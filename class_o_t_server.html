<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: OTServer Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_t_server.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">OTServer Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="OTServer" -->
<p><code>#include &lt;<a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>&gt;</code></p>

<p><a href="class_o_t_server-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a676d1065631af86553c3ac971a914a62">OTServer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a085800630a3da9253ecca58fc6ad4ff1">~OTServer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ad43926bb616a0e9ff5647a1fa03767f0">Release</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a46ffd986f1f8f7c64ba58db8297f22a7">Release_Server</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a3ecda4645f3d7fce295f5b6f78d53852">IsFlaggedForShutdown</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ac8d402506ad55458cd2fb0862dd7f26e">GetConnectInfo</a> (<a class="el" href="class_o_t_string.html">OTString</a> &amp;strHostname, int32_t &amp;nPort)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_mint.html">OTMint</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a65dd3c93d81f20a72b8d7d9e7cfe2eda">GetMint</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;ASSET_TYPE_ID, int32_t nSeries)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Lookup the current mint for any given asset type ID and series.  <a href="#a65dd3c93d81f20a72b8d7d9e7cfe2eda"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="_t_r1___wrapper_8hpp.html#a4081b6aa22d0f454ce7498756ea212ff">_SharedPtr</a>&lt; <a class="el" href="class_o_t_account.html">OTAccount</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a4e285894018dd3ed41b6aae6ccb0fec9">GetVoucherAccount</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;ASSET_TYPE_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ab89e968c42db6c16b835e36c899d8ea4">AddAssetContract</a> (<a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> &amp;theContract)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;ASSET_TYPE_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ac8efe3db8d0a98dfcd9758d622160c51">AddBasketAccountID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ACCOUNT_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_CONTRACT_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ad42ad136163957930d250c295d135a83">LookupBasketAccountID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ID, <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ACCOUNT_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a47bf0e4e73366e4aeddbd54da9bf2c14">VerifyBasketAccountID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ACCOUNT_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a257d4016ba99b0bb6c1762fa014e4623">LookupBasketAccountIDByContractID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_CONTRACT_ID, <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ACCOUNT_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae347553eb664ea7416240d0f5c9e9ebf">LookupBasketContractIDByAccountID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_ACCOUNT_ID, <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;BASKET_CONTRACT_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aaaf31d2353a6821b09453e0e60feee30">GetServerNym</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#af666d21f5f2814cf3dac34ecc041098d">Init</a> (bool bReadOnly=false)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a175acb5666be74924ad2237c6deceb43">LoadConfigFile</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a67db7bda44ff9b7e5a68661eba3dec87">ActivateCron</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a9f37adf57ae3e289f4a05494dd4642e3">ProcessCron</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aaf75e5038bc9879632d9a5519a68e78b">CreateMainFile</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a8d2815b41859393bdc3d2e63e3e62222">LoadMainFile</a> (bool bReadOnly=false)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aeff979d74c94eac885a8fe27fe698e8a">LoadServerUserAndContract</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a03d8221976e078b5deb04dacdbc37e64">SaveMainFileToString</a> (<a class="el" href="class_o_t_string.html">OTString</a> &amp;strMainFile)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae547a4bbf348c113568d625f8f5256aa">ProcessUserCommand</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut, <a class="el" href="class_o_t_client_connection.html">OTClientConnection</a> *pConnection=NULL, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> *pNym=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a4763bf53853ca87407c23ba152a8ebe4">ValidateServerIDfromUser</a> (<a class="el" href="class_o_t_string.html">OTString</a> &amp;strServerID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;USER_ID, const <a class="el" href="class_o_t_string.html">OTString</a> &amp;strMessage, const int64_t &amp;lRequestNum, const bool bReplyTransSuccess, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> *pActualNym=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a9f88b1a0a1b76f923e0830b353faf5a6">DropMessageToNymbox</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SENDER_USER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;RECIPIENT_USER_ID, <a class="el" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a> theType, <a class="el" href="class_o_t_message.html">OTMessage</a> *pMsg=NULL, const <a class="el" href="class_o_t_string.html">OTString</a> *pstrMessage=NULL, const char *szCommand=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ab500513963b83465cf5402d7b9809870">SendInstrumentToNym</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SENDER_USER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;RECIPIENT_USER_ID, <a class="el" href="class_o_t_message.html">OTMessage</a> *pMsg=NULL, const <a class="el" href="class_o_t_payment.html">OTPayment</a> *pPayment=NULL, const char *szCommand=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a3314039ea12808bf8d3bce6c251d7e8f">SendMessageToNym</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SENDER_USER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;RECIPIENT_USER_ID, <a class="el" href="class_o_t_message.html">OTMessage</a> *pMsg=NULL, const <a class="el" href="class_o_t_string.html">OTString</a> *pstrMessage=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aad09d6bc4e812109dd084c8606c7cd3a">UserCmdCheckServerID</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#af06ca9655b68edd3c6352e8ad0683b57">UserCmdCheckUser</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a8e8879f4902244d2e55debee8ee335a6">UserCmdSendUserMessage</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aad4515adb7c48a0d4b30140de99c727b">UserCmdSendUserInstrument</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#af69a358a7b5214d6200fe8d838e7f5d9">UserCmdGetRequest</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a8c6822ad744234645f3086bbf99e0c43">UserCmdGetTransactionNum</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a4ed65b2a39d3493cae05af541aafab7f">UserCmdIssueAssetType</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">An existing user is issuing a new currency.  <a href="#a4ed65b2a39d3493cae05af541aafab7f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ad8d48ac00f17dd758ee1ce638ec5eb3e">UserCmdIssueBasket</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">An existing user is creating an issuer account (that he will not control) based on a basket of currencies.  <a href="#ad8d48ac00f17dd758ee1ce638ec5eb3e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a5eb462c4e3d26d4ee2afbfbc151a4a37">UserCmdGetBoxReceipt</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a814dd4abce3b6b338b07602143f6636e">UserCmdDeleteUser</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a75f0645baa92a4f273ffb726eefa5a39">UserCmdDeleteAssetAcct</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a7cbd0ac6cbdf34d1e49ff96979691896">UserCmdCreateAccount</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">An existing user is creating an asset account.  <a href="#a7cbd0ac6cbdf34d1e49ff96979691896"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a6ac2aae7675c14c1bbb4b6ef87c70499">UserCmdNotarizeTransactions</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a0787e731cb0e2622677a7b7f25d9958c">UserCmdGetNymbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae660ce647967c554cbaed3888194160a">UserCmdGetInbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a59d3bba46b92f43461163bb5e99e15bd">UserCmdGetOutbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#af9644fd5e95a200a2689462a1caae6e8">UserCmdGetAccount</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aff8c02fe93fe3f8fbe5ab8d30981ad8b">UserCmdGetAccountFiles</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aa677b01656359ef72a78a7935eb0bf40">UserCmdGetContract</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae4ca69c54f16ba79ac6ee46d214795d0">UserCmdGetMint</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a45345893df0734299bd86c7dbddc4628">UserCmdProcessInbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a4c00992f16de5ef6f69fe6dfcf5556a9">UserCmdProcessNymbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a26de1a410e0281e6a19caa28db7a1c39">UserCmdUsageCredits</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a45d6cb87281eca8c86b51926dd87c2e1">UserCmdTriggerClause</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae7877e32c7ebfdf4abcecfb7d9494269">UserCmdQueryAssetTypes</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a8613c995889d628dde61855c1eae1e3a">UserCmdGetMarketList</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aaad2e2c40409f5377cf867cbdae677bc">UserCmdGetMarketOffers</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a2063c2f8497f69026e4e1a740218828b">UserCmdGetMarketRecentTrades</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aa205b6d4560bfb2e728c9ad48f084283">UserCmdGetNym_MarketOffers</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;MsgIn, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;msgOut)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, int64_t &amp;lTransactionNumber, bool bStoreTheNumber=true)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, const int64_t &amp;lTransactionNumber)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874">RemoveTransactionNumber</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, const int64_t &amp;lTransactionNumber, bool bSave=false)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove a transaction number from the Nym record once it's officially used/spent.  <a href="#ad0d2bc78b1059086d78e7f6d5aa1a874"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba">RemoveIssuedNumber</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, const int64_t &amp;lTransactionNumber, bool bSave=false)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove an issued number from the Nym record once that nym accepts the receipt from his inbox.  <a href="#ab7d81feacfb032dd09b7714f77c3ecba"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a4f55f071e6a561a33917a9a583c1da87">NotarizeTransaction</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a36c6f177e0884b05f3ae76b3dcb4f3dd">NotarizeTransfer</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theFromAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a63d1bff954081d9f73f50c41756d4573">NotarizeDeposit</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">for depositing a cheque or cash.  <a href="#a63d1bff954081d9f73f50c41756d4573"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a81f81918e187bf2c62bfb413a9db13ab">NotarizeWithdrawal</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae8313723858633f63bbdeec9a1d6e1f1">NotarizeProcessInbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a965049d4360936cd4930d361ca0d5c41">NotarizeProcessNymbox</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae0494b71bb963f7a5e56d3f1134e280d">NotarizeMarketOffer</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAssetAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">a user is exchanging in or out of a basket. (Ex. He's trading 2 gold and 3 silver for 10 baskets, or vice-versa.)  <a href="#ae0494b71bb963f7a5e56d3f1134e280d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aa5fbf4c29c1e9428924a7278f2f3cff0">NotarizePaymentPlan</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theDepositorAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ae784f808e73489ab4db99176eef8153c">NotarizeSmartContract</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theActivatingAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a21421671206f26b76c61406e95fde3af">NotarizeCancelCronItem</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAssetAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a061c83978f4cb2fdf6f13e3600790b0a">NotarizeExchangeBasket</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theSourceAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aeb24d887eb3c2394ab446e18b8f7a9b0">NotarizePayDividend</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAccount, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranIn, <a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;tranOut, bool &amp;bOutSuccess)</td></tr>
<tr><td colspan="2"><h2><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ada3425a1d2aed3991a889fe6c934f5f8">GetMinMarketScale</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aeb1ec70655351bd1b4fac9d76f78c304">SetMinMarketScale</a> (int64_t lVal)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#ab08a2fd97673e879377a1a8a60c27dff">GetHeartbeatNoRequests</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a63cfec2112f3b2a8490790a8fb8264fb">SetHeartbeatNoRequests</a> (int32_t nVal)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a972049b6ef960e94d43df291ac44dd4b">GetHeartbeatMsBetweenBeats</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a95e4bb3ce17ee91a57c8027dfd00255d">SetHeartbeatMsBetweenBeats</a> (int32_t nVal)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const std::string &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">GetOverrideNymID</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server.html#aacf5bdeecd0f8c3e1b923e7547a11810">SetOverrideNymID</a> (const std::string the_id)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00173">173</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a676d1065631af86553c3ac971a914a62"></a><!-- doxytag: member="OTServer::OTServer" ref="a676d1065631af86553c3ac971a914a62" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_server.html#a676d1065631af86553c3ac971a914a62">OTServer::OTServer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01213">1213</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                   : m_bReadOnly(<span class="keyword">false</span>), m_bShutdownFlag(<span class="keyword">false</span>), m_pServerContract(NULL), m_lTransactionNumber(0)
{
<span class="comment">//  m_lTransactionNumber = 0;   // This will be set when the server main xml file is loaded. For now, initialize to 0.</span>
<span class="comment">//</span>
<span class="comment">//  m_bShutdownFlag = false;    // If I ever set this to true, then the caller will shutdown gracefully.</span>
<span class="comment">// (Caller must regularly check the flag and shutdown when it sees the change.)</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a085800630a3da9253ecca58fc6ad4ff1"></a><!-- doxytag: member="OTServer::~OTServer" ref="a085800630a3da9253ecca58fc6ad4ff1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_server.html#a085800630a3da9253ecca58fc6ad4ff1">OTServer::~OTServer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01222">1222</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_server.html#a46ffd986f1f8f7c64ba58db8297f22a7">Release_Server</a>();
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a67db7bda44ff9b7e5a68661eba3dec87"></a><!-- doxytag: member="OTServer::ActivateCron" ref="a67db7bda44ff9b7e5a68661eba3dec87" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a67db7bda44ff9b7e5a68661eba3dec87">OTServer::ActivateCron</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00287">287</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTServer::ActivateCron: %s \n&quot;</span>, m_Cron.<a class="code" href="class_o_t_cron.html#a226d64f94cc582bbaefc9e3b8c1fe86a">ActivateCron</a>() ? <span class="stringliteral">&quot;(STARTED)&quot;</span> : <span class="stringliteral">&quot;FAILED&quot;</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab89e968c42db6c16b835e36c899d8ea4"></a><!-- doxytag: member="OTServer::AddAssetContract" ref="ab89e968c42db6c16b835e36c899d8ea4" args="(OTAssetContract &amp;theContract)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ab89e968c42db6c16b835e36c899d8ea4">OTServer::AddAssetContract</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theContract</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p><a class="el" href="class_o_t_server.html">OTServer</a> will take ownership of theContract from this point on, and will be responsible for deleting it. MUST be allocated on the heap. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00753">753</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = NULL;

    <a class="code" href="class_o_t_string.html">OTString</a> STR_CONTRACT_ID; <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> CONTRACT_ID;
    theContract.<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(STR_CONTRACT_ID);
    theContract.<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(CONTRACT_ID);

    pContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(CONTRACT_ID);

    <span class="comment">// already exists</span>
    <span class="keywordflow">if</span> (NULL != pContract) <span class="comment">// if not null</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;

    m_mapContracts[STR_CONTRACT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()] = &amp;theContract;

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac8efe3db8d0a98dfcd9758d622160c51"></a><!-- doxytag: member="OTServer::AddBasketAccountID" ref="ac8efe3db8d0a98dfcd9758d622160c51" args="(const OTIdentifier &amp;BASKET_ID, const OTIdentifier &amp;BASKET_ACCOUNT_ID, const OTIdentifier &amp;BASKET_CONTRACT_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ac8efe3db8d0a98dfcd9758d622160c51">OTServer::AddBasketAccountID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ACCOUNT_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_CONTRACT_ID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00345">345</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theBasketAcctID;

    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_server.html#ad42ad136163957930d250c295d135a83">LookupBasketAccountID</a>(BASKET_ID, theBasketAcctID))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;User attempted to add Basket that already exists.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }

    <a class="code" href="class_o_t_string.html">OTString</a> strBasketID(BASKET_ID), strBasketAcctID(BASKET_ACCOUNT_ID), strBasketContractID(BASKET_CONTRACT_ID);

    m_mapBaskets[strBasketID.Get()]                 = strBasketAcctID.Get();
    m_mapBasketContracts[strBasketContractID.Get()] = strBasketAcctID.Get();

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aaf75e5038bc9879632d9a5519a68e78b"></a><!-- doxytag: member="OTServer::CreateMainFile" ref="aaf75e5038bc9879632d9a5519a68e78b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#aaf75e5038bc9879632d9a5519a68e78b">OTServer::CreateMainFile</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01626">1626</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szInstructions =
        <span class="stringliteral">&quot;\n\n ==&gt; WARNING: Main file not found. To create it, continue this process now...\n\n&quot;</span>
        <span class="stringliteral">&quot;REQUIREMENTS: You must already have a wallet, where you have created one Nym.\n&quot;</span>
        <span class="stringliteral">&quot;This will be a temporary wallet only, for the purpose of generating the server\n&quot;</span>
        <span class="stringliteral">&quot;nym and the master key for that server nym. You can erase the contents of the\n&quot;</span>
        <span class="stringliteral">&quot;~/.ot/client_data folder once we are done with this process, and the OT client\n&quot;</span>
        <span class="stringliteral">&quot;will just create a fresh wallet to replace it. In other words, don&#39;t continue\n&quot;</span>
        <span class="stringliteral">&quot;to use the temporary wallet as a REAL wallet, since it contains the master\n&quot;</span>
        <span class="stringliteral">&quot;key and private key for your new server nym. We&#39;re using a temporary client-side\n&quot;</span>
        <span class="stringliteral">&quot;wallet for the convenience of generating the server nym--we&#39;ll copy it over to \n&quot;</span>
        <span class="stringliteral">&quot;the server side, and then we&#39;ll wipe the temp wallet and start with a fresh one\n&quot;</span>
        <span class="stringliteral">&quot;once this process is done.\n&quot;</span>
        <span class="stringliteral">&quot;(FYI, you can decode an armored wallet by using the &#39;opentxs decode&#39; command.)\n&quot;</span>
        <span class="stringliteral">&quot;-- You must also have the new Server Nym&#39;s \&quot;NymID\&quot;, which should be found in the\nwallet.\n&quot;</span>
        <span class="stringliteral">&quot;-- When you have created your server Nym (using your temp wallet) you will want to\n&quot;</span>
        <span class="stringliteral">&quot;copy the credentials from the temp wallet to your new server:\n&quot;</span>
        <span class="stringliteral">&quot;    cp -R ~/.ot/client_data/credentials ~/.ot/server_data/ \n&quot;</span>
        <span class="stringliteral">&quot;-- You must already have a signed server contract. (*** To get one, copy the\n&quot;</span>
        <span class="stringliteral">&quot;UNSIGNED version of the sample server contract, which is named &#39;localhost.xml&#39;,\n&quot;</span>
        <span class="stringliteral">&quot;and then change the tags as you see fit. Then use the same Nym, the server Nym,\n&quot;</span>
        <span class="stringliteral">&quot;to sign the server contract, via the &#39;opentxs newserver&#39; command.***)\n&quot;</span>
        <span class="stringliteral">&quot;You must also have the server ID for the above contract, which the newserver\n&quot;</span>
        <span class="stringliteral">&quot;command will output at the same time it outputs the newly-signed server contract.\n&quot;</span>
        <span class="stringliteral">&quot;=&gt; Note that the Nym who signs the server contract MUST be the same Nym that you\n&quot;</span>
        <span class="stringliteral">&quot;provide HERE, for this process now...)\n&quot;</span>
        <span class="stringliteral">&quot;-- Finally, you must provide the cached key from the same wallet where you brought\n&quot;</span>
        <span class="stringliteral">&quot;the Nym from (In this case, be careful to only copy the base64-encoded portion\n&quot;</span>
        <span class="stringliteral">&quot;of the cached key from the wallet, and not the XML tags around it!) We\n&quot;</span>
        <span class="stringliteral">&quot;recommend you create a blank wallet entirely for this purpose (of generating\n&quot;</span>
        <span class="stringliteral">&quot;that cached key and server Nym, to be used for your new OT server.) Then erase it\nonce this process is done.\n&quot;</span>
        <span class="stringliteral">&quot; ==&gt; WARNING: Main file not found. To create it, continue this process now...\n&quot;</span>;

    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, szInstructions);
    <span class="comment">// ---------------------------------</span>
    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the ServerID for your server contract: &quot;</span>);
    std::string strServerID = <a class="code" href="_o_t___m_e_8hpp.html#a2f6d1287151b67b52f7d187721d48e96">OT_CLI_ReadLine</a>();
    <span class="comment">// ---------------------------------</span>
    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the Server User ID (the NymID of the Nym who signed the server contract): &quot;</span>);
    std::string strNymID = <a class="code" href="_o_t___m_e_8hpp.html#a2f6d1287151b67b52f7d187721d48e96">OT_CLI_ReadLine</a>();
    <span class="comment">// ---------------------------------</span>
    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Paste the cached key (ONLY the base64-encoded portion) below, from wallet.xml for that Nym.\n&quot;</span>
                  <span class="stringliteral">&quot;Terminate with &#39;~&#39; on a line by itself.\n\n&quot;</span>);

    std::string strCachedKey = <a class="code" href="_o_t___m_e_8hpp.html#af621e54162979e65c23c0290c96099f0">OT_CLI_ReadUntilEOF</a>();
    <span class="comment">// ---------------------------------</span>
    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Paste the contents of the server Nym&#39;s certfile, including public/PRIVATE, below.\n&quot;</span>
                  <span class="stringliteral">&quot;NOTE: LEAVE THIS BLANK unless you REALLY want to use the OLD system. If you leave this\n&quot;</span>
                  <span class="stringliteral">&quot;blank (preferred), it will instead use the new credentials system. (Just make sure\n&quot;</span>
                  <span class="stringliteral">&quot;you copied over the \&quot;credentials\&quot; folder, as described above, since we&#39;re about to\n&quot;</span>
                  <span class="stringliteral">&quot;use it, if you leave this blank.)\n&quot;</span>
                  <span class="stringliteral">&quot;Terminate with &#39;~&#39; on a line by itself.\n\n&quot;</span>);

    std::string strCert = <a class="code" href="_o_t___m_e_8hpp.html#af621e54162979e65c23c0290c96099f0">OT_CLI_ReadUntilEOF</a>();
    <span class="comment">// ---------------------------------</span>
    <span class="comment">// signed server contract</span>
    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Paste the complete, signed, server contract below. (You must already have it.)\n&quot;</span>
                  <span class="stringliteral">&quot;Terminate with &#39;~&#39; on a line by itself.\n\n&quot;</span>);

    std::string strContract = <a class="code" href="_o_t___m_e_8hpp.html#af621e54162979e65c23c0290c96099f0">OT_CLI_ReadUntilEOF</a>();
    <span class="comment">// ---------------------------------</span>
    <span class="keywordflow">if</span> (!<a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strContract, <span class="stringliteral">&quot;contracts&quot;</span>, strServerID))
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed trying to store the server contract.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------</span>
    <span class="keywordflow">if</span> ((strCert.size()) &gt; 0 &amp;&amp; !<a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strCert, <span class="stringliteral">&quot;certs&quot;</span>, strNymID))
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed trying to store the server Nym&#39;s public/private cert.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szBlankFile = <span class="comment">// todo hardcoding.</span>
        <span class="stringliteral">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
        <span class="stringliteral">&quot;&lt;notaryServer version=\&quot;2.0\&quot;\n&quot;</span>
        <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;\n&quot;</span>
        <span class="stringliteral">&quot; serverUserID=\&quot;%s\&quot;\n&quot;</span>
        <span class="stringliteral">&quot; transactionNum=\&quot;%ld\&quot; &gt;\n&quot;</span>
        <span class="stringliteral">&quot;\n&quot;</span>
        <span class="stringliteral">&quot;&lt;cachedKey&gt;\n&quot;</span>
        <span class="stringliteral">&quot;%s&lt;/cachedKey&gt;\n&quot;</span>
        <span class="stringliteral">&quot;\n&quot;</span>
        <span class="stringliteral">&quot;&lt;accountList type=\&quot;voucher\&quot; count=\&quot;0\&quot; &gt;\n&quot;</span>
        <span class="stringliteral">&quot;\n&quot;</span>
        <span class="stringliteral">&quot;&lt;/accountList&gt;\n&quot;</span>
        <span class="stringliteral">&quot;\n&quot;</span>
        <span class="stringliteral">&quot;&lt;/notaryServer&gt;\n\n&quot;</span>
        ;

    <span class="keyword">const</span> int64_t lTransNum = 5; <span class="comment">// a starting point, for the new server.</span>

    <a class="code" href="class_o_t_string.html">OTString</a> strNotaryFile;
    strNotaryFile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(szBlankFile,
                         strServerID.c_str(),
                         strNymID.c_str(),
                         lTransNum,
                         strCachedKey.c_str());

    std::string str_Notary(strNotaryFile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

    <span class="keywordflow">if</span> (!<a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(str_Notary, <span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;notaryServer.xml&quot;</span>)) <span class="comment">// todo hardcoding.</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed trying to store the new notaryServer.xml file.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------------------------------------</span>
    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCachedKey;
    ascCachedKey.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(strCachedKey.c_str());
    <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SetCachedKey(ascCachedKey);

    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;HasHashCheck())
    {
        <a class="code" href="class_o_t_password.html">OTPassword</a> tempPassword; tempPassword.<a class="code" href="class_o_t_password.html#a3a971b06f42d1c89802167a0ab5330a5">zeroMemory</a>();
        _SharedPtr&lt;OTCachedKey&gt; sharedPtr(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>());
        sharedPtr-&gt;GetMasterPassword(sharedPtr, tempPassword,
                                     <span class="stringliteral">&quot;We do not have a check hash yet for this password, &quot;</span>
                                     <span class="stringliteral">&quot;please enter your password&quot;</span>, <span class="keyword">true</span>);
        <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>())
        {
            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
        }
    }
    <span class="comment">// ---------------------------------------------------------------</span>
    <span class="comment">// At this point, the contract is saved, the cert is saved, and the notaryServer.xml file</span>
    <span class="comment">// is saved. All we have left is the Nymfile, which we&#39;ll create.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerUserID(strNymID.c_str());

    m_nymServer.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(strServerUserID);

    <span class="keywordflow">if</span> (!m_nymServer.<a class="code" href="class_o_t_pseudonym.html#aa5a79982c08a8db1c961d05fd449b585">Loadx509CertAndPrivateKey</a>())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading server credentials, or certificate and private key.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_nymServer.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error verifying server nym. Are you sure you have the right ID?\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_nymServer.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error saving new nymfile for server nym.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: OKAY, we have apparently created the new server. Remember to erase the contents &quot;</span>
                       <span class="stringliteral">&quot;of your ~/.ot/client_data folder, since we used a temporary wallet to generate the server &quot;</span>
                       <span class="stringliteral">&quot;nym and its master key.\n&quot;</span>
                       <span class="stringliteral">&quot;Let&#39;s try to load up your new server contract...\n&quot;</span>, __FUNCTION__);
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9f88b1a0a1b76f923e0830b353faf5a6"></a><!-- doxytag: member="OTServer::DropMessageToNymbox" ref="a9f88b1a0a1b76f923e0830b353faf5a6" args="(const OTIdentifier &amp;SERVER_ID, const OTIdentifier &amp;SENDER_USER_ID, const OTIdentifier &amp;RECIPIENT_USER_ID, OTTransaction::transactionType theType, OTMessage *pMsg=NULL, const OTString *pstrMessage=NULL, const char *szCommand=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a9f88b1a0a1b76f923e0830b353faf5a6">OTServer::DropMessageToNymbox</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SENDER_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>RECIPIENT_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a>&#160;</td>
          <td class="paramname"><em>theType</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> *&#160;</td>
          <td class="paramname"><em>pMsg</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_string.html">OTString</a> *&#160;</td>
          <td class="paramname"><em>pstrMessage</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>szCommand</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02785">2785</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( !( (NULL == pMsg) &amp;&amp; (NULL == pstrMessage) ), <span class="stringliteral">&quot;pMsg and pstrMessage -- these can&#39;t BOTH be NULL.\n&quot;</span>); <span class="comment">// must provide one or the other.</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( !( (NULL != pMsg) &amp;&amp; (NULL != pstrMessage) ), <span class="stringliteral">&quot;pMsg and pstrMessage -- these can&#39;t BOTH be not-NULL.\n&quot;</span>); <span class="comment">// can&#39;t provide both.</span>
    <span class="comment">// ------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::DropMessageToNymbox&quot;</span>;
    <span class="comment">// ------------------------</span>
    int64_t lTransNum = 0;
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNextTransNum = this-&gt;<a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lTransNum, <span class="keyword">false</span>); <span class="comment">// bool bStoreTheNumber = false</span>

    <span class="keywordflow">if</span> (!bGotNextTransNum)
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to get next transaction number.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------</span>
    <span class="keywordflow">switch</span> (theType)
    {
        <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>:            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:   <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected transactionType passed here (expected message &quot;</span>
                          <span class="stringliteral">&quot;or instrumentNotice.)\n&quot;</span>, szFunc);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------</span>
    <span class="comment">// If pMsg was not already passed in here, then</span>
    <span class="comment">// create pMsg using pstrMessage.</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMsgAngel;

    <span class="keywordflow">if</span> (NULL == pMsg) <span class="comment">// we have to create it ourselves.</span>
    {
        pMsg = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMsg);
        theMsgAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pMsg); <span class="comment">// In this case we created it, so we clean it up as well.</span>
        <span class="comment">// ---------------------------------</span>
        <span class="keywordflow">if</span> (NULL != szCommand)
            pMsg-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a> = szCommand;
        <span class="keywordflow">else</span>
        {
            <span class="keywordflow">switch</span> (theType)
            {
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>:            pMsg-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a> = <span class="stringliteral">&quot;sendUserMessage&quot;</span>;    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:   pMsg-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a> = <span class="stringliteral">&quot;sendUserInstrument&quot;</span>; <span class="keywordflow">break</span>;
                <span class="keywordflow">default</span>:  <span class="keywordflow">break</span>; <span class="comment">// should never happen.</span>
            }
        }
        <span class="comment">// --------------------------------------------------------------</span>
        pMsg-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a> = this-&gt;m_strServerID;
        pMsg-&gt;<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>    = <span class="keyword">true</span>;
        SENDER_USER_ID.   GetString(pMsg-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>);
        RECIPIENT_USER_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>); <span class="comment">// set the recipient ID in pMsg to match our recipient ID.</span>
        <span class="comment">// ---------------------------------</span>
        <span class="comment">// Load up the recipient&#39;s public key (so we can encrypt the envelope</span>
        <span class="comment">// to him that will contain the payment instrument.)</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> nymRecipient(RECIPIENT_USER_ID);

        <span class="keywordtype">bool</span> bLoadedNym = nymRecipient.LoadPublicKey(); <span class="comment">// Old style (deprecated.) But this function calls the new style, LoadCredentials, at the top. Eventually we&#39;ll just call that here directly.</span>
        <span class="comment">// -----------------------------------------------------------</span>
        <span class="keywordflow">if</span> (!bLoadedNym)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load public key for recipient.\n&quot;</span>, szFunc);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!nymRecipient.VerifyPseudonym())
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to verify Nym for recipient.\n&quot;</span>, szFunc);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="comment">// ---------------------------------</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; thePubkey = nymRecipient.GetPublicEncrKey();
        <span class="comment">// ---------------------------------</span>
        <span class="comment">// Wrap the message up into an envelope and attach it to pMsg.</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_envelope.html">OTEnvelope</a>  theEnvelope;

        pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();

        <span class="keywordflow">if</span> ((NULL != pstrMessage) &amp;&amp; pstrMessage-&gt;<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
            theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(thePubkey, *pstrMessage) &amp;&amp; <span class="comment">// Seal pstrMessage into theEnvelope, using nymRecipient&#39;s public key.</span>
            theEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>)) <span class="comment">// Grab the sealed version as base64-encoded string, into pMsg-&gt;m_ascPayload.</span>
        {
            pMsg-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);
            pMsg-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to seal envelope containing message &quot;</span>
                          <span class="stringliteral">&quot;(or while grabbing the base64-encoded result.)\n&quot;</span>,
                          szFunc);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }

        <span class="comment">// ---------------------------------</span>
        <span class="comment">// By this point, pMsg is all set up, signed and saved. Its payload contains</span>
        <span class="comment">// the envelope (as base64) containing the encrypted message.</span>
    }
<span class="comment">//  else // pMsg was passed in, so it&#39;s not NULL. No need to create it ourselves like above. (pstrMessage should be NULL anyway in this case.)</span>
<span class="comment">//  {</span>
<span class="comment">//       // Apparently no need to do anything in here at all.</span>
<span class="comment">//  }</span>
    <span class="comment">// --------------------------------------</span>
    <span class="comment">// Grab a string copy of pMsg.</span>
    <span class="comment">//</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInMessage(*pMsg);
    <span class="comment">// --------------------------------------</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(RECIPIENT_USER_ID, RECIPIENT_USER_ID, SERVER_ID); <span class="comment">// The recipient&#39;s Nymbox.</span>
    <span class="comment">// ------------------------</span>
    <span class="comment">// Drop in the Nymbox</span>
    <span class="keywordflow">if</span> ( (theLedger.LoadNymbox()                &amp;&amp;  <span class="comment">// I think this loads the box receipts too, since I didn&#39;t call &quot;LoadNymboxNoVerify&quot;</span>
<span class="comment">//        theLedger.VerifyAccount(m_nymServer)  &amp;&amp;  // This loads all the Box Receipts, which is unnecessary.</span>
          theLedger.VerifyContractID()          &amp;&amp;  <span class="comment">// Instead, we&#39;ll verify the IDs and Signature only.</span>
          theLedger.VerifySignature(m_nymServer)
       ) )
    {
        <span class="comment">// Create the instrumentNotice to put in the Nymbox.</span>
        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theLedger, theType, lTransNum);

        <span class="keywordflow">if</span> (NULL != pTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
        {
            <span class="comment">// NOTE: todo: SHOULD this be &quot;in reference to&quot; itself? The reason, I assume we are doing this</span>
            <span class="comment">// is because there is a reference STRING so &quot;therefore&quot; there must be a reference # as well. Eh?</span>
            <span class="comment">// Anyway, it must be understood by those involved that a message is stored inside. (Which has no transaction #.)</span>

            pTransaction-&gt;  SetReferenceToNum(lTransNum);       <span class="comment">// &lt;====== Recipient RECEIVES entire incoming message as string here, which includes the sender user ID,</span>
            pTransaction-&gt;  SetReferenceString(strInMessage);   <span class="comment">// and has an OTEnvelope in the payload. Message is signed by sender, and envelope is encrypted to recipient.</span>

            pTransaction-&gt;  SignContract(m_nymServer);
            pTransaction-&gt;  SaveContract();
            <span class="comment">// -----------------------------------------</span>
            theLedger.AddTransaction(*pTransaction); <span class="comment">// Add the message transaction to the nymbox. (It will cleanup.)</span>

            theLedger.ReleaseSignatures();
            theLedger.SignContract(m_nymServer);
            theLedger.SaveContract();
            theLedger.SaveNymbox(); <span class="comment">// We don&#39;t grab the Nymbox hash here, since nothing important changed (just a message was sent.)</span>


            <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
            <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
            <span class="comment">//</span>
            <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
            <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
            <span class="comment">// is removed from a box.</span>
            <span class="comment">//</span>
            pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theLedger);

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientUserID(RECIPIENT_USER_ID);
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
                          <span class="stringliteral">&quot;add a message to Nymbox: %s\n&quot;</span>,
                          szFunc, strRecipientUserID.Get());
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientUserID(RECIPIENT_USER_ID);
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to load or verify Nymbox: %s\n&quot;</span>,
                      szFunc, strRecipientUserID.Get());
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5a678422af4b38d615adc593c8310ffb"></a><!-- doxytag: member="OTServer::DropReplyNoticeToNymbox" ref="a5a678422af4b38d615adc593c8310ffb" args="(const OTIdentifier &amp;SERVER_ID, const OTIdentifier &amp;USER_ID, const OTString &amp;strMessage, const int64_t &amp;lRequestNum, const bool bReplyTransSuccess, OTPseudonym *pActualNym=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">OTServer::DropReplyNoticeToNymbox</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strMessage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lRequestNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool&#160;</td>
          <td class="paramname"><em>bReplyTransSuccess</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> *&#160;</td>
          <td class="paramname"><em>pActualNym</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10097">10097</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(USER_ID, USER_ID, SERVER_ID);

    <span class="keywordtype">bool</span> bSuccessLoadingNymbox = theNymbox.LoadNymbox();

    <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingNymbox)
        bSuccessLoadingNymbox   = (theNymbox.VerifyContractID() &amp;&amp; theNymbox.VerifySignature(m_nymServer));
<span class="comment">//      bSuccessLoadingNymbox   = theNymbox.VerifyAccount(m_nymServer); // make sure it&#39;s all good.</span>

    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingNymbox)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::DropReplyNoticeToNymbox: Failed loading or verifying Nymbox for user: %s\n&quot;</span>,
                       strNymID.Get());
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">else</span>
    {
        int64_t lReplyNoticeTransNum=0;
        <span class="keywordtype">bool</span> bGotNextTransNum = <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lReplyNoticeTransNum, <span class="keyword">false</span>); <span class="comment">// bool bStoreTheNumber = false</span>

        <span class="keywordflow">if</span> (!bGotNextTransNum)
        {
            lReplyNoticeTransNum = 0;
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::DropReplyNoticeToNymbox: Error getting next transaction number for an OTTransaction::replyNotice.\n&quot;</span>);
        }
        <span class="keywordflow">else</span>
        {   <span class="comment">// Drop in the Nymbox</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pReplyNotice = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theNymbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>, lReplyNoticeTransNum);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pReplyNotice);
            <span class="comment">// --------------------------------</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyNoticeItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pReplyNotice, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2e7b5819c105436d507ee05b176026d2">OTItem::replyNotice</a>);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pReplyNoticeItem);
            <span class="comment">// --------------------------------</span>
            pReplyNoticeItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// Nymbox notice is always a success. It&#39;s just a notice. (The message inside it will have success/failure also, and any transaction inside that will also.)</span>
            pReplyNoticeItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strMessage); <span class="comment">// Purpose of this notice is to carry a copy of server&#39;s reply message (to certain requests, including all transactions.)</span>
            pReplyNoticeItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
            pReplyNoticeItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            <span class="comment">// --------------------------------</span>
            pReplyNotice-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pReplyNoticeItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
            <span class="comment">// --------------------------------</span>
            <span class="comment">// So the client-side can quickly/easily match up the replyNotices in</span>
            <span class="comment">// the Nymbox with the request numbers of the messages that were sent.</span>
            <span class="comment">// I think this is actually WHY the server message low-level functions</span>
            <span class="comment">// now RETURN the request number.</span>
            <span class="comment">// FYI: replyNotices will ONLY be in my Nymbox if the MESSAGE was successful.</span>
            <span class="comment">// (Meaning, the balance agreement might have failed, and the transaction</span>
            <span class="comment">// might have failed, but the MESSAGE ITSELF must be a success, in order for</span>
            <span class="comment">// the replyNotice to appear in the Nymbox.)</span>
            <span class="comment">//</span>
            pReplyNotice-&gt;<a class="code" href="class_o_t_transaction.html#a8db20f109eab5bf715673bfcf3b3bb4f">SetRequestNum</a>(lRequestNum);
            pReplyNotice-&gt;<a class="code" href="class_o_t_transaction.html#a3099413a51aa3ec99b783a4e89144150">SetReplyTransSuccess</a>(bReplyTransSuccess);
            <span class="comment">// --------------------------------</span>
            pReplyNotice-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
            pReplyNotice-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            <span class="comment">// --------------------------------</span>
            theNymbox.  AddTransaction(*pReplyNotice); <span class="comment">// Add the replyNotice to the nymbox. It takes ownership.</span>
            theNymbox.  ReleaseSignatures();
            theNymbox.  SignContract(m_nymServer);
            theNymbox.  SaveContract();

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
            theNymbox.  SaveNymbox(&amp;NYMBOX_HASH);

            pReplyNotice-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theNymbox);
            <span class="comment">// -----------------------</span>

            <span class="keywordflow">if</span> ((NULL != pActualNym) &amp;&amp; pActualNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5ec9340b8d1d0fcd32f754ea63f9915a">CompareID</a>(USER_ID))
            {
                pActualNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH);
                pActualNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pActualNym)
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::DropReplyNoticeToNymbox: ERROR: pActualNym was not NULL, but it didn&#39;t match USER_ID.\n&quot;</span>);
        }
    }
    <span class="comment">// -------------------------------------------------------------</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2f39cc0d6b8ab27de71fc8a68f00914c"></a><!-- doxytag: member="OTServer::GetAssetContract" ref="a2f39cc0d6b8ab27de71fc8a68f00914c" args="(const OTIdentifier &amp;ASSET_TYPE_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> * <a class="el" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">OTServer::GetAssetContract</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>ASSET_TYPE_ID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The server supports various different asset types. Any user may create a new asset type by uploading the asset contract to the server. The server stores the contract in a directory and in its in-memory list of asset types. You can call this function to look up any asset contract by ID. If it returns NULL, you can add it yourself by uploading the contract. But be sure that the public key in the contract, used to sign the contract, is also the public key of the Nym of the issuer. They must match. In the future I may create a special key category just for this purpose. Right now I'm using the "contract" key which is already used to verify any asset or server contract. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00731">731</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_asset_contract_8hpp.html#a88f3c1b8259d44ecd0d15628789315cb">mapOfContracts</a>, m_mapContracts)
    {
        <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theContractID;
        pContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theContractID);

        <span class="keywordflow">if</span> (theContractID == ASSET_TYPE_ID)
            <span class="keywordflow">return</span> pContract;
    }

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac8d402506ad55458cd2fb0862dd7f26e"></a><!-- doxytag: member="OTServer::GetConnectInfo" ref="ac8d402506ad55458cd2fb0862dd7f26e" args="(OTString &amp;strHostname, int32_t &amp;nPort)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ac8d402506ad55458cd2fb0862dd7f26e">OTServer::GetConnectInfo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strHostname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t &amp;&#160;</td>
          <td class="paramname"><em>nPort</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l14939">14939</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (NULL == m_pServerContract)
        <span class="keywordflow">return</span> <span class="keyword">false</span>;

    <span class="keywordflow">return</span> m_pServerContract-&gt;<a class="code" href="class_o_t_server_contract.html#a0714f92ddd215d7a0120dffc4c9c8cd5">GetConnectInfo</a>(strHostname, nPort);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a972049b6ef960e94d43df291ac44dd4b"></a><!-- doxytag: member="OTServer::GetHeartbeatMsBetweenBeats" ref="a972049b6ef960e94d43df291ac44dd4b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int32_t <a class="el" href="class_o_t_server.html#a972049b6ef960e94d43df291ac44dd4b">OTServer::GetHeartbeatMsBetweenBeats</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00279">279</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> __heartbeat_ms_between_beats; }
</pre></div>
</div>
</div>
<a class="anchor" id="ab08a2fd97673e879377a1a8a60c27dff"></a><!-- doxytag: member="OTServer::GetHeartbeatNoRequests" ref="ab08a2fd97673e879377a1a8a60c27dff" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int32_t <a class="el" href="class_o_t_server.html#ab08a2fd97673e879377a1a8a60c27dff">OTServer::GetHeartbeatNoRequests</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00276">276</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> __heartbeat_no_requests; }
</pre></div>
</div>
</div>
<a class="anchor" id="ada3425a1d2aed3991a889fe6c934f5f8"></a><!-- doxytag: member="OTServer::GetMinMarketScale" ref="ada3425a1d2aed3991a889fe6c934f5f8" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int64_t <a class="el" href="class_o_t_server.html#ada3425a1d2aed3991a889fe6c934f5f8">OTServer::GetMinMarketScale</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00272">272</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> __min_market_scale; }
</pre></div>
</div>
</div>
<a class="anchor" id="a65dd3c93d81f20a72b8d7d9e7cfe2eda"></a><!-- doxytag: member="OTServer::GetMint" ref="a65dd3c93d81f20a72b8d7d9e7cfe2eda" args="(const OTIdentifier &amp;ASSET_TYPE_ID, int32_t nSeries)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_mint.html">OTMint</a> * <a class="el" href="class_o_t_server.html#a65dd3c93d81f20a72b8d7d9e7cfe2eda">OTServer::GetMint</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>ASSET_TYPE_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>nSeries</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Lookup the current mint for any given asset type ID and series. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00483">483</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = NULL;

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#aa530cfc75dfb39aece69b3c04210fdde">mapOfMints</a>, m_mapMints)
    {
        pMint = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pMint, <span class="stringliteral">&quot;NULL mint pointer in OTServer::GetMint\n&quot;</span>);

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theID;
        pMint-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theID);

        <span class="keywordflow">if</span> ((ASSET_TYPE_ID  == theID) &amp;&amp;            <span class="comment">// if the ID on the Mint matches the ID passed in</span>
            (nSeries        == pMint-&gt;<a class="code" href="class_o_t_mint.html#a18ccc7a8eebfdf973533cf3b96e6b7ea">GetSeries</a>())) <span class="comment">// and the series also matches...</span>
            <span class="keywordflow">return</span> pMint;                           <span class="comment">// return the pointer right here, we&#39;re done.</span>
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">// The mint isn&#39;t in memory for the series requested.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> ASSET_ID_STR(ASSET_TYPE_ID);

    <a class="code" href="class_o_t_string.html">OTString</a>    strMintFilename;
    strMintFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s%s%s%s%d&quot;</span>,
                           m_strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
                           ASSET_ID_STR.Get(), <span class="stringliteral">&quot;.&quot;</span>, nSeries);

    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#a821d8437b66e62cca2782da52777f299">OTFolders::Mint</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = strMintFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
    <span class="comment">// --------------------------------------------------------------------</span>
    pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(m_strServerID, m_strServerUserID, ASSET_ID_STR);

    <span class="comment">// You cannot hash the Mint to get its ID. (The ID is a hash of the asset contract.)</span>
    <span class="comment">// Instead, you must READ the ID from the Mint file, and then compare it to the one expected</span>
    <span class="comment">// to see if they match (similar to how Account IDs are verified.)</span>

    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pMint, <span class="stringliteral">&quot;Error allocating memory for Mint in OTServer::GetMint&quot;</span>);
    <span class="comment">// --------------------------------------------------------------------</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strSeries;
    strSeries.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s%d&quot;</span>, <span class="stringliteral">&quot;.&quot;</span>, nSeries);
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>(strSeries.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
    {
        <span class="keywordflow">if</span> (pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>(m_nymServer)) <span class="comment">// I don&#39;t verify the Mint&#39;s expiration date here, just its signature, ID, etc.</span>
        {                                   <span class="comment">// (Expiry dates are enforced on tokens during deposit--and checked against mint--</span>
                                            <span class="comment">// but expiry dates are only enforced on the Mint itself during a withdrawal.)</span>
            <span class="comment">// It&#39;s a multimap now...</span>
            <span class="comment">//m_mapMints[ASSET_ID_STR.Get()] = pMint;</span>

            m_mapMints.insert ( std::pair&lt;std::string, OTMint *&gt;(ASSET_ID_STR.Get(), pMint) );

            <span class="keywordflow">return</span> pMint;
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error verifying Mint in OTServer::GetMint:\n%s%s%s\n&quot;</span>,
                          szFoldername, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
        }
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading Mint in OTServer::GetMint:\n%s%s%s\n&quot;</span>,
                      szFoldername, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
    }

    <span class="keywordflow">if</span> (NULL != pMint)
        <span class="keyword">delete</span> pMint;
    pMint = NULL;

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1cf188f4a50e9dff3f8ee97807ed505a"></a><!-- doxytag: member="OTServer::GetOverrideNymID" ref="a1cf188f4a50e9dff3f8ee97807ed505a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static const std::string&amp; <a class="el" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00284">284</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> __override_nym_id; }
</pre></div>
</div>
</div>
<a class="anchor" id="aaaf31d2353a6821b09453e0e60feee30"></a><!-- doxytag: member="OTServer::GetServerNym" ref="aaaf31d2353a6821b09453e0e60feee30" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; <a class="el" href="class_o_t_server.html#aaaf31d2353a6821b09453e0e60feee30">OTServer::GetServerNym</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00339">339</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> m_nymServer;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4e285894018dd3ed41b6aae6ccb0fec9"></a><!-- doxytag: member="OTServer::GetVoucherAccount" ref="a4e285894018dd3ed41b6aae6ccb0fec9" args="(const OTIdentifier &amp;ASSET_TYPE_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_t_r1___wrapper_8hpp.html#a4081b6aa22d0f454ce7498756ea212ff">_SharedPtr</a>&lt; <a class="el" href="class_o_t_account.html">OTAccount</a> &gt; <a class="el" href="class_o_t_server.html#a4e285894018dd3ed41b6aae6ccb0fec9">OTServer::GetVoucherAccount</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>ASSET_TYPE_ID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Looked up the voucher account (where cashier's cheques are issued for any given asset type) return a pointer to the account. Since it's SUPPOSED to exist, and since it's being requested, also will GENERATE it if it cannot be found, add it to the list, and return the pointer. Should always succeed. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00454">454</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    _SharedPtr&lt;OTAccount&gt; pAccount;
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_USER_ID(m_nymServer), SERVER_ID(m_strServerID);
    <span class="comment">// --------------------------------------------------</span>
    <span class="keywordtype">bool</span> bWasAcctCreated = <span class="keyword">false</span>;
    pAccount = m_VoucherAccts.<a class="code" href="class_o_t_acct_list.html#ad525fafc311107c6a158030c3d429538">GetOrCreateAccount</a>(m_nymServer, SERVER_USER_ID, ASSET_TYPE_ID,
                                                SERVER_ID, bWasAcctCreated);
    <span class="keywordflow">if</span> (bWasAcctCreated)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
        pAccount-&gt;GetIdentifier(strAcctID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_TYPE_ID);

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::GetVoucherAccount: Successfully created voucher account ID: %s Asset Type ID: %s\n&quot;</span>,
                 strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.Get());

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>())
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::GetVoucherAccount: Error saving main server file containing new account ID!!\n&quot;</span>);
        }
    }
    <span class="comment">// -------------------------------</span>

    <span class="keywordflow">return</span> pAccount;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af666d21f5f2814cf3dac34ecc041098d"></a><!-- doxytag: member="OTServer::Init" ref="af666d21f5f2814cf3dac34ecc041098d" args="(bool bReadOnly=false)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#af666d21f5f2814cf3dac34ecc041098d">OTServer::Init</a> </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bReadOnly</em> = <code>false</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01312">1312</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// -------------------------------------------------------</span>
    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a624a126d059f0db031d894de786b4011">OTDataFolder::IsInitialized</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to Init data folders&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
    <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_o_t_server.html#a175acb5666be74924ad2237c6deceb43">LoadConfigFile</a>())        { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to Load Config File!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
    <span class="comment">// -------------------------------------------------------</span>
    m_bReadOnly = bReadOnly;
    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// Server Data Path</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strDataPath;
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGetDataFolderSuccess = <a class="code" href="class_o_t_data_folder.html#a3cc847ac0fc0e30eb0f37dc8ecc9cec3">OTDataFolder::Get</a>(strDataPath);
    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// PID -- Make sure we&#39;re not running two copies of OT on the same data simultaneously here.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (bGetDataFolderSuccess)
    {
        <span class="comment">// If we want to WRITE to the data location, then we can&#39;t be in read-only</span>
        <span class="comment">// mode, and there can&#39;t be another copy running at the same time.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (!bReadOnly)
        {
            <span class="comment">// 1. READ A FILE STORING THE PID. (It will already exist, if OT is already running.)</span>
            <span class="comment">//</span>
            <span class="comment">// We open it for reading first, to see if it already exists. If it does,</span>
            <span class="comment">// we read the number. 0 is fine, since we overwrite with 0 on shutdown. But</span>
            <span class="comment">// any OTHER number means OT is still running. Or it means it was killed while</span>
            <span class="comment">// running and didn&#39;t shut down properly, and that you need to delete the pid file</span>
            <span class="comment">// by hand before running OT again. (This is all for the purpose of preventing two</span>
            <span class="comment">// copies of OT running at the same time and corrupting the data folder.)</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strPIDPath;
            <a class="code" href="class_o_t_paths.html#a149093f1bcedb1b792a8262f41b05f35">OTPaths::AppendFile</a>(strPIDPath,strDataPath,<a class="code" href="_o_t_server_8cpp.html#ac965e824dfe0199632423fa896071e1e">SERVER_PID_FILENAME</a>);

            std::ifstream pid_infile(strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="comment">// 2. (IF FILE EXISTS WITH ANY PID INSIDE, THEN DIE.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (pid_infile.is_open()) <span class="comment">// it existed already</span>
            {
                uint32_t old_pid = 0;
                pid_infile &gt;&gt; old_pid;
                pid_infile.close();

                <span class="comment">// There was a real PID in there.</span>
                <span class="keywordflow">if</span> (old_pid != 0)
                {
                    <span class="keyword">const</span> uint64_t lPID = old_pid;
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;\n\n\nIS OPEN-TRANSACTIONS ALREADY RUNNING?\n\n&quot;</span>
                                  <span class="stringliteral">&quot;I found a PID (%llu) in the data lock file, located at: %s\n\n&quot;</span>
                                  <span class="stringliteral">&quot;If the OT process with PID %llu is truly not running anymore, &quot;</span>
                                  <span class="stringliteral">&quot;then just ERASE THAT FILE and then RESTART.\n&quot;</span>, lPID, strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), lPID);
                    exit(-1);
                }
                <span class="comment">// Otherwise, though the file existed, the PID within was 0.</span>
                <span class="comment">// (Meaning the previous instance of OT already set it to 0 as it was shutting down.)</span>
            }
            <span class="comment">// Next let&#39;s record our PID to the same file, so other copies of OT can&#39;t trample on US.</span>

            <span class="comment">// 3. GET THE CURRENT (ACTUAL) PROCESS ID.</span>
            <span class="comment">//</span>
            uint64_t the_pid = 0;

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            the_pid = GetCurrentProcessId();
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            the_pid = getpid();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
            <span class="comment">// 4. OPEN THE FILE IN WRITE MODE, AND SAVE THE PID TO IT.</span>
            <span class="comment">//</span>
            std::ofstream pid_outfile(strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">if</span> (pid_outfile.is_open())
            {
                pid_outfile &lt;&lt; the_pid;
                pid_outfile.close();
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed trying to open data locking file (to store PID %llu): %s\n&quot;</span>,
                              the_pid, strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
    }
    <span class="comment">// -------------------------------------------------------</span>
    <a class="code" href="namespace_o_t_d_b.html#a346935608a31e0f724d839833e90e2f1">OTDB::InitDefaultStorage</a>(<a class="code" href="_o_t_storage_8hpp.html#aa14839d27201385945fff99b52448a29">OTDB_DEFAULT_STORAGE</a>,<a class="code" href="_o_t_storage_8hpp.html#aae47b801ed98c155ad4705c110987b25">OTDB_DEFAULT_PACKER</a>);
<span class="comment">//  bool bSuccessInitDefault =</span>
    <span class="comment">//OTDB::InitDefaultStorage(OTDB_DEFAULT_STORAGE, OTDB_DEFAULT_PACKER,SERVER_MAIN_FILENAME);</span>
    <span class="comment">// -------------------------------------------------------</span>


    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// Load up the transaction number and other OTServer data members.</span>
    <span class="comment">//</span>
    <span class="keywordtype">bool</span> bMainFileExists = m_strWalletFilename.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<span class="stringliteral">&quot;.&quot;</span>, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : <span class="keyword">false</span>;

    <span class="keywordflow">if</span> (!bMainFileExists)
    {
        <span class="keywordflow">if</span> (bReadOnly)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Main file non-existent (%s). &quot;</span>
                          <span class="stringliteral">&quot;Plus, unable to create, since read-only flag is set.\n&quot;</span>,
                          __FUNCTION__,
                          m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;  <span class="comment">// end execution here.</span>
        }
        <span class="keywordflow">else</span>
            bMainFileExists = <a class="code" href="class_o_t_server.html#aaf75e5038bc9879632d9a5519a68e78b">CreateMainFile</a>();
    }
    <span class="comment">// -----------------------------------</span>
    <span class="keywordflow">if</span> (bMainFileExists)
    {
        <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#a8d2815b41859393bdc3d2e63e3e62222">LoadMainFile</a>(bReadOnly))
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;\n%s: Error in Loading Main File!\n&quot;</span>, __FUNCTION__);
            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;  <span class="comment">// end execution here.</span>
        }

        <span class="comment">// We just want to call this function once in order to make sure that the</span>
        <span class="comment">// Nym is loaded up and ready for use decrypting messages that are sent to it.</span>
        <span class="comment">// If you comment this out, the server will be unable to decrypt and open envelopes.</span>
        <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#a4763bf53853ca87407c23ba152a8ebe4">ValidateServerIDfromUser</a>(m_strServerID))
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;\n%s: Error in Validation of ServerID from User!\n&quot;</span>, __FUNCTION__);
            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;  <span class="comment">// end execution here.</span>
        }
    }

    <span class="comment">// With the Server&#39;s private key loaded, and the latest transaction number loaded,</span>
    <span class="comment">// and all the various other data (contracts, etc) the server is now ready for operation!</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3ecda4645f3d7fce295f5b6f78d53852"></a><!-- doxytag: member="OTServer::IsFlaggedForShutdown" ref="a3ecda4645f3d7fce295f5b6f78d53852" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a3ecda4645f3d7fce295f5b6f78d53852">OTServer::IsFlaggedForShutdown</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00300">300</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_bShutdownFlag; }
</pre></div>
</div>
</div>
<a class="anchor" id="ab1bb5230bbd1f13dc1b43203c092b99c"></a><!-- doxytag: member="OTServer::IssueNextTransactionNumber" ref="ab1bb5230bbd1f13dc1b43203c092b99c" args="(OTPseudonym &amp;theNym, int64_t &amp;lTransactionNumber, bool bStoreTheNumber=true)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">OTServer::IssueNextTransactionNumber</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bStoreTheNumber</em> = <code>true</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Just as every request must be accompanied by a request number, so every transaction request must be accompanied by a transaction number. The request numbers can simply be incremented on both sides (per user.) But the transaction numbers must be issued by the server and they do not repeat from user to user. They are unique to transaction.</p>
<p>Users must ask the server to send them transaction numbers so that they can be used in transaction requests. The server keeps an internal counter and maintains a data file to store the latest one.</p>
<p>More specifically, the server file itself stores the latest transaction number (So it knows what number to issue and increment when the next request comes in.)</p>
<p>But once it issues the next number, that number needs to be recorded in the nym file for the user it was issued to, so that it can be verified later when he submits it for a transaction--and so it can be removed once the transaction is complete (so it won't work twice.)</p>
<p>The option to bSaveTheNumber defaults to true for this reason. But sometimes it will be sent to false, in cases where the number doesn't need to be saved because it's never going to be verified. For example, if the server creates a transaction number so it can put a transaction into your inbox, it's never going to have to verify that it actually put it into the inbox by checking it's own nymfile for that transaction number. Instead it would just check its own server signature on the inbox. But I digress... </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00579">579</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID(theNym), SERVER_NYM_ID(m_nymServer);

    <span class="comment">// If theNym has the same ID as m_nymServer, then we&#39;ll use m_nymServer</span>
    <span class="comment">// instead of theNym.  (Since it&#39;s the same nym anyway, we&#39;ll stick to the</span>
    <span class="comment">// one we already loaded so any changes don&#39;t get overwritten later.)</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = NULL;

    <span class="keywordflow">if</span> (NYM_ID == SERVER_NYM_ID)
        pNym = &amp;m_nymServer;
    <span class="keywordflow">else</span>
        pNym = &amp;theNym;

    <span class="comment">// ----------------------------------------------------------------------------</span>

    <span class="comment">// m_lTransactionNumber stores the last VALID AND ISSUED transaction number.</span>
    <span class="comment">// So first, we increment that, since we don&#39;t want to issue the same number twice.</span>
    m_lTransactionNumber++;

    <span class="comment">// Next, we save it to file.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>())
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error saving main server file.\n&quot;</span>);
        m_lTransactionNumber--;
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }

    <span class="comment">// Each Nym stores the transaction numbers that have been issued to it.</span>
    <span class="comment">// (On client AND server side.)</span>
    <span class="comment">//</span>
    <span class="comment">// So whenever the server issues a new number, it&#39;s to a specific Nym, then</span>
    <span class="comment">// it is recorded in his Nym file before being sent to the client (where it</span>
    <span class="comment">// is also recorded in his Nym file.)  That way the server always knows which</span>
    <span class="comment">// numbers are valid for each Nym.</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bStoreTheNumber &amp;&amp;
             (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(m_nymServer, m_strServerID, m_lTransactionNumber, <span class="keyword">true</span>))) <span class="comment">// bSave = true</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error adding transaction number to Nym file.\n&quot;</span>);
        m_lTransactionNumber--;
        <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>(); <span class="comment">// Save it back how it was, since we&#39;re not issuing this number after all.</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }

    <span class="comment">// SUCCESS?</span>
    <span class="comment">// Now the server main file has saved the latest transaction number,</span>
    <span class="comment">// and the number has been stored on the relevant nym file.</span>
    <span class="comment">// NOW we set it onto the parameter and return true.</span>
    <span class="keywordflow">else</span>
    {
        lTransactionNumber = m_lTransactionNumber;
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a175acb5666be74924ad2237c6deceb43"></a><!-- doxytag: member="OTServer::LoadConfigFile" ref="a175acb5666be74924ad2237c6deceb43" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a175acb5666be74924ad2237c6deceb43">OTServer::LoadConfigFile</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00928">928</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::LoadConfigFile()&quot;</span>;

    <span class="comment">// Setup Config File</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strConfigFolder, strConfigFilename;

    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a624a126d059f0db031d894de786b4011">OTDataFolder::IsInitialized</a>()) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };

    <span class="comment">// Create Config Object (OTSettings)</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strConfigFilePath=<span class="stringliteral">&quot;&quot;</span>;
    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a03f3da5b6d8d7f3df43757c66cbb8693">OTDataFolder::GetConfigFilePath</a>(strConfigFilePath)) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
    <a class="code" href="class_o_t_settings.html">OTSettings</a> * p_Config = NULL;
    p_Config = <span class="keyword">new</span> <a class="code" href="class_o_t_settings.html">OTSettings</a>(strConfigFilePath);

    <span class="comment">// First Load, Create new fresh config file if failed loading.</span>
    <span class="keywordflow">if</span> (!p_Config -&gt; Load())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;%s: Note: Unable to Load Config. Creating a new file: %s\n&quot;</span>, szFunc, strConfigFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
        <span class="keywordflow">if</span> (!p_Config -&gt; Save() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }

    <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;

    <span class="comment">// Second Load, Throw Assert if Failed loading.</span>
    <span class="keywordflow">if</span> (!p_Config -&gt; Load())
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(0,<span class="stringliteral">&quot;%s: Error: Unable to load config file: %s It should exist, as we just saved it!\n&quot;</span>, szFunc, strConfigFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
    }


    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// LOG LEVEL</span>
    {
        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;logging&quot;</span>,<span class="stringliteral">&quot;log_level&quot;</span>,0,lValue,bIsNewKey);
        <a class="code" href="class_o_t_log.html#a42b7411eaf5734cc10825d53939f4a0d">OTLog::SetLogLevel</a>(static_cast&lt;int32_t&gt; (lValue));
    }


    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// WALLET</span>

    <span class="comment">// WALLET FILENAME</span>
    <span class="comment">//</span>
    <span class="comment">// Clean and Set</span>
    {
        <span class="keywordtype">bool</span> bIsNewKey;
        <a class="code" href="class_o_t_string.html">OTString</a> strValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a3771310348bc201a8444ef3f55e59142">CheckSet_str</a>(<span class="stringliteral">&quot;wallet&quot;</span>,<span class="stringliteral">&quot;wallet_filename&quot;</span>,<a class="code" href="_o_t_server_8cpp.html#a7ef5c35c1a04e80acec81a673b10fae3">SERVER_WALLET_FILENAME</a>,strValue,bIsNewKey);
        m_strWalletFilename.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(strValue);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;Using Wallet: %s\n&quot;</span>,strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }

    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// CRON</span>
    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;;; CRON  (regular events like market trades and smart contract clauses)\n&quot;</span>;

        <span class="keywordtype">bool</span> b_SectionExist;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a2d5bbcf1220477060e6d6d8e1db70859">CheckSetSection</a>(<span class="stringliteral">&quot;cron&quot;</span>,szComment,b_SectionExist);
    }

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; refill_trans_number is the count of transaction numbers cron will grab for itself,\n&quot;</span>
        <span class="stringliteral">&quot;; whenever its supply is getting low.  If it ever drops below 20% of this count\n&quot;</span>
        <span class="stringliteral">&quot;; while in the middle of processing, it will put a WARNING into your server log.\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;cron&quot;</span>,<span class="stringliteral">&quot;refill_trans_number&quot;</span>,500,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_cron.html#a40e88ae62f7c536109228251feace4be">OTCron::SetCronRefillAmount</a>(static_cast&lt;int32_t&gt;(lValue));
    }

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; ms_between_cron_beats is the number of milliseconds before Cron processes\n&quot;</span>
        <span class="stringliteral">&quot;; (all the trades, all the smart contracts, etc every 10 seconds.)\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;cron&quot;</span>,<span class="stringliteral">&quot;ms_between_cron_beats&quot;</span>,10000,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_cron.html#a619a81f1f5a75c7f9e20d5542b8f9fe9">OTCron::SetCronMsBetweenProcess</a>(static_cast&lt;int32_t&gt;(lValue));
    }

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; max_items_per_nym is the number of cron items (such as market offers or payment\n&quot;</span>
        <span class="stringliteral">&quot;; plans) that any given Nym is allowed to have live and active at the same time.\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;cron&quot;</span>,<span class="stringliteral">&quot;max_items_per_nym&quot;</span>,10,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_cron.html#acdc92929308e95fa1af64320d3c51191">OTCron::SetCronMaxItemsPerNym</a>(static_cast&lt;int32_t&gt;(lValue));
    }

    <span class="comment">// -----------------------------------</span>
    <span class="comment">// HEARTBEAT</span>

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;;; HEARTBEAT\n&quot;</span>;

        <span class="keywordtype">bool</span> bSectionExist;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a2d5bbcf1220477060e6d6d8e1db70859">CheckSetSection</a>(<span class="stringliteral">&quot;heartbeat&quot;</span>,szComment,bSectionExist);
    }

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; no_requests is the number of client requests the server processes per heartbeat.\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;heartbeat&quot;</span>,<span class="stringliteral">&quot;no_requests&quot;</span>,10,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_server.html#a63cfec2112f3b2a8490790a8fb8264fb">OTServer::SetHeartbeatNoRequests</a>(static_cast&lt;int32_t&gt;(lValue));
    }

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; ms_between_beats is the number of milliseconds between each heartbeat.\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;heartbeat&quot;</span>,<span class="stringliteral">&quot;ms_between_beats&quot;</span>,100,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_server.html#a95e4bb3ce17ee91a57c8027dfd00255d">OTServer::SetHeartbeatMsBetweenBeats</a>(static_cast&lt;int32_t&gt;(lValue));
    }


    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// PERMISSIONS</span>

    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
            <span class="stringliteral">&quot;;; PERMISSIONS\n&quot;</span>
            <span class="stringliteral">&quot;;; You can deactivate server functions here by setting them to false.\n&quot;</span>
            <span class="stringliteral">&quot;;; (Even if you do, override_nym_id will STILL be able to do those functions.)\n&quot;</span>;

        <span class="keywordtype">bool</span> bSectionExists;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a2d5bbcf1220477060e6d6d8e1db70859">CheckSetSection</a>(<span class="stringliteral">&quot;permissions&quot;</span>,szComment,bSectionExists);
    }

    {
        <a class="code" href="class_o_t_string.html">OTString</a> strValue;
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szValue;

        std::string stdstrValue = <a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>();
        szValue = stdstrValue.c_str();

        <span class="keywordtype">bool</span> bIsNewKey;

        <span class="keywordflow">if</span> (NULL == szValue)
            p_Config-&gt;<a class="code" href="class_o_t_settings.html#a3771310348bc201a8444ef3f55e59142">CheckSet_str</a>(<span class="stringliteral">&quot;permissions&quot;</span>,<span class="stringliteral">&quot;override_nym_id&quot;</span>,NULL,strValue,bIsNewKey);
        <span class="keywordflow">else</span>
            p_Config-&gt;<a class="code" href="class_o_t_settings.html#a3771310348bc201a8444ef3f55e59142">CheckSet_str</a>(<span class="stringliteral">&quot;permissions&quot;</span>,<span class="stringliteral">&quot;override_nym_id&quot;</span>,szValue,strValue,bIsNewKey);

        <a class="code" href="class_o_t_server.html#aacf5bdeecd0f8c3e1b923e7547a11810">OTServer::SetOverrideNymID</a>(strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }

    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// MARKETS</span>

    {
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
        <span class="stringliteral">&quot;; minimum_scale is the smallest allowed power-of-ten for the scale, for any market.\n&quot;</span>
        <span class="stringliteral">&quot;; (1oz, 10oz, 100oz, 1000oz.)\n&quot;</span>;

    <span class="keywordtype">bool</span> bIsNewKey;
    int64_t lValue;
    p_Config -&gt; CheckSet_long(<span class="stringliteral">&quot;markets&quot;</span>,<span class="stringliteral">&quot;minimum_scale&quot;</span>,<a class="code" href="class_o_t_server.html#ada3425a1d2aed3991a889fe6c934f5f8">GetMinMarketScale</a>(),lValue,bIsNewKey,szComment);
    this-&gt;<a class="code" href="class_o_t_server.html#aeb1ec70655351bd1b4fac9d76f78c304">SetMinMarketScale</a>(lValue);
    }

    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// SECURITY (beginnings of..)</span>

    <span class="comment">// Master Key Timeout</span>
    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
            <span class="stringliteral">&quot;; master_key_timeout is how int64_t the master key will be in memory until a thread wipes it out.\n&quot;</span>
            <span class="stringliteral">&quot;; 0   : means you have to type your password EVERY time OT uses a private key. (Even multiple times in a single function.)\n&quot;</span>
            <span class="stringliteral">&quot;; 300 : means you only have to type it once per 5 minutes.\n&quot;</span>
            <span class="stringliteral">&quot;; -1  : means you only type it once PER RUN (popular for servers.)\n&quot;</span>;

        <span class="keywordtype">bool</span> bIsNewKey;
        int64_t lValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a03475b7711763cca0470c242f9c1c786">CheckSet_long</a>(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;master_key_timeout&quot;</span>,<a class="code" href="_o_t_server_8cpp.html#a31bf0284bd4189d43043f04ad16bff57">SERVER_MASTER_KEY_TIMEOUT_DEFAULT</a>,lValue,bIsNewKey,szComment);
        <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SetTimeoutSeconds(static_cast&lt;int32_t&gt;(lValue));
    }

    <span class="comment">// Use System Keyring</span>
    {
        <span class="keywordtype">bool</span> bIsNewKey;
        <span class="keywordtype">bool</span> bValue;
        p_Config-&gt;<a class="code" href="class_o_t_settings.html#a27314a76cb518d7959ffd100bb9d2103">CheckSet_bool</a>(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;use_system_keyring&quot;</span>,<a class="code" href="_o_t_server_8cpp.html#a18fb8d9415908ad23854bef47d425974">SERVER_USE_SYSTEM_KEYRING</a>,bValue,bIsNewKey);
        <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;UseSystemKeyring(bValue);


<span class="preprocessor">#if defined(OT_KEYRING_FLATFILE)</span>
<span class="preprocessor"></span>        <span class="comment">// Is there a password folder? (There shouldn&#39;t be, but we allow it...)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (bValue)
        {
            <span class="keywordtype">bool</span> bIsNewKey2;
            <a class="code" href="class_o_t_string.html">OTString</a> strValue;
            p_Config-&gt;<a class="code" href="class_o_t_settings.html#a3771310348bc201a8444ef3f55e59142">CheckSet_str</a>(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;password_folder&quot;</span>,<a class="code" href="_o_t_server_8cpp.html#a867d3f6f3125bfd4c97247dc9dd44497">SERVER_PASSWORD_FOLDER</a>,strValue,bIsNewKey2);
            <span class="keywordflow">if</span> (strValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                OTKeyring::FlatFile_SetPasswordFolder(strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot; Using server password folder: %s\n&quot;</span>,strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// (#defined right above this function.)</span>
    <span class="comment">//</span>

    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;admin_usage_credits&quot;</span>,      __admin_usage_credits);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;admin_server_locked&quot;</span>,      __admin_server_locked);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_usage_credits&quot;</span>,        __cmd_usage_credits);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_issue_asset&quot;</span>,          __cmd_issue_asset);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_contract&quot;</span>,         __cmd_get_contract);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_check_server_id&quot;</span>,      __cmd_check_server_id);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_create_user_acct&quot;</span>,     __cmd_create_user_acct);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_del_user_acct&quot;</span>,        __cmd_del_user_acct);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_check_user&quot;</span>,           __cmd_check_user);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_request&quot;</span>,          __cmd_get_request);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_trans_num&quot;</span>,        __cmd_get_trans_num);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_send_message&quot;</span>,         __cmd_send_message);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_nymbox&quot;</span>,           __cmd_get_nymbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_process_nymbox&quot;</span>,       __cmd_process_nymbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_create_asset_acct&quot;</span>,    __cmd_create_asset_acct);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_del_asset_acct&quot;</span>,       __cmd_del_asset_acct);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_acct&quot;</span>,             __cmd_get_acct);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_inbox&quot;</span>,            __cmd_get_inbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_outbox&quot;</span>,           __cmd_get_outbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_process_inbox&quot;</span>,        __cmd_process_inbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_issue_basket&quot;</span>,         __cmd_issue_basket);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_exchange_basket&quot;</span>, __transact_exchange_basket);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_notarize_transaction&quot;</span>, __cmd_notarize_transaction);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_process_inbox&quot;</span>,   __transact_process_inbox);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_transfer&quot;</span>,        __transact_transfer);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_withdrawal&quot;</span>,      __transact_withdrawal);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_deposit&quot;</span>,         __transact_deposit);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_withdraw_voucher&quot;</span>,__transact_withdraw_voucher);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_pay_dividend&quot;</span>,    __transact_pay_dividend);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_deposit_cheque&quot;</span>,  __transact_deposit_cheque);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_mint&quot;</span>,             __cmd_get_mint);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_withdraw_cash&quot;</span>,   __transact_withdraw_cash);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_deposit_cash&quot;</span>,    __transact_deposit_cash);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_market_list&quot;</span>,      __cmd_get_market_list);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_market_offers&quot;</span>,    __cmd_get_market_offers);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_market_recent_trades&quot;</span>,__cmd_get_market_recent_trades);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_get_nym_market_offers&quot;</span>,__cmd_get_nym_market_offers);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_market_offer&quot;</span>,    __transact_market_offer);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_payment_plan&quot;</span>,    __transact_payment_plan);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_cancel_cron_item&quot;</span>,__transact_cancel_cron_item);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;transact_smart_contract&quot;</span>,  __transact_smart_contract);
    p_Config-&gt;<a class="code" href="class_o_t_settings.html#a20242f0243259d5a5149cd2237444b38">SetOption_bool</a>(<span class="stringliteral">&quot;permissions&quot;</span>, <span class="stringliteral">&quot;cmd_trigger_clause&quot;</span>,       __cmd_trigger_clause);

    <span class="comment">// Done Loading... Lets save any changes...</span>
    <span class="keywordflow">if</span> (!p_Config -&gt; Save())
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error! Unable to save updated Config!!!\n&quot;</span>,szFunc);
        <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
    }

    <span class="comment">// Finsihed Saving... now lets cleanup!</span>
    <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;

    <span class="keywordflow">if</span> (NULL != p_Config) <span class="keyword">delete</span> p_Config;
    p_Config = NULL;

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8d2815b41859393bdc3d2e63e3e62222"></a><!-- doxytag: member="OTServer::LoadMainFile" ref="a8d2815b41859393bdc3d2e63e3e62222" args="(bool bReadOnly=false)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a8d2815b41859393bdc3d2e63e3e62222">OTServer::LoadMainFile</a> </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bReadOnly</em> = <code>false</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01817">1817</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (!<a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<span class="stringliteral">&quot;.&quot;</span>, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error finding file: %s\n&quot;</span>, __FUNCTION__, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(<span class="stringliteral">&quot;.&quot;</span>, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())); <span class="comment">// &lt;=== LOADING FROM DATA STORE.</span>

    <span class="keywordflow">if</span> (!strFileContents.Exists())
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to read main file: %s\n&quot;</span>,
                      __FUNCTION__, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">//</span>
    <span class="comment">// If, for example, the server user Nym is in old format (no master key)</span>
    <span class="comment">// then we will set this to true while loading. Then at the BOTTOM of this</span>
    <span class="comment">// function, we&#39;ll convert the Nym to the new format and re-save the notary</span>
    <span class="comment">// file.</span>
    <span class="comment">//</span>
    <span class="keywordtype">bool</span> bNeedToConvertUser = <span class="keyword">false</span>;
    <span class="keywordtype">bool</span> bNeedToSaveAgain = <span class="keyword">false</span>;

    <span class="keywordtype">bool</span> bFailure = <span class="keyword">false</span>;

    {
        <a class="code" href="class_o_t_string_x_m_l.html">OTStringXML</a> xmlFileContents(strFileContents);

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == xmlFileContents.DecodeIfArmored()) <span class="comment">// bEscapedIsAllowed=true by default.</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Notary server file apparently was encoded and then failed decoding. Filename: %s \n&quot;</span>
                          <span class="stringliteral">&quot;Contents: \n%s\n&quot;</span>, __FUNCTION__, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFileContents.Get());
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="comment">// --------------------------------------------------------------------</span>
        <a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>* xml = irr::io::createIrrXMLReader(xmlFileContents);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;irr::io::IrrXMLReader&gt;</a> theXMLGuardian(xml); <span class="comment">// So I don&#39;t have to clean it up later.</span>
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="comment">// parse the file until end reached</span>
        <span class="keywordflow">while</span>(xml &amp;&amp; xml-&gt;read())
        {
            <span class="comment">// strings for storing the data that we want to read out of the file</span>

            <a class="code" href="class_o_t_string.html">OTString</a> AssetName;
            <a class="code" href="class_o_t_string.html">OTString</a> AssetContract;
            <a class="code" href="class_o_t_string.html">OTString</a> AssetID;

            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNodeName(xml-&gt;getNodeName());

            <span class="keywordflow">switch</span>(xml-&gt;getNodeType())
            {
            <span class="keywordflow">case</span> irr::io::EXN_TEXT:
                    <span class="comment">// in this xml file, the only text which occurs is the messageText</span>
                    <span class="comment">//messageText = xml-&gt;getNodeData();</span>
                    <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> irr::io::EXN_ELEMENT:
                {
                    <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;notaryServer&quot;</span>))
                    {
                        m_strVersion            = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;version&quot;</span>);
                        m_strServerID           = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverID&quot;</span>);
                        m_strServerUserID       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverUserID&quot;</span>);


                        <a class="code" href="class_o_t_string.html">OTString</a> strTransactionNumber;  <span class="comment">// The server issues transaction numbers and stores the counter here for the latest one.</span>
                        strTransactionNumber    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;transactionNum&quot;</span>);
                        m_lTransactionNumber    = atol(strTransactionNumber.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nLoading Open Transactions server. File version: %s\n&quot;</span>
                                       <span class="stringliteral">&quot; Last Issued Transaction Number: %ld\n Server ID:      %s\n Server User ID: %s\n&quot;</span>,
                                       m_strVersion.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), m_lTransactionNumber, m_strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), m_strServerUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="comment">// --------------------------------------------------------------------</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (m_strVersion.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;1.0&quot;</span>)) <span class="comment">// This means this Nym has not been converted yet to master password.</span>
                        {
                            bNeedToConvertUser = <span class="keyword">true</span>;

                            <span class="keywordflow">if</span> (!(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused()))
                                <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Pause();

                            <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_o_t_server.html#aeff979d74c94eac885a8fe27fe698e8a">LoadServerUserAndContract</a>())
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed calling LoadServerUserAndContract.\n&quot;</span>, __FUNCTION__);
                                bFailure = <span class="keyword">true</span>;
                            }

                            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
                                <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Unpause();
                        }
                        <span class="comment">// --------------------------------------------------------------------</span>
                    }
                    <span class="comment">// todo in the future just remove masterkey. I&#39;m leaving it for now so people&#39;s</span>
                    <span class="comment">// data files can get converted over. After a while just remove it.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;masterKey&quot;</span>) || strNodeName.Compare(<span class="stringliteral">&quot;cachedKey&quot;</span>))
                    {
                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCachedKey;

                        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, ascCachedKey))
                        {
                            <span class="comment">// We successfully loaded the masterKey from file, so let&#39;s SET it</span>
                            <span class="comment">// as the master key globally...</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SetCachedKey(ascCachedKey);

                            <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;HasHashCheck())
                            {
                                <a class="code" href="class_o_t_password.html">OTPassword</a> tempPassword; tempPassword.<a class="code" href="class_o_t_password.html#a3a971b06f42d1c89802167a0ab5330a5">zeroMemory</a>();
                                _SharedPtr&lt;OTCachedKey&gt; sharedPtr(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>());
                                bNeedToSaveAgain = sharedPtr-&gt;GetMasterPassword(sharedPtr, tempPassword,
                                                                                <span class="stringliteral">&quot;We do not have a check hash yet for this password, &quot;</span>
                                                                                <span class="stringliteral">&quot;please enter your password&quot;</span>, <span class="keyword">true</span>);
                            }
                        }

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nLoading cachedKey:\n%s\n&quot;</span>, ascCachedKey.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="comment">// --------------------------------------------------------------------</span>
                        <span class="comment">//</span>
                        <span class="comment">// It&#39;s only here, AFTER the master key has been loaded, that we can</span>
                        <span class="comment">// go ahead and load the server user, the server contract, cron, etc.</span>
                        <span class="comment">// (It wasn&#39;t that way in version 1, before we had master keys.)</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == m_strVersion.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;1.0&quot;</span>)) <span class="comment">// This is, for example, 2.0</span>
                        {
                            <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_o_t_server.html#aeff979d74c94eac885a8fe27fe698e8a">LoadServerUserAndContract</a>())
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed calling LoadServerUserAndContract.\n&quot;</span>, __FUNCTION__);
                                bFailure = <span class="keyword">true</span>;
                            }
                        }
                        <span class="comment">// --------------------------------------------------------------------</span>
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;accountList&quot;</span>)) <span class="comment">// the voucher reserve account IDs.</span>
                    {
                        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctType  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;type&quot;</span>);
                        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctCount = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;count&quot;</span>);

                        <span class="keywordflow">if</span> ((-1) == m_VoucherAccts.<a class="code" href="class_o_t_acct_list.html#ab821444a5a7e7cc453182e755d5a00dc">ReadFromXMLNode</a>(xml, strAcctType, strAcctCount))
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading voucher accountList.\n&quot;</span>, __FUNCTION__);
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;basketInfo&quot;</span>))
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strBasketID            = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;basketID&quot;</span>);
                        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID        = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;basketAcctID&quot;</span>);
                        <a class="code" href="class_o_t_string.html">OTString</a> strBasketContractID    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;basketContractID&quot;</span>);

                        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> BASKET_ID(strBasketID), BASKET_ACCT_ID(strBasketAcctID), BASKET_CONTRACT_ID(strBasketContractID);

                        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_server.html#ac8efe3db8d0a98dfcd9758d622160c51">AddBasketAccountID</a>(BASKET_ID, BASKET_ACCT_ID, BASKET_CONTRACT_ID))
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Loading basket currency info...\n Basket ID: %s\n Basket Acct ID: %s\n Basket Contract ID: %s\n&quot;</span>,
                                           strBasketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strBasketAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strBasketContractID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="keywordflow">else</span>
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error adding basket currency info...\n Basket ID: %s\n Basket Acct ID: %s\n&quot;</span>,
                                          strBasketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strBasketAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }

                    <span class="comment">// Create an OTAssetContract and load them from file, (for each asset type),</span>
                    <span class="comment">// and add them to the internal map.</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;assetType&quot;</span>))
                    {
                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascAssetName = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>);

                        <span class="keywordflow">if</span> (ascAssetName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                            ascAssetName.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(AssetName, <span class="keyword">false</span>); <span class="comment">// linebreaks == false</span>

                        AssetID         = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;assetTypeID&quot;</span>);    <span class="comment">// hash of contract itself</span>

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\n****Asset Contract**** (server listing)\n Name: %s\n Contract ID: %s\n&quot;</span>,
                                       AssetName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), AssetID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                        <a class="code" href="class_o_t_string.html">OTString</a> strContractPath;
                        strContractPath = <a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();

                        <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(AssetName, strContractPath, AssetID, AssetID);

                        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;ASSERT: allocating memory for Asset Contract in OTServer::LoadMainFile\n&quot;</span>);

                        <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>())
                        {
                            <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
                            {
                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;** Asset Contract Verified **\n&quot;</span>);

                                pContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(AssetName);

                                m_mapContracts[AssetID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()] = pContract;
                            }
                            <span class="keywordflow">else</span>
                            {
                                <span class="keyword">delete</span> pContract; pContract = NULL;
                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Asset Contract FAILED to verify.\n&quot;</span>);
                            }
                        }
                        <span class="keywordflow">else</span>
                        {
                            <span class="keyword">delete</span> pContract; pContract = NULL;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed reading file for Asset Contract.\n&quot;</span>, __FUNCTION__);
                        }
                    }

                    <span class="comment">// This is where the server finds out his own contract, which he hashes in order to verify his</span>
                    <span class="comment">// serverID (which is either hardcoded or stored in the server xml file.)</span>
                    <span class="comment">//</span>
                    <span class="comment">// There should be only one of these per transaction server.</span>
                    <span class="comment">//</span>
                    <span class="comment">// Commented out because I don&#39;t need it right now. TODO. COMING SOON! So the server can load his</span>
                    <span class="comment">// port information out of the contract BEFORE it starts listening on the port (right now port is</span>
                    <span class="comment">// still hardcoded.)</span>
                    <span class="comment">// Todo: Server should also then immediately connect to itself BASED ON THE INFO IN THE CONTRACT</span>
                    <span class="comment">// in order to verify that whatever is running at that port IS, IN FACT, ITSELF!</span>
                    <span class="comment">/*</span>
<span class="comment">                    else if (strNodeName.Compare(&quot;notaryProvider&quot;))</span>
<span class="comment">                    {</span>
<span class="comment">                        ServerName      = xml-&gt;getAttributeValue(&quot;name&quot;);</span>
<span class="comment">                        ServerID        = xml-&gt;getAttributeValue(&quot;serverID&quot;);   // hash of contract itself</span>
<span class="comment"></span>
<span class="comment">                        OTLog::vOutput(0, &quot;\n\n****Notary Server (contract)**** (server listing) Name: %s\nContract ID:\n%s\n&quot;,</span>
<span class="comment">                                       ServerName.Get(), ServerID.Get());</span>
<span class="comment"></span>
<span class="comment">                        OTString strContractPath;</span>
<span class="comment">                        strContractPath.Format(&quot;%s%s%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(),</span>
<span class="comment">                                               OTFolders::Contract().Get(),</span>
<span class="comment">                                               OTLog::PathSeparator(), ServerID.Get());</span>
<span class="comment">                        OTServerContract * pContract = new OTServerContract(ServerName, strContractPath, ServerID);</span>
<span class="comment"></span>
<span class="comment">                        OT_ASSERT_MSG(NULL != pContract, &quot;Error allocating memory for Server Contract in OTServer::LoadMainFile\n&quot;);</span>
<span class="comment"></span>
<span class="comment">                        if (pContract-&gt;LoadContract())</span>
<span class="comment">                        {</span>
<span class="comment">                            if (pContract-&gt;VerifyContract())</span>
<span class="comment">                            {</span>
<span class="comment">                                OTLog::Output(0, &quot;** Server Contract Verified **\n&quot;);</span>
<span class="comment"></span>
<span class="comment">                                m_mapContracts[ServerID.Get()] = pContract;</span>
<span class="comment">                            }</span>
<span class="comment">                            else</span>
<span class="comment">                            {</span>
<span class="comment">                                delete pContract; pContract = NULL;</span>
<span class="comment">                                OTLog::Output(0, &quot;Server Contract FAILED to verify.\n&quot;);</span>
<span class="comment">                            }</span>
<span class="comment">                        }</span>
<span class="comment">                        else</span>
<span class="comment">                        {</span>
<span class="comment">                            delete pContract; pContract = NULL;</span>
<span class="comment">                            OTLog::Output(0, &quot;Failed reading file for Server Contract in OTServer::LoadMainFile\n&quot;);</span>
<span class="comment">                        }</span>
<span class="comment">                    }</span>
<span class="comment">                     */</span>



                    <span class="comment">/*</span>
<span class="comment">                     // commented out because, since I already have the serverID, then the server</span>
<span class="comment">                     // already knows which certfile to open in order to get at its private key.</span>
<span class="comment">                     // So I already have the private key loaded, so I don&#39;t need pseudonyms in</span>
<span class="comment">                     // the config file right now.</span>
<span class="comment">                     //</span>
<span class="comment">                     // In the future, I will load the server XML file (here) FIRST, and get the serverID and</span>
<span class="comment">                     // contract file from that. THEN I will hash the contract file and verify that it matches</span>
<span class="comment">                     // the serverID. THEN I will use that serverID to open the Certfile and get my private key.</span>
<span class="comment">                     //</span>
<span class="comment">                     // In the meantime I don&#39;t need this yet, serverID is setup in the config file (that I&#39;m reading now.)</span>
<span class="comment">                    else if (strNodeName.Compare(&quot;pseudonym&quot;)) // The server has to sign things, too.</span>
<span class="comment">                    {</span>
<span class="comment">                        NymName = xml-&gt;getAttributeValue(&quot;name&quot;);// user-assigned name for GUI usage</span>
<span class="comment">                        NymID = xml-&gt;getAttributeValue(&quot;nymID&quot;); // message digest from hash of x.509 cert, used to look up certfile.</span>
<span class="comment"></span>
<span class="comment">                        OTLog::vOutput(0, &quot;\n\n** Pseudonym ** (server): %s\nID: %s\nfile: %s\n&quot;,</span>
<span class="comment">                                NymName.Get(), NymID.Get(), NymFile.Get());</span>
<span class="comment"></span>
<span class="comment">                        OTPseudonym * pNym = new OTPseudonym(NymName, NymFile, NymID);</span>
<span class="comment"></span>
<span class="comment">                        if (pNym &amp;&amp; pNym-&gt;LoadNymfile((char*)(NymFile.Get())))</span>
<span class="comment">                        {</span>
<span class="comment">                            if (pNym-&gt;Loadx509CertAndPrivateKey())</span>
<span class="comment">                            {</span>
<span class="comment">                                if (pNym-&gt;VerifyPseudonym())</span>
<span class="comment">                                {</span>
<span class="comment">                                    m_mapNyms[NymID.Get()] = pNym;</span>
<span class="comment">                                    g_pTemporaryNym = pNym; // TODO remove this temporary line used for testing only.</span>
<span class="comment">                                }</span>
<span class="comment">                                else {</span>
<span class="comment">                                    OTLog::Error(&quot;Error verifying public key from x509 against Nym ID in OTWallet::LoadWallet\n&quot;);</span>
<span class="comment">                                }</span>
<span class="comment">                            }</span>
<span class="comment">                            else {</span>
<span class="comment">                                OTLog::Error(&quot;Error loading x509 file for Pseudonym in OTWallet::LoadWallet\n&quot;);</span>
<span class="comment">                            }</span>
<span class="comment">                        }</span>
<span class="comment">                        else {</span>
<span class="comment">                            OTLog::Error(&quot;Error creating or loading Nym in OTWallet::LoadWallet\n&quot;);</span>
<span class="comment">                        }</span>
<span class="comment">                    }</span>
<span class="comment">                    */</span>

                    <span class="keywordflow">else</span>
                    {
                        <span class="comment">// unknown element type</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unknown element type: %s\n&quot;</span>, __FUNCTION__, xml-&gt;getNodeName());
                    }
                }
                    <span class="keywordflow">break</span>;
                    <span class="comment">// --------------------</span>
                <span class="keywordflow">default</span>:
                    <span class="keywordflow">break</span>;
            } <span class="comment">// switch</span>
        } <span class="comment">// while xml-&gt;read</span>
    }
    <span class="comment">// --------------------------------</span>
    <span class="keywordflow">if</span> (!bReadOnly)
    {
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strReason(<span class="stringliteral">&quot;Converting Server Nym to master key.&quot;</span>);
            <span class="keywordflow">if</span> (bNeedToConvertUser &amp;&amp; m_nymServer.<a class="code" href="class_o_t_pseudonym.html#a395ce52dec4e07f04fb66521897c9cf2">Savex509CertAndPrivateKey</a>(<span class="keyword">true</span>, &amp;strReason)) <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>();
        }
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strReason(<span class="stringliteral">&quot;Creating a Hash Check for the master key.&quot;</span>);
            <span class="keywordflow">if</span> (bNeedToSaveAgain &amp;&amp; m_nymServer.<a class="code" href="class_o_t_pseudonym.html#a395ce52dec4e07f04fb66521897c9cf2">Savex509CertAndPrivateKey</a>(<span class="keyword">true</span>, &amp;strReason)) <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>();
        }
    }
    <span class="keywordflow">return</span> !bFailure;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aeff979d74c94eac885a8fe27fe698e8a"></a><!-- doxytag: member="OTServer::LoadServerUserAndContract" ref="aeff979d74c94eac885a8fe27fe698e8a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#aeff979d74c94eac885a8fe27fe698e8a">OTServer::LoadServerUserAndContract</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01445">1445</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> *szFunc = <span class="stringliteral">&quot;OTServer::LoadServerUserAndContract&quot;</span>;
    <span class="keywordtype">bool</span> bSuccess      = <span class="keyword">false</span>;
    <span class="comment">// -----------------------------------------</span>
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(m_strVersion.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(m_strServerID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(m_strServerUserID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
    <span class="comment">// -----------------------------------------</span>
    <span class="comment">//</span>
    m_nymServer.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(m_strServerUserID);

    <span class="keywordflow">if</span> (!m_nymServer.<a class="code" href="class_o_t_pseudonym.html#aa5a79982c08a8db1c961d05fd449b585">Loadx509CertAndPrivateKey</a>(<span class="keyword">false</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading server certificate and keys.\n&quot;</span>, szFunc);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_nymServer.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error verifying server nym.\n&quot;</span>, szFunc);
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// This file will be saved during the course of operation</span>
        <span class="comment">// Just making sure it is loaded up first.</span>
        <span class="comment">//</span>
        <span class="keywordtype">bool</span> bLoadedSignedNymfile = m_nymServer.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(m_nymServer);
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bLoadedSignedNymfile, <span class="stringliteral">&quot;ASSERT: OTServer::LoadServerUserAndContract: m_nymServer.LoadSignedNymfile(m_nymServer)\n&quot;</span>);
<span class="comment">//      m_nymServer.SaveSignedNymfile(m_nymServer); // Uncomment this if you want to create the file. NORMALLY LEAVE IT OUT!!!! DANGEROUS!!!</span>

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Loaded server certificate and keys.\nNext, loading Cron...\n&quot;</span>, szFunc);
        <span class="comment">// ----------------------------------------------------------------</span>
        <span class="comment">// Load Cron (now that we have the server Nym.</span>
        <span class="comment">// (I WAS loading this erroneously in Server.Init(), before</span>
        <span class="comment">// the Nym had actually been loaded from disk. That didn&#39;t work.)</span>
        <span class="comment">//</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID);

        <span class="comment">// Make sure the Cron object has a pointer to the server&#39;s Nym.</span>
        <span class="comment">// (For signing stuff...)</span>
        <span class="comment">//</span>
        m_Cron.<a class="code" href="class_o_t_cron.html#a7c421c0abe1a6728a2a056bfb46a3de2">SetServerID</a>(SERVER_ID);
        m_Cron.<a class="code" href="class_o_t_cron.html#a8c09682be017ef6c39a84c27123e23b2">SetServerNym</a>(&amp;m_nymServer);

        <span class="keywordflow">if</span> (!m_Cron.<a class="code" href="class_o_t_cron.html#a6ad24d6d2669343157613f0efa017312">LoadCron</a>())
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading Cron file. (Did you just create this server?)\n&quot;</span>, szFunc);
        <span class="comment">// ----------------------------------------------------------------</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Loading the server contract...\n&quot;</span>, szFunc);

        <span class="comment">// We have the serverID, so let&#39;s load  up the server Contract!</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strContractPath(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());

        <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>(m_strServerID, strContractPath, m_strServerID, m_strServerID);
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;ASSERT while allocating memory for main Server Contract in OTServer::LoadServerUserAndContract\n&quot;</span>);

        <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>())
        {
            <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n** Main Server Contract Verified **\n&quot;</span>);
                m_pServerContract = pContract;
                bSuccess          = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
                <span class="keyword">delete</span> pContract; pContract = NULL;
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\nMain Server Contract FAILED to verify.\n&quot;</span>);
            }
        }
        <span class="keywordflow">else</span>
        {
            <span class="keyword">delete</span> pContract; pContract = NULL;
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n%s: Failed reading Main Server Contract:\n%s\n&quot;</span>, szFunc,
                           strContractPath.Get());
        }
    }

    <span class="keywordflow">return</span> bSuccess;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad42ad136163957930d250c295d135a83"></a><!-- doxytag: member="OTServer::LookupBasketAccountID" ref="ad42ad136163957930d250c295d135a83" args="(const OTIdentifier &amp;BASKET_ID, OTIdentifier &amp;BASKET_ACCOUNT_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ad42ad136163957930d250c295d135a83">OTServer::LookupBasketAccountID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ACCOUNT_ID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Use this to find the basket account for this server (which is unique to this server) using the basket ID to look it up (the Basket ID is the same for all servers) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00429">429</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// Server stores a map of BASKET_ID to BASKET_ACCOUNT_ID. Let&#39;s iterate through that map...</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#a25e6368c39fb959e4cb7b6c2cdef4f40">mapOfBaskets</a>, m_mapBaskets)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketID        = (*it).first.c_str();
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID    = (*it).second.c_str();

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> id_BASKET(strBasketID), id_BASKET_ACCT(strBasketAcctID);

        <span class="keywordflow">if</span> (BASKET_ID == id_BASKET) <span class="comment">// if the basket ID passed in matches this one...</span>
        {
            BASKET_ACCOUNT_ID = id_BASKET_ACCT;
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a257d4016ba99b0bb6c1762fa014e4623"></a><!-- doxytag: member="OTServer::LookupBasketAccountIDByContractID" ref="a257d4016ba99b0bb6c1762fa014e4623" args="(const OTIdentifier &amp;BASKET_CONTRACT_ID, OTIdentifier &amp;BASKET_ACCOUNT_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a257d4016ba99b0bb6c1762fa014e4623">OTServer::LookupBasketAccountIDByContractID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_CONTRACT_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ACCOUNT_ID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Use this to find the basket account ID for this server (which is unique to this server) using the contract ID to look it up. (The basket contract ID is unique to this server.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00385">385</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// Server stores a map of BASKET_ID to BASKET_ACCOUNT_ID. Let&#39;s iterate through that map...</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#a25e6368c39fb959e4cb7b6c2cdef4f40">mapOfBaskets</a>, m_mapBasketContracts)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketContractID    = (*it).first.c_str();
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID        = (*it).second.c_str();

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> id_BASKET_CONTRACT(strBasketContractID), id_BASKET_ACCT(strBasketAcctID);

        <span class="keywordflow">if</span> (BASKET_CONTRACT_ID == id_BASKET_CONTRACT) <span class="comment">// if the basket contract ID passed in matches this one...</span>
        {
            BASKET_ACCOUNT_ID = id_BASKET_ACCT;
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae347553eb664ea7416240d0f5c9e9ebf"></a><!-- doxytag: member="OTServer::LookupBasketContractIDByAccountID" ref="ae347553eb664ea7416240d0f5c9e9ebf" args="(const OTIdentifier &amp;BASKET_ACCOUNT_ID, OTIdentifier &amp;BASKET_CONTRACT_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ae347553eb664ea7416240d0f5c9e9ebf">OTServer::LookupBasketContractIDByAccountID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ACCOUNT_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_CONTRACT_ID</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Use this to find the basket account ID for this server (which is unique to this server) using the contract ID to look it up. (The basket contract ID is unique to this server.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00407">407</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// Server stores a map of BASKET_ID to BASKET_ACCOUNT_ID. Let&#39;s iterate through that map...</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#a25e6368c39fb959e4cb7b6c2cdef4f40">mapOfBaskets</a>, m_mapBasketContracts)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketContractID    = (*it).first.c_str();
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID        = (*it).second.c_str();

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> id_BASKET_CONTRACT(strBasketContractID), id_BASKET_ACCT(strBasketAcctID);

        <span class="keywordflow">if</span> (BASKET_ACCOUNT_ID == id_BASKET_ACCT) <span class="comment">// if the basket contract ID passed in matches this one...</span>
        {
            BASKET_CONTRACT_ID = id_BASKET_CONTRACT;
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a21421671206f26b76c61406e95fde3af"></a><!-- doxytag: member="OTServer::NotarizeCancelCronItem" ref="a21421671206f26b76c61406e95fde3af" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAssetAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a21421671206f26b76c61406e95fde3af">OTServer::NotarizeCancelCronItem</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAssetAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l08118">8118</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atCancelCronItem&quot;, that is, &quot;a reply to the cancelCronItem request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will definitely be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID), USER_ID(theNym);

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);

    pBalanceItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
    <span class="comment">// -----------------------------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ab3ded9d37de3a75d4b39735bb9aff341">OTItem::atCancelCronItem</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// -----------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_cancel_cron_item))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction &quot;</span>
                       <span class="stringliteral">&quot;(CancelCronItem messages are disallowed in server.cfg)\n&quot;</span>,
                       __FUNCTION__, strUserID.Get());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pBalanceItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expected transaction statement in trans# %ld: \n\n%s\n\n&quot;</span>, __FUNCTION__,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// For now, there should only be one of these cancelCronItem items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != (pItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5db1c9a56286c66937eb57d460f2eb01">OTItem::cancelCronItem</a>)))
    {
        <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
        <span class="comment">// here so it can be saved into the &quot;in reference to&quot; field.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// ASSET_ACCT_ID is the ID on the &quot;from&quot; Account that was passed in.</span>
        <span class="comment">//</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ASSET_ACCT_ID(theAssetAccount);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        <span class="comment">// **********************************************************************</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == (pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7df2f7973839d7a270f6ea8de67d07b4">VerifyTransactionStatement</a>(theNym, tranIn))) <span class="comment">// isRealTransaction=true</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR verifying transaction statement in NotarizeCancelCronItem.\n&quot;</span>);
        }
        <span class="comment">// **********************************************************************</span>
        <span class="keywordflow">else</span>
        {
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

            <span class="keyword">const</span> int64_t lReferenceToNum = pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>();

            <span class="comment">// I&#39;m using the operator== because it exists. (Although now I believe != exists also)</span>
            <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
            <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
            <span class="keywordflow">if</span> (!(ASSET_ACCT_ID == pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: Asset account ID on the transaction does not match asset account &quot;</span>
                              <span class="stringliteral">&quot;ID on the transaction item.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="comment">// LET&#39;S SEE IF WE CAN REMOVE IT THEN...</span>
            {
                <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = m_Cron.<a class="code" href="class_o_t_cron.html#ab732ac1263aac936d8d948df3412119b">GetItemByValidOpeningNum</a>(lReferenceToNum);

                <span class="comment">// Check for the closing number here (that happens in OTCronItem, since it&#39;s polymorphic.)</span>

                <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

                <span class="keywordflow">if</span> ((NULL != pCronItem) &amp;&amp; (pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#ae79115b7343f9b2700aa59d2701f2334">CanRemoveItemFromCron</a>(theNym))) <span class="comment">// see if theNym has right to remove the cronItem from processing.</span>
                {
                    bSuccess = m_Cron.<a class="code" href="class_o_t_cron.html#a8db968a79df5cee7258c4c08ba07973b">RemoveCronItem</a>(pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(), theNym); <span class="comment">// &lt;=====</span>
                }

                <span class="comment">// If we were just successful in removing the offer from the market, that means a finalReceipt was</span>
                <span class="comment">// just dropped into the inboxes for the relevant asset accounts. Once I process that receipt out of my</span>
                <span class="comment">// inbox, (which will require my processing out all related marketReceipts) then the closing number</span>
                <span class="comment">// will be removed from my list of responsibility.</span>

                <span class="keywordflow">if</span> (bSuccess)
                {
                    <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                    bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The &quot;cancel cron item&quot; was successful.</span>

                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;Successfully removed Cron Item from Cron object, based on ID: %ld\n&quot;</span>,
                                   (NULL != pCronItem) ? pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>() : lReferenceToNum);

                    <span class="comment">// Any transaction numbers that need to be cleared, happens inside RemoveCronItem().</span>
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to remove Cron Item from Cron object OTServer::NotarizeCancelCronItem\n&quot;</span>);
                }
            }
        } <span class="comment">// transaction statement verified.</span>
    } <span class="comment">// if pItem = tranIn.GetItem(OTItem::cancelCronItem)</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Error, expected OTItem::cancelCronItem &quot;</span>
                     <span class="stringliteral">&quot;in OTServer::NotarizeCancelCronItem for trans# %ld:\n\n%s\n\n&quot;</span>,
                     tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION FROM STRING) &quot;</span>);
    }
    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a63d1bff954081d9f73f50c41756d4573"></a><!-- doxytag: member="OTServer::NotarizeDeposit" ref="a63d1bff954081d9f73f50c41756d4573" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a63d1bff954081d9f73f50c41756d4573">OTServer::NotarizeDeposit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>for depositing a cheque or cash. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l05747">5747</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atDeposit&quot;, that is, &quot;a reply to the deposit request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCheque    = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCash      = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),       USER_ID(theNym),    ACCOUNT_ID(theAccount),
                        SERVER_USER_ID(m_nymServer),    ASSET_TYPE_ID(theAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAccountID(ACCOUNT_ID);

    <a class="code" href="class_o_t_mint.html">OTMint</a>      * pMint                 = NULL; <span class="comment">// the Mint itself.</span>
    <a class="code" href="class_o_t_account.html">OTAccount</a>   * pMintCashReserveAcct  = NULL; <span class="comment">// the Mint&#39;s funds for cash withdrawals.</span>
    <span class="comment">// -----------------------------------------------------------------</span>
    <span class="comment">// Here we find out if we&#39;re depositing cash, or a cheque</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

    pItemCheque = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>);

    <span class="keywordflow">if</span> (NULL == pItemCheque)
    {
        pItemCash = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);
        pItem = pItemCash;
        <span class="comment">// -------</span>
        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a>;
    }
    <span class="keywordflow">else</span>
    {
        pItem = pItemCheque;
        <span class="comment">// -------</span>
        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a>;
    }
    <span class="comment">// --------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, theReplyItemType);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------</span>
    <span class="keywordflow">if</span> (NULL == pItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: Expected OTItem::deposit or OTItem::depositCheque in trans# %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// Below this point, we know that pItem is good, and that either pItemCheque OR pItemCash is good,</span>
    <span class="comment">// and that pItem points to the good one. Therefore next, let&#39;s verify permissions:</span>
    <span class="comment">// ---------------------------------------------------------------------</span>

    <span class="comment">// This permission has to do with ALL deposits (cash or cheque)</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_deposit))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: User %s cannot do this transaction (All deposits are disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// -----------------------------------------</span>
    <span class="comment">// This permission has to do with vouchers.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL != pItemCheque) &amp;&amp;
             (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_deposit_cheque)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: User %s cannot do this transaction (depositCheque is disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// This permission has to do with cash.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL != pItemCash) &amp;&amp;
             (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_deposit_cash)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: User %s cannot do this transaction (deposit cash is disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// ----------------------------------------------------------</span>
    <span class="comment">// Check for a balance agreement...</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pBalanceItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>)))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: Expected OTItem::balanceStatement, but not found in trans # %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// -------------------------------------------------------------------------------------------</span>
    <span class="comment">// DEPOSIT CHEQUE  (Deposit Cash is the bottom half of the function, deposit cheque is the top half.)</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
    {
        <span class="comment">// The response item, as well as the sender&#39;s inbox, will soon contain a copy</span>
        <span class="comment">// of the request item. So I save it into a string here so they can grab a copy of it</span>
        <span class="comment">// into their &quot;in reference to&quot; fields.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>
        <span class="comment">// -----------------------------------------------------</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

        <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) Verified in OTAccount::Load</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error loading or verifying inbox for depositor account.\n&quot;</span>);
        }

        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) Verified in OTAccount::Load</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error loading or verifying outbox for depositor account.\n&quot;</span>);
        }
        <span class="comment">// NOTE: Below this point, pInbox and pOutbox are both available, AND will be properly</span>
        <span class="comment">// cleaned up automatically upon scope exit.</span>
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
        <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ACCOUNT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
        {
            <span class="comment">// TODO: Verify that this if block is unnecessary, and if so, remove it.</span>
            <span class="comment">// (The item should already have been verified when the transaction itself was</span>
            <span class="comment">// verified, before this function was even called. I think this is just an oversight.)</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error: account ID does not match account ID on the deposit item.\n&quot;</span>);
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);
            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(SERVER_ID, ASSET_TYPE_ID); <span class="comment">// allocated on the stack :-)</span>
            <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.LoadContractFromString(strCheque);

            <span class="keywordflow">if</span> (!bLoadContractFromString)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading cheque from string:\n%s\n&quot;</span>, __FUNCTION__,
                        strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="comment">// ----------------------------------------</span>
            <span class="comment">// See if the cheque is drawn on the same server as the deposit account</span>
            <span class="comment">// (the server running this code right now.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SERVER_ID != theCheque.GetServerID())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strSenderUserID(theCheque.GetSenderUserID());
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strRecipientUserID(theCheque.GetRecipientUserID());
                <span class="comment">// --------------------------------------------</span>
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Cheque rejected (%ld): &quot;</span>
                               <span class="stringliteral">&quot;Incorrect Server ID on cheque. Sender User ID: %s\nRecipient User ID is: %s\n&quot;</span>,
                               __FUNCTION__, theCheque.GetTransactionNum(), strSenderUserID.Get(), strRecipientUserID.Get());
            }
            <span class="comment">// ----------------------------------------</span>
            <span class="comment">// See if the cheque is already expired or otherwise not within it&#39;s valid date range.</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theCheque.VerifyCurrentDate())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strSenderUserID(theCheque.GetSenderUserID());
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strRecipientUserID(theCheque.GetRecipientUserID());
                <span class="comment">// --------------------------------------------</span>
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Cheque rejected (%ld): &quot;</span>
                               <span class="stringliteral">&quot;Not within valid date range. Sender User ID: %s\nRecipient User ID: %s\n&quot;</span>,
                               __FUNCTION__, theCheque.GetTransactionNum(), strSenderUserID.Get(), strRecipientUserID.Get());
            }
            <span class="comment">// ----------------------------------------</span>
            <span class="comment">// You can&#39;t deposit a cheque into the same account that it&#39;s drawn on. (Otherwise, in loading</span>
            <span class="comment">// both accounts, I would cause one of them to  be overwritten. I&#39;m not willing to do the same</span>
            <span class="comment">// pointer magic that I&#39;m doing with Nyms... instead I just disallow this entirely.)</span>
            <span class="comment">//</span>
            <span class="comment">// UPDATE: New rule: If you deposit a cheque into the same account it&#39;s drawn on,</span>
            <span class="comment">// the effect is the cancellation of the cheque. (If we are in this block, it means</span>
            <span class="comment">// the original cheque writer is now trying to cancel the cheque before the recipient</span>
            <span class="comment">// has a chance to deposit it.)</span>
            <span class="comment">//</span>
            <span class="comment">// CANCELLATION OF CHEQUES:</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ACCOUNT_ID == theCheque.GetSenderAcctID()) <span class="comment">// Depositor ACCOUNT_ID is recipient&#39;s acct. (theNym.) But pSenderNym is normally someone else (the sender).</span>
            {
<span class="comment">//              OTLog::vError(&quot;OTServer::NotarizeDeposit: Error: Unable to deposit into the same account cheque was drawn on:\n%s\n&quot;,</span>
<span class="comment">//                            strCheque.Get());</span>

                <span class="comment">// UPDATE: This block is now for cancelling the cheque before the original</span>
                <span class="comment">// recipient manages to deposit it.</span>

                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strSenderUserID(theCheque.GetSenderUserID());
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strRecipientUserID(theCheque.GetRecipientUserID());
                <span class="comment">// --------------------------------------------</span>
                <span class="keywordflow">if</span> (theCheque.GetSenderUserID() != USER_ID)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure verifying cheque: Strange: while the depositing account has the &quot;</span>
                                   <span class="stringliteral">&quot;same ID as the cheque sender acct, somehow the user IDs do not match. (Should never happen.)\n&quot;</span>
                                   <span class="stringliteral">&quot;Cheque Sender User ID: %s\n Depositor User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strSenderUserID.Get(), strUserID.Get());
                }
                <span class="comment">// --------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.GetAmount() != 0)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure verifying cheque: While attempting to perform cancellation, &quot;</span>
                                   <span class="stringliteral">&quot;the cheque has a non-zero amount.\n&quot;</span>
                                   <span class="stringliteral">&quot;Sender User ID: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                }
                <span class="comment">// --------------------------------------------</span>
                <span class="comment">// Make sure the transaction number on the cheque is still available and valid for use by theNym.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, theCheque.<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>()))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure verifying cheque: Bad transaction number.\n&quot;</span>
                                   <span class="stringliteral">&quot;Sender User ID: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                }
                <span class="comment">// ---------------------------------------------</span>
                <span class="comment">// Let&#39;s see if the sender&#39;s signature matches the one on the cheque...</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theCheque.VerifySignature(theNym))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure verifying cheque signature for &quot;</span>
                                   <span class="stringliteral">&quot;sender ID: %s\nRecipient User ID: %s\n Cheque:\n\n%s\n\n&quot;</span>, __FUNCTION__,
                                   strSenderUserID.Get(), strRecipientUserID.Get(), strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                }
                <span class="comment">// ---------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(theCheque.GetAmount(), <span class="comment">// This amount is always zero in the case of cheque cancellation.</span>
                                                                theNym,
                                                                *pInbox,
                                                                *pOutbox,
                                                                theAccount,
                                                                tranIn)))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying balance statement while cancelling cheque %ld. Acct ID:\n%s\n&quot;</span>,
                                   __FUNCTION__, theCheque.GetTransactionNum(), strAccountID.Get());
                }
                <span class="comment">// ---------------------------------------------</span>
                <span class="keywordflow">else</span>
                {
                    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

                    <span class="keywordflow">if</span> (<span class="comment">// Clear the transaction number. Sender Nym was responsible for it (and still is, until</span>
                        <span class="comment">// he signs to accept the cheque reecipt). Still, however, he HAS used the cheque, so</span>
                        <span class="comment">// I&#39;m removing his ability to use that number twice. It will remain on his issued list</span>
                        <span class="comment">// until he signs for the receipt.</span>
                        <span class="comment">//</span>
                        (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, theCheque.<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>(), <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                        )<span class="comment">// -----------------------------------------------------------------------</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed marking the transaction number as in use. (Should never happen.)\n&quot;</span>,
                                      __FUNCTION__);
                    }
                    <span class="keywordflow">else</span>
                    {
                        <span class="comment">// Generate new transaction number (for putting the check receipt in the sender&#39;s inbox.)</span>
                        <span class="comment">// todo check this generation for failure (can it fail?)</span>
                        int64_t lNewTransactionNumber = 0;

                        <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pInbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>,
                                                                                               lNewTransactionNumber);

                        <span class="comment">// The depositCheque request OTItem is saved as a &quot;in reference to&quot; field,</span>
                        <span class="comment">// on the inbox chequeReceipt transaction.</span>
                        <span class="comment">//todo put these two together in a method.</span>
                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();

                        <span class="comment">// Now we have created a new transaction from the server to the sender&#39;s inbox</span>
                        <span class="comment">// Let&#39;s sign and save it...</span>
                        pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                        pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        <span class="comment">// Here the transaction we just created is actually added to the source acct&#39;s inbox.</span>
                        pInbox-&gt;AddTransaction(*pInboxTransaction);

                        <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                        <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                        <span class="comment">//</span>
                        pInbox-&gt;ReleaseSignatures();
                        pInbox-&gt;SignContract(m_nymServer);
                        pInbox-&gt;SaveContract();

                        theAccount.SaveInbox(*pInbox);

                        <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                        <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                        <span class="comment">//</span>
                        <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                        <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                        <span class="comment">// is removed from a box.</span>
                        <span class="comment">//</span>
                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pInbox);
                        <span class="comment">// ---------------------------------------------------------------------------------</span>
                        <span class="comment">// AT THIS POINT, the sender/depositor&#39;s inbox has had the cheque transaction added to it,</span>
                        <span class="comment">// as his receipt. (He must perform a balance agreement in order to get it out of his inbox.)</span>
                        <span class="comment">//</span>
                        <span class="comment">// THERE IS NOTHING LEFT TO DO BUT SAVE THE FILES!!</span>

                        theAccount.ReleaseSignatures();
                        theAccount.SignContract(m_nymServer);
                        theAccount.SaveContract();
                        theAccount.SaveAccount();

                        <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                        <span class="comment">// otherwise, if we never entered this block, then it would still be set to rejection, and the</span>
                        <span class="comment">// new item would never have been added to the inbox, and the inbox file would never have had</span>
                        <span class="comment">// its signatures released, or been re-signed or re-saved back to file.</span>
                        <span class="comment">// BUT... if the message comes back with acknowledgement--then all of these actions must have</span>
                        <span class="comment">// happened, and here is the server&#39;s signature to prove it.</span>
                        <span class="comment">// Otherwise you get no items and no signature. Just a rejection item in the response transaction.</span>
                        <span class="comment">//</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                        bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The cheque cancellation was successful.</span>

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: SUCCESS cancelling cheque %ld, which had been drawn from account: %s\n&quot;</span>,
                                       __FUNCTION__, theCheque.GetTransactionNum(), strAccountID.Get());

                        tranOut.<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();

                        <span class="comment">// TODO: Our code that actually saves the new balance statement receipt should go here</span>
                        <span class="comment">// (that is, only after ultimate success.) Otherwise we still want to store the old receipt.</span>
                        <span class="comment">// For now I&#39;m verifying it, but not storing it.  This means the security for it works, but</span>
                        <span class="comment">// in a dispute, I can&#39;t prove it / cover my ass.  So very soon a receipt WILL be saved here</span>
                        <span class="comment">// that is, a copy of the user&#39;s signed BalanceAgreement.</span>
                        <span class="comment">// Note: if I&#39;m saving the entire outgoing transaction reply, or message reply, (versus just</span>
                        <span class="comment">// the reply to a certain item) then I think I have the balance agreement already? Double check.</span>
                    }
                } <span class="comment">// &quot;else&quot;</span>
            } <span class="comment">// ABOVE: Cheque cancellation</span>
            <span class="comment">// ----------------------------------------</span>
            <span class="keywordflow">else</span> <span class="comment">// BELOW: Cheque deposit</span>
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SOURCE_ACCT_ID   (theCheque.GetSenderAcctID()); <span class="comment">// relevant for both vouchers AND cheques.</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_USER_ID   (theCheque.GetSenderUserID());

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; REMITTER_ACCT_ID   (theCheque.GetRemitterAcctID()); <span class="comment">// only relevant in case of vouchers.</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; REMITTER_USER_ID   (theCheque.GetRemitterUserID());

                <span class="comment">// If the cheque has a remitter ...and the depositor IS the remitter...</span>
                <span class="comment">// (Then the remitter is cancelling the voucher.)</span>
                <span class="comment">//</span>
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bHasRemitter        = theCheque.HasRemitter();
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemitterCancelling = (bHasRemitter &amp;&amp; (USER_ID == theCheque.GetRemitterUserID()));

                <span class="comment">// The point of the logic here is to enable remitters to deposit vouchers. Basically allows</span>
                <span class="comment">// them to &quot;cancel&quot; the voucher, and get their money back.</span>
                <span class="comment">//</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; RECIPIENT_USER_ID(bRemitterCancelling ? USER_ID : theCheque.GetRecipientUserID());

                <span class="comment">// (Note that we allow the remitter of a voucher to deposit that voucher.)</span>

                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strSenderUserID(SENDER_USER_ID),
                                strSourceAcctID(SOURCE_ACCT_ID),
                                strRecipientUserID(RECIPIENT_USER_ID),
                                strRemitterUserID(REMITTER_USER_ID),
                                strRemitterAcctID(REMITTER_ACCT_ID);
                <span class="comment">// ------------------------------------------------------------------------------</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theSenderInbox  (  SENDER_USER_ID,   SOURCE_ACCT_ID, SERVER_ID); <span class="comment">// chequeReceipt goes here.</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theRemitterInbox(REMITTER_USER_ID, REMITTER_ACCT_ID, SERVER_ID); <span class="comment">// voucherReceipt goes here.</span>
                <span class="comment">// ------------------------------------------------------------------------------</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pSenderInbox   = &amp;theSenderInbox;
                <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pRemitterInbox = &amp;theRemitterInbox;
                <a class="code" href="class_o_t_account.html">OTAccount</a> * pRemitterAcct  = NULL;  <span class="comment">// Only used in the case of vouchers.</span>
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theRemitterAcctGuardian; <span class="comment">// This is set below, right after OTAccount::LoadExistingAccount().</span>
                <span class="comment">// ------------------------------------------------------------------------------</span>
                <a class="code" href="class_o_t_account.html">OTAccount</a> * pSourceAcct    = NULL;  <span class="comment">// We&#39;ll load this up and change its balance, save it then delete the instance.</span>
                                                    <span class="comment">// (I&#39;ll use OTCleanup to take care of deleting the instance, so it&#39;s automatic.)</span>
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theSourceAcctGuardian; <span class="comment">// This is set below, right after OTAccount::LoadExistingAccount().</span>
                <span class="comment">// ------------------------------------------------------------------------------</span>
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     theRemitterNym(REMITTER_USER_ID);
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pRemitterNym = &amp;theRemitterNym;
                <span class="comment">// ------------------------------------------------------------------------------</span>
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     theSenderNym(SENDER_USER_ID);
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pSenderNym = &amp;theSenderNym;

                <span class="comment">// Don&#39;t want to overwrite files or db records in cases where the sender is also the depositor.</span>
                <span class="comment">// (Similar concern if the server is also the depositor, but that&#39;s already partly handled</span>
                <span class="comment">// before we get to this point... theNym is already substituted for m_nymServer,</span>
                <span class="comment">// if the IDs match, before any of the commands are processed.)</span>
                <span class="comment">//</span>
                <span class="comment">// The conundrum is in the multiplicity of combinations. The server COULD be the sender</span>
                <span class="comment">// OR the depositor, or he could be BOTH, or the server might NOT be the sender OR depositor,</span>
                <span class="comment">// yet they could still be the same person.  Normally all 3 are separate entities.  That&#39;s a</span>
                <span class="comment">// lot of combinations. I want to make sure that I don&#39;t overwrite ANY files while juggling the</span>
                <span class="comment">// respective nymfiles, transaction numbers, request numbers, etc.</span>
                <span class="comment">//</span>
                <span class="comment">// Solution:  When commands are first processed, and the Request Number is processed, theNym</span>
                <span class="comment">// is ALREADY replaced with m_nymServer IF the IDs match and the signature verifies. It is then</span>
                <span class="comment">// passed that way to all of the commands (including the one we are in now.)</span>
                <span class="comment">//</span>
                <span class="comment">// I THEN do the logic BELOW as additional to that. Make sure if you change anything that you</span>
                <span class="comment">// think int64_t and hard about what you are doing!!</span>
                <span class="comment">//</span>
                <span class="comment">// Here&#39;s the logic:</span>
                <span class="comment">// -- theNym is the depositor (for sure.)</span>
                <span class="comment">// -- m_nymServer is the server nym (for sure.)</span>
                <span class="comment">// -- By the time we get here, IF the ServerUserID and UserID match,</span>
                <span class="comment">//    then theNym IS ALREADY m_nymServer, literally a reference to it.</span>
                <span class="comment">//    (This is performed before we even get to this point, so that the</span>
                <span class="comment">//    same problem doesn&#39;t occur with request numbers.)</span>
                <span class="comment">// -- In cases where the &quot;server is also the depositor&quot;, it&#39;s therefore</span>
                <span class="comment">//    ALREADY handled, since theNym already points to m_nymServer.</span>
                <span class="comment">// -- theSenderNym is used to load the sender nym in cases where we have</span>
                <span class="comment">//    to load it from file or db ourselves. (Most normal cases.)</span>
                <span class="comment">// -- In those normal cases, pSenderNym will point to theSenderNym and</span>
                <span class="comment">//    we load it up from file or database.</span>
                <span class="comment">// -- In cases where the sender is also the user (the depositor), then</span>
                <span class="comment">//    pSenderNym will point to theNym instead of to theSenderNym, and we</span>
                <span class="comment">//    no longer bother loading it, since the user is already loaded.</span>
                <span class="comment">// -- In cases where the sender is also the server, then pSenderNym will</span>
                <span class="comment">//    point to m_nymServer instead of to theSenderNym, and we no longer</span>
                <span class="comment">//    bother loading it, since the server&#39;s nym is already loaded.</span>

                <span class="keywordtype">bool</span>    bDepositorIsServer     = (USER_ID          == SERVER_USER_ID);
                <span class="keywordtype">bool</span>    bDepositorIsSender     = (USER_ID          == SENDER_USER_ID);
                <span class="keywordtype">bool</span>    bDepositorIsRemitter   = (USER_ID          == REMITTER_USER_ID);
                <span class="keywordtype">bool</span>    bDepositAcctIsRemitter = (ACCOUNT_ID       == REMITTER_ACCT_ID);
                <span class="keywordtype">bool</span>    bSourceAcctIsRemitter  = (SOURCE_ACCT_ID   == REMITTER_ACCT_ID);
                <span class="keywordtype">bool</span>    bSenderIsServer        = (SENDER_USER_ID   == SERVER_USER_ID);
                <span class="keywordtype">bool</span>    bRemitterIsServer      = (REMITTER_USER_ID == SERVER_USER_ID);
                <span class="comment">// --------------------------------------------------------------------------------------</span>
                <span class="keywordtype">bool</span>    bSenderUserAlreadyLoaded   = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>    bSourceAcctAlreadyLoaded   = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>    bRemitterUserAlreadyLoaded = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>    bRemitterAcctAlreadyLoaded = <span class="keyword">false</span>;
                <span class="comment">// --------------------------------------------------------------------------------------</span>

                <span class="comment">// The depositor is already loaded, (for sure.)</span>

                <span class="comment">// The server is already loaded, (for sure.)</span>

                <span class="comment">// If the depositor IS the server, then it already points there (for sure.)</span>
                <span class="keywordflow">if</span> (bDepositorIsServer)
                {
                    <span class="comment">//OTPseudonym &amp; theNym = m_nymServer; // Already handled in the code that calls IncrementRequestNum().</span>

                    <span class="comment">//bSenderUserAlreadyLoaded = false; // Sender is either determined to be already loaded (directly below) or</span>
                                                        <span class="comment">// it is loaded as part of the cheque verification process below that.</span>
                                                        <span class="comment">// At this point I can&#39;t set it because I just don&#39;t know yet.</span>
                }
                <span class="comment">// --------------------------------------------------------------------------------------</span>
                <span class="comment">// If the depositor IS the sender, pSenderNym points to depositor, and we&#39;re already loaded.</span>
                <span class="keywordflow">if</span> (bDepositorIsSender)
                {
                    pSenderNym = &amp;theNym;
                    bSenderUserAlreadyLoaded = <span class="keyword">true</span>;
                }
                <span class="comment">// --------------------------------------------------------------------------------------</span>
                <span class="comment">// If the server IS the sender, pSenderNym points to the server, and we&#39;re already loaded.</span>
                <span class="keywordflow">if</span> (bSenderIsServer)
                {
                    pSenderNym = &amp;m_nymServer;
                    bSenderUserAlreadyLoaded = <span class="keyword">true</span>;
                }
                <span class="comment">// --------------------------------------------------------------------------------------</span>
                <span class="keywordtype">bool</span> bSuccessLoadSenderInbox   = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span> bSuccessLoadRemitterInbox = <span class="keyword">false</span>;

                <span class="keywordflow">if</span> (bHasRemitter)
                {
                    pSenderInbox = NULL;

                    <span class="comment">// If the depositor IS the remitter, pRemitterNym points to depositor, and we&#39;re already loaded.</span>
                    <span class="keywordflow">if</span> (bDepositorIsRemitter)
                    {
                        pRemitterNym = &amp;theNym;
                        bRemitterUserAlreadyLoaded = <span class="keyword">true</span>;
                    }
                    <span class="comment">// --------------------------------------------------------------------------------------</span>
                    <span class="comment">// If the server IS the remitter, pRemitterNym points to the server, and we&#39;re already loaded.</span>
                    <span class="keywordflow">if</span> (bRemitterIsServer)
                    {
                        pRemitterNym = &amp;m_nymServer;
                        bRemitterUserAlreadyLoaded = <span class="keyword">true</span>;
                    }
                    <span class="comment">// --------------------------------------------------------------------------------------</span>
                    <span class="comment">// If the account IS the remitter&#39;s account, pRemitterNym points to the server, and we&#39;re already loaded.</span>
                    <span class="keywordflow">if</span> (bDepositAcctIsRemitter)
                    {
                        pRemitterAcct  = &amp;theAccount;
                        pRemitterInbox = pInbox;

                        bRemitterAcctAlreadyLoaded = <span class="keyword">true</span>;
                        bSuccessLoadRemitterInbox  = <span class="keyword">true</span>;

                        <span class="comment">// Just for completeness. In this case ALL THREE accounts would be the same account,</span>
                        <span class="comment">// which is probably disallowed later on anyway.</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (bSourceAcctIsRemitter)
                        {
                            pSourceAcct  = pRemitterAcct;
                            pSenderInbox = pRemitterInbox;

                            bSourceAcctAlreadyLoaded = <span class="keyword">true</span>;
                            bSuccessLoadSenderInbox  = <span class="keyword">true</span>;
                        }
                    }
                }
                <span class="keywordflow">else</span> <span class="comment">// Definitely has no remitter. Therefore definitely NOT a voucher.</span>
                {    <span class="comment">// (If it&#39;s not a voucher, that means we should DEFINITELY be able to load the sender&#39;s inbox.)</span>
                    <span class="comment">// ----------------------------------</span>
                    <span class="comment">// Load source account&#39;s inbox</span>

                    bSuccessLoadSenderInbox = pSenderInbox-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>();

                    <span class="comment">// ...If it loads, verify it. Otherwise, generate it...</span>
                    <span class="keywordflow">if</span> (bSuccessLoadSenderInbox)
                        bSuccessLoadSenderInbox = pSenderInbox-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(m_nymServer);
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failed loading inbox for %s source account.\n&quot;</span>, __FUNCTION__,
                                       (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>);
<span class="comment">//                  else</span>
<span class="comment">//                      bSuccessLoadSenderInbox = pSenderInbox-&gt;GenerateLedger(SOURCE_ACCT_ID, SERVER_ID, OTLedger::inbox, true); // bGenerateFile=true</span>

                }
                <span class="comment">// --------------------------------------------------------------------------------------</span>
                <span class="comment">// To deposit a cheque, need to verify:  (in no special order)</span>
                <span class="comment">//</span>
                <span class="comment">// -- DONE Load the source account and verify it exists.</span>
                <span class="comment">// -- DONE Make sure the source acct is verified for the server signature.</span>
                <span class="comment">// -- DONE Make sure the Asset Type of the cheque matches the Asset Type of BOTH source and recipient accts.</span>
                <span class="comment">// -- DONE See if there is a Recipient User ID. If so, MAKE SURE it matches the user depositing the cheque!</span>
                <span class="comment">// -- DONE See if the Sender User even exists.</span>
                <span class="comment">// -- DONE See if the Sender User ID matches the hash of the actual public key in the sender&#39;s pubkey file.</span>
                <span class="comment">// -- DONE Make sure the cheque has the right server ID.</span>
                <span class="comment">// -- DONE Make sure the cheque has not yet EXPIRED.</span>
                <span class="comment">// -- DONE Make sure the cheque signature is verified with the sender&#39;s pubkey.</span>
                <span class="comment">// -- DONE Make sure the account ID on the transaction item matches the depositor account ID.</span>
                <span class="comment">// -- DONE Verify the funds are in the source acct.</span>
                <span class="comment">//</span>
                <span class="comment">// -- DONE Plus deal with sender&#39;s inbox.</span>

                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// If there&#39;s a remitter, then it&#39;s a voucher, and thus the sender MUST be the server.</span>
                <span class="comment">// (If the sender on a voucher is NOT the server, then it&#39;s very suspicious.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !bSenderIsServer)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failure: Voucher has a &#39;sender&#39; who is not the server: %s\n&quot;</span>,
                                   __FUNCTION__, strSenderUserID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
<span class="comment">//              else if (bRemitterIsServer) // Disallowed for now. UPDATE: Necesssary for paying dividends.</span>
<span class="comment">//              {</span>
<span class="comment">//                  OTLog::vOutput(0, &quot;OTServer::%s: Failure: Voucher has the server set as the &#39;remitter&#39; (disallowed.)\n&quot;,</span>
<span class="comment">//                                 __FUNCTION__);</span>
<span class="comment">//              }</span>
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// See if we can load the sender&#39;s public key (to verify cheque signature,</span>
                <span class="comment">// and to remove transaction number if it&#39;s not a voucher.)</span>
                <span class="comment">// if !bSenderUserAlreadyLoaded since the server already had its public key loaded at boot-time.</span>
                <span class="comment">// (also since the depositor and sender might be the same person.)</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bSenderUserAlreadyLoaded                &amp;&amp;
<span class="comment">//                      (false == theSenderNym.LoadCredentials()) &amp;&amp;  // New style.</span>
                        (<span class="keyword">false</span> == theSenderNym.LoadPublicKey())       <span class="comment">// Old style (The call on this line is deprecated.) NOTE: LoadPublicKey already calls LoadCredentials at its top, though eventually we&#39;ll just call it here directly, once LoadPublicKey is removed for good.</span>
                    )
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Error loading public key for %s signer during &quot;</span>
                                   <span class="stringliteral">&quot;deposit: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                }

                <span class="comment">// See if the Nym ID (User ID) that we have matches the message digest of his public key.</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSenderNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failure verifying %s: &quot;</span>
                                   <span class="stringliteral">&quot;Bad Sender User ID (fails hash check of pubkey)&quot;</span>
                                   <span class="stringliteral">&quot;: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                }

                <span class="comment">// See if we can load the sender&#39;s nym file (to verify the transaction # on the cheque)</span>
                <span class="comment">// if !bSenderUserAlreadyLoaded since the server already had its nym file loaded at boot-time.</span>
                <span class="comment">// (also since the depositor and sender might be the same person.)</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bSenderUserAlreadyLoaded &amp;&amp; (<span class="keyword">false</span> == theSenderNym.LoadSignedNymfile(m_nymServer)))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Error loading nymfile for %s signer during deposit, user ID: %s\n&quot;</span>
                                   <span class="stringliteral">&quot;Recipient User ID: %s\n&quot;</span>, __FUNCTION__, (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// See if we can load the remitter&#39;s public key (if it&#39;s a voucher.)</span>
                <span class="comment">// if !bRemitterAlreadyLoaded since the server already had its public key loaded at boot-time.</span>
                <span class="comment">// (also since the depositor or server, and remitter, might be the same person.)</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !bRemitterUserAlreadyLoaded &amp;&amp;
<span class="comment">//                  (false == theRemitterNym.LoadCredentials())      &amp;&amp;  // New style.</span>
                    (<span class="keyword">false</span> == theRemitterNym.LoadPublicKey())            <span class="comment">// Old style (The call on this line is deprecated.) NOTE: LoadPublicKey already calls LoadCredentials at its top, though eventually we&#39;ll just call it here directly, once LoadPublicKey is removed for good.</span>
                    )
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Error loading public key for remitter during &quot;</span>
                                   <span class="stringliteral">&quot;voucher deposit: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strRemitterUserID.Get(), strRecipientUserID.Get());
                }

                <span class="comment">// See if the Nym ID (User ID) that we have matches the message digest of his public key.</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !pRemitterNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failure verifying voucher: &quot;</span>
                                   <span class="stringliteral">&quot;Bad Remitter User ID (fails hash check of pubkey)&quot;</span>
                                   <span class="stringliteral">&quot;: %s\nRecipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strRemitterUserID.Get(), strRecipientUserID.Get());
                }

                <span class="comment">// See if we can load the remitter&#39;s nym file (to verify the transaction # on the cheque)</span>
                <span class="comment">// if !bRemitterUserAlreadyLoaded since the server already had its nym file loaded at boot-time.</span>
                <span class="comment">// (also since the depositor and remitter might be the same person.)</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !bRemitterUserAlreadyLoaded &amp;&amp; (<span class="keyword">false</span> == theRemitterNym.LoadSignedNymfile(m_nymServer)))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Error loading nymfile for remitter during voucher deposit: %s\n&quot;</span>
                                   <span class="stringliteral">&quot;Recipient User ID: %s\n&quot;</span>, __FUNCTION__,
                                   strRemitterUserID.Get(), strRecipientUserID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Make sure they&#39;re not double-spending this cheque.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(*(bHasRemitter ? pRemitterNym : pSenderNym),
                                                          theCheque.GetTransactionNum()))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failure verifying %s: Bad transaction number.\n&quot;</span>
                                   <span class="stringliteral">&quot;Recipient User ID: %s\n&quot;</span>, __FUNCTION__, (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strRecipientUserID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Let&#39;s see if the sender&#39;s signature matches the one on the cheque...</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theCheque.VerifySignature(*pSenderNym)) <span class="comment">// This is same for cheques and vouchers.</span>
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failure verifying %s signature for &quot;</span>
                                   <span class="stringliteral">&quot;sender ID: %s Recipient User ID: %s&quot;</span>, __FUNCTION__,
                                   (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strSenderUserID.Get(), strRecipientUserID.Get());
                    <span class="keywordflow">if</span> (bHasRemitter)
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot; Remitter User ID: %s\n&quot;</span>, strRemitterUserID.Get());
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// If there is a recipient user ID on the check, it must match the user depositing the cheque.</span>
                <span class="comment">// (But if there is NO recipient user ID, then it&#39;s a blank cheque and ANYONE can deposit it.)</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.HasRecipient() &amp;&amp; !(USER_ID == RECIPIENT_USER_ID))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure matching %s recipient to depositor. Depositor User ID: %s &quot;</span>
                                   <span class="stringliteral">&quot;Recipient User ID: %s\n&quot;</span>, __FUNCTION__, (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strUserID.Get(), strRecipientUserID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Try to load the source account (that cheque is drawn on) up into memory.</span>
                <span class="comment">// We&#39;ll need to debit funds from it...  Also, set the cleanup object onto this pointer.</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bSourceAcctAlreadyLoaded &amp;&amp;
                            ((
                             NULL == (pSourceAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(SOURCE_ACCT_ID, SERVER_ID))
                            )
                            ||
                            (
                             theSourceAcctGuardian.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pSourceAcct), <span class="keyword">false</span>  <span class="comment">// I want this to eval to false, but I want SetCleanup to call.</span>
                            ))                                                                  <span class="comment">// Also, SetCleanup() is safe even if pointer is NULL.</span>
                        )
                    <span class="comment">// ----------------------------------------------------------------------------------</span>
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: %s deposit failure, &quot;</span>
                                   <span class="stringliteral">&quot;trying to load source acct, ID: %s Recipient User ID: %s&quot;</span>,
                                   __FUNCTION__, (bHasRemitter) ? <span class="stringliteral">&quot;Cheque&quot;</span> : <span class="stringliteral">&quot;Voucher&quot;</span>, strSourceAcctID.Get(), strRecipientUserID.Get());
                    <span class="keywordflow">if</span> (bHasRemitter)
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot; Remitter User ID: %s\n&quot;</span>, strRemitterUserID.Get());
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// If the cheque is a voucher (drawn on an internal server account) then there is no need to</span>
                <span class="comment">// load any &quot;sender inbox&quot; (which will not exist anyway.) Whereas if the source account is NOT</span>
                <span class="comment">// an internal server account (but rather, is a NORMAL account) then it had better have</span>
                <span class="comment">// successfully loaded that inbox, or we have a problem.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bSuccessLoadSenderInbox &amp;&amp; !pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a9a3c4e0a90a5f0f837c7f4acda8d4a10">IsInternalServerAcct</a>())
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR verifying inbox ledger for source acct ID: %s\n&quot;</span>,
                                  __FUNCTION__, strSourceAcctID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Does the source account verify?</span>
                <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
                <span class="comment">// (Otherwise I might normally call VerifyAccount(), which does both...)</span>
                <span class="comment">//</span>
                <span class="comment">// Someone can&#39;t just alter an account file, because then the server&#39;s signature</span>
                <span class="comment">// won&#39;t verify anymore on that file and transactions will fail such as right here:</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pSourceAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying signature on source account while depositing %s. Acct ID: %s\n&quot;</span>,
                                   __FUNCTION__, (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>, strAccountID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Need to make sure the signer is the owner of the source account...</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pSenderNym))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: ERROR verifying signer&#39;s ownership of source account while &quot;</span>
                                   <span class="stringliteral">&quot;depositing %s. Source Acct ID: %s\n&quot;</span>, __FUNCTION__,
                                   (bHasRemitter) ? <span class="stringliteral">&quot;cheque&quot;</span> : <span class="stringliteral">&quot;voucher&quot;</span>,
                                   strAccountID.Get());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span>
                {
                    bSourceAcctAlreadyLoaded = <span class="keyword">true</span>;
                    <span class="comment">// -------------------------------------</span>
                    <span class="keywordflow">if</span> (bSourceAcctIsRemitter)
                    {
                        pRemitterAcct              = pSourceAcct;
                        bRemitterAcctAlreadyLoaded = <span class="keyword">true</span>;

                        pRemitterInbox             = pSenderInbox;

                        <span class="keywordflow">if</span> (NULL != pRemitterInbox) <span class="comment">// This part is here for completeness only. It will never actually happen,</span>
                            bSuccessLoadRemitterInbox = <span class="keyword">true</span>; <span class="comment">// since a voucher source account is owned by server and has no inbox.</span>
                    }
                    <span class="comment">// *********************************************************************</span>

                    <span class="comment">// Try to load the remitter account (that voucher was originally financed from) up into memory.</span>
                    <span class="comment">// We&#39;ll need to verify it so we can drop the receipt into its inbox. Also, set the cleanup object onto this pointer.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !bRemitterAcctAlreadyLoaded &amp;&amp;
                        (
                         (
                         NULL == (pRemitterAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(REMITTER_ACCT_ID, SERVER_ID))
                         )
                        ||
                         (
                         theRemitterAcctGuardian.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pRemitterAcct), <span class="keyword">false</span> <span class="comment">// I want this to eval to false, but I want SetCleanup to call.</span>
                         )                                                                     <span class="comment">// Also, SetCleanup() is safe even if pointer is NULL.</span>
                        )
                    )
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Voucher deposit, failure &quot;</span>
                                       <span class="stringliteral">&quot;trying to load remitter acct, ID: %s Recipient User ID: %s Remitter User ID: %s\n&quot;</span>,
                                       __FUNCTION__, strRemitterAcctID.Get(), strRecipientUserID.Get(), strRemitterUserID.Get());
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <span class="comment">// Does the remitter account verify?</span>
                    <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
                    <span class="comment">// (Otherwise I might normally call VerifyAccount(), which does both...)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !pRemitterAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying signature on remitter account while depositing voucher. &quot;</span>
                                       <span class="stringliteral">&quot;Remitter Acct ID: %s\n&quot;</span>, __FUNCTION__, strRemitterAcctID.Get());
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <span class="comment">// Need to make sure the remitter is the owner of the remitter account...</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHasRemitter &amp;&amp; !pRemitterAcct-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pRemitterNym))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: ERROR verifying remitter&#39;s ownership of remitter account while &quot;</span>
                                       <span class="stringliteral">&quot;depositing voucher. Remitter Acct ID: %s\n&quot;</span>, __FUNCTION__, strRemitterAcctID.Get());
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bHasRemitter                 &amp;&amp; <span class="comment">// If it&#39;s a voucher, and the source account isn&#39;t the remitter account...</span>
                             !bSourceAcctIsRemitter        &amp;&amp; <span class="comment">// (if it was, there&#39;d definitely be no remitter inbox, since it&#39;d be a server acct.)</span>
                             !bSuccessLoadRemitterInbox    &amp;&amp; <span class="comment">// ...and if we haven&#39;t successfully loaded the remitter&#39;s inbox yet...</span>
                             (!pRemitterInbox-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>() || !pRemitterInbox-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(m_nymServer))) <span class="comment">// Then load and verify it.</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading or verifying inbox ledger for remitter acct ID: %s\n&quot;</span>,
                                      __FUNCTION__, strRemitterAcctID.Get());
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <span class="comment">// Are all of the accounts, AND the cheque, all of the same Asset Type?</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!( theCheque.GetAssetID() == pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() ) ||
                             !( theCheque.GetAssetID() == theAccount.GetAssetTypeID()   ) ||
                              ( bHasRemitter &amp;&amp;
                             !( theCheque.GetAssetID() == pRemitterAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() ))
                            )
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a>    strSourceAssetID(pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()),
                                    strRecipientAssetID(theAccount.GetAssetTypeID());
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: ERROR - user attempted to deposit cheque between accounts of different &quot;</span>
                                <span class="stringliteral">&quot;asset types. Source Acct: %s\nType: %s\nRecipient Acct: %s\nType: %s\n&quot;</span>, __FUNCTION__,
                                strSourceAcctID.Get(), strSourceAssetID.Get(),
                                strAccountID.Get(), strRecipientAssetID.Get());

                        <span class="keywordflow">if</span> (bHasRemitter)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strRemitterAssetID(pRemitterAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Remitter Acct: %s\nType: %s\n&quot;</span>, strRemitterAcctID.Get(),
                                           strRemitterAssetID.Get());
                        }
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>

                    <span class="comment">// The BALANCE AGREEMENT includes a signed and dated:</span>
                    <span class="comment">/*</span>
<span class="comment">                     user ID, server ID, account ID, transaction ID.</span>
<span class="comment"></span>
<span class="comment">                     BY THE TIME you are ever inside the procesing for ANY transaction. we know for</span>
<span class="comment">                     a fact that NotarizeTransaction has ALREADY checked all the items on the transaction</span>
<span class="comment">                     (the ones in its list) to make sure they ALL have the same owner, and signature,</span>
<span class="comment">                     and transaction number, and account ID, and server ID. This happens when the items</span>
<span class="comment">                     first load via VerifyContractID(), and then in NotarizeTransaction() with a call to</span>
<span class="comment">                     VerifyItems(). Therefore I can consider the above variables COVERED for pItem as</span>
<span class="comment">                     well as pBalanceItem.</span>
<span class="comment"></span>
<span class="comment">                     Balance Agreement also includes:</span>
<span class="comment">                     -- A copy of all the transaction numbers that should still be issued to the Nym,</span>
<span class="comment">                        AFTER one is removed from depositing this cheque. (The same number on tranIn and pItem.)</span>
<span class="comment">                        NEED TO VERIFY BOTH LISTS ARE THE SAME AFTER REMOVING ONE ON MY SIDE.</span>
<span class="comment">                     -- Account balance.</span>
<span class="comment">                        (NEED TO VERIFY BALANCE WOULD BE THE SAME AFTER PROCESSING TRANSACTION.</span>
<span class="comment">                     -- Inbox and Outbox reports on a single list of sub-items.</span>
<span class="comment">                        (NEED TO VERIFY INBOX AND OUTBOX ITEMS MATCH BY RE-CREATING AND THEN COMPARING.)</span>
<span class="comment"></span>
<span class="comment">                     All these are now done in VerifyBalanceStatement().</span>
<span class="comment"></span>
<span class="comment">                     */</span>

                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(theCheque.GetAmount(),
                                                                    theNym,
                                                                    *pInbox,
                                                                    *pOutbox,
                                                                    theAccount,
                                                                    tranIn)))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: ERROR verifying balance statement while depositing cheque. Acct ID:\n%s\n&quot;</span>,
                                       __FUNCTION__, strAccountID.Get());
                    }

                    <span class="comment">// Debit Source account, Credit Recipient Account, add to Sender&#39;s inbox.</span>
                    <span class="comment">//</span>
                    <span class="comment">// Also clear the transaction number so this cheque can&#39;t be deposited again.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span>
                    {
                        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

                        <span class="comment">// Deduct the amount from the source account, and add it to the recipient account...</span>
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(theCheque.GetAmount()))
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed debiting source account.\n&quot;</span>, __FUNCTION__);
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.Credit(theCheque.GetAmount()))
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed crediting destination account.\n&quot;</span>, __FUNCTION__);

                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(theCheque.GetAmount()))
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed crediting back source account.\n&quot;</span>, __FUNCTION__);
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="comment">// Clear the transaction number. Sender Nym was responsible for it (and still is, until</span>
                                 <span class="comment">// he signs to accept the cheque reecipt). Alternately, remitter Nym is responsible for</span>
                                 <span class="comment">// it, until he signs to accept the voucher receipt. At this point, the cheque is USED,</span>
                                 <span class="comment">// so I&#39;m removing his ability to use that number twice. It will remain on his issued</span>
                                 <span class="comment">// list until he signs for the receipt.</span>
                                 <span class="comment">//</span>
                                 <span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(*(bHasRemitter ? pRemitterNym : pSenderNym),
                                                                  theCheque.GetTransactionNum(), <span class="keyword">true</span>) <span class="comment">//bSave=true</span>
                                )<span class="comment">// -----------------------------------------------------------------------</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Strange: Failed removing transaction number from sender or remitter, even though &quot;</span>
                                          <span class="stringliteral">&quot;it verified just earlier...\n&quot;</span>, __FUNCTION__);
                            <span class="comment">// -----------------------------------------------------------</span>
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSourceAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(theCheque.GetAmount()))
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed crediting-back source account.\n&quot;</span>, __FUNCTION__);

                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.Debit(theCheque.GetAmount()))
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed debiting-back destination account.\n&quot;</span>, __FUNCTION__);
                            <span class="comment">// -----------------------------------------------------------</span>
                        }
                        <span class="keywordflow">else</span>
                        {   <span class="comment">// need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                            <span class="comment">// update: actually does pretty good roll-back as it is. The debits and credits</span>
                            <span class="comment">// don&#39;t save unless everything is a success.</span>

                            <a class="code" href="class_o_t_account.html">OTAccount</a> * pAcctWhereReceiptGoes  = NULL;
                            <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pInboxWhereReceiptGoes = NULL;
                            <span class="comment">// -----------------------------------------------------------------------------------</span>
                            <span class="keywordflow">if</span> (bHasRemitter) <span class="comment">// voucher</span>
                            {
                                pAcctWhereReceiptGoes  = pRemitterAcct;
                                pInboxWhereReceiptGoes = pRemitterInbox;
                            }
                            <span class="keywordflow">else</span> <span class="comment">// normal cheque</span>
                            {
                                pAcctWhereReceiptGoes  = pSourceAcct;
                                pInboxWhereReceiptGoes = pSenderInbox;
                            }
                            <span class="comment">// -----------------------------------------------------------------------------------</span>
                            <span class="comment">// Add the chequeReceipt to the inbox of the signer on the cheque.</span>
                            <span class="comment">// (Or add the voucherReceipt to the inbox of the remitter of the voucher.)</span>
                            <span class="comment">//</span>
                            <span class="comment">// The original sender (or remitter, whichever is applicable) can close out the</span>
                            <span class="comment">// transaction number associated with the cheque by signing-off on that chequeReceipt or</span>
                            <span class="comment">// voucherReceipt.</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_account.html#a9a3c4e0a90a5f0f837c7f4acda8d4a10">IsInternalServerAcct</a>()) <span class="comment">// Must be a voucher remitted by the server. (Unusual, but possible... Typically a voucher is remitted by a normal user, but this can happen in the case of dividends.)</span>
                            {
                                <span class="keywordflow">if</span> (!bHasRemitter || !bRemitterIsServer)
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Apparently this is a voucher remitted directly by the server (such as a dividend payment) &quot;</span>
                                                  <span class="stringliteral">&quot;but one of these values is false: bHasRemitter (), bRemitterIsServer()\n&quot;</span>, __FUNCTION__,
                                                  bHasRemitter ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>, bRemitterIsServer ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
                                <span class="comment">// -----------------------------------------------</span>
                                <span class="keywordflow">else</span>
                                {
                                    <span class="comment">// If bHasRemitter is true, which it is, then we KNOW the server is the sender, since</span>
                                    <span class="comment">// we explicitly verified that already above. But the receipt doesn&#39;t go to the sender&#39;s inbox,</span>
                                    <span class="comment">// but rather, to the remitter&#39;s inbox. However, in this block, clearly IsInternalServerAcct is true,</span>
                                    <span class="comment">// where the receipt is supposed to go, which means the server is also the remitter! And we verified</span>
                                    <span class="comment">// that also in the above &#39;if&#39; statement, so we explicitly know that bRemitterIsServer. And in that</span>
                                    <span class="comment">// case, we can&#39;t just drop a receipt into his inbox, since the server has no inbox, and that means</span>
                                    <span class="comment">// he will never be able to close out the transaction number by accepting the receipt, like a normal</span>
                                    <span class="comment">// user would be able to do.</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// Therefore, we explicitly remove the issued number here from the remitter (whom we know to actually</span>
                                    <span class="comment">// be the server.) He has no inbox, and he won&#39;t get any receipt -- but the number will be closed out</span>
                                    <span class="comment">// properly. Before this fix, the server was probably keeping every voucher number open for eternity.</span>
                                    <span class="comment">//</span>
                                    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>(*pRemitterNym, theCheque.<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>(), <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Strange: Failed removing issued number from remitter (the server nym, in this case), &quot;</span>
                                                      <span class="stringliteral">&quot;even though the number verified just earlier...\n&quot;</span>, __FUNCTION__);
                                }
                            }
                            <span class="keywordflow">else</span> <span class="comment">// For normal cheques, and for normal vouchers (where the remitter is a normal user.)</span>
                            {
                                <span class="comment">// Generate new transaction number (for putting the check receipt in the sender&#39;s inbox.)</span>
                                <span class="comment">// todo check this generation for failure (can it fail?)</span>
                                int64_t lNewTransactionNumber = 0;

                                <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pInboxWhereReceiptGoes,
                                                                                                       theCheque.HasRemitter() ?
                                                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a> :
                                                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>,
                                                                                                       lNewTransactionNumber);

                                <span class="comment">// The depositCheque request OTItem is saved as a &quot;in reference to&quot; field,</span>
                                <span class="comment">// on the inbox chequeReceipt or voucherReceipt transaction.</span>
                                <span class="comment">//todo put these two together in a method.</span>
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(theCheque.GetTransactionNum());

                                <span class="keywordflow">if</span> (bRemitterCancelling)
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();

                                <span class="comment">// Now we have created a new transaction from the server to the sender&#39;s inbox (or remitter&#39;s inbox.)</span>
                                <span class="comment">// Let&#39;s sign and save it...</span>
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                <span class="comment">// Here the transaction we just created is actually added to the source acct&#39;s or remitter&#39;s inbox.</span>
                                pInboxWhereReceiptGoes-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pInboxTransaction);

                                <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                                <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                                <span class="comment">//</span>
                                pInboxWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                pInboxWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                pInboxWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_account.html#a81e503e95310da5ac9c2003cb00d6d2e">SaveInbox</a>(*pInboxWhereReceiptGoes);

                                <span class="comment">// if there&#39;s NOT a remitter, then the source account is ALREADY saved below this block.</span>
                                <span class="comment">// (Otherwise we need to save his acct here.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> ( bHasRemitter &amp;&amp;
                                    !bRemitterIsServer) <span class="comment">// If remitter is also server, then no need to save here, since source acct is ALREADY saved below.</span>
                                {
                                    <span class="comment">// If there IS a remitter who is NOT the server, then we save his</span>
                                    <span class="comment">// account here, so it will contain the updated inbox hash (since</span>
                                    <span class="comment">// we just added a receipt to its inbox.)</span>
                                    <span class="comment">//</span>
                                    pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                    pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                    pAcctWhereReceiptGoes-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
                                }

                                <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                                <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                                <span class="comment">//</span>
                                <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                                <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                                <span class="comment">// is removed from a box.</span>
                                <span class="comment">//</span>
                                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pInboxWhereReceiptGoes);
                            }
                            <span class="comment">// ---------------------------------------------------------------------------------</span>
                            <span class="comment">// AT THIS POINT, the source account is debited, the recipient account is credited,</span>
                            <span class="comment">// and the sender&#39;s (or remitter&#39;s) inbox has had the chequeReceipt or voucherReceipt added to it.</span>
                            <span class="comment">// (He must perform a balance agreement in order to get it out of his inbox.)</span>
                            <span class="comment">//</span>
                            <span class="comment">// THERE IS NOTHING LEFT TO DO BUT SAVE THE FILES!!</span>

                            pSourceAcct-&gt;   ReleaseSignatures();
                            theAccount.     ReleaseSignatures();

                            pSourceAcct-&gt;   SignContract(m_nymServer);
                            theAccount.     SignContract(m_nymServer);

                            pSourceAcct-&gt;   SaveContract();
                            theAccount.     SaveContract();

                            pSourceAcct-&gt;   SaveAccount();
                            theAccount.     SaveAccount();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            <span class="comment">// otherwise, if we never entered this block, then it would still be set to rejection, and the</span>
                            <span class="comment">// new item would never have been added to the inbox, and the inbox file, along with the</span>
                            <span class="comment">// account files, would never have had their signatures released, or been re-signed or</span>
                            <span class="comment">// re-saved back to file.  The debit failed, so all of those other actions would fail also.</span>
                            <span class="comment">// BUT... if the message comes back with acknowledgement--then all of these actions must have</span>
                            <span class="comment">// happened, and here is the server&#39;s signature to prove it.</span>
                            <span class="comment">// Otherwise you get no items and no signature. Just a rejection item in the response transaction.</span>
                            <span class="comment">//</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                            bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The cheque deposit was successful.</span>

                            <span class="keywordflow">if</span> (bRemitterCancelling)
                            {
                                tranOut.<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTServer::%s: SUCCESS crediting remitter account from voucher cancellation.\n&quot;</span>,
                                               __FUNCTION__);
                            }
                            <span class="keywordflow">else</span>
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTServer::%s: SUCCESS crediting account from cheque deposit.\n&quot;</span>, __FUNCTION__);

                            <span class="comment">// TODO: Our code that actually saves the new balance statement receipt should go here</span>
                            <span class="comment">// (that is, only after ultimate success.) Otherwise we still want to store the old receipt.</span>
                            <span class="comment">// For now I&#39;m verifying it, but not storing it.  This means the security for it works, but</span>
                            <span class="comment">// in a dispute, I can&#39;t prove it / cover my ass.  So very soon a receipt WILL be saved here</span>
                            <span class="comment">// that is, a copy of the user&#39;s signed BalanceAgreement.</span>
                            <span class="comment">// Note: if I&#39;m saving the entire outgoing transaction reply, or message reply, (versus just</span>
                            <span class="comment">// the reply to a certain item) then I think I have the balance agreement already? Double check.</span>

                        }

                        <span class="comment">// Make sure we clean this up.</span>
<span class="comment">//                      delete pSourceAcct; // No longer necessary -- handled by OTCleanup in this case.</span>
<span class="comment">//                      pSourceAcct = NULL; // OTCleanup handles this now.</span>
                    } <span class="comment">// &quot;else&quot;</span>
                } <span class="comment">// &quot;else&quot;</span>
            } <span class="comment">// successfully loaded cheque from string</span>
        } <span class="comment">// account ID DOES match item&#39;s account ID</span>

<span class="comment">//      OTString strTestInRefTo;</span>
<span class="comment">//      pResponseItem-&gt;GetReferenceString(strTestInRefTo);</span>
<span class="comment">//      OTLog::vOutput(0, &quot;DEBUG: Item in reference to: %s\n&quot;, strTestInRefTo.Get());</span>

    } <span class="comment">// deposit cheque</span>

    <span class="comment">// ---------------------------------------------------------------------------------</span>

    <span class="comment">// BELOW -- DEPOSIT CASH</span>

    <span class="comment">// For now, there should only be one of these deposit items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="comment">//</span>
    <span class="comment">// Deposit (the transaction) now supports deposit (the item) and depositCheque (the item)</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>)
    {
        <span class="comment">// The response item, as well as the inbox and outbox items, will contain a copy</span>
        <span class="comment">// of the request item. So I save it into a string here so they can all grab a copy of it</span>
        <span class="comment">// into their &quot;in reference to&quot; fields.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
        <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
        <span class="keywordflow">if</span> (ACCOUNT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error: &#39;From&#39; account ID on the transaction does not match &#39;from&#39; account ID on the deposit item.\n&quot;</span>);
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// --------------------------------------------------------------------</span>
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(m_nymServer);
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(m_nymServer);

            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

            <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error loading or verifying inbox.\n&quot;</span>);
                <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; <span class="comment">// pInbox may get dereferenced</span>
            }

            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error loading or verifying outbox.\n&quot;</span>);
                <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; <span class="comment">// pOutbox may get dereferenced</span>
            }
            <span class="comment">// --------------------------------------------------------------------</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPurse);

            <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, ASSET_TYPE_ID);
            <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = NULL;

            <span class="keywordtype">bool</span> bLoadContractFromString = thePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPurse);

            <span class="keywordflow">if</span> (!bLoadContractFromString)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR loading purse from string:\n%s\n&quot;</span>,
                        strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }

            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(thePurse.GetTotalValue(),
                                                            theNym,
                                                            *pInbox,
                                                            *pOutbox,
                                                            theAccount,
                                                            tranIn)))
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying balance statement while depositing cash. Acct ID:\n%s\n&quot;</span>,
                               strAccountID.Get());
            }

            <span class="comment">// TODO: double-check all verification stuff all around on the purse and token, transaction, mint, etc.</span>

            <span class="keywordflow">else</span> <span class="comment">// the purse loaded successfully from the string</span>
            {
                pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

                <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

                <span class="comment">// Pull the token(s) out of the purse that was received from the client.</span>
                <span class="keywordflow">while</span> ((pToken = thePurse.Pop(m_nymServer)) != NULL)
                {
                    <span class="comment">// This way I don&#39;t have to worry about cleaning up pToken or leaking memory.</span>
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenGuardian(*pToken);

                    pMint = <a class="code" href="class_o_t_server.html#a65dd3c93d81f20a72b8d7d9e7cfe2eda" title="Lookup the current mint for any given asset type ID and series.">GetMint</a>(ASSET_TYPE_ID, pToken-&gt;<a class="code" href="class_o_t_token.html#ad68798a37c37605745ae99475a942126">GetSeries</a>());

                    <span class="keywordflow">if</span> (NULL == pMint)
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Unable to get or load Mint.\n&quot;</span>);
                        <span class="keywordflow">break</span>;
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pMintCashReserveAcct = pMint-&gt;<a class="code" href="class_o_t_mint.html#a98138568de72510cb6baf3f0faf45915">GetCashReserveAccount</a>()) != NULL)
                    {
<span class="comment">//                      OTString DEBUG_STR(*pToken);</span>
<span class="comment">//                      OTLog::vError(&quot;\n**************\nEXTRACTED TOKEN FROM PURSE:\n%s\n&quot;, DEBUG_STR.Get());</span>

                        <a class="code" href="class_o_t_string.html">OTString</a>    strSpendableToken;
                        <span class="keywordtype">bool</span> bToken = pToken-&gt;<a class="code" href="class_o_t_token.html#ac8ba8227c8762aeb4cccc3a9af39abbc">GetSpendableString</a>(m_nymServer, strSpendableToken);
<span class="comment">//                      OTLog::vError(&quot;\n**************\nSPENDABLE STRING:\n%s\n&quot;, strSpendableToken.Get());</span>

                        <span class="keywordflow">if</span> (!bToken)  <span class="comment">// if failure getting the spendable token data from the token object</span>
                        {
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying token: Failure retrieving token data. \n&quot;</span>);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pToken-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>() == ASSET_TYPE_ID)) <span class="comment">// or if failure verifying asset type</span>
                        {
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying token: Wrong asset type. \n&quot;</span>);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pToken-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() == SERVER_ID)) <span class="comment">// or if failure verifying server ID</span>
                        {
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying token: Wrong server ID. \n&quot;</span>);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="comment">// This call to VerifyToken verifies the token&#39;s Series and From/To dates against the</span>
                        <span class="comment">// mint&#39;s, and also verifies that the CURRENT date is inside that valid date range.</span>
                        <span class="comment">//</span>
                        <span class="comment">// It also verifies the Lucre coin data itself against the key for that series and</span>
                        <span class="comment">// denomination. (The signed and unblinded Lucre coin is finally verified in Lucre</span>
                        <span class="comment">// using the appropriate Mint private key.)</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pMint-&gt;<a class="code" href="class_o_t_mint.html#aaa92a68483a8454aa726c64eefe4ab4b">VerifyToken</a>(m_nymServer, strSpendableToken, pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>())))
                        {
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying token: Token verification failed. \n&quot;</span>);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="comment">// Lookup the token in the SPENT TOKEN DATABASE, and make sure</span>
                        <span class="comment">// that it hasn&#39;t already been spent...</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pToken-&gt;<a class="code" href="class_o_t_token.html#a63c87c3fe61440f554e37f3ad98b241b">IsTokenAlreadySpent</a>(strSpendableToken))
                        {
                            <span class="comment">// TODO!!!! Need to store the spent token database in multiple places, on multiple media!</span>
                            <span class="comment">//          Furthermore need to CHECK those multiple places inside IsTokenAlreadySpent.</span>
                            <span class="comment">//          In fact, that should all be configurable in the server config file!</span>
                            <span class="comment">//          Related: make sure IsTokenAlreadySpent differentiates between ACTUALLY not finding</span>
                            <span class="comment">//          a token as spent (successfully), versus some error state with the storage.</span>
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: ERROR verifying token: Token was already spent. \n&quot;</span>);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: SUCCESS verifying token...    \n&quot;</span>);

                            <span class="comment">// need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                            <span class="comment">// so unless bSuccess is true, I don&#39;t save the account below.</span>
                            <span class="comment">//</span>

                            <span class="comment">// two defense mechanisms here:  mint cash reserve acct, and spent token database</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error debiting the mint cash reserve account. &quot;</span>
                                             <span class="stringliteral">&quot;SHOULD NEVER HAPPEN...\n&quot;</span>);
                                bSuccess = <span class="keyword">false</span>;
                                <span class="keywordflow">break</span>;
                            }
                            <span class="comment">// CREDIT the amount to the account...</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.Credit(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Error crediting the user&#39;s asset account...\n&quot;</span>);

                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Failure crediting-back mint&#39;s cash reserve account &quot;</span>
                                                 <span class="stringliteral">&quot;while depositing cash.\n&quot;</span>);
                                bSuccess = <span class="keyword">false</span>;
                                <span class="keywordflow">break</span>;
                            }
                            <span class="comment">// Spent token database. This is where the call is made to add</span>
                            <span class="comment">// the token to the spent token database.</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#a30331c0d3eb5a5a78e989dca54440b7d">RecordTokenAsSpent</a>(strSpendableToken))
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Failed recording token as spent...\n&quot;</span>);

                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Failure crediting-back mint&#39;s cash reserve account while depositing cash.\n&quot;</span>);

                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.Debit(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Failure debiting-back user&#39;s asset account while depositing cash.\n&quot;</span>);

                                bSuccess = <span class="keyword">false</span>;
                                <span class="keywordflow">break</span>;
                            }
                            <span class="keywordflow">else</span> <span class="comment">// SUCCESS!!! (this iteration)</span>
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: SUCCESS crediting account with cash token...\n&quot;</span>);
                                bSuccess = <span class="keyword">true</span>;

                                <span class="comment">// No break here -- we allow the loop to carry on through.</span>
                            }
                        }
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeDeposit: Unable to get cash reserve account for Mint.\n&quot;</span>);
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>;
                    }

<span class="comment">//                  delete pToken; // Unnecessary now, handled by OTCleanup.</span>
<span class="comment">//                  pToken = NULL;</span>

                } <span class="comment">// while success popping token from purse ------------------------------------</span>

                <span class="keywordflow">if</span> (bSuccess)
                {
                    <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                    <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                    theAccount. ReleaseSignatures();

                    <span class="comment">// Sign</span>
                    theAccount. SignContract(m_nymServer);

                    <span class="comment">// Save</span>
                    theAccount. SaveContract();

                    <span class="comment">// Save to file</span>
                    theAccount. SaveAccount();

                    <span class="comment">// We also need to save the Mint&#39;s cash reserve.</span>
                    <span class="comment">// (Any cash issued by the Mint is automatically backed by this reserve</span>
                    <span class="comment">// account. If cash is deposited, it comes back out of this account. If the</span>
                    <span class="comment">// cash expires, then after the expiry period, if it remains in the account,</span>
                    <span class="comment">// it is now the property of the transaction server.)</span>
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                    bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The cash deposit was successful.</span>

                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;OTServer::NotarizeDeposit: .....SUCCESS -- crediting account from cash deposit.\n&quot;</span>);

                    <span class="comment">// TODO:  Right here, again, I need to save the receipt from the new balance agreement, since we have</span>
                    <span class="comment">// &quot;ultimate success&quot;.  Also need to save the Nym, since he had a transaction number removed in</span>
                    <span class="comment">// the above call to VerifyBalanceAgreement. If we failed here, then we wouldn&#39;t WANT to save, since</span>
                    <span class="comment">// that number should stay on him! Same reason we don&#39;t save the accounts if anything goes wrong.</span>
                }
            } <span class="comment">// the purse loaded successfully from the string</span>
        } <span class="comment">// the account ID matches correctly to the acct ID on the item.</span>

<span class="comment">//      OTString strTestInRefTo;</span>
<span class="comment">//      pResponseItem-&gt;GetReferenceString(strTestInRefTo);</span>
<span class="comment">//      OTLog::vError(&quot;DEBUG: Item in reference to: %s\n&quot;, strTestInRefTo.Get());</span>

    } <span class="comment">// if pItem = tranIn.GetItem(OTItem::deposit)</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expected OTItem::deposit or OTItem::depositCheque on trans# %ld: \n\n%s\n\n&quot;</span>,
                       __FUNCTION__, tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
                       strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR CREATING STRING FROM TRANSACTION.) &quot;</span>);
    }

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a061c83978f4cb2fdf6f13e3600790b0a"></a><!-- doxytag: member="OTServer::NotarizeExchangeBasket" ref="a061c83978f4cb2fdf6f13e3600790b0a" args="(OTPseudonym &amp;theNym, OTAccount &amp;theSourceAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a061c83978f4cb2fdf6f13e3600790b0a">OTServer::NotarizeExchangeBasket</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>void OTServer::NotarizeExchangeBasket(OTPseudonym &amp; theNym, OTAccount &amp; theAccount, OTTransaction &amp; tranIn, OTTransaction &amp; tranOut)</p>
<p>a user is exchanging in or out of a basket. (Ex. He's trading 2 gold and 3 silver for 10 baskets, or vice-versa.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l08265">8265</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atExchangeBasket&quot;, that is, &quot;a reply to the exchange basket request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1332f32813f158436fd58abdddec855c">OTItem::exchangeBasket</a>);
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>);
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID(theNym),
                        SERVER_ID(m_strServerID),
                        BASKET_CONTRACT_ID(theAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()),
                        ACCOUNT_ID(theAccount);

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
    <span class="comment">// -------------------------------------------------------------</span>

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
    <span class="comment">// ----------------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0b62f8efea6ed9bdefbc48ce2e97a8b6">OTItem::atExchangeBasket</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------</span>
    <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_exchange_basket))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: User %s cannot do this transaction (All basket exchanges are disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pItem)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: No exchangeBasket item found on this transaction.\n&quot;</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pBalanceItem)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: No Balance Agreement item found on this transaction.\n&quot;</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pInbox)) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying inbox.\n&quot;</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pOutbox)) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying outbox.\n&quot;</span>);
    }
    <span class="keywordflow">else</span>
    {
<span class="comment">//      theInboxAngel.SetCleanupTarget(*pInbox);</span>
<span class="comment">//      theOutboxAngel.SetCleanupTarget(*pOutbox);</span>
        <span class="comment">// ------------------------------------------</span>

        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// ----------------------------------------------</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to tranIn&#39;s balance agreement</span>

        <span class="comment">// ***************************************************************************</span>
<span class="comment">//      OTLog::Error(&quot;BELOW THE LOOP===&gt; ABout to call VERIFY BALANCE STATEMENT \n&quot;);</span>

        <span class="comment">// Now after all that setup, we do the balance agreement!</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(0,<span class="comment">// the one balance agreement that doesn&#39;t change any balances.</span>
                                                               theNym,  <span class="comment">// Could have been a transaction agreement.</span>
                                                               *pInbox, <span class="comment">// Still could be, in fact....</span>
                                                               *pOutbox,
                                                               theAccount,
                                                               tranIn))
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: ERROR verifying balance statement.\n&quot;</span>);

        }
        <span class="comment">// **********************************************************************</span>

        <span class="keywordflow">else</span> <span class="comment">// BALANCE AGREEMENT WAS SUCCESSFUL.......</span>
        {
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the balance agreement was successful.</span>

            <span class="comment">// --------------------------------------------------------------------</span>

            <span class="comment">// Set up some account pointer lists for later...</span>
            <a class="code" href="_o_t_account_8hpp.html#a87c015e46e1f46faa02334d663c2627b">listOfAccounts</a>          listUserAccounts, listServerAccounts;
            std::list&lt;OTLedger*&gt;    listInboxes;

            <span class="comment">// Here&#39;s the request from the user.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strBasket;
            <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket, theRequestBasket;

            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strBasket);
            <span class="comment">// -------------------------------------</span>

            int64_t lTransferAmount = 0;

            <span class="comment">// Now we have the Contract ID from the basket account,</span>
            <span class="comment">// we can get a pointer to its asset contract...</span>

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> BASKET_ACCOUNT_ID;

            <a class="code" href="class_o_t_account.html">OTAccount</a> * pBasketAcct = NULL;
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theBasketAcctGuardian;

            <span class="keywordtype">bool</span> bLookup = <a class="code" href="class_o_t_server.html#a257d4016ba99b0bb6c1762fa014e4623">LookupBasketAccountIDByContractID</a>(BASKET_CONTRACT_ID, BASKET_ACCOUNT_ID);
            <span class="keywordflow">if</span> (!bLookup)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Asset type is not a basket currency.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strBasket.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ||
                     !theRequestBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strBasket) ||
                     !theRequestBasket.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Expected verifiable basket object to be attached to exchangeBasket item.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theRequestBasket.<a class="code" href="class_o_t_basket.html#ab555be54ac5511072afefe94ee15105a">GetRequestAccountID</a>() != theAccount.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: User&#39;s main account ID according to request basket doesn&#39;t match theAccount.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, theRequestBasket.<a class="code" href="class_o_t_basket.html#a602444788130d3af6ff2a5f440095e7d">GetClosingNum</a>()))
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Closing number used for User&#39;s main account receipt was not available for use...\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {   <span class="comment">// Load the basket account and make sure it exists.</span>
                pBasketAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(BASKET_ACCOUNT_ID, SERVER_ID);

                <span class="comment">// If the pointer is NULL, that works too. Otherwise it cleans up the object at the end of this function.</span>
                theBasketAcctGuardian.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pBasketAcct);

                <span class="keywordflow">if</span> (NULL == pBasketAcct)
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading the basket account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                }
                <span class="comment">// Does it verify?</span>
                <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pBasketAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR verifying signature on the basket account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                }
                <span class="keywordflow">else</span>
                {
                    <span class="comment">// Now we get a pointer to its asset contract...</span>
                    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(BASKET_CONTRACT_ID);

                    <span class="comment">// Now let&#39;s load up the actual basket, from the actual asset contract.</span>
                    <span class="keywordflow">if</span> (pContract &amp;&amp;
                        theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()) &amp;&amp;
                        theBasket.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer) &amp;&amp;
                        theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>() == theRequestBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>() &amp;&amp;
                        theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>() == theRequestBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>())
                    {
                        <span class="comment">// -----------------------------------------------------------------------------------</span>
                        <span class="comment">// Let&#39;s make sure that the same asset account doesn&#39;t appear twice on the request.</span>
                        <span class="comment">//</span>
                        std::set&lt;OTIdentifier&gt; setOfAccounts;
                        setOfAccounts.insert(theRequestBasket.<a class="code" href="class_o_t_basket.html#ab555be54ac5511072afefe94ee15105a">GetRequestAccountID</a>());

                        <span class="keywordtype">bool</span> bFoundSameAcctTwice = <span class="keyword">false</span>;

                        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theRequestBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
                        {
                            <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theRequestBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);
                            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
                            <span class="comment">// -------------------------------------</span>
                            std::set&lt;OTIdentifier&gt;::iterator it_account = setOfAccounts.find(pItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>);

                            <span class="keywordflow">if</span> (setOfAccounts.end() != it_account) <span class="comment">// The account appears twice!!</span>
                            {
                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSubID(pItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>);
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: Sub-account ID found TWICE on same basket exchange request: %s\n&quot;</span>,
                                              __FUNCTION__, strSubID.Get());
                                bFoundSameAcctTwice = <span class="keyword">true</span>;
                                <span class="keywordflow">break</span>;
                            }
                            <span class="comment">// -------------------------------------</span>
                            setOfAccounts.insert(pItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>);
                        }
                        <span class="comment">// -----------------------------------------------------------------------------------</span>
                        <span class="keywordflow">if</span> (!bFoundSameAcctTwice) <span class="comment">// Let&#39;s do it!</span>
                        {
                            <span class="comment">// Loop through the request AND the actual basket TOGETHER...</span>
                            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
                            {
                                <a class="code" href="class_basket_item.html">BasketItem</a> * pBasketItem    = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);
                                <a class="code" href="class_basket_item.html">BasketItem</a> * pRequestItem   = theRequestBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i); <span class="comment">// we already know these are the same length</span>

                                <span class="comment">// if not equal</span>
                                <span class="keywordflow">if</span> (!(pBasketItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a> == pRequestItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>))
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error: expected asset type IDs to match in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                    bSuccess = <span class="keyword">false</span>;
                                    <span class="keywordflow">break</span>;
                                }
                                <span class="comment">// if accounts are equal (should never happen -- why would the user be trying to use the server&#39;s account as his own?)</span>
                                <span class="comment">// Furthermore, loading both at the same time, with same ID, then saving again, can screw up the balance.</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBasketItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a> == pRequestItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>)
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error: VERY strange to have these account ID&#39;s match. OTServer::NotarizeExchangeBasket.\n&quot;</span>);
                                    bSuccess = <span class="keyword">false</span>;
                                    <span class="keywordflow">break</span>;
                                }

                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, pRequestItem-&gt;<a class="code" href="class_basket_item.html#a688548ad883b26d810a3e4a23c1693a4">lClosingTransactionNo</a>))
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error: Basket sub-currency closing number didn&#39;t verify . OTServer::NotarizeExchangeBasket.\n&quot;</span>);
                                    bSuccess = <span class="keyword">false</span>;
                                    <span class="keywordflow">break</span>;
                                }
                                <span class="keywordflow">else</span> <span class="comment">// if equal</span>
                                {
                                    bSuccess = <span class="keyword">true</span>;

                                    <span class="comment">// --------------------------------------------------------</span>
                                    <span class="comment">// Load up the two accounts and perform the exchange...</span>
                                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pUserAcct   = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pRequestItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>, SERVER_ID);

                                    <span class="keywordflow">if</span> (NULL == pUserAcct)
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading a user&#39;s asset account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }
                                    <span class="comment">// --------------------------------------------------------</span>
                                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pServerAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pBasketItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>, SERVER_ID);

                                    <span class="keywordflow">if</span> (NULL == pServerAcct)
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading a basket sub-account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }
                                    <span class="comment">// --------------------------------------------------------</span>
                                    <span class="comment">// Load up the inbox for the user&#39;s sub account, so we can drop the receipt.</span>
                                    <span class="comment">//</span>
                                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pSubInbox = pUserAcct-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);

                                    <span class="keywordflow">if</span> (NULL == pSubInbox) <span class="comment">// || !pSubInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying sub-inbox in OTServer::NotarizeExchangeBasket.\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }

                                    <span class="comment">// I&#39;m preserving these points, to be deleted at the end.</span>
                                    <span class="comment">// They won&#39;t be saved until after ALL debits/credits were successful.</span>
                                    <span class="comment">// Once ALL exchanges are done, THEN it loops through and saves / deletes</span>
                                    <span class="comment">// all the accounts.</span>
                                    listUserAccounts.push_back(pUserAcct);
                                    listServerAccounts.push_back(pServerAcct);
                                    listInboxes.push_back(pSubInbox);

                                    <span class="comment">// Do they verify?</span>
                                    <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
                                    <span class="keywordflow">if</span> (pUserAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() != pBasketItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>)
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR verifying asset type on a user&#39;s account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }
                                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pUserAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR verifying signature on a user&#39;s asset account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }
                                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pServerAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR verifying signature on a basket sub-account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                        bSuccess = <span class="keyword">false</span>;
                                        <span class="keywordflow">break</span>;
                                    }
                                    <span class="keywordflow">else</span>  <span class="comment">// -------------------------------------------------------------------------------</span>
                                    {
                                        <span class="comment">// the amount being transferred between these two accounts is the minimum transfer amount</span>
                                        <span class="comment">// for the sub-account on the basket, multiplied by</span>
                                        lTransferAmount = (pBasketItem-&gt;<a class="code" href="class_basket_item.html#a7a1360eb91fa3bced17ed6d097669c9a">lMinimumTransferAmount</a> * theRequestBasket.<a class="code" href="class_o_t_basket.html#a17a8f5c77fdff52265e05c2d73110d08">GetTransferMultiple</a>());

    <span class="comment">//                                  bSuccess = false; // probably superfluous.</span>

                                        <span class="comment">// user is performing exchange IN</span>
                                        <span class="keywordflow">if</span> (theRequestBasket.<a class="code" href="class_o_t_basket.html#a27ddc61eab873748483628daa399de72">GetExchangingIn</a>())
                                        {
                                            <span class="keywordflow">if</span> (pUserAcct-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lTransferAmount))
                                            {
                                                <span class="keywordflow">if</span> (pServerAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                    bSuccess = <span class="keyword">true</span>;
                                                <span class="keywordflow">else</span>
                                                {   <span class="comment">// the server credit failed.</span>
                                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot; OTServer::NotarizeExchangeBasket: Failure crediting server acct.\n&quot;</span>);

                                                    <span class="comment">// Since we debited the user&#39;s acct already, let&#39;s put that back.</span>
                                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pUserAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot; OTServer::NotarizeExchangeBasket: Failure crediting back user &quot;</span>
                                                                     <span class="stringliteral">&quot;account.\n&quot;</span>);
                                                    bSuccess = <span class="keyword">false</span>;
                                                    <span class="keywordflow">break</span>;
                                                }
                                            }
                                            <span class="keywordflow">else</span>
                                            {
                                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Unable to Debit user account.\n&quot;</span>);
                                                bSuccess = <span class="keyword">false</span>;
                                                <span class="keywordflow">break</span>;
                                            }
                                        }
                                        <span class="keywordflow">else</span> <span class="comment">// user is peforming exchange OUT</span>
                                        {
                                            <span class="keywordflow">if</span> (pServerAcct-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lTransferAmount))
                                            {
                                                <span class="keywordflow">if</span> (pUserAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                    bSuccess = <span class="keyword">true</span>;
                                                <span class="keywordflow">else</span>
                                                {   <span class="comment">// the user credit failed.</span>
                                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot; OTServer::NotarizeExchangeBasket: Failure crediting user acct.\n&quot;</span>);

                                                    <span class="comment">// Since we debited the server&#39;s acct already, let&#39;s put that back.</span>
                                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pServerAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot; OTServer::NotarizeExchangeBasket: Failure crediting back server &quot;</span>
                                                                     <span class="stringliteral">&quot;account.\n&quot;</span>);
                                                    bSuccess = <span class="keyword">false</span>;
                                                    <span class="keywordflow">break</span>;
                                                }
                                            }
                                            <span class="keywordflow">else</span>
                                            {
                                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot; OTServer::NotarizeExchangeBasket: Unable to Debit server account.\n&quot;</span>);
                                                bSuccess = <span class="keyword">false</span>;
                                                <span class="keywordflow">break</span>;
                                            }
                                        }
                                        <span class="comment">// -----------------------------------------------------------------------------</span>
                                        <span class="comment">// Drop the receipt -- accounts were debited and credited properly.</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (bSuccess)
                                        {   <span class="comment">// need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                                            <span class="comment">// update: actually does pretty good roll-back as it is. The debits and credits</span>
                                            <span class="comment">// don&#39;t save unless everything is a success.</span>

                                            <span class="comment">// Generate new transaction number (for putting the basketReceipt in the exchanger&#39;s inbox.)</span>
                                            <span class="comment">// todo check this generation for failure (can it fail?)</span>
                                            int64_t lNewTransactionNumber = 0;

                                            <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction   = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pSubInbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>, lNewTransactionNumber);

                                            <a class="code" href="class_o_t_item.html">OTItem</a> * pItemInbox = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pInboxTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>);

                                            <span class="comment">// these may be unnecessary, I&#39;ll have to check CreateItemFromTransaction. I&#39;ll leave em.</span>
                                            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItemInbox);

                                            pItemInbox-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the default.</span>
                                            pItemInbox-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(theRequestBasket.<a class="code" href="class_o_t_basket.html#a27ddc61eab873748483628daa399de72">GetExchangingIn</a>() ? lTransferAmount*(-1) : lTransferAmount);

                                            pItemInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                            pItemInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItemInbox); <span class="comment">// Add the inbox item to the inbox transaction, so we can add to the inbox ledger.</span>

                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                                            <span class="comment">// The &quot;exchangeBasket request&quot; OTItem is saved as the &quot;In Reference To&quot; field</span>
                                            <span class="comment">// on the inbox basketReceipt transaction.</span>
                                            <span class="comment">//todo put these two together in a method.</span>
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;GetTransactionNum());
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#af3c025bbdeb70a053c6149a32d8b9940">SetClosingNum</a>(pRequestItem-&gt;<a class="code" href="class_basket_item.html#a688548ad883b26d810a3e4a23c1693a4">lClosingTransactionNo</a>); <span class="comment">// Here is the number the user wishes to sign-off by accepting this receipt.</span>

                                            <span class="comment">// Now we have created a new transaction from the server to the sender&#39;s inbox (for a receipt).</span>
                                            <span class="comment">// Let&#39;s sign and save it...</span>
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                            <span class="comment">// Here the transaction we just created is actually added to the exchanger&#39;s inbox.</span>
                                            pSubInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pInboxTransaction);
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pSubInbox);
                                        }
                                    } <span class="comment">// User and Server sub-accounts are good. ---------------------------------------</span>
                                } <span class="comment">// pBasketItem and pRequestItem are good.</span>
                            } <span class="comment">// for (loop through basketitems)</span>
                            <span class="comment">// *****************************************************************************</span>
                            <span class="comment">// Load up the two main accounts and perform the exchange...</span>
                            <span class="comment">// (Above we did the sub-accounts for server and user. Now we do the main accounts for server and user.)</span>
                            <span class="comment">//</span>

                            <span class="comment">// At this point, if we have successfully debited / credited the sub-accounts.</span>
                            <span class="comment">// then we need to debit and credit the user&#39;s main basket account and the server&#39;s basket issuer account.</span>
                            <span class="keywordflow">if</span> ((<span class="keyword">true</span> == bSuccess) &amp;&amp; (NULL != pBasketAcct))
                            {
                                lTransferAmount =  (theRequestBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>() * theRequestBasket.<a class="code" href="class_o_t_basket.html#a17a8f5c77fdff52265e05c2d73110d08">GetTransferMultiple</a>());

                                <span class="comment">// Load up the two accounts and perform the exchange...</span>
                                <span class="comment">// user is performing exchange IN</span>
                                <span class="keywordflow">if</span> (theRequestBasket.<a class="code" href="class_o_t_basket.html#a27ddc61eab873748483628daa399de72">GetExchangingIn</a>())
                                {
                                    <span class="keywordflow">if</span> (pBasketAcct-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lTransferAmount))
                                    {
                                        <span class="keywordflow">if</span> (theAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                            bSuccess = <span class="keyword">true</span>;
                                        <span class="keywordflow">else</span>
                                        {
                                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Failed crediting user basket account.\n&quot;</span>);

                                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBasketAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Failed crediting back basket issuer account.\n&quot;</span>);

                                            bSuccess = <span class="keyword">false</span>;
                                        }
                                    }
                                    <span class="keywordflow">else</span>
                                    {
                                        bSuccess = <span class="keyword">false</span>;
                                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to Debit basket issuer account, in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                    }
                                }
                                <span class="keywordflow">else</span> <span class="comment">// user is peforming exchange OUT</span>
                                {
                                    <span class="keywordflow">if</span> (theAccount.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lTransferAmount))
                                    {
                                        <span class="keywordflow">if</span> (pBasketAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                            bSuccess = <span class="keyword">true</span>;
                                        <span class="keywordflow">else</span>
                                        {
                                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Failed crediting basket issuer account.\n&quot;</span>);

                                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTransferAmount))
                                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeExchangeBasket: Failed crediting back user basket account.\n&quot;</span>);

                                            bSuccess = <span class="keyword">false</span>;
                                        }
                                    }
                                    <span class="keywordflow">else</span>
                                    {
                                        bSuccess = <span class="keyword">false</span>;
                                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to Debit user basket account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                    }
                                }


                                <span class="comment">// -----------------------------------------------------------------------------</span>
                                <span class="comment">// Drop the receipt -- accounts were debited and credited properly.</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (bSuccess)
                                {   <span class="comment">// need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                                    <span class="comment">// update: actually does pretty good roll-back as it is. The debits and credits</span>
                                    <span class="comment">// don&#39;t save unless everything is a success.</span>

                                    <span class="comment">// Generate new transaction number (for putting the basketReceipt in the exchanger&#39;s inbox.)</span>
                                    <span class="comment">// todo check this generation for failure (can it fail?)</span>
                                    int64_t lNewTransactionNumber = 0;

                                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction   = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pInbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>,
                                                                                                             lNewTransactionNumber);

                                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemInbox     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pInboxTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>);

                                    <span class="comment">// these may be unnecessary, I&#39;ll have to check CreateItemFromTransaction. I&#39;ll leave em.</span>
                                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItemInbox);

                                    pItemInbox-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the default.</span>
                                    pItemInbox-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(theRequestBasket.<a class="code" href="class_o_t_basket.html#a27ddc61eab873748483628daa399de72">GetExchangingIn</a>() ? lTransferAmount : lTransferAmount*(-1));

                                    pItemInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pItemInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItemInbox); <span class="comment">// Add the inbox item to the inbox transaction, so we can add to the inbox ledger.</span>

                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                                    <span class="comment">// The exchangeBasket request OTItem is saved as a &quot;in reference to&quot; field,</span>
                                    <span class="comment">// on the inbox basketReceipt transaction.</span>
                                    <span class="comment">//todo put these two together in a method.</span>
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;GetTransactionNum());
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#af3c025bbdeb70a053c6149a32d8b9940">SetClosingNum</a>(theRequestBasket.<a class="code" href="class_o_t_basket.html#a602444788130d3af6ff2a5f440095e7d">GetClosingNum</a>()); <span class="comment">// So the exchanger can sign-off on this closing num by accepting the basket receipt on his main basket account.</span>

                                    <span class="comment">// Now we have created a new transaction from the server to the sender&#39;s inbox</span>
                                    <span class="comment">// Let&#39;s sign and save it...</span>
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                    <span class="comment">// Here the transaction we just created is actually added to the source acct&#39;s inbox.</span>
                                    pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pInboxTransaction);
                                    pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pInbox);
                                }
                            }
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying user&#39;s main basket account in OTServer::NotarizeExchangeBasket\n&quot;</span>);
                                bSuccess = <span class="keyword">false</span>;
                            }
                            <span class="comment">// ---------------------------------------------------------------------------------------</span>


                            <span class="comment">// At this point, we have hopefully credited/debited ALL the relevant accounts.</span>
                            <span class="comment">// So now, let&#39;s Save them ALL to disk.. (and clean them up.)</span>
                            <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = NULL;

                            <span class="comment">// empty the list of USER accounts (and save to disk, if everything was successful.)</span>
                            <span class="keywordflow">while</span> (!listUserAccounts.empty())
                            {
                                pAccount = listUserAccounts.front();
                                <span class="keywordflow">if</span> (NULL == pAccount) <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
                                listUserAccounts.pop_front();

                                <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
                                {
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                    pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
                                }

                                <span class="keyword">delete</span> pAccount; pAccount=NULL;
                            }
                            <span class="comment">// ---------------------------------------------</span>
                            <span class="comment">// empty the list of SERVER accounts (and save to disk, if everything was successful.)</span>
                            <span class="keywordflow">while</span> (!listServerAccounts.empty())
                            {
                                pAccount = listServerAccounts.front();
                                <span class="keywordflow">if</span> (NULL == pAccount) <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;

                                listServerAccounts.pop_front();

                                <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
                                {
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                    pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
                                }

                                <span class="keyword">delete</span> pAccount; pAccount=NULL;
                            }
                            <span class="comment">// ---------------------------------------------</span>
                            <span class="comment">// empty the list of inboxes (and save to disk, if everything was successful.)</span>
                            <span class="keywordflow">while</span> (!listInboxes.empty())
                            {
                                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pTempInbox = listInboxes.front();
                                <span class="keywordflow">if</span> (NULL == pTempInbox) <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
                                listInboxes.pop_front();

                                <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
                                {
                                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                    pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
                                }

                                <span class="keyword">delete</span> pTempInbox; pTempInbox=NULL;
                            }
                            <span class="comment">// ---------------------------------------------</span>
                            <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
                            {
                                pInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                pInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                pInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                theAccount.<a class="code" href="class_o_t_account.html#a81e503e95310da5ac9c2003cb00d6d2e">SaveInbox</a>(*pInbox);

                                theAccount.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                theAccount.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                theAccount.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                theAccount.<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                                pBasketAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                pBasketAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                pBasketAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                pBasketAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                                <span class="comment">// ----------------------------------------------------</span>
                                <span class="comment">// Remove my ability to use the &quot;closing&quot; numbers in the future.</span>
                                <span class="comment">// (Since I&#39;m using them to do this exchange...)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theRequestBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
                                {
                                    <a class="code" href="class_basket_item.html">BasketItem</a> * pRequestItem   = theRequestBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);

                                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pRequestItem);

                                    <span class="comment">// This just removes the number so I can&#39;t USE it.</span>
                                    <span class="comment">// I&#39;m still RESPONSIBLE for the number until RemoveIssuedNumber() is called.</span>
                                    <span class="comment">//</span>
                                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, pRequestItem-&gt;<a class="code" href="class_basket_item.html#a688548ad883b26d810a3e4a23c1693a4">lClosingTransactionNo</a>, <span class="keyword">false</span>); <span class="comment">// bSave=false</span>
                                }
                                <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, theRequestBasket.<a class="code" href="class_o_t_basket.html#a602444788130d3af6ff2a5f440095e7d">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                                <span class="comment">// ----------------------------------------------------</span>
                                pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the exchangeBasket was successful.</span>

                                bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The exchangeBasket was successful.</span>
                            }
                        } <span class="comment">// Let&#39;s do it!</span>
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error finding asset contract for basket, or loading the basket from it, or verifying\n&quot;</span>
                                     <span class="stringliteral">&quot;the signature on that basket, or the request basket didn&#39;t match actual basket.\n&quot;</span>);
                    }
                } <span class="comment">// pBasket exists and signature verifies</span>
                <span class="comment">// NO need to cleanup pBasketAcct here, since OTCleanup handles it now.</span>
            } <span class="comment">// theRequestBasket loaded properly.</span>
        } <span class="comment">// else (balance agreement verified.)</span>
    } <span class="comment">// Balance Agreement item found.</span>

    <span class="comment">// I put this here so it&#39;s signed/saved whether the balance agreement itself was successful OR NOT.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae0494b71bb963f7a5e56d3f1134e280d"></a><!-- doxytag: member="OTServer::NotarizeMarketOffer" ref="ae0494b71bb963f7a5e56d3f1134e280d" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAssetAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae0494b71bb963f7a5e56d3f1134e280d">OTServer::NotarizeMarketOffer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAssetAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>a user is exchanging in or out of a basket. (Ex. He's trading 2 gold and 3 silver for 10 baskets, or vice-versa.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l09213">9213</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atMarketOffer&quot;, that is, &quot;a reply to the marketOffer request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will definitely be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID), USER_ID(theNym);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);

    pItem           = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae973afad2dc8a8349e8889304b20e73b">OTItem::marketOffer</a>);
    pBalanceItem    = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
    <span class="comment">// ---------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a229f0c7ace7a51840d7632910a0b92a6">OTItem::atMarketOffer</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// ---------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_market_offer))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: User %s cannot do this transaction &quot;</span>
                       <span class="stringliteral">&quot;(All market offers are disallowed in server.cfg)\n&quot;</span>, strUserID.Get());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pBalanceItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: Expected transaction statement in trans # %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: Expected OTItem::marketOffer in trans# %ld:\n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// For now, there should only be one of these marketOffer items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="keywordflow">else</span>
    {
        <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
        <span class="comment">// here so it can be saved into the &quot;in reference to&quot; field.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// ASSET_ACCT_ID is the ID on the &quot;from&quot; Account that was passed in.</span>
        <span class="comment">// The CURRENCY_ACCT_ID is the ID on the &quot;To&quot; Account. (When doing a transfer, normally 2nd acct is the Payee.)</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ASSET_ACCT_ID(theAssetAccount), CURRENCY_ACCT_ID(pItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>());

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        <span class="comment">// *******************************************************************************************</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == (pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7df2f7973839d7a270f6ea8de67d07b4">VerifyTransactionStatement</a>(theNym, tranIn))) <span class="comment">// bIsRealTransaction = true;</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR verifying transaction statement in NotarizeMarketOffer.\n&quot;</span>);
        }
        <span class="comment">// *******************************************************************************************</span>
        <span class="keywordflow">else</span>
        {
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

            <span class="comment">// Load up the currency account and validate it.</span>
            <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(CURRENCY_ACCT_ID, SERVER_ID);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theCurrencyAcctGuardian(pCurrencyAcct); <span class="comment">// Now I don&#39;t have to worry about deleting pCurrencyAcct.</span>

            <span class="comment">// Also load up the Trade from inside the transaction item.</span>
            <a class="code" href="class_o_t_string.html">OTString</a>    strOffer;
            <a class="code" href="class_o_t_offer.html">OTOffer</a>     theOffer;

            <a class="code" href="class_o_t_string.html">OTString</a>    strTrade;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strTrade);

            <a class="code" href="class_o_t_trade.html">OTTrade</a> * pTrade = <span class="keyword">new</span> <a class="code" href="class_o_t_trade.html">OTTrade</a>();

            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTrade);

            <span class="comment">// First load the Trade up (from the string that was passed in on the transaction item.)</span>
            <span class="keywordtype">bool</span> bLoadContractFromString = pTrade-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTrade);

            <span class="comment">// If failed to load the trade...</span>
            <span class="keywordflow">if</span> (!bLoadContractFromString)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading trade from string in OTServer::NotarizeMarketOffer:\n%s\n&quot;</span>,
                              strTrade.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="comment">// I&#39;m using the operator== because it exists. (Although now I believe != exists also)</span>
            <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
            <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(ASSET_ACCT_ID == pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: Asset account ID on the transaction does not match asset account ID on the transaction item.\n&quot;</span>);
            }
            <span class="comment">// ok so the IDs match. Does the currency account exist?</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pCurrencyAcct)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying existence of the currency account in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pCurrencyAcct-&gt;<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying Contract ID on the currency account in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pCurrencyAcct-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(theNym))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying ownership of the currency account in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="comment">// Are both of the accounts of the same Asset Type?</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theAssetAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() == pCurrencyAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
            {
                <a class="code" href="class_o_t_string.html">OTString</a>    strAssetTypeID(theAssetAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()),
                strCurrencyTypeID(pCurrencyAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR - user attempted to trade between identical &quot;</span>
                               <span class="stringliteral">&quot;asset types in OTServer::NotarizeMarketOffer:\n%s\n%s\n&quot;</span>,
                               strAssetTypeID.Get(),
                               strCurrencyTypeID.Get());
            }
            <span class="comment">// Does it verify?</span>
            <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pCurrencyAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying signature on the Currency account in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pTrade-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying signature on the Trade in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>() != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR bad transaction number on trade in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="comment">// The transaction number opens the market offer, but there must also be a closing number for closing it.</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a96d3ae7898526a317dd503daecbf10af">GetCountClosingNumbers</a>() &lt; 2) ||
                     !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, pTrade-&gt;<a class="code" href="class_o_t_trade.html#ad21c6e7d77168d945c1375dedc9a74e0">GetAssetAcctClosingNum</a>()) || <span class="comment">// Verify that it can still be USED</span>
                     !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, pTrade-&gt;<a class="code" href="class_o_t_trade.html#af72dc4e869fe4b25c250398a2da27570">GetCurrencyAcctClosingNum</a>())
                     )
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR needed 2 valid closing transaction numbers in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() !=   SERVER_ID)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID1(pTrade-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>()), strID2(SERVER_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong Server ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strID1.Get(), strID2.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() != USER_ID)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID1(pTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>()), strID2(USER_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong Nym ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strID1.Get(), strID2.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>() != theAssetAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID1(pTrade-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()), strAssetID2(theAssetAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong Asset Type ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strAssetID1.Get(), strAssetID2.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>() != ASSET_ACCT_ID)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID1(pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>()), strAcctID2(ASSET_ACCT_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong asset Acct ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strAcctID1.Get(), strAcctID2.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>() != pCurrencyAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID1(pTrade-&gt;<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>()), strID2(pCurrencyAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong Currency Type ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strID1.Get(), strID2.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>() != CURRENCY_ACCT_ID)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID1(pTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()), strID2(CURRENCY_ACCT_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: ERROR wrong Currency Acct ID (%s) on trade. Expected: %s\n&quot;</span>,
                               strID1.Get(), strID2.Get());
            }
            <span class="comment">// If the Trade successfully verified, but I couldn&#39;t get the offer out of it, then it</span>
            <span class="comment">// actually DIDN&#39;T successfully load still.  :-(</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pTrade-&gt;<a class="code" href="class_o_t_trade.html#a61d3d3ab221ede656fbaeb5f963e2bf3">GetOfferString</a>(strOffer))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR getting offer string from trade in OTServer::NotarizeMarketOffer:\n%s\n&quot;</span>,
                              strTrade.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theOffer.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOffer))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading offer from string in OTServer::NotarizeMarketOffer:\n%s\n&quot;</span>,
                              strTrade.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="comment">// ...And then we use that same Nym to verify the signature on the offer.</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theOffer.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR verifying offer signature in OTServer::NotarizeMarketOffer.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pTrade-&gt;<a class="code" href="class_o_t_trade.html#a6327be5c41af7a34dd3912b8d17947e0">VerifyOffer</a>(theOffer))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;FAILED verifying offer for Trade in OTServer::NotarizeMarketOffer\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>() &lt; this-&gt;<a class="code" href="class_o_t_server.html#ada3425a1d2aed3991a889fe6c934f5f8">GetMinMarketScale</a>())
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: FAILED verifying Offer, SCALE: %ld. (Minimum is %ld.) \n&quot;</span>,
                               theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>(), this-&gt;<a class="code" href="class_o_t_server.html#ada3425a1d2aed3991a889fe6c934f5f8">GetMinMarketScale</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (static_cast&lt;int64_t&gt;((theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>().size() / 3)) &gt;= <a class="code" href="class_o_t_cron.html#accfe2e68cac873324a78037a46607854">OTCron::GetCronMaxItemsPerNym</a>())
            {
                <span class="comment">// NOTE:</span>
                <span class="comment">// We divided by 3 since this set contains THREE numbers for each active market offer.</span>
                <span class="comment">// It&#39;s kind of a hack, since it may NOT be three numbers for other cron items such as</span>
                <span class="comment">// payment plans and smart contracts. But it&#39;s a good enough approximation for now.</span>
                <span class="comment">//</span>
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeMarketOffer: FAILED adding offer to market: &quot;</span>
                              <span class="stringliteral">&quot;NYM HAS TOO MANY ACTIVE OFFERS ALREADY. See &#39;max_items_per_nym&#39; setting in the config file.\n&quot;</span>);
            }
            <span class="comment">// At this point I feel pretty confident that the Trade is a valid request from the user.</span>
            <span class="comment">// -------------------------------------------------</span>
            <span class="comment">// The top half of this function is oriented around finding the &quot;marketOffer&quot; item (in the &quot;marketOffer&quot;</span>
            <span class="comment">// transaction) and setting up the response item that will go into the response transaction. It also</span>
            <span class="comment">// retrieves the Trade object and fully validates it.</span>
            <span class="comment">//</span>
            <span class="comment">// Next all we need to do is add it to the market...</span>


            <span class="keywordflow">else</span>
            {
                <span class="comment">// We don&#39;t actually add the trade to a market here. Instead, we add it to the server&#39;s Cron object.</span>
                <span class="comment">// That object will take care of processing the offer on and off of any market.</span>
                <span class="comment">//</span>
                <span class="comment">// NOTE: FYI, inside AddCronItem, since this is a new CronItem, a Cron Receipt will</span>
                <span class="comment">// be saved with the User&#39;s signature on it, containing the Cron Item from the user&#39;s</span>
                <span class="comment">// original request. After that, the item is stored internally to Cron itself, and</span>
                <span class="comment">// signed by the server--and changes over time as cron processes. (The original receipt</span>
                <span class="comment">// can always be loaded when necessary.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (m_Cron.<a class="code" href="class_o_t_cron.html#a2d42c183c174f56a7c7c3da1e844a53f">AddCronItem</a>(*pTrade, &amp;theNym, <span class="keyword">true</span>, <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>())) <span class="comment">// bSaveReceipt=true</span>
                {
                    <span class="comment">//todo need to be able to &quot;roll back&quot; if anything inside this block fails.</span>

                    <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                    bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The offer was successfully placed on the market.</span>

                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Successfully added Trade to Cron object.\n&quot;</span>);

                    <span class="comment">// Server side, the Nym stores a list of all open cron item numbers.</span>
                    <span class="comment">// (So we know if there is still stuff open on Cron for that Nym, and we know what it is.)</span>
                    <span class="comment">//</span>
                    std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
                    theIDSet.insert(pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                    theIDSet.insert(pTrade-&gt;<a class="code" href="class_o_t_trade.html#ad21c6e7d77168d945c1375dedc9a74e0">GetAssetAcctClosingNum</a>());
                    theIDSet.insert(pTrade-&gt;<a class="code" href="class_o_t_trade.html#af72dc4e869fe4b25c250398a2da27570">GetCurrencyAcctClosingNum</a>());
                    <span class="comment">// ------------------------------------------------------------------</span>
                    <span class="comment">// This just removes the Closing number so he can&#39;t USE it again. (Since he&#39;s using it as the closing</span>
                    <span class="comment">// number for this cron item now.) He&#39;s still RESPONSIBLE for the number until RemoveIssuedNumber()</span>
                    <span class="comment">// is called. If we didn&#39;t call this here, then he could come back later and USE THE NUMBER AGAIN!</span>
                    <span class="comment">// (Bad!) You might ask, why not remove the Opening number as well as the Closing numbers? The answer</span>
                    <span class="comment">// is, we already did, before we got here. (Otherwise we wouldn&#39;t have even gotten this far.)</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, pTrade-&gt;<a class="code" href="class_o_t_trade.html#ad21c6e7d77168d945c1375dedc9a74e0">GetAssetAcctClosingNum</a>(), <span class="keyword">false</span>);
                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, pTrade-&gt;<a class="code" href="class_o_t_trade.html#af72dc4e869fe4b25c250398a2da27570">GetCurrencyAcctClosingNum</a>(), <span class="keyword">false</span>); <span class="comment">// (Saved below.)</span>
                    <span class="comment">// RemoveIssuedNum will be called for the original transaction number when the finalReceipt is created.</span>
                    <span class="comment">// RemoveIssuedNum will be called for the Closing number when the finalReceipt is accepted.</span>

                    theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);  <span class="comment">// &lt;===== SAVED HERE.</span>
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to add trade to Cron object OTServer::NotarizeMarketOffer\n&quot;</span>);
                }
            }

            <span class="comment">// If the trade WAS successfully added to Cron, then we don&#39;t need to</span>
            <span class="comment">// delete it here, since Cron owns it now, and will deal with cleaning</span>
            <span class="comment">// it up at the right time.</span>
            <span class="keywordflow">if</span> ((NULL != pTrade) &amp;&amp; pResponseItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>() != <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>)
            {
                <span class="keyword">delete</span> pTrade;
                pTrade = NULL;
            }
        } <span class="comment">// transaction statement verified.</span>

        <span class="comment">// --------------------------------------------------------------------</span>
    } <span class="comment">// if pItem = tranIn.GetItem(OTItem::marketOffer)</span>

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save. (fixed.)</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aeb24d887eb3c2394ab446e18b8f7a9b0"></a><!-- doxytag: member="OTServer::NotarizePayDividend" ref="aeb24d887eb3c2394ab446e18b8f7a9b0" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aeb24d887eb3c2394ab446e18b8f7a9b0">OTServer::NotarizePayDividend</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theSourceAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>NotarizePayDividend</p>
<p>Phase 1: Only the signer on the currency contract (the issuer) can pay a dividend. He must pay the dividend in a currency of a DIFFERENT type. (Such as, a dollar dividend for shares of Pepsi.) So this transaction is a "dollar" transaction, using that example, and theAccount is a dollar account. But then how do we know those dollars are being paid to _Pepsi_ shareholders? Because the asset type of the shares must be attached to the <a class="el" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a76baae22af2df636d404516ecf5ea06a">OTItem::payDividend</a> within tranIn--and also so must the "dividend payout amount, per share" be included, for the same reason. This function gets the asset contract for the shares, and passes a functor to it, so that it can iterate through all the Pepsi asset accounts and form/send a payout voucher for each one (via the functor.) This function also verifies that theNym is both signer on the asset contract for Pepsi shares (the calling function has already verified that theNym is the signer on the dollar account.)</p>
<p>Phase 2: voting groups, hierarchical entities with agents, oversight, corporate asset accounts, etc. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l05187">5187</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::NotarizePayDividend&quot;</span>;

    <span class="comment">// The outgoing transaction is an &quot;atPayDividend&quot;, that is, &quot;a reply to the &#39;pay dividend&#39; request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem                  = NULL;  <span class="comment">// This pointer and the following one, are 2 pointers, as a vestige</span>
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemPayDividend       = NULL;  <span class="comment">// from the withdrawal code, which has two forms: voucher and cash.</span>
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem           = NULL;  <span class="comment">// The balance agreement item, which must be on any transaction.</span>
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem          = NULL;  <span class="comment">// Server&#39;s response to pItem.</span>
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;  <span class="comment">// Server&#39;s response to pBalanceItem.</span>

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_string.html">OTString</a>  strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a>  strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="comment">//</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID       (m_strServerID),
                        USER_ID         (theNym),
                        SOURCE_ACCT_ID  (theSourceAccount),
                        SERVER_USER_ID  (m_nymServer),
                        PAYOUT_ASSET_ID (theSourceAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()); <span class="comment">// Ex: Pepsi shares, Dollar dividend. (PAYOUT_ASSET_ID is Dollars.)</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strUserID      (USER_ID),
                    strAccountID   (SOURCE_ACCT_ID),
                    strAssetTypeID (PAYOUT_ASSET_ID);
    <span class="comment">// -----------------------------------------------------------------</span>
    <span class="comment">// Make sure the appropriate item is attached.</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

    pItemPayDividend = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a76baae22af2df636d404516ecf5ea06a">OTItem::payDividend</a>);

    <span class="keywordflow">if</span> (NULL != pItemPayDividend) <span class="comment">// found it.</span>
    {
        pItem = pItemPayDividend;
        <span class="comment">// ---------</span>
        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a>;
    }
    <span class="comment">// -----------------------------------------------------------------</span>
    <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
    <span class="comment">// (They&#39;re getting SOME sort of response item.)</span>
    <span class="comment">//</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, theReplyItemType);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------</span>
    <span class="keywordflow">if</span> (NULL == pItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expected OTItem::payDividend in trans# %ld: \n\n%s\n\n&quot;</span>,
                       szFunc,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
                       strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR SERIALIZING TRANSACTION INTO A STRING) &quot;</span>);
    }
    <span class="comment">// Below this point, we know that pItem is good, and that pItemPayDividend is good,</span>
    <span class="comment">// and that pItem points to it. Therefore next, let&#39;s verify permissions:</span>
    <span class="comment">// ---------------------------------------------------------------------</span>
    <span class="comment">//</span>
    <span class="comment">// This permission has to do with ALL withdrawals from an account</span>
    <span class="comment">// (cash / voucher / dividends)</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_withdrawal))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction (All withdrawals are &quot;</span>
                       <span class="stringliteral">&quot;disallowed in server.cfg, even for paying dividends with.)\n&quot;</span>,
                       szFunc, strUserID.Get());
    }
    <span class="comment">// -----------------------------------------</span>
    <span class="comment">// This permission has to do with paying dividends.</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL != pItemPayDividend) &amp;&amp;
             (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_pay_dividend)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction &quot;</span>
                       <span class="stringliteral">&quot;(payDividend is disallowed in server.cfg)\n&quot;</span>,
                       szFunc,
                       strUserID.Get());
    }
    <span class="comment">// ----------------------------------------------------------</span>
    <span class="comment">// Check for a balance agreement...</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pBalanceItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>)))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expected OTItem::balanceStatement, but not found in trans # %ld: \n\n%s\n\n&quot;</span>, szFunc,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR SERIALIZING TRANSACTION INTO A STRING) &quot;</span>);
    }
    <span class="comment">// ------------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a76baae22af2df636d404516ecf5ea06a">OTItem::payDividend</a>) <span class="comment">// Superfluous by this point. Artifact of withdrawal code.</span>
    {
        <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
        <span class="comment">// here so they can all grab a copy of it into their &quot;in reference to&quot; fields.</span>
        <span class="comment">//</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// Make sure the response items know which transaction # they&#39;re in response to,</span>
        <span class="comment">// and have a copy of the original request-transaction.</span>
        <span class="comment">//</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>
        <span class="comment">// ----------------------------------------------------</span>
        <span class="keyword">const</span> int64_t lTotalCostOfDividend = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
        <span class="comment">// ----------------------------------------------------</span>
        <a class="code" href="class_o_t_cheque.html">OTCheque</a>    theVoucherRequest;
        <a class="code" href="class_o_t_string.html">OTString</a>    strVoucherRequest, strItemNote; <span class="comment">// When paying a dividend, you create a voucher request (the same as in withdrawVoucher). It&#39;s just for information</span>
        pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strVoucherRequest);    <span class="comment">// passing, since payDividend needs a few bits of info, and this is a convenient way of passing it.</span>
        pItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>      (strItemNote);
        <span class="keyword">const</span> <span class="keywordtype">bool</span>  bLoadContractFromString = theVoucherRequest.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strVoucherRequest);

        <span class="keywordflow">if</span> (!bLoadContractFromString)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading dividend payout&#39;s voucher request from string:\n%s\n&quot;</span>,
                          szFunc, strVoucherRequest.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="comment">// ----------------------------------------------------</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theVoucherRequest.<a class="code" href="class_o_t_cheque.html#a84e570d654f20e69f64f0037b96b7c7e">GetAmount</a>() &lt;= 0)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR expected &gt;0 &#39;payout per share&#39; as &#39;amount&#39; on request voucher:\n%s\n&quot;</span>,
                          szFunc, strVoucherRequest.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="comment">// ----------------------------------------------------</span>
        <span class="keywordflow">else</span>
        {
            <span class="comment">// the request voucher (sent from client) contains the payout amount per share.</span>
            <span class="comment">// Whereas pItem contains lTotalCostOfDividend, which is the total cost (the</span>
            <span class="comment">// payout multiplied by number of shares.)</span>
            <span class="comment">//</span>
            <span class="keyword">const</span> int64_t lAmountPerShare = theVoucherRequest.<a class="code" href="class_o_t_cheque.html#a84e570d654f20e69f64f0037b96b7c7e">GetAmount</a>(); <span class="comment">// already validated, just above.</span>
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SHARES_ISSUER_ACCT_ID = theVoucherRequest.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();

            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSharesIssuerAcct(SHARES_ISSUER_ACCT_ID);
            <span class="comment">// ----------------------------------------------------</span>
            <span class="comment">// Get the asset contract for the shares type, stored in the voucher request, inside pItem.</span>
            <span class="comment">//       (Make sure it&#39;s NOT the same asset type as theSourceAccount.)</span>
            <span class="comment">//</span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    SHARES_ASSET_ID      = theVoucherRequest.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>();
            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>    *  pSharesContract      = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(SHARES_ASSET_ID);
            <a class="code" href="class_o_t_account.html">OTAccount</a>          *  pSharesIssuerAccount = NULL;
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a>  theAcctAngel;

            <span class="keywordflow">if</span> (NULL != pSharesContract)
            {
                pSharesIssuerAccount = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(SHARES_ISSUER_ACCT_ID, SERVER_ID);
                theAcctAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pSharesIssuerAccount);
            }

            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">if</span> (NULL == pSharesContract)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSharesType(SHARES_ASSET_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR unable to find shares contract based on asset type ID: %s\n&quot;</span>, szFunc,
                              strSharesType.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pSharesContract-&gt;<a class="code" href="class_o_t_asset_contract.html#acbd416ba9d7ac6b0965fadc971e3d12b">IsShares</a>())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSharesType(SHARES_ASSET_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: FAILURE: Asset contract is not shares-based. Asset type ID: %s\n&quot;</span>,
                              szFunc, strSharesType.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSharesContract-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSharesType(SHARES_ASSET_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR unable to verify signature for Nym (%s) on shares contract &quot;</span>
                              <span class="stringliteral">&quot;with asset ID: %s\n&quot;</span>, szFunc, strUserID.Get(), strSharesType.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pSharesIssuerAccount)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR unable to find issuer account for shares: %s\n&quot;</span>, szFunc,
                              strSharesIssuerAcct.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PAYOUT_ASSET_ID == SHARES_ASSET_ID) <span class="comment">// these can&#39;t be the same</span>
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSharesType(PAYOUT_ASSET_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR dividend payout attempted, using shares asset type as payout type also. &quot;</span>
                              <span class="stringliteral">&quot;(It&#39;s logically impossible for it to payout to itself, using &quot;</span>
                              <span class="stringliteral">&quot;ITSELF as the asset type for the payout): %s\n&quot;</span>, szFunc, strSharesType.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSharesIssuerAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(m_nymServer))
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIssuerAcctID(SHARES_ISSUER_ACCT_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR failed trying to verify issuer account: %s\n&quot;</span>,
                              szFunc, strIssuerAcctID.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSharesIssuerAccount-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(theNym))
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIssuerAcctID(SHARES_ISSUER_ACCT_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying signer&#39;s ownership of shares issuer account (%s), &quot;</span>
                               <span class="stringliteral">&quot;while trying to pay dividend from source account: %s\n&quot;</span>,
                               szFunc, strIssuerAcctID.Get(), strAccountID.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
<span class="comment">//          const int64_t lTotalCostOfDividend = pItem-&gt;GetAmount();</span>
<span class="comment">//          const int64_t lAmountPerShare = theVoucherRequest.GetAmount(); // already validated, just above.</span>
            <span class="comment">//</span>
            <span class="comment">// Make sure the share issuer&#39;s account balance (number of shares issued * (-1)),</span>
            <span class="comment">// when multiplied by the dividend &quot;amount payout per share&quot;, equals the &quot;total cost of dividend&quot;</span>
            <span class="comment">// as expected based on the value from pItem-&gt;GetAmount.</span>
            <span class="comment">//</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pSharesIssuerAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() * (-1) * lAmountPerShare) != lTotalCostOfDividend)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIssuerAcctID(SHARES_ISSUER_ACCT_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR: total payout of dividend as calculated (%ld) doesn&#39;t match client&#39;s request (%ld) for source acct: %s\n&quot;</span>,
                               szFunc, (pSharesIssuerAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() * (-1) * lAmountPerShare), lTotalCostOfDividend, strAccountID.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theSourceAccount.<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lTotalCostOfDividend)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIssuerAcctID(SHARES_ISSUER_ACCT_ID);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: FAILURE: not enough funds (%ld) to cover total dividend payout (%ld) for source acct: %s\n&quot;</span>,
                               szFunc, theSourceAccount.<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>(), lTotalCostOfDividend, strAccountID.Get());
            }
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">else</span>
            {
                <span class="comment">// Remove all the funds at once (so the balance agreement matches up.)</span>
                <span class="comment">// Then, iterate through the asset accounts and use a functor to send a voucher to each one.</span>
                <span class="comment">// (Or back to the issuer, for any that fail.)</span>

                <span class="comment">// UPDATE: unfortunately the balance agreement will be a lie unless the complete amount is removed.</span>
                <span class="comment">// Therefore, failures must be sent back to the issuer as individual receipts, containing the vouchers</span>
                <span class="comment">// for any failures, so he can have a record of them, and so he can recover the funds.</span>
                <span class="comment">// ----------------------------------------------------</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theSourceAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a> (m_nymServer);
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theSourceAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a>   theInboxAngel (pInbox);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a>   theOutboxAngel(pOutbox);
                <span class="comment">// ----------------------------------------------------</span>
                _SharedPtr&lt;OTAccount&gt;   pVoucherReserveAcct;        <span class="comment">// contains the server&#39;s funds to back vouchers of a specific asset type.</span>
<span class="comment">//              OTAccount   *       pVoucherReserveAcct = NULL;</span>
                <span class="comment">// ----------------------------------------------------</span>
                <span class="comment">//</span>
                <span class="comment">// If the ID on the &quot;from&quot; account that was passed in, does</span>
                <span class="comment">// not match the &quot;Acct From&quot; ID on this transaction item...</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (SOURCE_ACCT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
                {   <span class="comment">// TODO see if this is already verified by the caller function and if so, remove.</span>
                    <span class="comment">// (I believe the item would have entirely failed to load, if the account ID, and</span>
                    <span class="comment">// other IDs, hadn&#39;t matched up with the transaction when we loaded it.)</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Account ID does not match account ID on the &#39;pay dividend&#39; item.\n&quot;</span>, szFunc);
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying inbox.\n&quot;</span>, szFunc);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying outbox.\n&quot;</span>, szFunc);
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// The server will already have a special account for issuing vouchers. Actually, a list of them --</span>
                <span class="comment">// one for each asset type. Since this is the normal way of doing business, GetVoucherAccount() will</span>
                <span class="comment">// just create it if it doesn&#39;t already exist, and then return the pointer. Therefore, a failure here</span>
                <span class="comment">// is a catastrophic failure!  Should never fail.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pVoucherReserveAcct = <a class="code" href="class_o_t_server.html#a4e285894018dd3ed41b6aae6ccb0fec9">GetVoucherAccount</a>(PAYOUT_ASSET_ID)) &amp;&amp; <span class="comment">// If GetVoucherAccount returns a good pointer...</span>
                          pVoucherReserveAcct-&gt;VerifyAccount(m_nymServer))             <span class="comment">// ...and if it points to an acct that verifies with the server&#39;s nym...</span>
                {
                    <a class="code" href="class_o_t_account.html">OTAccount</a>    &amp; theVoucherReserveAcct = (*pVoucherReserveAcct);
                    <span class="keyword">const</span>
                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   VOUCHER_ACCOUNT_ID(theVoucherReserveAcct);

                    <span class="comment">// *********************************************************************************</span>
                    <span class="comment">// This amount must be the total amount based on the amount issued.</span>
                    <span class="comment">// For example if 1000 shares of Pepsi were issued, and the dividend is $2 per share,</span>
                    <span class="comment">// then loading the issuer&#39;s account will show a balance of -1000, and I must have</span>
                    <span class="comment">// $2000 in my source account if I am going to pay this dividend.</span>
                    <span class="comment">//</span>
                    <span class="comment">// This $2000 is entirely removed from my account at once, and the below balance agreement</span>
                    <span class="comment">// must be for $2000. The vouchers are sent to the owners of each account, in amounts</span>
                    <span class="comment">// proportionate to the number of shares in the account. For any voucher that fails to be</span>
                    <span class="comment">// sent (for whatever reason) it is sent back to theNym instead.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(lTotalCostOfDividend * (-1), <span class="comment">// My account&#39;s balance will go down by this much.</span>
                                                               theNym,
                                                               *pInbox,
                                                               *pOutbox,
                                                               theSourceAccount,
                                                               tranIn)))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying balance statement while trying to pay dividend. Source Acct ID: %s\n&quot;</span>,
                                       szFunc, strAccountID.Get());
                    }
                    <span class="comment">// *********************************************************************************</span>

                    <span class="keywordflow">else</span> <span class="comment">// successfully verified the balance agreement.</span>
                    {
                        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>
                        <span class="comment">// -------------------------------------------------</span>
                        <span class="comment">// IF we successfully created the voucher, AND the voucher amount is greater than 0,</span>
                        <span class="comment">// AND debited the user&#39;s account,</span>
                        <span class="comment">// AND credited the server&#39;s voucher account,</span>
                        <span class="comment">//</span>
                        <span class="comment">// THEN save the accounts and pay the dividend out to the shareholders.</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> ( (lTotalCostOfDividend &gt; 0) &amp;&amp;
                             <span class="comment">// ----------------</span>
                             theSourceAccount.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lTotalCostOfDividend) <span class="comment">// todo: failsafe: update this code in case of problems in this sensitive area. need better funds transfer code.</span>
                           )
                        {
                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strVoucherAcctID(VOUCHER_ACCOUNT_ID);

                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pVoucherReserveAcct-&gt;Credit(lTotalCostOfDividend)) <span class="comment">//theVoucherRequest.GetAmount()))</span>
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed crediting %ld units to voucher reserve account: %s\n&quot;</span>,
                                              szFunc, lTotalCostOfDividend, strVoucherAcctID.Get());

                                <span class="comment">// Since pVoucherReserveAcct-&gt;Credit failed, we have to return</span>
                                <span class="comment">// the funds from theSourceAccount.Debit (Credit them back.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == theSourceAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lTotalCostOfDividend))
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed crediting back the user account, after taking his funds &quot;</span>
                                                  <span class="stringliteral">&quot;and failing to credit them to the voucher reserve account.\n&quot;</span>, szFunc);
                            }
                            <span class="comment">// --------------------------------------------------------------------------</span>
                            <span class="keywordflow">else</span>    <span class="comment">// By this point, we have taken the full funds and moved them to the voucher</span>
                            {       <span class="comment">// reserve account. So now, let&#39;s iterate all the accounts for that share type,</span>
                                    <span class="comment">// and send a voucher to the owner of each one, to payout his dividend.</span>


                                <span class="comment">// todo: determine whether I need to attach anything here at all...</span>
                                <span class="comment">//</span>
<span class="comment">//                              pResponseItem-&gt;SetAttachment(strVoucher);</span>
                                pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                                bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The paying of the dividends was successful.</span>
                                <span class="comment">//</span>
                                <span class="comment">// --------------------------------------------------------------------------</span>
                                <span class="comment">//</span>
                                <span class="comment">// SAVE THE ACCOUNTS WITH THE NEW BALANCES (FUNDS ARE MOVED)</span>
                                <span class="comment">//</span>
                                <span class="comment">// At this point, we save the accounts, so that the funds transfer is solid before</span>
                                <span class="comment">// we start mailing vouchers out to people.</span>

                                <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                                <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                                theSourceAccount.   ReleaseSignatures();
                                theSourceAccount.   SignContract(m_nymServer);  <span class="comment">// Sign</span>
                                theSourceAccount.   SaveContract();             <span class="comment">// Save</span>
                                theSourceAccount.   SaveAccount();              <span class="comment">// Save to file</span>

                                <span class="comment">// We also need to save the Voucher cash reserve account.</span>
                                <span class="comment">// (Any issued voucher cheque is automatically backed by this reserve account.</span>
                                <span class="comment">// If a cheque is deposited, the funds come back out of this account. If the</span>
                                <span class="comment">// cheque expires, then after the expiry period, if it remains in the account,</span>
                                <span class="comment">// it is now the property of the transaction server.)</span>
                                pVoucherReserveAcct-&gt;ReleaseSignatures();
                                pVoucherReserveAcct-&gt;SignContract(m_nymServer);
                                pVoucherReserveAcct-&gt;SaveContract();
                                pVoucherReserveAcct-&gt;SaveAccount();

                                <span class="comment">// --------------------------------------------------------------------------</span>
                                <span class="comment">//</span>
                                <span class="comment">// PAY THE SHAREHOLDERS</span>
                                <span class="comment">//</span>
                                <span class="comment">// Here&#39;s where we actually loop through the asset accounts for the share type,</span>
                                <span class="comment">// and send a voucher to the owner of each one.</span>
                                <span class="comment">//</span>
                                <span class="comment">// This way, the actionPayDividend won&#39;t possibly load these accounts twice.</span>
                                <span class="comment">// We make them available here this way.</span>
                                <span class="comment">//</span>
                                <a class="code" href="_o_t_agent_8hpp.html#abd4942716d546c8d42670619a03ef99e">mapOfAccounts</a>       theAccounts;
                                theAccounts.insert( std::pair&lt;std::string, OTAccount *&gt;(strAccountID.Get(),        &amp;theSourceAccount));
                                theAccounts.insert( std::pair&lt;std::string, OTAccount *&gt;(strSharesIssuerAcct.Get(), pSharesIssuerAccount));
                                theAccounts.insert( std::pair&lt;std::string, OTAccount *&gt;(strVoucherAcctID.Get(),    &amp;theVoucherReserveAcct));

                                <a class="code" href="class_o_t_acct_functor___pay_dividend.html">OTAcctFunctor_PayDividend</a>  actionPayDividend(SERVER_ID,
                                                                             USER_ID,
                                                                             PAYOUT_ASSET_ID,
                                                                             VOUCHER_ACCOUNT_ID,
                                                                             strInReferenceTo, <span class="comment">// Memo for each voucher (containing original payout request pItem)</span>
                                                                             *<span class="keyword">this</span>,
                                                                             lAmountPerShare,
                                                                             &amp;theAccounts);

                                <span class="comment">// Loops through all the accounts for a given asset type (PAYOUT_ASSET_ID), and triggers</span>
                                <span class="comment">// actionPayDividend for each one. This sends the owner nym for each, a voucher drawn on</span>
                                <span class="comment">// VOUCHER_ACCOUNT_ID. (In the amount of lAmountPerShare * number of shares in account.)</span>
                                <span class="comment">//</span>
                                <span class="keyword">const</span> <span class="keywordtype">bool</span> bForEachAcct = pSharesContract-&gt;<a class="code" href="class_o_t_asset_contract.html#a1872fcbbefee5f891f3252126c933e8a">ForEachAccountRecord</a>(actionPayDividend);   <span class="comment">// &lt;================== pay all the dividends here.</span>
                                <span class="comment">// ----------------------------------------------------------------------------</span>

                                <span class="comment">// TODO: Since the above line of code loops through all the accounts and loads them</span>
                                <span class="comment">// up, transforms them, and saves them again, we cannot use our own loaded accounts below</span>
                                <span class="comment">// this point. (They could overwrite themselves.) theSourceAccount especially, was passed in</span>
                                <span class="comment">// from above -- so how can we possible warn the caller than he cannot save this account without</span>
                                <span class="comment">// overwriting work we have done in this function?</span>
                                <span class="comment">//</span>
                                <span class="comment">// Aside from any more elegant solution, the only way to make it work in this case would be to</span>
                                <span class="comment">// make a map or list of all the accounts that are already loaded in memory (such as theSourceAccount)</span>
                                <span class="comment">// and PASS THEM IN to the above ForEachAccountRecord call. This way it would have the option to use</span>
                                <span class="comment">// the &quot;already loaded&quot; versions, where appropriate, instead of loading them twice. (As it is,</span>
                                <span class="comment">// theSourceAccount is not used below this point, though we couldn&#39;t preven the caller from using it.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// Therefore we need to have some central system where accounts can be loaded, locked, saved, etc.</span>
                                <span class="comment">// So we cannot ever overwrite ourselves BY DESIGN. (And the same for other data types as well, like Nyms.)</span>
                                <span class="comment">// Todo.</span>
                                <span class="comment">//</span>
                                <span class="comment">// ----------------------------------------------------------------------------</span>
                                <span class="keywordflow">if</span> (!bForEachAcct) <span class="comment">// todo failsafe. Handle this better.</span>
                                {
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: After moving funds for dividend payment, there was some &quot;</span>
                                                  <span class="stringliteral">&quot;error when sending out the vouchers to the payout recipients.\n&quot;</span>, szFunc);
                                }
                                <span class="comment">// ---------------------------------------------------------------------------</span>
                                <span class="comment">//</span>
                                <span class="comment">// REFUND ANY LEFTOVERS</span>
                                <span class="comment">//</span>
                                <span class="keyword">const</span> int64_t lLeftovers = lTotalCostOfDividend - (actionPayDividend.GetAmountPaidOut() +
                                                                                actionPayDividend.GetAmountReturned());
                                <span class="keywordflow">if</span> (lLeftovers &gt; 0)
                                {
                                    <span class="comment">// Of the total amount removed from the sender&#39;s account, and after paying all dividends,</span>
                                    <span class="comment">// there was a leftover amount that wasn&#39;t paid to anybody. Therefore, we should pay it back</span>
                                    <span class="comment">// to the sender himself, now.</span>
                                    <span class="comment">//</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: After dividend payout, with %ld units removed initially, &quot;</span>
                                                   <span class="stringliteral">&quot;there were %ld units remaining. (Returning them to sender...)\n&quot;</span>,
                                                   szFunc, lTotalCostOfDividend, lLeftovers);
                                    <span class="comment">// ------------------------------------------</span>
                                    <a class="code" href="class_o_t_cheque.html">OTCheque</a>  theVoucher(SERVER_ID, PAYOUT_ASSET_ID);

                                    <span class="comment">// 10 minutes ==    600 Seconds</span>
                                    <span class="comment">// 1 hour   ==     3600 Seconds</span>
                                    <span class="comment">// 1 day    ==    86400 Seconds</span>
                                    <span class="comment">// 30 days  ==  2592000 Seconds</span>
                                    <span class="comment">// 3 months ==  7776000 Seconds</span>
                                    <span class="comment">// 6 months == 15552000 Seconds</span>

                                    <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>();            <span class="comment">// This time is set to TODAY NOW</span>
                                    <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>)); <span class="comment">// This time occurs in 180 days (6 months).  Todo hardcoding.</span>

                                    int64_t        lNewTransactionNumber = 0;
                                    <span class="keyword">const</span> <span class="keywordtype">bool</span>  bGotNextTransNum =
                                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber);     <span class="comment">// bStoreTheNumber defaults to true. We save the transaction</span>
                                                                                                        <span class="comment">// number on the server Nym (normally we&#39;d discard it) because</span>
                                                                                                        <span class="comment">// when the cheque is deposited, the server nym, as the owner of</span>
                                                                                                        <span class="comment">// the voucher account, needs to verify the transaction # on the</span>
                                                                                                        <span class="comment">// cheque (to prevent double-spending of cheques.)</span>
                                    <span class="comment">// ----------------------------------------------------------------------------------------------</span>
                                    <span class="keywordflow">if</span> (bGotNextTransNum)
                                    {
                                        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_NYM_ID(m_nymServer);
                                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bIssueVoucher = theVoucher.IssueCheque(lLeftovers,               <span class="comment">// The amount of the cheque.</span>
                                                                                          lNewTransactionNumber,    <span class="comment">// Requiring a transaction number prevents double-spending of cheques.</span>
                                                                                          VALID_FROM,               <span class="comment">// The expiration date (valid from/to dates) of the cheque</span>
                                                                                          VALID_TO,                 <span class="comment">// Vouchers are automatically starting today and lasting 6 months.</span>
                                                                                          VOUCHER_ACCOUNT_ID,       <span class="comment">// The asset account the cheque is drawn on.</span>
                                                                                          SERVER_NYM_ID,            <span class="comment">// User ID of the sender (in this case the server nym.)</span>
                                                                                          strInReferenceTo,         <span class="comment">// Optional memo field. Includes item note and request memo.</span>
                                                                                          &amp;USER_ID);

                                        <span class="comment">// All account crediting / debiting happens in the caller, in OTServer.</span>
                                        <span class="comment">//    (AND it happens only ONCE, to cover ALL vouchers.)</span>
                                        <span class="comment">// Then in here, the voucher either gets send to the recipient, or if error, sent back home to</span>
                                        <span class="comment">// the issuer Nym. (ALL the funds are removed, then the vouchers are sent one way or the other.)</span>
                                        <span class="comment">// Any returned vouchers, obviously serve to notify the dividend payer of where the errors were</span>
                                        <span class="comment">// (as well as give him the opportunity to get his money back.)</span>
                                        <span class="comment">//</span>
                                        <span class="keywordtype">bool</span> bSent = <span class="keyword">false</span>;
                                        <span class="keywordflow">if</span> (bIssueVoucher)
                                        {
                                            theVoucher.SetAsVoucher(SERVER_NYM_ID, VOUCHER_ACCOUNT_ID); <span class="comment">// All this does is set the voucher&#39;s internal contract string</span>
                                            theVoucher.SignContract(m_nymServer);                       <span class="comment">// to &quot;VOUCHER&quot; instead of &quot;CHEQUE&quot;.</span>
                                            theVoucher.SaveContract();

                                            <span class="comment">// Send the voucher to the payments inbox of the recipient.</span>
                                            <span class="comment">//</span>
                                            <span class="keyword">const</span>
                                            <a class="code" href="class_o_t_string.html">OTString</a>  strVoucher(theVoucher);
                                            <a class="code" href="class_o_t_payment.html">OTPayment</a> thePayment(strVoucher);

                                            <span class="comment">// calls DropMessageToNymbox</span>
                                            bSent = this-&gt;<a class="code" href="class_o_t_server.html#ab500513963b83465cf5402d7b9809870">SendInstrumentToNym</a>(SERVER_ID,
                                                                              SERVER_NYM_ID,  <span class="comment">// sender nym</span>
                                                                              USER_ID,        <span class="comment">// recipient nym (returning to original sender.)</span>
                                                                              NULL, &amp;thePayment, <span class="stringliteral">&quot;payDividend&quot;</span>); <span class="comment">// todo: hardcoding.</span>
                                        }
                                        <span class="comment">// --------------------------------------------------------------------------</span>
                                        <span class="comment">// If we didn&#39;t send it, then we need to return the funds to where they came from.</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (!bSent)
                                        {
                                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPayoutAssetID(PAYOUT_ASSET_ID), strSenderUserID(USER_ID);
                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR failed issuing voucher (to return leftovers back to &quot;</span>
                                                          <span class="stringliteral">&quot;the dividend payout initiator.) WAS TRYING TO PAY %ld of asset type %s to Nym %s.\n&quot;</span>,
                                                          szFunc, lLeftovers, strPayoutAssetID.Get(), strSenderUserID.Get());
                                        } <span class="comment">// if !bSent</span>
                                    }
                                    <span class="keywordflow">else</span> <span class="comment">// !bGotNextTransNum</span>
                                    {
                                        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPayoutAssetID(PAYOUT_ASSET_ID), strRecipientUserID(USER_ID);
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR!! Failed issuing next transaction &quot;</span>
                                                      <span class="stringliteral">&quot;number while trying to send a voucher (while returning leftover funds, after paying dividends.) &quot;</span>
                                                      <span class="stringliteral">&quot;WAS TRYING TO PAY %ld of asset type %s to Nym %s.\n&quot;</span>, szFunc,
                                                      lLeftovers, strPayoutAssetID.Get(), strRecipientUserID.Get());
                                    }
                                }
                            } <span class="comment">// else</span>
                            <span class="comment">// --------------------------------------------------------------------------</span>
                        }
                        <span class="comment">//else{} // TODO log that there was a problem with the amount</span>

                    } <span class="comment">// voucher request loaded successfully from string</span>
                } <span class="comment">// GetVoucherAccount()</span>
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: GetVoucherAccount() failed. Asset Type:\n%s\n&quot;</span>, szFunc,
                                  strAssetTypeID.Get());
                }
            }
        } <span class="comment">// (else bLoadContract is true)</span>
    }
    <span class="comment">// --------------------------------------------------------------------------------------</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expected OTItem::payDividend in trans# %ld: \n\n%s\n\n&quot;</span>, szFunc,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// --------------------------------------------------------------------------------------</span>
    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa5fbf4c29c1e9428924a7278f2f3cff0"></a><!-- doxytag: member="OTServer::NotarizePaymentPlan" ref="aa5fbf4c29c1e9428924a7278f2f3cff0" args="(OTPseudonym &amp;theNym, OTAccount &amp;theDepositorAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aa5fbf4c29c1e9428924a7278f2f3cff0">OTServer::NotarizePaymentPlan</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theDepositorAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>1) The Merchant generates the payment plan, adds transaction numbers, and signs. (All done via ProposePaymentPlan) 2) Then the Customer uses ConfirmPaymentPlan to add his own numbers and sign. 3) Then the Customer must activate the payment plan. (Using a transaction with the same number as the plan.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l07101">7101</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atPaymentPlan&quot;, that is, &quot;a reply to the paymentPlan request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will definitely be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),       DEPOSITOR_USER_ID(theNym),
                        SERVER_USER_ID(m_nymServer),    DEPOSITOR_ACCT_ID(theDepositorAccount), USER_ID(theNym);

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
    <span class="comment">// --------------------------------------------------------------------</span>
    pItem           = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);
    pBalanceItem    = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
    <span class="comment">// --------------------------------------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afbc3c7556a790e7a7b6be464f8ea058b">OTItem::atPaymentPlan</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
        (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_payment_plan)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction (All payment plans are disallowed in server.cfg)\n&quot;</span>,
                       __FUNCTION__, strUserID.Get());
    }
    <span class="comment">// For now, there should only be one of these paymentPlan items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pItem) || (NULL == pBalanceItem))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error, expected OTItem::paymentPlan and OTItem::transactionStatement.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span>
    {
        <span class="keywordflow">if</span> (DEPOSITOR_ACCT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Source account ID on the transaction does not match sender&#39;s account ID on the transaction item.\n&quot;</span>,
                           __FUNCTION__);
        }
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7df2f7973839d7a270f6ea8de67d07b4">VerifyTransactionStatement</a>(theNym, tranIn)) <span class="comment">// bIsRealTransaction=true</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying transaction statement.\n&quot;</span>, __FUNCTION__);
        }
        <span class="keywordflow">else</span>
        {
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

            <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
            <span class="comment">// here so it can be saved into the &quot;in reference to&quot; field.</span>
            pItem       -&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
            pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

            <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
            <span class="comment">// They&#39;re getting SOME sort of response item.</span>

            pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
            pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

            <span class="comment">// Also load up the Payment Plan from inside the transaction item.</span>
            <a class="code" href="class_o_t_string.html">OTString</a>    strPaymentPlan;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPaymentPlan);
            <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> * pPlan = <span class="keyword">new</span> <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>();
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPlan);

            <span class="comment">// If we failed to load the plan...</span>
            <span class="keywordflow">if</span> ((<span class="keyword">false</span> == pPlan-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPaymentPlan)))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading payment plan from string:\n%s\n&quot;</span>, __FUNCTION__,
                              strPaymentPlan.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
<span class="comment">//          else if (!pPlan-&gt;VerifySignature(theNym))  // This is now done below, in VerifyAgreement()!</span>
<span class="comment">//          {</span>
<span class="comment">//              OTLog::vOutput(0, &quot;ERROR verifying sender signature on Payment Plan.\n&quot;, __FUNCTION__);</span>
<span class="comment">//          }</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPlan-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad server ID on payment plan.\n&quot;</span>, __FUNCTION__);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPlan-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>() != theDepositorAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID1(pPlan-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()), strAssetID2(theDepositorAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong Asset Type ID (%s) on payment plan. Expected: %s\n&quot;</span>, __FUNCTION__,
                               strAssetID1.Get(), strAssetID2.Get());
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// CANCELLING? OR ACTIVATING?</span>
                <span class="comment">// If he is cancelling the payment plan (from his outpayments box, before it&#39;s even had a chance</span>
                <span class="comment">// to be activated by the sender) then the recipient (merchant) will be the depositor. Otherwise,</span>
                <span class="comment">// if he is activating the payment plan (from his payments inbox) then the sender (customer) will</span>
                <span class="comment">// be the depositor.</span>

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theCancelerNymID;
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bCancelling  = (pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>() &amp;&amp; pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#ac9031aa34854265423155e448be01120">GetCancelerID</a>(theCancelerNymID));
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keyword">const</span> int64_t lExpectedNum = bCancelling ? 0 : pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
                <span class="keyword">const</span> int64_t lFoundNum    = pPlan-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>();
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; FOUND_USER_ID = bCancelling ? pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>() : pPlan-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>();
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; FOUND_ACCT_ID = bCancelling ? pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a66300d99a12d32b6825e7e11dfca8614">GetRecipientAcctID</a>() : pPlan-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keyword">const</span> int64_t lFoundOpeningNum = pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a809937fd06b26ff5791094592be68b0d">GetOpeningNumber</a>(FOUND_USER_ID);
                <span class="keyword">const</span> int64_t lFoundClosingNum = pPlan-&gt;<a class="code" href="class_o_t_agreement.html#ab9ff6bc2d5f152a9e3f2203a067af40b">GetClosingNumber</a>(FOUND_ACCT_ID);
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keywordflow">if</span> (lFoundNum != lExpectedNum)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad main transaction number while %s payment plan (%ld). Expected based on transaction: %ld\n&quot;</span>,
                                   __FUNCTION__, bCancelling ? <span class="stringliteral">&quot;cancelling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>, lFoundNum, lExpectedNum);
                }
                <span class="keywordflow">if</span> (lFoundOpeningNum != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>())
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad transaction number while %s payment plan (%ld). Expected based on transaction: %ld\n&quot;</span>,
                                   __FUNCTION__, bCancelling ? <span class="stringliteral">&quot;cancelling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>, lFoundOpeningNum, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FOUND_USER_ID != DEPOSITOR_USER_ID)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDExpected(FOUND_USER_ID), strIDDepositor(DEPOSITOR_USER_ID);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong user ID while %s payment plan. Depositor: %s  Found on plan: %s\n&quot;</span>,
                                   __FUNCTION__, bCancelling ? <span class="stringliteral">&quot;cancelling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>, strIDDepositor.Get(), strIDExpected.Get());
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCancelling &amp;&amp; (DEPOSITOR_USER_ID != theCancelerNymID))
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDExpected(DEPOSITOR_USER_ID), strIDDepositor(theCancelerNymID);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong canceler Nym ID while canceling payment plan. Depositor: %s  Canceler: %s\n&quot;</span>,
                                   __FUNCTION__, strIDExpected.Get(), strIDDepositor.Get());
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FOUND_ACCT_ID != DEPOSITOR_ACCT_ID)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID1(FOUND_ACCT_ID), strAcctID2(DEPOSITOR_ACCT_ID);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong Acct ID (%s) while %s payment plan. Expected: %s\n&quot;</span>,
                                   __FUNCTION__, strAcctID1.Get(), bCancelling ? <span class="stringliteral">&quot;cancelling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>, strAcctID2.Get());
                }
                <span class="comment">// If we&#39;re activating the plan (versus cancelling) then the transaction number opens</span>
                <span class="comment">// the payment plan, but there must also be a closing number for closing it.</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bCancelling &amp;&amp; <span class="comment">// If activating and:</span>
                         ((pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#a96d3ae7898526a317dd503daecbf10af">GetCountClosingNumbers</a>() &lt; 1) || <span class="comment">// ...if there aren&#39;t enough closing numbers...</span>
                          !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, lFoundClosingNum))) <span class="comment">// ...or the official closing # isn&#39;t available for use on theNym.</span>
                { <span class="comment">// We don&#39;t check opening number here, since NotarizeTransaction already did.</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR: the Closing number %ld wasn&#39;t available for use while activating a payment plan.\n&quot;</span>,
                                   __FUNCTION__, lFoundClosingNum);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bCancelling &amp;&amp; <span class="comment">// If cancelling and:</span>
                          ( (pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a8e9c210a43af7950d610868900141b35">GetRecipientCountClosingNumbers</a>() &lt; 2) ||
                            !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, lFoundClosingNum)
                          )
                        )
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR: the Closing number wasn&#39;t available for use while cancelling a payment plan.\n&quot;</span>, __FUNCTION__);
                }
                <span class="keywordflow">else</span>  <span class="comment">// The plan is good (so far.)</span>
                {
                    <span class="comment">// The RECIPIENT_ACCT_ID is the ID on the &quot;To&quot; Account. (When doing a transfer, normally 2nd acct is the Payee.)</span>
                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  RECIPIENT_ACCT_ID(pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a66300d99a12d32b6825e7e11dfca8614">GetRecipientAcctID</a>()),
                                        RECIPIENT_USER_ID(pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>());

                    <span class="keywordtype">bool</span> bRecipientNymIsServerNym = ((RECIPIENT_USER_ID == SERVER_USER_ID)    ? <span class="keyword">true</span> : <span class="keyword">false</span>);
                    <span class="keywordtype">bool</span> bUsersAreSameNym         = ((DEPOSITOR_USER_ID == RECIPIENT_USER_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);

                    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     theRecipientNym;        <span class="comment">// We&#39;ll probably use this, but maybe not. So I use a pointer that will maybe point here.</span>
                    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pRecipientNym   = NULL; <span class="comment">// Here&#39;s the pointer.  (Logic explained directly below.)</span>
                    <span class="comment">// ------------------------------------------------------------------------</span>
                    <span class="comment">// Set pRecipientNym to point to the right one so we can use it below. (Do NOT use theRecipientNym,</span>
                    <span class="comment">// since it won&#39;t always point to that one.)</span>

                    <span class="keywordtype">bool</span> bFoundRecipientNym = <span class="keyword">false</span>;

                    <span class="comment">// Find out if Recipient Nym is also the Server Nym...</span>
                    <span class="keywordflow">if</span> (bRecipientNymIsServerNym)
                    {
                        <span class="comment">// If the Recipient Nym is the server, then just point to that.</span>
                        pRecipientNym       = &amp;m_nymServer;
                        bFoundRecipientNym  = <span class="keyword">true</span>;

                        <span class="comment">// (No need to verify Nym here since already done in this case.)</span>
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bUsersAreSameNym)  <span class="comment">// Else if the participants are the same Nym, point to the one we already loaded.</span>
                    {
                        pRecipientNym       = &amp;theNym;
                        bFoundRecipientNym  = <span class="keyword">true</span>;

                        <span class="comment">// (No need to verify Nym here since already done in this case, before we even got here.)</span>
                    }
                    <span class="keywordflow">else</span>    <span class="comment">// Otherwise load the Recipient Nym from Disk and point to that.</span>
                    {
                        theRecipientNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(RECIPIENT_USER_ID);

                        <span class="keywordtype">bool</span> bLoadedNym = theRecipientNym.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>();    <span class="comment">// Old style (deprecated.) NOTE: LoadCredentials is already called inside LoadPublicKey, at the top, but eventually we&#39;ll be calling it here directly, once LoadPublicKey is removed.</span>

                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedNym)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(RECIPIENT_USER_ID);
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading Recipient Nym public key: %s\n&quot;</span>, __FUNCTION__,
                                          strNymID.Get());
                            bFoundRecipientNym = <span class="keyword">false</span>;
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theRecipientNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>() || !theRecipientNym.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(m_nymServer))
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(RECIPIENT_USER_ID);
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading or verifying Recipient Nym public key: %s\n&quot;</span>, __FUNCTION__,
                                          strNymID.Get());
                            bFoundRecipientNym = <span class="keyword">false</span>;
                        }
                        <span class="keywordflow">else</span>
                        {
                            pRecipientNym = &amp;theRecipientNym; <span class="comment">//  &lt;=====</span>
                            bFoundRecipientNym = <span class="keyword">true</span>;
                        }
                    }
                    <span class="comment">// Below this point, ALWAYS use pRecipientNym, NOT theRecipientNym.</span>
                    <span class="comment">// pRecipientNym is always guaranteed below here to point to the right one.</span>
                    <span class="comment">// ------------------------------------------------------------------------</span>
                    <span class="keywordflow">if</span> (!bFoundRecipientNym || (NULL == pRecipientNym))
                    {
                        <span class="comment">// (No need to log here; already logged right above.)</span>
                        <span class="comment">// OTLog::vOutput(&quot;Unable to load or verify Recipient Nym.()&quot;, __FUNCTION__);</span>
                    }

                    <span class="comment">// Below this point, we know for sure that the Recipient Nym is loaded and verified, and we know</span>
                    <span class="comment">// that if the Server or Sender is actually the Recipient, that the pRecipientNym pointer will</span>
                    <span class="comment">// always point to the right one, and no files can be overwritten. *phew*</span>


                    <span class="comment">// You CAN have both accounts owned by the same Nym, but you CANNOT have them both actually be the SAME ACCT.</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bCancelling &amp;&amp; (DEPOSITOR_ACCT_ID == RECIPIENT_ACCT_ID))  <span class="comment">// ACTIVATING</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Source account ID matches Recipient account ID &quot;</span>
                                       <span class="stringliteral">&quot;on attempted Payment Plan notarization.\n&quot;</span>, __FUNCTION__);
                    }
                    <span class="comment">// Unless you are cancelling...</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCancelling &amp;&amp; (DEPOSITOR_ACCT_ID != RECIPIENT_ACCT_ID))   <span class="comment">// CANCELLING</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Source account ID doesn&#39;t match Recipient account ID &quot;</span>
                                       <span class="stringliteral">&quot;on attempted Payment Plan cancellation.\n&quot;</span>, __FUNCTION__);
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bCancelling &amp;&amp; !pPlan-&gt;<a class="code" href="class_o_t_payment_plan.html#a774efdf388acb0982bbdd9dd1c4b732d">VerifyAgreement</a>(*pRecipientNym, theNym)) <span class="comment">// ACTIVATING</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying Sender and Recipient on Payment Plan &quot;</span>
                                       <span class="stringliteral">&quot;(against merchant and customer copies.)\n&quot;</span>, __FUNCTION__);
                    }
                    <span class="comment">// This is now done above, in VerifyAgreement().</span>
                    <span class="comment">// We only have it here now in cases of cancellation (where VerifyAgreement isn&#39;t called.)</span>
                    <span class="comment">//                                                                        // CANCELING</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCancelling &amp;&amp; !pPlan-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pRecipientNym))
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying Recipient&#39;s signature on Payment Plan.\n&quot;</span>);
                    }
                    <span class="keywordflow">else</span> <span class="comment">// -----------------------------------------------------------------</span>
                    {
                        <span class="comment">// Verify that BOTH of the Recipient&#39;s transaction numbers</span>
                        <span class="comment">// (opening and closing) are available for use.</span>
                        <span class="comment">//</span>
                        <span class="comment">// These three blocks are only checked if we are activating, not cancelling.</span>
                        <span class="comment">// Why? Because if we&#39;re canceling, then we ALREADY checked these things above.</span>
                        <span class="comment">// But if we&#39;re activating, that means we checked the sender above only, and</span>
                        <span class="comment">// thus we still need to check the recipient.</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (!bCancelling &amp;&amp; pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a8e9c210a43af7950d610868900141b35">GetRecipientCountClosingNumbers</a>() &lt; 2)
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying Recipient&#39;s Opening and Closing number on a Payment Plan &quot;</span>
                                           <span class="stringliteral">&quot;(he should have two numbers, but he doesn&#39;t.)\n&quot;</span>, __FUNCTION__);
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bCancelling &amp;&amp; !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(*pRecipientNym, pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a3602a1424347da4b23e06b65005148f9">GetRecipientOpeningNum</a>()))
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying Recipient&#39;s opening transaction number on a payment plan.\n&quot;</span>,
                                           __FUNCTION__);
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bCancelling &amp;&amp; !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(*pRecipientNym, pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a5cbac600e627010f50e876e3250530ec">GetRecipientClosingNum</a>()))
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying Recipient&#39;s Closing transaction number on a Payment Plan.\n&quot;</span>,
                                           __FUNCTION__);
                        }
                        <span class="comment">// -----------------------------------------------------------------</span>
                        <span class="keywordflow">else</span>
                        {
                            <span class="comment">// Load up the recipient ACCOUNT and validate it.</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_account.html">OTAccount</a> * pRecipientAcct = NULL;
                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theRecipientAcctGuardian;
                            <span class="comment">// -------------------------------------------</span>
                            <span class="keywordflow">if</span> (!bCancelling) <span class="comment">// ACTIVATING</span>
                            {
                                pRecipientAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(RECIPIENT_ACCT_ID, SERVER_ID);
                                theRecipientAcctGuardian.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pRecipientAcct); <span class="comment">// This will cleanup pRecipAcct, or do nothing if it&#39;s NULL.</span>
                            }
                            <span class="keywordflow">else</span>              <span class="comment">// CANCELLING</span>
                            {
                                pRecipientAcct = &amp;theDepositorAccount;
                            }
                            <span class="comment">// --------------------------------------------------------</span>
                            <span class="comment">//</span>
                            <span class="comment">// --------------------------------------------------------</span>
                            <span class="keywordflow">if</span> (NULL == pRecipientAcct)
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR loading Recipient account.\n&quot;</span>, __FUNCTION__);
                            }
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pRecipientNym))
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying ownership of the recipient account.\n&quot;</span>, __FUNCTION__);
                            }
                            <span class="comment">// ----------------------------------------------------------------------------</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a9a3c4e0a90a5f0f837c7f4acda8d4a10">IsInternalServerAcct</a>())
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed: recipient account is an internal &quot;</span>
                                               <span class="stringliteral">&quot;server account (currently prohibited.)\n&quot;</span>, __FUNCTION__);
                            }
                            <span class="comment">// ----------------------------------------------------------------------------</span>
                            <span class="comment">// Are both of the accounts of the same Asset Type? VERY IMPORTANT!!</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() != theDepositorAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
                            {
                                <a class="code" href="class_o_t_string.html">OTString</a>    strSourceAssetID(theDepositorAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()),
                                            strRecipAssetID(pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR - user attempted to %s a payment plan between dissimilar &quot;</span>
                                               <span class="stringliteral">&quot;asset types:\n%s\n%s\n&quot;</span>, __FUNCTION__, bCancelling ? <span class="stringliteral">&quot;cancel&quot;</span> : <span class="stringliteral">&quot;activate&quot;</span>,
                                               strSourceAssetID.Get(),
                                               strRecipAssetID.Get());
                            }
                            <span class="comment">// Does it verify?</span>
                            <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pRecipientAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying signature on the Recipient account.\n&quot;</span>, __FUNCTION__);
                            }
                            <span class="comment">// This one is superfluous, but I&#39;m leaving it. (pPlan and pRecip are both already</span>
                            <span class="comment">// matches to a 3rd value: source acct asset type ID.)</span>
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() != pPlan-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>())
                            {
                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID1(pPlan-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()), strAssetID2(pRecipientAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong Asset Type ID (%s) on Recipient Acct. Expected per Plan: %s\n&quot;</span>,
                                               __FUNCTION__, strAssetID2.Get(), strAssetID1.Get());
                            }
                            <span class="comment">// --------------------------------------------------------</span>
                            <span class="comment">// At this point I feel pretty confident that the Payment Plan is a valid request from both parties.</span>
                            <span class="comment">// I have both users AND both accounts and validated against the Payment Plan, signatures and all.</span>
                            <span class="comment">// The only other possibility is that the merchant is canceling the payment plan before the customer</span>
                            <span class="comment">// had a chance to confirm/activate it.</span>
                            <span class="keywordflow">else</span>
                            {
<span class="comment">//                                theInboxAngel.SetCleanupTarget(*pInbox);</span>
                                <span class="comment">// -----------------------------------------------------</span>
                                <span class="comment">// If activating, add it to Cron...</span>
                                <span class="comment">//</span>
                                <span class="comment">// We add the payment plan to the server&#39;s Cron object, which does regular processing.</span>
                                <span class="comment">// That object will take care of processing the payment plan according to its terms.</span>
                                <span class="comment">//</span>
                                <span class="comment">// NOTE: FYI, inside AddCronItem, since this is a new CronItem, a Cron Receipt will</span>
                                <span class="comment">// be saved with the User&#39;s signature on it, containing the Cron Item from the user&#39;s</span>
                                <span class="comment">// original request. After that, the item is stored internally to Cron itself, and</span>
                                <span class="comment">// signed by the server--and changes over time as cron processes. (The original receipt</span>
                                <span class="comment">// can always be loaded when necessary.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (!bCancelling &amp;&amp; m_Cron.<a class="code" href="class_o_t_cron.html#a2d42c183c174f56a7c7c3da1e844a53f">AddCronItem</a>(*pPlan, &amp;theNym, <span class="keyword">true</span>, <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>())) <span class="comment">// bSaveReceipt=true</span>
                                {
                                    <span class="comment">//todo need to be able to &quot;roll back&quot; if anything inside this block fails.</span>

                                    <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                                    bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The payment plan activation was successful.</span>

                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Successfully added payment plan to Cron object.\n&quot;</span>, __FUNCTION__);

                                    <span class="comment">// ***************************************************************</span>

                                    <span class="comment">// Server side, the Nym stores a list of all open cron item numbers.</span>
                                    <span class="comment">// (So we know if there is still stuff open on Cron for that Nym, and we know what it is.)</span>
                                    <span class="comment">//</span>
                                    std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
                                    theIDSet.insert(pPlan-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                                    theIDSet.insert(pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#afdbeda9f62eb4d4288d6d06ac78fcdef">GetClosingNum</a>());
<span class="comment">//                                  theNym.SaveSignedNymfile(m_nymServer); // saved below</span>

                                    <span class="comment">// This just marks the Closing number so I can&#39;t USE it again. (Since I&#39;m using it as the closing</span>
                                    <span class="comment">// number for this cron item now.) I&#39;m still RESPONSIBLE for the number until RemoveIssuedNumber()</span>
                                    <span class="comment">// is called. If we didn&#39;t call this here, then I could come back later and USE THE NUMBER AGAIN!</span>
                                    <span class="comment">// (Bad!)</span>
                                    <span class="comment">// -------------------------------------</span>
                                    <span class="comment">// RemoveTransactionNumber was already called for tranIn-&gt;GetTransactionNum()</span>
                                    <span class="comment">// (That&#39;s the opening number.)</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// Here&#39;s the closing number:</span>
                                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#afdbeda9f62eb4d4288d6d06ac78fcdef">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                                    <span class="comment">// -------------------------------------</span>
                                    <span class="comment">// RemoveIssuedNum will be called for that original transaction number when the finalReceipt is created.</span>
                                    <span class="comment">// RemoveIssuedNum will be called for the Closing number when the finalReceipt is accepted.</span>

                                    <span class="comment">// ***************************************************************</span>

                                    std::set&lt;int64_t&gt; &amp; theIDSet2 = pRecipientNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
                                    theIDSet2.insert(pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a3602a1424347da4b23e06b65005148f9">GetRecipientOpeningNum</a>());
                                    theIDSet2.insert(pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a5cbac600e627010f50e876e3250530ec">GetRecipientClosingNum</a>());
<span class="comment">//                                  pRecipientNym-&gt;SaveSignedNymfile(m_nymServer); // saved below</span>

                                    <span class="comment">// For recipient, I also remove the opening and closing numbers as AVAILABLE FOR USE.</span>
                                    <span class="comment">// But they aren&#39;t removed as ISSUED until later...</span>
                                    <span class="comment">// RemoveIssuedNum is called for the Recipient&#39;s opening number onFinalReceipt,</span>
                                    <span class="comment">// and it&#39;s called for the Recipient&#39;s closing number when that final receipt is closed out.</span>
                                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(*pRecipientNym, pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a3602a1424347da4b23e06b65005148f9">GetRecipientOpeningNum</a>(), <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
                                    <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(*pRecipientNym, pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a5cbac600e627010f50e876e3250530ec">GetRecipientClosingNum</a>(), <span class="keyword">true</span>);  <span class="comment">// bSave=true</span>

                                    <span class="comment">// ***************************************************************</span>
                                    <span class="comment">// Send success notice to other parties.</span>
                                    <span class="comment">// (So they can deal with their payments inbox and outpayments box,</span>
                                    <span class="comment">// where pending copies of the instrument may still be waiting.)</span>
                                    <span class="comment">//</span>
                                    int64_t lOtherNewTransNumber = 0;
                                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lOtherNewTransNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a871b6c2a80d4187aac0e4ce520c92bbf">SendNoticeToAllParties</a>(<span class="keyword">true</span>, <span class="comment">//bSuccessMsg=true</span>
                                                                               m_nymServer, SERVER_ID,
                                                                               lOtherNewTransNumber,
    <span class="comment">//                                                                         pPlan-&gt;GetTransactionNum(), // Each party has its own opening number. Handled internally.</span>
                                                                               strPaymentPlan,
                                                                               NULL, NULL, &amp;theNym))
                                    {
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed notifying parties while trying to activate payment plan: %ld.\n&quot;</span>,
                                                       __FUNCTION__, pPlan-&gt;<a class="code" href="class_o_t_cron_item.html#acd198571145b47602c121a419723b39a">GetOpeningNum</a>());
                                    }
                                    <span class="comment">// --------------------------------------</span>
                                } <span class="comment">// if (m_Cron.AddCronItem(*pPlan, &amp;theNym, true, OTTimeGetCurrentTime())) // bSaveReceipt=true</span>
                                <span class="keywordflow">else</span>
                                {
                                    <span class="keywordflow">if</span> (bCancelling)
                                    {
                                        tranOut.<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();

                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Canceling a payment plan before it was ever activated. (At user&#39;s request.)\n&quot;</span>,
                                                       __FUNCTION__);
                                    }
                                    <span class="keywordflow">else</span>
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to add payment plan to Cron. (Failed activating payment plan.)\n&quot;</span>, __FUNCTION__);

                                    <span class="comment">// Send a failure notice to the other parties.</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// DROP REJECTION NOTICE HERE TO ALL PARTIES....</span>
                                    <span class="comment">// SO THEY CAN CLAW BACK THEIR TRANSACTION #s....</span>
                                    <span class="comment">//</span>
                                    int64_t lOtherNewTransNumber = 0;
                                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lOtherNewTransNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a871b6c2a80d4187aac0e4ce520c92bbf">SendNoticeToAllParties</a>(<span class="keyword">false</span>, <span class="comment">//bSuccessMsg=false (OTItem::rejection)</span>
                                                                               m_nymServer, SERVER_ID,
                                                                               lOtherNewTransNumber,
    <span class="comment">//                                                                         pPlan-&gt;GetTransactionNum(), // Each party has its own opening number. Handled internally.</span>
                                                                               strPaymentPlan,
                                                                               NULL, NULL, &amp;theNym))
                                    {
                                        <span class="comment">// NOTE: A party may deliberately try to activate a payment plan without signing it.</span>
                                        <span class="comment">// (As a way of rejecting it.) This will cause rejection notices to go to all the other</span>
                                        <span class="comment">// parties, allowing them to harvest back their closing numbers.</span>
                                        <span class="comment">// Since that is expected to happen, that means if you have 2 parties, and the 2nd one</span>
                                        <span class="comment">// &quot;activates&quot; it (without signing), then this piece of code here will DEFINITELY fail to</span>
                                        <span class="comment">// send the rejection notice to the first party (since the 2nd one hadn&#39;t even signed the</span>
                                        <span class="comment">// thing yet.)</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// (Since we expect that to normally happen, we don&#39;t log an error here.)</span>

    <span class="comment">//                                  OTLog::vOutput(0, &quot;%s: Failed notifying all parties about failed activation of payment plan: %ld.\n&quot;,</span>
    <span class="comment">//                                                 __FUNCTION__, pPlan-&gt;GetTransactionNum());</span>
                                    }
                                } <span class="comment">// Failure adding Cron Item.</span>
                                <span class="comment">// --------------------------------------------------------</span>
                            }
                        }
                    } <span class="comment">// If recipient Nym successfully loaded from storage.</span>
                } <span class="comment">// If Payment Plan successfully loaded from Transaction Item.</span>
            } <span class="comment">// else</span>

            <span class="comment">// If the payment plan WAS successfully added to Cron, then we don&#39;t need to</span>
            <span class="comment">// delete it here, since Cron owns it now, and will deal with cleaning</span>
            <span class="comment">// it up at the right time. (So I can&#39;t use OTCleanup on pPlan.)</span>
            <span class="keywordflow">if</span> ((NULL != pPlan) &amp;&amp; (pResponseItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>() != <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>))
            {
                <span class="keyword">delete</span> pPlan;
                pPlan = NULL;
            }
        } <span class="comment">// if pItem = tranIn.GetItem(OTItem::paymentPlan)</span>
    }

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae8313723858633f63bbdeec9a1d6e1f1"></a><!-- doxytag: member="OTServer::NotarizeProcessInbox" ref="ae8313723858633f63bbdeec9a1d6e1f1" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae8313723858633f63bbdeec9a1d6e1f1">OTServer::NotarizeProcessInbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The client may send multiple transactions in the ledger when he calls processInbox. This function will be called for each of those. Each may contain multiple items accepting or rejecting certain transactions. The server acknowledges and notarizes those transactions accordingly. (And each of those transactions must be accepted or rejected in whole.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l12456">12456</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atProcessInbox&quot;, that is, &quot;a reply to the process inbox request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>);
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),   ACCOUNT_ID(theAccount),
                        USER_ID(theNym);

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);

    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theTempNym, theTempClosingNumNym;
    <span class="comment">// --------------------------------------------------------------</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
    <span class="comment">// --------------------------------------------------------------</span>
    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_process_inbox))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction (All \&quot;process inbox\&quot; &quot;</span>
                       <span class="stringliteral">&quot;transactions are disallowed in server.cfg)\n&quot;</span>, __FUNCTION__, strUserID.Get());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pBalanceItem)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: No Balance Agreement item found on this transaction.\n&quot;</span>,
                       __FUNCTION__);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pInbox)<span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) already verified in OTAccount::LoadInbox()</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying inbox.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)<span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) already verified in OTAccount::LoadOutbox()</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying outbox.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span>
    {
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to tranIn&#39;s balance agreement</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pBalanceItem);

<span class="comment">//        OTString strAccountIDBLAH(ACCOUNT_ID);</span>
<span class="comment">//        OTLog::vError(&quot;OTServer::NotarizeProcessInbox ==========&gt; ENTERING LOOP ------ (Loaded &quot;</span>
<span class="comment">//                      &quot;Inbox for ACCOUNT ID): %s.\n ==========&gt; Inbox Receipt Count: %d \n&quot;,</span>
<span class="comment">//                      strAccountIDBLAH.Get(), pInbox-&gt;GetTransactionCount());</span>

        <span class="comment">// -----------------------------------------------------------</span>
        <span class="comment">// This transaction accepts various incoming pending transfers.</span>
        <span class="comment">// So when it&#39;s all done, my balance will be higher.</span>
        <span class="comment">// AND pending inbox items will be removed from my inbox.</span>
        <span class="comment">//</span>
        <span class="comment">// I would like to not even process the whole giant loop below,</span>
        <span class="comment">// if I can verify here now that the balance agreement is wrong.</span>
        <span class="comment">//</span>
        <span class="comment">// Thus I will actually loop through the acceptPending items in tranIn, and then for each one, I&#39;ll</span>
        <span class="comment">// lookup the ACTUAL transaction in the inbox, and get its ACTUAL value. (And total them all up.)</span>
        <span class="comment">//</span>
        <span class="comment">// The total of those, (WITHOUT the user having to tell me what it will be, since I&#39;m looking them all up),</span>
        <span class="comment">// should equal the difference in the account balance! Meaning the current balance plus that total will be</span>
        <span class="comment">// the expected NEW balance, according to this balance agreement -- if it wants to be approved, that is.</span>
        <span class="comment">//</span>
        <span class="comment">//</span>

        std::list&lt;int64_t&gt; theListOfInboxReceiptsBeingRemoved;
<span class="comment">//      std::set&lt;int64_t&gt;  setOfRefNumsProcessed; // To make sure each inbox item refers to a different number. (If two of them refer to the same number, that&#39;s bad and is not allowed. You can&#39;t process the same inbox item twice simultaneously! Or even at all.)</span>

        <span class="keywordtype">bool</span> bSuccessFindingAllTransactions = <span class="keyword">true</span>;
        int64_t lTotalBeingAccepted = 0;

        <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, tranIn.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>(), it_bigloop)
        {
<span class="comment">//          OTLog::Error(&quot;OTServer::NotarizeProcessInbox: TOP OF LOOP (of the item list on the incoming transaction) \n&quot;);</span>
<span class="comment">//</span>
<span class="comment">//          OTLog::vError(&quot;OTServer::NotarizeProcessInbox ==========&gt; =======&gt; Inbox Receipt Count: %d \n&quot;,</span>
<span class="comment">//                        pInbox-&gt;GetTransactionCount());</span>

            pItem = *it_bigloop;
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Pointer should not have been NULL.&quot;</span>);
            <span class="comment">// -----------------------------------------------------</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;

            <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
            {
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>:
<span class="comment">//                  OTLog::Output(1, &quot;OTServer::NotarizeProcessInbox: (This item is a balance statement... SKIPPING IT.)\n\n&quot;); // temp remove</span>
                    pServerTransaction = NULL;
                    <span class="keywordflow">continue</span>;

                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>:
                    <span class="comment">//---------</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0ae31723e4a6a715f4de40bf18aa932f">OTItem::disputeCronReceipt</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a62442ecb84d96e94176c7f9b533a9061">OTItem::disputeFinalReceipt</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a69a150fe3a7ec3726dc71d183d572a87">OTItem::disputeBasketReceipt</a>:
<span class="comment">//</span>
<span class="comment">//                  OTLog::vOutput(1, &quot;OTServer::NotarizeProcessInbox: Checking server-side inbox for expected CRON receipt: %ld... \n&quot;,</span>
<span class="comment">//                                 pItem-&gt;GetReferenceToNum()); // temp remove</span>
                    <span class="comment">// ---------------------------------------------------------------</span>
                    <span class="comment">// NOTE: Turns out, it&#39;s normal to have multiple receipts in reference to the same thing.</span>
                    <span class="comment">// For example, I might have two transfer receipts that are both in reference to the same notarizeInbox.</span>
<span class="comment">//                    {</span>
<span class="comment">//</span>
<span class="comment">//                        std::set&lt;int64_t&gt;::iterator it_ref = setOfRefNumsProcessed.find(pItem-&gt;GetReferenceToNum()); // It had BETTER not be on this list already!</span>
<span class="comment">//</span>
<span class="comment">//                        if (setOfRefNumsProcessed.end() != it_ref) // It&#39;s already there!! (Bad.)</span>
<span class="comment">//                        {</span>
<span class="comment">//                            OTLog::vError(&quot;%s: 1. Bad input from client: This request already contains an item in reference to receipt %ld, yet here&#39;s &quot;</span>
<span class="comment">//                                          &quot;ANOTHER item in reference to the same number! (Failure.)\n&quot;, __FUNCTION__, pItem-&gt;GetReferenceToNum());</span>
<span class="comment">//                            bSuccessFindingAllTransactions = false;</span>
<span class="comment">//                            break;</span>
<span class="comment">//                        }</span>
<span class="comment">//                        else</span>
<span class="comment">//                            setOfRefNumsProcessed.insert(pItem-&gt;GetReferenceToNum());</span>
<span class="comment">//                    }</span>
                    <span class="comment">// ---------------------------------------------------------------</span>
                    pServerTransaction = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    <span class="keywordflow">break</span>;

                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>:         <span class="comment">// Accept an incoming (pending) transfer.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>:     <span class="comment">// Accept a chequeReceipt, voucherReceipt, or transferReceipt.</span>
                    <span class="comment">//---------</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a873fcfb43e552e1f81d475fb898e9ac8">OTItem::rejectPending</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4eb8608cbf2db1dd590856c3777e70a2">OTItem::disputeItemReceipt</a>:

<span class="comment">//                  OTLog::vOutput(1, &quot;OTServer::NotarizeProcessInbox: Checking server-side inbox for receipt pending (IN REF TO): %ld... \n&quot;,</span>
<span class="comment">//                                 pItem-&gt;GetReferenceToNum()); // temp remove</span>
                    <span class="comment">// ---------------------------------------------------------------</span>
                    <span class="comment">// NOTE: Turns out, it&#39;s normal to have multiple receipts in reference to the same thing.</span>
                    <span class="comment">// For example, I might have two transfer receipts that are both in reference to the same notarizeInbox.</span>
<span class="comment">//                    {</span>
<span class="comment">//</span>
<span class="comment">//                        std::set&lt;int64_t&gt;::iterator it_ref = setOfRefNumsProcessed.find(pItem-&gt;GetReferenceToNum()); // It had BETTER not be on this list already!</span>
<span class="comment">//</span>
<span class="comment">//                        if (setOfRefNumsProcessed.end() != it_ref) // It&#39;s already there!! (Bad.)</span>
<span class="comment">//                        {</span>
<span class="comment">//                            OTLog::vError(&quot;%s: 1. Bad input from client: This request already contains an item in reference to receipt %ld, yet here&#39;s &quot;</span>
<span class="comment">//                                          &quot;ANOTHER item in reference to the same number! (Failure.)\n&quot;, __FUNCTION__, pItem-&gt;GetReferenceToNum());</span>
<span class="comment">//                            bSuccessFindingAllTransactions = false;</span>
<span class="comment">//                            break;</span>
<span class="comment">//                        }</span>
<span class="comment">//                        else</span>
<span class="comment">//                            setOfRefNumsProcessed.insert(pItem-&gt;GetReferenceToNum());</span>
<span class="comment">//                    }</span>
                    <span class="comment">// ---------------------------------------------------------------</span>

                    pServerTransaction = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    <span class="keywordflow">break</span>;

                <span class="keywordflow">default</span>:
                {
                    <a class="code" href="class_o_t_string.html">OTString</a> strItemType;
                    pItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strItemType);
                    int32_t nItemType = pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();

                    pServerTransaction = NULL;
                    bSuccessFindingAllTransactions = <span class="keyword">false</span>;

                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type: %s (%d).\n&quot;</span>, __FUNCTION__,
                                  strItemType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;&quot;</span>, nItemType);
                    <span class="keywordflow">break</span>;
                }
            }
            <span class="comment">// -------------------------------------------------------</span>
            <span class="keywordflow">if</span> (NULL == pServerTransaction)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAccountID(ACCOUNT_ID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find or process inbox transaction being accepted by user: %s for account: %s\n&quot;</span>,
                              __FUNCTION__, strUserID.Get(), strAccountID.Get());
                bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                <span class="keywordflow">break</span>; <span class="comment">// for</span>
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>() != pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>())
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Receipt amounts don&#39;t match: %ld and %ld. Nym: %s\n&quot;</span>, __FUNCTION__,
                              pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(), pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), strUserID.Get());
                bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                <span class="keywordflow">break</span>; <span class="comment">// for</span>
            }

            <span class="comment">// BELOW THIS POINT, WE KNOW THAT pServerTransaction was FOUND (and validated.)</span>
            <span class="comment">// *****************************************************************************</span>

            <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
            {
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>:
                    bSuccessFindingAllTransactions = <span class="keyword">true</span>;
                    <span class="keywordflow">break</span>;
                <span class="comment">// ---------------------------------------------------------------------------</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>:
                    bSuccessFindingAllTransactions = <span class="keyword">true</span>;

                    <span class="comment">// Need to ERROR OUT here, if the number of cron receipts (related to</span>
                    <span class="comment">// this finalReceipt) in the inbox isn&#39;t equal to the number being accepted</span>
                    <span class="comment">// in this processInbox transaction. (You can&#39;t close the final receipt unless</span>
                    <span class="comment">// you close all the others as well.)</span>
                    <span class="comment">//</span>


                    <span class="comment">// IN THIS CASE: If user is accepting a finalReceipt, that means all the OTHER receipts related to it</span>
                    <span class="comment">// (sharing the same &quot;in reference to&quot;) must ALSO be cleared from the inbox along with it! That&#39;s the</span>
                    <span class="comment">// whole point of the finalReceipt -- to make sure all related receipts are cleared, when IT is.</span>
                    <span class="comment">//</span>
                    <span class="comment">// So let&#39;s see if the number of related receipts on this process inbox (tranIn) matches</span>
                    <span class="comment">// the number of related receipts in the actual inbox (pInbox), as found by the finalReceipt&#39;s</span>
                    <span class="comment">// (pServerTransaction) &quot;in reference to&quot; value, which should be the same as on the related receipts.</span>

                    <span class="comment">// (Below) tranIn is the processInbox transaction. Each item on it is &quot;in ref to&quot; a DIFFERENT receipt,</span>
                    <span class="comment">// even though, if they are marketReceipts, all of THOSE receipts are &quot;in ref to&quot; the original transaction#.</span>
                    <span class="comment">// I need to loop through all items on tranIn (processInbox request)</span>
                    <span class="comment">// For each, look it up on the inbox. (Each item will be &quot;in reference to&quot; the original transaction.)</span>
                    <span class="comment">// ONCE THE INBOX RECEIPT IS FOUND, if *IT* is &quot;in reference to&quot; pServerTransaction-&gt;GetReferenceToNum(),</span>
                    <span class="comment">// Then increment the count for the transaction.  COMPARE *THAT* to theInbox.GetCount and we&#39;re golden!!</span>
                {
<span class="comment">//                  int32_t nRefCount = 0; // Using std::set here instead of a simple int32_t. (To prevent duplicates.)</span>
                    std::set&lt;int64_t&gt; setOfRefNumbers; <span class="comment">// we&#39;ll store them here, and disallow duplicates, to make sure they are all unique IDs (no repeats.)</span>

                    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, tranIn.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
                    {
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pItemPointer = *it;
                        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItemPointer, <span class="stringliteral">&quot;Pointer should not have been NULL.&quot;</span>);

                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransPointer = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItemPointer-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                        <span class="keywordflow">if</span> ((NULL != pTransPointer) &amp;&amp;
                            (pTransPointer-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()))
                        {
<span class="comment">//                          nRefCount++;</span>
                            <span class="comment">// std::set doesn&#39;t allow duplicates.</span>
                            setOfRefNumbers.insert(pItemPointer-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                        }
                    } <span class="comment">// for</span>
                    <span class="comment">// -------------------</span>

                    <span class="keywordflow">if</span> ( pInbox-&gt;<a class="code" href="class_o_t_ledger.html#ac72aea8d3eb0d0e8e59a5b7eaa4fda6e">GetTransactionCountInRefTo</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()) !=
                         static_cast&lt;int32_t&gt;(setOfRefNumbers.size()) )
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User tried to close a finalReceipt, &quot;</span>
                                       <span class="stringliteral">&quot;without also closing all related receipts. (Those that share the IN REF TO number.)\n&quot;</span>,
                                       __FUNCTION__);
                        bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>;
                    }
                    <span class="comment">// Upon success, these numbers will be removed from the Nym&#39;s additional record of &quot;cron item IDs&quot;.</span>
                    <span class="comment">//</span>
                    <span class="comment">// -------------------------------------------------------------------</span>

                    <span class="comment">// Server side stores a list of open cron items on each Nym.</span>
                    <span class="comment">// The closing transaction number on the final receipt SHOULD be on that list.</span>
                    <span class="comment">//</span>
                    std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();

                    std::set&lt;int64_t&gt;::iterator theSetIT = theIDSet.find(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());

                    <span class="comment">// If we FOUND it on the Nym, then we add it to the list to be removed from Nym&#39;s open cron items.</span>
                    <span class="comment">// (If it wasn&#39;t there before, then we wouldn&#39;t want to &quot;re-add&quot; it, now would we?)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (theIDSet.end() != theSetIT) <span class="comment">// FOUND IT!</span>
                        theTempClosingNumNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()); <span class="comment">// Schedule to remove GetClosingNum() from server-side list of Nym&#39;s open cron items. (By adding it to theTempClosingNumNym.)</span>
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: expected to find pServerTransaction-&gt;GetClosingNum() (%ld) on Nym&#39;s (%s) &quot;</span>
                                       <span class="stringliteral">&quot;list of open cron items. (Maybe he didn&#39;t see the notice in his Nymbox yet.)\n&quot;</span>,
                                       __FUNCTION__, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(), strUserID.Get());
                    <span class="comment">// else error log.</span>
                }

                <span class="comment">// ---- COUNT is correct and closing num is on list of open cron items. (FINAL RECEIPT FALLS THROUGH HERE!!! no break) ------------------------</span>

                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>:
                    <span class="comment">// IF it&#39;s actually there on theNym, then schedule it for removal.</span>
                    <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(m_strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
                        theTempNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
                    <span class="keywordflow">else</span>
                    {
                        bSuccessFindingAllTransactions = <span class="keyword">false</span>;

                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: basket or final receipt, trying to &#39;remove&#39; an issued &quot;</span>
                                      <span class="stringliteral">&quot;number (%ld) that already wasn&#39;t on Nym&#39;s issued list. (So what is this in the inbox, &quot;</span>
                                      <span class="stringliteral">&quot;then?)\n&quot;</span>, __FUNCTION__, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
                    }

                    <span class="keywordflow">break</span>;
                <span class="comment">// ----------------------------------------------------------------------------</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>:
                    <span class="comment">// IF I&#39;m accepting a pending transfer, then add the amount to my counter of total amount being accepted.</span>
                    <span class="comment">//</span>
                    lTotalBeingAccepted += pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
                    bSuccessFindingAllTransactions = <span class="keyword">true</span>;
                    <span class="keywordflow">break</span>;
                <span class="comment">// ----------------------------------------------------------------------------</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>:
                    bSuccessFindingAllTransactions = <span class="keyword">true</span>;
                {
                    <span class="comment">// If I&#39;m accepting an item receipt (which will remove my responsibility for that item) then add it</span>
                    <span class="comment">// to the temp Nym (which is a list of transaction numbers that will be removed from my responsibility if</span>
                    <span class="comment">// all is successful.)  Also remove all the Temp Nym numbers from theNym, so we can verify the Balance</span>
                    <span class="comment">// Statement AS IF they were already removed.</span>
                    <span class="comment">//</span>
                    <span class="comment">// What number do I remove here? the user is accepting a transfer receipt, which</span>
                    <span class="comment">// is in reference to the recipient&#39;s acceptPending. THAT item is in reference to</span>
                    <span class="comment">// my original transfer (or contains a cheque with my original number.) (THAT&#39;s the # I need.)</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                    <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strOriginalItem, SERVER_ID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theOrigItemGuardian(pOriginalItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>

                    <span class="keywordflow">if</span> (NULL != pOriginalItem)
                    {
                        <span class="comment">// If pOriginalItem is acceptPending, that means the client is accepting the transfer receipt from the server, (from his inbox),</span>
                        <span class="comment">// which has the recipient&#39;s acceptance inside of the client&#39;s transfer as the original item. This means the transfer that</span>
                        <span class="comment">// the client originally sent is now finally closed!</span>
                        <span class="comment">//</span>
                        <span class="comment">// If it&#39;s a depositCheque, that means the client is accepting the cheque receipt from the server, (from his inbox)</span>
                        <span class="comment">// which has the recipient&#39;s deposit inside of it as the original item. This means that the cheque that</span>
                        <span class="comment">// the client originally wrote is now finally closed!</span>
                        <span class="comment">//</span>
                        <span class="comment">// In both cases, the &quot;original item&quot; itself is not from the client, but from the recipient! Therefore,</span>
                        <span class="comment">// the number on that item is useless for removing numbers from the client&#39;s list of issued numbers.</span>
                        <span class="comment">// Rather, I need to load that original cheque, or pending transfer, from WITHIN the original item,</span>
                        <span class="comment">// in order to get THAT number, to remove it from the client&#39;s issued list. (Whether for real, or for</span>
                        <span class="comment">// setting up dummy data in order to verify the balance agreement.) *sigh*</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// client is accepting a cheque receipt, which has a depositCheque (from the recipient) as the original item within.</span>
                        {
                            <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);

                            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>

                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp;
                                          theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading cheque from string:\n%s\n&quot;</span>,
                                              __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                            }
                            <span class="keywordflow">else</span>    <span class="comment">// Since the client wrote the cheque, and he is now accepting the cheque receipt, he can be cleared for that transaction number...</span>
                            {
                                <span class="comment">// IF it&#39;s actually there on theNym, then schedule it for removal.</span>
                                <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a> (m_strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>()))
                                    theTempNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                                <span class="keywordflow">else</span>
                                {
                                    bSuccessFindingAllTransactions = <span class="keyword">false</span>;

                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: cheque receipt, trying to &#39;remove&#39; an issued &quot;</span>
                                                  <span class="stringliteral">&quot;number (%ld) that already wasn&#39;t on Nym&#39;s issued list. (So what is this in the inbox, &quot;</span>
                                                  <span class="stringliteral">&quot;then?)\n&quot;</span>, __FUNCTION__, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                                }
                            }
                        }
                        <span class="comment">// client is accepting a transfer receipt, which has an acceptPending from the recipient as the original item within,</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// (which is in reference to the client&#39;s outoing original transfer.)</span>
                        {
                            <span class="comment">// IF it&#39;s actually there on theNym, then schedule it for removal.</span>
                            <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (theNym. VerifyIssuedNum(m_strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>()))
                                theTempNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
                            <span class="keywordflow">else</span>
                            {
                                bSuccessFindingAllTransactions = <span class="keyword">false</span>;

                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: transfer receipt, trying to &#39;remove&#39; an issued &quot;</span>
                                              <span class="stringliteral">&quot;number (%ld) that already wasn&#39;t on Nym&#39;s issued list. (So what is this in the inbox, &quot;</span>
                                              <span class="stringliteral">&quot;then?)\n&quot;</span>, __FUNCTION__, pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                            }
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItemType;
                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strOriginalItemType);
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Original item has wrong type, while accepting item receipt:\n%s\n&quot;</span>,
                                          __FUNCTION__, strOriginalItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                        }
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load original item from string while accepting item receipt:\n%s\n&quot;</span>,
                                      __FUNCTION__, strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                    }
                } <span class="comment">// pItem is acceptItemReceipt --------------------</span>

                    <span class="keywordflow">break</span>;
                <span class="comment">// -------------------------------------------------------------------------------</span>
                <span class="keywordflow">default</span>:
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type in OTServer::NotarizeProcessInbox. (2nd notice.)\n&quot;</span>);
                    bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                    <span class="keywordflow">break</span>;
            } <span class="comment">// switch --------------------------------------------</span>


            <span class="comment">// I&#39;ll also go ahead and remove each transaction from pInbox, and pass said inbox into the VerifyBalanceAgreement call...</span>
            <span class="comment">// (So it can simulate as if the inbox was already processed, and the total is already calculated, and if it succeeds,</span>
            <span class="comment">// then we can allow the giant loop below to do it all for real.)</span>
            <span class="comment">// (I&#39;m not saving this copy of the inbox anyway--there&#39;s another one below.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (bSuccessFindingAllTransactions)
            {
                <span class="comment">// WE&#39;RE REMOVING THE TRANSACTIONS FROM AN INBOX COPY, IN ORDER TO VERIFY THE</span>
                <span class="comment">// BALANCE AGREEMENT (WITH THAT INBOX COPY SET UP AS THOUGH THE TRANSACTION HAD</span>
                <span class="comment">// ALREADY BEEN A SUCCESS.)</span>
                <span class="comment">// I&#39;m not ACTUALLY removing though, until AFTER the loop (in case the rest of the</span>
                <span class="comment">// loop needs the data still, in that inbox.) So we save in a list, and remove AFTER the loop.</span>
                <span class="comment">//</span>
                theListOfInboxReceiptsBeingRemoved.push_back(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
            }
            <span class="keywordflow">else</span> <span class="comment">// If there was an error above, then we don&#39;t want to keep looping. We want the below error block.</span>
                <span class="keywordflow">break</span>;
            <span class="comment">// ---------------------------------------------------------------------------</span>
        } <span class="comment">// for loop (list of &quot;process inbox&quot; items)</span>

        <span class="comment">// ***************************************************************************</span>

<span class="comment">//      OTLog::Error(&quot;OTServer::NotarizeProcessInbox   BELOW THE LOOP===&gt; ABout to call VERIFY BALANCE STATEMENT \n&quot;);</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessFindingAllTransactions)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: transactions in processInbox message do not match actual inbox.\n&quot;</span>, __FUNCTION__);
        }
        <span class="keywordflow">else</span>
        {   <span class="comment">// Remove certain receipts (determined in the big loop above) from the inbox copy,</span>
            <span class="comment">// to see if it will verify in the balance agreement.</span>
            <span class="comment">//</span>
            <span class="keywordflow">while</span> (!theListOfInboxReceiptsBeingRemoved.empty())
            {
                int64_t lTemp = theListOfInboxReceiptsBeingRemoved.front();
                theListOfInboxReceiptsBeingRemoved.pop_front();

                <span class="comment">// Notice I don&#39;t call DeleteBoxReceipt(lTemp) here like I normally would when calling</span>
                <span class="comment">// RemoveTransaction(lTemp), since this is only a copy of my inbox and not the real thing.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lTemp))    <span class="comment">// &lt;================</span>
                   <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed removing receipt from Inbox copy: %ld \n&quot;</span>
                                 <span class="stringliteral">&quot;Meaning the client probably has an old copy of his inbox. &quot;</span>
                                 <span class="stringliteral">&quot;We don&#39;t even see the receipt that he still thinks he has.\n&quot;</span>,
                                 __FUNCTION__, lTemp);
            }
            <span class="comment">// -----------------------------------------------------------------------------</span>
            <span class="comment">// Remove certain issued numbers (determined in the big loop above) from the Nym,</span>
            <span class="comment">// to see if it will verify in the balance agreement (we&#39;ll re-add them after.)</span>
            <span class="comment">// Also, we&#39;re ONLY removing these because we verified above that they were really there.</span>
            <span class="comment">// Otherwise it&#39;d be pretty stupid to &quot;re-add&quot; them, eh?</span>
            <span class="comment">//</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
            {
                int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
                theNym.<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_strServerID, lTemp);
            }

            <span class="comment">// **********************************************************************</span>
            <span class="comment">// FINALLY after all that setup, we can do the balance agreement!!</span>
            <span class="comment">//</span>
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bVerifiedBalanceStatement = pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(lTotalBeingAccepted,  <span class="comment">// &lt;========================</span>
                                                                                  theNym,
                                                                                  *pInbox,
                                                                                  *pOutbox,
                                                                                  theAccount,
                                                                                  tranIn);
            <span class="comment">// **********************************************************************</span>

            <span class="comment">// Here, add all the issued nums back (that had been temporarily removed from theNym) that were stored on theTempNym for safe-keeping.</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
            {
                int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
                theNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, lTemp);
            }
            <span class="comment">// (They are removed for real at the bottom of this function, IF everything is successful between now and then.)</span>

            <span class="comment">// -----------------------------------------------------------------------------</span>

            <span class="keywordflow">if</span> (<span class="keyword">false</span> == bVerifiedBalanceStatement)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeProcessInbox: ERROR verifying balance statement for transaction %ld.\n&quot;</span>,
                               tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
            }

            <span class="keywordflow">else</span> <span class="comment">// BALANCE AGREEMENT WAS SUCCESSFUL.......</span>
            {
                pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

                <span class="comment">// --------------------------------------------------------------------</span>

                <span class="comment">// THE ABOVE LOOP WAS JUST A TEST RUN</span>
                <span class="comment">//</span>
                <span class="comment">// (TO VERIFY BALANCE AGREEMENT BEFORE WE BOTHERED TO RUN THIS LOOP BELOW...)</span>

                <span class="comment">// loop through the items that make up the incoming transaction</span>
                <span class="comment">//</span>
                <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, tranIn.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>(), it_bigloop_two)
                {
                    pItem = *it_bigloop_two;
                    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Pointer should not have been NULL.&quot;</span>);

                    <span class="comment">// We already handled this one (if we&#39;re even in this block in the first place.)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                    {
                        <span class="keywordflow">continue</span>;
                    }

                    <span class="comment">// If the client sent an accept item, (or reject/dispute) then let&#39;s process it.</span>
                    <span class="keywordflow">if</span> (
                        (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a>    == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                        &amp;&amp;
                        (
                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>     == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepting notice of market trade or payment processing. (Original in Cron Receipt.)</span>
<span class="comment">//                       (OTItem::disputeCronReceipt    == pItem-&gt;GetType()) || // Disputing said notice.  With Cron receipts, original is stored as an OTCronItem...</span>
                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>     == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepted item receipt (cheque, transfer)</span>
<span class="comment">//                       (OTItem::disputeItemReceipt    == pItem-&gt;GetType()) || // Disputing said notice.</span>
                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>         == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepting notice of pending transfer</span>
<span class="comment">//                       (OTItem::rejectPending         == pItem-&gt;GetType()) || // With pending, the Original is stored in OTItem pOriginalItem...</span>
                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>    == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepting finalReceipt</span>
<span class="comment">//                       (OTItem::disputeFinalReceipt   == pItem-&gt;GetType()) || // Disputing finalReceipt.</span>
                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>   == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())    <span class="comment">// Accepting basketReceipt</span>
<span class="comment">//                       (OTItem::disputeBasketReceipt  == pItem-&gt;GetType())    // Disputing basketReceipt.</span>
                         )
                        )
                    {
                        <span class="comment">// The response item will contain a copy of the &quot;accept&quot; request.</span>
                        <span class="comment">// So I&#39;m just setting aside a copy now for those purposes later.</span>
                        strInReferenceTo.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);

                        <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType;
                        <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                        {
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a873fcfb43e552e1f81d475fb898e9ac8">OTItem::rejectPending</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a84f21da0049c428f2e74c573dfaff067">OTItem::atRejectPending</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0ae31723e4a6a715f4de40bf18aa932f">OTItem::disputeCronReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a15fb11d5243db9056a4c340bc49cea43">OTItem::atDisputeCronReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4eb8608cbf2db1dd590856c3777e70a2">OTItem::disputeItemReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acd9426f6754691aebb202e9c14cdc681">OTItem::atDisputeItemReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a62442ecb84d96e94176c7f9b533a9061">OTItem::disputeFinalReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9b353f70c54facca58998d250badcf27">OTItem::atDisputeFinalReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a69a150fe3a7ec3726dc71d183d572a87">OTItem::disputeBasketReceipt</a>:
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9fc8674f161335439c48b2e9db277b9b">OTItem::atDisputeBasketReceipt</a>;
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">default</span>:
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Should never happen.\n&quot;</span>);
                                theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>; <span class="comment">// should never happen based on above &#39;if&#39; statement.</span>
                                <span class="keywordflow">break</span>;                                  <span class="comment">// saving this anyway just cause it&#39;s cleaner.</span>
                        }


                        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
                        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

                        pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, theReplyItemType);
                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                        tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>


                        <span class="comment">// Need to load the Inbox first, in order to look up the transaction that</span>
                        <span class="comment">// the client is accepting. This is possible because the client has included</span>
                        <span class="comment">// the transaction number.  I&#39;ll just look it up in his inbox and then</span>
                        <span class="comment">// process it.</span>
                        <span class="comment">// theAcctID is the ID on the client Account that was passed in.</span>
                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);

                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;

                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theInbox.LoadInbox())
                        {
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading inbox during processInbox\n&quot;</span>);
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theInbox.VerifyAccount(m_nymServer))
                        {
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error verifying inbox during processInbox\n&quot;</span>);
                        }
                        <span class="comment">// --------------------------------------------------------------</span>
                        <span class="comment">//</span>
                        <span class="comment">// Warning! In the case of a OTTransaction::paymentReceipt or OTTransaction::marketReceipt,</span>
                        <span class="comment">// the &quot;in reference to&quot; string will NOT contain an OTItem at all, but an OTPaymentPlan or</span>
                        <span class="comment">// an OTTrade!! Also, a paymentReceipt might be for a smart contract, in which case there&#39;s</span>
                        <span class="comment">// a smartcontract inside, instead of a payment plan! I handle these cases first, here:</span>
                        <span class="comment">//</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (  <span class="comment">// MARKET RECEIPT, or PAYMENT RECEIPT.....</span>
                                 (
                                  (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())<span class="comment">// This is checked above, but just keeping this safe.</span>
                                  )                                             <span class="comment">// especially in case this block moves or is used elsewhere.</span>
                                 &amp;&amp;
                                 (NULL != (pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())))
                                 &amp;&amp;
                                 (
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>== pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                  )
                                 )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the Receipt</span>
                            <span class="comment">// represented by pServerTransaction. Therefore we have the user&#39;s</span>
                            <span class="comment">// item AND the receipt he is trying to accept.</span>

                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster.</span>
<span class="comment">//                          theInbox.   DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theInbox.   RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theInbox.   ReleaseSignatures();
                            theInbox.   SignContract(m_nymServer);
                            theInbox.   SaveContract();
                            theAccount. SaveInbox(theInbox);
                            theAccount. ReleaseSignatures();
                            theAccount. SignContract(m_nymServer);
                            theAccount. SaveContract();
                            theAccount. SaveAccount();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }
                        <span class="comment">// -----------------------------------------------------------------</span>

                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="comment">// FINAL RECEIPT</span>
                                 (
                                  (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())<span class="comment">// This is checked above, but just keeping this safe.</span>
                                  )                                             <span class="comment">// especially in case this block moves or is used elsewhere.</span>
                                 &amp;&amp;
                                 (NULL != (pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())))
                                 &amp;&amp;
                                 (
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                  )
                                 )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the Receipt</span>
                            <span class="comment">// represented by pServerTransaction. Therefore we have the user&#39;s</span>
                            <span class="comment">// item AND the receipt he is trying to accept.</span>

                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster.</span>
<span class="comment">//                          theInbox.   DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theInbox.   RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theInbox.   ReleaseSignatures();
                            theInbox.   SignContract(m_nymServer);
                            theInbox.   SaveContract();
                            theAccount. SaveInbox(theInbox);
                            theAccount. ReleaseSignatures();
                            theAccount. SignContract(m_nymServer);
                            theAccount. SaveContract();
                            theAccount. SaveAccount();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }

                        <span class="comment">// -----------------------------------------------------------------</span>

                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="comment">// BASKET RECEIPT</span>
                                 (
                                  (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())<span class="comment">// This is checked above, but just keeping this safe.</span>
                                  )                                             <span class="comment">// especially in case this block moves or is used elsewhere.</span>
                                 &amp;&amp;
                                 (NULL != (pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())))
                                 &amp;&amp;
                                 (
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                  )
                                 )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the Receipt</span>
                            <span class="comment">// represented by pServerTransaction. Therefore we have the user&#39;s</span>
                            <span class="comment">// item AND the receipt he is trying to accept.</span>

                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster.</span>
<span class="comment">//                          theInbox.   DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theInbox.   RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theInbox.   ReleaseSignatures();
                            theInbox.   SignContract(m_nymServer);
                            theInbox.   SaveContract();
                            theAccount. SaveInbox(theInbox);
                            theAccount. ReleaseSignatures();
                            theAccount. SignContract(m_nymServer);
                            theAccount. SaveContract();
                            theAccount. SaveAccount();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }

                        <span class="comment">// -----------------------------------------------------------------</span>
                        <span class="comment">// Careful here.  I&#39;m looking up the original transaction number (1, say) which is stored</span>
                        <span class="comment">// in my inbox as a &quot;in reference to&quot; on transaction number 41. (Which is a pending transaction</span>
                        <span class="comment">// or receipt</span>
                        <span class="comment">// that the server created in my inbox, and only REFERS to the original transaction, but is not</span>
                        <span class="comment">// the original transaction in and of itself.)</span>
                        <span class="comment">//</span>
                        <span class="comment">// In other words, in this case below, I am looking for the transaction in the Inbox</span>
                        <span class="comment">// that REFERS to the same transaction that the accept item REFERS to. That process, necessary</span>
                        <span class="comment">// for pending transactions and cheque receipts, is NOT the case above, with receipts from cron.</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (
                                   (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>   == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())    <span class="comment">// acceptItemReceipt includes checkReceipt and transferReceipts.</span>
<span class="comment">//                                   (OTItem::rejectItemReceipt == pItem-&gt;GetType())</span>
                                   || (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>    == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())    <span class="comment">// acceptPending includes checkReceipts. Because they are</span>
<span class="comment">//                                      (OTItem::rejectPending  == pItem-&gt;GetType())    // stored/loaded similarly, not like the above Cron Receipts.</span>
                                   )
                                 &amp;&amp;
                                 (NULL != (pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())))
                                 &amp;&amp;
                                 (
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>         == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || <span class="comment">// pending transfer.</span>
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || <span class="comment">// transfer receipt.</span>
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>  == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || <span class="comment">// voucher receipt.</span>
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>   == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())    <span class="comment">// cheque receipt is down here in the pending section,</span>
                                  )                                                                    <span class="comment">// because this is where an OTItem is loaded up (since it</span>
                                 )                                                                     <span class="comment">// originated with a deposit transaction, not a cron receipt.)</span>
                        {

<span class="comment">//                            if (theInbox.GetTransactionCountInRefTo(pItem-&gt;GetReferenceToNum()) &gt; 1)</span>
<span class="comment">//                                OTLog::vError(&quot;%s: WARNING 2: There are MULTIPLE receipts &#39;in reference to&#39; %ld. (It will return the first one...)\n&quot;,</span>
<span class="comment">//                                              __FUNCTION__, pItem-&gt;GetReferenceToNum());</span>

                            <span class="comment">// The accept item will come with the transaction number that</span>
                            <span class="comment">// it&#39;s referring to. So we&#39;ll just look up that transaction</span>
                            <span class="comment">// in the inbox, and now that it&#39;s been accepted, we&#39;ll process it.</span>

                            <span class="comment">// At this point, pItem points to the client&#39;s attempt to accept pServerTransaction</span>
                            <span class="comment">// and pServerTransaction is the server&#39;s created transaction in my inbox that contains</span>
                            <span class="comment">// the original item (from the sender) as the &quot;referenced to&quot; object. So let&#39;s extract</span>
                            <span class="comment">// it.</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                            <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strOriginalItem, SERVER_ID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theOrigItemGuardian(pOriginalItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>

                            <span class="keywordflow">if</span> (NULL != pOriginalItem)
                            {

                                <span class="comment">// What are we doing in this code?</span>
                                <span class="comment">//</span>
                                <span class="comment">// I need to accept various items that are sitting in my inbox, such as:</span>
                                <span class="comment">//</span>
                                <span class="comment">// -- transfers waiting to be accepted (or rejected.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// -- cheque deposit receipts waiting to be accepted (they cannot be rejected.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// -- transfer receipts waiting to be accepted (they cannot be rejected.)</span>

                                <span class="comment">//</span>
                                <span class="comment">// ONLY in the case of pending transfers also do I need to mess around with my account,</span>
                                <span class="comment">// and the sender&#39;s inbox and outbox. In the other cases, I merely need to remove</span>
                                <span class="comment">// the item from my inbox.</span>
                                <span class="comment">// Although when &#39;accepting the reject&#39;, I do need to take the money back into</span>
                                <span class="comment">// my inbox...</span>



                                <span class="comment">// ----------------------------------------------------------------------------------------------</span>


                                <span class="comment">// The depositCheque request OTItem is saved as a &quot;in reference to&quot; field</span>
                                <span class="comment">// on the inbox chequeReceipt transaction.</span>

                                <span class="comment">// Therefore, if I am processing an acceptPending item from the client,</span>
                                <span class="comment">// for accepting a chequeReceipt Transaction that&#39;s in his inbox, and</span>
                                <span class="comment">// the original item (that the receipt is for) is a depositCheque,</span>
                                <span class="comment">// then I can go ahead and clear it from his inbox.</span>


                                <span class="comment">// The below block only executes for ACCEPTING a CHEQUE deposit receipt, or</span>
                                <span class="comment">// for &#39;Accepting an ACCEPT.&#39;</span>
                                <span class="comment">//</span>
                                <span class="comment">// I can&#39;t &#39;Accept a REJECT&#39; without also transferring the rejected money back into</span>
                                <span class="comment">// my own account. And that means fiddling with my account, and that means it will</span>
                                <span class="comment">// be in a different block of code than this one.</span>
                                <span class="comment">//</span>
                                <span class="comment">// Whereas with accepting a cheque deposit receipt, or accepting an accepted transfer notice,</span>
                                <span class="comment">// in both of those cases, my account balance doesn&#39;t change at all. I just need to accept</span>
                                <span class="comment">// those notices in order to get them out of my inbox. So that&#39;s the simplest case, and it&#39;s</span>
                                <span class="comment">// handled by THIS block of code:</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (
                                    (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>  == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                    &amp;&amp;
                                    (
                                     (
                                      (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>   == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) &amp;&amp;
                                      (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>            == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                      )
                                        ||
                                      (
                                          ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>   == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                                            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>  == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
                                            &amp;&amp;
                                          (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>            == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                      )
                                     )
                                    )
                                {   <span class="comment">// (The funds are already paid out...)</span>
                                    <span class="comment">// pItem contains the current user&#39;s attempt to accept the</span>
                                    <span class="comment">// [&#39;depositCheque&#39; OR &#39;acceptPending&#39;] located in theOriginalItem.</span>
                                    <span class="comment">// Now we have the user&#39;s item and the item he is trying to accept.</span>

                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster.</span>
<span class="comment">//                                  theInbox.   DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                                    theInbox.   RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                                    <span class="comment">// ----------------------------------</span>
                                    theInbox.   ReleaseSignatures();
                                    theInbox.   SignContract(m_nymServer);
                                    theInbox.   SaveContract();
                                    <span class="comment">// ----------------------------------</span>
                                    theAccount. SaveInbox(theInbox);
                                    theAccount. ReleaseSignatures();
                                    theAccount. SignContract(m_nymServer);
                                    theAccount. SaveContract();
                                    theAccount. SaveAccount();

                                    <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                                    <span class="comment">// Don&#39;t I need to remove from responsibility list?</span>
                                    <span class="comment">// No, because that is done at the bottom of the function.</span>
                                    <span class="comment">//</span>
                                }<span class="comment">// its type is OTItem::acceptPending or OTItem::depositCheque</span>



                                <span class="comment">// ----------------------------------------------------------------------------------------------</span>

                                <span class="comment">// TODO: &#39;Accept a REJECT&#39; -- NEED TO PERFORM THE TRANSFER OF FUNDS BACK TO THE SENDER&#39;S ACCOUNT WHEN TRANSFER IS REJECTED.</span>

                                <span class="comment">// ----------------------------------------------------------------------------------------------</span>

                                <span class="comment">// The below block only executes for ACCEPTING a TRANSFER</span>

                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                                         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                         &amp;&amp;
                                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                         )
                                {
                                    <span class="comment">// pItem contains the current user&#39;s attempt to accept the transfer located in theOriginalItem.</span>
                                    <span class="comment">// Now we have both items.</span>
                                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> IDFromAccount(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>());
                                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> IDToAccount(pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>());

                                    <span class="comment">// I&#39;m using the operator== because it exists.</span>
                                    <span class="comment">// If the ID on the &quot;To&quot; account from the original transaction does not</span>
                                    <span class="comment">// match the Acct ID of the client trying to accept the transaction...</span>
                                    <span class="keywordflow">if</span> (!(ACCOUNT_ID == IDToAccount))
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error: Destination account ID on the transaction does not match account ID of client transaction item.\n&quot;</span>);
                                    }

                                    <span class="comment">// -------------------------------------------------------------------</span>

                                    <span class="comment">// The &#39;from&#39; outbox is loaded to remove the outgoing transfer, since it has been accepted.</span>
                                    <span class="comment">// The &#39;from&#39; inbox is loaded in order to put a notice of this acceptance for the sender&#39;s records.</span>
                                    <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theFromOutbox(IDFromAccount, SERVER_ID),    <span class="comment">// Sender&#39;s *OUTBOX*</span>
                                                theFromInbox(IDFromAccount, SERVER_ID);     <span class="comment">// Sender&#39;s *INBOX*</span>

                                    <span class="keywordtype">bool</span> bSuccessLoadingInbox   = theFromInbox.LoadInbox();
                                    <span class="keywordtype">bool</span> bSuccessLoadingOutbox  = theFromOutbox.LoadOutbox();

                                    <span class="comment">// --------------------------------------------------------------------</span>

                                    <span class="comment">// THE FROM INBOX -- We are adding an item here (acceptance of transfer),</span>
                                    <span class="comment">// so we will create this inbox if we have to, so we can add that record to it.</span>

                                    <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingInbox)
                                        bSuccessLoadingInbox    = theFromInbox.VerifyAccount(m_nymServer);
                                    <span class="keywordflow">else</span>
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR missing &#39;from&#39; inbox in OTServer::NotarizeProcessInbox.\n&quot;</span>);
<span class="comment">//                                  else</span>
<span class="comment">//                                        bSuccessLoadingInbox  = theFromInbox.GenerateLedger(IDFromAccount, SERVER_ID, OTLedger::inbox, true); // bGenerateFile=true</span>
                                    <span class="comment">// --------------------------------------------------------------------</span>
                                    <span class="comment">// THE FROM OUTBOX -- We are removing an item, so this outbox SHOULD already exist.</span>

                                    <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOutbox)
                                        bSuccessLoadingOutbox   = theFromOutbox.VerifyAccount(m_nymServer);
                                    <span class="keywordflow">else</span> <span class="comment">// If it does not already exist, that is an error condition. For now, log and fail.</span>
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR missing &#39;from&#39; outbox in OTServer::NotarizeProcessInbox.\n&quot;</span>);
                                    <span class="comment">// ---------------------------------------------------------------------</span>
                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingInbox || <span class="keyword">false</span> == bSuccessLoadingOutbox)
                                    {
                                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading &#39;from&#39; inbox or outbox in OTServer::NotarizeProcessInbox.\n&quot;</span>);
                                    }
                                    <span class="keywordflow">else</span>
                                    {
                                        <span class="comment">// Generate a new transaction number for the sender&#39;s inbox (to notice him of acceptance.)</span>
                                        int64_t lNewTransactionNumber = 0;
                                        <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                                        <span class="comment">// Generate a new transaction... (to notice the sender of acceptance.)</span>
                                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction   = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFromInbox,
                                                                                                                 <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>,
                                                                                                                 lNewTransactionNumber);

                                        <span class="keywordflow">if</span> (NULL == pInboxTransaction) <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;

                                        <span class="comment">// Here we give the sender (by dropping into his inbox) a copy of my acceptItem (for</span>
                                        <span class="comment">// his transfer), including the transaction number of my acceptance of his transfer.</span>
                                        <span class="comment">//</span>
                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());   <span class="comment">// Right now this has the &#39;accept the transfer&#39; transaction number.</span>
                                        <span class="comment">// It could be changed to the original transaction number, as a better</span>
                                        <span class="comment">// receipt for the original sender. TODO? Decisions....</span>

                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                                        <span class="comment">// Now we have created a new transaction from the server to the sender&#39;s inbox</span>
                                        <span class="comment">// Let&#39;s sign it and add to his inbox.</span>
                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                                        pInboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                        <span class="comment">// At this point I have theInbox ledger, theFromOutbox ledger, theFromINBOX ledger,</span>
                                        <span class="comment">// and theAccount.  So I should remove the appropriate item from each ledger, and</span>
                                        <span class="comment">// add the acceptance to the sender&#39;s inbox, and credit the account....</span>

                                        <span class="comment">// First try to credit the amount to the account...</span>
                                        <span class="keywordflow">if</span> (theAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()))
                                        {
                                            <span class="comment">// Add a transfer receipt to the sender&#39;s inbox, containing the &quot;accept&quot; transaction as the ref string.</span>
                                            <span class="comment">// (to notify him that his transfer was accepted; once he accepts it, the trans# can be removed from his issued list.)</span>
                                            <span class="comment">//</span>
                                            theFromInbox.   AddTransaction(*pInboxTransaction);

                                            <span class="comment">// The original item carries the transaction number that the original</span>
                                            <span class="comment">// sender used to generate the transfer in the first place. This is the number</span>
                                            <span class="comment">// by which that transaction is available in the sender&#39;s outbox.</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// Then ANOTHER transaction was created, by the server, in order to put</span>
                                            <span class="comment">// a pending transfer into the recipient&#39;s inbox. This has its own transaction</span>
                                            <span class="comment">// number, generated by the server at that time.</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// So we remove the original transfer from the sender&#39;s outbox using the</span>
                                            <span class="comment">// transaction number on the original item, and we remove the pending transfer</span>
                                            <span class="comment">// from the recipient&#39;s inbox using the transaction number from the pending</span>
                                            <span class="comment">// transaction.</span>

                                            <span class="comment">// UPDATE: These two transactions correspond to each other, so I am now creating</span>
                                            <span class="comment">// them with the same transaction number. As you can see, this makes them easy</span>
                                            <span class="comment">// to remove as well.</span>

                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theFromOutbox); <span class="comment">// faster.</span>
<span class="comment">//                                          theFromOutbox.  DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                                            theFromOutbox.  RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster.</span>
<span class="comment">//                                          theInbox.       DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                                            theInbox.       RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                                            <span class="comment">// NOTICE BTW, warning: Notice that the box receipts are marked for deletion</span>
                                            <span class="comment">// the instant they are removed from their respective boxes. Meanwhile, the client</span>
                                            <span class="comment">// may not have actually DOWNLOADED those box receipts. Once they are ACTUALLY</span>
                                            <span class="comment">// deleted, then client will never have the chance. It&#39;s assumed that client doesn&#39;t</span>
                                            <span class="comment">// care, since the receipts are already out of his box.</span>

                                            <span class="comment">// ----------------------------------------------</span>

                                            theFromInbox.   ReleaseSignatures();
                                            theFromOutbox.  ReleaseSignatures();

                                            theFromInbox.   SignContract(m_nymServer);
                                            theFromOutbox.  SignContract(m_nymServer);

                                            theFromInbox.   SaveContract();
                                            theFromOutbox.  SaveContract();

                                            theFromInbox.   SaveInbox();
                                            theFromOutbox.  SaveOutbox();
                                            <span class="comment">// ----------------------------------------</span>

                                            <span class="comment">// Release any signatures that were there before (Old ones won&#39;t</span>
                                            <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                                            theInbox.       ReleaseSignatures();
                                            theInbox.       SignContract(m_nymServer);
                                            theInbox.       SaveContract();
                                            theAccount.     SaveInbox(theInbox);
                                            theAccount.     ReleaseSignatures();
                                            theAccount.     SignContract(m_nymServer);
                                            theAccount.     SaveContract();
                                            theAccount.     SaveAccount();


                                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                                            <span class="comment">// otherwise, if we never entered this block, then it would still be set to rejection, and the</span>
                                            <span class="comment">// new items would never have been added to the inbox/outboxes, and those files, along with</span>
                                            <span class="comment">// the account file, would never have had their signatures released, or been re-signed or</span>
                                            <span class="comment">// re-saved back to file.  The debit failed, so all of those other actions would fail also.</span>
                                            <span class="comment">// BUT... if the message comes back with acknowledgement--then all of these actions must have</span>
                                            <span class="comment">// happened, and here is the server&#39;s signature to prove it.</span>
                                            <span class="comment">// Otherwise you get no items and no signature. Just a rejection item in the response transaction.</span>
                                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                                            <span class="comment">// This goes with the call above to theFromInbox.AddTransaction().</span>
                                            <span class="comment">// Adding a receipt to any box, for real, requires saving the box receipt</span>
                                            <span class="comment">// as well. (Which is stored in a separate file.)</span>
                                            <span class="comment">//</span>
                                            pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theFromInbox);
                                        }
                                        <span class="keywordflow">else</span>
                                        {
                                            <span class="keyword">delete</span> pInboxTransaction; pInboxTransaction = NULL;
                                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to credit account in OTServer::NotarizeProcessInbox.\n&quot;</span>);
                                        }
                                    } <span class="comment">// outbox was successfully loaded</span>
                                }<span class="comment">// its type is OTItem::transfer</span>
                            }<span class="comment">// loaded original item from string</span>
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading original item from inbox transaction.\n&quot;</span>);
                            }
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error finding original receipt or transfer that client is trying to accept: %ld\n&quot;</span>,
                                          pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                        }

                        <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
                        <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
                        <span class="comment">// is owned by the transaction, who will take it from here.</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                        pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strItemType;
                        pItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strItemType);

                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Error, unexpected OTItem::itemType: %s\n&quot;</span>,
                                      __FUNCTION__, strItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    } <span class="comment">// if type == ACCEPT, REJECT, DISPUTE</span>
                } <span class="comment">// for LOOP (each item)</span>
            } <span class="comment">// else (balance agreement verified.)</span>
        } <span class="comment">// else bSuccessFindingAllTransactions = true</span>
    } <span class="comment">// Balance Agreement item found.</span>

    <span class="comment">// I put this here so it&#39;s signed/saved whether the balance agreement itself was successful OR NOT.</span>
    <span class="comment">// (Or whether it even existed or not.)</span>
    <span class="comment">//</span>
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// -------------------------------------------------</span>
    tranOut.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    tranOut.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    tranOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// -------------------------------------------------</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strPath; <span class="comment">// SAVE THE RECEIPT TO LOCAL STORAGE (for dispute resolution.)</span>

    <span class="comment">// On the server side, response will only have chance to succeed if balance agreement succeeds first.</span>
    <span class="comment">// Therefore, you will never see successful response but failed balance, since it would stop at the</span>
    <span class="comment">// balance and response itself would remain failed with no chance of changing.</span>
    <span class="comment">//</span>
    <span class="comment">// Thus, &quot;success&quot; must be when balance succeeded and transaction succeeded,</span>
    <span class="comment">// and &quot;failure&quot; must be when balance succeeded but transaction failed.</span>
    <span class="comment">//</span>
    <span class="comment">// If NEITHER succeeded, then there is no point recording it to a file, now is there?</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);

    <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
    {
        <span class="comment">// Balance agreement was a success, AND process inbox was a success.</span>
        <span class="comment">// Therefore, remove any relevant issued numbers from theNym (those he&#39;s</span>
        <span class="comment">// now officially no longer responsible for), and save.</span>
        <span class="comment">//</span>
        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
        {
            int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
            theNym.<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_nymServer, m_strServerID, lTemp, <span class="keyword">false</span>); <span class="comment">// bSave = false (saved below)</span>
        }
        <span class="comment">//-------------------------------------------</span>
        <span class="comment">// The Nym (server side) stores a list of all opening and closing cron #s.</span>
        <span class="comment">// So when the number is released from the Nym, we also take it off that list.</span>
        <span class="comment">//</span>
        std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempClosingNumNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
        {
            int64_t lTemp = theTempClosingNumNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
            theIDSet.erase(lTemp); <span class="comment">// now it&#39;s erased from within the Nym.</span>
        }
        theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);
        <span class="comment">//-------------------------------------------</span>
        bOutSuccess = <span class="keyword">true</span>;     <span class="comment">// the processInbox was successful.</span>
        <span class="comment">//-------------------------------------------</span>
        strPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>((<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;%s.success&quot;</span>, strAcctID.Get());
    }
    <span class="keywordflow">else</span>
        strPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>((<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;%s.fail&quot;</span>, strAcctID.Get());

    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername = <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();

    <span class="comment">// Save the receipt. (My outgoing transaction including the client&#39;s signed request that triggered it.)</span>
    tranOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(szFoldername, strPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
}
</pre></div>
</div>
</div>
<a class="anchor" id="a965049d4360936cd4930d361ca0d5c41"></a><!-- doxytag: member="OTServer::NotarizeProcessNymbox" ref="a965049d4360936cd4930d361ca0d5c41" args="(OTPseudonym &amp;theNym, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a965049d4360936cd4930d361ca0d5c41">OTServer::NotarizeProcessNymbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The client may send multiple transactions in the ledger when he calls processNymbox. This function will be called for each of those. Each processNymbox transaction may contain multiple items accepting or rejecting certain transactions. The server acknowledges and notarizes those transactions accordingly. (And each of those transactions must be accepted or rejected in whole.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l11642">11642</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atProcessNymbox&quot;, that is, &quot;a reply to the process nymbox request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">OTTransaction::atProcessNymbox</a>);
    <span class="comment">// -------------------------------------------------------------------</span>
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID), USER_ID(theNym);
    <span class="comment">// --------------------------------------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theTempNym;

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(USER_ID, USER_ID, SERVER_ID);
    <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);

    <span class="keywordtype">bool</span> bSuccessLoadingNymbox  = theNymbox.LoadNymbox();

    <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingNymbox)
        bSuccessLoadingNymbox   = theNymbox.VerifyAccount(m_nymServer); <span class="comment">// make sure it&#39;s all good.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordtype">bool</span>           bNymboxHashRegenerated = <span class="keyword">false</span>;
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   NYMBOX_HASH; <span class="comment">// In case the Nymbox hash is updated, we will have the updated version here.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingNymbox)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: Failed loading or verifying Nymbox for user:\n%s\n&quot;</span>,
                      __FUNCTION__, strNymID.Get());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pBalanceItem)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransaction(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::%s: No Transaction Agreement item found on this transaction %ld (required):\n\n%s\n\n&quot;</span>,
                       __FUNCTION__, tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTransaction.Get());
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to tranIn&#39;s balance agreement</span>

        <span class="comment">// The incoming transaction accepts various messages and transaction numbers.</span>
        <span class="comment">// So when it&#39;s all finished, my list of transaction numbers will be higher.</span>
        <span class="comment">//</span>
        <span class="comment">// I would like to not even process the whole giant loop below,</span>
        <span class="comment">// if I can verify here now that the transaction agreement is wrong.</span>
        <span class="comment">//</span>
        <span class="comment">// Thus I will actually loop through the acceptTransaction items in tranIn, and then for each one, I&#39;ll</span>
        <span class="comment">// lookup the ACTUAL transaction in the nymbox, and get its ACTUAL value. (And store them all up on a temp nym.)</span>
        <span class="comment">//</span>
        <span class="comment">// The ones being accepted will therefore be added to my Nym, so the Transaction Statement will be signed</span>
        <span class="comment">// as if that is already the case. (So they&#39;ll match.)</span>
        <span class="comment">//</span>
        <span class="comment">// I need to add them all to the Nym, verify the transaction statement, and then remove them again.</span>
        <span class="comment">// (which is why I stored them on a temp Nym :-) Then if it succeeds for real, at the bottom of this function,</span>
        <span class="comment">// I&#39;ll go ahead and add them properly (so it adds them to both lists.)</span>
        <span class="comment">//</span>

        <span class="keywordtype">bool</span> bSuccessFindingAllTransactions = <span class="keyword">true</span>;

        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, tranIn.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
        {
            pItem = *it;
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Pointer should not have been NULL.&quot;</span>);

            <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>)
            {
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = theNymbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                <span class="keywordflow">if</span> ((NULL != pTransaction) &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>)) <span class="comment">// The user is referencing a blank in the nymbox, which indeed is actually there.</span>
                {
                    bSuccessFindingAllTransactions = <span class="keyword">true</span>;

                    <a class="code" href="class_o_t_num_list.html">OTNumList</a> listNumbersNymbox, listNumbersUserItem;

                    pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(listNumbersUserItem);
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(listNumbersNymbox);

                    <span class="comment">// MAKE SURE THEY MATCH. (Otherwise user could be signing numbers that differ from the</span>
                    <span class="comment">// actual ones in the Nymbox.)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == listNumbersNymbox.<a class="code" href="class_o_t_num_list.html#ac9692a20a114672de9e02a18b1cdd5e6">Verify</a>(listNumbersUserItem))
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeProcessNymbox: Failed verifying: The numbers on the actual blank &quot;</span>
                                     <span class="stringliteral">&quot;transaction in the nymbox do not match the list of numbers sent over by the user.\n&quot;</span>);
                    <span class="comment">// ------------------------------------------</span>
                    <span class="keywordflow">else</span>    <span class="comment">// INSTEAD of merely adding the TRANSACTION NUMBER of the blank to the Nym,</span>
                    {       <span class="comment">// we actually add an entire list of numbers retrieved from the blank, including</span>
                            <span class="comment">// its main number.</span>
                        std::set&lt;int64_t&gt; theNumbers;
                        listNumbersNymbox.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theNumbers);

                        <span class="comment">// Looping through the transaction numbers on the Nymbox blank transaction.</span>
                        <span class="comment">// (There&#39;s probably 20 of them.)</span>
                        <span class="comment">//</span>
                        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theNumbers)
                        {
                            <span class="keyword">const</span> int64_t lTransactionNumber = *it;
                            <span class="comment">// -----------------------------------------------</span>
                            <span class="comment">// (We don&#39;t add it if it&#39;s already there.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(m_strServerID, lTransactionNumber))
                            {
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, lTransactionNumber);
                                theTempNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(m_strServerID, lTransactionNumber); <span class="comment">// so I can remove from theNym after VerifyTransactionStatement call</span>
                            }
                            <span class="keywordflow">else</span>
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::NotarizeProcessNymbox: tried to add an issued trans# (%ld) to a nym who &quot;</span>
                                              <span class="stringliteral">&quot;ALREADY had that number...\n&quot;</span>, lTransactionNumber);
                        }
                    }
                    <span class="comment">// ------------------------------------------</span>
                }
                <span class="keywordflow">else</span>
                {
                    bSuccessFindingAllTransactions = <span class="keyword">false</span>;
                    <span class="keywordflow">break</span>;
                }
            }
        }


        <span class="comment">// NOTICE: We&#39;re adding up all the new transaction numbers being added. (OTItem::acceptTransaction)...</span>
        <span class="comment">// but we&#39;re NOT bothering with the ones being REMOVED (OTItem::acceptFinalReceipt) here in NotarizeProecessNymbox.</span>
        <span class="comment">// Why not? BECAUSE THEY WERE ALREADY REMOVED. They were removed when the Cron Item expired, or was canceled.</span>
        <span class="comment">// The finalReceipt notice that went into the Nymbox was ONLY A COURTESY -- the NUMBER was ALREADY REMOVED.</span>
        <span class="comment">// Thus, we don&#39;t need to remove it now, although we DO need to add the new transaction numbers (acceptTransaction).</span>
        <span class="comment">//</span>
        <span class="comment">// (Of course, I will still remove the finalReceipt from the Nymbox. I just don&#39;t have to juggle any</span>
        <span class="comment">// transaction numbers on the NYM as a result of this.)</span>
        <span class="comment">//</span>
        <span class="comment">// ------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessFindingAllTransactions)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: transactions in processNymbox message do not match actual nymbox.\n&quot;</span>, __FUNCTION__);

            <span class="comment">// Remove all issued nums from theNym that are stored on theTempNym HERE.</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
            {
                int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
                theNym.<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_strServerID, lTemp);
            }
        }
        <span class="comment">// (else true == success finding all transaction...)</span>
        <span class="comment">//</span>
        <span class="comment">// **********************************************************************************</span>
        <span class="comment">// VERIFY TRANSACTION STATEMENT!</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7df2f7973839d7a270f6ea8de67d07b4">VerifyTransactionStatement</a>(theNym, tranIn, <span class="keyword">false</span>)) <span class="comment">// bIsRealTransaction=false (since we&#39;re doing Nymbox) // &lt;========</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR verifying transaction statement.\n&quot;</span>, __FUNCTION__);

            <span class="comment">// Remove all issued nums from theNym that are stored on theTempNym HERE.</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
            {
                int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
                theNym.<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_strServerID, lTemp);
            }
        }
        <span class="comment">// **********************************************************************************</span>

        <span class="keywordflow">else</span> <span class="comment">// TRANSACTION AGREEMENT WAS SUCCESSFUL.......</span>
        {
            <span class="comment">// Remove all issued nums from theNym that are stored on theTempNym HERE.</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theTempNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID); i++)
            {
                int64_t lTemp = theTempNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, i);
                theNym.<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_strServerID, lTemp);
            }

            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction statement was successful.</span>

            <span class="comment">// --------------------------------------------------------------------</span>

            <span class="comment">// THE ABOVE LOOP WAS JUST A TEST RUN</span>
            <span class="comment">//</span>
            <span class="comment">// (TO **VERIFY TRANSACTION STATEMENT** BEFORE WE BOTHERED TO RUN THIS LOOP BELOW...)</span>
            <span class="comment">// (AND ALSO SO WE COULD GET THE LIST OF NUMBERS FOR THE STATEMENT ONTO TEMP NYM.)</span>

            <span class="comment">// loop through the items that make up the incoming transaction, and add them</span>
            <span class="comment">// to the Nym, and remove them from the Nymbox, as appropriate.</span>
            <span class="comment">//</span>
            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, tranIn.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
            {
                pItem = *it;
                <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Pointer should not have been NULL.&quot;</span>);

                <span class="comment">// We already handled this one (if we&#39;re even in this block in the first place.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                {
                    <span class="keywordflow">continue</span>;
                }

                <span class="comment">// If the client sent an accept item then let&#39;s process it.</span>
                <span class="keywordflow">if</span> (
                    (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                    &amp;&amp;
                    (
                     (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>== pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Clearing out a finalReceipt notice.</span>
                     (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepting new transaction number.</span>
                     (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>     == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || <span class="comment">// Accepted message.</span>
                     (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>      == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())    <span class="comment">// Accepted server notification.</span>
                    )
                   )
                {
                    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;

                    <span class="comment">// The response item will contain a copy of the &quot;accept&quot; request.</span>
                    <span class="comment">// So I&#39;m just setting aside a copy now for those purposes later.</span>
                    pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);

                    <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType;
                    <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                    {
                        <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>:
                            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>;
                            <span class="keywordflow">break</span>;
                        <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>:
                            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>;
                            <span class="keywordflow">break</span>;
                        <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>:
                            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>;
                            <span class="keywordflow">break</span>;
                        <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>:
                            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>;
                            <span class="keywordflow">break</span>;
                        <span class="keywordflow">default</span>:
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Should never happen.\n&quot;</span>);
                            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>; <span class="comment">// should never happen based on above &#39;if&#39; statement.</span>
                            <span class="keywordflow">continue</span>;                                   <span class="comment">// saving this anyway just cause it&#39;s cleaner.</span>
                    }


                    <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
                    <span class="comment">// They&#39;re getting SOME sort of response item.</span>

                    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, theReplyItemType);
                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
<span class="comment">//                  pResponseItem-&gt;SetReferenceToNum(pItem-&gt;GetTransactionNum()); // This was just 0 every time, since Nymbox needs no transaction numbers.</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// So the reference was useless. I&#39;m hoping to change it to this and make sure nothing breaks.</span>
                                                                                  <span class="comment">// ReferenceNum actually means you can match it up against the request items, and also, that is where THEY store it.</span>
                    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>


                    <span class="comment">// *******************************************************************************************</span>


                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;

                    <span class="keywordflow">if</span> (
                             (NULL != (pServerTransaction = theNymbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())))
                             &amp;&amp;
                             (
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>      == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// finalReceipt (notice that an opening num was closed.)</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>             == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// new transaction number waiting to be picked up.</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>           == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// message in the nymbox</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>       == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// replyNotice containing a server reply to a previous request. (Some replies are so important, this is used to make sure users get them.)</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>     == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// successNotice that you signed out a transaction#.</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>            == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||    <span class="comment">// server notification, in the nymbox</span>
                              (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>  == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())       <span class="comment">// A financial instrument sent from another user. (Nymbox=&gt;PaymentInbox)</span>
                             )
                       )
                    {
                        <span class="comment">// the accept item will come with the transaction number that</span>
                        <span class="comment">// it&#39;s referring to. So we&#39;ll just look up that transaction</span>
                        <span class="comment">// in the nymbox, and now that it&#39;s been accepted, we&#39;ll process it.</span>

                        <span class="comment">// At this point, pItem points to the client&#39;s attempt to accept pServerTransaction</span>
                        <span class="comment">// and pServerTransaction is the server&#39;s created transaction in my nymbox that might</span>
                        <span class="comment">// have a message or transaction number on it I might find useful.</span>


                        <span class="comment">// What are we doing in this code?</span>
                        <span class="comment">//</span>
                        <span class="comment">// I need to accept various items that are sitting in my nymbox, such as:</span>
                        <span class="comment">//</span>
                        <span class="comment">// -- transaction numbers waiting to be accepted (they cannot be rejected.)</span>
                        <span class="comment">//</span>
                        <span class="comment">// -- messages waiting to be accepted (they cannot be rejected.)</span>
                        <span class="comment">//</span>

                        <span class="comment">// ----------------------------------------------------------------------------------------------</span>

                        <span class="comment">// The below block only executes for ACCEPTING a MESSAGE</span>
                        <span class="keywordflow">if</span> (
                            (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>  == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                            &amp;&amp;
                            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                            )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the</span>
                            <span class="comment">// [&#39;message&#39;] located in pServerTransaction.</span>
                            <span class="comment">// Now we have the user&#39;s item and the item he is trying to accept.</span>
                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theNymbox); <span class="comment">// faster.</span>
<span class="comment">//                          theNymbox.  DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theNymbox.  RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theNymbox.  ReleaseSignatures();
                            theNymbox.  SignContract(m_nymServer);
                            theNymbox.  SaveContract();
                            theNymbox.  SaveNymbox();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }<span class="comment">// its type is OTItem::aacceptMessage</span>


                        <span class="comment">// The below block only executes for ACCEPTING a NOTICE</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                                 (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>  == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                 &amp;&amp;
                                 (
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>            == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>       == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>     == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                                  (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>  == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                  )
                                 )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the</span>
                            <span class="comment">// [&#39;notice&#39;] or replyNotice or successNotice or instrumentNotice</span>
                            <span class="comment">// located in pServerTransaction.</span>
                            <span class="comment">// Now we have the user&#39;s item and the item he is trying to accept.</span>

                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theNymbox); <span class="comment">// faster.</span>
<span class="comment">//                          theNymbox.  DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theNymbox.  RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theNymbox.  ReleaseSignatures();
                            theNymbox.  SignContract(m_nymServer);
                            theNymbox.  SaveContract();
                            theNymbox.  SaveNymbox();

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                        }<span class="comment">// its type is OTItem::acceptNotice</span>


                        <span class="comment">// The below block only executes for ACCEPTING a TRANSACTION NUMBER</span>
                        <span class="comment">// It also places a success notice into the Nymbox, to solve sync issues.</span>
                        <span class="comment">// (We&#39;ll make SURE the client got the notice! Probably should do this</span>
                        <span class="comment">// for cash withdrawals as well...)</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                                 (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                 &amp;&amp;
                                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                )
                        {
                            <span class="comment">// -----------------------------------------------</span>
                            <span class="comment">// Add the success notice to the Nymbox, so if the Nym fails to see the server reply, he can still get his</span>
                            <span class="comment">// transaction # later, from the notice, instead of going out of sync.</span>
                            <span class="comment">//</span>
                            int64_t lSuccessNoticeTransNum=0;
                            <span class="keywordtype">bool</span> bGotNextTransNum = <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lSuccessNoticeTransNum, <span class="keyword">false</span>); <span class="comment">// bool bStoreTheNumber = false</span>

                            <span class="keywordflow">if</span> (!bGotNextTransNum)
                            {
                                lSuccessNoticeTransNum = 0;
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error getting next transaction number in OTServer::NotarizeProcessNymbox for OTTransaction::blank (for the successNotice)\n&quot;</span>);
                            }
                            <span class="keywordflow">else</span>
                            {
                                <span class="comment">// Drop SUCCESS NOTICE in the Nymbox</span>
                                <span class="comment">//</span>
                                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pSuccessNotice = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theNymbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>, lSuccessNoticeTransNum);

                                <span class="keywordflow">if</span> (NULL != pSuccessNotice) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
                                {
                                    <span class="comment">// If I accepted blank trans#10, then this successNotice is in reference to #10.</span>
                                    <span class="comment">//</span>
                                    pSuccessNotice-&gt;    SetReferenceToNum(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                                    <span class="comment">// Contains a copy of the OTItem where I actually accepted the blank transaction #.</span>
                                    <span class="comment">// (which generated the notice in the first place...)</span>
                                    <span class="comment">//</span>
                                    pSuccessNotice-&gt;    SetReferenceString(strInReferenceTo);

                                    <a class="code" href="class_o_t_num_list.html">OTNumList</a> theOutput;
                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(theOutput); <span class="comment">// now theOutput contains the numlist from the server-side nymbox&#39;s copy of the blank. (containing 20 transaction #s)</span>

                                    pSuccessNotice-&gt;<a class="code" href="class_o_t_transaction.html#a492f3f835f309bd2e76e5d7cc4dc10a1">AddNumbersToTransaction</a>(theOutput); <span class="comment">// Now we add those numbers to the success notice. That way client can add those numbers to his issued and transaction lists.</span>

                                    pSuccessNotice-&gt;    SignContract(m_nymServer);
                                    pSuccessNotice-&gt;    SaveContract();

                                    theNymbox.AddTransaction(*pSuccessNotice); <span class="comment">// Add the successNotice to the nymbox. It takes ownership.</span>

                                    pSuccessNotice-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theNymbox);
                                }
                            }
                            <span class="comment">// -----------------------------------------------</span>
                            <span class="comment">// pItem contains the current user&#39;s attempt to accept the</span>
                            <span class="comment">// transaction number located in pServerTransaction.</span>
                            <span class="comment">// Now we have the user&#39;s item and the item he is trying to accept.</span>

                            <span class="comment">// Here we remove the blank transaction that was just accepted.</span>
                            <span class="comment">//</span>
                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theNymbox); <span class="comment">// faster.</span>
<span class="comment">//                          theNymbox.  DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theNymbox.  RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theNymbox.  ReleaseSignatures();
                            theNymbox.  SignContract(m_nymServer);
                            theNymbox.  SaveContract();
                            theNymbox.  SaveNymbox(&amp;NYMBOX_HASH);

                            bNymboxHashRegenerated = <span class="keyword">true</span>;

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }

                        <span class="comment">// The below block only executes for CLEARING a finalReceipt</span>
                        <span class="comment">// (an OPENING TRANSACTION NUMBER was already removed), and this was</span>
                        <span class="comment">// a notice that that had occurred. The client has seen the notice and is</span>
                        <span class="comment">// now clearing it from the box.</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                                 (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                 &amp;&amp;
                                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                 )
                        {
                            <span class="comment">// pItem contains the current user&#39;s attempt to clear the</span>
                            <span class="comment">// finalReceipt located in pServerTransaction.</span>
                            <span class="comment">// Now we have the user&#39;s item and the item he is trying to accept.</span>

                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theNymbox); <span class="comment">// faster.</span>
<span class="comment">//                          theNymbox.  DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            theNymbox.  RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            theNymbox.  ReleaseSignatures();
                            theNymbox.  SignContract(m_nymServer);
                            theNymbox.  SaveContract();
                            theNymbox.  SaveNymbox(&amp;NYMBOX_HASH);

                            bNymboxHashRegenerated = <span class="keyword">true</span>;

                            <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                            pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        }
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error finding original Nymbox transaction that client is trying to accept: %ld\n&quot;</span>,
                                      pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    }

                    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
                    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
                    <span class="comment">// is owned by the transaction, who will take it from here.</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                }
                <span class="keywordflow">else</span>
                {
                    <span class="keyword">const</span> int32_t nStatus   = pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>();
                    <a class="code" href="class_o_t_string.html">OTString</a> strItemType;
                    pItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strItemType);

                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error, unexpected item type (%s) and/or status (%d) in OTServer::NotarizeProcessNymbox\n&quot;</span>,
                                 strItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), nStatus);
                } <span class="comment">// if type == ACCEPT (only)</span>
            } <span class="comment">// for each item</span>


        } <span class="comment">// else (balance agreement verified.)</span>
    } <span class="comment">// Balance Agreement item found.</span>

    <span class="comment">// ----------------------------------------</span>
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// ----------------------------------------</span>
    tranOut.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    tranOut.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    tranOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// ----------------------------------------</span>

    <span class="keywordflow">if</span> (bNymboxHashRegenerated)
    {
        theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH); <span class="comment">// server-side</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer); <span class="comment">// todo: make objects like nym saveable and dirty-able, so they are only saved once and not multiple times redundantly.</span>
    }
    <span class="comment">// ----------------------------------------</span>

    <a class="code" href="class_o_t_string.html">OTString</a> strPath;

    <span class="comment">// On the server side, response will only have chance to succeed if balance agreement succeeds first.</span>
    <span class="comment">// Therefore, you will never see successful response but failed balance, since it would stop at the</span>
    <span class="comment">// balance and response itself would remain failed with no chance of changing.</span>
    <span class="comment">//</span>
    <span class="comment">// Thus, &quot;success&quot; must be when balance succeeded and transaction succeeded,</span>
    <span class="comment">// and &quot;failure&quot; must be when balance succeeded but transaction failed.</span>
    <span class="comment">//</span>
    <span class="comment">// If NEITHER succeeded, then there is no point recording it to a file, now is there?</span>

    <span class="keywordflow">if</span> ((NULL != pResponseBalanceItem) &amp;&amp; (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))
    {
        <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
        {
            <span class="comment">// Transaction agreement was a success, AND process nymbox was a success.</span>
            <span class="comment">// Therefore, add any new issued numbers to theNym, and save.</span>

            theNym.<a class="code" href="class_o_t_pseudonym.html#aa120e0e319f6c4f26fe68628701008fc">HarvestIssuedNumbers</a>(SERVER_ID, m_nymServer, theTempNym, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>

            bOutSuccess = <span class="keyword">true</span>;     <span class="comment">// the processNymbox was successful.</span>

            strPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>((<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;%s.success&quot;</span>, strNymID.Get());
        }
        <span class="keywordflow">else</span>
            strPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>((<span class="keywordtype">char</span>*)<span class="stringliteral">&quot;%s.fail&quot;</span>, strNymID.Get());

        <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername = <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();

        tranOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(szFoldername, strPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae784f808e73489ab4db99176eef8153c"></a><!-- doxytag: member="OTServer::NotarizeSmartContract" ref="ae784f808e73489ab4db99176eef8153c" args="(OTPseudonym &amp;theNym, OTAccount &amp;theActivatingAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae784f808e73489ab4db99176eef8153c">OTServer::NotarizeSmartContract</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theActivatingAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l07612">7612</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atSmartContract&quot;, that is, &quot;a reply to the smartContract request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem                  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem           = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will definitely be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),       ACTIVATOR_USER_ID(theNym),
                        SERVER_USER_ID(m_nymServer),    ACTIVATOR_ACCT_ID(theActivatingAccount),
                        USER_ID(theNym);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      strUserID(USER_ID);
    <span class="comment">// --------------------------------------------------------------------</span>
    pItem           = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1adb560811f0265d344fac45c9333bc25d">OTItem::smartContract</a>);
    pBalanceItem    = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
    <span class="comment">// --------------------------------------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1fe91e4cadee24de6acb9de56a55e4eb">OTItem::atSmartContract</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
        (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_smart_contract)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User %s cannot do this transaction (All smart contracts are disallowed in server.cfg)\n&quot;</span>,
                       __FUNCTION__, strUserID.Get());
    }
    <span class="comment">// For now, there should only be one of these smartContract items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pItem) || (NULL == pBalanceItem))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error, expected OTItem::smartContract and OTItem::transactionStatement.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span>
    {
        <span class="keywordflow">if</span> (ACTIVATOR_ACCT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Source account ID on the transaction does not match activator&#39;s account ID on the transaction item.\n&quot;</span>,
                           __FUNCTION__);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7df2f7973839d7a270f6ea8de67d07b4">VerifyTransactionStatement</a>(theNym, tranIn)) <span class="comment">// bIsRealTransaction=true</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying transaction statement.\n&quot;</span>, __FUNCTION__);
        }
        <span class="keywordflow">else</span>
        {
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

            <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
            <span class="comment">// here so it can be saved into the &quot;in reference to&quot; field.</span>
            pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
            pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

            <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
            <span class="comment">// They&#39;re getting SOME sort of response item.</span>

            pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
            pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
            pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

            <span class="comment">// Also load up the smart contract from inside the transaction item.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strContract;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strContract);
            <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a>(SERVER_ID);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);

            <span class="comment">// If we failed to load the smart contract...</span>
            <span class="keywordflow">if</span> ((<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strContract)))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading smart contract from string:\n\n%s\n\n&quot;</span>,
                              __FUNCTION__, strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() != SERVER_ID)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strWrongID(pContract-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad server ID (%s) on smart contract. Expected %s\n&quot;</span>,
                               __FUNCTION__, strWrongID.Get(), m_strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// CANCELING, or ACTIVATING?</span>
                <span class="comment">//</span>
                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theCancelerNymID;
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bCancelling  = (pContract-&gt;<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>() &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_cron_item.html#ac9031aa34854265423155e448be01120">GetCancelerID</a>(theCancelerNymID));
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keyword">const</span> int64_t lFoundNum    = pContract-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>();
                <span class="keyword">const</span> int64_t lExpectedNum = pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
                <span class="comment">// ----------------------------------------------------</span>
                int64_t lFoundOpeningNum = 0;
                int64_t lFoundClosingNum = 0;

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> FOUND_USER_ID;
                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> FOUND_ACCT_ID;

                <span class="keywordflow">if</span> (!bCancelling) <span class="comment">// ACTIVATING</span>
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Attempting to activate smart contract...\n&quot;</span>);

                    lFoundOpeningNum = pContract-&gt;<a class="code" href="class_o_t_cron_item.html#acd198571145b47602c121a419723b39a">GetOpeningNum</a>();
                    lFoundClosingNum = pContract-&gt;<a class="code" href="class_o_t_cron_item.html#afdbeda9f62eb4d4288d6d06ac78fcdef">GetClosingNum</a>();

                    FOUND_USER_ID    = pContract-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>();
                    FOUND_ACCT_ID    = pContract-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();
                }
                <span class="keywordflow">else</span>              <span class="comment">// CANCELING</span>
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Attempting to cancel smart contract...\n&quot;</span>);

                    lFoundOpeningNum = pContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a2bb8a0f8a1ff8ddf637e5d87d5935e51">GetOpeningNumber</a>(theCancelerNymID);  <span class="comment">// See if there&#39;s an opening number for the canceling Nym.</span>
                    lFoundClosingNum = pContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a3a9a2325c23aa03f4e6ce03fec6f69f7">GetClosingNumber</a>(ACTIVATOR_ACCT_ID); <span class="comment">// See if there&#39;s a closing number for the current account.</span>

                    <span class="keywordflow">if</span> (lFoundOpeningNum &gt; 0)
                        FOUND_USER_ID    = theCancelerNymID;
                    <span class="keywordflow">if</span> (lFoundClosingNum &gt; 0)
                        FOUND_ACCT_ID    = ACTIVATOR_ACCT_ID;
                }
                <span class="comment">// ----------------------------------------------------</span>

                <span class="keywordflow">if</span> (lFoundNum != lExpectedNum)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad main opening transaction number on smart contract. Found: %ld  Expected: %ld\n&quot;</span>
                                   <span class="stringliteral">&quot;FYI, pItem-&gt;GetTransactionNum() is %ld.\n&quot;</span>,
                                   __FUNCTION__, lFoundNum, lExpectedNum, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lFoundOpeningNum != lExpectedNum)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR bad opening transaction number on smart contract. Found: %ld  Expected: %ld\n&quot;</span>,
                                   __FUNCTION__, lFoundOpeningNum, lExpectedNum);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FOUND_USER_ID != ACTIVATOR_USER_ID)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strWrongID(ACTIVATOR_USER_ID);
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRightID(FOUND_USER_ID);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong user ID (%s) used while %s smart contract. Expected from contract: %s\n&quot;</span>,
                                   __FUNCTION__, strWrongID.Get(), bCancelling ? <span class="stringliteral">&quot;canceling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>, strRightID.Get());
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FOUND_ACCT_ID != ACTIVATOR_ACCT_ID)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderAcctID(FOUND_ACCT_ID), strActivatorAcctID(ACTIVATOR_ACCT_ID);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR wrong asset Acct ID used (%s) to %s smart contract. Expected from contract: %s\n&quot;</span>,
                                   __FUNCTION__, strActivatorAcctID.Get(), bCancelling ? <span class="stringliteral">&quot;cancel&quot;</span> : <span class="stringliteral">&quot;activate&quot;</span>, strSenderAcctID.Get());
                }
                <span class="comment">// The transaction number opens the smart contract, but there must also be a closing number for closing it.</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pContract-&gt;<a class="code" href="class_o_t_cron_item.html#a96d3ae7898526a317dd503daecbf10af">GetCountClosingNumbers</a>() &lt; 1) ||  <span class="comment">// the transaction number was verified before we entered this function, so only the closing # is left...</span>
                         !<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, lFoundClosingNum)) <span class="comment">// Verify that it can still be USED (not closed... that&#39;s VerifyIssuedNum())</span>
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ERROR: the Closing number %ld wasn&#39;t available for use while %s a smart contract.\n&quot;</span>,
                                   __FUNCTION__, lFoundClosingNum, bCancelling ? <span class="stringliteral">&quot;canceling&quot;</span> : <span class="stringliteral">&quot;activating&quot;</span>);
                }
                <span class="comment">// NOTE: since theNym has ALREADY been substituted for the Server&#39;s Nym by this point, if indeed they are the same Nym,</span>
                <span class="comment">// then I could probably just ALLOW the server to be a party to a smart contract. It will definitely be on the &quot;list of</span>
                <span class="comment">// nyms that are already loaded&quot; due to the substitution. So really it&#39;s just a matter of security review, and the below</span>
                <span class="comment">// block could be commented out (or not.)  ALSO: If I&#39;m going to enforce this, then I need to do it for ALL parties, not just</span>
                <span class="comment">// the activator!</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pContract-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() == SERVER_USER_ID) ||
                         (NULL != pContract-&gt;<a class="code" href="class_o_t_scriptable.html#aa89029542587094cd2844cb8bf7a9a16">FindPartyBasedOnNymAsAgent</a>(m_nymServer)))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ** SORRY ** but the server itself is NOT ALLOWED to be a party &quot;</span>
                                   <span class="stringliteral">&quot;to any smart contracts. (Pending security review.)\n&quot;</span>, __FUNCTION__);
                }
                <span class="comment">// *********************************************************</span>
                <span class="comment">//</span>
                <span class="comment">// VERIFY SMART CONTRACT</span>
                <span class="comment">/*</span>
<span class="comment">                 -- Loop through all parties and load up the authorizing agent&#39;s Nym, if not already loaded, for each.</span>
<span class="comment">                 -- Verify each party, that the authorizing agent is good, and verify his signature on the party&#39;s copy</span>
<span class="comment">                    of the contract.</span>
<span class="comment">                 -- Definitely during this, need to make sure that the contents of the signed version match the contents</span>
<span class="comment">                    of the main version, for each signer.</span>
<span class="comment">                 -- Verify that the authorizing agent actually has the opening transaction # for the party issued to him.</span>
<span class="comment">                 -- EVEN IF VERIFICATION FAILS HALFWAY THOUGH, REMOVE that opening transaction # for each-and-every agent.</span>
<span class="comment">                 (So he can&#39;t use it twice--leaving it as issued, but no longer as &quot;available to be used on another</span>
<span class="comment">                 transaction&quot;.) Otherwise, if verification failed halfway through, with half of the parties having their</span>
<span class="comment">                 opening numbers already burned, and the other half not, then it would be impossible to tell, based on</span>
<span class="comment">                 the failed message itself, which group YOU are in, and therefore whether YOU need to harvest that number</span>
<span class="comment">                 back or not (in order to avoid going out-of-sync.) THEREFORE WE BURN ALL OPENING NUMBERS so the client API</span>
<span class="comment">                 can just assume the opening number is burned, if the transaction ran at all. (And, as normal, if the</span>
<span class="comment">                 transaction did NOT run at all, e.g. if the message failed before the transaction had a chance to run,</span>
<span class="comment">                 then all opening numbers are still good, for all parties--including the activator.)</span>
<span class="comment"></span>
<span class="comment">                 -- NOTE: this means, if it succeeds, the opening numbers are marked as IN USE</span>
<span class="comment">                   (RemoveTransactionNum but NOT RemoveIssuedNum.) But if it FAILS, then we also need to RemoveIssuedNum...</span>
<span class="comment">                   So I&#39;m adding that to VerifySmartContract.</span>
<span class="comment"></span>
<span class="comment">                 -- Next, loop through all the asset accounts...</span>
<span class="comment">                 -- For each, get a pointer to the authorized agent and verify the CLOSING number for that asset acct.</span>
<span class="comment">                 (AND mark that number as &quot;used but still issued.&quot;) Again, do this for ALL asset accounts on the smart</span>
<span class="comment">                 contract, even if some of them fail the verification process. (It&#39;s also okay to skip the accounts for</span>
<span class="comment">                 parties who failed verification.) If anything fails, then at the very end, add the closing numbers back</span>
<span class="comment">                 again as &quot;available for use&quot; on those nyms.</span>
<span class="comment"></span>
<span class="comment">                 -- Since we&#39;re looping through all the agents, and looping through all the asset accounts, and</span>
<span class="comment">                 checking the agent for each asset account, then we might as well make sure that each agent is</span>
<span class="comment">                 a legit agent for the party, and that each account has a legit agent lording over it.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCancelling &amp;&amp; !pContract-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying canceler signature while canceling smart contract.\n&quot;</span>, __FUNCTION__);
                }

                <span class="comment">// We let it run through the verifier here, even if we are cancelling.</span>
                <span class="comment">// The reason is because this is where the various opening/closing numbers</span>
                <span class="comment">// are burned/reserved/etc. So even cancellation needs this part done.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a3b15d58a7c49d3ba2fc8a153bca6af0f">VerifySmartContract</a>(theNym, theActivatingAccount,
                                                         m_nymServer,
                                                         <span class="keyword">true</span>)) <span class="comment">// bBurnTransNo=false by default, but here we pass TRUE.</span>
                {
                    <span class="keywordflow">if</span> (bCancelling)
                    {
                        tranOut.<a class="code" href="class_o_t_transaction.html#a897714409d64aefd879ea08ec2e1731a">SetAsCancelled</a>();

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Canceling a smart contract before it was ever even activated (at user&#39;s request.)\n&quot;</span>,
                                       __FUNCTION__);
                    }
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: This smart contract has FAILED to verify.\n&quot;</span>, __FUNCTION__);

                    <span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">                     ------ TODO: Smart Contracts -----------</span>
<span class="comment"></span>
<span class="comment">                     Done:  Whenever a party confirms a smart contract (sending it on to the next party) then a copy of</span>
<span class="comment">                     the smart contract should go into that party&#39;s paymentOutbox. Same thing if the party is the last</span>
<span class="comment">                     one in the chain, and has activated it on to the server. A copy sits in the paymentOutbox until</span>
<span class="comment">                     that smart contract is either successfully activated, or FAILS to activate.</span>
<span class="comment"></span>
<span class="comment">                     If a smart contract activates, OTAgreement::DropServerNoticeToNymbox already sends an</span>
<span class="comment">                     &#39;acknowledgment&#39; notice to all parties.</span>
<span class="comment"></span>
<span class="comment">                     Done: If a smart contract fails to activate, it should ALSO send a notice (&#39;rejection&#39;) to</span>
<span class="comment">                     all parties.</span>
<span class="comment"></span>
<span class="comment">                     TODO: When a party receives a rejection notice in his Nymbox for a certain smart contract,</span>
<span class="comment">                     he looks up that same smart contract in his paymentOutbox, HARVESTS THE CLOSING NUMBERS, and</span>
<span class="comment">                     then moves the notice from his outpayments box to his recordBox.</span>
<span class="comment">                     NOTE: the notice might be in his payments inbox (sometimes) instead of his outpayments box.</span>
<span class="comment">                     Possibly even both. How so? See below. Point being: Need to check both, at this point.</span>
<span class="comment"></span>
<span class="comment">                     Until this is added, then clients will go out of sync on rejected smart contracts. (Not the kind</span>
<span class="comment">                     of out-of-sync where they can&#39;t do any transactions, but rather, the kind where they have certain</span>
<span class="comment">                     numbers signed out forever but then never use them on anything because their client thinks those</span>
<span class="comment">                     numbers were already used on a smart contract somewhere, and without the above code they would</span>
<span class="comment">                     never have clawed back those numbers.)</span>
<span class="comment">                     // ------------</span>
<span class="comment"></span>
<span class="comment">                     MORE DETAILS:</span>
<span class="comment"></span>
<span class="comment">                     *** When I send a smart contract on to the next party, remember it&#39;s sitting in my payments inbox</span>
<span class="comment">                     at first. When I confirm it, a copy goes into my outpayments box. Then when I actually SEND it, a</span>
<span class="comment">                     copy goes into my outpayments box AGAIN. (This is already smart enough to remove this first copy,</span>
<span class="comment">                     when this happens.) If I activate it (rather than sending it on, perhaps I&#39;m the last one) then it&#39;s</span>
<span class="comment">                     already in my outpayments box from the confirmation.</span>
<span class="comment"></span>
<span class="comment">                     BUT WHEN DO I REMOVE IT FROM THE payments *INBOX* ? Answer: when the successful server reply is</span>
<span class="comment">                     received from the sendUserInstrument. What if I don&#39;t send it to another user? Perhaps I activate it.</span>
<span class="comment">                     In that case, whether the activation succeeds or fails, I will get an acknowledgment (or rejection)</span>
<span class="comment">                     notice in my Nymbox. Therefore I can harvest the numbers back when that notice is received (or not.)</span>
<span class="comment">                     That will be from my outpayments box. But removing it from my INBOX should happen when I get the server</span>
<span class="comment">                     response to the activation (just as when I get the server response to sendUserInstrument.)</span>
<span class="comment">                     If I never tried to activate it, and never tried to send it to the next party, and never discarded it,</span>
<span class="comment">                     then it should remain in my inbox, until I choose to do one of those things.</span>
<span class="comment"></span>
<span class="comment"></span>
<span class="comment">                     *** The sent contract remains in the outPayments box until:</span>
<span class="comment">                        A. Activated. When: When the acknowledgment of activation is received through the Nymbox.</span>
<span class="comment">                        B. Failed activation. When: Rejection of activation received through the Nymbox.</span>
<span class="comment">                        C. Expiration. Expired notices may be harvested from the outpayments box. After all,</span>
<span class="comment">                           they were apparently never activated or even attempted, since either of those actions</span>
<span class="comment">                           would have resulted in a rejection notice which would have already removed the outpayments</span>
<span class="comment">                           box. So the transaction numbers can be harvested. BUT make sure you have latest version of</span>
<span class="comment">                           files first, so you know for sure that the contract never really was activated or attempted.</span>
<span class="comment"></span>
<span class="comment">                     *** What if the incoming smart contract is discarded, instead of confirmed?</span>
<span class="comment">                     This means it never goes into my outbox in the first place. It&#39;s in my inbox, then I discard it.</span>
<span class="comment">                     Then what? In one scenario, the user simply throws it away. He removes it from the box and never</span>
<span class="comment">                     notifies anyone. This is physically possible so we must consider it. In that case, it&#39;s still sitting</span>
<span class="comment">                     in other people&#39;s outboxes, and will eventually expire, and then those people will just harvest back</span>
<span class="comment">                     their transaction numbers. It&#39;s kind of rude not to notify them, but everything will still be OKAY.</span>
<span class="comment">                     They also still have the power, since it hasn&#39;t been activated, to &quot;false activate&quot; it, which will fail</span>
<span class="comment">                     since it&#39;s not fully-confirmed yet, and then the rejection notice will come through and remove it from</span>
<span class="comment">                     their outboxes. All parties are notified in that case.</span>
<span class="comment">                     The polite thing to do, instead of just discarding it, would be for me to do the same (false-activate it)</span>
<span class="comment">                     meaning I activate it, but without signing it. And possibly putting some other &quot;This must fail&quot; indicator</span>
<span class="comment">                     on the message, so the server doesn&#39;t waste a lot of time figuring that out. Then the failure causes all</span>
<span class="comment">                     the parties who DID sign it, to get a rejection notification, and I can remove it from my payments inbox at</span>
<span class="comment">                     that time, when they are all removing it from their outboxes.</span>
<span class="comment"></span>
<span class="comment">                     *** What if the incoming contract is discarded AFTER it was confirmed? From the outbox, meaning it hasn&#39;t</span>
<span class="comment">                     been activated yet. Perhaps I sent someone a cheque that hasn&#39;t been cashed yet. Perhaps I sent someone</span>
<span class="comment">                     a signed smart contract but they haven&#39;t activated it yet. Therefore I still have a chance to cancel it.</span>
<span class="comment">                     I can&#39;t just discard it, since they can still deposit their copy whenever they want. But if I RUN IT THROUGH,</span>
<span class="comment">                     then it will be INVALIDATED thereafter -- and if I beat them to the punch, then it will work. Of course, if</span>
<span class="comment">                     they activate it, then I will get an activation notice, which will automatically remove it from my outbox.</span>
<span class="comment">                     So I beat them to the punch, by activating / depositing it myself, which fails, and then we both get rejection</span>
<span class="comment">                     notices. That removes it from my outbox, as well as the inbox of the guy who I had been stuck waiting on in</span>
<span class="comment">                     the first place.</span>
<span class="comment"></span>
<span class="comment"></span>
<span class="comment">                     WHY WAS IT in whichever box it was in? (Just curious.) Well...</span>
<span class="comment">                     If inbox, because I discarded it without confirming, yet wanted to be nice and let people who</span>
<span class="comment">                     had, harvest their numbers back. (Otherwise they&#39;d still eventually expire.) If outpayments box,</span>
<span class="comment">                     because I activated it (so it&#39;s in that box) and it&#39;s just legitimately a failed attempt on my</span>
<span class="comment">                     part, or because I confirmed it and sent to the next guy, and he hasn&#39;t activated it yet, and</span>
<span class="comment">                     I&#39;ve changed my mind and wish to cancel it. Either way, once I do, I will get the notice (as will</span>
<span class="comment">                     any other parties) and then it will be removed from that box (and placed in the records box.)</span>
<span class="comment">                     Another scenario: It&#39;s removed from my inbox when some other confirming party &quot;false activates&quot; it</span>
<span class="comment">                     in order to cancel it and remove it from his outbox. He HAD been sitting there waiting on me, while</span>
<span class="comment">                     the notice sat in my inbox. But now that it&#39;s been invalidated at the server, I will get a rejection</span>
<span class="comment">                     notice from the server which should remove the one that was sitting in my inbox, to the record box.</span>
<span class="comment"></span>
<span class="comment">                     // ---------------</span>
<span class="comment"></span>
<span class="comment">                     ACTIONS:</span>
<span class="comment"></span>
<span class="comment">                     -- When successful &quot;sendUserInstrument&quot; server reply is received,</span>
<span class="comment">                        remove that instrument from payments inbox. (If it&#39;s there -- it can be.)</span>
<span class="comment"></span>
<span class="comment">                     -- When party receives notice that smart contract has been activated,</span>
<span class="comment">                        remove the instrument from outpayments box. (If it&#39;s there -- it can be.)</span>
<span class="comment"></span>
<span class="comment">                     -- When party receives notice that smart contract has failed activation attempt, then remove</span>
<span class="comment">                        the instrument from payments inbox AND outpayments box. (If there -- could be for either.)</span>
<span class="comment"></span>
<span class="comment">                     Does this cover all cases?</span>
<span class="comment"></span>
<span class="comment">                     -- Any _sent_ instrument will properly be removed from the payments inbox.</span>
<span class="comment">                     -- It will go into the outpayments box. Once it activates, it will be removed again from that box. (For all parties.)</span>
<span class="comment">                     -- If it fails to activate, or if a party discards it from inbox (through a deliberate failed activation) or if a party</span>
<span class="comment">                        discards it from the outbox (through a deliberate failed activation) either way, it will be removed from both boxes.</span>
<span class="comment">                     -- If it expires while sitting in my inbox, my high-level API is responsible to remove it and harvest the numbers.</span>
<span class="comment">                     -- It if expires while sitting in my outbox, my high-level API is responsible to remove it and harvest the numbers.</span>
<span class="comment"></span>
<span class="comment">                     It can be sent, discarded (from outbox, as a scramble-to-discard-it-before-next-guy-deposits it), discarded (from inbox,</span>
<span class="comment">                     when I decide I won&#39;t sign it), it can be ignored until expiration (either box), and it can legitimately activate or fail</span>
<span class="comment">                     to activate, and either way, all the parties who confirmed it will get a notice and harvest (if necessary.)</span>
<span class="comment"></span>
<span class="comment">                     THIS SEEMS TO COVER ALL CASES!</span>
<span class="comment"></span>
<span class="comment">                     One more thing, just noticed: Whether success or fail, the opening AND closing numbers are marked as &quot;used but not closed&quot;</span>
<span class="comment">                     on the Nym&#39;s record. We do this above for all Nyms just doing verification, since we can&#39;t fail halfway through and have</span>
<span class="comment">                     inconsistent results between them. (All or nothing.)</span>
<span class="comment"></span>
<span class="comment">                     THERFORE: 1. When the Nyms receive &quot;SUCCESS&quot; activating the smart contract, they ALL know that the opening AND closing</span>
<span class="comment">                     numbers are marked off as used, and can only be closed thereafter through the final receipt. 2. When the Nyms receive</span>
<span class="comment">                     FAILED activating the smart contract... Do they harvest the numbers back? NOT if they were all marked off already! So</span>
<span class="comment">                     next, if failure here I need to mark them all as closed, right? Since we failed? And then the client side, when he gets</span>
<span class="comment">                     the notice, he needs to mark them as closed as well. (NOT harvest them.) We could alternately mark them all as &quot;still</span>
<span class="comment">                     available&quot; on the server side (or all closing numbers anyway) and mark all the opening numbers as closed. But whatever we</span>
<span class="comment">                     do, the client side needs to do the same thing.</span>
<span class="comment">                     The only time we harvest ALL the numbers is then when we haven&#39;t even sent it to the server yet? Otherwise we mark them</span>
<span class="comment">                     as &quot;used and not closed&quot; (if success) or if failure, we mark them as:  ????? Perhaps all still open except the main opening</span>
<span class="comment">                     one? Or perhaps all the closing numbers are still available and the opening numbers are burned? Or just ALL numbers are</span>
<span class="comment">                     burned? Which? Why?</span>
<span class="comment"></span>
<span class="comment">                     NOTE: I found the answer in the comments in OTSmartContract::VerifySmartContract. (And there are very good reasons</span>
<span class="comment">                     involved for why I went the way that I did. Read it for those reasons.) Conclusion:</span>
<span class="comment"></span>
<span class="comment">                     If there is a failed activation attempt, then all parties get a notice, and all parties can CLOSE the opening number,</span>
<span class="comment">                     which was burned, and they can HARVEST the closing numbers, which were made new again.</span>
<span class="comment"></span>
<span class="comment">                     But if the activation attempt succeeded, then all parties get a notice, and all parties will continue as they were:</span>
<span class="comment">                     with the opening AND closing numbers marked as &quot;Still issued but in use.&quot; Their opening numbers will not close until</span>
<span class="comment">                     the smart contract is deactivated, and their closing numbers will not close until their final receipts have been closed.</span>
<span class="comment">                     You might ask, &quot;Then why send the notice, if the transaction numbers are already set up correctly on the client side?&quot;</span>
<span class="comment">                     The answer is, because the client still does things based on that notice. Like for example, it removes the confirmed</span>
<span class="comment">                     copy of that smart contract from its outpayments box.</span>
<span class="comment"></span>
<span class="comment">                    */</span>

                    <span class="comment">// DROP REJECTION NOTICE HERE TO ALL PARTIES....</span>
                    <span class="comment">// SO THEY CAN CLAW BACK THEIR TRANSACTION #s....</span>
                    <span class="comment">//</span>
                    int64_t lNewTransactionNumber = 0;
                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a03d724ec348f2dc140c9ed45d6133429">SendNoticeToAllParties</a>(<span class="keyword">false</span>, <span class="comment">//bSuccessMsg=false (OTItem::rejection)</span>
                                                                   m_nymServer, SERVER_ID,
                                                                   lNewTransactionNumber,
    <span class="comment">//                                                             pContract-&gt;GetTransactionNum(), // Each party has its own opening number. Handled internally.</span>
                                                                   strContract,
                                                                   NULL, NULL, &amp;theNym))
                    {
                        <span class="comment">// NOTE: A party may deliberately try to activate a smart contract without signing it.</span>
                        <span class="comment">// (As a way of rejecting it.) This will cause rejection notices to go to all the other</span>
                        <span class="comment">// parties, allowing them to harvest back their closing numbers.</span>
                        <span class="comment">// Since that is expected to happen, that means if you have 5 parties, and the 3rd one</span>
                        <span class="comment">// &quot;activates&quot; the contract, then this piece of code here will DEFINITELY fail to send</span>
                        <span class="comment">// the rejection notice to the last 2 parties (since they hadn&#39;t even signed the contract</span>
                        <span class="comment">// yet.)</span>
                        <span class="comment">//</span>
                        <span class="comment">// (Since we expect that to normally happen, we don&#39;t log an error here.)</span>

    <span class="comment">//                  OTLog::vOutput(0, &quot;%s: Failed notifying all parties about failed activation of smart contract: %ld.\n&quot;,</span>
    <span class="comment">//                                 __FUNCTION__, pContract-&gt;GetTransactionNum());</span>
                    }
                } <span class="comment">// smart contract is no good.</span>
                <span class="comment">// *********************************************************</span>
                <span class="comment">// The smart contract is good...</span>
                <span class="comment">//</span>
                <span class="comment">// NOTIFY ALL PARTIES and ACTIVATE.</span>
                <span class="comment">//</span>
                <span class="comment">// This is important to notify first, because the hooks in OTSmartContract::onActivate() could very</span>
                <span class="comment">// potentially trigger MORE receipts, and we want to make sure the activation receipt comes first.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span>
                {
                    int64_t lNewTransactionNumber = 0;
                    <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a03d724ec348f2dc140c9ed45d6133429">SendNoticeToAllParties</a>(<span class="keyword">true</span>, <span class="comment">//bSuccessMsg=true</span>
                                                                   m_nymServer, SERVER_ID,
                                                                   lNewTransactionNumber,
<span class="comment">//                                                                 pContract-&gt;GetTransactionNum(), // Each party has its own opening number. Handled internally.</span>
                                                                   strContract,
                                                                   NULL, NULL, &amp;theNym))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed notifying parties while trying to activate smart contract: %ld.\n&quot;</span>,
                                       __FUNCTION__, pContract-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                    }
                    <span class="comment">// -----------------------------------------------------</span>
                    <span class="comment">// Add it to Cron...</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_Cron.<a class="code" href="class_o_t_cron.html#a2d42c183c174f56a7c7c3da1e844a53f">AddCronItem</a>(*pContract, &amp;theNym, <span class="keyword">true</span>, <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>())) <span class="comment">// bSaveReceipt=true</span>
                    {
                        <span class="comment">// We add the smart contract to the server&#39;s Cron object, which does regular processing.</span>
                        <span class="comment">// That object will take care of processing the smart contract according to its terms.</span>
                        <span class="comment">//</span>
                        <span class="comment">// NOTE: FYI, inside AddCronItem, since this is a new CronItem, a Cron Receipt will</span>
                        <span class="comment">// be saved with the User&#39;s signature on it, containing the Cron Item from the user&#39;s</span>
                        <span class="comment">// original request. After that, the item is stored internally to Cron itself, and</span>
                        <span class="comment">// signed by the server--and changes over time as cron processes. (The original receipt</span>
                        <span class="comment">// can always be loaded when necessary.)</span>
                        <span class="comment">//</span>

                        <span class="comment">// Now we can set the response item as an acknowledgement instead of rejection (the default)</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);
                        bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The smart contract activation was successful.</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Successfully added smart contract to Cron object.\n&quot;</span>,
                                       __FUNCTION__);
                    } <span class="comment">// If smart contract verified.</span>
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to add smart contract to Cron object.\n&quot;</span>,
                                       __FUNCTION__);
                    }
                } <span class="comment">// contract verifies, activate it.</span>
            } <span class="comment">// else</span>
            <span class="comment">// ------------------------------------------------------------------------</span>
            <span class="comment">// If the smart contract WAS successfully added to Cron, then we don&#39;t need to</span>
            <span class="comment">// delete it here, since Cron owns it now, and will deal with cleaning</span>
            <span class="comment">// it up at the right time. (So I can&#39;t use OTCleanup on pContract.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> ((NULL != pContract) &amp;&amp; (pResponseItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>() != <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>))
            {
                <span class="keyword">delete</span> pContract;
                pContract = NULL;
            }
        } <span class="comment">// if pItem = tranIn.GetItem(OTItem::smartContract)</span>
    }

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4f55f071e6a561a33917a9a583c1da87"></a><!-- doxytag: member="OTServer::NotarizeTransaction" ref="a4f55f071e6a561a33917a9a583c1da87" args="(OTPseudonym &amp;theNym, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a4f55f071e6a561a33917a9a583c1da87">OTServer::NotarizeTransaction</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>If the server receives a notarizeTransactions command, it will be accompanied by a payload containing a ledger to be notarized. UserCmdNotarizeTransactions will loop through that ledger, and for each transaction within, it calls THIS method. TODO think about error reporting here and sending a message back to user. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l09531">9531</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span> bSuccess = bOutSuccess = <span class="keyword">false</span>;

    <span class="keyword">const</span>   int64_t         lTransactionNumber = tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
    <span class="keyword">const</span>   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    SERVER_ID(m_strServerID);
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    USER_ID;
    theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(   USER_ID);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDNym (USER_ID);

    <a class="code" href="class_o_t_account.html">OTAccount</a> theFromAccount(USER_ID, tranIn.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>(), SERVER_ID);

    <span class="comment">// Make sure the &quot;from&quot; account even exists...</span>
    <span class="keywordflow">if</span> (!theFromAccount.LoadContract())
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDAcct(tranIn.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>());
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading asset account: %s\n&quot;</span>,
                       __FUNCTION__, strIDAcct.Get());
    }
    <span class="comment">// Make sure the &quot;from&quot; account isn&#39;t marked for deletion.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theFromAccount.IsMarkedForDeletion())
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDAcct(tranIn.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>());
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed attempt to use an Asset account that was marked for deletion: %s\n&quot;</span>,
                       __FUNCTION__, strIDAcct.Get());
    }
    <span class="comment">// Make sure the Account ID loaded from the file matches the one we just set and used as the filename.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theFromAccount.VerifyContractID())
    {
        <span class="comment">// this should never happen. How did the wrong ID get into the account file, if the right</span>
        <span class="comment">// ID is on the filename itself? and vice versa.</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIDAcct(tranIn.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>());
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error verifying account ID: %s\n&quot;</span>, __FUNCTION__, strIDAcct.Get());
    }
    <span class="comment">// Make sure the nymID loaded up in the account as its actual owner matches the nym who was</span>
    <span class="comment">// passed in to this function requesting a transaction on this account... otherwise any asshole</span>
    <span class="comment">// could do transactions on your account, no?</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theFromAccount.VerifyOwner(theNym))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idAcct(theFromAccount);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strIDAcct(idAcct);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error verifying account ownership... Nym: %s  Acct: %s\n&quot;</span>,
                       __FUNCTION__, strIDNym.Get(), strIDAcct.Get());
    }
    <span class="comment">// Make sure I, the server, have signed this file.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theFromAccount.VerifySignature(m_nymServer))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idAcct(theFromAccount);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strIDAcct(idAcct);
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error verifying server signature on account: %s for Nym: %s\n&quot;</span>,
                      __FUNCTION__, strIDAcct.Get(), strIDNym.Get());
    }
    <span class="comment">// No need to call VerifyAccount() here since the above calls go above and beyond that method.</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, lTransactionNumber))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idAcct(theFromAccount);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strIDAcct(idAcct);
        <span class="comment">// The user may not submit a transaction using a number he&#39;s already used before.</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error verifying transaction number %ld on user Nym: %s Account: %s\n&quot;</span>,
                       __FUNCTION__, lTransactionNumber, strIDNym.Get(), strIDAcct.Get());
    }

    <span class="comment">// The items&#39; acct and server ID were already checked in VerifyContractID() when they were loaded.</span>
    <span class="comment">// Now this checks a little deeper, to verify ownership, signatures, and transaction number</span>
    <span class="comment">// on each item.  That way those things don&#39;t have to be checked for security over and over</span>
    <span class="comment">// again in the subsequent calls.</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!tranIn.<a class="code" href="class_o_t_transaction.html#a196bf845f57deaf4e04493e462fd6d97">VerifyItems</a>(theNym))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idAcct(theFromAccount);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strIDAcct(idAcct);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error verifying transaction items. Trans: %ld Nym: %s  Account: %s\n&quot;</span>,
                       __FUNCTION__, lTransactionNumber, strIDNym.Get(), strIDAcct.Get());
    }

    <span class="comment">// any other security stuff?</span>
    <span class="comment">// Todo do I need to verify the server ID here as well?</span>
    <span class="keywordflow">else</span>
    {
        <span class="comment">// We don&#39;t want any transaction number being used twice.</span>
        <span class="comment">// (The number, at this point, is STILL issued to the user, who is still responsible</span>
        <span class="comment">// for that number and must continue signing for it. All this means here is that the</span>
        <span class="comment">// user no longer has the number on his AVAILABLE list. Removal from issued list happens separately.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, lTransactionNumber, <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error removing transaction number (as available) from user nym in OTServer::NotarizeTransaction\n&quot;</span>);
        }
        <span class="comment">// -------------------------------------------------------------------</span>
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

            <span class="keywordflow">switch</span> (tranIn.<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
            {
                    <span class="comment">// TRANSFER (account to account)</span>
                    <span class="comment">// Alice sends a signed request to the server asking it to</span>
                    <span class="comment">// transfer from her account ABC to the inbox of account DEF.</span>
                    <span class="comment">// A copy will also remain in her outbox until canceled or accepted.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Transfer\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#a36c6f177e0884b05f3ae76b3dcb4f3dd">NotarizeTransfer</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac310111eca8eb295fb5dafddd884fc82">OTItem::atTransfer</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// PROCESS INBOX (currently, all incoming transfers must be accepted.)</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to reject</span>
                    <span class="comment">// some of his inbox items and/or accept some into his account DEF.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Process Inbox\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#ae8313723858633f63bbdeec9a1d6e1f1">NotarizeProcessInbox</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
<span class="comment">//                  theReplyItemType = OTItem::atProcessInbox; // Nonexistent, and here, unused.</span>
                    <span class="comment">// (There is a processInbox message that carries that transaction...)</span>
                    <span class="keywordflow">break</span>;

                    <span class="comment">// WITHDRAWAL (cash or voucher)</span>
                    <span class="comment">// Alice sends a signed request to the server asking it to debit her</span>
                    <span class="comment">// account ABC and then issue her a purse full of blinded cash tokens</span>
                    <span class="comment">// --OR-- a voucher (a cashier&#39;s cheque, made out to any recipient&#39;s</span>
                    <span class="comment">// User ID, or made out to a blank recipient, just like a blank cheque.)</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>:
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemVoucher = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>);
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCash    = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>);

                    <span class="keywordflow">if</span> (NULL != pItemCash)
                    {
                        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>;
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Withdrawal (cash)\n&quot;</span>);
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pItemVoucher)
                    {
                        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>;
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Withdrawal (voucher)\n&quot;</span>);
                    }
                    <span class="comment">// ------------------------------------------------</span>
                    <a class="code" href="class_o_t_server.html#a81f81918e187bf2c62bfb413a9db13ab">NotarizeWithdrawal</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                }
                    <span class="keywordflow">break</span>;

                    <span class="comment">// DEPOSIT  (cash or cheque)</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to deposit into his</span>
                    <span class="comment">// account ABC. He includes with his request a signed cheque made out to</span>
                    <span class="comment">// Bob&#39;s user ID (or blank), --OR-- a purse full of tokens.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Deposit\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#a63d1bff954081d9f73f50c41756d4573" title="for depositing a cheque or cash.">NotarizeDeposit</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// PAY DIVIDEND</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to pay all shareholders</span>
                    <span class="comment">// of a given asset type at the rate of $X per share, where X and $ are both</span>
                    <span class="comment">// configurable.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Pay Dividend\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#aeb24d887eb3c2394ab446e18b8f7a9b0">NotarizePayDividend</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// MARKET OFFER</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to put an offer</span>
                    <span class="comment">// on the market. He includes with his request a signed trade listing</span>
                    <span class="comment">// the relevant information, asset types and account IDs.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Market Offer\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#ae0494b71bb963f7a5e56d3f1134e280d" title="a user is exchanging in or out of a basket. (Ex. He&#39;s trading 2 gold and 3 silver for 10 baskets...">NotarizeMarketOffer</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a229f0c7ace7a51840d7632910a0b92a6">OTItem::atMarketOffer</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// PAYMENT PLAN</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to make regular</span>
                    <span class="comment">// payments to Alice. (BOTH Alice AND Bob must have signed the same contract.)</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Payment Plan\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#aa5fbf4c29c1e9428924a7278f2f3cff0">NotarizePaymentPlan</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afbc3c7556a790e7a7b6be464f8ea058b">OTItem::atPaymentPlan</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// SMART CONTRACT</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to activate a smart contract.</span>
                    <span class="comment">// Bob is the authorizing agent for one of the parties, all of whom have signed it,</span>
                    <span class="comment">// and have provided transaction #s for it.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>:
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Smart Contract\n&quot;</span>);

                    <span class="comment">// For all transaction numbers used on cron items, we keep track of them in</span>
                    <span class="comment">// the GetSetOpenCronItems. This will be removed again below, if the transaction</span>
                    <span class="comment">// fails.</span>
                    std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
                    theIDSet.insert(lTransactionNumber);
                    <span class="comment">// ----------------------------------------------</span>
                    <a class="code" href="class_o_t_server.html#ae784f808e73489ab4db99176eef8153c">NotarizeSmartContract</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1fe91e4cadee24de6acb9de56a55e4eb">OTItem::atSmartContract</a>;
                }
                    <span class="keywordflow">break</span>;

                    <span class="comment">// CANCEL CRON ITEM</span>
                    <span class="comment">// (Cron items: market offers, payment plans...)</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to cancel a</span>
                    <span class="comment">// REGULARLY PROCESSING CONTRACT that he had previously created.</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: cancelCronItem\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#a21421671206f26b76c61406e95fde3af">NotarizeCancelCronItem</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ab3ded9d37de3a75d4b39735bb9aff341">OTItem::atCancelCronItem</a>;
                    <span class="keywordflow">break</span>;

                    <span class="comment">// EXCHANGE BASKET</span>
                    <span class="comment">// Bob sends a signed request to the server asking it to exchange funds</span>
                    <span class="comment">// in or out of a basket currency. (From-or-to his main basket account and his</span>
                    <span class="comment">// various sub-accounts for each member currency in the basket.)</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>:
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;NotarizeTransaction type: Exchange Basket\n&quot;</span>);
                    <a class="code" href="class_o_t_server.html#a061c83978f4cb2fdf6f13e3600790b0a">NotarizeExchangeBasket</a>(theNym, theFromAccount, tranIn, tranOut, bOutSuccess);
                    bSuccess = <span class="keyword">true</span>;
                    theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0b62f8efea6ed9bdefbc48ce2e97a8b6">OTItem::atExchangeBasket</a>;
                    <span class="keywordflow">break</span>;

                <span class="keywordflow">default</span>:
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error, unexpected type: %s\n&quot;</span>, __FUNCTION__, tranIn.<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
                    <span class="keywordflow">break</span>;
            }

            <span class="comment">// ------------------------------------------</span>

            <span class="comment">// Where appropriate, remove a transaction number from my issued list</span>
            <span class="comment">// (the list of numbers I must sign for in every balance agreement.)</span>
            <span class="keywordtype">bool</span> bIsCronItem = <span class="keyword">false</span>;

            <span class="keywordflow">switch</span> (tranIn.<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
            {
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>:
                    bIsCronItem = <span class="keyword">true</span>; <span class="comment">// Falls through...</span>

                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>:
                    <span class="comment">// If success, then Issued number stays on Nym&#39;s issued list until the transfer, paymentPlan, marketOffer, or smart</span>
                    <span class="comment">// contract is entirely closed and removed. In the case of transfer, that&#39;s when the transfer receipt is accepted.</span>
                    <span class="comment">// In the case of markets and paymentplans, that&#39;s when they&#39;ve been entirely removed from Cron (many</span>
                    <span class="comment">// intermediary receipts might occur before that happens.) At that time, a final receipt is issued with</span>
                    <span class="comment">// a closing transaction number (to make sure the user closes all of the related market receipts.)</span>
                    <span class="comment">//</span>
                    <span class="comment">// But if failure, then Issued number is immediately removed.</span>
                    <span class="comment">// (It already can&#39;t be used again, and there&#39;s no receipt to clear later, thus no reason to save it...)</span>
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = tranOut.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theReplyItemType);

                    <span class="keywordflow">if</span> ((NULL != pItem))
                    {
                        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                        {
                            <span class="comment">// If this is a cron item, then we need to remove it from the</span>
                            <span class="comment">// list of open cron items as well.</span>
                            <span class="keywordflow">if</span> (bIsCronItem)
                            {
                                std::set&lt;int64_t&gt; &amp; theIDSet = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();
                                std::set&lt;int64_t&gt;::iterator theSetIT = theIDSet.find(lTransactionNumber);
                                <span class="keywordflow">if</span> (theSetIT != theIDSet.end()) <span class="comment">// Found it.</span>
                                    theIDSet.erase(lTransactionNumber);
                            }
                            <span class="comment">// --------------------------------------------------------------------</span>
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>(theNym, lTransactionNumber, <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                            {
                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number %ld from user nym: %s\n&quot;</span>,
                                              __FUNCTION__, lTransactionNumber, strNymID.Get());
                            }
                        }
                    }
                }
                    <span class="keywordflow">break</span>;
                <span class="comment">// ------------------------------------------</span>
                    <span class="comment">// In the case of the below transaction types, the transaction number is removed from the Nym&#39;s</span>
                    <span class="comment">// issued list SUCCESS OR FAIL. (It&#39;s closed either way.)</span>
                    <span class="comment">//</span>
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>:
                <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>:
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>(theNym, lTransactionNumber, <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                    {
                        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number %ld from user nym: %s\n&quot;</span>,
                                      __FUNCTION__, lTransactionNumber, strNymID.Get());
                    }
                    <span class="keywordflow">break</span>;
                <span class="comment">// ------------------------------------------</span>
                <span class="keywordflow">default</span>:
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error, unexpected type: %s\n&quot;</span>,
                                  __FUNCTION__, tranIn.<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
                    <span class="keywordflow">break</span>;
            }
        }
    }

    <span class="comment">// sign the outoing transaction</span>
    tranOut.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    tranOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();  <span class="comment">// don&#39;t forget to save (to internal raw file member)</span>

    <span class="comment">// Contracts store an internal member that contains the &quot;Raw File&quot; contents</span>
    <span class="comment">// That is, the unsigned XML portion, plus the signatures, attached in a standard</span>
    <span class="comment">// PGP-compatible format. It&#39;s not enough to sign it, you must also save it into</span>
    <span class="comment">// that Raw file member variable (using SaveContract) and then you must sometimes</span>
    <span class="comment">// THEN save it into a file (or a string or wherever you want to put it.)</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a36c6f177e0884b05f3ae76b3dcb4f3dd"></a><!-- doxytag: member="OTServer::NotarizeTransfer" ref="a36c6f177e0884b05f3ae76b3dcb4f3dd" args="(OTPseudonym &amp;theNym, OTAccount &amp;theFromAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a36c6f177e0884b05f3ae76b3dcb4f3dd">OTServer::NotarizeTransfer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theFromAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l03943">3943</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atTransfer&quot;, that is, &quot;a reply to the transfer request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),       USER_ID(theNym),    ACCOUNT_ID(theFromAccount),
                        ASSET_TYPE_ID(theFromAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());

    <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAccountID(ACCOUNT_ID);
    <span class="comment">// --------------------</span>
    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac310111eca8eb295fb5dafddd884fc82">OTItem::atTransfer</a>);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------</span>

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_transfer))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: User %s cannot do this transaction (All acct-to-acct transfers are disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// --------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pBalanceItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>)))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Expected OTItem::balanceStatement in trans# %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// For now, there should only be one of these transfer items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>)))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Expected OTItem::transfer in trans# %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ACCOUNT_ID == pItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>())
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Failed attempt by user %s in trans# %ld, to transfer money \&quot;To the From Acct\&quot;: \n\n%s\n\n&quot;</span>,
                       strUserID.Get(), tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// The response item, as well as the inbox and outbox items, will contain a copy</span>
        <span class="comment">// of the request item. So I save it into a string here so they can all grab a copy of it</span>
        <span class="comment">// into their &quot;in reference to&quot; fields.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// IDFromAccount is the ID on the &quot;from&quot; Account that was passed in.</span>
        <span class="comment">// IDItemFromAccount is the &quot;from&quot; account ID on the transaction Item we are currently examining.</span>
        <span class="comment">// IDItemToAccount is the &quot;to&quot; account ID on the transaction item we are currently examining.</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> IDFromAccount(theFromAccount);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

<span class="comment">//      OTString strTestInRefTo2;</span>
<span class="comment">//      pResponseItem-&gt;GetReferenceString(strTestInRefTo2);</span>
<span class="comment">//      OTLog::Error(&quot;DEBUG: Item in reference to: %s\n&quot;, strTestInRefTo2.Get());</span>

        <span class="comment">// Set the ID on the To Account based on what the transaction request said. (So we can load it up.)</span>
        <a class="code" href="class_o_t_account.html">OTAccount</a> * pDestinationAcct = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>(), SERVER_ID);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theDestAcctGuardian(pDestinationAcct); <span class="comment">// This is safe in cases where NULL is returned. No more need to cleanup pDestAcct.</span>

        <span class="comment">// Only accept transfers with positive amounts.</span>
        <span class="keywordflow">if</span> (0 &gt; pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>())
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Failure: Attempt to transfer negative balance.\n&quot;</span>);
        }

        <span class="comment">// I&#39;m using the operator== because it exists.</span>
        <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
        <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(IDFromAccount == pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Error: &#39;From&#39; account ID on the transaction does not match &#39;from&#39; account ID on the transaction item.\n&quot;</span>);
        }
        <span class="comment">// ok so the IDs match. Does the destination account exist?</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pDestinationAcct)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: ERROR verifying existence of the &#39;to&#39; account.\n&quot;</span>);
        }
        <span class="comment">// Is the destination a legitimate other user&#39;s acct, or is it just an internal server account?</span>
        <span class="comment">// (That is, stash accounts, voucher accounts, basket accounts, etc are only used internally,</span>
        <span class="comment">// and may not be recipients to user transfers...)</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pDestinationAcct-&gt;<a class="code" href="class_o_t_account.html#a9a3c4e0a90a5f0f837c7f4acda8d4a10">IsInternalServerAcct</a>())
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeTransfer: Failure: Destination account is used internally by the server, and is not a valid recipient for this transaction.\n&quot;</span>);
        }
        <span class="comment">// Are both of the accounts of the same Asset Type?</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(theFromAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>() == pDestinationAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()))
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAssetID(theFromAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>()),
            strDestinationAssetID(pDestinationAcct-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR - user attempted to transfer between accounts of 2 different &quot;</span>
                    <span class="stringliteral">&quot;asset types in OTServer::NotarizeTransfer:\n%s\n%s\n&quot;</span>, strFromAssetID.Get(),
                    strDestinationAssetID.Get());
        }
        <span class="comment">// Does it verify?</span>
        <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pDestinationAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying signature on, the &#39;to&#39; account in OTServer::NotarizeTransfer\n&quot;</span>);
        }

        <span class="comment">// This entire function can be divided into the top and bottom halves.</span>
        <span class="comment">// The top half is oriented around finding the &quot;transfer&quot; item (in the &quot;transfer&quot; transaction)</span>
        <span class="comment">// and setting up the response item that will go into the response transaction.</span>
        <span class="comment">// The bottom half is oriented, in the case of success, around creating the necessary inbox</span>
        <span class="comment">// and outbox entries, and debiting the account, and basically performing the actual transfer.</span>
        <span class="keywordflow">else</span>
        {
            <span class="comment">// Okay then, everything checks out. Let&#39;s add this to the sender&#39;s outbox and the recipient&#39;s inbox.</span>
            <span class="comment">// IF they can be loaded up from file, or generated, that is.</span>

            <span class="comment">// Load the inbox/outbox in case they already exist</span>
            <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theFromOutbox   (USER_ID, IDFromAccount, SERVER_ID),
                        theToInbox      (pItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>(), SERVER_ID);

            <span class="keywordtype">bool</span> bSuccessLoadingInbox   = theToInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>();
            <span class="keywordtype">bool</span> bSuccessLoadingOutbox  = theFromOutbox.LoadOutbox();
            <span class="comment">// --------------------------------------------------------------------</span>
            <span class="comment">// ...or generate them otherwise...</span>

            <span class="comment">// NOTE:</span>
            <span class="comment">// 1. Any normal user had his inbox created at the same time as his asset account was created.</span>
            <span class="comment">// 2. If there is an error now, we don&#39;t necessarily just want to re-create (and overwrite) that file.</span>
            <span class="comment">// 3. Therefore I do not generate the ledger for safety reasons, per 2.</span>
            <span class="comment">// 4. Also, what if an attempt is being made to transfer to an account that isn&#39;t SUPPOSED to have</span>
            <span class="comment">//    an inbox? For example, a server voucher account (where backing funds for vouchers are stored) does</span>
            <span class="comment">//    not have an inbox, and should not be able to receive transfers. In that case, we definitely don&#39;t want</span>
            <span class="comment">//    to just &quot;generate&quot; an inbox here! Instead, we want it to fail. In fact, I&#39;m adding a check, above, for</span>
            <span class="comment">//    the account type. In fact, I&#39;m adding a new method to OTAccount where we can just ask it, for each</span>
            <span class="comment">//    transaction type, whether it can even be used for that purpose in the first place.</span>
            <span class="comment">//    Update: appears OTAccount::IsInternalServerAcct already basically fits the bill.</span>

            <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingInbox)
                bSuccessLoadingInbox    = theToInbox.VerifyAccount(m_nymServer);
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeTransfer: Error loading &#39;to&#39; inbox.\n&quot;</span>);
<span class="comment">//          else</span>
<span class="comment">//              bSuccessLoadingInbox    = theToInbox.GenerateLedger(pItem-&gt;GetDestinationAcctID(), SERVER_ID, OTLedger::inbox, true); // bGenerateFile=true</span>
            <span class="comment">// --------------------------------------------------------------------</span>
            <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOutbox)
                bSuccessLoadingOutbox   = theFromOutbox.VerifyAccount(m_nymServer);
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeTransfer: Error loading &#39;from&#39; outbox.\n&quot;</span>);
<span class="comment">//          else</span>
<span class="comment">//              bSuccessLoadingOutbox   = theFromOutbox.GenerateLedger(IDFromAccount, SERVER_ID, OTLedger::outbox, true); // bGenerateFile=true</span>
            <span class="comment">// --------------------------------------------------------------------</span>
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theFromAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theFromAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

            <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying inbox.\n&quot;</span>);
            }

            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying outbox.\n&quot;</span>);
            }
            <span class="comment">// --------------------------------------------------------------------</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingInbox || <span class="keyword">false</span> == bSuccessLoadingOutbox)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR generating ledger in OTServer::NotarizeTransfer.\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// Generate new transaction number for these new transactions</span>
                <span class="comment">// todo check this generation for failure (can it fail?)</span>
                int64_t lNewTransactionNumber = 0;

                <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lNewTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>
                <span class="comment">// ------------------------------------------</span>
                <span class="comment">// I create TWO Outbox transactions -- one for the real outbox, (theFromOutbox)</span>
                <span class="comment">// and one for pOutbox (used for verifying the balance statement.)</span>
                <span class="comment">// pTEMPOutboxTransaction (here below) is that last one, pOutbox.</span>
                <span class="comment">//</span>
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTEMPOutboxTransaction  = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pOutbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
                                                                                             lNewTransactionNumber);
                <span class="comment">// ------------------------------------------</span>
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pOutboxTransaction      = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFromOutbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
                                                                                             lNewTransactionNumber);

<span class="comment">//              IssueNextTransactionNumber(m_nymServer, lNewTransactionNumber, false); // bStoreTheNumber = false</span>
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pInboxTransaction       = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theToInbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
                                                                                             lNewTransactionNumber);
                <span class="comment">// ------------------------------------------</span>
                <span class="comment">// UPDATE: I am now issuing one new transaction number above, instead of two. This is to make it easy</span>
                <span class="comment">// for the two to cross-reference each other. Later if I want to remove the transaction from the inbox</span>
                <span class="comment">// and need to know the corresponding transaction # for the outbox, it will be the same number.</span>

                <span class="comment">// I have to set this one up just like the one below.</span>
                pTEMPOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                pTEMPOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                pTEMPOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);
                <span class="comment">// -------------------------------------------</span>
                <span class="comment">// the new transactions store a record of the item they&#39;re referring to.</span>
                pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                <span class="comment">//todo put these two together in a method.</span>
                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo);
                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                pInboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pItem);

                <span class="comment">// Now we have created 2 new transactions from the server to the users&#39; boxes</span>
                <span class="comment">// Let&#39;s sign them and add to their inbox / outbox.</span>
                pOutboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                pInboxTransaction-&gt; SignContract(m_nymServer);

                pOutboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pInboxTransaction-&gt; SaveContract();
                <span class="comment">// -------------------------------------------</span>
                <span class="comment">// Meanwhile a copy of the outbox transaction is also added to</span>
                <span class="comment">// pOutbox. (It&#39;s just another copy of the outbox, but used</span>
                <span class="comment">// purely for verifying the balance statement, while a different</span>
                <span class="comment">// copy of the outbox is used for actually adding the receipt</span>
                <span class="comment">// and saving to the outbox file.)</span>
                <span class="comment">//</span>
                pTEMPOutboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                pTEMPOutboxTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// No need to save a box receipt in this case, like we normally would</span>
                <span class="comment">// when adding a transaction to a box.</span>
                pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTEMPOutboxTransaction); <span class="comment">// pOutbox will clean this up</span>

                <span class="comment">// The balance item from the user, for the outbox transaction, will not have</span>
                <span class="comment">// the correct transaction number (because I just generated it above, so the user</span>
                <span class="comment">// could not possibly have known that when he sent his message.) Currently it is</span>
                <span class="comment">// set to &quot;1&quot; in the user request, but I just put the actual number in the pOutbox</span>
                <span class="comment">// above (since I now have the actual number.)</span>
                <span class="comment">//</span>
                <span class="comment">// So when the receipt is saved (the output transaction) it will show the user&#39;s</span>
                <span class="comment">// signed request with &quot;1&quot; in the outbox, included in the server&#39;s signed reply</span>
                <span class="comment">// with lNewTransactionNumber in the outbox to correspond to it. The user saves</span>
                <span class="comment">// a copy of the same receipt, thus he will be unable to produce a receipt signed</span>
                <span class="comment">// by the server, without producing the exact same thing.</span>
                <span class="comment">// (&quot;1&quot; in the request and lNewTransactionNumber in the signed response.)</span>
                <span class="comment">//</span>
                <span class="comment">// This all means that the below call to VerifyBalanceStatement() needs to verify</span>
                <span class="comment">// the number &quot;1&quot; on the user request, as lNewTransactionNumber in pOutbox, in order</span>
                <span class="comment">// to handle this special case, since otherwise the verification would fail.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>() * (-1), <span class="comment">// My acct balance will be smaller as a result of this transfer.</span>
                                                           theNym,
                                                           *pInbox,
                                                           *pOutbox,
                                                           theFromAccount,
                                                           tranIn,
                                                           lNewTransactionNumber)))
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR verifying balance statement while performing transfer. Acct ID:\n%s\n&quot;</span>,
                                   strAccountID.Get());
                }

                <span class="keywordflow">else</span>
                {
                    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the balance agreement (just above) was successful.</span>
                    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a7eb1718e9e4c791d1a378d87863c3f90">SetNewOutboxTransNum</a>(lNewTransactionNumber); <span class="comment">// So the receipt will show that the client&#39;s &quot;1&quot; in the outbox is now actually &quot;34&quot; or whatever, issued by the server as part of successfully processing the transaction.</span>

                    <span class="comment">// Deduct the amount from the account...</span>
                    <span class="comment">// TODO an issuer account here, can go negative.</span>
                    <span class="comment">// whereas a regular account should not be allowed to go negative.</span>
                    <span class="keywordflow">if</span> (theFromAccount.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()))
                    {<span class="comment">//todo need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                        <span class="comment">// Here the transactions we just created are actually added to the ledgers.</span>
                        theFromOutbox.  AddTransaction(*pOutboxTransaction);
                        theToInbox.     AddTransaction(*pInboxTransaction);

                        <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                        <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                        theFromOutbox.  ReleaseSignatures();
                        theToInbox.     ReleaseSignatures();

                        <span class="comment">// Sign them.</span>
                        theFromOutbox.  SignContract(m_nymServer);
                        theToInbox.     SignContract(m_nymServer);

                        <span class="comment">// Save them internally</span>
                        theFromOutbox.  SaveContract();
                        theToInbox.     SaveContract();

                        <span class="comment">// Save their internals (signatures and all) to file.</span>
                        theFromAccount.<a class="code" href="class_o_t_account.html#ad8c1a43eff592d7cd7af20fcd2eac468">SaveOutbox</a>(theFromOutbox);
                        pDestinationAcct-&gt;<a class="code" href="class_o_t_account.html#a81e503e95310da5ac9c2003cb00d6d2e">SaveInbox</a>(theToInbox);
                        <span class="comment">// ----------------------------------------</span>

                        theFromAccount. ReleaseSignatures();
                        theFromAccount. SignContract(m_nymServer);
                        theFromAccount. SaveContract();
                        theFromAccount. SaveAccount();

                        pDestinationAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                        pDestinationAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                        pDestinationAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                        pDestinationAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                        <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                        <span class="comment">// otherwise, if we never entered this block, then it would still be set to rejection, and the</span>
                        <span class="comment">// new items would never have been added to the inbox/outboxes, and those files, along with</span>
                        <span class="comment">// the account file, would never have had their signatures released, or been re-signed or</span>
                        <span class="comment">// re-saved back to file.  The debit failed, so all of those other actions would fail also.</span>
                        <span class="comment">// BUT... if the message comes back with acknowledgement--then all of these actions must have</span>
                        <span class="comment">// happened, and here is the server&#39;s signature to prove it.</span>
                        <span class="comment">// Otherwise you get no items and no signature. Just a rejection item in the response transaction.</span>
                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                        bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The transfer was successful.</span>

                        <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                        <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                        <span class="comment">//</span>
                        <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                        <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                        <span class="comment">// is removed from a box.</span>
                        <span class="comment">//</span>
                        pOutboxTransaction-&gt;    SaveBoxReceipt(theFromOutbox);
                        pInboxTransaction-&gt;     SaveBoxReceipt(theToInbox);
                    }
                    <span class="keywordflow">else</span>
                    {
                        <span class="keyword">delete</span> pOutboxTransaction; pOutboxTransaction = NULL; <span class="comment">// I can&#39;t use OTCleanup here because sometimes we DON&#39;T delete it. (above)</span>
                        <span class="keyword">delete</span> pInboxTransaction; pInboxTransaction = NULL;
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to debit account %s in the amount of: %ld\n&quot;</span>,
                                       __FUNCTION__, strAccountID.Get(), pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>());
                    }
                }
            } <span class="comment">// both boxes were successfully loaded or generated.</span>
        }
<span class="comment">//      OTString strTestInRefTo;</span>
<span class="comment">//      pResponseItem-&gt;GetReferenceString(strTestInRefTo);</span>
<span class="comment">//      OTLog::vError(&quot;DEBUG: Item in reference to: %s\n&quot;, strTestInRefTo.Get());</span>

    } <span class="comment">// if pItem = tranIn.GetItem(OTItem::transfer)</span>

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a81f81918e187bf2c62bfb413a9db13ab"></a><!-- doxytag: member="OTServer::NotarizeWithdrawal" ref="a81f81918e187bf2c62bfb413a9db13ab" args="(OTPseudonym &amp;theNym, OTAccount &amp;theAccount, OTTransaction &amp;tranIn, OTTransaction &amp;tranOut, bool &amp;bOutSuccess)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a81f81918e187bf2c62bfb413a9db13ab">OTServer::NotarizeWithdrawal</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAccount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>tranOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool &amp;&#160;</td>
          <td class="paramname"><em>bOutSuccess</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>NotarizeWithdrawal supports two withdrawal types:</p>
<p><a class="el" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a> This is a bank voucher, like a cashier's check. Funds are transferred to the bank, who then issues a cheque drawn on an internal voucher account.</p>
<p><a class="el" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a> This is a digital cash withdrawal, in the form of untraceable, blinded tokens. Funds are transferred to the bank, who blind-signs the tokens. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l04331">4331</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// The outgoing transaction is an &quot;atWithdrawal&quot;, that is, &quot;a reply to the withdrawal request&quot;</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a12494b5a0460ce08f67033e0523caf97">SetType</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>);

    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem          = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCash      = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemVoucher   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem   = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseItem  = NULL;
    <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem   = NULL;

    <span class="comment">// The incoming transaction may be sent to inboxes and outboxes, and it</span>
    <span class="comment">// will probably be bundled in our reply to the user as well. Therefore,</span>
    <span class="comment">// let&#39;s grab it as a string.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo;
    <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;

    <span class="comment">// Grab the actual server ID from this object, and use it as the server ID here.</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),       USER_ID(theNym), ACCOUNT_ID(theAccount),
                        SERVER_USER_ID(m_nymServer),    ASSET_TYPE_ID(theAccount.<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAccountID(ACCOUNT_ID), strAssetTypeID(ASSET_TYPE_ID);
    <span class="comment">// -----------------------------------------------------------------</span>

    <span class="comment">// Here we find out if we&#39;re withdrawing cash, or a voucher</span>
    <span class="comment">// (A voucher is a cashier&#39;s cheque aka banker&#39;s cheque).</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

    pItemVoucher = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>);

    <span class="keywordflow">if</span> (NULL == pItemVoucher)
    {
        pItemCash = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>);
        pItem = pItemCash;
        <span class="comment">// ---------</span>
        <span class="keywordflow">if</span> (NULL != pItem)
            theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>;
    }
    <span class="keywordflow">else</span>
    {
        pItem = pItemVoucher;
        <span class="comment">// ---------</span>
        theReplyItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>;
    }
    <span class="comment">// -----------------------------------------------------------------</span>
    pResponseItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, theReplyItemType);
    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

    pResponseBalanceItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(tranOut, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
    tranOut.<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pResponseBalanceItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
    <span class="comment">// --------------------------------------</span>
    <span class="keywordflow">if</span> (NULL == pItem)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Expected OTItem::withdrawal or OTItem::withdrawVoucher in trans# %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// Below this point, we know that pItem is good, and that either pItemVoucher OR pItemCash is good,</span>
    <span class="comment">// and that pItem points to the good one. Therefore next, let&#39;s verify permissions:</span>
    <span class="comment">// ---------------------------------------------------------------------</span>
    <span class="comment">// This permission has to do with ALL withdrawals (cash or voucher)</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_withdrawal))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: User %s cannot do this transaction (All withdrawals are disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// -----------------------------------------</span>
    <span class="comment">// This permission has to do with vouchers.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL != pItemVoucher) &amp;&amp;
             (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_withdraw_voucher)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: User %s cannot do this transaction (withdrawVoucher is disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// This permission has to do with cash.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL != pItemCash) &amp;&amp;
             (<span class="keyword">false</span> == <a class="code" href="_o_t_server_8cpp.html#afa27f441e5360a9540bc0c606728e7bc">NYM_IS_ALLOWED</a>(strUserID.Get(), __transact_withdraw_cash)))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: User %s cannot do this transaction (withdraw cash is disallowed in server.cfg)\n&quot;</span>,
                       strUserID.Get());
    }
    <span class="comment">// ----------------------------------------------------------</span>
    <span class="comment">// Check for a balance agreement...</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pBalanceItem = tranIn.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>)))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Expected OTItem::balanceStatement, but not found in trans # %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }
    <span class="comment">// ------------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>)
    {
        <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
        <span class="comment">// here so they can all grab a copy of it into their &quot;in reference to&quot; fields.</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// (They&#39;re getting SOME sort of response item.)</span>

        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

<span class="comment">//      OTAccount * pVoucherReserveAcct = NULL;</span>
        _SharedPtr&lt;OTAccount&gt;   pVoucherReserveAcct; <span class="comment">// contains the server&#39;s funds to back vouchers of a specific asset type.</span>
        <span class="comment">// ----------------------------------------------------</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
        <span class="comment">// ----------------------------------------------------</span>
        <span class="comment">// I&#39;m using the operator== because it exists.</span>
        <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
        <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (!(ACCOUNT_ID == pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()))
        {  <span class="comment">// TODO see if this is already verified by the caller function and if so, remove.</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: Account ID does not match account ID on the withdrawal item.\n&quot;</span>);
        }
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying inbox.\n&quot;</span>);
        }

        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) OTAccount::Load (above) already verifies.</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying outbox.\n&quot;</span>);
        }
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="comment">// The server will already have a special account for issuing vouchers. Actually, a list of them --</span>
        <span class="comment">// one for each asset type. Since this is the normal way of doing business, GetVoucherAccount() will</span>
        <span class="comment">// just create it if it doesn&#39;t already exist, and then return the pointer. Therefore, a failure here</span>
        <span class="comment">// is a catastrophic failure!  Should never fail.</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pVoucherReserveAcct = <a class="code" href="class_o_t_server.html#a4e285894018dd3ed41b6aae6ccb0fec9">GetVoucherAccount</a>(ASSET_TYPE_ID)) &amp;&amp; <span class="comment">// If assignment results in good pointer...</span>
                 pVoucherReserveAcct-&gt;VerifyAccount(m_nymServer))            <span class="comment">// and if it points to an acct that verifies...</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strVoucherRequest, strItemNote;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strItemNote);
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strVoucherRequest);

            <a class="code" href="class_o_t_account.html">OTAccount</a>    &amp; theVoucherReserveAcct = (*pVoucherReserveAcct);
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   VOUCHER_ACCOUNT_ID(theVoucherReserveAcct);

            <a class="code" href="class_o_t_cheque.html">OTCheque</a>    theVoucher       (SERVER_ID, ASSET_TYPE_ID),
                        theVoucherRequest(SERVER_ID, ASSET_TYPE_ID);

            <span class="keywordtype">bool</span> bLoadContractFromString = theVoucherRequest.LoadContractFromString(strVoucherRequest);

            <span class="keywordflow">if</span> (!bLoadContractFromString)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: ERROR loading voucher request from string:\n%s\n&quot;</span>,
                              __FUNCTION__, strVoucherRequest.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, theVoucherRequest.<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>()))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed verifying transaction number on the voucher (%ld) in withdrawal request %ld for Nym: %s\n&quot;</span>,
                              __FUNCTION__, theVoucherRequest.GetTransactionNum(), tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strUserID.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ASSET_TYPE_ID != theVoucherRequest.GetAssetID())
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strFoundAssetID(theVoucherRequest.GetAssetID());
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::%s: Failed verifying asset type ID (%s) on the withdraw voucher request (found: %s) &quot;</span>
                              <span class="stringliteral">&quot;for transaction %ld, voucher %ld. User: %s\n&quot;</span>,
                              __FUNCTION__, strAssetTypeID.Get(), strFoundAssetID.Get(),
                              tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), theVoucherRequest.GetTransactionNum(), strUserID.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(theVoucherRequest.GetAmount() * (-1), <span class="comment">// My account&#39;s balance will go down by this much.</span>
                                                            theNym,
                                                            *pInbox,
                                                            *pOutbox,
                                                            theAccount,
                                                            tranIn)))
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR verifying balance statement while issuing voucher. Acct ID:\n%s\n&quot;</span>,
                               strAccountID.Get());
            }
            <span class="keywordflow">else</span> <span class="comment">// successfully loaded the voucher request from the string...</span>
            {
                pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>
                <span class="comment">// -------------------------------------------</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo;
                strChequeMemo.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s%s&quot;</span>, strItemNote.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theVoucherRequest.GetMemo().Get());

                <span class="comment">// 10 minutes ==    600 Seconds</span>
                <span class="comment">// 1 hour   ==     3600 Seconds</span>
                <span class="comment">// 1 day    ==    86400 Seconds</span>
                <span class="comment">// 30 days  ==  2592000 Seconds</span>
                <span class="comment">// 3 months ==  7776000 Seconds</span>
                <span class="comment">// 6 months == 15552000 Seconds</span>

                <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
                <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  VALID_TO    = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>));

                <span class="comment">// UPDATE: We now use a transaction number owned by the remitter, instead of the transaction server.</span>
                <span class="comment">//</span>
<span class="comment">//              int64_t lNewTransactionNumber = 0;</span>
<span class="comment">//              IssueNextTransactionNumber(m_nymServer, lNewTransactionNumber); // bStoreTheNumber defaults to true. We save the transaction</span>
                                                                                <span class="comment">// number on the server Nym (normally we&#39;d discard it) because</span>
                <span class="keyword">const</span> int64_t lAmount = theVoucherRequest.GetAmount();              <span class="comment">// when the cheque is deposited, the server nym, as the owner of</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; RECIPIENT_ID = theVoucherRequest.GetRecipientUserID(); <span class="comment">// the voucher account, needs to verify the transaction # on the</span>
                                                                                            <span class="comment">// cheque (to prevent double-spending of cheques.)</span>
                <span class="keywordtype">bool</span> bIssueVoucher = theVoucher.IssueCheque(
                                                            lAmount,                <span class="comment">// The amount of the cheque.</span>
                                                            theVoucherRequest.GetTransactionNum(),  <span class="comment">// Requiring a transaction number prevents double-spending of cheques.</span>
                                                            VALID_FROM,             <span class="comment">// The expiration date (valid from/to dates) of the cheque</span>
                                                            VALID_TO,               <span class="comment">// Vouchers are automatically starting today and lasting 6 months.</span>
                                                            VOUCHER_ACCOUNT_ID,     <span class="comment">// The asset account the cheque is drawn on.</span>
                                                            SERVER_USER_ID,         <span class="comment">// User ID of the sender (in this case the server.)</span>
                                                            strChequeMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <span class="comment">// Optional memo field. Includes item note and request memo.</span>
                                                            theVoucherRequest.HasRecipient() ? (&amp;RECIPIENT_ID) : NULL);

                <span class="comment">// IF we successfully created the voucher, AND the voucher amount is greater than 0,</span>
                <span class="comment">// AND debited the user&#39;s account,</span>
                <span class="comment">// AND credited the server&#39;s voucher account,</span>
                <span class="comment">//</span>
                <span class="comment">// THEN save the accounts and return the voucher to the user.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bIssueVoucher  &amp;&amp;  (lAmount &gt; 0)    &amp;&amp;
                    theAccount.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(theVoucherRequest.GetAmount())
                    )
                {
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pVoucherReserveAcct-&gt;Credit(theVoucherRequest.GetAmount()))
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Failed crediting voucher reserve account.\n&quot;</span>);

                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(theVoucherRequest.GetAmount()))
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::NotarizeWithdrawal (voucher): Failed crediting user account.\n&quot;</span>);
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strVoucher;
                        theVoucher.SetAsVoucher(USER_ID, ACCOUNT_ID);   <span class="comment">// All this does is set the voucher&#39;s internal contract string to</span>
                                                                        <span class="comment">// &quot;VOUCHER&quot; instead of &quot;CHEQUE&quot;. Plus it saves the remitter&#39;s IDs.</span>
                        theVoucher.SignContract(m_nymServer);
                        theVoucher.SaveContract();
                        theVoucher.SaveContractRaw(strVoucher);

                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strVoucher);
                        pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                        bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The withdrawal of a voucher was successful.</span>
                        <span class="comment">// --------------------------------------------------------------------------</span>
                        <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                        <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                        theAccount. ReleaseSignatures();
                        theAccount. SignContract(m_nymServer);  <span class="comment">// Sign</span>
                        theAccount. SaveContract();             <span class="comment">// Save</span>
                        theAccount. SaveAccount();              <span class="comment">// Save to file</span>

                        <span class="comment">// We also need to save the Voucher cash reserve account.</span>
                        <span class="comment">// (Any issued voucher cheque is automatically backed by this reserve account.</span>
                        <span class="comment">// If a cheque is deposited, the funds come back out of this account. If the</span>
                        <span class="comment">// cheque expires, then after the expiry period, if it remains in the account,</span>
                        <span class="comment">// it is now the property of the transaction server.)</span>
                        pVoucherReserveAcct-&gt;ReleaseSignatures();
                        pVoucherReserveAcct-&gt;SignContract(m_nymServer);
                        pVoucherReserveAcct-&gt;SaveContract();
                        pVoucherReserveAcct-&gt;SaveAccount();
                    }
                }
                <span class="comment">//else{} // TODO log that there was a problem with the amount</span>

            } <span class="comment">// voucher request loaded successfully from string</span>
        } <span class="comment">// GetVoucherAccount()</span>
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;GetVoucherAccount() failed in NotarizeWithdrawal. Asset Type:\n%s\n&quot;</span>,
                          strAssetTypeID.Get());
        }
    }

    <span class="comment">// --------------------------------------------------------------------------------------</span>

    <span class="comment">// WITHDRAW DIGITAL CASH (BLINDED TOKENS)</span>
    <span class="comment">//</span>
    <span class="comment">// For now, there should only be one of these withdrawal items inside the transaction.</span>
    <span class="comment">// So we treat it that way... I either get it successfully or not.</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>)
    {
        <span class="comment">// The response item will contain a copy of the request item. So I save it into a string</span>
        <span class="comment">// here so they can all grab a copy of it into their &quot;in reference to&quot; fields.</span>
        <span class="comment">//</span>
        pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strInReferenceTo);
        pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBalanceItem);

        <span class="comment">// Server response item being added to server response transaction (tranOut)</span>
        <span class="comment">// They&#39;re getting SOME sort of response item.</span>
        <span class="comment">//</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInReferenceTo); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strBalanceItem); <span class="comment">// the response item carries a copy of what it&#39;s responding to.</span>
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This response item is IN RESPONSE to pItem and its Owner Transaction.</span>
        <span class="comment">// --------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = theAccount.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(m_nymServer);
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = theAccount.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
        <span class="comment">// --------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_mint.html">OTMint</a>      * pMint = NULL;
        <a class="code" href="class_o_t_account.html">OTAccount</a>   * pMintCashReserveAcct = NULL;

        <span class="keywordflow">if</span> (0 &gt; pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>())
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Attempt to withdraw a negative amount.\n&quot;</span>);
        }
        <span class="comment">// If the ID on the &quot;from&quot; account that was passed in,</span>
        <span class="comment">// does not match the &quot;Acct From&quot; ID on this transaction item</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ACCOUNT_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>())
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: &#39;From&#39; account ID on the transaction does not match &#39;from&#39; account ID on the withdrawal item.\n&quot;</span>);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) Already verified in OTAccount::LoadInbox()</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying inbox.\n&quot;</span>);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) Already verified in OTAccount::LoadOutbox()</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading or verifying outbox.\n&quot;</span>);
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// --------------------------------------------------------------------</span>
            <span class="comment">// The COIN REQUEST (including the prototokens) comes from the client side.</span>
            <span class="comment">// so we assume the OTToken is in the payload. Now we need to randomly choose one for</span>
            <span class="comment">// signing, and reply to the client with that number so that the client can reply back</span>
            <span class="comment">// to us with the unblinding factors for all the other prototokens (but that one.)</span>
            <span class="comment">//</span>
            <span class="comment">// In the meantime, I have to store this request somewhere -- presumably in the outbox or purse.</span>
            <span class="comment">//</span>
            <span class="comment">// UPDATE!!! Looks like Lucre protocol is simpler than that. The request only needs to contain a</span>
            <span class="comment">// single blinded token, which the server signs and sends back. Done.</span>
            <span class="comment">//</span>
            <span class="comment">// The amount is known to be safe (by the mint) because the User asks the Mint to create</span>
            <span class="comment">// a denomination (say, 10) token. The Mint therefore uses the &quot;Denomination 10&quot; key to sign</span>
            <span class="comment">// the token, and will later use the &quot;Denomination 10&quot; key to verify the token. So the mint</span>
            <span class="comment">// obviously trusts its own keys... There is nothing else to &quot;open and verify&quot;, since only the ID</span>
            <span class="comment">// itself is what gets blinded and verified.  The amount on the token (as well as the asset type)</span>
            <span class="comment">// is only there to help the bank to look up the right key, without which the token will DEFINITELY</span>
            <span class="comment">// NOT verify. So it is in the user&#39;s interest to supply the correct amount, because otherwise he&#39;ll</span>
            <span class="comment">// just get the wrong key and then get rejected by the bank.</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPurse);

            <span class="comment">// Todo do more security checking in here, like making sure the withdrawal amount matches the</span>
            <span class="comment">// total of the proto-tokens. Update: I think this is done, since the Debits are done one-at-a-time</span>
            <span class="comment">// for each token and it&#39;s amount/denomination</span>

            <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, ASSET_TYPE_ID);
            <a class="code" href="class_o_t_purse.html">OTPurse</a> theOutputPurse(SERVER_ID, ASSET_TYPE_ID);
            <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = NULL;
            <a class="code" href="_o_t_token_8hpp.html#a936004d84b158e909dc03d51f0ac3c21">dequeOfTokenPtrs</a> theDeque;

            <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bLoadContractFromString = thePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPurse);

            <span class="keywordflow">if</span> (!bLoadContractFromString)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading purse from string in OTServer::NotarizeWithdrawal:\n%s\n&quot;</span>,
                        strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a343a0c7a7a05ef4dade448cd551547ea">VerifyBalanceStatement</a>(thePurse.GetTotalValue() * (-1), <span class="comment">// This amount will be subtracted from my acct.</span>
                                                            theNym,
                                                            *pInbox,
                                                            *pOutbox,
                                                            theAccount,
                                                            tranIn)))
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ERROR verifying balance statement while withdrawing cash. Acct ID: %s\n&quot;</span>,
                               strAccountID.Get());
            }
            <span class="keywordflow">else</span> <span class="comment">// successfully loaded the purse from the string...</span>
            {
                pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// the transaction agreement was successful.</span>

                <span class="comment">// Pull the token(s) out of the purse that was received from the client.</span>
                <span class="keywordflow">while</span> ((pToken = thePurse.Pop(m_nymServer)) != NULL)
                {
                    <span class="comment">// We are responsible to cleanup pToken</span>
                    <span class="comment">// So I grab a copy here for later...</span>
                    theDeque.push_front(pToken);

                    pMint = <a class="code" href="class_o_t_server.html#a65dd3c93d81f20a72b8d7d9e7cfe2eda" title="Lookup the current mint for any given asset type ID and series.">GetMint</a>(ASSET_TYPE_ID, pToken-&gt;<a class="code" href="class_o_t_token.html#ad68798a37c37605745ae99475a942126">GetSeries</a>());

                    <span class="keywordflow">if</span> (NULL == pMint)
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Unable to find Mint (series %d): %s\n&quot;</span>,
                                      pToken-&gt;<a class="code" href="class_o_t_token.html#ad68798a37c37605745ae99475a942126">GetSeries</a>(), strAssetTypeID.Get());
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>; <span class="comment">// Once there&#39;s a failure, we ditch the loop.</span>
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pMintCashReserveAcct = pMint-&gt;<a class="code" href="class_o_t_mint.html#a98138568de72510cb6baf3f0faf45915">GetCashReserveAccount</a>()))
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Unable to find cash reserve account for Mint (series %d): %s\n&quot;</span>,
                                      pToken-&gt;<a class="code" href="class_o_t_token.html#ad68798a37c37605745ae99475a942126">GetSeries</a>(), strAssetTypeID.Get());
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>; <span class="comment">// Once there&#39;s a failure, we ditch the loop.</span>
                    }
                    <span class="comment">// Mints expire halfway into their token expiration period. So if a mint creates</span>
                    <span class="comment">// tokens valid from Jan 1 through Jun 1, then the Mint itself expires Mar 1.</span>
                    <span class="comment">// That&#39;s when the next series Mint is phased in to start issuing tokens, even</span>
                    <span class="comment">// though the server continues redeeming the first series tokens until June.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pMint-&gt;<a class="code" href="class_o_t_mint.html#ae2aa73becb8bd2a00221860520fb8f4e">Expired</a>())
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: User attempting withdrawal with an expired mint (series %d): %s\n&quot;</span>,
                                      pToken-&gt;<a class="code" href="class_o_t_token.html#ad68798a37c37605745ae99475a942126">GetSeries</a>(), strAssetTypeID.Get());
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>; <span class="comment">// Once there&#39;s a failure, we ditch the loop.</span>
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a>  theStringReturnVal;

                        <span class="keywordflow">if</span> (pToken-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>() != ASSET_TYPE_ID)
                        {
                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> str1(pToken-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()), str2(ASSET_TYPE_ID);
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR while signing token: Expected asset ID %s but found %s instead. (Failure.)\n&quot;</span>,
                                          __FUNCTION__, str2.Get(), str1.Get());
                            <span class="keywordflow">break</span>;
                        }
                        <span class="comment">// TokenIndex is for cash systems that send multiple proto-tokens, so the Mint</span>
                        <span class="comment">// knows which proto-token has been chosen for signing.</span>
                        <span class="comment">// But Lucre only uses a single proto-token, so the token index is always 0.</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pMint-&gt;<a class="code" href="class_o_t_mint.html#a6d55a004dab7e719a96a2087f904fd06">SignToken</a>(m_nymServer, *pToken, theStringReturnVal, 0))) <span class="comment">// nTokenIndex = 0 // ******************************************</span>
                        {
                            bSuccess = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure in call: pMint-&gt;SignToken(m_nymServer, *pToken, theStringReturnVal, 0). (Returning.)\n&quot;</span>,
                                          __FUNCTION__);
                            <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>  theArmorReturnVal(theStringReturnVal);

                            pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// this releases the normal signatures, not the Lucre signed token from the Mint, above.</span>

                            pToken-&gt;<a class="code" href="class_o_t_token.html#a0d086617307060980956b431c6b020c5">SetSignature</a>(theArmorReturnVal, 0); <span class="comment">// nTokenIndex = 0</span>

                            <span class="comment">// Sign and Save the token</span>
                            pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                            pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                            <span class="comment">// Now the token is in signedToken mode, and the other prototokens have been released.</span>

                            <span class="comment">// Deduct the amount from the account...</span>
                            <span class="keywordflow">if</span> (theAccount.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                            {<span class="comment">//todo need to be able to &quot;roll back&quot; if anything inside this block fails.</span>
                                bSuccess = <span class="keyword">true</span>;

                                <span class="comment">// Credit the server&#39;s cash account for this asset type in the same</span>
                                <span class="comment">// amount that was debited. When the token is deposited again, Debit that same</span>
                                <span class="comment">// server cash account and deposit in the depositor&#39;s acct.</span>
                                <span class="comment">// Why, you might ask? Because if the token expires, the money will stay in</span>
                                <span class="comment">// the bank&#39;s cash account instead of being lost (and screwing up the overall</span>
                                <span class="comment">// issuer balance, with the issued money disappearing forever.) The bank knows</span>
                                <span class="comment">// that once the series expires, whatever funds are left in that cash account are</span>
                                <span class="comment">// for the bank to keep. They can be transferred to another account and kept, instead</span>
                                <span class="comment">// of being lost.</span>
                                <span class="keywordflow">if</span> (!pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error crediting mint cash reserve account...\n&quot;</span>);

                                    <span class="comment">// Reverse the account debit (even though we&#39;re not going to save it anyway.)</span>
                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAccount.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()))
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed crediting user account back.\n&quot;</span>, __FUNCTION__);

                                    bSuccess = <span class="keyword">false</span>;
                                    <span class="keywordflow">break</span>;
                                }
                            }
                            <span class="keywordflow">else</span> {
                                bSuccess = <span class="keyword">false</span>;
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to debit account %s in the amount of: %ld\n&quot;</span>,
                                               __FUNCTION__, strAccountID.Get(), pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>());
                                <span class="keywordflow">break</span>; <span class="comment">// Once there&#39;s a failure, we ditch the loop.</span>
                            }
                        }
                    }
                } <span class="comment">// While success popping token out of the purse...</span>

                <span class="keywordflow">if</span> (bSuccess)
                {
                    <span class="keywordflow">while</span> (!theDeque.empty())
                    {
                        pToken = theDeque.front();
                        theDeque.pop_front();

                        theOutputPurse.Push(theNym, *pToken); <span class="comment">// these were in reverse order. Fixing with theDeque.</span>

                        <span class="keyword">delete</span> pToken;
                        pToken = NULL;
                    }

                    strPurse.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); <span class="comment">// just in case it only concatenates.</span>

                    theOutputPurse.SignContract(m_nymServer);
                    theOutputPurse.SaveContract(); <span class="comment">// todo this is probably unnecessary</span>
                    theOutputPurse.SaveContractRaw(strPurse);


                    <span class="comment">// Add the digital cash token to the response message</span>
                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse);
                    pResponseItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>);

                    bOutSuccess = <span class="keyword">true</span>;  <span class="comment">// The cash withdrawal was successful.</span>

                    <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                    <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                    theAccount. ReleaseSignatures();

                    <span class="comment">// Sign</span>
                    theAccount. SignContract(m_nymServer);

                    <span class="comment">// Save</span>
                    theAccount. SaveContract();

                    <span class="comment">// Save to file</span>
                    theAccount. SaveAccount();

                    <span class="comment">// We also need to save the Mint&#39;s cash reserve.</span>
                    <span class="comment">// (Any cash issued by the Mint is automatically backed by this reserve</span>
                    <span class="comment">// account. If cash is deposited, it comes back out of this account. If the</span>
                    <span class="comment">// cash expires, then after the expiry period, if it remains in the account,</span>
                    <span class="comment">// it is now the property of the transaction server.)</span>
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    pMintCashReserveAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                    <span class="comment">// Notice if there is any failure in the above loop, then we will never enter this block.</span>
                    <span class="comment">// Therefore the account will never be saved with the new debited balance, and the output</span>
                    <span class="comment">// purse will never be added to the response item.  No tokens will be returned to the user</span>
                    <span class="comment">// and the account will not be saved, thus retaining the original balance.</span>
                    <span class="comment">//</span>
                    <span class="comment">// Only if everything is successful do we enter this block, save the output purse onto the</span>
                    <span class="comment">// response, and save the newly-debitted account back to disk.</span>
                }
                <span class="comment">// Still need to clean up theDeque</span>
                <span class="keywordflow">else</span>
                {
                    <span class="keywordflow">while</span> (!theDeque.empty())
                    {
                        pToken = theDeque.front();
                        theDeque.pop_front();

                        <span class="keyword">delete</span> pToken;
                        pToken = NULL;
                    }
                }

            } <span class="comment">// purse loaded successfully from string</span>

        } <span class="comment">// the Account ID on the item matched properly</span>
        <span class="comment">// ---------------------------------------------------</span>
        <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
        <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
        <span class="comment">// is owned by the transaction, who will take it from here.</span>
        pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
        pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
        pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    } <span class="comment">// if pItem = tranIn.GetItem(OTItem::withdrawal)</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTemp(tranIn);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::NotarizeWithdrawal: Expected OTItem::withdrawal or OTItem::withdrawVoucher in trans# %ld: \n\n%s\n\n&quot;</span>,
                       tranIn.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strTemp.Exists() ? strTemp.Get() : <span class="stringliteral">&quot; (ERROR LOADING TRANSACTION INTO STRING) &quot;</span>);
    }

    <span class="comment">// sign the response item before sending it back (it&#39;s already been added to the transaction above)</span>
    <span class="comment">// Now, whether it was rejection or acknowledgement, it is set properly and it is signed, and it</span>
    <span class="comment">// is owned by the transaction, who will take it from here.</span>
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// the signing was of no effect because I forgot to save.</span>

    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9f37adf57ae3e289f4a05494dd4642e3"></a><!-- doxytag: member="OTServer::ProcessCron" ref="a9f37adf57ae3e289f4a05494dd4642e3" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a9f37adf57ae3e289f4a05494dd4642e3">OTServer::ProcessCron</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Currently the test server calls this 10 times per second. It also processes all the input/output at the same rate. It sleeps in between. (See testserver.cpp for the call and OTLog::Sleep() for the sleep code.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00298">298</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!m_Cron.<a class="code" href="class_o_t_cron.html#a1f1795c385d987bd098e1c636f4a08ce">IsActivated</a>())
        <span class="keywordflow">return</span>;

    <span class="keywordtype">bool</span> bAddedNumbers = <span class="keyword">false</span>;

    <span class="comment">// Cron requires transaction numbers in order to process.</span>
    <span class="comment">// So every time before I call Cron.Process(), I make sure to replenish first.</span>
    <span class="keywordflow">while</span> (m_Cron.<a class="code" href="class_o_t_cron.html#ae241ecf6802b59ccde653082f098e80c">GetTransactionCount</a>() &lt; <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>())
    {
        int64_t lTransNum = 0;
        <span class="keywordtype">bool</span> bSuccess = <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(m_nymServer, lTransNum, <span class="keyword">false</span>); <span class="comment">// bStoreTheNumber = false</span>

        <span class="keywordflow">if</span> (bSuccess)
        {
            m_Cron.<a class="code" href="class_o_t_cron.html#aad85faf2146cea516d7a5f169904485d">AddTransactionNumber</a>(lTransNum);
            bAddedNumbers = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span>
            <span class="keywordflow">break</span>;
    }

    <span class="keywordflow">if</span> (bAddedNumbers)
    {
        m_Cron.<a class="code" href="class_o_t_cron.html#a24df32b4bf36e48867e7afda0955bb72">SaveCron</a>();
    }

    m_Cron.<a class="code" href="class_o_t_cron.html#a1a8bdc614a109ccecf9712531ba9cf14">ProcessCronItems</a>(); <span class="comment">// This needs to be called regularly for trades, markets, payment plans, etc to process.</span>


    <span class="comment">// NOTE:  TODO:  OTHER RE-OCCURRING SERVER FUNCTIONS CAN GO HERE AS WELL!!</span>
    <span class="comment">//</span>
    <span class="comment">// Such as sweeping server accounts after expiration dates, etc.</span>

}
</pre></div>
</div>
</div>
<a class="anchor" id="ae547a4bbf348c113568d625f8f5256aa"></a><!-- doxytag: member="OTServer::ProcessUserCommand" ref="ae547a4bbf348c113568d625f8f5256aa" args="(OTMessage &amp;theMessage, OTMessage &amp;msgOut, OTClientConnection *pConnection=NULL, OTPseudonym *pNym=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ae547a4bbf348c113568d625f8f5256aa">OTServer::ProcessUserCommand</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_client_connection.html">OTClientConnection</a> *&#160;</td>
          <td class="paramname"><em>pConnection</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> *&#160;</td>
          <td class="paramname"><em>pNym</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l13655">13655</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    msgOut.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>); <span class="comment">// to prevent replay attacks.</span>

    <span class="comment">/*</span>
<span class="comment">     p_Config-&gt;SetOption_bool(&quot;permissions&quot;, &quot;admin_server_locked&quot;,     __admin_server_locked);</span>
<span class="comment">     */</span>
    <span class="comment">// ---------------------------------------------</span>
    <span class="keywordflow">if</span> ((<span class="keyword">true</span> == OTServer::__admin_server_locked) &amp;&amp;    <span class="comment">// IF (the OT Server is in &quot;lock down&quot; mode)</span>
        ((<a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().size() &lt;= 0) ||  <span class="comment">// AND (there&#39;s no Override Nym ID listed --OR-- the Override Nym ID doesn&#39;t</span>
         (0 != <a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().compare((theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())))))   <span class="comment">// match the Nym&#39;s ID who sent this message)</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::ProcessUserCommand: Nym %s: failed attempt to message the server, while server is in **LOCK DOWN MODE**.\n&quot;</span>,
                       theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ----------------------------------------------</span>

    <span class="comment">// Validate the server ID, to keep users from intercepting a valid requst</span>
    <span class="comment">// and sending it to the wrong server.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#a4763bf53853ca87407c23ba152a8ebe4">ValidateServerIDfromUser</a>(theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>))
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::ProcessUserCommand: Invalid server ID sent in command request.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Received valid Server ID with command request.\n&quot;</span>);
    }
    <span class="comment">// ----------------------------------------------</span>
    <span class="comment">// NYM WAS PASSED IN</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theNym(theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>);

    <span class="keywordflow">if</span> (NULL == pNym)
        pNym = &amp;theNym; <span class="comment">// If one wasn&#39;t passed in, we&#39;ll use the one constructed here. (One line up.)</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5ec9340b8d1d0fcd32f754ea63f9915a">CompareID</a>(theNym))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strTempNymID;
        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strTempNymID);
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::ProcessUserCommand: NymID on the optional Nym passed in (%s) &quot;</span>
                      <span class="stringliteral">&quot;does NOT match the NymID on theMessage (%s). (Returning false.)\n&quot;</span>,
                      strTempNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ----------------------------------------------</span>
    <span class="comment">// NYM IS ACTUALLY SERVER</span>

    <span class="comment">// For special cases where the Nym sending the transaction has the same public key as</span>
    <span class="comment">// the server itself. (IE it IS the server Nym, then we&#39;d want to use the already-loaded</span>
    <span class="comment">// server nym object instead of loading a fresh one, so the two don&#39;t overwrite each other.)</span>
    <span class="comment">//</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymIsServerNym = (m_strServerUserID.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<span class="comment">//  OTPseudonym * pNym = &amp;theNym; // this is now done higher up in this function.</span>

    <span class="keywordflow">if</span> (bNymIsServerNym)
        pNym = &amp;m_nymServer;

    <span class="comment">//**********************************************************************************************</span>

    <span class="comment">// This command is special because the User sent his public key, not just his ID.</span>
    <span class="comment">// We have to verify the two together.</span>
    <span class="comment">//</span>
    <span class="comment">// At this point the user doesn&#39;t even have an account, so there is no public key</span>
    <span class="comment">// to look up from the database.</span>
    <span class="comment">//</span>
    <span class="comment">// If the ServerID in the reply matches the ID calculated from the Server Contract,</span>
    <span class="comment">// that means the user, without asking for the server&#39;s public key, can just extract</span>
    <span class="comment">// the public key from the contract from which the serverID was first calculated. (The</span>
    <span class="comment">// ID is a hash of the contract.)</span>
    <span class="comment">//</span>
    <span class="comment">// In other words, the user reads a contract. It&#39;s signed. The signature is verified</span>
    <span class="comment">// by a public key that is embedded in the contract. If the server, a URL also embedded in</span>
    <span class="comment">// the contract, acknowledges the ServerID, then the user can encrypt everything to the</span>
    <span class="comment">// public key in the contract, without asking the server for a copy of that key.</span>
    <span class="comment">//</span>
    <span class="comment">// Only the private key who signed that contract will be able to read the communications from</span>
    <span class="comment">// the user.</span>
    <span class="comment">//</span>
    <span class="comment">// I definitely have to build in an option for x509 certs to be used in lieu of public keys.</span>
    <span class="comment">// Otherwise the key is not ever revokable -- yet it&#39;s in a contract!  What is the issuer supposed</span>
    <span class="comment">// to do if that key is stolen? Make a public announcement?</span>
    <span class="comment">//</span>
    <span class="comment">// UPDATE ONE-LINE NOTE: THE TRUE SOLUTION TO THIS WHOLE ISSUE IS:   *** NAMECOIN ***</span>
    <span class="comment">// (Now continuing back to my old comments from 18 months ago...)</span>
    <span class="comment">//</span>
    <span class="comment">// In such a case, the issuer would have to put a &quot;check this URL to make sure contract still good&quot;</span>
    <span class="comment">// variable into the contract so that the users have the chance to make sure the contract is still</span>
    <span class="comment">// good and the contract&#39;s private key hasn&#39;t been stolen. Well guess what? That&#39;s what x509 does.</span>
    <span class="comment">// Therefore the appropriate solution is for the server to support x509s, and to look up the authority</span>
    <span class="comment">// and verify certs, so that users have recourse in the event their private key is stolen. (They can</span>
    <span class="comment">// just use their Cert to issue a new public key, which the transaction server would be smart enough</span>
    <span class="comment">// to use, once the certificate authority signs off on it. (Since the user uses an x509 from a</span>
    <span class="comment">// specific authority, then I can trust that whatever that authority says, that user wanted it to say.)</span>
    <span class="comment">// Without knowing the authority itself, I can now trust it because the user has asked me to trust it.</span>
    <span class="comment">// Fair enough!</span>
    <span class="comment">//</span>
    <span class="comment">// Similarly a user should be able to use his x509 Cert instead of his public key, and the server</span>
    <span class="comment">// should verify that cert whenever it&#39;s used to make sure it&#39;s up to date.  This takes the</span>
    <span class="comment">// problem off of the user&#39;s hands by way of a trusted authority.</span>
    <span class="comment">//</span>
    <span class="comment">// In fact this transaction server is really just a transaction VERIFIER. It&#39;s just another form</span>
    <span class="comment">// of trusted 3rd party. Just like Verisign is an authority who ceritifies an identity, so this</span>
    <span class="comment">// server is an authority who certifies a transaction. It&#39;s like a timestamping server. In fact</span>
    <span class="comment">// it should have timestamping built in as one of the functions.</span>
    <span class="comment">//</span>
    <span class="comment">// Transactions do not actually occur on the server, per se. They occur between the USERS.</span>
    <span class="comment">// All the server does it certify that the numbers are correct. It&#39;s like accounting software.</span>
    <span class="comment">// Ultimately the users are the ones making a transaction, and they are the ones who are</span>
    <span class="comment">// responsible to back up their promises in real life and potentially in court. All the software</span>
    <span class="comment">// does is CERTIFY that the users DID make certain agreements at certain times, and digitally sign</span>
    <span class="comment">// those certifications.</span>
    <span class="comment">//</span>
    <span class="comment">// Thus, this server is very similar to Verisign. It is a trusted 3rd party who users can trust</span>
    <span class="comment">// to authenticate their transactions. Instead of authenticating certifications like Verisign does,</span>
    <span class="comment">// it authenticates transactions.</span>
    <span class="comment">//</span>
    <span class="comment">// UPDATE: May not want x509&#39;s after all, since it provides an opening for governments to</span>
    <span class="comment">// serve warrants on the authority site and switch certs whenever they want to (BAD THING!)</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strMsgNymID;
    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strMsgNymID);

    <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;checkServerID&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a checkServerID message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_check_server_id);
        <span class="comment">/*</span>
<span class="comment">         #define OT_ENFORCE_PERMISSION_MSG(BOOL_VAR_NAME) \</span>
<span class="comment">        { \</span>
<span class="comment">            const char * pNymAllowedIDStr   = theMessage.m_strNymID.Get(); \</span>
<span class="comment">            const char * pActionNameStr     = theMessage.m_strCommand.Get(); \</span>
<span class="comment">            \</span>
<span class="comment">            if (false == NYM_IS_ALLOWED(pNymAllowedIDStr, (BOOL_VAR_NAME))) \</span>
<span class="comment">            { \</span>
<span class="comment">                OTLog::vOutput(0, &quot;Nym %s attempted an action (%s), but based on server configuration, he&#39;s not allowed.\n&quot;, \</span>
<span class="comment">                               pNymAllowedIDStr, pActionNameStr); \</span>
<span class="comment">                return false; \</span>
<span class="comment">            } \</span>
<span class="comment">        }</span>
<span class="comment">        */</span>
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pNymAuthentKey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
        <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pNymEncryptKey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNymAuthentKey);
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNymEncryptKey);
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theAuthKeyAngel(pNymAuthentKey);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theEncrKeyAngel(pNymEncryptKey);
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; nymAuthentKey    = *pNymAuthentKey;
        <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; nymEncryptionKey = *pNymEncryptKey;
        <span class="comment">// ------------------------------------------------------------</span>
        <span class="keyword">const</span> <span class="keywordtype">bool</span> bIfNymPublicKey =
                (nymAuthentKey   .<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(theMessage.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a>, <span class="keyword">true</span><span class="comment">/*bEscaped*/</span>) &amp;&amp;
                 nymEncryptionKey.<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>,       <span class="keyword">true</span><span class="comment">/*bEscaped*/</span>));

        <span class="keywordflow">if</span> (bIfNymPublicKey)
        {
            <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_contract.html#ab80fbfabc9dca35310f63bce3840387e">VerifyWithKey</a>(nymAuthentKey)) <span class="comment">// Not all contracts are signed with the authentication key, but messages are.</span>
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Signature verified! The message WAS signed by &quot;</span>
                        <span class="stringliteral">&quot;the Private Authentication Key inside the message.\n&quot;</span>);

                <span class="comment">// This is only for verified Nyms, (and we&#39;re verified in here!) We do this so that</span>
                <span class="comment">// we have the option later to encrypt the replies back to the client...(using the</span>
                <span class="comment">// client&#39;s public key that we set here.)</span>
                <span class="keywordflow">if</span> (NULL != pConnection)
                    pConnection-&gt;<a class="code" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">SetPublicKey</a>(theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>); <span class="comment">// theMessage.m_strNymID2 contains the public encryption key for sending an encrypted reply.</span>

                <a class="code" href="class_o_t_server.html#aad09d6bc4e812109dd084c8606c7cd3a">UserCmdCheckServerID</a>(*pNym, theMessage, msgOut);
                <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;checkServerID: Signature verification failed!\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failure reading Nym&#39;s signing and/or encryption keys from message.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
    }

    <span class="comment">// The below block is now COMPLETE. (For credentials new system.)</span>
    <span class="comment">//</span>
    <span class="comment">// Next, make sure the client side is properly forming the new version of this message,</span>
    <span class="comment">// and make sure it creates credentials when necessary, if they don&#39;t already exist</span>
    <span class="comment">// (Since this new server version ONLY accepts credentials, and not old-style public keys.)</span>
    <span class="comment">//</span>
    <span class="comment">// This command is also special because again, the User sent his public key, not just his ID.</span>
    <span class="comment">// We have to verify the two together.</span>
    <span class="comment">// UPDATE: now the Nym sends not a public key, but a full set of credentials along with</span>
    <span class="comment">// a list of credential IDs. You load the list of credential IDs as if you are loading the Nym</span>
    <span class="comment">// from a string. (It&#39;s like a nym that only contains the credential parts.) Then in the process</span>
    <span class="comment">// of loading the Nym, it will load the credentials from the mapOfStrings.</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;createUserAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a createUserAccount message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_create_user_acct);
        <span class="comment">// ------------------------------------------------------------</span>
        <span class="keywordflow">if</span> (bNymIsServerNym)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;**** Sorry, the server Nym is forbidden from using &quot;</span>
                          <span class="stringliteral">&quot;the createUserAccount message as a client. &quot;</span>
                          <span class="stringliteral">&quot;PLEASE REMOVE THAT NYM FROM YOUR WALLET!! Create a fresh Nym to use. ***\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// First try to get Credentials, if there are any.</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor  = theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>;  <span class="comment">// credentialList  (New style! Credentials.)</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor2 = theMessage.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>; <span class="comment">// credentials</span>
        <span class="comment">// -----------------------------------------------------</span>
        <span class="keyword">const</span> <span class="keywordtype">bool</span> bHasCredentials = (ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; ascArmor2.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
        <span class="comment">// -------------------------------------------------</span>
        <span class="keywordflow">if</span> (bHasCredentials) <span class="comment">// New style of doing things, for Nym keys. Credentials!</span>
        {
            <span class="comment">// -------------------------------------------------</span>
            <span class="comment">// credentialList</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strCredentialList(ascArmor);

            <span class="keywordflow">if</span> (strCredentialList.Exists())
            {
                <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
                <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
                <span class="keywordflow">if</span> (NULL == pMap)
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: @createUserAccount: Failed decoding StringMap object.\n&quot;</span>, __FUNCTION__);
                <span class="comment">// ----------------------------------------</span>
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
                    <span class="comment">// ----------------------------------------</span>
                    <span class="comment">// NOTE: This action may very well be a malicious attacker saving a false</span>
                    <span class="comment">// credential list and a false set of credentials under a certain Nym ID!</span>
                    <span class="comment">// However, a Nym is always verified after loading, before being used for</span>
                    <span class="comment">// anything. (AND MUST BE.) And that includes before being saved to disk.</span>
                    <span class="comment">//</span>
                    <span class="comment">// DILEMMA at this point was, I don&#39;t want to save the credentials into the</span>
                    <span class="comment">// actual folder locations BEFORE they have been verified...</span>
                    <span class="comment">// SO I had to add &quot;LoadFromString&quot; functions to OTCredential (which I have done.)</span>
                    <span class="comment">// So now I should be able to continue here, load the credentials up from string,</span>
                    <span class="comment">// verify them, and if verified, THEN save them to disk...</span>
                    <span class="comment">// OTPseudonym::LoadFromString now allows you to load credentials from the map passed</span>
                    <span class="comment">// in (from the message) versus just reading them from local storage.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strCredentialList, &amp;theMap))
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @createUserAccount: Failure loading nym %s &quot;</span>
                                      <span class="stringliteral">&quot;from credential string.\n&quot;</span>,
                                      __FUNCTION__, theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }
                    <span class="comment">// Now that the Nym has been loaded up from the message parameters,</span>
                    <span class="comment">// including the list of credential IDs, and the map containing the</span>
                    <span class="comment">// credentials themselves, let&#39;s try to Verify the pseudonym. If we</span>
                    <span class="comment">// verify, then we&#39;re safe to save the credentials to storage.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @createUserAccount: Loaded nym %s &quot;</span>
                                      <span class="stringliteral">&quot;from credentials, but then it failed verifying.\n&quot;</span>,
                                      __FUNCTION__, theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }
                    <span class="keywordflow">else</span><span class="comment">// Okay, we loaded the Nym up from the credentials in the message, AND</span>
                    {   <span class="comment">// verified the Nym (including the credentials.)</span>
                        <span class="comment">// So let&#39;s save it to local storage...</span>
                        <span class="comment">//</span>

                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Pseudonym verified!\n&quot;</span>);
                        <span class="comment">// -------------------------------------------------------------</span>
                        <span class="comment">// Okay, now that the Nym is verified, let&#39;s verify the message itself...</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym)) <span class="comment">// FYI, OTMessage overrides VerifySignature with VerifySigAuthent.</span>
                        {                                               <span class="comment">// (Because we use authentication keys, not signing keys, for messages.)</span>
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;@createUserAccount: Authentication signature -- verification failed!\n&quot;</span>);
                            <span class="keywordflow">return</span> <span class="keyword">false</span>;
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Signature verified! The message WAS signed by &quot;</span>
                                          <span class="stringliteral">&quot;the Nym\&#39;s private authentication key.\n&quot;</span>);
                            <span class="comment">// ---------------------------------------------------------------</span>
                            <span class="comment">// SAVE the credentials to local storage, now that things are verified.</span>
                            <span class="comment">//</span>
                            std::string str_nym_id = theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
                            <a class="code" href="class_o_t_string.html">OTString</a> strFilename;
                            strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.cred&quot;</span>, str_nym_id.c_str());

                            <span class="keywordtype">bool</span>     bStoredList = <span class="keyword">false</span>;
                            <a class="code" href="class_o_t_string.html">OTString</a> strOutput;

                            <span class="keywordflow">if</span> (ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
                                ascArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput, <span class="stringliteral">&quot;CREDENTIAL LIST&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
                                strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                bStoredList = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                                                     <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                                                     strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            <span class="keywordflow">if</span> (!bStoredList)
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @createUserAccount: Failed trying to armor or store: %s\n&quot;</span>,
                                              __FUNCTION__, strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            <span class="comment">// -------------------------------------------------</span>
                            <span class="keywordflow">else</span> <span class="comment">// IF the list saved, then we save the credentials themselves...</span>
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@createUserAccount: Success saving public credential list for Nym: %s\n&quot;</span>,
                                               str_nym_id.c_str());
                                <span class="comment">// ----------------------------------------</span>
                                <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>, theMap)
                                {
                                    std::string str_cred_id = (*it).first;
                                    <a class="code" href="class_o_t_string.html">OTString</a>    strCredential((*it).second);
                                    <span class="comment">// ------------------------------------------</span>
                                    <span class="keywordtype">bool</span> bStoredCredential = <span class="keyword">false</span>;
                                    strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                                    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascLoopArmor(strCredential);
                                    <span class="keywordflow">if</span> (ascLoopArmor.Exists() &amp;&amp;
                                        ascLoopArmor.WriteArmoredString(strOutput, <span class="stringliteral">&quot;CREDENTIAL&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
                                        strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                        bStoredCredential = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                                                                   <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                                                                   str_nym_id,
                                                                                   str_cred_id);
                                    <span class="keywordflow">if</span> (!bStoredCredential)
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @createUserAccount: Failed trying to store credential %s for nym %s.\n&quot;</span>,
                                                      __FUNCTION__, str_cred_id.c_str(), str_nym_id.c_str());
                                    <span class="keywordflow">else</span>
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@createUserAccount: Success saving public credential ID: %s\n&quot;</span>,
                                                       str_cred_id.c_str());
                                } <span class="comment">//FOR_EACH</span>
                            } <span class="comment">// else (bStoredList)</span>
                            <span class="comment">// ---------------------------------------------------------------</span>
                            <span class="comment">// Make sure we are encrypting the message we send back, if possible.</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_string.html">OTString</a>          strPublicEncrKey, strPublicSignKey;
                            <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; thePublicEncrKey = (<a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp;)pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7a7b836bb9e8e0df7b3601f44e1b7220">GetPublicEncrKey</a>(); <span class="comment">// todo cast</span>
                            <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; thePublicSignKey = (<a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp;)pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aa60e86ffafcfba7c68801530c12c9927">GetPublicSignKey</a>(); <span class="comment">// todo cast</span>

                            thePublicEncrKey.<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strPublicEncrKey, <span class="keyword">false</span>); <span class="comment">// bEscaped=true by default</span>
                            thePublicSignKey.<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strPublicSignKey, <span class="keyword">false</span>); <span class="comment">// bEscaped=true by default</span>

                            <span class="comment">// We also (for now) set the Nym&#39;s keypair (which is being phased out entirely,</span>
                            <span class="comment">// and being replaced with credentials.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (strPublicSignKey.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acd9b375d6c16d11d7d0df1dcf1f543a7">SetPublicKey</a>(strPublicSignKey, <span class="keyword">false</span>); <span class="comment">// bEscaped=true by default</span>

                            <span class="comment">// This is only for verified Nyms, (and we&#39;re verified in here!) We do this so that</span>
                            <span class="comment">// we have the option later to encrypt the replies back to the client...(using the</span>
                            <span class="comment">// client&#39;s public key that we set here.)</span>
                            <span class="keywordflow">if</span> (strPublicEncrKey.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (NULL != pConnection))
                                pConnection-&gt;<a class="code" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">SetPublicKey</a>(thePublicEncrKey);
                            <span class="comment">// ---------------------------------------------------------------</span>
                            <span class="comment">// Look up the NymID and see if it&#39;s already a valid user account.</span>
                            <span class="comment">//</span>
                            <span class="comment">// If it is, then we can&#39;t very well create it twice, can we?</span>
                            <span class="comment">//</span>
                            <span class="comment">// UPDATE: Actually we should, in such cases, just return true with</span>
                            <span class="comment">// a copy of the Nymfile. Helps prevent sync errors, and gives people</span>
                            <span class="comment">// a way to grab the server&#39;s copy of their nymfile, if they need it.</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Verifying account doesn&#39;t already exist... &quot;</span>
                                          <span class="stringliteral">&quot;(IGNORE ANY ERRORS, IMMEDIATELY BELOW, ABOUT FAILURE OPENING FILES)\n&quot;</span>);

                            <span class="comment">// Prepare to send success or failure back to user.</span>
                            <span class="comment">// (1) set up member variables</span>
                            msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@createUserAccount&quot;</span>;     <span class="comment">// reply to createUserAccount</span>
                            msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;    <span class="comment">// UserID</span>
                            msgOut.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>    = m_strServerID;            <span class="comment">// ServerID, a hash of the server contract.</span>
                            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>       = <span class="keyword">false</span>;

                            <span class="comment">// already done, top of this function.</span>
<span class="comment">//                          msgOut.m_strRequestNum.Set(theMessage.m_strRequestNum); // to prevent replay attacks.</span>

                            <span class="comment">// We send the user&#39;s message back to him, ascii-armored,</span>
                            <span class="comment">// as part of our response.</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage;
                            theMessage.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(tempInMessage);
                            msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);

                            <span class="keywordtype">bool</span> bLoadedSignedNymfile = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(m_nymServer);

                            <span class="comment">// He ALREADY exists. We&#39;ll set success to true, and send him a copy of his own nymfile.</span>
                            <span class="comment">// (Signature is verified already anyway, by this point.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (bLoadedSignedNymfile &amp;&amp;
                                (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acae3c2ac801dbb0e33be9b3d493bbf4f">IsMarkedForDeletion</a>()))
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(Allowed in order to prevent sync issues) &quot;</span>
                                               <span class="stringliteral">&quot;==&gt; User is registering nym that already exists: %s\n&quot;</span>,
                                               theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                                <a class="code" href="class_o_t_string.html">OTString</a> strNymContents;
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac4914854cf1643e776b182055f40e97a">SavePseudonym</a>(strNymContents);
                                <span class="comment">// ------------------------</span>
                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNewNymID, SERVER_ID(m_strServerID);
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(theNewNymID);
                                <span class="comment">// ------------------------------------</span>
                                <a class="code" href="class_o_t_ledger.html">OTLedger</a>     theNymbox(theNewNymID, theNewNymID, SERVER_ID);
                                <span class="comment">// ------------------------------------</span>
                                <span class="keywordtype">bool</span> bSuccessLoadingNymbox  = theNymbox.LoadNymbox();

                                <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingNymbox)
                                    bSuccessLoadingNymbox   = (theNymbox.VerifyContractID() &amp;&amp; theNymbox.VerifyAccount(m_nymServer));
<span class="comment">//                                  bSuccessLoadingNymbox   = (theNymbox.VerifyAccount(m_nymServer)); // (No need here to load all the Box Receipts)</span>
                                <span class="keywordflow">else</span>
                                {
                                    bSuccessLoadingNymbox   = theNymbox.GenerateLedger(theNewNymID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

                                    <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                    {
                                        bSuccessLoadingNymbox   = theNymbox.SignContract(m_nymServer);

                                        <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                        {
                                            bSuccessLoadingNymbox = theNymbox.SaveContract();

                                            <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                                bSuccessLoadingNymbox   = theNymbox.SaveNymbox();
                                        }
                                    }
                                }
                                <span class="comment">// -----------------------------------------------------</span>
                                <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingNymbox)
                                {
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error during user account re-registration. Failed verifying or generating nymbox for user: %s\n&quot;</span>,
                                                  theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                }
                                <span class="comment">// -----------------------------------------------------</span>
                                msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strNymContents);
                                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>   = bSuccessLoadingNymbox;
                                msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);
                                msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                <span class="keywordflow">return</span> <span class="keyword">true</span>;
                            }
                            <span class="comment">// --------------------------------------</span>
                            <span class="keywordflow">else</span>
<span class="comment">//                               ((pNym-&gt;IsMarkedForDeletion()      &amp;&amp;  (true == bLoadedPublicKey)) ||  // We allow people to resurrect deleted Nyms.</span>
<span class="comment"></span><span class="comment">//                                (false == bLoadedPublicKey))                                          // can still buy usage credits.</span>
                            {
                                <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acae3c2ac801dbb0e33be9b3d493bbf4f">IsMarkedForDeletion</a>())
                                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#af9711e021a13ee987eb71bd598d5287a">MarkAsUndeleted</a>();

                                <span class="comment">// Good -- this means the account doesn&#39;t already exist.</span>
                                <span class="comment">// Let&#39;s create it.</span>

                                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(<a class="code" href="class_o_t_folders.html#a2651fe13634bb3164059f4969ae0dc65">OTFolders::UserAcct</a>().Get(), theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                                <span class="comment">// First we save the createUserAccount message in the accounts folder...</span>
                                <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
                                {
                                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Success saving new user account verification file.\n&quot;</span>);

                                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNewNymID, SERVER_ID(m_strServerID);
                                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(theNewNymID);
                                    <span class="comment">// ------------------------------------</span>
                                    <a class="code" href="class_o_t_ledger.html">OTLedger</a>     theNymbox(theNewNymID, theNewNymID, SERVER_ID);
                                    <span class="comment">// ------------------------------------</span>
                                    <span class="keywordtype">bool</span> bSuccessLoadingNymbox  = theNymbox.LoadNymbox();

                                    <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingNymbox) <span class="comment">// that&#39;s strange, this user didn&#39;t exist... but maybe I allow people to drop notes anyway, so then the nymbox might already exist, with usage tokens and messages inside....</span>
                                        bSuccessLoadingNymbox   = (theNymbox.VerifyContractID() &amp;&amp; theNymbox.VerifyAccount(m_nymServer));
<span class="comment">//                                      bSuccessLoadingNymbox   = (theNymbox.VerifyAccount(m_nymServer)); // (No need here to load all the Box Receipts)</span>
                                    <span class="keywordflow">else</span>
                                    {
                                        bSuccessLoadingNymbox   = theNymbox.GenerateLedger(theNewNymID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                        <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                        {
                                            bSuccessLoadingNymbox   = theNymbox.SignContract(m_nymServer);
                                            <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                            {
                                                bSuccessLoadingNymbox = theNymbox.SaveContract();

                                                <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                                                    bSuccessLoadingNymbox   = theNymbox.SaveNymbox();
                                            }
                                        }
                                    }
                                    <span class="comment">// -----------------------------------------------------</span>
                                    <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>

                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingNymbox)
                                    {
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error during user account registration. Failed verifying or generating nymbox for user: %s\n&quot;</span>,
                                                      theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    }
                                    <span class="comment">// Either we loaded it up (it already existed) or we didn&#39;t, in which case we should</span>
                                    <span class="comment">// save it now (to create it.)</span>
                                    <span class="comment">//</span>
                                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bLoadedSignedNymfile || pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer))
                                    {
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Success creating new Nym. (User account fully created.)\n&quot;</span>);

                                        <a class="code" href="class_o_t_string.html">OTString</a> strNymContents;
                                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac4914854cf1643e776b182055f40e97a">SavePseudonym</a>(strNymContents);
                                        <span class="comment">// ------------------</span>
                                        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strNymContents);
                                        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;
                                        msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);
                                        msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                        <span class="keywordflow">return</span> <span class="keyword">true</span>;
                                    }
                                    <span class="keywordflow">else</span>
                                    {
                                        msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);
                                        msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                        <span class="keywordflow">return</span> <span class="keyword">true</span>;
                                    }
                                }
                                <span class="keywordflow">else</span>
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error saving new user account verification file.\n&quot;</span>);
                                    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);
                                    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                    <span class="keywordflow">return</span> <span class="keyword">true</span>;
                                }
                            }
                            <span class="comment">// -------------</span>
                            <span class="keywordflow">return</span> <span class="keyword">true</span>;
                        }
                    } <span class="comment">// Success loading and verifying the Nym based on his credentials.</span>
                } <span class="comment">// Success decoding the map of credentials from the message.</span>
                <span class="comment">// -------------------------------------</span>
            } <span class="comment">// credential list exists, after base64-decoding.</span>
        } <span class="comment">// Has Credentials.</span>
    }
    <span class="comment">// ------------------------------------------------------------------------------------------</span>
    <span class="comment">// Look up the NymID and see if it&#39;s a valid user account.</span>
    <span class="comment">//</span>
    <span class="comment">// If we didn&#39;t receive a public key (above)</span>
    <span class="comment">// Or read one from our files (below)</span>
    <span class="comment">// ... then we&#39;d have no way of validating the requests.</span>
    <span class="comment">//</span>
    <span class="comment">// If it is, then we read the public key from that Pseudonym and use it to verify any</span>
    <span class="comment">// requests bearing that NymID.</span>
    <span class="comment">// ------------------------------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (!bNymIsServerNym                      &amp;&amp;
        (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>())   <span class="comment">// &amp;&amp; // Old style. (Deprecated, but fine for now since it calls LoadCredentials.)</span>
       )
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading public credentials for Nym: %s\n&quot;</span>, theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (!bNymIsServerNym &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acae3c2ac801dbb0e33be9b3d493bbf4f">IsMarkedForDeletion</a>())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(Failed) attempt by client to use a deleted Nym: %s\n&quot;</span>,
                       theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------------------------------------------------------------</span>
    <span class="comment">// Okay, the file was read into memory and Public Key was successfully extracted!</span>
    <span class="comment">// Next, let&#39;s use that public key to verify (1) the NymID and (2) the signature</span>
    <span class="comment">// on the message that we&#39;re processing.</span>

    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Pseudonym verified!\n&quot;</span>);

        <span class="comment">// So far so good. Now let&#39;s see if the signature matches...</span>
        <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Signature verified! The message WAS signed by &quot;</span>
                    <span class="stringliteral">&quot;the Nym\&#39;s private key.\n&quot;</span>);

            <span class="comment">// Get the public key from pNym, and set it into the connection.</span>
            <span class="comment">// This is only for verified Nyms, (and we&#39;re verified in here!) We do this so that</span>
            <span class="comment">// we have the option later to encrypt the replies back to the client...(using the</span>
            <span class="comment">// client&#39;s public key that we set here.)</span>
            <span class="keywordflow">if</span> (NULL != pConnection)
                pConnection-&gt;<a class="code" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">SetPublicKey</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7a7b836bb9e8e0df7b3601f44e1b7220">GetPublicEncrKey</a>());

            <span class="comment">// Now we might as well load up the rest of the Nym.</span>
            <span class="comment">// Notice I use the || to only load the nymfile if it&#39;s NOT the server Nym.</span>
            <span class="keywordflow">if</span> (bNymIsServerNym || pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(m_nymServer))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2,  <span class="stringliteral">&quot;Successfully loaded Nymfile into memory.\n&quot;</span>);

                <span class="comment">// *****************************************************************************</span>
                <span class="comment">// ENTERING THE INNER SANCTUM OF SECURITY. If the user got all the way to here,</span>
                <span class="comment">// Then he has passed multiple levels of security, and all commands below will</span>
                <span class="comment">// assume the Nym is secure, validated, and loaded into memory for use.</span>
                <span class="comment">//</span>
                <span class="comment">// But still need to verify the Request Number for all other commands except</span>
                <span class="comment">// Get Request Number itself...</span>
                <span class="comment">// *****************************************************************************</span>

                <span class="comment">// Request numbers start at 100 (currently). (Since certain special messages USE 1 already...</span>
                <span class="comment">// Such as messages that occur before requestnumbers are possible, like CreateUserAccount.)</span>
                <span class="comment">//</span>
                int64_t lRequestNumber = 0;

                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(m_strServerID, lRequestNumber))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Nym file request number doesn&#39;t exist. Apparently first-ever request to server--but everything checks out. &quot;</span>
                            <span class="stringliteral">&quot;(Shouldn&#39;t this request number have been created already when the NymFile was first created???????\n&quot;</span>);
                    <span class="comment">// FIRST TIME!  This account has never before made a single request to this server.</span>
                    <span class="comment">// The above call always succeeds unless the number just isn&#39;t there for that server.</span>
                    <span class="comment">// Therefore, since it&#39;s the first time, we&#39;ll create it now:</span>
                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(m_nymServer, m_strServerID);

                    <span class="comment">// Call it again so that lRequestNumber is set to 1 also</span>
                    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(m_strServerID, lRequestNumber))
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Created first request number in Nym file, apparently first-ever request. &quot;</span>
                                <span class="stringliteral">&quot;(Shouldn&#39;t this have been created already when the NymFile was first created???????\n&quot;</span>);
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR creating first request number in Nym file.\n&quot;</span>);
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                    }
                }

                <span class="comment">// At this point, I now have the current request number for this nym in lRequestNumber</span>
                <span class="comment">// Let&#39;s compare it to the one that was sent in the message... (This prevents attackers</span>
                <span class="comment">// from repeat-sending intercepted messages to the server.)</span>
                <span class="keywordflow">if</span> (<span class="keyword">false</span> == theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;getRequest&quot;</span>))        <span class="comment">// IF it&#39;s NOT a getRequest CMD, (therefore requires a request number)</span>
                {
                    <span class="keywordflow">if</span> (lRequestNumber != atol(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))  <span class="comment">// AND the request number attached does not match what we just read out of the file...</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Request number sent in this message %ld does not match the one in the file! (%ld)\n&quot;</span>,
                                atol(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), lRequestNumber);
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                    }
                    <span class="keywordflow">else</span> <span class="comment">// it&#39;s not a getRequest CMD, and the request number sent DOES match what we read out of the file!!</span>
                    {
                        <span class="comment">// USAGE CREDITS...</span>
                        <span class="comment">// Since (just below) we IncrementRequestNum() and therefore save the Nym,</span>
                        <span class="comment">// I figured it&#39;s a good spot to do our Usage Credits code, so we don&#39;t have</span>
                        <span class="comment">// to save twice.</span>
                        <span class="comment">// ----------------------------------------------------------------------------</span>
                        <span class="keywordflow">if</span> ((<span class="keyword">true</span> == OTServer::__admin_usage_credits) &amp;&amp;    <span class="comment">// IF (the OT Server is in &quot;require usage credits&quot; mode)</span>
                            (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a4469f9108d8239b72e6ebc6bc5b2b4a9">GetUsageCredits</a>() &gt;= 0 ) &amp;&amp;              <span class="comment">// AND the User isn&#39;t magically FREE from having to use usage credits (-1 is a get-out-of-jail-free-card.)</span>
                            ((<a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().size() &lt;= 0) ||  <span class="comment">// AND (there&#39;s no Override Nym ID listed --OR-- the Override Nym ID doesn&#39;t</span>
                             (0 != <a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().compare((theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())))))   <span class="comment">// match the Nym&#39;s ID who sent this message)</span>
                        {
                            <span class="keyword">const</span> int64_t &amp; lUsageCredits = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a4469f9108d8239b72e6ebc6bc5b2b4a9">GetUsageCredits</a>();

                            <span class="keywordflow">if</span> (0 == lUsageCredits) <span class="comment">// If the User has ZERO USAGE CREDITS LEFT. (Too bad, even 1 would have squeezed him by here.)</span>
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Nym %s: ALL OUT of Usage Credits, while server is in **REQUIRE USAGE CREDITS MODE**!\n&quot;</span>,
                                               theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                <span class="keywordflow">return</span> <span class="keyword">false</span>;
                            }

                            <span class="keyword">const</span> int64_t lUsageFinal = (lUsageCredits-1);
                            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#afdd9f22128599dc00dbec2d5fb4ad43d">SetUsageCredits</a>(lUsageFinal);
                        }
                        <span class="comment">// ----------------------------------------------------------------------------</span>

                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;Request number sent in this message %ld DOES match the one in the file!\n&quot;</span>, lRequestNumber);

                        <span class="comment">// At this point, it is some OTHER command (besides getRequest)</span>
                        <span class="comment">// AND the request number verifies, so we&#39;re going to increment</span>
                        <span class="comment">// the number, and let the command process.</span>
                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(m_nymServer, m_strServerID);

                        <span class="comment">// *****************************************************************************</span>
                        <span class="comment">// **INSIDE** THE INNER SANCTUM OF SECURITY. If the user got all the way to here,</span>
                        <span class="comment">// Then he has passed multiple levels of security, and all commands below will</span>
                        <span class="comment">// assume the Nym is secure, validated, and loaded into memory for use. They can</span>
                        <span class="comment">// also assume that the request number has been verified on this message.</span>
                        <span class="comment">// EVERYTHING checks out.</span>
                        <span class="comment">// *****************************************************************************</span>

                        <span class="comment">// NO RETURN HERE!!!! ON PURPOSE!!!!</span>
                    }

                }
                <span class="keywordflow">else</span>  <span class="comment">// If you entered this else, that means it IS a getRequest command</span>
                      <span class="comment">// So we allow it to go through without verifying this step, and without incrementing the counter.</span>
                {
                    <span class="comment">//pNym-&gt;IncrementRequestNum(m_strServerID); // commented out cause this is the one case where we DON&#39;T increment this number.</span>
                                                           <span class="comment">// We allow the user to get the number, we DON&#39;T increment it, and now the user</span>
                                                           <span class="comment">// can send it on his next request for some other command, and it will verify</span>
                                                           <span class="comment">// properly. This prevents repeat messages.</span>

                    <span class="comment">// NO RETURN HERE!!!! ON PURPOSE!!!!</span>
                }


                <span class="comment">// At this point, we KNOW that it is EITHER a GetRequest command, which doesn&#39;t require a request number,</span>
                <span class="comment">// OR it was some other command, but the request number they sent in the command MATCHES the one that we</span>
                <span class="comment">// just read out of the file.</span>

                <span class="comment">// Therefore, we can process ALL messages below this</span>
                <span class="comment">// point KNOWING that the Nym is properly verified in all ways.</span>
                <span class="comment">// No messages need to worry about verifying the Nym, or about</span>
                <span class="comment">// dealing with the Request Number. It&#39;s all handled in here.</span>

            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading Nymfile: %s\n&quot;</span>, theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Signature verification failed!\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Pseudonym failed to verify. Hash of public key doesn&#39;t match &quot;</span>
                <span class="stringliteral">&quot;Nym ID that was sent.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }


    <span class="comment">// ----------------------------------------------------------------------------------------</span>


    <span class="comment">// If you made it down this far, that means the Pseudonym verifies! The message is legit.</span>
    <span class="comment">//</span>
    <span class="comment">// (Server ID was good, NymID is a valid hash of User&#39;s public key, and the Signature on</span>
    <span class="comment">// the message was signed by the user&#39;s private key.)</span>
    <span class="comment">//</span>
    <span class="comment">// Now we can process the message.</span>
    <span class="comment">//</span>
    <span class="comment">// All the commands below here, it is assumed that the user account exists and is</span>
    <span class="comment">// referenceable via pNym. (An OTPseudonym object.)</span>
    <span class="comment">//</span>
    <span class="comment">// ALL commands below can assume the Nym is real, and that the NymID and Public Key are</span>
    <span class="comment">// available for use -- and that they verify -- without having to check again and again.</span>

    <span class="comment">// ----------------------------------------------------------------------------------------</span>

    <span class="comment">// ACKNOWLEDGMENTS OF REPLIES ALREADY RECEIVED (FOR OPTIMIZATION.)</span>

    <span class="comment">// On the client side, whenever the client is DEFINITELY made aware of the existence of a</span>
    <span class="comment">// server reply, he adds its request number to this list, which is sent along with all client-side</span>
    <span class="comment">// requests to the server.</span>
    <span class="comment">// The server reads the list on the incoming client message (and it uses these same functions</span>
    <span class="comment">// to store its own internal list.) If the # already appears on its internal list, then it does</span>
    <span class="comment">// nothing. Otherwise, it loads up the Nymbox and removes the replyNotice, and then adds the #</span>
    <span class="comment">// to its internal list.</span>
    <span class="comment">// For any numbers on the internal list but NOT on the client&#39;s list, the server removes from</span>
    <span class="comment">// the internal list. (The client removed them when it saw the server&#39;s internal list, which the</span>
    <span class="comment">// server sends with its replies.)</span>
    <span class="comment">//</span>
    <span class="comment">// This entire protocol, densely described, is unnecessary for OT to function, but is great for</span>
    <span class="comment">// optimization, as it enables OT to avoid downloading all Box Receipts containing replyNotices,</span>
    <span class="comment">// as long as the original reply was properly received when the request was originally sent (which</span>
    <span class="comment">// is MOST of the time...)</span>
    <span class="comment">// Thus we can eliminate most replyNotice downloads, and likely a large % of box receipt downloads</span>
    <span class="comment">// as well.</span>
    <span class="comment">//</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID);

    <span class="comment">// The server reads the list of acknowledged replies from the incoming client message...</span>
    <span class="comment">//</span>
    <span class="keywordtype">bool</span> bIsDirtyNym    = <span class="keyword">false</span>; <span class="comment">// if we add any acknowledged replies to the server-side list, we will want to save (at the end.)</span>
    <span class="keywordtype">bool</span> bIsDirtyNymbox = <span class="keyword">false</span>; <span class="comment">// if we remove any replyNotices from the Nymbox, then we will want to save the Nymbox (at the end.)</span>

    std::set&lt;int64_t&gt; numlist_ack_reply;
    <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a8ebd61b24f8b983cf02a1a49d21e3ec4">m_AcknowledgedReplies</a>.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(numlist_ack_reply)) <span class="comment">// returns false if the numlist was empty.</span>
    {
        <span class="comment">// Load Nymbox</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(), pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(), SERVER_ID);

        <span class="keywordflow">if</span> (theNymbox.LoadNymbox() &amp;&amp; theNymbox.VerifySignature(m_nymServer))
        {
            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, numlist_ack_reply)
            {
                <span class="keyword">const</span> int64_t lRequestNum = *it;
                <span class="comment">// ----------------------------</span>
                <span class="comment">// If the # already appears on its internal list, then it does nothing. (It must have already done</span>
                <span class="comment">// whatever it needed to do, since it already has the number recorded as acknowledged.)</span>
                <span class="comment">//</span>
                <span class="comment">// Otherwise, if the # does NOT already appear on server&#39;s internal list, then it loads up the</span>
                <span class="comment">// Nymbox and removes the replyNotice, and then adds the # to its internal list for safe-keeping.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a11fd56ffbcef5fcebbd259bdb1bd7c8e">VerifyAcknowledgedNum</a>(m_strServerID, lRequestNum))
                {
                    <span class="comment">// Verify whether a replyNotice exists in the Nymbox, with that lRequestNum</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pReplyNotice = theNymbox.GetReplyNotice(lRequestNum);

                    <span class="keywordflow">if</span> (NULL != pReplyNotice)
                    {
                        <span class="comment">// If so, remove it...</span>
                        <span class="comment">//</span>
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bDeleted = pReplyNotice-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theNymbox);
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemoved = theNymbox.RemoveTransaction(pReplyNotice-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// deletes</span>
                        pReplyNotice = NULL;
                        <span class="comment">// (pReplyNotice is deleted, below this point, automatically by the above Remove call.)</span>

                        <span class="keywordflow">if</span> (!bDeleted || !bRemoved)
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::ProcessUserCommand: Failed trying to delete a box receipt, or &quot;</span>
                                         <span class="stringliteral">&quot;while removing its stub from the Nymbox.\n&quot;</span>);

                        <span class="comment">// ...and add lRequestNum to server&#39;s acknowledgment list. (So this can&#39;t happen twice with same #.)</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ae6b11aa38ba2894e1d8386d6e5589e2f">AddAcknowledgedNum</a>(m_strServerID, lRequestNum)) <span class="comment">// doesn&#39;t save (here).</span>
                            bIsDirtyNym    = <span class="keyword">true</span>; <span class="comment">// So we don&#39;t have to save EACH iteration, but instead just once at the bottom.</span>

                        <span class="keywordflow">if</span> (bRemoved)
                            bIsDirtyNymbox = <span class="keyword">true</span>; <span class="comment">// So we don&#39;t have to save EACH iteration, but instead just once at the bottom.</span>
                    }
                } <span class="comment">// If server didn&#39;t already have a record of this acknowledged request #.</span>
            } <span class="comment">// FOR_EACH</span>
            <span class="comment">// --------------------------</span>

            <span class="keywordflow">if</span> (bIsDirtyNymbox)
            {
                theNymbox.ReleaseSignatures();
                theNymbox.SignContract(m_nymServer);
                theNymbox.SaveContract();
                theNymbox.SaveNymbox();
            }
        } <span class="comment">// If nymbox loaded and verified.</span>
    }
    <span class="comment">// ------------------------------------</span>

    <span class="comment">// For any numbers on the server&#39;s internal list but NOT on the client&#39;s list, the server removes from</span>
    <span class="comment">// the internal list. (Because the client must have seen my acknowledgment and thus removed the number</span>
    <span class="comment">// from its own list, so the server doesn&#39;t need to display it anymore.)</span>
    <span class="comment">//</span>
    <span class="comment">// Thus: iterate through the server&#39;s list of numbers, and see if each is on the client&#39;s list. If not,</span>
    <span class="comment">// then remove it from my own (server&#39;s) internal list as well.</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_num_list.html">OTNumList</a> numlist_to_remove; <span class="comment">// a temp variable where we will put the numbers &quot;to be removed&quot; (so we can remove them all at once, after the loop.)</span>
    <span class="keyword">const</span> int32_t nAcknowledgedNumCount = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7f5e5ae674b53d13ab71a343c8924c8a">GetAcknowledgedNumCount</a>(SERVER_ID);

    <span class="keywordflow">if</span> (nAcknowledgedNumCount &gt; 0)
    {
        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nAcknowledgedNumCount; i++)
        {
            <span class="keyword">const</span> int64_t lAcknowledgedNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a734cf5ea45bdcabf9a479acf1b5e6f7a">GetAcknowledgedNum</a>(SERVER_ID, i); <span class="comment">// index</span>

            <span class="comment">// For any numbers on the server&#39;s internal list but NOT on the client&#39;s list (according</span>
            <span class="comment">// to the incoming message) the server removes them from its internal list. (If the client</span>
            <span class="comment">// is done with them, then so is the server.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (<span class="keyword">false</span> == theMessage.<a class="code" href="class_o_t_message.html#a8ebd61b24f8b983cf02a1a49d21e3ec4">m_AcknowledgedReplies</a>.<a class="code" href="class_o_t_num_list.html#ac9692a20a114672de9e02a18b1cdd5e6">Verify</a>(lAcknowledgedNum))
            {
                numlist_to_remove.Add(lAcknowledgedNum);
            }
        } <span class="comment">// for</span>
        <span class="comment">// ---------------------------------</span>
        <span class="keywordflow">if</span> (numlist_to_remove.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>() &gt; 0)
        {
            std::set&lt;int64_t&gt; set_server_ack;
            <span class="comment">// -----------------------------------</span>
            <span class="keywordflow">if</span> (numlist_to_remove.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(set_server_ack))
                <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, set_server_ack)
                {
                    <span class="keyword">const</span> int64_t lRequestNum = *it;
                    <span class="comment">// --------------------------</span>
                    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0d8fd416811828f1eb8c07eb141790c2">RemoveAcknowledgedNum</a>(m_nymServer, m_strServerID, lRequestNum, <span class="keyword">false</span>)) <span class="comment">// bSave=false</span>
                        bIsDirtyNym = <span class="keyword">true</span>;
                }
        }
    } <span class="comment">// if there are server-side ack numbers that could potentially be removed, if client&#39;s message doesn&#39;t list them.</span>
    <span class="comment">// -------------------------------------------</span>

    <span class="keywordflow">if</span> (bIsDirtyNym)
    {
        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer); <span class="comment">// we save here.</span>
    }

    <span class="comment">// Note: in the ultimate future, we wouldn&#39;t even save the Nym down here, but we&#39;ll let the entire message process</span>
    <span class="comment">// and then save the Nym at the end.</span>
    <span class="comment">// Then again -- you&#39;d still want to know if the Nym was locked, at each &quot;save attempt&quot; along the way. Because even</span>
    <span class="comment">// though the Nym might not actually save at each of those signposts, it should still CANCEL OUT IF IT WOULD FAIL TRYING.</span>
    <span class="comment">// Of course we still only want to save the Nym once, but we still want each step along the way -- each vital step that</span>
    <span class="comment">// would normally have saved each time -- to know whether or not it will actually work, and if not, to fail the message</span>
    <span class="comment">// AT THAT POINT and not somewhere much later, at the bottom, after all kinds of other processing has been done.</span>
    <span class="comment">//</span>
    <span class="comment">// Therefore in the new version we will probably still &quot;Save&quot; the Nym at each critical point, but INTERNALLY, it won&#39;t</span>
    <span class="comment">// actually save until the bottom. BUT, even though it won&#39;t actually save, it will still know if the TIMESTAMP IS WITHIN</span>
    <span class="comment">// VALID RANGE (each time), and it will still know that it has definitely locked the resource (which happens the first time)</span>
    <span class="comment">// and it will still want to set the resource as dirty, internally, even when it doesn&#39;t save it right away, because otherwise</span>
    <span class="comment">// it wouldn&#39;t know to save it later, either.</span>

    msgOut.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>    = m_strServerID;
    msgOut.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER msgOut.m_strServerID is already set. (It uses it.)</span>

    <span class="comment">// ****************************************************************************************************</span>


    <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;getRequest&quot;</span>)) <span class="comment">// This command is special because it&#39;s the only one that doesn&#39;t require a request number.</span>
                                                       <span class="comment">// All of the other commands, below, will fail above if the proper request number isn&#39;t included</span>
                                                       <span class="comment">// in the message.  They will already have failed by this point if they didn&#39;t verify.</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getRequest message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_request);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#af69a358a7b5214d6200fe8d838e7f5d9">UserCmdGetRequest</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;getTransactionNum&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getTransactionNum message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_trans_num);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a8c6822ad744234645f3086bbf99e0c43">UserCmdGetTransactionNum</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;checkUser&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a checkUser message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_check_user);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#af06ca9655b68edd3c6352e8ad0683b57">UserCmdCheckUser</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;sendUserMessage&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a sendUserMessage message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_send_message);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a8e8879f4902244d2e55debee8ee335a6">UserCmdSendUserMessage</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;sendUserInstrument&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a sendUserInstrument message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_send_message);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#aad4515adb7c48a0d4b30140de99c727b">UserCmdSendUserInstrument</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteUserAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a deleteUserAccount message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_del_user_acct);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a814dd4abce3b6b338b07602143f6636e">UserCmdDeleteUser</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteAssetAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a deleteAssetAccount message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_del_asset_acct);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a75f0645baa92a4f273ffb726eefa5a39">UserCmdDeleteAssetAcct</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;createAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a createAccount message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_create_asset_acct);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a7cbd0ac6cbdf34d1e49ff96979691896" title="An existing user is creating an asset account.">UserCmdCreateAccount</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;issueAssetType&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received an issueAssetType message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_issue_asset);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a4ed65b2a39d3493cae05af541aafab7f" title="An existing user is issuing a new currency.">UserCmdIssueAssetType</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;issueBasket&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received an issueBasket message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_issue_basket);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#ad8d48ac00f17dd758ee1ce638ec5eb3e" title="An existing user is creating an issuer account (that he will not control) based on a basket of curren...">UserCmdIssueBasket</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;notarizeTransactions&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a notarizeTransactions message.  Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_notarize_transaction);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a6ac2aae7675c14c1bbb4b6ef87c70499">UserCmdNotarizeTransactions</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;getNymbox&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getNymbox message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_nymbox);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a0787e731cb0e2622677a7b7f25d9958c">UserCmdGetNymbox</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;getBoxReceipt&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getBoxReceipt message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordtype">bool</span> bRunIt = <span class="keyword">true</span>;
        <span class="comment">// ------------------------------------------------------------</span>
        <span class="keywordflow">if</span> (0 == theMessage.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>)
            <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_nymbox)
        else if (1 == theMessage.m_lDepth)
            <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_inbox)
        else if (2 == theMessage.m_lDepth)
            <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_outbox)
        else
            bRunIt = false;
        <span class="comment">// ------------------------------------------------------------</span>

        if (bRunIt)
            <a class="code" href="class_o_t_server.html#a5eb462c4e3d26d4ee2afbfbc151a4a37">UserCmdGetBoxReceipt</a>(*pNym, theMessage, msgOut);

        return true;
    }
    else if (theMessage.m_strCommand.Compare(&quot;getInbox&quot;))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getInbox message.  Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.m_strAcctID.Get(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_inbox);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#ae660ce647967c554cbaed3888194160a">UserCmdGetInbox</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getOutbox&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getOutbox message.  Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.m_strAcctID.Get(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_outbox);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a59d3bba46b92f43461163bb5e99e15bd">UserCmdGetOutbox</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getAccount message.  Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.m_strAcctID.Get(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_acct);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#af9644fd5e95a200a2689462a1caae6e8">UserCmdGetAccount</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getAccountFiles&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getAccountFiles message.  Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.m_strAcctID.Get(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_inbox);
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_outbox);
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_acct);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#aff8c02fe93fe3f8fbe5ab8d30981ad8b">UserCmdGetAccountFiles</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;processNymbox&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a processNymbox message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_process_nymbox);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a4c00992f16de5ef6f69fe6dfcf5556a9">UserCmdProcessNymbox</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;processInbox&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a processInbox message. Acct: %s Nym: %s  ...\n&quot;</span>,
                       theMessage.m_strAcctID.Get(), strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_process_inbox);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a45345893df0734299bd86c7dbddc4628">UserCmdProcessInbox</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;queryAssetTypes&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a queryAssetTypes message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_contract);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#ae7877e32c7ebfdf4abcecfb7d9494269">UserCmdQueryAssetTypes</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getContract&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getContract message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_contract);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#aa677b01656359ef72a78a7935eb0bf40">UserCmdGetContract</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getMint&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getMint message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_mint);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#ae4ca69c54f16ba79ac6ee46d214795d0">UserCmdGetMint</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getMarketList&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getMarketList message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_market_list);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a8613c995889d628dde61855c1eae1e3a">UserCmdGetMarketList</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getMarketOffers&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getMarketOffers message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_market_offers);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#aaad2e2c40409f5377cf867cbdae677bc">UserCmdGetMarketOffers</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getMarketRecentTrades&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getMarketRecentTrades message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_market_recent_trades);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a2063c2f8497f69026e4e1a740218828b">UserCmdGetMarketRecentTrades</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;getNym_MarketOffers&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a getNym_MarketOffers message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_get_nym_market_offers);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#aa205b6d4560bfb2e728c9ad48f084283">UserCmdGetNym_MarketOffers</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;triggerClause&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a triggerClause message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_trigger_clause);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a45d6cb87281eca8c86b51926dd87c2e1">UserCmdTriggerClause</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMessage.m_strCommand.Compare(<span class="stringliteral">&quot;usageCredits&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n==&gt; Received a usageCredits message. Nym: %s ...\n&quot;</span>, strMsgNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ------------------------------------------------------------</span>
        <a class="code" href="_o_t_server_8cpp.html#a0b260f72e0a52a556f556b326cd0e237">OT_ENFORCE_PERMISSION_MSG</a>(__cmd_usage_credits);
        <span class="comment">// ------------------------------------------------------------</span>

        <a class="code" href="class_o_t_server.html#a26de1a410e0281e6a19caa28db7a1c39">UserCmdUsageCredits</a>(*pNym, theMessage, msgOut);

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Unknown command type in the XML, or missing payload, in ProcessMessage.\n&quot;</span>);
        <span class="comment">// --------------------------------------------------------------------------------</span>

        <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
        strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;@%s&quot;</span>, theMessage.m_strCommand.Get()); <span class="comment">// Todo security. Review this.</span>

        msgOut.m_strCommand   = strTemp;
        msgOut.m_strAcctID    = theMessage.m_strAcctID;
        msgOut.m_strServerID  = theMessage.m_strServerID;
        msgOut.m_strNymID     = theMessage.m_strNymID;

        msgOut.m_bSuccess = <span class="keyword">false</span>;

        <a class="code" href="class_o_t_string.html">OTString</a> strRef(theMessage);

        msgOut.m_ascInReferenceTo.SetString(strRef);

        msgOut.SignContract(m_nymServer);
        msgOut.SaveContract();

        <span class="comment">// --------------------------------------------------------------------------------</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad43926bb616a0e9ff5647a1fa03767f0"></a><!-- doxytag: member="OTServer::Release" ref="ad43926bb616a0e9ff5647a1fa03767f0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ad43926bb616a0e9ff5647a1fa03767f0">OTServer::Release</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01297">1297</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_server.html#a46ffd986f1f8f7c64ba58db8297f22a7">Release_Server</a>();

    <span class="comment">// ot_super::Release() call would normally go here, if we had a super class.</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a46ffd986f1f8f7c64ba58db8297f22a7"></a><!-- doxytag: member="OTServer::Release_Server" ref="a46ffd986f1f8f7c64ba58db8297f22a7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a46ffd986f1f8f7c64ba58db8297f22a7">OTServer::Release_Server</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l01229">1229</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// -------------------------------</span>
    <span class="keywordflow">if</span> (NULL == m_pServerContract)
        <span class="keyword">delete</span> m_pServerContract;
    m_pServerContract = NULL;
    <span class="comment">// -------------------------------</span>
    <span class="comment">// Erase various dynamically-allocated objects...</span>
    <span class="comment">// (asset contracts, and mints, for example.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">while</span> (m_mapContracts.size() &gt; 0)
    {
        mapOfContracts::iterator it = m_mapContracts.begin();
        <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
        <span class="comment">// --------------------------</span>
        m_mapContracts.erase(it);
        <span class="comment">// --------------------------</span>
        <span class="keyword">delete</span> pContract;
        pContract = NULL;
    }
    <span class="comment">// -------------------------------</span>
    <span class="comment">// Mints...</span>
    <span class="comment">//</span>
    <span class="keywordflow">while</span> (m_mapMints.size() &gt; 0)
    {
        mapOfMints::iterator it = m_mapMints.begin();
        <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
        <span class="comment">// --------------------------</span>
        m_mapMints.erase(it);
        <span class="comment">// --------------------------</span>
        <span class="keyword">delete</span> pMint;
        pMint = NULL;
    }
    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// PID -- Set it to 0 in the lock file so the next time we run OT, it knows there isn&#39;t</span>
    <span class="comment">// another copy already running (otherwise we might wind up with two copies trying to write</span>
    <span class="comment">// to the same data folder simultaneously, which could corrupt the data...)</span>
    <span class="comment">//</span>
<span class="comment">//    OTLog::vError(&quot;m_strDataPath: %s\n&quot;, m_strDataPath.Get());</span>
<span class="comment">//    OTLog::vError(&quot;SERVER_PID_FILENAME: %s\n&quot;, SERVER_PID_FILENAME);</span>

    <a class="code" href="class_o_t_string.html">OTString</a> strDataPath;
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGetDataFolderSuccess = <a class="code" href="class_o_t_data_folder.html#a3cc847ac0fc0e30eb0f37dc8ecc9cec3">OTDataFolder::Get</a>(strDataPath);
    <span class="comment">// ----------------------------------------------</span>
    <span class="keywordflow">if</span> (!m_bReadOnly &amp;&amp; bGetDataFolderSuccess)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strPIDPath;
        <a class="code" href="class_o_t_paths.html#a149093f1bcedb1b792a8262f41b05f35">OTPaths::AppendFile</a>(strPIDPath, strDataPath, <a class="code" href="_o_t_server_8cpp.html#ac965e824dfe0199632423fa896071e1e">SERVER_PID_FILENAME</a>);

        uint32_t the_pid = 0;

        std::ofstream pid_outfile(strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordflow">if</span> (pid_outfile.is_open())
        {
            pid_outfile &lt;&lt; the_pid;
            pid_outfile.close();
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed trying to open data locking file (to wipe PID back to 0): %s\n&quot;</span>,
                          strPIDPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab7d81feacfb032dd09b7714f77c3ecba"></a><!-- doxytag: member="OTServer::RemoveIssuedNumber" ref="ab7d81feacfb032dd09b7714f77c3ecba" args="(OTPseudonym &amp;theNym, const int64_t &amp;lTransactionNumber, bool bSave=false)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba">OTServer::RemoveIssuedNumber</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bSave</em> = <code>false</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove an issued number from the Nym record once that nym accepts the receipt from his inbox. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00701">701</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID(theNym), SERVER_NYM_ID(m_nymServer);

    <span class="comment">// If theNym has the same ID as m_nymServer, then we&#39;ll use m_nymServer</span>
    <span class="comment">// instead of theNym.  (Since it&#39;s the same nym anyway, we&#39;ll stick to the</span>
    <span class="comment">// one we already loaded so any changes don&#39;t get overwritten later.)</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = NULL;

    <span class="keywordflow">if</span> (NYM_ID == SERVER_NYM_ID)
        pNym = &amp;m_nymServer;
    <span class="keywordflow">else</span>
        pNym = &amp;theNym;

    <span class="keywordtype">bool</span> bRemoved = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(m_nymServer, m_strServerID, lTransactionNumber, bSave);

    <span class="keywordflow">return</span> bRemoved;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad0d2bc78b1059086d78e7f6d5aa1a874"></a><!-- doxytag: member="OTServer::RemoveTransactionNumber" ref="ad0d2bc78b1059086d78e7f6d5aa1a874" args="(OTPseudonym &amp;theNym, const int64_t &amp;lTransactionNumber, bool bSave=false)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874">OTServer::RemoveTransactionNumber</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bSave</em> = <code>false</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove a transaction number from the Nym record once it's officially used/spent. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00675">675</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID(theNym), SERVER_NYM_ID(m_nymServer);

    <span class="comment">// If theNym has the same ID as m_nymServer, then we&#39;ll use m_nymServer</span>
    <span class="comment">// instead of theNym.  (Since it&#39;s the same nym anyway, we&#39;ll stick to the</span>
    <span class="comment">// one we already loaded so any changes don&#39;t get overwritten later.)</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = NULL;

    <span class="keywordflow">if</span> (NYM_ID == SERVER_NYM_ID)
        pNym = &amp;m_nymServer;
    <span class="keywordflow">else</span>
        pNym = &amp;theNym;

    <span class="keywordtype">bool</span> bRemoved = <span class="keyword">false</span>;

    <span class="keywordflow">if</span> (bSave)
        bRemoved = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3fb93588f8e68c7f56cee00930f07d34">RemoveTransactionNum</a>(m_nymServer, m_strServerID, lTransactionNumber); <span class="comment">// the version that passes in a signer nym -- saves to local storage.</span>
    <span class="keywordflow">else</span>
        bRemoved = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3fb93588f8e68c7f56cee00930f07d34">RemoveTransactionNum</a>(m_strServerID, lTransactionNumber); <span class="comment">// the version that doesn&#39;t save.</span>

    <span class="keywordflow">return</span> bRemoved;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa0f5b043756e7838af38539f4053ab24"></a><!-- doxytag: member="OTServer::SaveMainFile" ref="aa0f5b043756e7838af38539f4053ab24" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">OTServer::SaveMainFile</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00887">887</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// ---------------------------------------------------------------</span>
    <span class="comment">// Get the loaded (or new) version of the Server&#39;s Main File.</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strMainFile;

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#a03d8221976e078b5deb04dacdbc37e64">SaveMainFileToString</a>(strMainFile))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving to string. (Giving up on save attempt.)\n&quot;</span>, __FUNCTION__);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">// Try to save the notary server&#39;s main datafile to local storage...</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(strMainFile);

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.WriteArmoredString(strFinal, <span class="stringliteral">&quot;NOTARY&quot;</span>)) <span class="comment">// todo hardcoding.</span>
    {

        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving notary (failed writing armored string)\n&quot;</span>, __FUNCTION__);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">// Save the Main File to the Harddrive... (or DB, if other storage module is being used).</span>
    <span class="comment">//</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSaved = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),<span class="stringliteral">&quot;.&quot;</span>, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

    <span class="keywordflow">if</span> (!bSaved)  <span class="comment">// Check if successfull.</span>
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving main file: %s\n&quot;</span>, __FUNCTION__, m_strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

    <span class="keywordflow">return</span> bSaved;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a03d8221976e078b5deb04dacdbc37e64"></a><!-- doxytag: member="OTServer::SaveMainFileToString" ref="a03d8221976e078b5deb04dacdbc37e64" args="(OTString &amp;strMainFile)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a03d8221976e078b5deb04dacdbc37e64">OTServer::SaveMainFileToString</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strMainFile</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00773">773</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::SaveMainFileToString&quot;</span>;
    <span class="comment">// ---------------------------------------------------------------</span>

    strMainFile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
                       <span class="stringliteral">&quot;&lt;notaryServer version=\&quot;%s\&quot;\n&quot;</span>
                       <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;\n&quot;</span>
                       <span class="stringliteral">&quot; serverUserID=\&quot;%s\&quot;\n&quot;</span>
                       <span class="stringliteral">&quot; transactionNum=\&quot;%ld\&quot; &gt;\n\n&quot;</span>,
                       <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;IsGenerated() ? <span class="stringliteral">&quot;2.0&quot;</span> : m_strVersion.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                       m_strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                       m_strServerUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                       m_lTransactionNumber);



    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;IsGenerated()) <span class="comment">// If it exists, then serialize it.</span>
    {
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascMasterContents;

        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SerializeTo(ascMasterContents))
        {
            strMainFile.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;cachedKey&gt;\n%s&lt;/cachedKey&gt;\n\n&quot;</span>, ascMasterContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to write master key to notary file.\n&quot;</span>, szFunc);
    }
    <span class="comment">// ---------------------------------------------------------------</span>

    <span class="comment">//mapOfContracts    m_mapContracts;   // If the server needs to store copies of the asset contracts, then here they are.</span>
    <span class="comment">//mapOfMints        m_mapMints;       // Mints for each of those.</span>

    <span class="comment">// ---------------------------------------------------------------</span>

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_asset_contract_8hpp.html#a88f3c1b8259d44ecd0d15628789315cb">mapOfContracts</a>, m_mapContracts)
    {
        <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;NULL contract pointer in OTServer::SaveMainFile.\n&quot;</span>);

        <span class="comment">// This is like the Server&#39;s wallet.</span>
        pContract-&gt;<a class="code" href="class_o_t_contract.html#af16a41ce18a9e3408fc5c9ee18315a30">SaveContractWallet</a>(strMainFile);

    }

    <span class="comment">// ----------------------------------------------------------------</span>

    <span class="comment">// Save the basket account information</span>

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#a25e6368c39fb959e4cb7b6c2cdef4f40">mapOfBaskets</a>, m_mapBaskets)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketID        = (*it).first.c_str();
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID    = (*it).second.c_str();

        <span class="keyword">const</span>   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> BASKET_ACCOUNT_ID(strBasketAcctID);
                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> BASKET_CONTRACT_ID;

        <span class="keywordtype">bool</span> bContractID = <a class="code" href="class_o_t_server.html#ae347553eb664ea7416240d0f5c9e9ebf">LookupBasketContractIDByAccountID</a>(BASKET_ACCOUNT_ID, BASKET_CONTRACT_ID);

        <span class="keywordflow">if</span> (!bContractID)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Missing Contract ID for basket ID %s\n&quot;</span>, szFunc,
                          strBasketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keywordflow">break</span>;
        }

        <a class="code" href="class_o_t_string.html">OTString</a> strBasketContractID(BASKET_CONTRACT_ID);

        strMainFile.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;basketInfo basketID=\&quot;%s\&quot;\n&quot;</span>
                                <span class="stringliteral">&quot; basketAcctID=\&quot;%s\&quot;\n&quot;</span>
                                <span class="stringliteral">&quot; basketContractID=\&quot;%s\&quot; /&gt;\n\n&quot;</span>,
                                strBasketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strBasketAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strBasketContractID.Get());
    }


    m_VoucherAccts.<a class="code" href="class_o_t_acct_list.html#a3e8b8cf7b31d9f4affb3be6dba3852a8">Serialize</a>(strMainFile);


    <span class="comment">/*</span>
<span class="comment">     FOR_EACH(mapOfNyms, m_mapNyms)</span>
<span class="comment">     {</span>
<span class="comment">        OTPseudonym * pNym = (*it).second;</span>
<span class="comment">        OT_ASSERT_MSG(NULL != pNym, &quot;NULL pseudonym pointer in OTWallet::m_mapNyms, OTWallet::SaveWallet&quot;);</span>
<span class="comment"></span>
<span class="comment">        pNym-&gt;SavePseudonymWallet(fl);</span>
<span class="comment">     }</span>
<span class="comment"></span>
<span class="comment"></span>
<span class="comment">     // ---------------------------------------------------------------</span>
<span class="comment"></span>
<span class="comment">     FOR_EACH(mapOfServers, m_mapServers)</span>
<span class="comment">     {</span>
<span class="comment">        OTContract * pServer = (*it).second;</span>
<span class="comment">        OT_ASSERT_MSG(NULL != pServer, &quot;NULL server pointer in OTWallet::m_mapServers, OTWallet::SaveWallet&quot;);</span>
<span class="comment"></span>
<span class="comment">        pServer-&gt;SaveContractWallet(fl);</span>
<span class="comment">     }</span>
<span class="comment"></span>
<span class="comment">     // ---------------------------------------------------------------</span>
<span class="comment">     */</span>

    strMainFile.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;/notaryServer&gt;\n&quot;</span>);

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab500513963b83465cf5402d7b9809870"></a><!-- doxytag: member="OTServer::SendInstrumentToNym" ref="ab500513963b83465cf5402d7b9809870" args="(const OTIdentifier &amp;SERVER_ID, const OTIdentifier &amp;SENDER_USER_ID, const OTIdentifier &amp;RECIPIENT_USER_ID, OTMessage *pMsg=NULL, const OTPayment *pPayment=NULL, const char *szCommand=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ab500513963b83465cf5402d7b9809870">OTServer::SendInstrumentToNym</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SENDER_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>RECIPIENT_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> *&#160;</td>
          <td class="paramname"><em>pMsg</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_payment.html">OTPayment</a> *&#160;</td>
          <td class="paramname"><em>pPayment</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>szCommand</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02700">2700</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( !( (NULL == pMsg) &amp;&amp; (NULL == pPayment) ), <span class="stringliteral">&quot;pMsg and pPayment -- these can&#39;t BOTH be NULL.\n&quot;</span>); <span class="comment">// must provide one or the other.</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( !( (NULL != pMsg) &amp;&amp; (NULL != pPayment) ), <span class="stringliteral">&quot;pMsg and pPayment -- these can&#39;t BOTH be not-NULL.\n&quot;</span>); <span class="comment">// can&#39;t provide both.</span>
    <span class="comment">// ------------------------</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((NULL == pPayment) || ((NULL != pPayment) &amp;&amp; pPayment-&gt;<a class="code" href="class_o_t_payment.html#a7f95ab568d481ecc7d38689c80caba84">IsValid</a>()) , <span class="stringliteral">&quot;OTServer::SendInstrumentToNym: You can only pass a valid payment here.&quot;</span>);
    <span class="comment">// ------------------------</span>
    <span class="comment">// If a payment was passed in (for us to use it to construct pMsg, which is NULL in the case where payment isn&#39;t NULL)</span>
    <span class="comment">// Then we grab it in string form, so we can pass it on...</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strPayment;
    <span class="keywordflow">if</span> (NULL != pPayment)
    {
        <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotPaymentContents = pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strPayment);
        <span class="keywordflow">if</span> (!bGotPaymentContents) <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error GetPaymentContents Failed&quot;</span>, __FUNCTION__);
    }
    <span class="comment">// ------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bDropped = this-&gt;<a class="code" href="class_o_t_server.html#a9f88b1a0a1b76f923e0830b353faf5a6">DropMessageToNymbox</a>(SERVER_ID,
                                                    SENDER_USER_ID,
                                                    RECIPIENT_USER_ID,
                                                    <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>,
                                                    pMsg,
                                                    (NULL != pMsg) ? NULL : &amp;strPayment,
                                                    szCommand);

    <span class="keywordflow">return</span> bDropped;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3314039ea12808bf8d3bce6c251d7e8f"></a><!-- doxytag: member="OTServer::SendMessageToNym" ref="a3314039ea12808bf8d3bce6c251d7e8f" args="(const OTIdentifier &amp;SERVER_ID, const OTIdentifier &amp;SENDER_USER_ID, const OTIdentifier &amp;RECIPIENT_USER_ID, OTMessage *pMsg=NULL, const OTString *pstrMessage=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a3314039ea12808bf8d3bce6c251d7e8f">OTServer::SendMessageToNym</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SENDER_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>RECIPIENT_USER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> *&#160;</td>
          <td class="paramname"><em>pMsg</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_string.html">OTString</a> *&#160;</td>
          <td class="paramname"><em>pstrMessage</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02734">2734</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_server.html#a9f88b1a0a1b76f923e0830b353faf5a6">DropMessageToNymbox</a>(SERVER_ID,
                                     SENDER_USER_ID,
                                     RECIPIENT_USER_ID,
                                     <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>,
                                     pMsg,
                                     pstrMessage); <span class="comment">//, szCommand=NULL</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a95e4bb3ce17ee91a57c8027dfd00255d"></a><!-- doxytag: member="OTServer::SetHeartbeatMsBetweenBeats" ref="a95e4bb3ce17ee91a57c8027dfd00255d" args="(int32_t nVal)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void <a class="el" href="class_o_t_server.html#a95e4bb3ce17ee91a57c8027dfd00255d">OTServer::SetHeartbeatMsBetweenBeats</a> </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>nVal</em></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00280">280</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ __heartbeat_ms_between_beats = nVal; }
</pre></div>
</div>
</div>
<a class="anchor" id="a63cfec2112f3b2a8490790a8fb8264fb"></a><!-- doxytag: member="OTServer::SetHeartbeatNoRequests" ref="a63cfec2112f3b2a8490790a8fb8264fb" args="(int32_t nVal)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void <a class="el" href="class_o_t_server.html#a63cfec2112f3b2a8490790a8fb8264fb">OTServer::SetHeartbeatNoRequests</a> </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>nVal</em></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00277">277</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ __heartbeat_no_requests = nVal; }
</pre></div>
</div>
</div>
<a class="anchor" id="aeb1ec70655351bd1b4fac9d76f78c304"></a><!-- doxytag: member="OTServer::SetMinMarketScale" ref="aeb1ec70655351bd1b4fac9d76f78c304" args="(int64_t lVal)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void <a class="el" href="class_o_t_server.html#aeb1ec70655351bd1b4fac9d76f78c304">OTServer::SetMinMarketScale</a> </td>
          <td>(</td>
          <td class="paramtype">int64_t&#160;</td>
          <td class="paramname"><em>lVal</em></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00274">274</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ __min_market_scale = lVal; }
</pre></div>
</div>
</div>
<a class="anchor" id="aacf5bdeecd0f8c3e1b923e7547a11810"></a><!-- doxytag: member="OTServer::SetOverrideNymID" ref="aacf5bdeecd0f8c3e1b923e7547a11810" args="(const std::string the_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void <a class="el" href="class_o_t_server.html#aacf5bdeecd0f8c3e1b923e7547a11810">OTServer::SetOverrideNymID</a> </td>
          <td>(</td>
          <td class="paramtype">const std::string&#160;</td>
          <td class="paramname"><em>the_id</em></td><td>)</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8hpp_source.html#l00285">285</a> of file <a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ __override_nym_id = the_id; }
</pre></div>
</div>
</div>
<a class="anchor" id="aad09d6bc4e812109dd084c8606c7cd3a"></a><!-- doxytag: member="OTServer::UserCmdCheckServerID" ref="aad09d6bc4e812109dd084c8606c7cd3a" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aad09d6bc4e812109dd084c8606c7cd3a">OTServer::UserCmdCheckServerID</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02344">2344</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@checkServerID&quot;</span>; <span class="comment">// reply to checkServerID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="comment">// already at the top of ProcessUserCommand, which calls this.</span>
<span class="comment">//  msgOut.m_strRequestNum.Set(MsgIn.m_strRequestNum);</span>

    <span class="keywordflow">if</span> (MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a> == m_strServerID)   <span class="comment">// ServerID, a hash of the server contract.</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>       = <span class="keyword">true</span>;
    <span class="keywordflow">else</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>       = <span class="keyword">false</span>;

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="af06ca9655b68edd3c6352e8ad0683b57"></a><!-- doxytag: member="OTServer::UserCmdCheckUser" ref="af06ca9655b68edd3c6352e8ad0683b57" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#af06ca9655b68edd3c6352e8ad0683b57">OTServer::UserCmdCheckUser</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02964">2964</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@checkUser&quot;</span>;     <span class="comment">// reply to checkUser</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;<span class="comment">// UserID of public key requested by user.</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> nym2;
    nym2.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>);

    <span class="keywordtype">bool</span> bLoaded        = nym2.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>(); <span class="comment">// This calls LoadCredentials inside.</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>   = (bLoaded &amp;&amp; nym2.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>());

    <span class="comment">// If success, we send the Nym2&#39;s public key back to the user.</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        nym2.<a class="code" href="class_o_t_pseudonym.html#a7a7b836bb9e8e0df7b3601f44e1b7220">GetPublicEncrKey</a>().<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(msgOut.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a>, <span class="keyword">true</span>);

        <span class="comment">// NEW: Also attach the public credentials to the response</span>
        <span class="comment">//      (not just a public key.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (nym2.<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0)
        {
            <span class="comment">// -----------------------------</span>
            <span class="comment">// Create an OTDB::StringMap object.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
            <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
            <span class="comment">// --------------------------------------------------------------</span>
            pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
            theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
            pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
            <span class="comment">// --------------------------------------------------------------</span>
            <span class="comment">// It exists.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (NULL == pMap)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to create a STORED_OBJ_STRING_MAP.\n&quot;</span>,
                              __FUNCTION__);
                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// -----------------------------------------------</span>
                <a class="code" href="class_o_t_string.html">OTString</a>       strCredList;
                <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;

                nym2.<a class="code" href="class_o_t_pseudonym.html#a356d33b203d025ec66a43e23c63c55ed">GetPublicCredentials</a>(strCredList, &amp;theMap);
                <span class="comment">// -----------------------------------------------</span>
                <span class="comment">// Serialize the StringMap to a string...</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (theMap.size() &gt; 0) <span class="comment">// Won&#39;t bother if there are zero credentials somehow.</span>
                {
                    std::string str_Encoded = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessEncoding = (str_Encoded.size() &gt; 0);
                    <span class="keywordflow">if</span> (bSuccessEncoding)
                    {
                        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strCredList);   <span class="comment">// &lt;========== Success</span>
                        msgOut.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str());  <span class="comment">// Payload contains credentials list, payload2 contains actual credentials.</span>
                    }
                }
            }
        } <span class="comment">// bLoadedCredentials</span>
    } <span class="comment">// msgOut.m_bSuccess</span>
    <span class="comment">// if Failed, we send the user&#39;s message back to him, ascii-armored as part of response.</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7cbd0ac6cbdf34d1e49ff96979691896"></a><!-- doxytag: member="OTServer::UserCmdCreateAccount" ref="a7cbd0ac6cbdf34d1e49ff96979691896" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a7cbd0ac6cbdf34d1e49ff96979691896">OTServer::UserCmdCreateAccount</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>An existing user is creating an asset account. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l03765">3765</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::UserCmdCreateAccount&quot;</span>;

    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@createAccount&quot;</span>; <span class="comment">// reply to createAccount</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="comment">// Either way, we need to send the user&#39;s command back to him as well.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
    msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym), SERVER_ID(m_strServerID);
    <span class="comment">// ----------------------------------------------</span>

    <a class="code" href="class_o_t_account.html">OTAccount</a> * pNewAccount = <a class="code" href="class_o_t_account.html#a67320767550f65babfeebee7beff2c34">OTAccount::GenerateNewAccount</a>(USER_ID, SERVER_ID, m_nymServer, MsgIn);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAcctAngel(pNewAccount);

    <span class="comment">// If we successfully create the account, then bundle it in the message XML payload</span>
    <span class="keywordflow">if</span> (NULL != pNewAccount)
    {
        <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(pNewAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());

        <span class="keywordflow">if</span> (NULL == pContract)
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(pNewAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Unable to get AssetContract for asset type: %s\n&quot;</span>,
                          szFunc, strAssetID.Get());
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#acbd416ba9d7ac6b0965fadc971e3d12b">IsShares</a>())
        {
            <span class="comment">// The asset type keeps a list of all accounts for that type.</span>
            <span class="comment">// (For shares, not for currencies.)</span>
            <span class="comment">//</span>
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#aaae4a28e5f6b4cd915b47862d8614cf4">AddAccountRecord</a>(*pNewAccount);
            <span class="keywordflow">if</span> (!bAdded)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(pNewAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR Adding Account Record: %s ... Aborting.\n&quot;</span>, __FUNCTION__,strAssetID.Get());
                <span class="keywordflow">return</span>; <span class="comment">//error</span>
            }
        }
        <span class="comment">// -----------------------------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNewAccountID;
        pNewAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theNewAccountID);

<span class="comment">//      OTLog::Error(&quot;DEBUG: GenerateNewAccount successfully returned account pointer. Contents:\n%s\n&quot;, tempPayload.Get());</span>

        <span class="comment">// -----------------------------------------------</span>

        <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theOutbox(USER_ID, theNewAccountID, SERVER_ID),
                    theInbox (USER_ID, theNewAccountID, SERVER_ID);

        <span class="keywordtype">bool</span> bSuccessLoadingInbox   = theInbox. LoadInbox();
        <span class="keywordtype">bool</span> bSuccessLoadingOutbox  = theOutbox.LoadOutbox();

        <span class="comment">// --------------------------------------------------------------------</span>

        <span class="comment">// ...or generate them otherwise...</span>

        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingInbox) <span class="comment">// WEIRD IF THIS HAPPENED...</span>
            bSuccessLoadingInbox    = theInbox.VerifyAccount(m_nymServer); <span class="comment">// todo -- this should NEVER happen, the ID was just RANDOMLY generated, so HOW did the inbox already exist???</span>
        <span class="keywordflow">else</span>
        {
            bSuccessLoadingInbox    = theInbox.GenerateLedger(theNewAccountID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

            <span class="keywordflow">if</span> (bSuccessLoadingInbox)
            {
                bSuccessLoadingInbox    = theInbox.SignContract(m_nymServer);

                <span class="keywordflow">if</span> (bSuccessLoadingInbox)
                {
                    bSuccessLoadingInbox = theInbox.SaveContract();

                    <span class="keywordflow">if</span> (bSuccessLoadingInbox)
                        bSuccessLoadingInbox    = pNewAccount-&gt;<a class="code" href="class_o_t_account.html#a81e503e95310da5ac9c2003cb00d6d2e">SaveInbox</a>(theInbox);
                }
            }
        }

        <span class="comment">// --------------------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOutbox) <span class="comment">// WEIRD IF THIS HAPPENED....</span>
            bSuccessLoadingOutbox   = theOutbox.VerifyAccount(m_nymServer); <span class="comment">// todo -- this should NEVER happen, the ID was just RANDOMLY generated, so HOW did the outbox already exist???</span>
        <span class="keywordflow">else</span>
        {
            bSuccessLoadingOutbox   = theOutbox.GenerateLedger(theNewAccountID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

            <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
            {
                bSuccessLoadingOutbox   = theOutbox.SignContract(m_nymServer);

                <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
                {
                    bSuccessLoadingOutbox = theOutbox.SaveContract();

                    <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
                        bSuccessLoadingOutbox   = pNewAccount-&gt;<a class="code" href="class_o_t_account.html#ad8c1a43eff592d7cd7af20fcd2eac468">SaveOutbox</a>(theOutbox);
                }
            }
        }

        <span class="comment">// --------------------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingInbox)
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNewAcctID(theNewAccountID);

            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR generating inbox ledger: %s\n&quot;</span>, szFunc,
                          strNewAcctID.Get());
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingOutbox)
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNewAcctID(theNewAccountID);

            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR generating outbox ledger: %s\n&quot;</span>, szFunc,
                          strNewAcctID.Get());
        }
        <span class="keywordflow">else</span>
        {
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>; <span class="comment">// &lt;==== SUCCESS!!</span>

            pNewAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);

            <span class="comment">// On the server side, each nym stores a list of its asset accounts (IDs).</span>
            <span class="comment">//</span>
            std::set&lt;std::string&gt; &amp; theAccountSet = theNym.<a class="code" href="class_o_t_pseudonym.html#ad3dbc1ca45e891918fb363bdf24a57e3">GetSetAssetAccounts</a>();
            theAccountSet.insert(msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

            <span class="comment">// ---------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> tempPayload(*pNewAccount);
            msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempPayload);
        }
        <span class="comment">// --------------------------------------------------------------------</span>
    }


    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();


    <span class="comment">// (You are in UserCmdCreateAcct.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum, <span class="comment">// No need to update the NymboxHash in this case.</span>
                                      <span class="keyword">false</span>);   <span class="comment">// trans success (not a transaction)</span>
<span class="comment">//      this-&gt;DropReplyNoticeToNymbox(SERVER_ID, USER_ID, strReplyMessage, lReqNum, &amp;theNym);</span>
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a75f0645baa92a4f273ffb726eefa5a39"></a><!-- doxytag: member="OTServer::UserCmdDeleteAssetAcct" ref="a75f0645baa92a4f273ffb726eefa5a39" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a75f0645baa92a4f273ffb726eefa5a39">OTServer::UserCmdDeleteAssetAcct</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l11183">11183</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::UserCmdDeleteAssetAcct&quot;</span>;

    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@deleteAssetAccount&quot;</span>;    <span class="comment">// reply to deleteAssetAccount</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;         <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;        <span class="comment">// the asset account being deleted.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID   (MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>),
                        SERVER_ID (MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>),
                        ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);

    <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(ACCOUNT_ID, SERVER_ID);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAcctGuardian(pAccount); <span class="comment">// This is safe in cases where NULL is returned. No more need to cleanup pAccount.</span>

    <span class="keywordflow">if</span> (NULL == pAccount || !pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(m_nymServer))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying account: %s\n&quot;</span>,
                      szFunc, MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() != 0)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed while trying to delete asset account %s: &quot;</span>
                       <span class="stringliteral">&quot;Balance must be zero to do this!\n&quot;</span>,
                       szFunc, MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a> (m_nymServer);
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(m_nymServer);

        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

        <span class="keywordflow">if</span> (NULL == pInbox) <span class="comment">// || !pInbox-&gt;VerifyAccount(m_nymServer)) // NOTE: OTAccount::LoadInbox already verifies.</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying inbox: %s\n&quot;</span>, szFunc, MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) <span class="comment">// || !pOutbox-&gt;VerifyAccount(m_nymServer)) // NOTE: OTAccount::LoadOutbox already verifies.</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading or verifying outbox: %s\n&quot;</span>, szFunc, MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &gt; 0)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: Tried to delete asset account, but there are still &quot;</span>
                          <span class="stringliteral">&quot;receipts in the Inbox. (Process them first.)\n&quot;</span>, szFunc);
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &gt; 0)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: Tried to delete asset account, but there are still &quot;</span>
                          <span class="stringliteral">&quot;receipts in the Outbox. (Process them first.)\n&quot;</span>, szFunc);
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        }
        <span class="keywordflow">else</span> <span class="comment">// SUCCESS!</span>
        {
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

            std::set&lt;std::string&gt; &amp; theAccountSet = theNym.<a class="code" href="class_o_t_pseudonym.html#ad3dbc1ca45e891918fb363bdf24a57e3">GetSetAssetAccounts</a>();
            theAccountSet.erase(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);
            <span class="comment">// --------------------------------</span>
            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());

            <span class="keywordflow">if</span> (NULL == pContract)
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Unable to get AssetContract for asset type: %s\n&quot;</span>,
                              szFunc, strAssetID.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#acbd416ba9d7ac6b0965fadc971e3d12b">IsShares</a>())
            {
                <span class="comment">// The asset type keeps a list of all accounts for that type.</span>
                <span class="comment">// (For shares, not for currencies.)</span>
                <span class="comment">//</span>
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bErased = pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#a37e62619190b5af431a99883cd76de11">EraseAccountRecord</a>(pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                <span class="keywordflow">if</span> (!bErased)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR Erasing Account Record: %s ... Aborting.\n&quot;</span>, __FUNCTION__,strAssetID.Get());
                    <span class="keywordflow">return</span>; <span class="comment">//error</span>
                }
            }
            <span class="comment">// -----------------------------------------------</span>
            <span class="comment">//</span>
            pAccount-&gt;<a class="code" href="class_o_t_account.html#aea147dd5991690f6a6f9e2500cf39872">MarkForDeletion</a>();    <span class="comment">// The account isn&#39;t actually deleted yet, just marked for deletion.</span>
                                            <span class="comment">//  It will get cleaned up later, during server maintenance.</span>

            <span class="comment">// SAVE the Account... (NOW THAT IT IS MARKED FOR DELETION.)</span>
            <span class="comment">//</span>
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
        }
    } <span class="comment">// pAccount verifies.</span>
    <span class="comment">// ----------------------------------------------------</span>

    <span class="comment">// Send the user&#39;s command back to him (success or failure.)</span>
    <span class="comment">//  if (false == msgOut.m_bSuccess)</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    <span class="comment">// (You are in UserCmdDeleteAssetAcct.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum,
                                      <span class="keyword">false</span>,   <span class="comment">// trans success (not a transaction.)</span>
                                      &amp;theNym);
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a814dd4abce3b6b338b07602143f6636e"></a><!-- doxytag: member="OTServer::UserCmdDeleteUser" ref="a814dd4abce3b6b338b07602143f6636e" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a814dd4abce3b6b338b07602143f6636e">OTServer::UserCmdDeleteUser</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10882">10882</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@deleteUserAccount&quot;</span>; <span class="comment">// reply to deleteUserAccount</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, USER_ID, SERVER_ID);

    std::set&lt;int64_t&gt; &amp; theSetofCronItemIDs = theNym.<a class="code" href="class_o_t_pseudonym.html#a92abc7a6b6253681f3379f135597f5a9">GetSetOpenCronItems</a>();

    <span class="comment">// If success loading Nymbox, and there are transactions still inside, THEN FAIL!!!</span>
    <span class="comment">// (Can&#39;t delete a Nym with open receipts...)</span>
    <span class="comment">//</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessLoadNymbox = (theLedger.LoadNymbox() &amp;&amp; theLedger.VerifyAccount(m_nymServer));
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadNymbox)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Tried to delete Nym, but failed loading or verifying the Nymbox.\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theLedger.GetTransactionCount() &gt; 0)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Tried to delete Nym, but there are still receipts in the Nymbox. (Process them first.)\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="comment">// This Nym still has items open on Cron!</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theSetofCronItemIDs.size() &gt; 0)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Tried to delete Nym, but there are still open Cron Items. (Close them first.)\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#ad3dbc1ca45e891918fb363bdf24a57e3">GetSetAssetAccounts</a>().size() &gt; 0)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Tried to delete Nym, but there are still Asset Accounts open for that Nym. (Close them first.)\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="comment">// The Nym has used some of his transaction numbers, but hasn&#39;t closed them out yet.</span>
    <span class="comment">// Close those transactions first.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) != theNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Tried to delete Nym, but there are still transactions open for that Nym. (Close them first.)\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span> <span class="comment">// SUCCESS!</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

        <span class="comment">// The Nym may have some numbers signed out, but none of them have come through</span>
        <span class="comment">// and been &quot;used but not closed&quot; yet. (That is, removed from transaction num list but still</span>
        <span class="comment">// on issued num list.) If they had (i.e. if the previous elseif just above had discovered</span>
        <span class="comment">// mismatched counts) then we wouldn&#39;t be able to delete the Nym until those transactions were</span>
        <span class="comment">// closed.</span>
        <span class="comment">// Since we know the counts match perfectly, here we remove all the numbers.</span>
        <span class="comment">// The client side must know to remove all the numbers as well, when it receives a successful</span>
        <span class="comment">// reply that the nym was &quot;deleted.&quot;</span>
        <span class="comment">//</span>
        <span class="keywordflow">while</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &gt; 0)
        {
            int64_t lTemp = theNym.<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
            <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, lTemp, <span class="keyword">false</span>); <span class="comment">// bSave = false</span>
        }

        <span class="keywordflow">while</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID) &gt; 0)
        {
            int64_t lTemp = theNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
            <a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>(theNym, lTemp, <span class="keyword">false</span>); <span class="comment">// bSave = false</span>
        }
        <span class="comment">// --------------------------------</span>
        <span class="comment">//</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#a3b96d3b8d3d2836b8a83132eb133895c">MarkForDeletion</a>();   <span class="comment">// The nym isn&#39;t actually deleted yet, just marked for deletion.</span>
        <span class="comment">//  It will get cleaned up later, during server maintenance.</span>

        <span class="comment">// SAVE the Nym... (now marked for deletion and with all of its transaction numbers removed.)</span>
        <span class="comment">//</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);
    }

    <span class="comment">// Send the user&#39;s command back to him (success or failure.)</span>
    <span class="comment">//  if (false == msgOut.m_bSuccess)</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    <span class="comment">// (You are in UserCmdDeleteUser.)</span>


    <span class="comment">// TODO: We may also need to mark the Nymbox, as well as the credential files, as &quot;Marked For Deletion.&quot;</span>


    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum,
                                      <span class="keyword">false</span>,   <span class="comment">// trans success</span>
                                      &amp;theNym);
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="af9644fd5e95a200a2689462a1caae6e8"></a><!-- doxytag: member="OTServer::UserCmdGetAccount" ref="af9644fd5e95a200a2689462a1caae6e8" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#af9644fd5e95a200a2689462a1caae6e8">OTServer::UserCmdGetAccount</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10186">10186</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getAccount&quot;</span>;    <span class="comment">// reply to getAccount</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;    <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);

    <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount        = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(ACCOUNT_ID, SERVER_ID);
    <span class="keywordtype">bool</span> bSuccessLoadingAccount = ((pAccount != NULL) ? <span class="keyword">true</span>:<span class="keyword">false</span> );

    <span class="comment">// Yup the account exists. Yup it has the same user ID.</span>
    <span class="keywordflow">if</span> (bSuccessLoadingAccount &amp;&amp; (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>() == USER_ID))
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;
        <span class="comment">// extract the account in ascii-armored form on the outgoing message</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pAccount); <span class="comment">// first grab it in plaintext string form</span>
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the account in its payload in base64 form.</span>
    }
    <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    <span class="keywordflow">else</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aff8c02fe93fe3f8fbe5ab8d30981ad8b"></a><!-- doxytag: member="OTServer::UserCmdGetAccountFiles" ref="aff8c02fe93fe3f8fbe5ab8d30981ad8b" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aff8c02fe93fe3f8fbe5ab8d30981ad8b">OTServer::UserCmdGetAccountFiles</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10226">10226</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getAccountFiles&quot;</span>;   <span class="comment">// reply to getAccountFiles</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;     <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;        // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;    <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);

    <a class="code" href="class_o_t_string.html">OTString</a>    strAccount, strInbox, strOutbox, strInboxHash, strOutboxHash;
    <span class="comment">// ------------------------------------------</span>
    <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount        = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(ACCOUNT_ID, SERVER_ID);
    <span class="keywordtype">bool</span> bSuccessLoadingAccount = ((pAccount != NULL) ? <span class="keyword">true</span>:<span class="keyword">false</span> );
    <span class="keywordtype">bool</span> bSuccessLoadingInbox   = <span class="keyword">false</span>;
    <span class="keywordtype">bool</span> bSuccessLoadingOutbox  = <span class="keyword">false</span>;
    <span class="comment">// ------------------------------------------</span>
    <span class="keywordflow">if</span> (bSuccessLoadingAccount)
        bSuccessLoadingAccount = (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>() == USER_ID);
    <span class="comment">// ------------------------------------------</span>
    <span class="comment">// Yup the account exists. Yup it has the same user ID.</span>
    <span class="keywordflow">if</span> (bSuccessLoadingAccount)
    {
        <span class="comment">// extract the account in ascii-armored form on the outgoing message</span>
        pAccount-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strAccount); <span class="comment">// first grab it in plaintext string form</span>

        <span class="comment">// ******************************************************************************</span>
        <span class="comment">// Get the Inbox.</span>
        <span class="comment">//</span>
        {
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);

            bSuccessLoadingInbox = theInbox.LoadInbox();

            <span class="keywordflow">if</span> (!bSuccessLoadingInbox)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load Inbox from storage.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">else</span>
            {
                <span class="comment">// We do NOT call VerifyAccount in this function (because we don&#39;t need to) and thus we do NOT</span>
                <span class="comment">// force the box receipts to be loaded here (which happens inside that call.) But we DO verify</span>
                <span class="comment">// the IDs and the Signature, of course.</span>
                <span class="comment">//</span>
                bSuccessLoadingInbox = (theInbox.VerifyContractID() &amp;&amp; theInbox.VerifySignature(m_nymServer));

                <span class="comment">// If we loaded old data in this file... (when whole receipts used to be stored in boxes.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bSuccessLoadingInbox &amp;&amp; theInbox.LoadedLegacyData())    <span class="comment">// (which automatically saves the box receipt as the old data is loaded...)</span>
                {
<span class="comment">//                  bSuccessLoadingInbox = theInbox.VerifyAccount(m_nymServer); // Then Verify, which forces a LoadBoxReceipts... (</span>

                    theInbox.ReleaseSignatures();               <span class="comment">// UPDATE: We do NOT force the loading here, since they aren&#39;t needed.</span>
                    theInbox.SignContract(m_nymServer);     <span class="comment">// Waste of resources. Instead, we recognize that it was old data, and so</span>
                    theInbox.SaveContract();                    <span class="comment">// we gracefully re-save in the new format, so it won&#39;t repeatedly be</span>
                    theInbox.SaveInbox();                       <span class="comment">// loaded over and over again in the large filesize.</span>
                }

                <span class="keywordflow">if</span> (!bSuccessLoadingInbox)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Verification failed on Inbox after loading.\n&quot;</span>, __FUNCTION__);
            }
            <span class="comment">// ---------------------------------------------</span>
            <span class="keywordflow">if</span> (bSuccessLoadingInbox)
            {
                theInbox.SaveContractRaw(strInbox);

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theHash;
                <span class="keywordflow">if</span> (theInbox.CalculateInboxHash(theHash))
                    theHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strInboxHash);
            }
        }
        <span class="comment">// ******************************************************************************</span>
        <span class="comment">// Now get the OUTBOX.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (bSuccessLoadingInbox) <span class="comment">// (Which we don&#39;t bother to do unless the inbox was already successful.)</span>
        {
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theOutbox(USER_ID, ACCOUNT_ID, SERVER_ID);

            bSuccessLoadingOutbox = theOutbox.LoadOutbox();

            <span class="keywordflow">if</span> (!bSuccessLoadingOutbox)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load Outbox from storage.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">else</span>
            {
                <span class="comment">// We do NOT call VerifyAccount in this function (because we don&#39;t need to) and thus we do NOT</span>
                <span class="comment">// force the box receipts to be loaded here (which happens inside that call.) But we DO verify</span>
                <span class="comment">// the IDs and the Signature, of course.</span>
                <span class="comment">//</span>
                bSuccessLoadingOutbox = (theOutbox.VerifyContractID() &amp;&amp; theOutbox.VerifySignature(m_nymServer));

                <span class="comment">// If we loaded old data in this file... (when whole receipts used to be stored in boxes.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bSuccessLoadingOutbox &amp;&amp; theOutbox.LoadedLegacyData())  <span class="comment">// (which automatically saves the box receipt as the old data is loaded...)</span>
                {
<span class="comment">//                  bSuccessLoadingOutbox = theOutbox.VerifyAccount(m_nymServer);   // Then Verify, which forces a LoadBoxReceipts... (</span>

                    theOutbox.ReleaseSignatures();              <span class="comment">// UPDATE: We do NOT force the loading here, since they aren&#39;t needed.</span>
                    theOutbox.SignContract(m_nymServer);        <span class="comment">// Waste of resources. Instead, we recognize that it was old data, and so</span>
                    theOutbox.SaveContract();                   <span class="comment">// we gracefully re-save in the new format, so it won&#39;t repeatedly be</span>
                    theOutbox.SaveOutbox();                     <span class="comment">// loaded over and over again in the large filesize.</span>
                }

                <span class="keywordflow">if</span> (!bSuccessLoadingOutbox)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Verification Failed on Outbox after loading.\n&quot;</span>, __FUNCTION__);
            }
            <span class="comment">// -----------------------------------------------</span>
            <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
            {
                theOutbox.SaveContractRaw(strOutbox);

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theHash;
                <span class="keywordflow">if</span> (theOutbox.CalculateOutboxHash(theHash))
                    theHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strOutboxHash);
            }
        }
    }
    <span class="comment">// ******************************************************************************</span>
    <span class="comment">// TODO optimize: Really only !SuccessLoadingOutbox is needed here.</span>
    <span class="comment">// If it is false, then the others are definitely false as well.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (!bSuccessLoadingOutbox || !bSuccessLoadingInbox || !bSuccessLoadingAccount)
    {
        <span class="comment">// FAILURE: (Send the user&#39;s command back to him.)</span>
        <span class="comment">//</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }
    <span class="comment">// ------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="comment">// SUCCESS.</span>
    {
        <span class="comment">// Create an OTDB::StringMap object.</span>
        <span class="comment">// (To return the three files in.)</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
        <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
        <span class="comment">// --------------------------------------------------------------</span>
        pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
        theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
        pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
        <span class="comment">// --------------------------------------------------------------</span>
        <span class="comment">// It exists.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (NULL == pMap)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to create a STORED_OBJ_STRING_MAP.\n&quot;</span>,
                          __FUNCTION__);
        <span class="keywordflow">else</span>
        {
            <span class="comment">// -----------------------------------------------</span>
            <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
            <span class="comment">// -----------------------------------------------</span>
            theMap.insert(std::pair&lt;std::string, std::string&gt;(<span class="stringliteral">&quot;account&quot;</span>, strAccount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
            theMap.insert(std::pair&lt;std::string, std::string&gt;(<span class="stringliteral">&quot;inbox&quot;</span>,   strInbox  .Get()));
            theMap.insert(std::pair&lt;std::string, std::string&gt;(<span class="stringliteral">&quot;outbox&quot;</span>,  strOutbox .Get()));
            <span class="comment">// -----------------------------------------------</span>
            <span class="comment">// Serialize the StringMap to a string...</span>
            <span class="comment">//</span>
            std::string str_Encoded     = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessEncoding = (str_Encoded.size() &gt; 0);

            <span class="keywordflow">if</span> (!bSuccessEncoding)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to encode a STORED_OBJ_STRING_MAP.\n&quot;</span>,
                              __FUNCTION__);
            <span class="keywordflow">else</span>
            {
                msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str()); <span class="comment">// &lt;============</span>
                msgOut.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>  = strInboxHash;
                msgOut.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a> = strOutboxHash;
                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>      = <span class="keyword">true</span>;
            }
        }
    }
    <span class="comment">// ------------------------------------------</span>
    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5eb462c4e3d26d4ee2afbfbc151a4a37"></a><!-- doxytag: member="OTServer::UserCmdGetBoxReceipt" ref="a5eb462c4e3d26d4ee2afbfbc151a4a37" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a5eb462c4e3d26d4ee2afbfbc151a4a37">OTServer::UserCmdGetBoxReceipt</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l11009">11009</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;@getBoxReceipt&quot;</span>;         <span class="comment">// reply to getBoxReceipt</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;         <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID        = m_strServerID;            // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;        <span class="comment">// the asset account ID (inbox/outbox), or Nym ID (nymbox)</span>
    msgOut.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>    = MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>;  <span class="comment">// TransactionNumber for the receipt in the box (unique to the box.)</span>
    msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>             = MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>;
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>           = <span class="keyword">false</span>;

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>),
                        SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>),
                        ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = NULL;
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theLedgerAngel;

    <span class="keywordtype">bool</span> bErrorCondition = <span class="keyword">false</span>;
    <span class="keywordtype">bool</span> bSuccessLoading = <span class="keyword">false</span>;

    <span class="keywordflow">switch</span> (MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>)
    {
        <span class="keywordflow">case</span> 0: <span class="comment">// Nymbox</span>
            <span class="keywordflow">if</span> (USER_ID == ACCOUNT_ID)
            {
                pLedger = <span class="keyword">new</span> <a class="code" href="class_o_t_ledger.html">OTLedger</a>(USER_ID, USER_ID, SERVER_ID);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pLedger);
                theLedgerAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pLedger);
                bSuccessLoading = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>(); <span class="comment">// It&#39;s verified using VerifyAccount() below this switch block.</span>
            }
            <span class="keywordflow">else</span> <span class="comment">// Inbox / Outbox.</span>
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: User requested Nymbox, but failed to provide the &quot;</span>
                              <span class="stringliteral">&quot;UserID (%s) in the AccountID (%s) field as expected.\n&quot;</span>, MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                              MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                bErrorCondition = <span class="keyword">true</span>;
            }
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 1: <span class="comment">// Inbox</span>
            <span class="keywordflow">if</span> (USER_ID == ACCOUNT_ID)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: User requested Inbox, but erroneously provided the &quot;</span>
                              <span class="stringliteral">&quot;UserID (%s) in the AccountID (%s) field.\n&quot;</span>, MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                bErrorCondition = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
                pLedger = <span class="keyword">new</span> <a class="code" href="class_o_t_ledger.html">OTLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pLedger);
                theLedgerAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pLedger);
                bSuccessLoading = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(); <span class="comment">// It&#39;s verified using VerifyAccount() below this switch block.</span>
            }
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 2: <span class="comment">// Outbox</span>
            <span class="keywordflow">if</span> (USER_ID == ACCOUNT_ID)
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: User requested Outbox, but erroneously provided the &quot;</span>
                              <span class="stringliteral">&quot;UserID (%s) in the AccountID (%s) field.\n&quot;</span>, MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                bErrorCondition = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
                pLedger = <span class="keyword">new</span> <a class="code" href="class_o_t_ledger.html">OTLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pLedger);
                theLedgerAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pLedger);
                bSuccessLoading = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(); <span class="comment">// It&#39;s verified using VerifyAccount() below this switch block.</span>
            }
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: Unknown box type: %ld\n&quot;</span>,
                          MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>);
            bErrorCondition = <span class="keyword">true</span>;
            <span class="keywordflow">break</span>;
    }
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// At this point, we have the box loaded. Now let&#39;s use it to</span>
    <span class="comment">// load the appropriate box receipt...</span>

    <span class="keywordflow">if</span> (bSuccessLoading                     &amp;&amp;
        !bErrorCondition                    &amp;&amp;
<span class="comment">//      pLedger-&gt;VerifyAccount(m_nymServer) &amp;&amp;  // This call causes all the Box Receipts to be loaded up and we don&#39;t need them here, except</span>
        pLedger-&gt;<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>()         &amp;&amp;  <span class="comment">// for just one, so we&#39;re going to VerifyContractID and Signature instead. Then below, we&#39;ll</span>
        pLedger-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer)   <span class="comment">// just load the one we actually need.</span>
        )
    {
        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);
        <span class="keywordflow">if</span> (NULL == pTransaction)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: User requested a transaction number &quot;</span>
                          <span class="stringliteral">&quot;(%ld) that&#39;s not in the %s. UserID (%s) and AccountID (%s) FYI.\n&quot;</span>,
                          MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>,
                          (MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>), <span class="comment">// outbox is 2.</span>
                          MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            bErrorCondition = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span>
        {
            pLedger-&gt;<a class="code" href="class_o_t_ledger.html#ae91873a35ebda05d8d91c78c1c1fcfbf">LoadBoxReceipt</a>(MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);

            <span class="comment">// The above call will replace pTransaction, inside pLedger, with the full version</span>
            <span class="comment">// (instead of the abbreviated version) of that transaction, meaning that the pTransaction</span>
            <span class="comment">// pointer is now a bad pointer, if that call was successful.</span>
            <span class="comment">// Therefore we just call GetTransaction() AGAIN. This way, whether LoadBoxReceipt()</span>
            <span class="comment">// failed or not (perhaps it&#39;s legacy data and is already not abbreviated, and thus the</span>
            <span class="comment">// LoadBoxReceipt call failed, but that&#39;s doesn&#39;t mean we&#39;re going to fail HERE, now does it?)</span>
            <span class="comment">//</span>
            pTransaction = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);

            <span class="keywordflow">if</span> ((NULL != pTransaction)              &amp;&amp;
                !pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>()      &amp;&amp;
                pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>()    &amp;&amp;
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(m_nymServer)
                )
            {
                <span class="comment">// Okay so after finding it, then calling LoadBoxReceipt(), then finding it again,</span>
                <span class="comment">// it&#39;s definitely not abbreviated by this point. Success!</span>
                <span class="comment">// LoadBoxReceipt() already calls VerifyBoxReceipt(), FYI.</span>
                <span class="comment">//</span>
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strBoxReceipt(*pTransaction);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(strBoxReceipt.Exists());

                msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strBoxReceipt);  <span class="comment">// &lt;=================</span>
                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: Success: User is retrieving the box receipt for transaction number &quot;</span>
                               <span class="stringliteral">&quot;%ld in the %s for UserID (%s) AccountID (%s).\n&quot;</span>,
                               MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>, (MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>), <span class="comment">// outbox is 2.</span>
                               MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: User requested a transaction number (%ld) that&#39;s &quot;</span>
                              <span class="stringliteral">&quot;failing to retrieve from the %s, AFTER calling LoadBoxReceipt(). (Though it worked BEFORE calling it.) &quot;</span>
                              <span class="stringliteral">&quot;UserID (%s) and AccountID (%s) FYI. IsAbbreviated == %s\n&quot;</span>,
                              MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>,
                              (MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>), <span class="comment">// outbox is 2.</span>
                              MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), (NULL == pTransaction) ? <span class="stringliteral">&quot;NULL&quot;</span> : (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>()) ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>  );
                bErrorCondition = <span class="keyword">true</span>;
            }
        }
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetBoxReceipt: Failed loading or verifying %s. &quot;</span>
                      <span class="stringliteral">&quot;Transaction (%ld), UserID (%s) and AccountID (%s) FYI.\n&quot;</span>,
                      (MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>), <span class="comment">// outbox is 2.</span>
                      MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>, MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        bErrorCondition = <span class="keyword">true</span>;
    }
    <span class="comment">// ---------------------------------------------</span>

    <span class="comment">// Send the user&#39;s command back to him (success or failure.)</span>
    <span class="comment">//  if (false == msgOut.m_bSuccess)</span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa677b01656359ef72a78a7935eb0bf40"></a><!-- doxytag: member="OTServer::UserCmdGetContract" ref="aa677b01656359ef72a78a7935eb0bf40" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aa677b01656359ef72a78a7935eb0bf40">OTServer::UserCmdGetContract</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>todo fix cast. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10631">10631</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getContract&quot;</span>;   <span class="comment">// reply to getContract</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    <span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>     = MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>;   <span class="comment">// The Asset Type ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ASSET_TYPE_ID(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(ASSET_TYPE_ID);

    <span class="keywordtype">bool</span> bSuccessLoadingContract = ((pContract != NULL) ? <span class="keyword">true</span>:<span class="keyword">false</span> );

    <span class="comment">// Yup the asset contract exists.</span>
    <span class="keywordflow">if</span> (bSuccessLoadingContract)
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;
        <span class="comment">// extract the account in ascii-armored form on the outgoing message</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pContract); <span class="comment">// first grab it in plaintext string form</span>
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the contract in its payload in base64 form.</span>
    }
    <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    <span class="keywordflow">else</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer); 

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae660ce647967c554cbaed3888194160a"></a><!-- doxytag: member="OTServer::UserCmdGetInbox" ref="ae660ce647967c554cbaed3888194160a" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae660ce647967c554cbaed3888194160a">OTServer::UserCmdGetInbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10410">10410</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getInbox&quot;</span>;          <span class="comment">// reply to getInbox</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;     <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;        // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;    <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadInbox();

    <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load Inbox from storage.\n&quot;</span>, __FUNCTION__);
    <span class="keywordflow">else</span>
    {
        <span class="comment">// We do NOT call VerifyAccount in this function (because we don&#39;t need to) and thus we do NOT</span>
        <span class="comment">// force the box receipts to be loaded here (which happens inside that call.) But we DO verify</span>
        <span class="comment">// the IDs and the Signature, of course.</span>
        <span class="comment">//</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = (theLedger.VerifyContractID() &amp;&amp; theLedger.VerifySignature(m_nymServer));

        <span class="comment">// If we loaded old data in this file... (when whole receipts were stored in boxes.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theLedger.LoadedLegacyData())  <span class="comment">// (which automatically saves the box receipt as the old data is loaded...)</span>
        {
<span class="comment">//          msgOut.m_bSuccess = theLedger.VerifyAccount(m_nymServer);   // Then Verify, which forces a LoadBoxReceipts... (</span>

            theLedger.ReleaseSignatures();              <span class="comment">// UPDATE: We do NOT force the loading here, since they aren&#39;t needed.</span>
            theLedger.SignContract(m_nymServer);        <span class="comment">// Waste of resources. Instead, we recognize that it was old data, and so</span>
            theLedger.SaveContract();                   <span class="comment">// we gracefully re-save in the new format, so it won&#39;t repeatedly be</span>
            theLedger.SaveInbox();                      <span class="comment">// loaded over and over again in the large filesize.</span>
        }

        <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Verification failed on Inbox after loading.\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="comment">// extract the ledger in ascii-armored form on the outgoing message</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(theLedger); <span class="comment">// first grab it in plaintext string form</span>
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the inbox ledger in its payload in base64 form.</span>

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theHash;
        <span class="keywordflow">if</span> (theLedger.CalculateInboxHash(theHash))
            theHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>);
    }
    <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer); <span class="comment">// todo const cast</span>

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8613c995889d628dde61855c1eae1e3a"></a><!-- doxytag: member="OTServer::UserCmdGetMarketList" ref="a8613c995889d628dde61855c1eae1e3a" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a8613c995889d628dde61855c1eae1e3a">OTServer::UserCmdGetMarketList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02152">2152</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getMarketList&quot;</span>; <span class="comment">// reply to getMarketList</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOutput;
    int32_t nMarketCount = 0;

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = m_Cron.<a class="code" href="class_o_t_cron.html#ae331e0bba385dfd33a8f7cca095d2380">GetMarketList</a>(ascOutput, nMarketCount);

    <span class="comment">// If success,</span>
    <span class="keywordflow">if</span> ((<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>) &amp;&amp; (nMarketCount &gt; 0))
    {
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(ascOutput);

        <a class="code" href="class_o_t_string.html">OTString</a> strCount;
        strCount.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, nMarketCount);
        msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> = atol(strCount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
    <span class="comment">// if Failed, we send the user&#39;s message back to him, ascii-armored as part of response.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aaad2e2c40409f5377cf867cbdae677bc"></a><!-- doxytag: member="OTServer::UserCmdGetMarketOffers" ref="aaad2e2c40409f5377cf867cbdae677bc" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aaad2e2c40409f5377cf867cbdae677bc">OTServer::UserCmdGetMarketOffers</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02192">2192</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getMarketOffers&quot;</span>;   <span class="comment">// reply to getMarketOffers</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;<span class="comment">// Market ID.</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    int64_t lDepth = MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>;
    <span class="keywordflow">if</span> (lDepth &lt; 0)
        lDepth = 0;

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MARKET_ID(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>);

    <span class="comment">// ------------------------------------------</span>

    <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = m_Cron.<a class="code" href="class_o_t_cron.html#afcc38ab744f5e3710982c600c4412cf2">GetMarket</a>(MARKET_ID);

    <span class="comment">// If success,</span>
    <span class="keywordflow">if</span> ((msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = ((pMarket != NULL) ? <span class="keyword">true</span>:<span class="keyword">false</span>) )) <span class="comment">// if assigned true</span>
    {
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOutput;
        int32_t nOfferCount = 0;

        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = pMarket-&gt;<a class="code" href="class_o_t_market.html#a4b6f10cedaa3a30fa5d7efc8912c71e2">GetOfferList</a>(ascOutput, lDepth, nOfferCount);

        <span class="keywordflow">if</span> ((<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>) &amp;&amp; (nOfferCount &gt; 0))
        {
            msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a> = ascOutput;
            msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>     = nOfferCount;
        }
    }

    <span class="comment">// if Failed, we send the user&#39;s message back to him, ascii-armored as part of response.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2063c2f8497f69026e4e1a740218828b"></a><!-- doxytag: member="OTServer::UserCmdGetMarketRecentTrades" ref="a2063c2f8497f69026e4e1a740218828b" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a2063c2f8497f69026e4e1a740218828b">OTServer::UserCmdGetMarketRecentTrades</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02244">2244</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getMarketRecentTrades&quot;</span>; <span class="comment">// reply to getMarketRecentTrades</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;<span class="comment">// Market ID.</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MARKET_ID(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>);

    <span class="comment">// ------------------------------------------</span>

    <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = m_Cron.<a class="code" href="class_o_t_cron.html#afcc38ab744f5e3710982c600c4412cf2">GetMarket</a>(MARKET_ID);

    <span class="comment">// If success,</span>
    <span class="keywordflow">if</span> ((msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> =  ((pMarket != NULL) ? <span class="keyword">true</span>:<span class="keyword">false</span>) )) <span class="comment">// if assigned true</span>
    {
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOutput;
        int32_t nTradeCount = 0;

        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = pMarket-&gt;<a class="code" href="class_o_t_market.html#a7375c51d4be96bf9d7e6a92f0dc7f18f">GetRecentTradeList</a>(ascOutput, nTradeCount);

        <span class="keywordflow">if</span> (<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
        {
            msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> = nTradeCount;

            <span class="keywordflow">if</span> (nTradeCount &gt; 0)
                msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a> = ascOutput;
        }
    }

    <span class="comment">// if Failed, we send the user&#39;s message back to him, ascii-armored as part of response.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae4ca69c54f16ba79ac6ee46d214795d0"></a><!-- doxytag: member="OTServer::UserCmdGetMint" ref="ae4ca69c54f16ba79ac6ee46d214795d0" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae4ca69c54f16ba79ac6ee46d214795d0">OTServer::UserCmdGetMint</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10820">10820</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getMint&quot;</span>;   <span class="comment">// reply to getMint</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>     = MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>;   <span class="comment">// The Asset Type ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  ASSET_TYPE_ID(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      ASSET_ID_STR(ASSET_TYPE_ID);
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordtype">bool</span> bSuccessLoadingMint = <span class="keyword">false</span>;

    <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(m_strServerID, ASSET_ID_STR);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">true</span> == (bSuccessLoadingMint = pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>(<span class="stringliteral">&quot;.PUBLIC&quot;</span>)))
    {
        <span class="comment">// You cannot hash the Mint to get its ID.</span>
        <span class="comment">// (The ID is a hash of the asset contract, not the mint contract.)</span>
        <span class="comment">// Instead, you must READ the ID from the Mint file, and then compare it to the one expected</span>
        <span class="comment">// to see if they match (similar to how Account IDs are verified.)</span>

        bSuccessLoadingMint = pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>(m_nymServer);

        <span class="comment">// Yup the asset contract exists.</span>
        <span class="keywordflow">if</span> (bSuccessLoadingMint)
        {
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

            <span class="comment">// extract the account in ascii-armored form on the outgoing message</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pMint); <span class="comment">// first grab it in plaintext string form</span>
            msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the inbox ledger in its payload in base64 form.</span>
        }
        <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    }

    <span class="keywordflow">if</span> (!bSuccessLoadingMint)
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa205b6d4560bfb2e728c9ad48f084283"></a><!-- doxytag: member="OTServer::UserCmdGetNym_MarketOffers" ref="aa205b6d4560bfb2e728c9ad48f084283" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aa205b6d4560bfb2e728c9ad48f084283">OTServer::UserCmdGetNym_MarketOffers</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02299">2299</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getNym_MarketOffers&quot;</span>;   <span class="comment">// reply to getMarketOffers</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID; theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(NYM_ID);

    <span class="comment">// ------------------------------------------</span>

    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOutput;
    int32_t nOfferCount = 0;

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = m_Cron.<a class="code" href="class_o_t_cron.html#a581f68b86ff6f5ef1200e885a8f159f9">GetNym_OfferList</a>(ascOutput, NYM_ID, nOfferCount);

    <span class="keywordflow">if</span> ((<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>) &amp;&amp; (nOfferCount &gt; 0))
    {
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a> = ascOutput;
        msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>     = nOfferCount;
    }
    <span class="comment">// if Failed, we send the user&#39;s message back to him, ascii-armored as part of response.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0787e731cb0e2622677a7b7f25d9958c"></a><!-- doxytag: member="OTServer::UserCmdGetNymbox" ref="a0787e731cb0e2622677a7b7f25d9958c" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a0787e731cb0e2622677a7b7f25d9958c">OTServer::UserCmdGetNymbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l11327">11327</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getNymbox&quot;</span>; <span class="comment">// reply to getNymbox</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
    <span class="keywordtype">bool</span> bSavedNymbox = <span class="keyword">false</span>;

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, USER_ID, SERVER_ID);

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadNymbox();
    <span class="keywordtype">bool</span> bCalculated  = <span class="keyword">false</span>;

    <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetNymbox: Failed trying to load Nymbox from storage.\n&quot;</span>);
    <span class="keywordflow">else</span>
    {
        <span class="comment">// We do NOT call VerifyAccount in this function (because we don&#39;t need to) and thus we do NOT</span>
        <span class="comment">// force the box receipts to be loaded here (which happens inside that call.) But we DO verify</span>
        <span class="comment">// the IDs and the Signature, of course.</span>
        <span class="comment">//</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = (theLedger.VerifyContractID() &amp;&amp; theLedger.VerifySignature(m_nymServer));

        <span class="comment">// If we loaded old data in this file... (when whole receipts were stored in boxes.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theLedger.LoadedLegacyData())  <span class="comment">// (which automatically saves the box receipt as the old data is loaded...)</span>
        {
<span class="comment">//          msgOut.m_bSuccess = theLedger.VerifyAccount(m_nymServer);   // Then Verify, which forces a LoadBoxReceipts... (</span>

            theLedger.ReleaseSignatures();              <span class="comment">// UPDATE: We do NOT force the loading here, since they aren&#39;t needed.</span>
            theLedger.SignContract(m_nymServer);        <span class="comment">// Waste of resources. Instead, we recognize that it was old data, and so</span>
            theLedger.SaveContract();                   <span class="comment">// we gracefully re-save in the new format, so it won&#39;t repeatedly be</span>
            theLedger.SaveNymbox(&amp;NYMBOX_HASH);         <span class="comment">// loaded over and over again in the large filesize.</span>

            bSavedNymbox = <span class="keyword">true</span>;
        }
        <span class="comment">// ----------------------------------------------</span>
        <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetNymbox: Verification failed on Nymbox after loading.\n&quot;</span>);
    }

    <span class="keywordflow">if</span> (<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="comment">// extract the ledger in ascii-armored form on the outgoing message</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(theLedger); <span class="comment">// first grab it in plaintext string form</span>
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the nymbox ledger in its payload in base64 form.</span>
    }
    <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }
    <span class="comment">// -------------------------</span>

    <span class="keywordflow">if</span> (bSavedNymbox)
    {
        <span class="comment">// Todo: make objects (like nyms) &quot;saveable&quot;, and ability to get &quot;dirty&quot;. (To prevent multiple</span>
        <span class="comment">// redundant saves.)</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH);    <span class="comment">// Save the hash onto the Nym</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

        NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);  <span class="comment">// Get the hash onto the message</span>
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        bCalculated = theLedger.CalculateNymboxHash(NYMBOX_HASH);

        theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH);    <span class="comment">// Save the hash onto the Nym</span>
        theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

        NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);  <span class="comment">// Get the hash onto the message</span>
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> EXISTING_NYMBOX_HASH;
        <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, EXISTING_NYMBOX_HASH)) <span class="comment">// if hash exists already for nym...</span>
            EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);          <span class="comment">// ...then set it onto the message.</span>
    }
    <span class="comment">// -------------------------</span>

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer); <span class="comment">// todo const_cast</span>

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a59d3bba46b92f43461163bb5e99e15bd"></a><!-- doxytag: member="OTServer::UserCmdGetOutbox" ref="a59d3bba46b92f43461163bb5e99e15bd" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a59d3bba46b92f43461163bb5e99e15bd">OTServer::UserCmdGetOutbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10479">10479</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getOutbox&quot;</span>;         <span class="comment">// reply to getOutbox</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;     <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;        // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;    <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>), ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID(MsgIn.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadOutbox();

    <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load Outbox from storage.\n&quot;</span>, __FUNCTION__);
    <span class="keywordflow">else</span>
    {
        <span class="comment">// We do NOT call VerifyAccount in this function (because we don&#39;t need to) and thus we do NOT</span>
        <span class="comment">// force the box receipts to be loaded here (which happens inside that call.) But we DO verify</span>
        <span class="comment">// the IDs and the Signature, of course.</span>
        <span class="comment">//</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = (theLedger.VerifyContractID() &amp;&amp; theLedger.VerifySignature(m_nymServer));

        <span class="comment">// If we loaded old data in this file... (when whole receipts were stored in boxes.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theLedger.LoadedLegacyData())  <span class="comment">// (which automatically saves the box receipt as the old data is loaded...)</span>
        {
<span class="comment">//          msgOut.m_bSuccess = theLedger.VerifyAccount(m_nymServer);   // Then Verify, which forces a LoadBoxReceipts... (</span>

            theLedger.ReleaseSignatures();              <span class="comment">// UPDATE: We do NOT force the loading here, since they aren&#39;t needed.</span>
            theLedger.SignContract(m_nymServer);        <span class="comment">// Waste of resources. Instead, we recognize that it was old data, and so</span>
            theLedger.SaveContract();                   <span class="comment">// we gracefully re-save in the new format, so it won&#39;t repeatedly be</span>
            theLedger.SaveOutbox();                     <span class="comment">// loaded over and over again in the large filesize.</span>
        }

        <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Verification Failed on Outbox after loading.\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="comment">// extract the ledger in ascii-armored form on the outgoing message</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(theLedger); <span class="comment">// first grab it in plaintext string form</span>
        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the outbox ledger in its payload in base64 form.</span>

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theHash;
        <span class="keywordflow">if</span> (theLedger.CalculateOutboxHash(theHash))
            theHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>);
    }
    <span class="comment">// Send the user&#39;s command back to him if failure.</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="af69a358a7b5214d6200fe8d838e7f5d9"></a><!-- doxytag: member="OTServer::UserCmdGetRequest" ref="af69a358a7b5214d6200fe8d838e7f5d9" args="(OTPseudonym &amp;theNym, OTMessage &amp;msgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#af69a358a7b5214d6200fe8d838e7f5d9">OTServer::UserCmdGetRequest</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02564">2564</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getRequest&quot;</span>;    <span class="comment">// reply to getRequest</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.m_strNymID; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    msgOut.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(MsgIn.m_strRequestNum); <span class="comment">// Outoing reply contains same request num coming in (1).</span>

    int64_t lReqNum = 1; <span class="comment">// The request number being REQUESTED (in this message) will be sent in msgOut.m_lNewRequestNum</span>

    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>   = theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(m_strServerID, lReqNum);

    <span class="comment">// Server was unable to load ReqNum, which is unusual because the calling function</span>
    <span class="comment">// should have already insured its existence.</span>
    <span class="keywordflow">if</span> (!msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading request number in OTServer::UserCmdGetRequest\n&quot;</span>);
    }
    <span class="comment">// ---------------</span>
    <span class="keywordflow">else</span>
        msgOut.<a class="code" href="class_o_t_message.html#a2d3fecf3324ca955abb23d0a4be0af6b">m_lNewRequestNum</a> = lReqNum;
<span class="comment">//      msgOut.m_strRequestNum.Format(&quot;%ld&quot;, lReqNum); // This will now contain the same req num (1) that came in, with the new one stored in msgOut.m_lNewRequestNum instead.</span>
    <span class="comment">// ---------------</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID);
    <span class="comment">// ---------------</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> EXISTING_NYMBOX_HASH;
    <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, EXISTING_NYMBOX_HASH))
        EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="keywordflow">else</span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNymID(theNym);
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(theNymID, theNymID, SERVER_ID);

        <span class="keywordflow">if</span> (theLedger.LoadNymbox()          &amp;&amp;
            theLedger.VerifyContractID()    &amp;&amp;
            theLedger.VerifySignature(m_nymServer))
        {
            theLedger.CalculateNymboxHash(EXISTING_NYMBOX_HASH);

            theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(EXISTING_NYMBOX_HASH);
            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

            EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
        }
    }
    <span class="comment">// ---------------</span>

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8c6822ad744234645f3086bbf99e0c43"></a><!-- doxytag: member="OTServer::UserCmdGetTransactionNum" ref="a8c6822ad744234645f3086bbf99e0c43" args="(OTPseudonym &amp;theNym, OTMessage &amp;msgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a8c6822ad744234645f3086bbf99e0c43">OTServer::UserCmdGetTransactionNum</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02371">2371</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@getTransactionNum&quot;</span>; <span class="comment">// reply to getTransactionNum</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.m_strNymID; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="comment">// already at the top of ProcessUserCommand, which calls this.</span>
<span class="comment">//  msgOut.m_strRequestNum.Set(MsgIn.m_strRequestNum);</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(m_strServerID);

    <span class="comment">// ---------------</span>
    <span class="comment">// A few client requests, and a few server replies (not exactly matched up)</span>
    <span class="comment">// will include a copy of the NymboxHash.  The server may reject certain</span>
    <span class="comment">// client requests that have a bad value here (since it would be out of sync</span>
    <span class="comment">// anyway); the client is able to see the server&#39;s hash and realize to</span>
    <span class="comment">// re-download the nymbox and other intermediary files.</span>
    <span class="comment">//</span>
    <span class="comment">// ------------------------------------------------------------</span>
    int32_t nCount = theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID);
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keyword">const</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theMsgNymboxHash(MsgIn.m_strNymboxHash);    <span class="comment">// theMsgNymboxHash is the hash sent by the client side</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  EXISTING_NYMBOX_HASH;

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, EXISTING_NYMBOX_HASH);
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNymboxHashClientSide = MsgIn.m_strNymboxHash.Exists();

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// EXISTING_NYMBOX_HASH is the hash stored on the server side</span>
        EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (
        (bGotNymboxHashServerSide &amp;&amp; bGotNymboxHashClientSide &amp;&amp; (theMsgNymboxHash != EXISTING_NYMBOX_HASH))
        ||
        (bGotNymboxHashServerSide &amp;&amp; !bGotNymboxHashClientSide)
        )
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTServer::UserCmdGetTransactionNum: Rejecting message since nymbox hash &quot;</span>
                      <span class="stringliteral">&quot;doesn&#39;t match. (Send a getNymbox message to grab the newest one.)\n&quot;</span>);

    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nCount &gt; 50) <span class="comment">// todo no hardcoding. (max transaction nums allowed out at a single time.)</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::UserCmdGetTransactionNum: Failure: Nym %s already has &quot;</span>
                       <span class="stringliteral">&quot;more than 50 unused transaction numbers signed out. (He needs to use those first. &quot;</span>
                       <span class="stringliteral">&quot;Tell him to download his latest Nymbox.)\n&quot;</span>, MsgIn.m_strNymID.Get());
    }
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID, NYMBOX_HASH;
        theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);

        <span class="keywordtype">bool</span>        bSuccess = <span class="keyword">true</span>, bCalculated = <span class="keyword">false</span>;
        <span class="keywordtype">bool</span>        bSavedNymbox = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theLedger(USER_ID, USER_ID, SERVER_ID); <span class="comment">// Nymbox</span>

        <span class="comment">// We&#39;ll store the transaction numbers here immediately after they&#39;re issued,</span>
        <span class="comment">// before adding them to the Nymbox.</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_num_list.html">OTNumList</a>   theNumlist;

        int64_t    lFirstTransNum = 0; <span class="comment">// While there may be 20 transaction numbers on this tranasction, ONE of them (the first one) is the &quot;official&quot; number of this transaction. The rest are just attached in an extra variable.</span>

        <span class="comment">// Update: Now we&#39;re going to grab 20 or 30 transaction numbers,</span>
        <span class="comment">// instead of just 1 like before!!!</span>
        <span class="comment">//</span>
        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; 100; i++) <span class="comment">// todo, hardcoding!!!! (But notice we grab 100 transaction numbers at a time now.)</span>
        {
            int64_t lTransNum = 0;
            <span class="comment">// This call will save the new transaction number to the nym&#39;s file.</span>
            <span class="comment">// ??? Why did I say that, when clearly the last parameter is false?</span>
            <span class="comment">// AHHHH Because I drop it into the Nymbox instead, and make him sign for it!</span>

            <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ab1bb5230bbd1f13dc1b43203c092b99c">IssueNextTransactionNumber</a>(theNym, lTransNum, <span class="keyword">false</span>)) <span class="comment">// bool bStoreTheNumber = false</span>
            {
                lTransNum = 0;
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTServer::UserCmdGetTransactionNu: Error issuing next transaction number!\n&quot;</span>);
                bSuccess = <span class="keyword">false</span>;
                <span class="keywordflow">break</span>;
            }

            theNumlist.Add(lTransNum); <span class="comment">// &lt;=========</span>
            <span class="keywordflow">if</span> (0 == i) <span class="comment">// First iteration</span>
                lFirstTransNum = lTransNum;
        }
        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccess)
        {
            <span class="comment">// Apparently nothing. Also, plenty of logs just above already, if this ever happens.</span>
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theLedger.LoadNymbox())
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading Nymbox in OTServer::UserCmdGetTransactionNum\n&quot;</span>);
        }
        <span class="comment">// Drop in the Nymbox</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> =   (
<span class="comment">//                                       theLedger.VerifyAccount(m_nymServer) &amp;&amp;    // This forces ALL box receipts to load.</span>
                                         theLedger.VerifyContractID() &amp;&amp;            <span class="comment">// We don&#39;t need them right now, so we verify</span>
                                         theLedger.VerifySignature(m_nymServer)     <span class="comment">// everything else without loading them.</span>
                                         ) <span class="comment">// if loaded and verified.</span>
                 )) <span class="comment">// if success</span>
        {
            <span class="comment">// Note: I decided against adding newly-requested transaction numbers to existing OTTransaction::blanks in the Nymbox.</span>
            <span class="comment">// Why not? Because once the user downloads the Box Receipt, he will think he has it already, when the Server meanwhile</span>
            <span class="comment">// has a new version of that same Box Receipt. But the user will never re-download it if he believes that he already has</span>
            <span class="comment">// it.</span>
            <span class="comment">// Since the transaction can contain 10, 20, or 50 transaction numbers now, we don&#39;t NEED to be able to combine them</span>
            <span class="comment">// anyway, since the problem is still effectively solved.</span>

            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theLedger, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>, lFirstTransNum);  <span class="comment">// Generate a new OTTransaction::blank</span>

            <span class="keywordflow">if</span> (NULL != pTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
            {
                <span class="comment">// ADD the contents of theNumlist (the 20 new transaction numbers we&#39;re giving the user)</span>
                <span class="comment">// to this OTTransaction::blank.</span>
                <span class="comment">//</span>
                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a492f3f835f309bd2e76e5d7cc4dc10a1">AddNumbersToTransaction</a>(theNumlist);

                pTransaction-&gt;  SignContract(m_nymServer);
                pTransaction-&gt;  SaveContract();

                theLedger.AddTransaction(*pTransaction);

                theLedger.ReleaseSignatures();
                theLedger.SignContract(m_nymServer);
                theLedger.SaveContract();

                bSavedNymbox = <span class="keyword">true</span>;
                theLedger.SaveNymbox(&amp;NYMBOX_HASH);

                <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                <span class="comment">//</span>
                <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                <span class="comment">// is removed from a box.</span>
                <span class="comment">//</span>
                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theLedger);
            }
            <span class="keywordflow">else</span>
                bCalculated = theLedger.CalculateNymboxHash(NYMBOX_HASH);
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error verifying Nymbox in OTServer::UserCmdGetTransactionNum\n&quot;</span>);
        }
        <span class="comment">// ------------------------------------------------------------</span>
        std::set&lt;int64_t&gt; theList;
        theNumlist.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theList);

        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theList)
        {
            <span class="keyword">const</span> int64_t lTransNum = *it;
            <span class="comment">// ----------------------------</span>
            <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a> (theNym, lTransNum, <span class="keyword">false</span>); <span class="comment">//bSave=false</span>
            <a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>      (theNym, lTransNum, <span class="keyword">false</span>); <span class="comment">// I&#39;ll drop it in his Nymbox -- he can SIGN for it.</span>
            <span class="comment">// Then why was it added in the first place? Because we originally sent it back in the reply directly,</span>
            <span class="comment">// so IssueNext was designed to work that way originally.</span>
        }
        <span class="comment">// ----------------</span>

        <span class="keywordflow">if</span> (bSavedNymbox)
        {
            theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH);
            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

            NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
        {
            bCalculated = theLedger.CalculateNymboxHash(NYMBOX_HASH);

            theNym.<a class="code" href="class_o_t_pseudonym.html#ab3b725b4837a88a8d273d5ca1ad636a0">SetNymboxHashServerSide</a>(NYMBOX_HASH);    <span class="comment">// Save the hash onto the Nym</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

            NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);  <span class="comment">// Get the hash onto the message</span>
        }
        <span class="comment">// else EXISTING_NYMBOX_HASH.GetString(msgOut.m_strNymboxHash); (above)</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4ed65b2a39d3493cae05af541aafab7f"></a><!-- doxytag: member="OTServer::UserCmdIssueAssetType" ref="a4ed65b2a39d3493cae05af541aafab7f" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a4ed65b2a39d3493cae05af541aafab7f">OTServer::UserCmdIssueAssetType</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>An existing user is issuing a new currency. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l03222">3222</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTServer::UserCmdIssueAssetType&quot;</span>;

    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@issueAssetType&quot;</span>;<span class="comment">// reply to issueAssetType</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>     = MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>;   <span class="comment">// Asset Type ID, a hash of the asset contract.</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="comment">// already at the top of ProcessUserCommand, which calls this.</span>
<span class="comment">//  msgOut.m_strRequestNum.Set(MsgIn.m_strRequestNum);</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym), SERVER_ID(m_strServerID), ASSET_TYPE_ID(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pAssetContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(ASSET_TYPE_ID);

    <span class="comment">// Make sure the contract isn&#39;t already available on this server.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (NULL != pAssetContract) <span class="comment">// it exists already.</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Attempt to issue asset type that already exists.\n&quot;</span>,
                      szFunc);
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// Pull the contract out of the message and verify it.</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get()), strFilename(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <a class="code" href="class_o_t_string.html">OTString</a> strContract(MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
        pAssetContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername, strFilename, MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    ASSET_USER_ID;
        <span class="keywordtype">bool</span>            bSuccessLoadingContract = <span class="keyword">false</span>;
        <span class="keywordtype">bool</span>            bSuccessCalculateDigest = <span class="keyword">false</span>;
        <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pNym                    = NULL;

        <span class="keywordflow">if</span> (NULL == pAssetContract)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to instantiate asset contract. Asset ID: %s\n&quot;</span>,
                          szFunc, MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="keywordflow">else</span> <span class="comment">// success instantiating contract.</span>
        {
            bSuccessLoadingContract = pAssetContract-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strContract);

            <span class="keywordflow">if</span> (!bSuccessLoadingContract)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to load asset contract from string. Asset ID: %s\n&quot;</span>,
                               szFunc, MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed trying to load asset contract from string. Contract:\n\n%s\n\n&quot;</span>,
                               szFunc, strContract.Get());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pAssetContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Prevented attempt by user to issue a basket currency contract. (He needs to use the issueBasket message for that.)\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="comment">// success loading contract from string.</span>
            {
                pNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>*)pAssetContract-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>(); <span class="comment">// todo fix this cast.</span>

                <span class="keywordflow">if</span> (NULL == pNym)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to retrieve Issuer&#39;s public key from asset &quot;</span>
                                   <span class="stringliteral">&quot;contract. Asset ID: %s\n&quot;</span>, szFunc, MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                }
                <span class="keywordflow">else</span> <span class="comment">// success retrieving issuer Nym&#39;s public key from asset contract.</span>
                {
                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(ASSET_USER_ID);

                    bSuccessCalculateDigest = <span class="keyword">true</span>;

<span class="comment">//                    OTString strPublicKey;</span>
<span class="comment">//                    bool bGotPublicKey = pNym-&gt;GetPublicSignKey().GetPublicKey(strPublicKey);</span>
<span class="comment">//</span>
<span class="comment">//                    if (!bGotPublicKey)</span>
<span class="comment">//                    {</span>
<span class="comment">//                        OTLog::vError(&quot;%s: Error getting public key in OTServer::UserCmdIssueAssetType.\n&quot;,</span>
<span class="comment">//                                      szFunc);</span>
<span class="comment">//                    }</span>
<span class="comment">//                    else // success retrieving public key from Nym</span>
<span class="comment">//                    {</span>
<span class="comment">//                        bSuccessCalculateDigest = ASSET_USER_ID.CalculateDigest(strPublicKey);</span>
<span class="comment">//</span>
<span class="comment">//                        if (!bSuccessCalculateDigest)</span>
<span class="comment">//                        {</span>
<span class="comment">//                            OTLog::vError(&quot;%s: Error calculating digest in OTServer::UserCmdIssueAssetType.\n&quot;,</span>
<span class="comment">//                                          szFunc);</span>
<span class="comment">//                        }</span>
<span class="comment">//                    }</span>
                }
            }
        }

        <span class="comment">// Make sure the public key in the contract is the public key of the Nym.</span>
        <span class="comment">// If we successfully loaded the contract from the string, and the contract</span>
        <span class="comment">// internally verifies (the ID matches the hash of the contract, and the</span>
        <span class="comment">// signature verifies with the contract key that&#39;s inside the contract),</span>
        <span class="comment">// AND the Nym making this request has the same ID as the Nym in the</span>
        <span class="comment">// asset contract. (ONLY the issuer of that contract can connect to this</span>
        <span class="comment">// server and issue his currency.)</span>
        <span class="comment">// TODO make sure a receipt is issued that the issuer can post on his</span>
        <span class="comment">// website, to verify that he has indeed issued the currency at the specified</span>
        <span class="comment">// transaction processor.  That way, users can double-check.</span>
        <span class="keywordflow">if</span> (bSuccessCalculateDigest)
        {
            <span class="keywordflow">if</span> ((ASSET_USER_ID == USER_ID))
                                        <span class="comment">// The ID of the user who signed the contract must be the ID of the user</span>
                                        <span class="comment">// whose public key is associated with this user account. They are one.</span>
            {
                <span class="keywordflow">if</span> (pAssetContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
                {
                    <span class="comment">// Create an ISSUER account (like a normal account, except it can go negative)</span>
                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pNewAccount = NULL;
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAcctGuardian;

                    pNewAccount = <a class="code" href="class_o_t_account.html#a67320767550f65babfeebee7beff2c34">OTAccount::GenerateNewAccount</a>(USER_ID, SERVER_ID,
                                                                m_nymServer, MsgIn,
                                                                <a class="code" href="class_o_t_account.html#aadaf6bd4178672bdbc783c6f06313784a170fa7885ccfa40da7ae333ea2ae494a">OTAccount::issuer</a>);

                    <span class="comment">// If we successfully create the account, then bundle it in the message XML payload</span>
                    <span class="keywordflow">if</span> (NULL != pNewAccount) <span class="comment">// This last parameter generates an ISSUER account</span>
                    {                                                                   <span class="comment">// instead of the default SIMPLE.</span>
                        theAcctGuardian.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pNewAccount); <span class="comment">// So I don&#39;t have to worry about cleaning it up.</span>

                        <a class="code" href="class_o_t_string.html">OTString</a> tempPayload(*pNewAccount);
                        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempPayload);

                        <span class="comment">// Attach the new account number to the outgoing message.</span>
                        pNewAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);

                        <span class="comment">// Now that the account is actually created, let&#39;s add the new asset contract</span>
                        <span class="comment">// to the server&#39;s list.</span>
                        <a class="code" href="class_o_t_server.html#ab89e968c42db6c16b835e36c899d8ea4">AddAssetContract</a>(*pAssetContract); <span class="comment">// Do NOT clean this up unless failure! Server will clean it up.</span>
                        <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>(); <span class="comment">// So the main xml file knows to load this asset type next time we run.</span>

                        <span class="comment">// Make sure the contracts/%s file is created for next time.</span>
                        pAssetContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="comment">// ---------------------------------------------------</span>
                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNewAccountID;
                        pNewAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theNewAccountID);
                        <span class="comment">// -----------------------------------------------</span>
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Generating inbox/outbox for new issuer acct. \n&quot;</span>);

                        <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theOutbox   (USER_ID, theNewAccountID, SERVER_ID),
                                    theInbox    (USER_ID, theNewAccountID, SERVER_ID);

                        <span class="keywordtype">bool</span> bSuccessLoadingInbox   = theInbox.LoadInbox();
                        <span class="keywordtype">bool</span> bSuccessLoadingOutbox  = theOutbox.LoadOutbox();
                        <span class="comment">// --------------------------------------------------------------------</span>
                        <span class="comment">// ...or generate them otherwise...</span>

                        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingInbox) <span class="comment">// WEIRD IF THIS HAPPENED...</span>
                            bSuccessLoadingInbox    = theInbox.VerifyAccount(m_nymServer); <span class="comment">// todo -- this should NEVER happen, the ID was just RANDOMLY generated, so HOW did the inbox already exist???</span>
                        <span class="keywordflow">else</span>
                        {
                            bSuccessLoadingInbox    = theInbox.GenerateLedger(theNewAccountID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

                            <span class="keywordflow">if</span> (bSuccessLoadingInbox)
                            {
                                bSuccessLoadingInbox    = theInbox.SignContract(m_nymServer);

                                <span class="keywordflow">if</span> (bSuccessLoadingInbox)
                                {
                                    bSuccessLoadingInbox = theInbox.SaveContract();

                                    <span class="keywordflow">if</span> (bSuccessLoadingInbox)
                                        bSuccessLoadingInbox    = pNewAccount-&gt;<a class="code" href="class_o_t_account.html#a81e503e95310da5ac9c2003cb00d6d2e">SaveInbox</a>(theInbox);
                                }
                            }
                        }
                        <span class="comment">// --------------------------------------------------------------------</span>
                        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOutbox) <span class="comment">// WEIRD IF THIS HAPPENED....</span>
                            bSuccessLoadingOutbox   = theOutbox.VerifyAccount(m_nymServer); <span class="comment">// todo -- this should NEVER happen, the ID was just RANDOMLY generated, so HOW did the outbox already exist???</span>
                        <span class="keywordflow">else</span>
                        {
                            bSuccessLoadingOutbox   = theOutbox.GenerateLedger(theNewAccountID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

                            <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
                            {
                                bSuccessLoadingOutbox   = theOutbox.SignContract(m_nymServer);

                                <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
                                {
                                    bSuccessLoadingOutbox = theOutbox.SaveContract();

                                    <span class="keywordflow">if</span> (bSuccessLoadingOutbox)
                                        bSuccessLoadingOutbox   = pNewAccount-&gt;<a class="code" href="class_o_t_account.html#ad8c1a43eff592d7cd7af20fcd2eac468">SaveOutbox</a>(theOutbox);
                                }
                            }
                        }
                        <span class="comment">// --------------------------------------------------------------------</span>
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingInbox)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strNewAcctID(theNewAccountID);

                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR generating inbox ledger in OTServer::UserCmdIssueAssetType:\n%s\n&quot;</span>,
                                          strNewAcctID.Get());
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessLoadingOutbox)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strNewAcctID(theNewAccountID);

                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR generating outbox ledger in OTServer::UserCmdIssueAssetType:\n%s\n&quot;</span>,
                                          strNewAcctID.Get());
                        }
                        <span class="keywordflow">else</span>
                        {
                            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>; <span class="comment">// &lt;==== SUCCESS!!</span>

                            <span class="comment">// On the server side, each nym stores a list of its asset accounts (IDs).</span>
                            <span class="comment">//</span>
                            std::set&lt;std::string&gt; &amp; theAccountSet = theNym.<a class="code" href="class_o_t_pseudonym.html#ad3dbc1ca45e891918fb363bdf24a57e3">GetSetAssetAccounts</a>();
                            theAccountSet.insert(msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                            theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer);

                            <span class="comment">// TODO fire off a separate process here to create the mint.</span>
                            <span class="comment">//</span>
                            <span class="comment">// THE PROGRAM ALREADY EXISTS (CreateMint) and you can RUN IT BY HAND FOR NOW.</span>
                            <span class="comment">// But in actual production environment, we&#39;ll trigger that executable here,</span>
                            <span class="comment">// and within a few minutes, users will be able to getMint successfully (and</span>
                            <span class="comment">// thus withdraw cash.)</span>
                        }
                    }
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failure generating new issuer account in OTServer::UserCmdIssueAssetType.\n&quot;</span>);
                }
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failure verifying asset contract in OTServer::UserCmdIssueAssetType.\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_string.html">OTString</a> strAssetUserID(ASSET_USER_ID), strUserID;
                theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strUserID);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;User ID on this user account (%s) does NOT match User ID &quot;</span>
                              <span class="stringliteral">&quot;for public key used in asset contract: %s\n&quot;</span>,
                              strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetUserID.Get());
            }
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading asset contract from client.\n&quot;</span>, __FUNCTION__);
        <span class="comment">// -----------------------------------------------</span>
        <span class="keywordflow">if</span> (pAssetContract &amp;&amp; !msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>) <span class="comment">// We only clean it up here, if the Server didn&#39;t take ownership of it.</span>
        {
            <span class="keyword">delete</span> pAssetContract;
            pAssetContract = NULL;
        }
    }

    <span class="comment">// Either way, we need to send the user&#39;s command back to him as well.</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    <span class="comment">// (You are in UserCmdIssueAssetType.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum,
                                      <span class="keyword">false</span>,    <span class="comment">// trans success (not a transaction...)</span>
                                      &amp;theNym);
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad8d48ac00f17dd758ee1ce638ec5eb3e"></a><!-- doxytag: member="OTServer::UserCmdIssueBasket" ref="ad8d48ac00f17dd758ee1ce638ec5eb3e" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ad8d48ac00f17dd758ee1ce638ec5eb3e">OTServer::UserCmdIssueBasket</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>An existing user is creating an issuer account (that he will not control) based on a basket of currencies. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l03512">3512</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@issueBasket&quot;</span>;   <span class="comment">// reply to issueBasket</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="comment">// Either way, we need to send the user&#39;s command back to him as well.</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym), SERVER_ID(m_strServerID), SERVER_USER_ID(m_nymServer);

    <a class="code" href="class_o_t_string.html">OTString</a> strBasket(MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
    <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;

    <span class="keywordflow">if</span> (!theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strBasket))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load basket from string.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theBasket.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed verifying signature on basket.\n&quot;</span>, __FUNCTION__);
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// The basket ID should be the same on all servers.</span>
        <span class="comment">// The basket contract ID will be unique on each server.</span>
        <span class="comment">//</span>
        <span class="comment">// The contract ID of the basket is calculated based on the UNSIGNED portion of the contract</span>
        <span class="comment">// (so it is unique on every server) and for the same reason with the AccountID removed before calculating.</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> BASKET_ID, BASKET_ACCOUNT_ID, BASKET_CONTRACT_ID;
        theBasket.<a class="code" href="class_o_t_basket.html#a5a3f5c035ad58df511c6829675186a1c">CalculateContractID</a>(BASKET_ID);

        <span class="comment">// Use BASKET_ID to look up the Basket account and see if it already exists (the server keeps a list.)</span>
        <span class="keywordtype">bool</span> bFoundBasket = <a class="code" href="class_o_t_server.html#ad42ad136163957930d250c295d135a83">LookupBasketAccountID</a>(BASKET_ID, BASKET_ACCOUNT_ID);

        <span class="keywordflow">if</span> (bFoundBasket)
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Rejected: user tried to create basket currency that already exists.\n&quot;</span>, __FUNCTION__);
        }
        <span class="keywordflow">else</span> <span class="comment">// Basket doesn&#39;t already exist -- so perhaps we can create it then.</span>
        {
            <span class="comment">// Let&#39;s make sure that all the sub-currencies for this basket are available on this server.</span>
            <span class="comment">// NOTE: this also prevents someone from using another basket as a sub-currency UNLESS it already</span>
            <span class="comment">// exists on this server. (For example, they couldn&#39;t use a basket contract from some other</span>
            <span class="comment">// server, since it wouldn&#39;t be issued here...) Also note that issueAssetType explicitly prevents</span>
            <span class="comment">// baskets from being issued -- you HAVE to use issueBasket for creating any basket currency.</span>
            <span class="comment">// Taken in tandem, this insures that the only possible way to have a basket currency as a sub-currency</span>
            <span class="comment">// is if it&#39;s already issued on this server.</span>
            <span class="comment">//</span>
            <span class="keywordtype">bool</span> bSubCurrenciesAllExist = <span class="keyword">true</span>;

            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
            {
                <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);

                <span class="keywordflow">if</span> (NULL == this-&gt;<a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>)) <span class="comment">// Sub-currency not found.</span>
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSubID(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>);
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: Sub-currency for basket is not issued on this server: %s\n&quot;</span>,
                                  __FUNCTION__, strSubID.Get());
                    bSubCurrenciesAllExist = <span class="keyword">false</span>;
                    <span class="keywordflow">break</span>;
                }
            }
            <span class="comment">// -----------------------------------------------------------------------------------</span>
            <span class="comment">// By this point we know that the basket currency itself does NOT already exist (good.)</span>
            <span class="comment">// We also know that all the subcurrencies DO already exist (good.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (bSubCurrenciesAllExist)
            {
                <span class="comment">// GenerateNewAccount also expects the NymID to be stored in m_strNymID.</span>
                <span class="comment">// Since we want the SERVER to be the user for basket accounts, I&#39;m setting it that</span>
                <span class="comment">// way in MsgIn so that GenerateNewAccount will create the sub-account with the server</span>
                <span class="comment">// as the owner, instead of the user.</span>
                SERVER_USER_ID.GetString(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>);

                <span class="comment">// We need to actually create all the sub-accounts.</span>
                <span class="comment">// This loop also sets the Account ID onto the basket items (which formerly was blank, from the client.)</span>
                <span class="comment">// This loop also adds the BASKET_ID and the NEW ACCOUNT ID to a map on the server for later reference.</span>
                <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
                {
                    <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);
                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);

                    <span class="comment">/*</span>
<span class="comment">                     // Just make sure theMessage has these members populated:</span>
<span class="comment">                     //</span>
<span class="comment">                     // theMessage.m_strNymID;</span>
<span class="comment">                     // theMessage.m_strAssetID;</span>
<span class="comment">                     // theMessage.m_strServerID;</span>
<span class="comment"></span>
<span class="comment">                     // static method (call it without an instance, using notation: OTAccount::GenerateNewAccount)</span>
<span class="comment">                     OTAccount * OTAccount::GenerateNewAccount( const OTIdentifier &amp; theUserID, const OTIdentifier &amp; theServerID,</span>
<span class="comment">                                                                const OTPseudonym &amp; theServerNym,   const OTMessage &amp; theMessage,</span>
<span class="comment">                                                                const OTAccount::AccountType eAcctType=OTAccount::simple)</span>
<span class="comment"></span>
<span class="comment">                     // The above method uses this one internally...</span>
<span class="comment">                     bool OTAccount::GenerateNewAccount(const OTPseudonym &amp; theServer, const OTMessage &amp; theMessage,</span>
<span class="comment">                                                        const OTAccount::AccountType eAcctType=OTAccount::simple)</span>
<span class="comment">                     */</span>

                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pNewAccount = NULL;

                    <span class="comment">// GenerateNewAccount expects the Asset ID to be in MsgIn.</span>
                    <span class="comment">// So we&#39;ll just put it there to make things easy...</span>
                    <span class="comment">//</span>
                    pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

                    pNewAccount = <a class="code" href="class_o_t_account.html#a67320767550f65babfeebee7beff2c34">OTAccount::GenerateNewAccount</a>(SERVER_USER_ID,
                                                                SERVER_ID,
                                                                m_nymServer,
                                                                MsgIn,
                                                                <a class="code" href="class_o_t_account.html#aadaf6bd4178672bdbc783c6f06313784a5aacd60653d044eb340bdc1f884b29df">OTAccount::basketsub</a>);

                    <span class="comment">// If we successfully create the account, then bundle it</span>
                    <span class="comment">// in the message XML payload</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (NULL != pNewAccount)
                    {
                        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

                        <span class="comment">// Now the item finally has its account ID. Let&#39;s grab it.</span>
                        pNewAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(pItem-&gt;<a class="code" href="class_basket_item.html#a6926a25bfb975ac37b2ea49a44fc3294">SUB_ACCOUNT_ID</a>);

                        <span class="keyword">delete</span> pNewAccount;
                        pNewAccount = NULL;
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while calling: &quot;</span>
                                     <span class="stringliteral">&quot;OTAccount::GenerateNewAccount(SERVER_USER_ID, SERVER_ID, m_nymServer, &quot;</span>
                                     <span class="stringliteral">&quot;MsgIn, OTAccount::basketsub)\n&quot;</span>, __FUNCTION__);
                        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>;
                    }
                } <span class="comment">// for</span>


                <span class="keywordflow">if</span> (<span class="keyword">true</span> == msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
                {
                    <span class="comment">// Generate a new OTAssetContract -- the ID will be a hash of THAT contract, which includes theBasket as well as</span>
                    <span class="comment">// the server&#39;s public key as part of its contents. Therefore, the actual Asset Type ID of the basket currency</span>
                    <span class="comment">// will be different from server to server.</span>
                    <span class="comment">//</span>
                    <span class="comment">// BUT!! Because we can also generate a hash of theBasket.m_xmlUnsigned (which is what OTBasket::CalculateContractID</span>
                    <span class="comment">// does) then we have a way of obtaining a number that will be the same from server to server, for cross-server</span>
                    <span class="comment">// transfers of basket assets.</span>
                    <span class="comment">//</span>
                    <span class="comment">// The way it will work is, when the cross-server transfer request is generated, the server will check the asset contract</span>
                    <span class="comment">// for the &quot;from&quot; account and see if it is for a basket currency. If it is, there will be a function on the contract</span>
                    <span class="comment">// that returns the Basket ID, which can be included in the message to the target server, which uses the ID to look</span>
                    <span class="comment">// for its own basket issuer account for the same basket asset type. This allows the target server to translate the</span>
                    <span class="comment">// Asset Type ID to its own corresponding ID for the same basket.</span>
                    <span class="comment">// -----------------------------------------------------------------------------------</span>
                    theBasket.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    theBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
                    theBasket.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="comment">// The basket does not yet exist on this server. Create a new Asset Contract to support it...</span>
                    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pBasketContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>;

                    <span class="comment">// todo check for memory allocation failure here.</span>

                    <span class="comment">// Put the Server&#39;s Public Key into the &quot;contract&quot; key field of the new Asset Contract...</span>
                    <span class="comment">// This adds a &quot;contract&quot; key to the asset contract (the server&#39;s public key)</span>
                    <span class="comment">// Asset Contracts are verified by a key found internal to the contract, so it&#39;s</span>
                    <span class="comment">// necessary to put the key in there so it will verify later.</span>
                    <span class="comment">// This also updates the m_xmlUnsigned contents, signs the contract, saves it,</span>
                    <span class="comment">// and calculates the new ID.</span>
                    pBasketContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ab3a38bdbd886fdc57d0a2293ec464548">CreateBasket</a>(theBasket, m_nymServer);

                    <span class="comment">// Grab the new asset ID for the new basket currency</span>
                    pBasketContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(BASKET_CONTRACT_ID);
                    <a class="code" href="class_o_t_string.html">OTString</a> STR_BASKET_CONTRACT_ID(BASKET_CONTRACT_ID);

                    <span class="comment">// set the new Asset Type ID, aka ContractID, onto the outgoing message.</span>
                    msgOut.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a> = STR_BASKET_CONTRACT_ID;

                    <span class="comment">// Save the new Asset Contract to disk</span>
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get()), strFilename(STR_BASKET_CONTRACT_ID.Get());

                    <span class="comment">// Save the new basket contract to the contracts folder</span>
                    <span class="comment">// (So the users can use it the same as they would use any other contract.)</span>
                    pBasketContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(strFoldername.Get(), strFilename.Get());

                    <a class="code" href="class_o_t_server.html#ab89e968c42db6c16b835e36c899d8ea4">AddAssetContract</a>(*pBasketContract);
                    <span class="comment">// I don&#39;t save this here. Instead, I wait for AddBasketAccountID and then I call SaveMainFile after that. See below.</span>
                    <span class="comment">// TODO need better code for reverting when something screws up halfway through a change.</span>
                    <span class="comment">// If I add this contract, it&#39;s not enough to just &quot;not save&quot; the file. I actually need to re-load the file</span>
                    <span class="comment">// in order to TRULY &quot;make sure&quot; this won&#39;t screw something up on down the line.</span>

                    <span class="comment">// Once the new Asset Type is generated, from which the BasketID can be requested at will, next we need to create</span>
                    <span class="comment">// the issuer account for that new Asset Type.  (We have the asset type ID and the contract file. Now let&#39;s create</span>
                    <span class="comment">// the issuer account the same as we would for any normal issuer account.)</span>
                    <span class="comment">//</span>
                    <span class="comment">// The issuer account is special compared to a normal issuer account, because within its walls, it must store an</span>
                    <span class="comment">// OTAccount for EACH sub-contract, in order to store the reserves. That&#39;s what makes the basket work.</span>

                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pBasketAccount = NULL;

                    <span class="comment">// GenerateNewAccount expects the Asset ID to be in MsgIn. So we&#39;ll just put it there to make things easy...</span>
                    MsgIn.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a> = STR_BASKET_CONTRACT_ID;

                    pBasketAccount = <a class="code" href="class_o_t_account.html#a67320767550f65babfeebee7beff2c34">OTAccount::GenerateNewAccount</a>(SERVER_USER_ID, SERVER_ID, m_nymServer, MsgIn, <a class="code" href="class_o_t_account.html#aadaf6bd4178672bdbc783c6f06313784ae1f1a5a7da2a20f9e1a72486fae08993">OTAccount::basket</a>);

                    <span class="keywordflow">if</span> (NULL != pBasketAccount)
                    {
                        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

                        pBasketAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>); <span class="comment">// string</span>
                        pBasketAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>().<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

                        pBasketAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(BASKET_ACCOUNT_ID); <span class="comment">// id</span>

                        <span class="comment">// So the server can later use the BASKET_ID (which is universal)</span>
                        <span class="comment">// to lookup the account ID on this server corresponding to that basket.</span>
                        <span class="comment">// (The account ID will be different from server to server, thus the need</span>
                        <span class="comment">// to be able to look it up via the basket ID.)</span>
                        <a class="code" href="class_o_t_server.html#ac8efe3db8d0a98dfcd9758d622160c51">AddBasketAccountID</a>(BASKET_ID, BASKET_ACCOUNT_ID, BASKET_CONTRACT_ID);

                        <a class="code" href="class_o_t_server.html#aa0f5b043756e7838af38539f4053ab24">SaveMainFile</a>(); <span class="comment">// So the main xml file loads this basket info next time we run.</span>

                        <span class="keyword">delete</span> pBasketAccount;
                        pBasketAccount = NULL;
                    }
                    <span class="keywordflow">else</span>
                    {
                        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
                    }

                }<span class="comment">// if true == msgOut.m_bSuccess</span>
            } <span class="comment">// Subcurrencies all do exist.</span>
        } <span class="comment">// basket doesn&#39;t already exist (creating it)</span>
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6ac2aae7675c14c1bbb4b6ef87c70499"></a><!-- doxytag: member="OTServer::UserCmdNotarizeTransactions" ref="a6ac2aae7675c14c1bbb4b6ef87c70499" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a6ac2aae7675c14c1bbb4b6ef87c70499">OTServer::UserCmdNotarizeTransactions</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>There will be more code here to handle all that. In the meantime, I just send a test response back to make sure the communication works.</p>
<p>An existing user is sending a list of transactions to be notarized. </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l09859">9859</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@notarizeTransactions&quot;</span>;  <span class="comment">// reply to notarizeTransactions</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;         <span class="comment">// UserID</span>
    <span class="comment">//  msgOut.m_strServerID    = m_strServerID;            // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;        <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>),
        ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>),
        SERVER_ID(m_strServerID),
        SERVER_USER_ID(m_nymServer);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);         <span class="comment">// These are ledgers used as messages. The one we received and the one</span>
    <span class="comment">// that we&#39;re sending back in response.</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pResponseLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(SERVER_USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>, <span class="keyword">false</span>);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRespLedgerGuardian(pResponseLedger); <span class="comment">// So I don&#39;t have to worry about cleaning it up.</span>
    <span class="comment">// ----------------</span>

    <span class="keywordtype">bool</span> bTransSuccess = <span class="keyword">false</span>; <span class="comment">// for the Nymbox notice.</span>
    <span class="keywordtype">bool</span> bCancelled    = <span class="keyword">false</span>; <span class="comment">// for &quot;failed&quot; transactions that were actually successful cancellations.</span>

    int64_t lTransactionNumber = 0, lResponseNumber = 0;
    <span class="comment">// --------------------------</span>
    <span class="comment">// Since the one going back (above) is a new ledger, we have to call GenerateLedger.</span>
    <span class="comment">// Whereas the ledger we received from the server was generated there, so we don&#39;t</span>
    <span class="comment">// have to generate it again. We just load it.</span>

    <a class="code" href="class_o_t_string.html">OTString</a> strLedger(MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theMsgNymboxHash(MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);    <span class="comment">// theMsgNymboxHash is the hash sent by the client side</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theSrvrNymboxHash;

    <span class="keywordtype">bool</span> bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="keywordflow">else</span> {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,<span class="stringliteral">&quot;%s: We cannot obtain server side nymbox hash, will continue.\n&quot;</span>,__FUNCTION__);
    }

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNymboxHashClientSide = MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();

    <span class="keywordflow">if</span> (!bGotNymboxHashClientSide) {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: We don&#39;t have a client side nymbox hash, will continue\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide &amp;&amp; bGotNymboxHashClientSide)
        <span class="keywordflow">if</span> (theMsgNymboxHash != theSrvrNymboxHash) {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The server and client nymbox hashes missmatch! rejecting message.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">goto</span> send_message;
        }


    <span class="comment">// as long as the request ledger loads from the message into memory, success is true</span>
    <span class="comment">// from there, the success or failure of the transactions within will be carried in</span>
    <span class="comment">// their own status variables and those of the items inside those transactions.</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadLedgerFromString(strLedger);

    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="comment">// In this case we need to process the ledger items</span>
        <span class="comment">// and create a corresponding ledger where each of the new items</span>
        <span class="comment">// contains the answer to the ledger item sent.</span>
        <span class="comment">// Then we send that new &quot;response ledger&quot; back to the user in MsgOut.Payload.</span>
        <span class="comment">// That is all done here. Until I write that, in the meantime,</span>
        <span class="comment">// let&#39;s just fprintf it out and see what it looks like.</span>
        <span class="comment">//      OTLog::Error(&quot;Loaded ledger out of message payload:\n%s\n&quot;, strLedger.Get());</span>
        <span class="comment">//      OTLog::Error(&quot;Loaded ledger out of message payload.\n&quot;);</span>

        <span class="comment">// Loop through ledger transactions, and do a &quot;NotarizeTransaction&quot; call for each one.</span>
        <span class="comment">// Inside that function it will do the various necessary authentication and processing, not this one.</span>
        <span class="comment">// NOTE: In practice there is only ONE transaction, but in potential there are many.</span>
        <span class="comment">// But so far, the code only actually has one, ever being sent. Otherwise the messages</span>
        <span class="comment">// get too big IMO.</span>
        <span class="comment">//</span>
        int32_t nCounter = 0;
        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theLedger.GetTransactionMap())
        {
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
            ++nCounter;

            <span class="keywordflow">if</span> (1 != nCounter)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;WARNING: multiple transactions in a single message ledger.\n&quot;</span>);

            <span class="comment">// for each transaction in the ledger, we create a transaction response and add</span>
            <span class="comment">// that to the response ledger.</span>

            <span class="comment">// I don&#39;t call IssueNextTransactionNumber here because I&#39;m not creating a new transaction</span>
            <span class="comment">// in someone&#39;s inbox or outbox. Instead, I&#39;m making a transaction response to a transaction</span>
            <span class="comment">// request, with a MATCHING transaction number (so don&#39;t need to issue a new one) to be sent</span>
            <span class="comment">// back to the client in a message.</span>
            <span class="comment">//</span>
            <span class="comment">// On this new &quot;response transaction&quot;, I set the ACCT ID, the serverID, and Transaction Number.</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTranResponse =
                <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pResponseLedger,
                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
            <span class="comment">// Add the response transaction to the response ledger.</span>
            <span class="comment">// That will go into the response message and be sent back to the client.</span>
            pResponseLedger-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTranResponse);

            <span class="comment">// Now let&#39;s make sure the response transaction has a copy of the transaction</span>
            <span class="comment">// it is responding to.</span>
            <span class="comment">//              OTString strResponseTo;</span>
            <span class="comment">//              pTransaction-&gt;SaveContract(strResponseTo);</span>
            <span class="comment">//              pTranResponse-&gt;m_ascInReferenceTo.SetString(strResponseTo);</span>
            <span class="comment">// I commented out the above because we are keeping too many copies.</span>
            <span class="comment">// Message contains a copy of the message it&#39;s responding to.</span>
            <span class="comment">// Then each transaction contains a copy of the transaction responding to...</span>
            <span class="comment">// Then each ITEM in each transaction contains a copy of each item it&#39;s responding to.</span>
            <span class="comment">//</span>
            <span class="comment">// Therefore, for the &quot;notarizeTransactions&quot; message, I have decided (for now) to have</span>
            <span class="comment">// the extra copy in the items themselves, and in the overall message, but not in the</span>
            <span class="comment">// transactions. Thus, the above is commented out.</span>


            <span class="comment">// It should always return something. Success, or failure, that goes into pTranResponse.</span>
            <span class="comment">// I don&#39;t think there&#39;s need for more return value than that. The user has gotten deep</span>
            <span class="comment">// enough that they deserve SOME sort of response.</span>
            <span class="comment">//</span>
            <span class="comment">// This function also SIGNS the transaction, so there is no need to sign it after this.</span>
            <span class="comment">// There&#39;s also no point to change it after this, unless you plan to sign it twice.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_server.html#a4f55f071e6a561a33917a9a583c1da87">NotarizeTransaction</a>(theNym, *pTransaction, *pTranResponse, bTransSuccess);

            <span class="keywordflow">if</span> (pTranResponse-&gt;<a class="code" href="class_o_t_transaction.html#aeabba0a2b6a52c8f50a329f7d14a1ba1">IsCancelled</a>())
                bCancelled = <span class="keyword">true</span>;

            lTransactionNumber = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
            lResponseNumber    = pTranResponse-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(lTransactionNumber == lResponseNumber, <span class="stringliteral">&quot;Transaction number and response number should always be the same. (But this time, they weren&#39;t.)&quot;</span>);

            pTranResponse = NULL; <span class="comment">// at this point, the ledger now &quot;owns&quot; the response, and will handle deleting it.</span>
        }

        <span class="comment">// TODO: should consider saving a copy of the response ledger here on the server.</span>
        <span class="comment">// Until the user signs off of the responses, maybe the user didn&#39;t receive them.</span>
        <span class="comment">// The server should be able to re-send them until confirmation, then delete them.</span>
        <span class="comment">// So might want to consider a SAVE TO FILE here of that ledger we&#39;re sending out...</span>

        <span class="comment">// sign the ledger</span>
        pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
        pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

        <span class="comment">// extract the ledger in ascii-armored form</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pResponseLedger);

        msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);  <span class="comment">// now the outgoing message has the response ledger in its payload.</span>
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading ledger from message in OTServer::UserCmdNotarizeTransactions\n&quot;</span>);
    }

send_message:
    <span class="comment">// ---------------------------------------------------------------</span>
    <span class="comment">// todo: consider commenting this out since the transaction reply items already include a copy</span>
    <span class="comment">// of the original client communication that the server is responding to. No point beating a</span>
    <span class="comment">// dead horse.</span>
    <span class="comment">//</span>
    <span class="comment">// Send the user&#39;s command back to him as well.</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// UPDATE NYMBOX HASH IN OUTGOING MESSAGE</span>
    <span class="comment">//</span>
    <span class="comment">// We already grabbed the server&#39;s NymboxHash near the top of this function,</span>
    <span class="comment">// and attached it to the outgoing reply message.</span>
    <span class="comment">//</span>
    <span class="comment">// However, the above block may have CHANGED this hash! Therefore, we grab it</span>
    <span class="comment">// AGAIN, just in case. This way a failed message will receive the old hash,</span>
    <span class="comment">// and a successful message will receive the new hash.</span>
    <span class="comment">//</span>
    bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);
    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------</span>

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    <span class="comment">// (You are in UserCmdNotarizeTransactions.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After EVERY / ANY transaction, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        <span class="comment">//      this-&gt;DropReplyNoticeToNymbox(SERVER_ID, USER_ID, strReplyMessage, lReqNum, bTransSuccess, &amp;theNym); // We don&#39;t want to update the Nym in this case (I don&#39;t think.)</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum,
            bTransSuccess);    <span class="comment">// trans success</span>
    }
    <span class="comment">// -----------</span>
    <span class="keywordflow">if</span> (bCancelled)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Success: canceling transaction %ld for nym: %s \n&quot;</span>,
            lTransactionNumber, msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransSuccess)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Success: processing transaction %ld for nym: %s \n&quot;</span>,
            lTransactionNumber, msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Failure: processing transaction %ld for nym: %s \n&quot;</span>,
            lTransactionNumber, msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a45345893df0734299bd86c7dbddc4628"></a><!-- doxytag: member="OTServer::UserCmdProcessInbox" ref="a45345893df0734299bd86c7dbddc4628" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a45345893df0734299bd86c7dbddc4628">OTServer::UserCmdProcessInbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l12178">12178</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@processInbox&quot;</span>;  <span class="comment">// reply to processInbox</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>      = MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>;    <span class="comment">// The Account ID in question</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID(msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>),
                        ACCOUNT_ID(MsgIn.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>),
                        SERVER_ID(m_strServerID),
                        SERVER_USER_ID(m_nymServer);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);         <span class="comment">// These are ledgers used as messages. The one we received,</span>
                                                                <span class="comment">// and the one we&#39;re sending back.</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pResponseLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(SERVER_USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>, <span class="keyword">false</span>); <span class="comment">// bCreateFile=false</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pResponseLedger, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox: ASSERT: NULL != pResponseLedger&quot;</span>);
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRespLedgerGuardian(*pResponseLedger);

    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTranResponse = NULL;

    <span class="comment">//---------------------------------------------------</span>
    <span class="comment">// Grab the string (containing the request ledger) out of ascii-armored form.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strLedger(MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

    <span class="keywordtype">bool</span> bTransSuccess = <span class="keyword">false</span>;
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keyword">const</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theMsgNymboxHash(MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);    <span class="comment">// theMsgNymboxHash is the hash sent by the client side</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theSrvrNymboxHash;

    <span class="keywordtype">bool</span> bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="keywordflow">else</span> {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,<span class="stringliteral">&quot;%s: We cannot obtain server side nymbox hash, will continue.\n&quot;</span>,__FUNCTION__);
    }

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNymboxHashClientSide = MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();

    <span class="keywordflow">if</span> (!bGotNymboxHashClientSide) {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: We don&#39;t have a client side nymbox hash, will continue\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide &amp;&amp; bGotNymboxHashClientSide)
        <span class="keywordflow">if</span> (theMsgNymboxHash != theSrvrNymboxHash) {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The server and client nymbox hashes missmatch! rejecting message.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">goto</span> send_message;
        }

    <span class="comment">// theLedger contains a single transaction from the client, with an item inside</span>
    <span class="comment">// for each inbox transaction the client wants to accept or reject.</span>
    <span class="comment">// Let&#39;s see if we can load it from the string that came in the message...</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadContractFromString(strLedger);
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <a class="code" href="class_o_t_account.html">OTAccount</a> theAccount(USER_ID, ACCOUNT_ID, SERVER_ID);

        <span class="comment">// Make sure the &quot;from&quot; account even exists...</span>
        <span class="keywordflow">if</span> (!theAccount.LoadContract())
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox: Failed loading account: %s\n&quot;</span>,
                           strAcctID.Get());
        }
        <span class="comment">// Make sure the account isn&#39;t marked for deletion.</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theAccount.IsMarkedForDeletion())
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox: Failed attempt to use an Asset account that was marked for deletion.\n&quot;</span>);
        }
        <span class="comment">// Make sure the Account ID loaded from the file matches the one we just set and used as the filename.</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theAccount.VerifyContractID())
        {
            <span class="comment">// this should never happen. How did the wrong ID get into the account file, if the right</span>
            <span class="comment">// ID is on the filename itself? and vice versa.</span>
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error verifying account ID in OTServer::UserCmdProcessInbox\n&quot;</span>);
        }
        <span class="comment">// Make sure the nymID loaded up in the account as its actual owner matches the nym who was</span>
        <span class="comment">// passed in to this function requesting a transaction on this account... otherwise any asshole</span>
        <span class="comment">// could do transactions on your account, no?</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theAccount.VerifyOwner(theNym))
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Failed verifying account ownership in OTServer::UserCmdProcessInbox\n&quot;</span>);
        }
        <span class="comment">// Make sure I, the server, have signed this file.</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theAccount.VerifySignature(m_nymServer))
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error verifying server signature on account in OTServer::UserCmdProcessInbox\n&quot;</span>);
        }
        <span class="comment">// No need to call VerifyAccount() here since the above calls go above and beyond that method.</span>

        <span class="keywordflow">else</span>
        {
            <span class="comment">// In this case we need to process the transaction items from the ledger</span>
            <span class="comment">// and create a corresponding transaction where each of the new items</span>
            <span class="comment">// contains the answer to the transaction item sent.</span>
            <span class="comment">// Then we send that new &quot;response ledger&quot; back to the user in MsgOut.Payload</span>
            <span class="comment">// as an @processInbox message.</span>

            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction    = theLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>);

            <span class="keywordflow">if</span> (NULL == pTransaction) <span class="comment">// I&#39;m assuming there&#39;s only one in the ledger (for now anyways..)</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Expected processInbox transaction in OTServer::UserCmdProcessInbox\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {
                <span class="keyword">const</span> int64_t lTransactionNumber = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

                <span class="comment">// ---------------------------</span>
                <span class="comment">// We create a transaction response and add that to the response ledger...</span>
                <span class="comment">//</span>
                pTranResponse =
                    <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pResponseLedger, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>, lTransactionNumber);
                <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTranResponse, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox: NULL != pTranResponse&quot;</span>);

                <span class="comment">// Add the response transaction to the response ledger.</span>
                <span class="comment">// That will go into the response message and be sent back to the client.</span>
                pResponseLedger-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTranResponse);

                <span class="comment">//---------------------------------------------------</span>
                <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">VerifyTransactionNumber</a>(theNym, lTransactionNumber))
                {
                    <span class="comment">// The user may not submit a transaction using a number he&#39;s already used before.</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox: Error verifying transaction num %ld for Nym %s\n&quot;</span>,
                                   lTransactionNumber, msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                }

                <span class="comment">// The items&#39; acct and server ID were already checked in VerifyContractID() when they were loaded.</span>
                <span class="comment">// Now this checks a little deeper, to verify ownership, signatures, and transaction number</span>
                <span class="comment">// on each item.  That way those things don&#39;t have to be checked for security over and over</span>
                <span class="comment">// again in the subsequent calls.</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a196bf845f57deaf4e04493e462fd6d97">VerifyItems</a>(theNym))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error verifying transaction items OTServer::UserCmdProcessInbox\n&quot;</span>);
                }

                <span class="comment">// any other security stuff?</span>
                <span class="comment">// Todo do I need to verify the server ID here as well?</span>
                <span class="keywordflow">else</span>
                {
                    <span class="comment">// We don&#39;t want any transaction number being used twice.</span>
                    <span class="comment">// (The number, at this point, is STILL issued to the user, who is still responsible</span>
                    <span class="comment">// for that number and must continue signing for it. All this means here is that the</span>
                    <span class="comment">// user no longer has the number on his AVAILABLE list. Removal from issued list happens separately.)</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ad0d2bc78b1059086d78e7f6d5aa1a874" title="Remove a transaction number from the Nym record once it&#39;s officially used/spent.">RemoveTransactionNumber</a>(theNym, lTransactionNumber, <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error removing transaction number (as available) from user nym in OTServer::UserCmdProcessInbox\n&quot;</span>);
                    }

                    <span class="comment">// -------------------------------------------------------------------</span>

                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;UserCmdProcessInbox type: Process Inbox\n&quot;</span>);

                        <a class="code" href="class_o_t_server.html#ae8313723858633f63bbdeec9a1d6e1f1">NotarizeProcessInbox</a>(theNym, theAccount, *pTransaction, *pTranResponse, bTransSuccess);
                        <span class="comment">// ------------------------------------------</span>
                        <span class="comment">// Where appropriate, remove a transaction number from my issued list</span>
                        <span class="comment">// (the list of numbers I must sign for in every balance agreement.)</span>

                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_server.html#ab7d81feacfb032dd09b7714f77c3ecba" title="Remove an issued number from the Nym record once that nym accepts the receipt from his inbox...">RemoveIssuedNumber</a>(theNym, lTransactionNumber, <span class="keyword">true</span>)) <span class="comment">//bSave=true</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym.\n&quot;</span>, __FUNCTION__);
                        }
                    }
                }
            } <span class="comment">// if pTransaction not NULL</span>

            <span class="comment">// DONE: should consider saving a copy of the response ledger here on the server.</span>
            <span class="comment">// Until the user signs off of the responses, maybe the user didn&#39;t receive them.</span>
            <span class="comment">// The server should be able to re-send them until confirmation, then delete them.</span>
            <span class="comment">// So might want to consider a SAVE TO FILE here of that ledger we&#39;re sending out...</span>
            <span class="comment">// UPDATE this is done now: notices go to the Nymbox.</span>
        }
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading ledger from message in OTServer::UserCmdProcessInbox\n&quot;</span>);
    }
    <span class="comment">// ----------------------------------------</span>

send_message:


    <span class="keywordflow">if</span> (NULL == pTranResponse)
    {
        pTranResponse =
            <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pResponseLedger, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>, 0);
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTranResponse, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox 2: NULL != pTranResponse&quot;</span>);

        <span class="comment">// Add the response transaction to the response ledger.</span>
        <span class="comment">// That will go into the response message and be sent back to the client.</span>
        pResponseLedger-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTranResponse);
    }

    <span class="comment">// sign the outoing transaction</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTranResponse, <span class="stringliteral">&quot;OTServer::UserCmdProcessInbox 3: NULL != pTranResponse&quot;</span>);

    pTranResponse-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    pTranResponse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pTranResponse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();   <span class="comment">// don&#39;t forget to save (to internal raw file member)</span>

    <span class="comment">// sign the ledger</span>
    pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// extract the ledger in ascii-armored form</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pResponseLedger);
    <span class="comment">// now the outgoing message has the response ledger in its payload.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);

    <span class="comment">// todo: consider commenting this out since the transaction reply items already include a copy</span>
    <span class="comment">// of the original client communication that the server is responding to. No point beating a</span>
    <span class="comment">// dead horse.</span>
    <span class="comment">//</span>
    <span class="comment">// Send the user&#39;s command back to him as well.</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// UPDATE NYMBOX HASH IN OUTGOING MESSAGE</span>
    <span class="comment">//</span>
    <span class="comment">// We already grabbed the server&#39;s NymboxHash near the top of this function,</span>
    <span class="comment">// and attached it to the outgoing reply message.</span>
    <span class="comment">//</span>
    <span class="comment">// However, the above block may have CHANGED this hash! Therefore, we grab it</span>
    <span class="comment">// AGAIN, just in case. This way a failed message will receive the old hash,</span>
    <span class="comment">// and a successful message will receive the new hash.</span>
    <span class="comment">//</span>
    bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);
    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------</span>

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

    <span class="comment">// (You are in UserCmdProcessInbox.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum, <span class="comment">// We don&#39;t want to update the Nym&#39;s copy here in processInbox (I don&#39;t think.)</span>
                                      bTransSuccess);
<span class="comment">//      this-&gt;DropReplyNoticeToNymbox(SERVER_ID, USER_ID, strReplyMessage, lReqNum, bTransSuccess, &amp;theNym);</span>
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4c00992f16de5ef6f69fe6dfcf5556a9"></a><!-- doxytag: member="OTServer::UserCmdProcessNymbox" ref="a4c00992f16de5ef6f69fe6dfcf5556a9" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a4c00992f16de5ef6f69fe6dfcf5556a9">OTServer::UserCmdProcessNymbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l11427">11427</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@processNymbox&quot;</span>; <span class="comment">// reply to processNymbox</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  USER_ID(msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>),
                        SERVER_ID(m_strServerID),
                        SERVER_USER_ID(m_nymServer);

    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, USER_ID, SERVER_ID);    <span class="comment">// These are ledgers used as messages. The one we received</span>
                                                        <span class="comment">// and the one we&#39;re sending back.</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pResponseLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(SERVER_USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>, <span class="keyword">false</span>); <span class="comment">// bCreateFile=false</span>
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRespLedgerGuardian(pResponseLedger);

    <span class="comment">// Grab the string (containing the request ledger) out of ascii-armored form.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strLedger(MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

    <span class="keywordtype">bool</span> bTransSuccess = <span class="keyword">false</span>;

    <span class="comment">// --------------------------</span>
    <span class="keyword">const</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theMsgNymboxHash(MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);    <span class="comment">// theMsgNymboxHash is the hash sent by the client side</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theSrvrNymboxHash;

    <span class="keywordtype">bool</span> bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="keywordflow">else</span> {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,<span class="stringliteral">&quot;%s: We cannot obtain server side nymbox hash, will continue.\n&quot;</span>,__FUNCTION__);
    }

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNymboxHashClientSide = MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();

    <span class="keywordflow">if</span> (!bGotNymboxHashClientSide) {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: We don&#39;t have a client side nymbox hash, will continue\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide &amp;&amp; bGotNymboxHashClientSide)
        <span class="keywordflow">if</span> (theMsgNymboxHash != theSrvrNymboxHash) {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The server and client nymbox hashes missmatch! rejecting message.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">goto</span> send_message;
        }


    <span class="comment">// theLedger contains a single transaction from the client, with an item inside</span>
    <span class="comment">// for each inbox transaction the client wants to accept or reject.</span>
    <span class="comment">// Let&#39;s see if we can load it from the string that came in the message...</span>
    <span class="comment">//</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = theLedger.LoadContractFromString(strLedger);
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>) <span class="comment">// Yes, that is an assignment operator.</span>
    {
        <span class="comment">// In this case we need to process the transaction items from the ledger</span>
        <span class="comment">// and create a corresponding transaction where each of the new items</span>
        <span class="comment">// contains the answer to the transaction item sent.</span>
        <span class="comment">// Then we send that new &quot;response ledger&quot; back to the user in MsgOut.Payload</span>
        <span class="comment">// as an @processNymbox message.</span>

        <span class="keywordflow">if</span> (theLedger.GetTransactionCount() == 0)
        {
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTranResponse =
                <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pResponseLedger,
                                               <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>,
                                               0);
            pTranResponse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
            pTranResponse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            <span class="comment">// Add the response transaction to the response ledger.</span>
            <span class="comment">// That will go into the response message and be sent back to the client.</span>
            pResponseLedger-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTranResponse);
        }
        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theLedger.GetTransactionMap())
        {
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTransaction, <span class="stringliteral">&quot;NULL transaction pointer in OTServer::UserCmdProcessNymbox\n&quot;</span>);

            <span class="comment">// for each transaction in the ledger, we create a transaction response and add</span>
            <span class="comment">// that to the response ledger.</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTranResponse =
                <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pResponseLedger,
                                                   <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>,
                                                   pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

            <span class="comment">// Add the response transaction to the response ledger.</span>
            <span class="comment">// That will go into the response message and be sent back to the client.</span>
            pResponseLedger-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTranResponse);

            <span class="comment">// Now let&#39;s make sure the response transaction has a copy of the transaction</span>
            <span class="comment">// it is responding to.</span>
            <span class="comment">//</span>
<span class="comment">//          OTString strResponseTo;</span>
<span class="comment">//          pTransaction-&gt;SaveContract(strResponseTo);</span>
<span class="comment">//          pTranResponse-&gt;m_ascInReferenceTo.SetString(strResponseTo);</span>
            <span class="comment">//</span>
            <span class="comment">// I commented out the above because we are keeping too many copies.</span>
            <span class="comment">// Message contains a copy of the message it&#39;s responding to.</span>
            <span class="comment">// Then each transaction contains a copy of the transaction responding to...</span>
            <span class="comment">// Then each ITEM in each transaction contains a copy of each item it&#39;s responding to.</span>
            <span class="comment">//</span>
            <span class="comment">// Therefore, for the &quot;processNymbox&quot; message, I have decided (for now) to have</span>
            <span class="comment">// the extra copy in the items themselves, and in the overall message, but not in the</span>
            <span class="comment">// transactions. Thus, the above is commented out.</span>


            <span class="comment">// It should always return something. Success, or failure, that goes into pTranResponse.</span>
            <span class="comment">// I don&#39;t think there&#39;s need for more return value than that. The user has gotten deep</span>
            <span class="comment">// enough that they deserve SOME sort of response.</span>
            <span class="comment">//</span>
            <span class="comment">// This function also SIGNS the transaction, so there is no need to sign it after this.</span>
            <span class="comment">// There&#39;s also no point to change it after this, unless you plan to sign it twice.</span>
            <a class="code" href="class_o_t_server.html#a965049d4360936cd4930d361ca0d5c41">NotarizeProcessNymbox</a>(theNym, *pTransaction, *pTranResponse, bTransSuccess);

            pTranResponse = NULL; <span class="comment">// at this point, the ledger now &quot;owns&quot; the response, and will handle deleting it.</span>
        }

        <span class="comment">// DONE (Notices go to Nymbox now): should consider saving a copy of the response</span>
        <span class="comment">// ledger here on the server.</span>
        <span class="comment">// Until the user signs off of the responses, maybe the user didn&#39;t receive them.</span>
        <span class="comment">// The server should be able to re-send them until confirmation, then delete them.</span>
        <span class="comment">// So might want to consider a SAVE TO FILE here of that ledger we&#39;re sending out...</span>
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading ledger from message in OTServer::UserCmdProcessNymbox\n&quot;</span>);
    }

send_message:

    <span class="comment">// sign the ledger</span>
    pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(m_nymServer);
    pResponseLedger-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
    <span class="comment">// extract the ledger in ascii-armored form</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strPayload(*pResponseLedger);
    <span class="comment">// now the outgoing message has the response ledger in its payload.</span>
    msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPayload);

    <span class="comment">// todo: consider commenting this out since the transaction reply items already include a copy</span>
    <span class="comment">// of the original client communication that the server is responding to. No point beating a</span>
    <span class="comment">// dead horse.</span>
    <span class="comment">//</span>
    <span class="comment">// Send the user&#39;s command back to him as well.</span>
    {
        <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn);
        msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage);
    }

    <span class="comment">// -------------------------------------------------------</span>
    <span class="comment">// UPDATE NYMBOX HASH IN OUTGOING MESSAGE</span>
    <span class="comment">//</span>
    <span class="comment">// We already grabbed the server&#39;s NymboxHash near the top of this function,</span>
    <span class="comment">// and attached it to the outgoing reply message.</span>
    <span class="comment">//</span>
    <span class="comment">// However, the above block may have CHANGED this hash! Therefore, we grab it</span>
    <span class="comment">// AGAIN, just in case. This way a failed message will receive the old hash,</span>
    <span class="comment">// and a successful message will receive the new hash.</span>
    <span class="comment">//</span>
    bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);
    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------</span>

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();


    <span class="comment">// (You are in UserCmdProcessNymbox.)</span>

    <span class="comment">// *************************************************************</span>
    <span class="comment">// REPLY NOTICE TO NYMBOX</span>
    <span class="comment">//</span>
    <span class="comment">// Now that we signed / saved the reply message...</span>
    <span class="comment">//</span>
    <span class="comment">// After specific messages, we drop a notice with a copy of the server&#39;s reply</span>
    <span class="comment">// into the Nymbox.  This way we are GUARANTEED that the Nym will receive and process</span>
    <span class="comment">// it. (And thus never get out of sync.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>)
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReplyMessage(msgOut);
        <span class="keyword">const</span> int64_t lReqNum = atol(MsgIn.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// If it fails, it logs already.</span>
        this-&gt;<a class="code" href="class_o_t_server.html#a5a678422af4b38d615adc593c8310ffb">DropReplyNoticeToNymbox</a>(SERVER_ID, USER_ID, strReplyMessage, lReqNum,    <span class="comment">// (We don&#39;t want to update the NymboxHash on the Nym, here in processNymbox, at least, not at this current point AFTER the reply message has already been signed.)</span>
                                      bTransSuccess);
<span class="comment">//      this-&gt;DropReplyNoticeToNymbox(SERVER_ID, USER_ID, strReplyMessage, lReqNum, bTransSuccess, &amp;theNym); // Only pass theNym if you want it to contain the LATEST hash. (Some messages don&#39;t.)</span>
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae7877e32c7ebfdf4abcecfb7d9494269"></a><!-- doxytag: member="OTServer::UserCmdQueryAssetTypes" ref="ae7877e32c7ebfdf4abcecfb7d9494269" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#ae7877e32c7ebfdf4abcecfb7d9494269">OTServer::UserCmdQueryAssetTypes</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10548">10548</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@queryAssetTypes&quot;</span>;   <span class="comment">// reply to queryAssetTypes</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;     <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>       = <span class="keyword">false</span>;                <span class="comment">// so far.</span>

    <span class="comment">// Send the user&#39;s command back to him whether success or failure.</span>
    <a class="code" href="class_o_t_string.html">OTString</a> tempInMessage(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(tempInMessage); <span class="comment">// Set it into the base64-encoded object on the outgoing message</span>

    <span class="keywordflow">if</span> (MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// (which it should)</span>
    {
        <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, MsgIn.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
        <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);

        <span class="keywordflow">if</span> (NULL != pMap) <span class="comment">// There was definitely a StringMap in the payload.</span>
        {
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;

            std::map&lt;std::string, std::string&gt; &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
            std::map&lt;std::string, std::string&gt; theNewMap;

            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>, theMap)
            {
                <span class="keyword">const</span> std::string &amp; str1 = (*it).first; <span class="comment">// Containing the asset type ID.</span>
                <span class="keyword">const</span> std::string &amp; str2 = (*it).second;    <span class="comment">// Containing the phrase &quot;exists&quot;. (More are possible in the future.)</span>
                <span class="comment">// --------------------------------</span>

                <span class="comment">// todo security: limit on length of this map? (sent through user message...)</span>

                <span class="comment">// &quot;exists&quot; means, &quot;Here&#39;s an asset ID. Please tell me</span>
                <span class="comment">// whether or not it&#39;s actually issued on this server.&quot;</span>
                <span class="comment">// Future options might include &quot;issue&quot;, &quot;audit&quot;, &quot;contract&quot;,</span>
                <span class="comment">// etc.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> ((str1.size() &gt; 0) &amp;&amp; (str2.compare(<span class="stringliteral">&quot;exists&quot;</span>) == 0)) <span class="comment">// todo hardcoding</span>
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetID(str1.c_str());
                    <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pAssetContract = <a class="code" href="class_o_t_server.html#a2f39cc0d6b8ab27de71fc8a68f00914c">GetAssetContract</a>(theAssetID);
                    <span class="comment">// -----------------------------------</span>
                    <span class="keywordflow">if</span> (NULL != pAssetContract) <span class="comment">// Yes, it exists.</span>
                        theNewMap[str1] = <span class="stringliteral">&quot;true&quot;</span>;
                    <span class="keywordflow">else</span>
                        theNewMap[str1] = <span class="stringliteral">&quot;false&quot;</span>;
                }
            } <span class="comment">// FOR_EACH</span>

            <span class="comment">// Replace contents of old map with contents of new map.</span>
            <span class="comment">//</span>
            theMap.clear();
            theMap = theNewMap;
            <span class="comment">// -----------------------------</span>
            <span class="comment">// Serialize the StringMap back to a string...</span>

            std::string str_Encoded = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);

            <span class="keywordflow">if</span> (str_Encoded.size() &gt; 0)
                msgOut.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a> = str_Encoded.c_str();  <span class="comment">// now the outgoing message has the response map in its payload, in base64 form.</span>
            <span class="keywordflow">else</span>
                msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>; <span class="comment">// Something went wrong.</span>
        } <span class="comment">// if pMap exists.</span>
    }
    <span class="keywordflow">else</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }

    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="aad4515adb7c48a0d4b30140de99c727b"></a><!-- doxytag: member="OTServer::UserCmdSendUserInstrument" ref="aad4515adb7c48a0d4b30140de99c727b" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#aad4515adb7c48a0d4b30140de99c727b">OTServer::UserCmdSendUserInstrument</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02661">2661</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@sendUserInstrument&quot;</span>;    <span class="comment">// reply to sendUserInstrument</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;         <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;        <span class="comment">// UserID of recipient pubkey</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;            // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      strInMessage(MsgIn);
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SENDER_USER_ID(theNym),
                        RECIPIENT_USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>),
                        SERVER_ID(m_strServerID);
    msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInMessage);
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSent = this-&gt;<a class="code" href="class_o_t_server.html#ab500513963b83465cf5402d7b9809870">SendInstrumentToNym</a>(SERVER_ID, SENDER_USER_ID, RECIPIENT_USER_ID, &amp;MsgIn); <span class="comment">// pPayment=NULL, szCommand=NULL</span>

    <span class="keywordflow">if</span> (!bSent)
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdSendUserInstrument: Failed while calling SendInstrumentToNym.\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;
    }
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8e8879f4902244d2e55debee8ee335a6"></a><!-- doxytag: member="OTServer::UserCmdSendUserMessage" ref="a8e8879f4902244d2e55debee8ee335a6" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a8e8879f4902244d2e55debee8ee335a6">OTServer::UserCmdSendUserMessage</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l02624">2624</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@sendUserMessage&quot;</span>;   <span class="comment">// reply to sendUserMessage</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;         <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;        <span class="comment">// UserID of recipient pubkey</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;            // This is already set in ProcessUserCommand.</span>

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      strInMessage(MsgIn);
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SENDER_USER_ID(theNym),
                        RECIPIENT_USER_ID(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>),
                        SERVER_ID(m_strServerID);
    msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInMessage);
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSent = this-&gt;<a class="code" href="class_o_t_server.html#a3314039ea12808bf8d3bce6c251d7e8f">SendMessageToNym</a>(SERVER_ID, SENDER_USER_ID, RECIPIENT_USER_ID, &amp;MsgIn); <span class="comment">// pstrMessage=NULL</span>

    <span class="keywordflow">if</span> (!bSent)
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTServer::UserCmdSendUserMessage: Failed while calling SendMessageToNym.\n&quot;</span>);
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span>
    {
        msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>;
    }
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a45d6cb87281eca8c86b51926dd87c2e1"></a><!-- doxytag: member="OTServer::UserCmdTriggerClause" ref="a45d6cb87281eca8c86b51926dd87c2e1" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a45d6cb87281eca8c86b51926dd87c2e1">OTServer::UserCmdTriggerClause</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l10677">10677</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_string.html">OTString</a> strInReferenceTo(MsgIn); <span class="comment">// Grab the incoming message in plaintext form</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInReferenceTo);
    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@triggerClause&quot;</span>; <span class="comment">// reply to triggerClause</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>       = <span class="keyword">false</span>;            <span class="comment">// Default value.</span>
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keyword">const</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  SERVER_ID(m_strServerID),
                  theMsgNymboxHash(MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>); <span class="comment">// theMsgNymboxHash is the hash sent by the client side</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theSrvrNymboxHash;

    <span class="keywordtype">bool</span> bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);
    <span class="keyword">const</span>
    <span class="keywordtype">bool</span> bGotNymboxHashClientSide = MsgIn.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (
        (bGotNymboxHashServerSide &amp;&amp; bGotNymboxHashClientSide &amp;&amp; (theMsgNymboxHash != theSrvrNymboxHash))
        ||
        (bGotNymboxHashServerSide &amp;&amp; !bGotNymboxHashClientSide)
        )
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Rejecting message since nymbox hash doesn&#39;t match. &quot;</span>
                       <span class="stringliteral">&quot;(Send a getNymbox message to grab the newest one.)\n&quot;</span>,
                       __FUNCTION__);
    }
    <span class="comment">// ------------------------------------------------------------</span>
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmartContract = NULL;
        <span class="comment">// ---------------------------------------------</span>
        <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = m_Cron.<a class="code" href="class_o_t_cron.html#ab732ac1263aac936d8d948df3412119b">GetItemByValidOpeningNum</a>(MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);

        <span class="keywordflow">if</span> (NULL == pCronItem)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Couldn&#39;t find smart contract based on transaction #: %ld \n&quot;</span>,
                           __FUNCTION__, MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);
        }
        <span class="comment">// -----------------------------------------</span>
        <span class="comment">// Also: CAN this guy trigger it?</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == (pSmartContract = dynamic_cast&lt;OTSmartContract *&gt; (pCronItem)))
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Found cron item %ld based on %ld, but it wasn&#39;t a &quot;</span>
                           <span class="stringliteral">&quot;smart contract. \n&quot;</span>, __FUNCTION__, pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(),
                           MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);
        }
        <span class="comment">// -----------------------------------------</span>
        <span class="keywordflow">else</span>
        {
            <span class="comment">// FIND THE PARTY / PARTY NAME</span>
            <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent = NULL;
            <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pSmartContract-&gt;<a class="code" href="class_o_t_scriptable.html#aa89029542587094cd2844cb8bf7a9a16">FindPartyBasedOnNymAsAgent</a>(theNym, &amp;pAgent);

            <span class="keywordflow">if</span> (NULL == pParty)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find party to this contract (%ld based on %ld) &quot;</span>
                               <span class="stringliteral">&quot;based on Nym as agent: %s&quot;</span>, __FUNCTION__, pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(),
                               MsgIn.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>, MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span>
            {
                <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
                <span class="keyword">const</span> std::string str_clause_name = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();

                <span class="keywordflow">if</span> (pSmartContract-&gt;<a class="code" href="class_o_t_scriptable.html#ae2046f1b62828d26dda822eaa6a194b6">CanExecuteClause</a>(pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>(), str_clause_name)) <span class="comment">// This calls (if available) the scripted clause: bool party_may_execute_clause(party_name, clause_name)</span>
                {
                    <span class="comment">// *****************************************************************************</span>
                    <span class="comment">//</span>
                    <span class="comment">// Execute the clause.</span>
                    <span class="comment">//</span>
                    <a class="code" href="_o_t_clause_8hpp.html#a40c16432fa9c16826c026b74351425ad">mapOfClauses</a> theMatchingClauses;
                    <a class="code" href="class_o_t_clause.html">OTClause</a> * pClause = pSmartContract-&gt;<a class="code" href="class_o_t_scriptable.html#abe36809472a1b7adf66b303ea176888e">GetClause</a>(str_clause_name);

                    <span class="keywordflow">if</span> (NULL != pClause)
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: At party request, processing smart contract clause: %s \n&quot;</span>,
                                       __FUNCTION__, str_clause_name.c_str());

                        theMatchingClauses.insert(std::pair&lt;std::string, OTClause*&gt;(str_clause_name, pClause));

                        pSmartContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a83282de7074313974d0db0f50b3b6e09">ExecuteClauses</a>(theMatchingClauses); <span class="comment">// &lt;============================================</span>

                        <span class="keywordflow">if</span> (pSmartContract-&gt;<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>())
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removing smart contract from cron processing: %ld\n&quot;</span>,
                                           __FUNCTION__, pSmartContract-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                        }
                        bSuccess = <span class="keyword">true</span>;
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed attempt to process clause (%s) on smart contract: %ld \n&quot;</span>,
                                       __FUNCTION__, str_clause_name.c_str(), pSmartContract-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                    }
                }
                <span class="comment">// *****************************************************************************</span>

                <span class="comment">// If we just removed the smart contract from cron, that means a finalReceipt was just dropped</span>
                <span class="comment">// into the inboxes for the relevant asset accounts. Once I process that receipt out of my</span>
                <span class="comment">// inbox, (which will require my processing out all related marketReceipts) then the closing</span>
                <span class="comment">// number will be removed from my list of responsibility.</span>

                <span class="keywordflow">if</span> (bSuccess)
                {
                    <span class="comment">// Now we can set the response item as an acknowledgement instead of the default (rejection)</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Party (%s) successfully triggered clause: %s.\n&quot;</span>,
                                   __FUNCTION__, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str(), str_clause_name.c_str());

                    msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> =  <span class="keyword">true</span>;
                }
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s:  Unable to trigger clause %s at request of party %s. &quot;</span>
                                   <span class="stringliteral">&quot;(Either the permission wasn&#39;t there, or the clause wasn&#39;t found.)\n&quot;</span>,
                                   __FUNCTION__, str_clause_name.c_str(), pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
            } <span class="comment">// pParty != NULL</span>
        } <span class="comment">// else found smart contract.</span>
    } <span class="comment">// NymboxHash matches.</span>
    <span class="comment">// -------------------------------------------------</span>
    bGotNymboxHashServerSide = theNym.<a class="code" href="class_o_t_pseudonym.html#ac9c61ecf8fe65ec5b862021bd063422a">GetNymboxHashServerSide</a>(SERVER_ID, theSrvrNymboxHash);

    <span class="keywordflow">if</span> (bGotNymboxHashServerSide)  <span class="comment">// theSrvrNymboxHash is the hash stored on the server side</span>
        theSrvrNymboxHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(msgOut.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>((<span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)m_nymServer); <span class="comment">// todo change this cast.</span>

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a26de1a410e0281e6a19caa28db7a1c39"></a><!-- doxytag: member="OTServer::UserCmdUsageCredits" ref="a26de1a410e0281e6a19caa28db7a1c39" args="(OTPseudonym &amp;theNym, OTMessage &amp;MsgIn, OTMessage &amp;msgOut)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server.html#a26de1a410e0281e6a19caa28db7a1c39">OTServer::UserCmdUsageCredits</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>MsgIn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>msgOut</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l03060">3060</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// (1) set up member variables</span>
    msgOut.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>     = <span class="stringliteral">&quot;@usageCredits&quot;</span>;  <span class="comment">// reply to usageCredits</span>
    msgOut.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>       = MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>; <span class="comment">// UserID</span>
    msgOut.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>      = MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>;<span class="comment">// UserID of user whose usage credits are being examined / adjusted.</span>
<span class="comment">//  msgOut.m_strServerID    = m_strServerID;    // This is already set in ProcessUserCommand.</span>
    <span class="comment">// -----------------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsPrivilegedNym = ((<a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().size() &gt; 0) &amp;&amp; <span class="comment">// And if there&#39;s an override Nym...</span>
                                   (0 == <a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().compare((MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())))); <span class="comment">// And if the acting Nym IS the override Nym...</span>
    <span class="comment">// -----------------------------------</span>
    <span class="comment">// The amount the usage credits are being ADJUSTED by.</span>
    <span class="keyword">const</span> int64_t lAdjustment  = (bIsPrivilegedNym &amp;&amp; OTServer::__admin_usage_credits) ? MsgIn.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> : 0;

    msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> = 0; <span class="comment">// Returns total Usage Credits on Nym at the end.</span>
    <span class="comment">// -----------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> nym2;
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> nym2ID, SERVER_ID(m_strServerID);
    nym2.SetIdentifier(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>);
    nym2.GetIdentifier(nym2ID);

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsSameNym   = nym2.CompareID(theNym);
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym      = NULL;

    <span class="keywordtype">bool</span> bErrorCondition        = <span class="keyword">false</span>;
    <span class="keywordtype">bool</span> bHaveToCreateNymfile   = <span class="keyword">false</span>;

    <span class="comment">// If nym2 and theNym are already the same Nym, then pNym points to theNym by now already.</span>
    <span class="comment">// (And we&#39;ll skip this block.) Otherwise we load up nym2, and point pNym to nym2 instead.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (bIsSameNym)
        pNym = &amp;theNym;
    <span class="keywordflow">else</span> <span class="comment">// theNym and nym2 are different Nyms, so let&#39;s load it up.</span>
    {
        <span class="keywordtype">bool</span> bLoadedPublicKey   = nym2.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>() &amp;&amp; nym2.VerifyPseudonym(); <span class="comment">// Old style (deprecated.) For now, this calls LoadCredentials inside (which is the new style.) Eventually we&#39;ll just call that here directly.</span>
        <span class="keywordtype">bool</span> bLoadSignedNymfile = nym2.LoadSignedNymfile(m_nymServer);
        <span class="comment">// -----------------</span>
        <span class="keywordflow">if</span> (!bLoadSignedNymfile &amp;&amp; !bLoadedPublicKey) <span class="comment">// Nym didn&#39;t already exist.</span>
        {
            pNym = &amp;nym2;
            bHaveToCreateNymfile = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bLoadedPublicKey &amp;&amp; !bLoadSignedNymfile) <span class="comment">// Error -- if key was there, then nymfile should have been also.</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Nym public key (%s) exists, but nymfile doesn&#39;t! &quot;</span>
                         <span class="stringliteral">&quot;Could be error reading from storage. (Failure.)\n&quot;</span>, __FUNCTION__,
                          MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            bErrorCondition = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span>
        {
            pNym = &amp;nym2;
        }
    }
    <span class="comment">// -----------------------------------</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(MsgIn.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>)) <span class="comment">// If the Nym is not performing this on himself...</span>
    {
        <span class="comment">// Either this is a Nym performing the action on himself (which is read-only.)</span>
        <span class="comment">// Or he is the &quot;override Nym&quot; (special powers) and he is allowed to do it on anybody (adjusting the credits up or down.)</span>
        <span class="comment">// But if he&#39;s NOT the override Nym, then he can NOT do it, even read-only, on anyone OTHER than himself.</span>
        <span class="comment">//</span>
        <span class="comment">// Inside this block, we&#39;ve said, &quot;If the Nym is NOT doing this on himself... (But on someone else)&quot;</span>
        <span class="comment">// ...Then we KNOW, if that&#39;s true, that the Nym had BETTER have special powers, or there&#39;s an error.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((<a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().size() &gt; 0) &amp;&amp;
                      (0 == <a class="code" href="class_o_t_server.html#a1cf188f4a50e9dff3f8ee97807ed505a">OTServer::GetOverrideNymID</a>().compare((MsgIn.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))))) <span class="comment">// ...And if he&#39;s not the special &quot;override Nym&quot;...</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed attempt by a normal Nym to view or adjust usage credits on a different Nym (you&#39;re only allowed to do this to yourself, unless your nym is the specially-empowered &#39;override nym&#39;.)\n&quot;</span>, __FUNCTION__);
            bErrorCondition = <span class="keyword">true</span>;
        }
    }
    <span class="comment">// -----------------------------------------------------</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(nym2ID, nym2ID, SERVER_ID);
    <span class="comment">// ------------------------------------</span>
    <span class="keywordtype">bool</span> bSuccessLoadingNymbox  = theNymbox.LoadNymbox();

    <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
        bSuccessLoadingNymbox   = (theNymbox.VerifyContractID() &amp;&amp; theNymbox.VerifyAccount(m_nymServer));
    <span class="keywordflow">else</span>
    {
        bSuccessLoadingNymbox   = theNymbox.GenerateLedger(nym2ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>

        <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
        {
            bSuccessLoadingNymbox   = theNymbox.SignContract(m_nymServer);

            <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
            {
                bSuccessLoadingNymbox = theNymbox.SaveContract();

                <span class="keywordflow">if</span> (bSuccessLoadingNymbox)
                    bSuccessLoadingNymbox   = theNymbox.SaveNymbox();
            }
        }
    }
    <span class="comment">// -----------------------------------------------------</span>
    <span class="keywordflow">if</span> (!bSuccessLoadingNymbox)
        bErrorCondition = <span class="keyword">true</span>;
    <span class="comment">// -----------------------------------------------------</span>
    <span class="comment">// By this point, pNym points to the correct Nym, if bErrorCondition=false;</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (!bErrorCondition)
    {
        <span class="comment">// Get the current usage credits, which will be sent in the reply.</span>
        <span class="comment">//</span>
        <span class="keyword">const</span> int64_t &amp; lOldCredits   = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a4469f9108d8239b72e6ebc6bc5b2b4a9">GetUsageCredits</a>();
        <span class="keyword">const</span> int64_t      lTentativeNew = lOldCredits + lAdjustment;
        <span class="keyword">const</span> int64_t       lNewCredits   = (lTentativeNew &lt; 0) ? (-1) : lTentativeNew; <span class="comment">// It can never be less than -1.</span>

        <span class="comment">// if adjustment is non-zero, and the acting Nym has authority to make adjustments...</span>
<span class="comment">//         if ((0 != lAdjustment) &amp;&amp; bIsPrivilegedNym)</span>
        <span class="comment">//</span>
        <span class="comment">// Note: if the adjustment is non-zero, then we ALREADY know the acting Nym has the authority.</span>
        <span class="comment">// How do we know?</span>
        <span class="comment">//</span>
        <span class="comment">// int64_t lAdjustment  = (bIsPrivilegedNym &amp;&amp; OTServer::__admin_usage_credits) ? MsgIn.m_lDepth : 0;</span>
        <span class="comment">//</span>
        <span class="comment">// (Therefore we also know that the server is in usage credits mode, as well.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (0 != lAdjustment)
        {
            <span class="comment">// Only the override Nym can get inside this block and set the credits.</span>
            <span class="comment">// And ONLY in the case where usage credits are turned on, on the server side.</span>
            <span class="comment">// Any other Nym can use UsageCredits message but as read-only, to retrieve</span>
            <span class="comment">// the value, not to actually set it. In that case, the adjustment is always</span>
            <span class="comment">// interpreted as &quot;0&quot;, and the return value usage credits is always set to -1.</span>
            <span class="comment">//</span>
            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#afdd9f22128599dc00dbec2d5fb4ad43d">SetUsageCredits</a>(lNewCredits);
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(m_nymServer); <span class="comment">// We changed it, so let&#39;s save pNym...</span>
        }
        <span class="keywordflow">else</span>
            msgOut.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">true</span>; <span class="comment">// No adjustment -- we&#39;re just returning the current usage credits or -1, depending on whether server is in usage mode.</span>
        <span class="comment">//</span>
        <span class="comment">// This is because we always return credits of -1 in this case, so we don&#39;t want to be secretly</span>
        <span class="comment">// continuing to adjust the credits farther and farther while simultaneously returning -1.</span>
        <span class="comment">// -------------------------------------------------</span>
        <span class="comment">// Either way (even if adjustment is zero) then lNewCredits contains the value being sent back...</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (OTServer::__admin_usage_credits) <span class="comment">// If the server has usage credits turned on...</span>
            msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> = lNewCredits;   <span class="comment">// ...then adjustment or not, we send the current usage credits balance back in the server reply.</span>
        <span class="keywordflow">else</span>                                 <span class="comment">// Else if the server does NOT have usage credits turned on...</span>
            msgOut.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> = -1;            <span class="comment">// ...then we always return -1, so the client doesn&#39;t pop up any error messages related to usage credits.</span>
    }
    <span class="comment">// -----------------------------------------------------</span>
    <span class="comment">// (2) Sign the Message</span>
    msgOut.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(m_nymServer);

    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
    <span class="comment">//</span>
    <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
    <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
    msgOut.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4763bf53853ca87407c23ba152a8ebe4"></a><!-- doxytag: member="OTServer::ValidateServerIDfromUser" ref="a4763bf53853ca87407c23ba152a8ebe4" args="(OTString &amp;strServerID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a4763bf53853ca87407c23ba152a8ebe4">OTServer::ValidateServerIDfromUser</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strServerID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l13603">13603</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">static</span> <span class="keywordtype">bool</span> bFirstTime = <span class="keyword">true</span>;

    <span class="keywordflow">if</span> (bFirstTime)
    {
        bFirstTime=<span class="keyword">false</span>;

        <span class="comment">// This part is now done when the server XML file is first loaded</span>
<span class="comment">//      if (!m_nymServer.Loadx509CertAndPrivateKey())</span>
<span class="comment">//      {</span>
<span class="comment">//          OTLog::Error(&quot;Error loading server certificate and keys.\n&quot;);</span>
<span class="comment">//      }</span>
<span class="comment">//      else {</span>
<span class="comment">//          OTLog::Error(&quot;Success loading server certificate and keys.\n&quot;);</span>
<span class="comment">//      }</span>

        <span class="comment">//TODO..  Notice after calling Loadx509CertAndPrivateKey, I do not call</span>
        <span class="comment">// VerifyPseudonym immediately after, like the client does. That&#39;s because</span>
        <span class="comment">// the client&#39;s ID is a hash of his public key, so that function compares</span>
        <span class="comment">// the two.</span>
        <span class="comment">//</span>
        <span class="comment">// But the server ID is a hash of the SERVER CONTRACT. Which will NOT match</span>
        <span class="comment">// the hash of the server public key.</span>
        <span class="comment">//</span>
        <span class="comment">// Ideally the server will load the contract, and then EXTRACT the public key</span>
        <span class="comment">// from the contract, and then use it to verify the signature on the contract,</span>
        <span class="comment">// and THEN hash the contract, to get the ServerID,</span>

        <span class="comment">// Here&#39;s basically what I need to add:  m_ServerContract</span>
        <span class="comment">//</span>
        <span class="comment">// ServerContract.SetFilename(&quot;server contract file&quot;)</span>
        <span class="comment">// ServerContract.LoadContract()</span>
        <span class="comment">// ServerContract.VerifyContractID()</span>
        <span class="comment">// if (success)</span>
        <span class="comment">//    ServerContract.VerifySignature(m_nymServer);</span>
        <span class="comment">// if (success)</span>
        <span class="comment">//    SUCCESS LOADING SERVER CERTIFICATES AND KEYS.</span>
    }

    <span class="keywordflow">if</span> (m_strServerID == strServerID)
    {
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a47bf0e4e73366e4aeddbd54da9bf2c14"></a><!-- doxytag: member="OTServer::VerifyBasketAccountID" ref="a47bf0e4e73366e4aeddbd54da9bf2c14" args="(const OTIdentifier &amp;BASKET_ACCOUNT_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#a47bf0e4e73366e4aeddbd54da9bf2c14">OTServer::VerifyBasketAccountID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>BASKET_ACCOUNT_ID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Looks up a basket account ID and returns true or false. (So you can confirm whether or not it's on the list.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00366">366</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// Server stores a map of BASKET_ID to BASKET_ACCOUNT_ID. Let&#39;s iterate through that map...</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_server_8hpp.html#a25e6368c39fb959e4cb7b6c2cdef4f40">mapOfBaskets</a>, m_mapBaskets)
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strBasketAcctID    = (*it).second.c_str();

        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> id_BASKET_ACCT(strBasketAcctID);

        <span class="keywordflow">if</span> (BASKET_ACCOUNT_ID == id_BASKET_ACCT) <span class="comment">// if the basket Acct ID passed in matches this one...</span>
        {
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad22e162604c556a0ec7b1d8bfd5fde17"></a><!-- doxytag: member="OTServer::VerifyTransactionNumber" ref="ad22e162604c556a0ec7b1d8bfd5fde17" args="(OTPseudonym &amp;theNym, const int64_t &amp;lTransactionNumber)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server.html#ad22e162604c556a0ec7b1d8bfd5fde17">OTServer::VerifyTransactionNumber</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNumber</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Transaction numbers are now stored in the nym file (on client and server side) for whichever nym they were issued to. This function verifies whether or not the transaction number is present and valid for any specific nym (i.e. for the nym passed in.) </p>

<p>Definition at line <a class="el" href="_o_t_server_8cpp_source.html#l00641">641</a> of file <a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID(theNym), SERVER_NYM_ID(m_nymServer);

    <span class="comment">// If theNym has the same ID as m_nymServer, then we&#39;ll use m_nymServer</span>
    <span class="comment">// instead of theNym.  (Since it&#39;s the same nym anyway, we&#39;ll stick to the</span>
    <span class="comment">// one we already loaded so any changes don&#39;t get overwritten later.)</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = NULL;

    <span class="keywordflow">if</span> (NYM_ID == SERVER_NYM_ID)
        pNym = &amp;m_nymServer;
    <span class="keywordflow">else</span>
        pNym = &amp;theNym;
    <span class="comment">// ---------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a13bbb470e627968c184ef4728ef85d7a">VerifyTransactionNum</a>(m_strServerID, lTransactionNumber))
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    <span class="keywordflow">else</span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(NYM_ID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strIssued(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(m_strServerID, lTransactionNumber) ?
                                 <span class="stringliteral">&quot;(However, that number IS issued to that Nym... He must have already used it.)\n&quot;</span> :
                                 <span class="stringliteral">&quot;(In fact, that number isn&#39;t even issued to that Nym, though perhaps it was at some time in the past?)\n&quot;</span>);

        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %ld not available for Nym %s to use. \n%s&quot;</span>, __FUNCTION__,
<span class="comment">//                    &quot; Oh, and FYI, tangentially, the current Trns# counter is: %ld\n&quot;,</span>
                      lTransactionNumber, strNymID.Get(), strIssued.Get());
<span class="comment">//                    m_lTransactionNumber);</span>
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/ots/<a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a></li>
<li>src/ots/<a class="el" href="_o_t_server_8cpp_source.html">OTServer.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_o_t_server.html">OTServer</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:16 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
