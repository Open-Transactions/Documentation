<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otlib/OTMarket.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_market_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otlib/OTMarket.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_market_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *    </span>
<a name="l00003"></a>00003 <span class="comment"> *  OTMarket.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *  </span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"> </span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"> </span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"> </span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_market_8hpp.html">OTMarket.hpp</a>&gt;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cron_8hpp.html">OTCron.hpp</a>&gt;</span>
<a name="l00138"></a>00138 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_offer_8hpp.html">OTOffer.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_storage_8hpp.html">OTStorage.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_account_8hpp.html">OTAccount.hpp</a>&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_pseudonym_8hpp.html">OTPseudonym.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_ledger_8hpp.html">OTLedger.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_trade_8hpp.html">OTTrade.hpp</a>&gt;</span>
<a name="l00145"></a>00145 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &quot;irrxml/irrXML.hpp&quot;</span>
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="comment">// return -1 if error, 0 if nothing, and 1 if the node was processed.</span>
<a name="l00153"></a><a class="code" href="class_o_t_market.html#a3085a94412fee20ffd116dbfdddf2ecc">00153</a> int32_t <a class="code" href="class_o_t_market.html#a3085a94412fee20ffd116dbfdddf2ecc">OTMarket::ProcessXMLNode</a>(<a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>*&amp; xml)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     int32_t nReturnVal = 0;
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     <span class="comment">// Here we call the parent class first.</span>
<a name="l00158"></a>00158     <span class="comment">// If the node is found there, or there is some error,</span>
<a name="l00159"></a>00159     <span class="comment">// then we just return either way.  But if it comes back</span>
<a name="l00160"></a>00160     <span class="comment">// as &#39;0&#39;, then nothing happened, and we&#39;ll continue executing.</span>
<a name="l00161"></a>00161     <span class="comment">//</span>
<a name="l00162"></a>00162     <span class="comment">// -- Note you can choose not to call the parent if</span>
<a name="l00163"></a>00163     <span class="comment">// you don&#39;t want to use any of those xml tags.</span>
<a name="l00164"></a>00164     <span class="comment">// As I do below, in the case of OTAccount.</span>
<a name="l00165"></a>00165     <span class="comment">//if (nReturnVal = OTContract::ProcessXMLNode(xml))</span>
<a name="l00166"></a>00166     <span class="comment">//  return nReturnVal;</span>
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;market&quot;</span>, xml-&gt;getNodeName())) 
<a name="l00169"></a>00169     {
<a name="l00170"></a>00170         <a class="code" href="class_o_t_contract.html#aa0d889e0e1670b56fedca245041a5ed3">m_strVersion</a>        =       xml-&gt;getAttributeValue(<span class="stringliteral">&quot;version&quot;</span>);
<a name="l00171"></a>00171         m_lScale            = atol( xml-&gt;getAttributeValue(<span class="stringliteral">&quot;marketScale&quot;</span>));
<a name="l00172"></a>00172         m_lLastSalePrice    = atol( xml-&gt;getAttributeValue(<span class="stringliteral">&quot;lastSalePrice&quot;</span>));
<a name="l00173"></a>00173         m_strLastSaleDate   =       xml-&gt;getAttributeValue(<span class="stringliteral">&quot;lastSaleDate&quot;</span>);
<a name="l00174"></a>00174         <span class="comment">// ---------------------------------------------</span>
<a name="l00175"></a>00175         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverID&quot;</span>)),
<a name="l00176"></a>00176                         strAssetTypeID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;assetTypeID&quot;</span>)),
<a name="l00177"></a>00177                         strCurrencyTypeID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;currencyTypeID&quot;</span>));
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         m_SERVER_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strServerID);
<a name="l00180"></a>00180         m_ASSET_TYPE_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strAssetTypeID);
<a name="l00181"></a>00181         m_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strCurrencyTypeID);
<a name="l00182"></a>00182         <span class="comment">// ---------------------------------------------</span>
<a name="l00183"></a>00183         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nMarket. Scale: %lld\n&quot;</span>, 
<a name="l00184"></a>00184                        m_lScale);
<a name="l00185"></a>00185         
<a name="l00186"></a>00186         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,
<a name="l00187"></a>00187                        <span class="stringliteral">&quot; assetTypeID: %s\n&quot;</span>
<a name="l00188"></a>00188                        <span class="stringliteral">&quot; currencyTypeID: %s\n&quot;</span>
<a name="l00189"></a>00189                        <span class="stringliteral">&quot; ServerID: %s\n&quot;</span>,
<a name="l00190"></a>00190                        strAssetTypeID.Get(),  strCurrencyTypeID.Get(), 
<a name="l00191"></a>00191                        strServerID.Get());
<a name="l00192"></a>00192         
<a name="l00193"></a>00193         nReturnVal = 1;
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     <span class="comment">// ---------------------------------------------</span>
<a name="l00196"></a>00196     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;offer&quot;</span>, xml-&gt;getNodeName())) 
<a name="l00197"></a>00197     {
<a name="l00198"></a>00198         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strDateAdded(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;dateAdded&quot;</span>));
<a name="l00199"></a>00199         <span class="keyword">const</span> int64_t    lDateAdded = strDateAdded.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strDateAdded.ToLong() : 0;
<a name="l00200"></a>00200         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     tDateAdded = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(lDateAdded);
<a name="l00201"></a>00201         <span class="comment">// ---------------------------------------------</span>
<a name="l00202"></a>00202         <a class="code" href="class_o_t_string.html">OTString</a> strData;
<a name="l00203"></a>00203         
<a name="l00204"></a>00204         <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, strData) || !strData.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00205"></a>00205         {
<a name="l00206"></a>00206             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error in OTMarket::%s: offer field without value.\n&quot;</span>,
<a name="l00207"></a>00207                           __FUNCTION__);
<a name="l00208"></a>00208             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210         <span class="keywordflow">else</span> 
<a name="l00211"></a>00211         {
<a name="l00212"></a>00212             <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = <span class="keyword">new</span> <a class="code" href="class_o_t_offer.html">OTOffer</a>(m_SERVER_ID, m_ASSET_TYPE_ID, m_CURRENCY_TYPE_ID, m_lScale);
<a name="l00213"></a>00213             
<a name="l00214"></a>00214             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00215"></a>00215             
<a name="l00216"></a>00216             <span class="keywordflow">if</span> (pOffer-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strData) &amp;&amp; 
<a name="l00217"></a>00217                 <a class="code" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">AddOffer</a>(NULL, *pOffer, <span class="keyword">false</span>, tDateAdded)) <span class="comment">// bSaveMarket = false (Don&#39;t SAVE -- we&#39;re loading right now!)</span>
<a name="l00218"></a>00218             {
<a name="l00219"></a>00219                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Successfully loaded offer and added to market.\n&quot;</span>);
<a name="l00220"></a>00220             }
<a name="l00221"></a>00221             <span class="keywordflow">else</span> 
<a name="l00222"></a>00222             {
<a name="l00223"></a>00223                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error adding offer to market while loading market.\n&quot;</span>);
<a name="l00224"></a>00224                 <span class="keyword">delete</span> pOffer;
<a name="l00225"></a>00225                 pOffer = NULL;
<a name="l00226"></a>00226                 <span class="keywordflow">return</span> (-1);
<a name="l00227"></a>00227             }
<a name="l00228"></a>00228         }
<a name="l00229"></a>00229         
<a name="l00230"></a>00230         nReturnVal = 1;
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     <span class="comment">// ---------------------------------------------</span>
<a name="l00233"></a>00233     <span class="keywordflow">return</span> nReturnVal;      
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="class_o_t_market.html#a51c01eeeb4dfd00d941efae50af53384">00237</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a51c01eeeb4dfd00d941efae50af53384">OTMarket::UpdateContents</a>()
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239     <span class="comment">// I release this because I&#39;m about to repopulate it.</span>
<a name="l00240"></a>00240     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l00241"></a>00241     
<a name="l00242"></a>00242     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;?xml version=\&quot;%s\&quot;?&gt;\n\n&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>);
<a name="l00243"></a>00243     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00244"></a>00244     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  SERVER_ID(m_SERVER_ID),
<a name="l00245"></a>00245                     ASSET_TYPE_ID(m_ASSET_TYPE_ID),
<a name="l00246"></a>00246                     CURRENCY_TYPE_ID(m_CURRENCY_TYPE_ID);
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;market\n version=\&quot;%s\&quot;\n&quot;</span>
<a name="l00249"></a>00249                               <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00250"></a>00250                               <span class="stringliteral">&quot; assetTypeID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00251"></a>00251                               <span class="stringliteral">&quot; currencyTypeID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00252"></a>00252                               <span class="stringliteral">&quot; marketScale=\&quot;%lld\&quot;\n&quot;</span>
<a name="l00253"></a>00253                               <span class="stringliteral">&quot; lastSaleDate=\&quot;%s\&quot;\n&quot;</span>
<a name="l00254"></a>00254                               <span class="stringliteral">&quot; lastSalePrice=\&quot;%lld\&quot;&quot;</span>
<a name="l00255"></a>00255                               <span class="stringliteral">&quot; &gt;\n\n&quot;</span>, 
<a name="l00256"></a>00256                               <a class="code" href="class_o_t_contract.html#aa0d889e0e1670b56fedca245041a5ed3">m_strVersion</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l00257"></a>00257                               SERVER_ID.Get(),
<a name="l00258"></a>00258                               ASSET_TYPE_ID.Get(), 
<a name="l00259"></a>00259                               CURRENCY_TYPE_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l00260"></a>00260                               m_lScale,
<a name="l00261"></a>00261                               m_strLastSaleDate.c_str(),
<a name="l00262"></a>00262                               m_lLastSalePrice);    
<a name="l00263"></a>00263     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00264"></a>00264     <span class="comment">// Save the offers for sale.</span>
<a name="l00265"></a>00265     <span class="comment">//</span>
<a name="l00266"></a>00266     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00269"></a>00269         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00270"></a>00270         
<a name="l00271"></a>00271         <a class="code" href="class_o_t_string.html">OTString</a> strOffer(*pOffer);     <span class="comment">// Extract the offer contract into string form.</span>
<a name="l00272"></a>00272         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOffer(strOffer);<span class="comment">// Base64-encode that for storage.</span>
<a name="l00273"></a>00273         
<a name="l00274"></a>00274         int64_t lDateAddedToMarket = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>());
<a name="l00275"></a>00275         
<a name="l00276"></a>00276         <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;offer dateAdded=\&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;\&quot;&gt;\n%s&lt;/offer&gt;\n\n&quot;</span>,
<a name="l00277"></a>00277                                   lDateAddedToMarket, ascOffer.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00278"></a>00278     }       
<a name="l00279"></a>00279     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00280"></a>00280     <span class="comment">// Save the bids.</span>
<a name="l00281"></a>00281     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapBids)
<a name="l00282"></a>00282     {
<a name="l00283"></a>00283         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00284"></a>00284         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00285"></a>00285         
<a name="l00286"></a>00286         <a class="code" href="class_o_t_string.html">OTString</a> strOffer(*pOffer);     <span class="comment">// Extract the offer contract into string form.</span>
<a name="l00287"></a>00287         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOffer(strOffer);<span class="comment">// Base64-encode that for storage.</span>
<a name="l00288"></a>00288         
<a name="l00289"></a>00289         int64_t lDateAddedToMarket = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>());
<a name="l00290"></a>00290         
<a name="l00291"></a>00291         <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;offer dateAdded=\&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;\&quot;&gt;\n%s&lt;/offer&gt;\n\n&quot;</span>,
<a name="l00292"></a>00292                                   lDateAddedToMarket, ascOffer.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00295"></a>00295     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;/market&gt;\n&quot;</span>);
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 
<a name="l00299"></a><a class="code" href="class_o_t_market.html#a2dd9eab76501e15105aca7a8f1ed7acd">00299</a> int64_t <a class="code" href="class_o_t_market.html#a2dd9eab76501e15105aca7a8f1ed7acd">OTMarket::GetTotalAvailableAssets</a>()
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301     int64_t lTotal = 0;
<a name="l00302"></a>00302     
<a name="l00303"></a>00303     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
<a name="l00304"></a>00304     {
<a name="l00305"></a>00305         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00306"></a>00306         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00307"></a>00307         
<a name="l00308"></a>00308         lTotal += pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310     
<a name="l00311"></a>00311     <span class="keywordflow">return</span> lTotal;
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="comment">// Get list of offers for a particular Nym, to send that Nym</span>
<a name="l00316"></a>00316 <span class="comment">//</span>
<a name="l00317"></a><a class="code" href="class_o_t_market.html#a5b14418890823e00d07549c513292cd1">00317</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a5b14418890823e00d07549c513292cd1">OTMarket::GetNym_OfferList</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> &amp; theOutputList, int32_t &amp; nNymOfferCount)
<a name="l00318"></a>00318 {
<a name="l00319"></a>00319     nNymOfferCount = 0; <span class="comment">// Outputs the count of offers for NYM_ID (on this market.)</span>
<a name="l00320"></a>00320     <span class="comment">// ---------------------------------------</span>
<a name="l00321"></a>00321     <span class="comment">// Loop through the offers, up to some maximum depth, and then add each</span>
<a name="l00322"></a>00322     <span class="comment">// as a data member to an offer list, then pack it into ascOutput. </span>
<a name="l00323"></a>00323     <span class="comment">//</span>
<a name="l00324"></a>00324     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#a1116207ea005957ee57510fbfd39758f">mapOfOffersTrnsNum</a>, m_mapOffers)
<a name="l00325"></a>00325     {
<a name="l00326"></a>00326         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00327"></a>00327         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <a class="code" href="class_o_t_trade.html">OTTrade</a> * pTrade = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>();
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="comment">// We only return offers for a specific Nym ID, since this is private info only for that Nym.</span>
<a name="l00332"></a>00332         <span class="comment">//</span>
<a name="l00333"></a>00333         <span class="keywordflow">if</span> ((NULL == pTrade) || (pTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() != NYM_ID))
<a name="l00334"></a>00334             <span class="keywordflow">continue</span>;
<a name="l00335"></a>00335         
<a name="l00336"></a>00336         <span class="comment">// Below this point, I KNOW pTrade and pOffer are both good pointers.</span>
<a name="l00337"></a>00337         <span class="comment">// with no need to cleanup. I also know they are for the right Nym.</span>
<a name="l00338"></a>00338         <span class="comment">// --------------------------------------------</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         <a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html">OTDB::OfferDataNym</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html">OTDB::OfferDataNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a5700f3141bdafc532997996ea4bf6db8">OTDB::STORED_OBJ_OFFER_DATA_NYM</a>));
<a name="l00341"></a>00341         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferDataNym&gt;</a> theDataAngel(*pOfferData);
<a name="l00342"></a>00342         <span class="comment">// --------------------------------------------</span>
<a name="l00343"></a>00343         <span class="keyword">const</span> int64_t &amp; lTransactionNum         = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
<a name="l00344"></a>00344         <span class="keyword">const</span> int64_t &amp; lPriceLimit             = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
<a name="l00345"></a>00345         <span class="keyword">const</span> int64_t &amp; lTotalAssets                = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afae5495e18a4b41e5d2a8470094e4753">GetTotalAssetsOnOffer</a>();
<a name="l00346"></a>00346         <span class="keyword">const</span> int64_t &amp; lFinishedSoFar              = pOffer-&gt;<a class="code" href="class_o_t_offer.html#ab3b709080aa7c81dcd268fd78eaef262">GetFinishedSoFar</a>();
<a name="l00347"></a>00347         <span class="keyword">const</span> int64_t &amp; lMinimumIncrement           = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
<a name="l00348"></a>00348         <span class="keyword">const</span> int64_t &amp; lScale                      = pOffer-&gt;<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>();
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom                   = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a08eb5f25566832e1a67b3e33c0dcc13f">GetValidFrom</a>();
<a name="l00351"></a>00351         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidTo                 = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#ab83a62f51692c946ff394408026b0c18">GetValidTo</a>();
<a name="l00352"></a>00352     
<a name="l00353"></a>00353         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket         = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID        = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>();        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
<a name="l00356"></a>00356         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetID         = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>();         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(theAssetID);
<a name="l00357"></a>00357         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetAcctID     = pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetAcctID(theAssetAcctID);
<a name="l00358"></a>00358         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theCurrencyID      = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>();      <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyID(theCurrencyID);
<a name="l00359"></a>00359         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theCurrencyAcctID  = pTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>();  <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyAcctID(theCurrencyAcctID);
<a name="l00360"></a>00360         
<a name="l00361"></a>00361         <span class="keyword">const</span> <span class="keywordtype">bool</span> bSelling                     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>();
<a name="l00362"></a>00362         <span class="comment">// -------------------------------------------------------</span>
<a name="l00363"></a>00363         <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#ac9a572c0c92699dd2a70f04d0aad933e">IsStopOrder</a>())
<a name="l00364"></a>00364         {           
<a name="l00365"></a>00365             <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#a532bed3d9d02a34878fb24b0ea615d1b">IsGreaterThan</a>())
<a name="l00366"></a>00366                 pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a> = <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00367"></a>00367             <span class="keywordflow">else</span> if (pTrade-&gt;<a class="code" href="class_o_t_trade.html#ab302e2eb41c65f91118bcd208b78ed4a">IsLessThan</a>())
<a name="l00368"></a>00368                 pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a> = <span class="stringliteral">&quot;&lt;&quot;</span>;
<a name="l00369"></a>00369             <span class="comment">// -------------------------------</span>
<a name="l00370"></a>00370             if (!pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a>.compare(<span class="stringliteral">&quot;&gt;&quot;</span>) || !pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a>.compare(<span class="stringliteral">&quot;&lt;&quot;</span>))
<a name="l00371"></a>00371             {
<a name="l00372"></a>00372                 <span class="keyword">const</span> int64_t &amp; lStopPrice  = pTrade-&gt;<a class="code" href="class_o_t_trade.html#a2234ed0a72b48fa0749cbe89e69d5a54">GetStopPrice</a>();
<a name="l00373"></a>00373                 pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a888f474f564554f6a0d03cabd1f0ef3c">stop_price</a>  = to_string&lt;int64_t&gt;(lStopPrice);
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376         <span class="comment">// ------------------------------------------------------</span>
<a name="l00377"></a>00377         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ab5b4cb920bf2211cae056c41aee47871">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
<a name="l00378"></a>00378         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a83d4f7597ad118a3232ebccce42b8735">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
<a name="l00379"></a>00379         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ab24b32937fd9ae98994e83bf7730bb70">total_assets</a>        = to_string&lt;int64_t&gt;(lTotalAssets);
<a name="l00380"></a>00380         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#acab7e0110c9737d49440fe5d62b16978">finished_so_far</a>     = to_string&lt;int64_t&gt;(lFinishedSoFar);
<a name="l00381"></a>00381         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a5e3c257180f603de8b8b569550c5cc9c">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
<a name="l00382"></a>00382         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a3c3e3ed3c40bb91ae5d172c93873c35c">scale</a>               = to_string&lt;int64_t&gt;(lScale);
<a name="l00383"></a>00383         
<a name="l00384"></a>00384         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80a04471908aef8021f63772e2fbad21">valid_from</a>          = to_string&lt;time64_t&gt;(tValidFrom);
<a name="l00385"></a>00385         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a3ab5cc1ff3567b40d5b4ccbf00003eb0">valid_to</a>            = to_string&lt;time64_t&gt;(tValidTo);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#aa25174f9820a0c6b5092e1a113eb1231">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ae1e0c74c7e547ed930cdf4a28ffeafe8">server_id</a>           = strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00390"></a>00390         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#aad0735277c4348f983f632ad29dd0acf">asset_type_id</a>       = strAssetID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00391"></a>00391         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a900d1d18875b50a9d0845615b9c97597">asset_acct_id</a>       = strAssetAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00392"></a>00392         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a1343a8d4cd9379f17782df3d3afe2a49">currency_type_id</a>    = strCurrencyID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00393"></a>00393         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ae6a57a2226f59e4364de65f299f7c304">currency_acct_id</a>    = strCurrencyAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a4864d06c6713e383f12c00bd79bd4956">selling</a>             = bSelling;
<a name="l00396"></a>00396         <span class="comment">// ------------------------------------------------------</span>
<a name="l00397"></a>00397         <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
<a name="l00398"></a>00398         <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
<a name="l00399"></a>00399         <span class="comment">//</span>
<a name="l00400"></a>00400         theOutputList.AddOfferDataNym(*pOfferData); 
<a name="l00401"></a>00401         nNymOfferCount++;
<a name="l00402"></a>00402     }       
<a name="l00403"></a>00403         
<a name="l00404"></a>00404     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00405"></a>00405     
<a name="l00406"></a>00406     <span class="keywordflow">return</span> <span class="keyword">true</span>;        
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 
<a name="l00410"></a><a class="code" href="class_o_t_market.html#a7375c51d4be96bf9d7e6a92f0dc7f18f">00410</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a7375c51d4be96bf9d7e6a92f0dc7f18f">OTMarket::GetRecentTradeList</a>(<a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascOutput, int32_t &amp; nTradeCount)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412     nTradeCount = 0;    <span class="comment">// Output the count of trades in the list being returned. (If success..)</span>
<a name="l00413"></a>00413     
<a name="l00414"></a>00414     <span class="comment">// -------------------------</span>
<a name="l00415"></a>00415     
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (NULL == m_pTradeList)
<a name="l00417"></a>00417     {
<a name="l00418"></a>00418 <span class="comment">//      OTLog::Error(&quot;OTMarket::GetRecentTradeList: m_pTradeList is NULL. \n&quot;);</span>
<a name="l00419"></a>00419         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00420"></a>00420         <span class="comment">// Returning true, since it&#39;s normal for this to be NULL when the list is empty.</span>
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422     
<a name="l00423"></a>00423     <span class="comment">// ------------------------------------------</span>
<a name="l00424"></a>00424     
<a name="l00425"></a>00425     <span class="comment">// The market already keeps a list of recent trades (informational only)</span>
<a name="l00426"></a>00426     <span class="comment">//</span>
<a name="l00427"></a>00427     
<a name="l00428"></a>00428     <span class="keyword">const</span> <span class="keywordtype">size_t</span> sizeList = m_pTradeList-&gt;GetTradeDataMarketCount();
<a name="l00429"></a>00429     nTradeCount = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span> (sizeList);
<a name="l00430"></a>00430     
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (nTradeCount == 0)
<a name="l00432"></a>00432         <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but there are 0 trade datas to return. (empty list.)</span>
<a name="l00433"></a>00433     
<a name="l00434"></a>00434     <span class="comment">// So now, let&#39;s pack the list into strOutput...</span>
<a name="l00435"></a>00435     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nTradeCount &gt; 0)
<a name="l00436"></a>00436     {
<a name="l00437"></a>00437         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l00438"></a>00438         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l00439"></a>00439         
<a name="l00440"></a>00440         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l00441"></a>00441         
<a name="l00442"></a>00442         <span class="comment">// -----------------------------</span>
<a name="l00443"></a>00443         
<a name="l00444"></a>00444         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*m_pTradeList); <span class="comment">// Now we PACK our market&#39;s recent trades list.</span>
<a name="l00445"></a>00445         
<a name="l00446"></a>00446         <span class="keywordflow">if</span> (NULL == pBuffer)
<a name="l00447"></a>00447         {
<a name="l00448"></a>00448             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pTradeList in OTCron::GetRecentTradeList. \n&quot;</span>);
<a name="l00449"></a>00449             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         
<a name="l00452"></a>00452         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
<a name="l00453"></a>00453         
<a name="l00454"></a>00454         <span class="comment">// -------------------------------------------------------- </span>
<a name="l00455"></a>00455         
<a name="l00456"></a>00456         <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
<a name="l00457"></a>00457         
<a name="l00458"></a>00458         <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
<a name="l00459"></a>00459         <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
<a name="l00460"></a>00460         
<a name="l00461"></a>00461         <span class="keywordflow">if</span> ((NULL != pUint) || (theSize &lt; 2))
<a name="l00462"></a>00462         {
<a name="l00463"></a>00463             <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
<a name="l00464"></a>00464             
<a name="l00465"></a>00465             <span class="comment">// This function will base64 ENCODE theData,</span>
<a name="l00466"></a>00466             <span class="comment">// and then Set() that as the string contents.</span>
<a name="l00467"></a>00467             ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
<a name="l00468"></a>00468             
<a name="l00469"></a>00469             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471         <span class="keywordflow">else</span> 
<a name="l00472"></a>00472             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error while getting buffer data in OTMarket::GetRecentTradeList.\n&quot;</span>);
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474     
<a name="l00475"></a>00475     <span class="keywordflow">else</span>
<a name="l00476"></a>00476         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error: nTradeCount with negative value in OTMarket::GetRecentTradeList: %d.\n&quot;</span>, nTradeCount);
<a name="l00477"></a>00477  
<a name="l00478"></a>00478     <span class="keywordflow">return</span> <span class="keyword">false</span>;   
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment">// OTDB::OfferListMarket</span>
<a name="l00483"></a>00483 <span class="comment">//</span>
<a name="l00484"></a><a class="code" href="class_o_t_market.html#a4b6f10cedaa3a30fa5d7efc8912c71e2">00484</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a4b6f10cedaa3a30fa5d7efc8912c71e2">OTMarket::GetOfferList</a>(<a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascOutput, int64_t lDepth, int32_t &amp; nOfferCount)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     nOfferCount = 0;  <span class="comment">// Outputs the actual count of offers being returned.</span>
<a name="l00487"></a>00487     <span class="comment">// ----------------------------</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (0 == lDepth)
<a name="l00489"></a>00489         lDepth = <a class="code" href="_o_t_market_8hpp.html#ad3557119e36c729a56ea7448245c116a">MAX_MARKET_QUERY_DEPTH</a>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">// Loop through the offers, up to some maximum depth, and then add each</span>
<a name="l00492"></a>00492     <span class="comment">// as a data member to an offer list, then pack it into ascOutput. </span>
<a name="l00493"></a>00493     
<a name="l00494"></a>00494     <a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> * pOfferList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2b54a22ce17683d3970981ec94203ad1">OTDB::STORED_OBJ_OFFER_LIST_MARKET</a>));
<a name="l00495"></a>00495     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListMarket&gt;</a> theListAngel(*pOfferList);
<a name="l00496"></a>00496     <span class="comment">// -----------------------------------------------------------</span>
<a name="l00497"></a>00497 <span class="comment">//  mapOfOffers         m_mapBids;      // The buyers, ordered by price limit</span>
<a name="l00498"></a>00498 <span class="comment">//  mapOfOffers         m_mapAsks;      // The sellers, ordered by price limit</span>
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer    = NULL;
<a name="l00501"></a>00501     int32_t nTempDepth      = 0;
<a name="l00502"></a>00502     
<a name="l00503"></a>00503     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapBids)
<a name="l00504"></a>00504     {
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (nTempDepth++ &gt; lDepth)
<a name="l00506"></a>00506             <span class="keywordflow">break</span>;
<a name="l00507"></a>00507         <span class="comment">// --------------------------------------------</span>
<a name="l00508"></a>00508         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00509"></a>00509         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00510"></a>00510         <span class="comment">// --------------------------------------------</span>
<a name="l00511"></a>00511         <span class="keyword">const</span> int64_t &amp; lPriceLimit     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         <span class="keywordflow">if</span> (0 == lPriceLimit) <span class="comment">// Skipping any market orders.</span>
<a name="l00514"></a>00514             <span class="keywordflow">continue</span>;
<a name="l00515"></a>00515         <span class="comment">// --------------------------------------------</span>
<a name="l00516"></a>00516         <span class="comment">// OfferDataMarket</span>
<a name="l00517"></a>00517         <a class="code" href="class_o_t_d_b_1_1_bid_data.html">OTDB::BidData</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_bid_data.html">OTDB::BidData</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82aa8c9eb3eaaf80d1bcde91443e43b9b2f">OTDB::STORED_OBJ_BID_DATA</a>));
<a name="l00518"></a>00518         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::BidData&gt;</a> theDataAngel(*pOfferData);
<a name="l00519"></a>00519         <span class="comment">// --------------------------------------------</span>
<a name="l00520"></a>00520         <span class="keyword">const</span> int64_t &amp; lTransactionNum = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
<a name="l00521"></a>00521         <span class="keyword">const</span> int64_t    lAvailableAssets   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
<a name="l00522"></a>00522         <span class="keyword">const</span> int64_t &amp; lMinimumIncrement   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
<a name="l00523"></a>00523         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();
<a name="l00524"></a>00524         
<a name="l00525"></a>00525         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a9204334216c536dbb899f1f99c121f9b">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
<a name="l00526"></a>00526         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a599d2dfd56c4232bbbb30d16987efb57">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
<a name="l00527"></a>00527         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a23ce62a0f8c04482ce8b9018bb9126aa">available_assets</a>    = to_string&lt;int64_t&gt;(lAvailableAssets);
<a name="l00528"></a>00528         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a62f4d67cf5675bd6f9ff6d602c199650">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
<a name="l00529"></a>00529         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a83cf18fff32be53bb5ac0b8e1b6b6f43">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);
<a name="l00530"></a>00530         <span class="comment">// ------------------------------------------------------</span>
<a name="l00531"></a>00531         <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
<a name="l00532"></a>00532         <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
<a name="l00533"></a>00533         <span class="comment">//</span>
<a name="l00534"></a>00534         pOfferList-&gt;AddBidData(*pOfferData);
<a name="l00535"></a>00535         nOfferCount++;
<a name="l00536"></a>00536     }       
<a name="l00537"></a>00537     
<a name="l00538"></a>00538     pOffer      = NULL;
<a name="l00539"></a>00539     nTempDepth  = 0;
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
<a name="l00542"></a>00542     {
<a name="l00543"></a>00543         <span class="keywordflow">if</span> (nTempDepth++ &gt; lDepth)
<a name="l00544"></a>00544             <span class="keywordflow">break</span>;
<a name="l00545"></a>00545         <span class="comment">// --------------------------------------------</span>
<a name="l00546"></a>00546         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
<a name="l00547"></a>00547         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00548"></a>00548         
<a name="l00549"></a>00549         <span class="comment">// OfferDataMarket</span>
<a name="l00550"></a>00550         <a class="code" href="class_o_t_d_b_1_1_ask_data.html">OTDB::AskData</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_ask_data.html">OTDB::AskData</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a95aef78f2a6a6e62d4a44b3301588538">OTDB::STORED_OBJ_ASK_DATA</a>));
<a name="l00551"></a>00551         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::AskData&gt;</a> theDataAngel(*pOfferData);
<a name="l00552"></a>00552         <span class="comment">// --------------------------------------------</span>
<a name="l00553"></a>00553         <span class="keyword">const</span> int64_t &amp; lTransactionNum = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
<a name="l00554"></a>00554         <span class="keyword">const</span> int64_t &amp; lPriceLimit     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
<a name="l00555"></a>00555         <span class="keyword">const</span> int64_t    lAvailableAssets   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
<a name="l00556"></a>00556         <span class="keyword">const</span> int64_t &amp; lMinimumIncrement   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
<a name="l00557"></a>00557         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a9204334216c536dbb899f1f99c121f9b">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
<a name="l00560"></a>00560         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a599d2dfd56c4232bbbb30d16987efb57">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
<a name="l00561"></a>00561         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a23ce62a0f8c04482ce8b9018bb9126aa">available_assets</a>    = to_string&lt;int64_t&gt;(lAvailableAssets);
<a name="l00562"></a>00562         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a62f4d67cf5675bd6f9ff6d602c199650">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
<a name="l00563"></a>00563         pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a83cf18fff32be53bb5ac0b8e1b6b6f43">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);
<a name="l00564"></a>00564         <span class="comment">// ------------------------------------------------------</span>
<a name="l00565"></a>00565         <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
<a name="l00566"></a>00566         <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
<a name="l00567"></a>00567         <span class="comment">//</span>
<a name="l00568"></a>00568         pOfferList-&gt;AddAskData(*pOfferData);
<a name="l00569"></a>00569         nOfferCount++;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00572"></a>00572     <span class="comment">// Now pack the list into strOutput...</span>
<a name="l00573"></a>00573     
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (nOfferCount == 0)
<a name="l00575"></a>00575         <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but there were zero offers found.</span>
<a name="l00576"></a>00576     
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (nOfferCount &gt; 0)
<a name="l00578"></a>00578     {
<a name="l00579"></a>00579         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l00580"></a>00580         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l00581"></a>00581         
<a name="l00582"></a>00582         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l00583"></a>00583         <span class="comment">// -----------------------------</span>
<a name="l00584"></a>00584         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*pOfferList); <span class="comment">// Now we PACK our market&#39;s offer list.</span>
<a name="l00585"></a>00585         
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (NULL == pBuffer)
<a name="l00587"></a>00587         {
<a name="l00588"></a>00588             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pOfferList in OTCron::GetOfferList. \n&quot;</span>);
<a name="l00589"></a>00589             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591         
<a name="l00592"></a>00592         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
<a name="l00593"></a>00593         <span class="comment">// --------------------------------------------------------</span>
<a name="l00594"></a>00594         <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
<a name="l00595"></a>00595         
<a name="l00596"></a>00596         <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
<a name="l00597"></a>00597         <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
<a name="l00598"></a>00598         
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (NULL != pUint)
<a name="l00600"></a>00600         {
<a name="l00601"></a>00601             <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
<a name="l00602"></a>00602             
<a name="l00603"></a>00603             <span class="comment">// This function will base64 ENCODE theData,</span>
<a name="l00604"></a>00604             <span class="comment">// and then Set() that as the string contents.</span>
<a name="l00605"></a>00605             ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
<a name="l00606"></a>00606             
<a name="l00607"></a>00607             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         <span class="keywordflow">else</span> 
<a name="l00610"></a>00610             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error while getting buffer data in OTMarket::GetOfferList.\n&quot;</span>);
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612     
<a name="l00613"></a>00613     <span class="keywordflow">else</span>
<a name="l00614"></a>00614         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;invalid: nOfferCount is &lt; 0 in OTMarket::GetOfferList.\n&quot;</span>);
<a name="l00615"></a>00615         
<a name="l00616"></a>00616     <span class="keywordflow">return</span> <span class="keyword">false</span>;   
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="comment">// To insure that offers of a specific price are always inserted at the upper bound,</span>
<a name="l00621"></a>00621 <span class="comment">// use this:  my_mmap.insert(my_mmap.upper_bound(key), my_mmap::value_type(key, val));</span>
<a name="l00622"></a>00622 <span class="comment">// This way I can read them from the lower bound later, and always get them in the </span>
<a name="l00623"></a>00623 <span class="comment">// order received for that price.</span>
<a name="l00624"></a>00624 <span class="comment">// </span>
<a name="l00625"></a>00625 <span class="comment">//typedef std::multimap&lt;int64_t, OTOffer *&gt; mapOfOffers;</span>
<a name="l00626"></a>00626 <span class="comment">//mapOfOffers   m_mapBids; // The buyers, ordered  </span>
<a name="l00627"></a>00627 <span class="comment">//mapOfOffers   m_mapAsks; // The sellers, ordered</span>
<a name="l00628"></a>00628 
<a name="l00629"></a><a class="code" href="class_o_t_market.html#a61f96f7d546012fd290307d519214088">00629</a> <a class="code" href="class_o_t_offer.html">OTOffer</a> * <a class="code" href="class_o_t_market.html#a61f96f7d546012fd290307d519214088">OTMarket::GetOffer</a>(<span class="keyword">const</span> int64_t &amp; lTransactionNum)
<a name="l00630"></a>00630 {
<a name="l00631"></a>00631     <span class="comment">// See if there&#39;s something there with that transaction number.</span>
<a name="l00632"></a>00632     mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
<a name="l00633"></a>00633     
<a name="l00634"></a>00634     <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
<a name="l00635"></a>00635     {
<a name="l00636"></a>00636         <span class="comment">// nothing found.</span>
<a name="l00637"></a>00637         <span class="keywordflow">return</span> NULL;
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639     <span class="comment">// Found it!</span>
<a name="l00640"></a>00640     <span class="keywordflow">else</span> 
<a name="l00641"></a>00641     {
<a name="l00642"></a>00642         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*ii).second;
<a name="l00643"></a>00643         
<a name="l00644"></a>00644         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pOffer));
<a name="l00645"></a>00645         
<a name="l00646"></a>00646         <span class="keywordflow">if</span> (pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>() == lTransactionNum)
<a name="l00647"></a>00647             <span class="keywordflow">return</span> pOffer;
<a name="l00648"></a>00648         <span class="keywordflow">else</span> 
<a name="l00649"></a>00649             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Expected Offer with transaction number %lld, but found %lld inside. Bad data?\n&quot;</span>,
<a name="l00650"></a>00650                           lTransactionNum, pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>());
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     
<a name="l00653"></a>00653     <span class="keywordflow">return</span> NULL;    
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 
<a name="l00657"></a><a class="code" href="class_o_t_market.html#a8c35cf47acba612a33c8aad9a96a0945">00657</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a8c35cf47acba612a33c8aad9a96a0945">OTMarket::RemoveOffer</a>(<span class="keyword">const</span> int64_t &amp; lTransactionNum) <span class="comment">// if false, offer wasn&#39;t found.</span>
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659     <span class="keywordtype">bool</span> bReturnValue = <span class="keyword">false</span>;
<a name="l00660"></a>00660     
<a name="l00661"></a>00661     <span class="comment">// See if there&#39;s something there with that transaction number.</span>
<a name="l00662"></a>00662     mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
<a name="l00663"></a>00663     
<a name="l00664"></a>00664     <span class="comment">// If it&#39;s not already on the list, then there&#39;s nothing to remove.</span>
<a name="l00665"></a>00665     <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
<a name="l00666"></a>00666     {
<a name="l00667"></a>00667         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to remove non-existent Offer from Market. Transaction #: %lld\n&quot;</span>,
<a name="l00668"></a>00668                       lTransactionNum);
<a name="l00669"></a>00669         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671     <span class="comment">// Otherwise, if it WAS already there, remove it properly.</span>
<a name="l00672"></a>00672     <span class="keywordflow">else</span> 
<a name="l00673"></a>00673     {
<a name="l00674"></a>00674         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*ii).second;
<a name="l00675"></a>00675         
<a name="l00676"></a>00676         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
<a name="l00677"></a>00677         <span class="comment">// ---------------------------------------</span>
<a name="l00678"></a>00678         <span class="comment">// This removes it from one list (the one indexed by transaction number.)</span>
<a name="l00679"></a>00679         <span class="comment">// But it&#39;s still on one of the other lists...</span>
<a name="l00680"></a>00680         m_mapOffers.erase(ii);
<a name="l00681"></a>00681         
<a name="l00682"></a>00682         <span class="comment">// The code operates the same whether ask or bid. Just use a pointer.</span>
<a name="l00683"></a>00683         <a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a> * pMap = (pOffer-&gt;<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>() ? &amp;m_mapBids : &amp;m_mapAsks);
<a name="l00684"></a>00684         
<a name="l00685"></a>00685         <span class="comment">// Future solution here: instead of looping through all the offers and finding it,</span>
<a name="l00686"></a>00686         <span class="comment">// I could just have each Offer store a copy of the iterator that&#39;s returned when</span>
<a name="l00687"></a>00687         <span class="comment">// it&#39;s first inserted. Later I just erase that iterator from the right list to remove. Todo.</span>
<a name="l00688"></a>00688         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pSameOffer = NULL;
<a name="l00689"></a>00689         
<a name="l00690"></a>00690         <span class="keywordflow">for</span> (mapOfOffers::iterator iii = pMap-&gt;begin(); iii != pMap-&gt;end(); ++iii)
<a name="l00691"></a>00691         {   
<a name="l00692"></a>00692             pSameOffer = (*iii).second;
<a name="l00693"></a>00693             
<a name="l00694"></a>00694             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pSameOffer, <span class="stringliteral">&quot;NULL offer pointer in OTMarket::RemoveOffer.\n&quot;</span>);
<a name="l00695"></a>00695             
<a name="l00696"></a>00696             <span class="comment">// found it!</span>
<a name="l00697"></a>00697             <span class="keywordflow">if</span> (lTransactionNum == pSameOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>())
<a name="l00698"></a>00698             {
<a name="l00699"></a>00699                 pMap-&gt;erase(iii);
<a name="l00700"></a>00700                 <span class="keywordflow">break</span>;
<a name="l00701"></a>00701             }
<a name="l00702"></a>00702             
<a name="l00703"></a>00703             <span class="comment">// Later on, below this loop, this pointer will be NULL or not, and I will know if it was removed.</span>
<a name="l00704"></a>00704             pSameOffer = NULL;
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         <span class="comment">// ---------------------------------------</span>
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (NULL == pSameOffer)
<a name="l00708"></a>00708         {
<a name="l00709"></a>00709             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Removed Offer from offers list, but not found on bid/ask list.\n&quot;</span>);
<a name="l00710"></a>00710         }
<a name="l00711"></a>00711         <span class="keywordflow">else</span> <span class="comment">// This means it was found and removed from the second list as well.</span>
<a name="l00712"></a>00712         {
<a name="l00713"></a>00713             bReturnValue = <span class="keyword">true</span>; <span class="comment">// Success.</span>
<a name="l00714"></a>00714         }
<a name="l00715"></a>00715         <span class="comment">// ---------------------------------------</span>
<a name="l00716"></a>00716         <span class="comment">// pOffer was found on the Offers list.</span>
<a name="l00717"></a>00717         <span class="comment">// pSameOffer was found on the Bid or Ask list, with the same transaction ID.</span>
<a name="l00718"></a>00718         <span class="comment">// They SHOULD be pointers to the SAME object.</span>
<a name="l00719"></a>00719         <span class="comment">// Therefore I CANNOT delete them both.</span>
<a name="l00720"></a>00720         <span class="comment">//</span>
<a name="l00721"></a>00721         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pOffer == pSameOffer);
<a name="l00722"></a>00722         
<a name="l00723"></a>00723         <span class="keyword">delete</span> pOffer;
<a name="l00724"></a>00724         pOffer = NULL;
<a name="l00725"></a>00725         pSameOffer = NULL;
<a name="l00726"></a>00726     }
<a name="l00727"></a>00727     
<a name="l00728"></a>00728     <span class="keywordflow">if</span> (bReturnValue)
<a name="l00729"></a>00729         <span class="keywordflow">return</span> <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>(); <span class="comment">// &lt;====== SAVE since an offer was removed.</span>
<a name="l00730"></a>00730     <span class="keywordflow">else</span>
<a name="l00731"></a>00731         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 <span class="comment">// This method demands an Offer reference in order to verify that it really exists.</span>
<a name="l00736"></a>00736 <span class="comment">// HOWEVER, it MUST be heap-allocated, since the Market takes ownership and will delete it.</span>
<a name="l00737"></a>00737 <span class="comment">// </span>
<a name="l00738"></a>00738 <span class="comment">// If NOT successful adding, caller must clear up his own memory.</span>
<a name="l00739"></a>00739 <span class="comment">//</span>
<a name="l00740"></a><a class="code" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">00740</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">OTMarket::AddOffer</a>(<a class="code" href="class_o_t_trade.html">OTTrade</a> * pTrade, <a class="code" href="class_o_t_offer.html">OTOffer</a> &amp; theOffer, <span class="keywordtype">bool</span> bSaveFile<span class="comment">/*=true*/</span>, <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket<span class="comment">/*=0*/</span>)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742     <span class="keyword">const</span> int64_t   lTransactionNum = theOffer.<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>(),
<a name="l00743"></a>00743                 lPriceLimit     = theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
<a name="l00744"></a>00744         
<a name="l00745"></a>00745     <span class="comment">// Make sure the offer is even appropriate for this market...</span>
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">ValidateOfferForMarket</a>(theOffer))
<a name="l00747"></a>00747     {
<a name="l00748"></a>00748         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed attempt to add invalid offer to market.\n&quot;</span>);
<a name="l00749"></a>00749         
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (NULL != pTrade)
<a name="l00751"></a>00751             pTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753     <span class="keywordflow">else</span>
<a name="l00754"></a>00754     {
<a name="l00755"></a>00755         <span class="comment">// I store duplicate lists of offer pointers. Two multimaps ordered by price,</span>
<a name="l00756"></a>00756         <span class="comment">// (for buyers and sellers) and one map ordered by transaction number.</span>
<a name="l00757"></a>00757         <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l00758"></a>00758         <span class="comment">// See if there&#39;s something else already there with the same transaction number.</span>
<a name="l00759"></a>00759         <span class="comment">//</span>
<a name="l00760"></a>00760         mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
<a name="l00761"></a>00761         
<a name="l00762"></a>00762         <span class="comment">// If it&#39;s not already on the list, then add it...</span>
<a name="l00763"></a>00763         <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
<a name="l00764"></a>00764         {
<a name="l00765"></a>00765             m_mapOffers[lTransactionNum] = &amp;theOffer;
<a name="l00766"></a>00766             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as an offer to the market...\n&quot;</span>);
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768         <span class="comment">// Otherwise, if it was already there, log an error.</span>
<a name="l00769"></a>00769         <span class="keywordflow">else</span> 
<a name="l00770"></a>00770         {
<a name="l00771"></a>00771             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to add Offer to Market with pre-existing transaction number: %lld\n&quot;</span>,
<a name="l00772"></a>00772                           lTransactionNum);
<a name="l00773"></a>00773             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l00776"></a>00776         <span class="comment">// Okay so we successfully added it to one list (indexed by Transaction Num) and we </span>
<a name="l00777"></a>00777         <span class="comment">// know it validated as an offer, AND we know it wasn&#39;t already on the market.</span>
<a name="l00778"></a>00778         <span class="comment">//</span>
<a name="l00779"></a>00779         <span class="comment">// So next, let&#39;s add it to the lists that are indexed by price:</span>
<a name="l00780"></a>00780                 
<a name="l00781"></a>00781         <span class="comment">// Determine if it&#39;s a buy or sell, and add it to the right list.</span>
<a name="l00782"></a>00782         <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>())
<a name="l00783"></a>00783         {
<a name="l00784"></a>00784             <span class="comment">// No bother checking if the offer is already on this list,</span>
<a name="l00785"></a>00785             <span class="comment">// since the code above basically already verifies that for us.</span>
<a name="l00786"></a>00786             
<a name="l00787"></a>00787             m_mapBids.insert (m_mapBids.lower_bound(lPriceLimit), <span class="comment">// highest bidders go first, so I am last in line at lower bound.</span>
<a name="l00788"></a>00788                               std::pair&lt;int64_t, OTOffer *&gt;(lPriceLimit, &amp;theOffer) );
<a name="l00789"></a>00789             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as a bid to the market.\n&quot;</span>);
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791         <span class="keywordflow">else</span>            
<a name="l00792"></a>00792         {
<a name="l00793"></a>00793             m_mapAsks.insert (m_mapAsks.upper_bound(lPriceLimit), <span class="comment">// lowest price sells first, so I am last in line at upper bound.</span>
<a name="l00794"></a>00794                               std::pair&lt;int64_t, OTOffer *&gt;(lPriceLimit, &amp;theOffer) );
<a name="l00795"></a>00795             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as an ask to the market.\n&quot;</span>);
<a name="l00796"></a>00796         }
<a name="l00797"></a>00797         <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (bSaveFile)
<a name="l00799"></a>00799         {
<a name="l00800"></a>00800             <span class="comment">// Set this to the current date/time, since the offer is</span>
<a name="l00801"></a>00801             <span class="comment">// being added for the first time.</span>
<a name="l00802"></a>00802             <span class="comment">//</span>
<a name="l00803"></a>00803             theOffer.<a class="code" href="class_o_t_offer.html#a46b667663f5a75693ac8d1d5fc445279">SetDateAddedToMarket</a>(<a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>());
<a name="l00804"></a>00804             
<a name="l00805"></a>00805             <span class="keywordflow">return</span> <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>();  <span class="comment">// &lt;====== SAVE since an offer was added to the Market.</span>
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807         <span class="keywordflow">else</span>
<a name="l00808"></a>00808         {
<a name="l00809"></a>00809             <span class="comment">// Set this to the date passed in, since this offer was</span>
<a name="l00810"></a>00810             <span class="comment">// added to the market in the past, and we are preserving that date.</span>
<a name="l00811"></a>00811             <span class="comment">//</span>
<a name="l00812"></a>00812             theOffer.<a class="code" href="class_o_t_offer.html#a46b667663f5a75693ac8d1d5fc445279">SetDateAddedToMarket</a>(tDateAddedToMarket);
<a name="l00813"></a>00813 
<a name="l00814"></a>00814             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817     <span class="comment">// ---------------------</span>
<a name="l00818"></a>00818     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="class_o_t_market.html#a814b2f38a7ffa5593acbf13698ffef24">00822</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a814b2f38a7ffa5593acbf13698ffef24">OTMarket::LoadMarket</a>()
<a name="l00823"></a>00823 {
<a name="l00824"></a>00824     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>());
<a name="l00825"></a>00825     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym());
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(*<span class="keyword">this</span>);
<a name="l00828"></a>00828     <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l00831"></a>00831     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00832"></a>00832     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00833"></a>00833     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l00834"></a>00834     <span class="keywordtype">bool</span> bSuccess = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(szFoldername, szFilename);
<a name="l00835"></a>00835     
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (bSuccess)
<a name="l00837"></a>00837         bSuccess = <a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>(szFoldername, szFilename); <span class="comment">// todo ??</span>
<a name="l00838"></a>00838     
<a name="l00839"></a>00839     <span class="keywordflow">if</span> (bSuccess)
<a name="l00840"></a>00840         bSuccess = <a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*(<a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym()));
<a name="l00841"></a>00841     
<a name="l00842"></a>00842     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l00843"></a>00843     <span class="comment">// Load the list of recent market trades (informational only.)</span>
<a name="l00844"></a>00844     <span class="comment">//</span>
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (bSuccess)
<a name="l00846"></a>00846     {
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (NULL != m_pTradeList)
<a name="l00848"></a>00848             <span class="keyword">delete</span> m_pTradeList;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         <span class="keyword">const</span> <span class="keywordtype">char</span> * szSubFolder = <span class="stringliteral">&quot;recent&quot;</span>; <span class="comment">// todo stop hardcoding.</span>
<a name="l00851"></a>00851 
<a name="l00852"></a>00852         m_pTradeList =  <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#aaf0caee055f843a828e3bac094321886">OTDB::QueryObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>,
<a name="l00853"></a>00853                                         szFoldername,   <span class="comment">// markets</span>
<a name="l00854"></a>00854                                         szSubFolder,    <span class="comment">// markets/recent</span>
<a name="l00855"></a>00855                                         szFilename));   <span class="comment">// markets/recent/market_ID</span>
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     <span class="keywordflow">return</span> bSuccess;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 
<a name="l00864"></a><a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">00864</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">OTMarket::SaveMarket</a>()
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>());
<a name="l00867"></a>00867     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym());
<a name="l00868"></a>00868     
<a name="l00869"></a>00869     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(*<span class="keyword">this</span>);
<a name="l00870"></a>00870     <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l00873"></a>00873     
<a name="l00874"></a>00874     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00875"></a>00875     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00876"></a>00876         
<a name="l00877"></a>00877     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l00878"></a>00878     
<a name="l00879"></a>00879     <span class="comment">// Remember, if the market has changed, the new contents will not be written anywhere</span>
<a name="l00880"></a>00880     <span class="comment">// until that market has been signed. So I have to re-sign here, or it would just save</span>
<a name="l00881"></a>00881     <span class="comment">// the old version of the market from before the most recent changes.</span>
<a name="l00882"></a>00882     <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l00883"></a>00883     
<a name="l00884"></a>00884     <span class="comment">// Sign it, save it internally to string, and then save that out to the file.</span>
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*(<a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym())) || !<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>() || !<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(szFoldername, szFilename))
<a name="l00886"></a>00886     {
<a name="l00887"></a>00887         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving Market:\n%s%s%s\n&quot;</span>, szFoldername,
<a name="l00888"></a>00888                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l00889"></a>00889         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891     
<a name="l00892"></a>00892     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l00893"></a>00893     <span class="comment">// Save a copy of recent trades.</span>
<a name="l00894"></a>00894     
<a name="l00895"></a>00895     <span class="keywordflow">if</span> (NULL != m_pTradeList)
<a name="l00896"></a>00896     {
<a name="l00897"></a>00897         <span class="keyword">const</span> <span class="keywordtype">char</span> * szSubFolder = <span class="stringliteral">&quot;recent&quot;</span>; <span class="comment">// todo stop hardcoding.</span>
<a name="l00898"></a>00898         
<a name="l00899"></a>00899         <span class="comment">// If this fails, oh well. It&#39;s informational, anyway.</span>
<a name="l00900"></a>00900         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a394420b02f48d3ebdfebb75d92a4d6dd">OTDB::StoreObject</a>(*m_pTradeList, 
<a name="l00901"></a>00901                                        szFoldername,    <span class="comment">// markets</span>
<a name="l00902"></a>00902                                        szSubFolder,     <span class="comment">// markets/recent</span>
<a name="l00903"></a>00903                                        szFilename))     <span class="comment">// markets/recent/Market_ID</span>
<a name="l00904"></a>00904             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving recent trades for Market:\n%s%s%s%s%s\n&quot;</span>, szFoldername,
<a name="l00905"></a>00905                           <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szSubFolder, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907     
<a name="l00908"></a>00908     <span class="keywordflow">return</span> <span class="keyword">true</span>;    
<a name="l00909"></a>00909 }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                                   
<a name="l00912"></a>00912 <span class="comment">// A Market&#39;s ID is based on the asset type, the currency type, and the scale.</span>
<a name="l00913"></a>00913 <span class="comment">//</span>
<a name="l00914"></a><a class="code" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">00914</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">OTMarket::GetIdentifier</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theIdentifier)
<a name="l00915"></a>00915 {   
<a name="l00916"></a>00916     <a class="code" href="class_o_t_string.html">OTString</a>    strTemp, strAsset(<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()), strCurrency(<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>());
<a name="l00917"></a>00917     
<a name="l00918"></a>00918     int64_t     lScale = <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>();
<a name="l00919"></a>00919     
<a name="l00920"></a>00920     <span class="comment">// In this way we generate a unique ID that will always be consistent</span>
<a name="l00921"></a>00921     <span class="comment">// for the same asset ID, currency ID, and market scale.</span>
<a name="l00922"></a>00922     strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;ASSET TYPE:\n%s\nCURRENCY TYPE:\n%s\nMARKET SCALE:\n%lld\n&quot;</span>,
<a name="l00923"></a>00923                    strAsset.Get(), strCurrency.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), lScale);
<a name="l00924"></a>00924     
<a name="l00925"></a>00925     <a class="code" href="class_o_t_contract.html#ac975866d3511c41d935d2ec44c24c4cb">m_ID</a>.<a class="code" href="class_o_t_identifier.html#ac50b356cf5d5d04c08eaf568d07bcc46">CalculateDigest</a>(strTemp);
<a name="l00926"></a>00926     
<a name="l00927"></a>00927     <a class="code" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">OTContract::GetIdentifier</a>(theIdentifier);
<a name="l00928"></a>00928 }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <span class="comment">// returns 0 if there are no bids. Otherwise returns the value of the highest bid on the market.</span>
<a name="l00932"></a><a class="code" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">00932</a> int64_t <a class="code" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">OTMarket::GetHighestBidPrice</a>()
<a name="l00933"></a>00933 {
<a name="l00934"></a>00934     int64_t lPrice = 0;
<a name="l00935"></a>00935     
<a name="l00936"></a>00936     mapOfOffers::reverse_iterator rr = m_mapBids.rbegin();
<a name="l00937"></a>00937     
<a name="l00938"></a>00938     <span class="keywordflow">if</span> (rr != m_mapBids.rend())
<a name="l00939"></a>00939     {       
<a name="l00940"></a>00940         lPrice = (*rr).first;
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942     
<a name="l00943"></a>00943     <span class="keywordflow">return</span> lPrice;
<a name="l00944"></a>00944 }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946 
<a name="l00947"></a>00947 <span class="comment">// returns 0 if there are no asks. Otherwise returns the value of the lowest ask on the market.</span>
<a name="l00948"></a><a class="code" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">00948</a> int64_t <a class="code" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">OTMarket::GetLowestAskPrice</a>()
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950     int64_t lPrice = 0;
<a name="l00951"></a>00951     
<a name="l00952"></a>00952     mapOfOffers::iterator ii = m_mapAsks.begin();
<a name="l00953"></a>00953     
<a name="l00954"></a>00954     <span class="keywordflow">if</span> (ii != m_mapAsks.end())
<a name="l00955"></a>00955     {       
<a name="l00956"></a>00956         lPrice = (*ii).first;
<a name="l00957"></a>00957         
<a name="l00958"></a>00958         <span class="comment">// Market orders have a 0 price, so we need to skip any if they are here.</span>
<a name="l00959"></a>00959         <span class="comment">//</span>
<a name="l00960"></a>00960         <span class="comment">// Note that we don&#39;t have to do this with the highest bid price (above</span>
<a name="l00961"></a>00961         <span class="comment">// function) but in the case of asks, a &quot;0 price&quot; will undercut the other</span>
<a name="l00962"></a>00962         <span class="comment">// actual prices, so we need to skip any that have a 0 price.</span>
<a name="l00963"></a>00963         <span class="comment">//</span>
<a name="l00964"></a>00964         <span class="keywordflow">while</span> (0 == lPrice)
<a name="l00965"></a>00965         {
<a name="l00966"></a>00966             ++ii;
<a name="l00967"></a>00967             <span class="comment">// -------</span>
<a name="l00968"></a>00968             <span class="keywordflow">if</span> (ii == m_mapAsks.end())
<a name="l00969"></a>00969                 <span class="keywordflow">break</span>;
<a name="l00970"></a>00970             <span class="comment">// -------</span>
<a name="l00971"></a>00971             lPrice = (*ii).first;
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974     
<a name="l00975"></a>00975     <span class="keywordflow">return</span> lPrice;
<a name="l00976"></a>00976 }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 <span class="comment">// This utility function is used directly below (only).</span>
<a name="l00980"></a><a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">00980</a> <span class="keywordtype">void</span> <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(<a class="code" href="class_o_t_account.html">OTAccount</a> * p1, <a class="code" href="class_o_t_account.html">OTAccount</a> * p2, <a class="code" href="class_o_t_account.html">OTAccount</a> * p3, <a class="code" href="class_o_t_account.html">OTAccount</a> * p4)
<a name="l00981"></a>00981 {
<a name="l00982"></a>00982     <span class="keywordflow">if</span> (p1)
<a name="l00983"></a>00983         <span class="keyword">delete</span> p1;
<a name="l00984"></a>00984     <span class="keywordflow">if</span> (p2)
<a name="l00985"></a>00985         <span class="keyword">delete</span> p2;
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (p3)
<a name="l00987"></a>00987         <span class="keyword">delete</span> p3;
<a name="l00988"></a>00988     <span class="keywordflow">if</span> (p4)
<a name="l00989"></a>00989         <span class="keyword">delete</span> p4;
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 <span class="comment">// This utility function is used directly below (only).</span>
<a name="l00994"></a>00994 <span class="comment">// It is ASSUMED that the first two accounts are DEBITS, and the second two accounts are CREDITS.</span>
<a name="l00995"></a>00995 <span class="comment">// The bool is the original result of the debit or credit that was attempted (and is now being rolled back.)</span>
<a name="l00996"></a>00996 <span class="comment">// so for example, p1 tried to debit, and if it returned true (debit was successful!) then we NEED to roll</span>
<a name="l00997"></a>00997 <span class="comment">// p1 back (since that&#39;s what this function does.)</span>
<a name="l00998"></a>00998 <span class="comment">// Whereas if it had returned false (debit failed) then the false would be passed in here, and I would know</span>
<a name="l00999"></a>00999 <span class="comment">// NOT to try to credit the account again, since the money never left.  If b1 is false, for each var, do nothing.</span>
<a name="l01000"></a>01000 <span class="comment">// If true, try to roll it back.</span>
<a name="l01001"></a><a class="code" href="_o_t_market_8cpp.html#abbc90643987323e470c2d23f8de34193">01001</a> <span class="keywordtype">void</span> <a class="code" href="_o_t_market_8cpp.html#abbc90643987323e470c2d23f8de34193">rollback_four_accounts</a>(<a class="code" href="class_o_t_account.html">OTAccount</a> &amp; p1, <span class="keywordtype">bool</span> b1, <span class="keyword">const</span> int64_t &amp; a1, <a class="code" href="class_o_t_account.html">OTAccount</a> &amp; p2, <span class="keywordtype">bool</span> b2, <span class="keyword">const</span> int64_t &amp; a2, 
<a name="l01002"></a>01002                             <a class="code" href="class_o_t_account.html">OTAccount</a> &amp; p3, <span class="keywordtype">bool</span> b3, <span class="keyword">const</span> int64_t &amp; a3, <a class="code" href="class_o_t_account.html">OTAccount</a> &amp; p4, <span class="keywordtype">bool</span> b4, <span class="keyword">const</span> int64_t &amp; a4)
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (b1)
<a name="l01005"></a>01005         p1.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(a1);
<a name="l01006"></a>01006     <span class="keywordflow">if</span> (b2)
<a name="l01007"></a>01007         p2.<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(a2);
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (b3)
<a name="l01009"></a>01009         p3.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(a3);
<a name="l01010"></a>01010     <span class="keywordflow">if</span> (b4)
<a name="l01011"></a>01011         p4.<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(a4);
<a name="l01012"></a>01012 }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 <span class="comment">// By the time this is called, we have already verified most things:</span>
<a name="l01016"></a>01016 <span class="comment">// -- The trade and offer belong to each other.</span>
<a name="l01017"></a>01017 <span class="comment">// -- theOtherOffer is a matching offer that was found to exist already on the market.</span>
<a name="l01018"></a>01018 <span class="comment">// -- Both offers have been verified on and to the market. (Their Asset types included.)</span>
<a name="l01019"></a>01019 <span class="comment">// -- theOffer MIGHT be a market order (with 0 price), but theOtherOffer definitely is NOT a market order.</span>
<a name="l01020"></a>01020 <span class="comment">// -- Both offers are within each other&#39;s price limit, if there is one.</span>
<a name="l01021"></a>01021 <span class="comment">// -- Both offers have enough assets for sale/purchase to meet their respective minimums.</span>
<a name="l01022"></a>01022 <span class="comment">// -- TheTrade will get the PriceLimit offered by theOtherOffer, and not vice-versa.</span>
<a name="l01023"></a>01023 <span class="comment">//    (See explanation below this function if you need to know the reasoning.)</span>
<a name="l01024"></a>01024 <span class="comment">//</span>
<a name="l01025"></a>01025 <span class="comment">// Basically, by the time you get to this function, the two offers do not need to be </span>
<a name="l01026"></a>01026 <span class="comment">// verified in terms of whether they can trade. They can DEFINITELY trade, that&#39;s why</span>
<a name="l01027"></a>01027 <span class="comment">// they&#39;re here. So any failures within here will be more related to successfully processing</span>
<a name="l01028"></a>01028 <span class="comment">// that trade, not determining whether to do it. (For example, perhaps one of the accounts</span>
<a name="l01029"></a>01029 <span class="comment">// doesn&#39;t actually have enough money to do the trade... that failure would occur here.)</span>
<a name="l01030"></a>01030 <span class="comment">//</span>
<a name="l01031"></a><a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">01031</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">OTMarket::ProcessTrade</a>(<a class="code" href="class_o_t_trade.html">OTTrade</a> &amp; theTrade, <a class="code" href="class_o_t_offer.html">OTOffer</a> &amp; theOffer, <a class="code" href="class_o_t_offer.html">OTOffer</a> &amp; theOtherOffer)
<a name="l01032"></a>01032 {
<a name="l01033"></a>01033     <a class="code" href="class_o_t_trade.html">OTTrade</a> * pOtherTrade = theOtherOffer.<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>();
<a name="l01034"></a>01034     <a class="code" href="class_o_t_cron.html">OTCron</a>  * pCron       = theTrade.<a class="code" href="class_o_t_cron_item.html#af734ad5d309fcc9b4a60d40d6c30f55a">GetCron</a>();
<a name="l01035"></a>01035     <span class="comment">// --------------------------------------------------</span>
<a name="l01036"></a>01036     <span class="comment">// Make sure have pointer to both trades.</span>
<a name="l01037"></a>01037     <span class="comment">//</span>
<a name="l01038"></a>01038     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>   (NULL != pOtherTrade, <span class="stringliteral">&quot;Offer was on the market, but somehow got into processing without a trade pointer.\n&quot;</span>);
<a name="l01039"></a>01039     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>       (NULL != pCron);    <span class="comment">// Also need the Cron pointer which SHOULD ALWAYS be there.</span>
<a name="l01040"></a>01040     <span class="comment">// --------------------------------------------------</span>
<a name="l01041"></a>01041     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = pCron-&gt;<a class="code" href="class_o_t_cron.html#a7756d0dcc047209ca87632939dc11db3">GetServerNym</a>();
<a name="l01042"></a>01042     
<a name="l01043"></a>01043     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pServerNym,
<a name="l01044"></a>01044                   <span class="stringliteral">&quot;Somehow a Market is running even though there is no Server Nym on the Cron object authorizing the trades.&quot;</span>);
<a name="l01045"></a>01045     <span class="comment">// --------------------------------------------------</span>
<a name="l01046"></a>01046     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(pCron-&gt;<a class="code" href="class_o_t_cron.html#a93b52f56c0de94e53bb05a610830ba4b">GetServerID</a>());
<a name="l01047"></a>01047     
<a name="l01048"></a>01048     <span class="keywordflow">if</span> (pCron-&gt;<a class="code" href="class_o_t_cron.html#ae241ecf6802b59ccde653082f098e80c">GetTransactionCount</a>() &lt; 1)
<a name="l01049"></a>01049     {
<a name="l01050"></a>01050         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed to process trades: Out of transaction numbers!\n&quot;</span>);
<a name="l01051"></a>01051         <span class="keywordflow">return</span>;
<a name="l01052"></a>01052     }
<a name="l01053"></a>01053     <span class="comment">// --------------------------------------------------</span>
<a name="l01054"></a>01054     <span class="comment">// Make sure these two separate trades don&#39;t have the same Account IDs inside</span>
<a name="l01055"></a>01055     <span class="comment">// otherwise we would have to take care not to load them twice, like with the Nyms below.</span>
<a name="l01056"></a>01056     <span class="comment">// (Instead I just disallow the trade entirely.)</span>
<a name="l01057"></a>01057     <span class="comment">//</span>
<a name="l01058"></a>01058     <span class="keywordflow">if</span> ((theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>()     == pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>())   ||
<a name="l01059"></a>01059         (theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>()     == pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()) ||
<a name="l01060"></a>01060         (theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()   == pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>())   ||
<a name="l01061"></a>01061         (theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()   == pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()))
<a name="l01062"></a>01062     {
<a name="l01063"></a>01063         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(5, <span class="stringliteral">&quot;Failed to process trades: they had account IDs in common.\n&quot;</span>);
<a name="l01064"></a>01064         
<a name="l01065"></a>01065         <span class="comment">// No need to remove either of the trades since they might still be valid when</span>
<a name="l01066"></a>01066         <span class="comment">// matched up to others.</span>
<a name="l01067"></a>01067         <span class="comment">// I put the log on the most verbose level because if this happens, it will probably</span>
<a name="l01068"></a>01068         <span class="comment">// happen over and over again. (Unless the market has enough depth to process them</span>
<a name="l01069"></a>01069         <span class="comment">// both out.)</span>
<a name="l01070"></a>01070         
<a name="l01071"></a>01071         <span class="comment">// TODO May need to choose (or add a config option) so server operators can remove the</span>
<a name="l01072"></a>01072         <span class="comment">// oldest or newest trade when this happens, or both. Or it can choose to do nothing,</span>
<a name="l01073"></a>01073         <span class="comment">// and let them both process out with other trades (as this does now.)</span>
<a name="l01074"></a>01074         
<a name="l01075"></a>01075         <span class="keywordflow">return</span>;
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077     <span class="comment">// No need to compare asset types, since those are already verified by the time</span>
<a name="l01078"></a>01078     <span class="comment">// we get here. BUT, when the accounts are actually loaded up, THEN should compare</span>
<a name="l01079"></a>01079     <span class="comment">// the asset types to make sure they were what we expected them to be.</span>
<a name="l01080"></a>01080     
<a name="l01081"></a>01081     <span class="comment">// -------------- Make sure have both nyms loaded and checked out. --------------------------------------------------</span>
<a name="l01082"></a>01082     <span class="comment">// WARNING: 1 or both of the Nyms could be also the Server Nym. They could also be the same Nym, but NOT the Server.</span>
<a name="l01083"></a>01083     <span class="comment">// In all of those different cases, I don&#39;t want to load the same file twice and overwrite it with itself, losing</span>
<a name="l01084"></a>01084     <span class="comment">// half of all my changes. I have to check all three IDs carefully and set the pointers accordingly, and then operate</span>
<a name="l01085"></a>01085     <span class="comment">// using the pointers from there.</span>
<a name="l01086"></a>01086     
<a name="l01087"></a>01087     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  FIRST_NYM_ID(theTrade.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>()),       <span class="comment">// The newest trade&#39;s Nym.</span>
<a name="l01088"></a>01088                         OTHER_NYM_ID(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>()),   <span class="comment">// The Nym of the trade that was already on the market. (Could be same Nym.)</span>
<a name="l01089"></a>01089                         SERVER_NYM_ID(*pServerNym);                     <span class="comment">// The Server Nym (could be one or both of the above.)</span>
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theNym, theOtherNym; <span class="comment">// We MIGHT use ONE, OR BOTH, of these, or none.</span>
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     <span class="comment">// Find out if either Nym is actually also the server.</span>
<a name="l01094"></a>01094     <span class="keywordtype">bool</span> bFirstNymIsServerNym   = ((FIRST_NYM_ID == SERVER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l01095"></a>01095     <span class="keywordtype">bool</span> bOtherNymIsServerNym   = ((OTHER_NYM_ID == SERVER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l01096"></a>01096     
<a name="l01097"></a>01097     <span class="comment">// We also see, after all that is done, whether both pointers go to the same entity. We&#39;ll want to know that later.</span>
<a name="l01098"></a>01098     <span class="keywordtype">bool</span> bTradersAreSameNym     = ((FIRST_NYM_ID == OTHER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l01099"></a>01099     
<a name="l01100"></a>01100     <span class="comment">// Initially both nym pointers are set to their own blank objects</span>
<a name="l01101"></a>01101     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pFirstNym = NULL;
<a name="l01102"></a>01102     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pOtherNym = NULL;
<a name="l01103"></a>01103     
<a name="l01104"></a>01104     <span class="comment">// Unless either of them is actually the server,</span>
<a name="l01105"></a>01105     <span class="comment">// in which case the pointer is re-pointed to the server Nym.</span>
<a name="l01106"></a>01106     <span class="keywordflow">if</span> (bFirstNymIsServerNym)       <span class="comment">// If the First Nym is the server, then just point to that.</span>
<a name="l01107"></a>01107     {
<a name="l01108"></a>01108         pFirstNym = pServerNym;
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110     <span class="keywordflow">else</span>    <span class="comment">// Else load the First Nym from storage.</span>
<a name="l01111"></a>01111     {
<a name="l01112"></a>01112         theNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(FIRST_NYM_ID);  <span class="comment">// theNym is pFirstNym</span>
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>())
<a name="l01115"></a>01115         {
<a name="l01116"></a>01116             <a class="code" href="class_o_t_string.html">OTString</a> strNymID(FIRST_NYM_ID);
<a name="l01117"></a>01117             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading First Nym public key in OTMarket::%s: %s\n&quot;</span>,
<a name="l01118"></a>01118                           __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01119"></a>01119             theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l01120"></a>01120             <span class="keywordflow">return</span>;
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122         
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>()                &amp;&amp; 
<a name="l01124"></a>01124             theTrade.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp; 
<a name="l01125"></a>01125             theOffer.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp;
<a name="l01126"></a>01126             theNym.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(*pServerNym)) <span class="comment">// ServerNym here is not theNym&#39;s identity, but merely the signer on this file.</span>
<a name="l01127"></a>01127         {
<a name="l01128"></a>01128             pFirstNym = &amp;theNym; <span class="comment">//  &lt;=====</span>
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130         <span class="keywordflow">else</span> 
<a name="l01131"></a>01131         {
<a name="l01132"></a>01132             <a class="code" href="class_o_t_string.html">OTString</a> strNymID(FIRST_NYM_ID);
<a name="l01133"></a>01133             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTMarket::%s: Failure verifying trade, offer, or nym, or loading signed Nymfile: %s\n&quot;</span>,
<a name="l01134"></a>01134                           __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01135"></a>01135             theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l01136"></a>01136             <span class="keywordflow">return</span>;         
<a name="l01137"></a>01137         }
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01140"></a>01140     <span class="keywordflow">if</span> (bOtherNymIsServerNym)    <span class="comment">// If the Other Nym is the server, then just point to that.</span>
<a name="l01141"></a>01141     {
<a name="l01142"></a>01142         pOtherNym = pServerNym;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTradersAreSameNym) <span class="comment">// Else if the Traders are the same Nym, point to the one we already loaded.</span>
<a name="l01145"></a>01145     {
<a name="l01146"></a>01146         pOtherNym = pFirstNym; <span class="comment">// theNym is pFirstNym</span>
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148     <span class="keywordflow">else</span>    <span class="comment">// Otherwise load the Other Nym from Disk and point to that.</span>
<a name="l01149"></a>01149     {
<a name="l01150"></a>01150         theOtherNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(OTHER_NYM_ID);
<a name="l01151"></a>01151 
<a name="l01152"></a>01152         <span class="keywordflow">if</span> (<span class="keyword">false</span> == theOtherNym.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>())
<a name="l01153"></a>01153         {
<a name="l01154"></a>01154             <a class="code" href="class_o_t_string.html">OTString</a> strNymID(OTHER_NYM_ID);
<a name="l01155"></a>01155             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading Other Nym public key in OTMarket::%s: %s\n&quot;</span>,
<a name="l01156"></a>01156                           __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01157"></a>01157             pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l01158"></a>01158             <span class="keywordflow">return</span>;
<a name="l01159"></a>01159         }
<a name="l01160"></a>01160         
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (theOtherNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>()               &amp;&amp; 
<a name="l01162"></a>01162             pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp; 
<a name="l01163"></a>01163             theOtherOffer.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)  &amp;&amp;
<a name="l01164"></a>01164             theOtherNym.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(*pServerNym))
<a name="l01165"></a>01165         {
<a name="l01166"></a>01166             pOtherNym = &amp;theOtherNym; <span class="comment">//  &lt;=====</span>
<a name="l01167"></a>01167         }
<a name="l01168"></a>01168         <span class="keywordflow">else</span> 
<a name="l01169"></a>01169         {
<a name="l01170"></a>01170             <a class="code" href="class_o_t_string.html">OTString</a> strNymID(OTHER_NYM_ID);
<a name="l01171"></a>01171             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading or verifying Other Nym public key in OTMarket::%s: %s\n&quot;</span>,
<a name="l01172"></a>01172                           __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01173"></a>01173             pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l01174"></a>01174             <span class="keywordflow">return</span>;         
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01178"></a>01178     <span class="comment">// AT THIS POINT, I have pServerNym, pFirstNym, and pOtherNym.</span>
<a name="l01179"></a>01179     <span class="comment">// ALL are loaded from disk (where necessary.) AND...</span>
<a name="l01180"></a>01180     <span class="comment">// ALL are valid pointers, (even if they sometimes point to the same object,)</span>
<a name="l01181"></a>01181     <span class="comment">// AND none are capable of overwriting the storage of the other (by accidentally</span>
<a name="l01182"></a>01182     <span class="comment">// loading the same storage twice.)</span>
<a name="l01183"></a>01183     <span class="comment">// We also have boolean variables at this point to tell us exactly which are which,</span>
<a name="l01184"></a>01184     <span class="comment">// (in case some of those pointers do go to the same object.) </span>
<a name="l01185"></a>01185     <span class="comment">// They are:</span>
<a name="l01186"></a>01186     <span class="comment">// bFirstNymIsServerNym, bOtherNymIsServerNym, and bTradersAreSameNym.</span>
<a name="l01187"></a>01187     <span class="comment">//</span>
<a name="l01188"></a>01188     <span class="comment">// We also have theTrade, theOffer, pOtherTrade, and theOtherOffer, </span>
<a name="l01189"></a>01189     <span class="comment">// and we know they are all good also.</span>
<a name="l01190"></a>01190     <span class="comment">//</span>
<a name="l01191"></a>01191     <span class="comment">// We also know that pOtherTrade/theOtherOffer are a Limit order (NOT a Market order.)</span>
<a name="l01192"></a>01192     <span class="comment">// (Meaning pOtherTrade/theOtherOffer definitely has a price set.)</span>
<a name="l01193"></a>01193     <span class="comment">//</span>
<a name="l01194"></a>01194     <span class="comment">// We also know that theTrade/theOffer MIGHT be a Limit order OR a Market order.</span>
<a name="l01195"></a>01195     <span class="comment">// (Meaning theTrade/theOffer MIGHT have a 0 price.)</span>
<a name="l01196"></a>01196     <span class="comment">//</span>
<a name="l01197"></a>01197     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01198"></a>01198     <span class="comment">// Make sure have ALL FOUR accounts loaded and checked out.</span>
<a name="l01199"></a>01199     <span class="comment">// (first nym&#39;s asset/currency, and other nym&#39;s asset/currency.)</span>
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <a class="code" href="class_o_t_account.html">OTAccount</a> * pFirstAssetAcct     = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),        SERVER_ID);
<a name="l01202"></a>01202     <a class="code" href="class_o_t_account.html">OTAccount</a> * pFirstCurrencyAcct  = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),      SERVER_ID);
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     <a class="code" href="class_o_t_account.html">OTAccount</a> * pOtherAssetAcct     = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),    SERVER_ID);
<a name="l01205"></a>01205     <a class="code" href="class_o_t_account.html">OTAccount</a> * pOtherCurrencyAcct  = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),  SERVER_ID);
<a name="l01206"></a>01206     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01207"></a>01207     <span class="keywordflow">if</span> ((NULL == pFirstAssetAcct)       ||
<a name="l01208"></a>01208         (NULL == pFirstCurrencyAcct))
<a name="l01209"></a>01209     {
<a name="l01210"></a>01210         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying existence of one of the first trader&#39;s accounts during attempted Market trade.\n&quot;</span>);
<a name="l01211"></a>01211         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01212"></a>01212         theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01213"></a>01213         <span class="keywordflow">return</span>;
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01216"></a>01216     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pOtherAssetAcct)      ||
<a name="l01217"></a>01217              (NULL == pOtherCurrencyAcct))
<a name="l01218"></a>01218     {
<a name="l01219"></a>01219         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying existence of one of the second trader&#39;s accounts during attempted Market trade.\n&quot;</span>);
<a name="l01220"></a>01220         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01221"></a>01221         pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01222"></a>01222         <span class="keywordflow">return</span>;
<a name="l01223"></a>01223     }
<a name="l01224"></a>01224     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01225"></a>01225     <span class="comment">// Are the accounts of the first trader of the right asset types?</span>
<a name="l01226"></a>01226     <span class="comment">// We already know the asset types matched as far as the market, trades, and offers were concerned.</span>
<a name="l01227"></a>01227     <span class="comment">// But only once the accounts themselves have been loaded can we VERIFY this to be true.</span>
<a name="l01228"></a>01228     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pFirstAssetAcct   -&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()) || <span class="comment">// the trader&#39;s asset accts have same asset type as the market.</span>
<a name="l01229"></a>01229              (pFirstCurrencyAcct-&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>()) <span class="comment">// the trader&#39;s currency accts have same asset type as the market.</span>
<a name="l01230"></a>01230              )
<a name="l01231"></a>01231     {       
<a name="l01232"></a>01232         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR - First Trader has accounts of wrong &quot;</span>
<a name="l01233"></a>01233                       <span class="stringliteral">&quot;asset types in OTMarket::%s\n&quot;</span>, __FUNCTION__);
<a name="l01234"></a>01234         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01235"></a>01235         theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01236"></a>01236         <span class="keywordflow">return</span>;
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01239"></a>01239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pOtherAssetAcct   -&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()) ||  <span class="comment">// the trader&#39;s asset accts have same asset type as the market.</span>
<a name="l01240"></a>01240              (pOtherCurrencyAcct-&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>())) <span class="comment">// the trader&#39;s currency accts have same asset type as market.</span>
<a name="l01241"></a>01241     {
<a name="l01242"></a>01242         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR - Other Trader has accounts of wrong &quot;</span>
<a name="l01243"></a>01243                       <span class="stringliteral">&quot;asset types in OTMarket::%s\n&quot;</span>, __FUNCTION__);
<a name="l01244"></a>01244         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01245"></a>01245         pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01246"></a>01246         <span class="keywordflow">return</span>;
<a name="l01247"></a>01247     }
<a name="l01248"></a>01248     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01249"></a>01249     <span class="comment">// Make sure all accounts are signed by the server and have the owner they are expected to have.</span>
<a name="l01250"></a>01250         
<a name="l01251"></a>01251     <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
<a name="l01252"></a>01252     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!pFirstAssetAcct   -&gt;VerifyOwner(*pFirstNym) || !pFirstAssetAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) ||
<a name="l01253"></a>01253              (!pFirstCurrencyAcct-&gt;VerifyOwner(*pFirstNym) || !pFirstCurrencyAcct-&gt;VerifySignature(*pServerNym)))
<a name="l01254"></a>01254     {
<a name="l01255"></a>01255         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR verifying ownership or signature on one of first trader&#39;s accounts in OTMarket::%s\n&quot;</span>,
<a name="l01256"></a>01256                       __FUNCTION__);
<a name="l01257"></a>01257         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01258"></a>01258         theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01259"></a>01259         <span class="keywordflow">return</span>;
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01262"></a>01262     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!pOtherAssetAcct   -&gt;VerifyOwner(*pOtherNym) || !pOtherAssetAcct-&gt;VerifySignature(*pServerNym) ) ||
<a name="l01263"></a>01263              (!pOtherCurrencyAcct-&gt;VerifyOwner(*pOtherNym) || !pOtherCurrencyAcct-&gt;VerifySignature(*pServerNym)))
<a name="l01264"></a>01264     {
<a name="l01265"></a>01265         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR verifying ownership or signature on one of other trader&#39;s accounts in OTMarket::%s\n&quot;</span>,
<a name="l01266"></a>01266                       __FUNCTION__);
<a name="l01267"></a>01267         <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01268"></a>01268         pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01269"></a>01269         <span class="keywordflow">return</span>;
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01272"></a>01272     <span class="comment">// By this point, I know I have all four accounts loaded, and I know that they have the right asset types,</span>
<a name="l01273"></a>01273     <span class="comment">// and I know they have the right owners and they were all signed by the server.</span>
<a name="l01274"></a>01274     <span class="comment">// I also know that their account IDs in their internal records matched the account filename for each acct.</span>
<a name="l01275"></a>01275     <span class="comment">// I also have pointers to the Nyms who own these accounts, as well as the Trades and Offers associated with them.</span>
<a name="l01276"></a>01276     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01277"></a>01277     <span class="keywordflow">else</span>
<a name="l01278"></a>01278     {           
<a name="l01279"></a>01279         <span class="comment">// Okay then, everything checks out. Let&#39;s add this to the sender&#39;s outbox and the recipient&#39;s inbox. </span>
<a name="l01280"></a>01280         <span class="comment">// IF they can be loaded up from file, or generated, that is. </span>
<a name="l01281"></a>01281         
<a name="l01282"></a>01282         <span class="comment">// Load the inbox/outbox in case they already exist</span>
<a name="l01283"></a>01283         <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theFirstAssetInbox      (FIRST_NYM_ID, theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),      SERVER_ID),
<a name="l01284"></a>01284                     theFirstCurrencyInbox   (FIRST_NYM_ID, theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),    SERVER_ID),
<a name="l01285"></a>01285                     theOtherAssetInbox      (OTHER_NYM_ID, pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),  SERVER_ID),
<a name="l01286"></a>01286                     theOtherCurrencyInbox   (OTHER_NYM_ID, pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),SERVER_ID);
<a name="l01287"></a>01287         
<a name="l01288"></a>01288         <span class="comment">// ALL inboxes -- no outboxes. All will receive notification of something ALREADY DONE.</span>
<a name="l01289"></a>01289         <span class="keywordtype">bool</span> bSuccessLoadingFirstAsset      = theFirstAssetInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>();
<a name="l01290"></a>01290         <span class="keywordtype">bool</span> bSuccessLoadingFirstCurrency   = theFirstCurrencyInbox.LoadInbox();
<a name="l01291"></a>01291         <span class="keywordtype">bool</span> bSuccessLoadingOtherAsset      = theOtherAssetInbox.LoadInbox();
<a name="l01292"></a>01292         <span class="keywordtype">bool</span> bSuccessLoadingOtherCurrency   = theOtherCurrencyInbox.LoadInbox();
<a name="l01293"></a>01293         <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01294"></a>01294         <span class="comment">// ...or generate them otherwise...</span>
<a name="l01295"></a>01295         
<a name="l01296"></a>01296         <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingFirstAsset)
<a name="l01297"></a>01297             bSuccessLoadingFirstAsset       = theFirstAssetInbox.VerifyAccount(*pServerNym);
<a name="l01298"></a>01298         <span class="keywordflow">else</span>
<a name="l01299"></a>01299             bSuccessLoadingFirstAsset       = theFirstAssetInbox.GenerateLedger(theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),
<a name="l01300"></a>01300                                                                                 SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l01301"></a>01301         
<a name="l01302"></a>01302         <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingFirstCurrency)
<a name="l01303"></a>01303             bSuccessLoadingFirstCurrency    = theFirstCurrencyInbox.VerifyAccount(*pServerNym);
<a name="l01304"></a>01304         <span class="keywordflow">else</span>
<a name="l01305"></a>01305             bSuccessLoadingFirstCurrency    = theFirstCurrencyInbox.GenerateLedger(theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),
<a name="l01306"></a>01306                                                                                    SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l01307"></a>01307         
<a name="l01308"></a>01308         <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOtherAsset)
<a name="l01309"></a>01309             bSuccessLoadingOtherAsset       = theOtherAssetInbox.VerifyAccount(*pServerNym);
<a name="l01310"></a>01310         <span class="keywordflow">else</span>
<a name="l01311"></a>01311             bSuccessLoadingOtherAsset       = theOtherAssetInbox.GenerateLedger(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),
<a name="l01312"></a>01312                                                                                 SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l01313"></a>01313         
<a name="l01314"></a>01314         <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOtherCurrency)
<a name="l01315"></a>01315             bSuccessLoadingOtherCurrency    = theOtherCurrencyInbox.VerifyAccount(*pServerNym);
<a name="l01316"></a>01316         <span class="keywordflow">else</span>
<a name="l01317"></a>01317             bSuccessLoadingOtherCurrency    = theOtherCurrencyInbox.GenerateLedger(pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),
<a name="l01318"></a>01318                                                                                    SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l01319"></a>01319         <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01320"></a>01320         <span class="keywordflow">if</span> ((<span class="keyword">false</span> == bSuccessLoadingFirstAsset)    ||
<a name="l01321"></a>01321             (<span class="keyword">false</span> == bSuccessLoadingFirstCurrency))
<a name="l01322"></a>01322         {
<a name="l01323"></a>01323             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading or generating an inbox for first trader in OTMarket::%s.\n&quot;</span>,
<a name="l01324"></a>01324                           __FUNCTION__);
<a name="l01325"></a>01325             <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01326"></a>01326             theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01327"></a>01327             <span class="keywordflow">return</span>;
<a name="l01328"></a>01328         }
<a name="l01329"></a>01329         <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01330"></a>01330         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">false</span> == bSuccessLoadingOtherAsset)   ||
<a name="l01331"></a>01331                  (<span class="keyword">false</span> == bSuccessLoadingOtherCurrency))
<a name="l01332"></a>01332         {
<a name="l01333"></a>01333             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading or generating an inbox for other trader in OTMarket::%s.\n&quot;</span>,
<a name="l01334"></a>01334                           __FUNCTION__);
<a name="l01335"></a>01335             <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01336"></a>01336             pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
<a name="l01337"></a>01337             <span class="keywordflow">return</span>;
<a name="l01338"></a>01338         }
<a name="l01339"></a>01339         <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01340"></a>01340         <span class="keywordflow">else</span>
<a name="l01341"></a>01341         {
<a name="l01342"></a>01342             <span class="comment">// Generate new transaction numbers for these new transactions</span>
<a name="l01343"></a>01343             int64_t lNewTransactionNumber = pCron-&gt;<a class="code" href="class_o_t_cron.html#a22822e0aeced441b6404cd8a2c8e00da">GetNextTransactionNumber</a>();
<a name="l01344"></a>01344             
<a name="l01345"></a>01345 <span class="comment">//          OT_ASSERT(lNewTransactionNumber &gt; 0); // this can be my reminder.           </span>
<a name="l01346"></a>01346             <span class="keywordflow">if</span> (0 == lNewTransactionNumber)
<a name="l01347"></a>01347             {
<a name="l01348"></a>01348                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;WARNING: Market is unable to process because there are no more transaction numbers available.\n&quot;</span>);
<a name="l01349"></a>01349                 <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l01350"></a>01350                 <span class="comment">// (Here I flag neither trade for removal.)</span>
<a name="l01351"></a>01351                 <span class="keywordflow">return</span>;             
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353             
<a name="l01354"></a>01354             <span class="comment">// Why a new transaction number here?</span>
<a name="l01355"></a>01355             <span class="comment">// </span>
<a name="l01356"></a>01356             <span class="comment">// Each user had to burn one of his own numbers to generate his own Trade.</span>
<a name="l01357"></a>01357             <span class="comment">//</span>
<a name="l01358"></a>01358             <span class="comment">// So the First Trader might have used number 345, and the Other Trader might have</span>
<a name="l01359"></a>01359             <span class="comment">// used the number 912. Those numbers were used to CREATE the Trades initially, and</span>
<a name="l01360"></a>01360             <span class="comment">// they can be used to lookup the original trade request from each user.</span>
<a name="l01361"></a>01361             <span class="comment">//</span>
<a name="l01362"></a>01362             <span class="comment">// So whenever I give a receipt to either Trader, I am sure to tell Trader A that</span>
<a name="l01363"></a>01363             <span class="comment">// this is in reference to transaction 345, and I tell Trader B that this is in</span>
<a name="l01364"></a>01364             <span class="comment">// reference to transaction 912.</span>
<a name="l01365"></a>01365             <span class="comment">//</span>
<a name="l01366"></a>01366             <span class="comment">// I also have to get a new transaction number (here) because the first two numbers</span>
<a name="l01367"></a>01367             <span class="comment">// were requests signed by the users to post the trades. That was completed--those</span>
<a name="l01368"></a>01368             <span class="comment">// numbers have been used now, and they could not be used again without introducing</span>
<a name="l01369"></a>01369             <span class="comment">// duplication and confusion. To remove money from someone&#39;s account, which we have just</span>
<a name="l01370"></a>01370             <span class="comment">// done, you need a new transaction number for that! Because you need a new number if</span>
<a name="l01371"></a>01371             <span class="comment">// you&#39;re going to put some new receipt in their inbox, which is exactly what we are </span>
<a name="l01372"></a>01372             <span class="comment">// doing right now.</span>
<a name="l01373"></a>01373             <span class="comment">// </span>
<a name="l01374"></a>01374             <span class="comment">// So let&#39;s say I generate transaction # 10023 to represent this money exchange that has</span>
<a name="l01375"></a>01375             <span class="comment">// just occurred between these two traders.  To me as a user, 345 was my original request</span>
<a name="l01376"></a>01376             <span class="comment">// to post the trade, 912 was the other guy&#39;s request to post his trade, and 10023 was</span>
<a name="l01377"></a>01377             <span class="comment">// the server&#39;s transferring funds (based on the authorization in those trades). Put</span>
<a name="l01378"></a>01378             <span class="comment">// another way, 345 has my signature, 912 has the other trader&#39;s signature, and 10023</span>
<a name="l01379"></a>01379             <span class="comment">// has the server&#39;s signature.</span>
<a name="l01380"></a>01380 
<a name="l01381"></a>01381             
<a name="l01382"></a>01382             <span class="comment">// Start generating the receipts (for all four inboxes.)</span>
<a name="l01383"></a>01383             
<a name="l01384"></a>01384             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans1     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFirstAssetInbox, 
<a name="l01385"></a>01385                                                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
<a name="l01386"></a>01386             
<a name="l01387"></a>01387             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans2     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFirstCurrencyInbox, 
<a name="l01388"></a>01388                                                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
<a name="l01389"></a>01389             
<a name="l01390"></a>01390             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans3     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theOtherAssetInbox, 
<a name="l01391"></a>01391                                                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
<a name="l01392"></a>01392             
<a name="l01393"></a>01393             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans4     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theOtherCurrencyInbox, 
<a name="l01394"></a>01394                                                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
<a name="l01395"></a>01395             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01396"></a>01396             <span class="comment">// (No need to OT_ASSERT on the above transactions since it occurs in GenerateTransaction().)</span>
<a name="l01397"></a>01397             
<a name="l01398"></a>01398             <span class="comment">// All four inboxes will get receipts with the same (new) transaction ID.</span>
<a name="l01399"></a>01399             <span class="comment">// They all have a &quot;reference to&quot; containing the original trade.</span>
<a name="l01400"></a>01400             <span class="comment">// The first two will contain theTrade as the reference field,</span>
<a name="l01401"></a>01401             <span class="comment">// but the second two contain pOtherTrade as the reference field.</span>
<a name="l01402"></a>01402             <span class="comment">// The first two also thus reference a different original transaction number than the other two.</span>
<a name="l01403"></a>01403             <span class="comment">// That&#39;s because each end of the trade was originally authorized separately by each trader, and</span>
<a name="l01404"></a>01404             <span class="comment">// in each case he used his own unique transaction number to do so.</span>
<a name="l01405"></a>01405             
<a name="l01406"></a>01406             <span class="comment">// set up the transaction items (each transaction may have multiple items... but not in this case.)</span>
<a name="l01407"></a>01407             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem1     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans1, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
<a name="l01408"></a>01408             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem2     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans2, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
<a name="l01409"></a>01409             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem3     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans3, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
<a name="l01410"></a>01410             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem4     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans4, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
<a name="l01411"></a>01411             
<a name="l01412"></a>01412             <span class="comment">// these may be unnecessary, I&#39;ll have to check CreateItemFromTransaction. I&#39;ll leave em.</span>
<a name="l01413"></a>01413             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem1);  <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem2);
<a name="l01414"></a>01414             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem3);  <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem4);
<a name="l01415"></a>01415             
<a name="l01416"></a>01416             pItem1-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
<a name="l01417"></a>01417             pItem2-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
<a name="l01418"></a>01418             pItem3-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
<a name="l01419"></a>01419             pItem4-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
<a name="l01420"></a>01420             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01421"></a>01421             <span class="comment">// Calculate the amount and remove / add it to the relevant accounts.</span>
<a name="l01422"></a>01422             <span class="comment">// Make sure each Account can afford it, and roll back in case of failure.</span>
<a name="l01423"></a>01423             
<a name="l01424"></a>01424             <span class="keywordtype">bool</span> bMove1 = <span class="keyword">false</span>;
<a name="l01425"></a>01425             <span class="keywordtype">bool</span> bMove2 = <span class="keyword">false</span>;
<a name="l01426"></a>01426             <span class="keywordtype">bool</span> bMove3 = <span class="keyword">false</span>;
<a name="l01427"></a>01427             <span class="keywordtype">bool</span> bMove4 = <span class="keyword">false</span>;
<a name="l01428"></a>01428             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01429"></a>01429             <span class="comment">// -- TheTrade will get the PriceLimit offered by theOtherOffer, and not vice-versa.</span>
<a name="l01430"></a>01430             <span class="comment">//    (See explanation below this function if you need to know the reasoning.)</span>
<a name="l01431"></a>01431 
<a name="l01432"></a>01432             <span class="comment">// NOTICE: This is one of the reasons why theOtherOffer CANNOT be a Market order,</span>
<a name="l01433"></a>01433             <span class="comment">// because we will be using his price limit to determine the price.</span>
<a name="l01434"></a>01434             <span class="comment">// (Another reason FYI, is because Market Orders are only allowed to process once,</span>
<a name="l01435"></a>01435             <span class="comment">// IN TURN.)</span>
<a name="l01436"></a>01436             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01437"></a>01437             <span class="comment">// Some logic described:</span>
<a name="l01438"></a>01438             <span class="comment">//</span>
<a name="l01439"></a>01439             <span class="comment">// Calculate the price</span>
<a name="l01440"></a>01440             <span class="comment">// I know the amount available for trade is at LEAST the minimum increment on both</span>
<a name="l01441"></a>01441             <span class="comment">// sides, since that was validated before this function was even called. Therefore,</span>
<a name="l01442"></a>01442             <span class="comment">// let&#39;s calculate a price based on the largest of the two minimum increments.</span>
<a name="l01443"></a>01443             <span class="comment">// Figure out which is largest, then divide that by the scale to get the multiplier.</span>
<a name="l01444"></a>01444             <span class="comment">// Multiply THAT by the theOtherOffer&#39;s Price Limit to get the price per minimum increment.</span>
<a name="l01445"></a>01445             <span class="comment">//</span>
<a name="l01446"></a>01446             <span class="comment">// Since we are calculating the MINIMUM that must be processed per round, let&#39;s also</span>
<a name="l01447"></a>01447             <span class="comment">// calculate the MOST that could be traded between these two offers. Then let&#39;s </span>
<a name="l01448"></a>01448             <span class="comment">// mod that to the Scale and remove the remainder, then divide by the Scale and</span>
<a name="l01449"></a>01449             <span class="comment">// multiply by the price (to get the MOST that would have to be paid, if the offers</span>
<a name="l01450"></a>01450             <span class="comment">// fulfilled each other to the maximum possible according to their limits.)</span>
<a name="l01451"></a>01451             <span class="comment">// !! It&#39;s better to process it all at once and avoid the loop entirely.</span>
<a name="l01452"></a>01452             <span class="comment">// Plus, there&#39;s SUPPOSED to be enough funds in all the accounts to cover it.</span>
<a name="l01453"></a>01453             <span class="comment">//</span>
<a name="l01454"></a>01454             <span class="comment">// Anyway, if there aren&#39;t:</span>
<a name="l01455"></a>01455             <span class="comment">//</span>
<a name="l01456"></a>01456             <span class="comment">// Then LOOP (while available &gt;= minimum increment) on both sides of the trade</span>
<a name="l01457"></a>01457             <span class="comment">// Inside, try to move funds across all 4 accounts. If any of them fail, roll them </span>
<a name="l01458"></a>01458             <span class="comment">// back and break. (I&#39;ll check balances first to avoid this.)</span>
<a name="l01459"></a>01459             <span class="comment">// As long as there&#39;s enough available in the accounts to continue exchanging the</span>
<a name="l01460"></a>01460             <span class="comment">// largest minimum increment, then keep looping like this and moving the digital assets.</span>
<a name="l01461"></a>01461             <span class="comment">// Each time, also, be sure to update the Offer so that less and less is available on each trade.</span>
<a name="l01462"></a>01462             <span class="comment">// At some point, the Trades will run out of authorization to transfer any more from the accounts.</span>
<a name="l01463"></a>01463             <span class="comment">// Perhaps one has a 10,000 bushel total limit and it has been reached. The trade is complete,</span>
<a name="l01464"></a>01464             <span class="comment">// from his side of it, anyway. Then the loop will be over for sure.</span>
<a name="l01465"></a>01465             
<a name="l01466"></a>01466                     
<a name="l01467"></a>01467             <a class="code" href="class_o_t_account.html">OTAccount</a> * pAssetAccountToDebit     = NULL;
<a name="l01468"></a>01468             <a class="code" href="class_o_t_account.html">OTAccount</a> * pAssetAccountToCredit    = NULL;
<a name="l01469"></a>01469             <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAccountToDebit  = NULL;
<a name="l01470"></a>01470             <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAccountToCredit = NULL;
<a name="l01471"></a>01471             
<a name="l01472"></a>01472             <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()) <span class="comment">// I&#39;m selling, he&#39;s buying</span>
<a name="l01473"></a>01473             {
<a name="l01474"></a>01474                 pAssetAccountToDebit     = pFirstAssetAcct;    <span class="comment">// I am selling gold. When I sell, my gold balance goes down.</span>
<a name="l01475"></a>01475                 pAssetAccountToCredit    = pOtherAssetAcct;    <span class="comment">// He is bidding on gold. When he buys, his gold balance goes up.</span>
<a name="l01476"></a>01476                 pCurrencyAccountToDebit  = pOtherCurrencyAcct; <span class="comment">// He is paying in dollars. When he pays, his dollar balance goes down.</span>
<a name="l01477"></a>01477                 pCurrencyAccountToCredit = pFirstCurrencyAcct; <span class="comment">// I am being paid in dollars. When I get paid, my dollar balance goes up.</span>
<a name="l01478"></a>01478             }
<a name="l01479"></a>01479             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01480"></a>01480             <span class="keywordflow">else</span>    <span class="comment">// I&#39;m buying, he&#39;s selling</span>
<a name="l01481"></a>01481             {
<a name="l01482"></a>01482                 pAssetAccountToDebit     = pOtherAssetAcct;    <span class="comment">// He is selling gold. When he sells, his gold balance goes down.</span>
<a name="l01483"></a>01483                 pAssetAccountToCredit    = pFirstAssetAcct;    <span class="comment">// I am bidding on gold. When I buy, my gold balance goes up.</span>
<a name="l01484"></a>01484                 pCurrencyAccountToDebit  = pFirstCurrencyAcct; <span class="comment">// I am paying in dollars. When I pay, my dollar balance goes down.</span>
<a name="l01485"></a>01485                 pCurrencyAccountToCredit = pOtherCurrencyAcct; <span class="comment">// He is being paid in dollars. When he gets paid, his dollar balance goes up.</span>
<a name="l01486"></a>01486             }
<a name="l01487"></a>01487             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01488"></a>01488             <span class="comment">// Calculate minimum increment to be traded each round.</span>
<a name="l01489"></a>01489             int64_t lMinIncrementPerRound =
<a name="l01490"></a>01490                 ((theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOtherOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>()) ?
<a name="l01491"></a>01491                   theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() : theOtherOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>());
<a name="l01492"></a>01492             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01493"></a>01493             <span class="keyword">const</span> int64_t lMultiplier = (lMinIncrementPerRound / <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());   <span class="comment">// If the Market scale is 10, and the minimum increment is 50, multiplier is 5..</span>
<a name="l01494"></a>01494                                                                             <span class="comment">// The price limit is per scale. (Per 10.) So if 1oz gold is $1300, then 10oz scale</span>
<a name="l01495"></a>01495                                                                             <span class="comment">// would be $13,000. So if my price limit is per SCALE, I might set my limit</span>
<a name="l01496"></a>01496                                                                             <span class="comment">// to $12,000 or $13,000 (PER 10 OZ OF GOLD, which is the SCALE for this market.)</span>
<a name="l01497"></a>01497             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01498"></a>01498             <span class="comment">// Calc price of each round.</span>
<a name="l01499"></a>01499             int64_t lPrice = ( lMultiplier * theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() );   <span class="comment">// So if my minimum increment is 50, then my multiplier is 5, which means</span>
<a name="l01500"></a>01500                                                                             <span class="comment">// multiply my price by 5: $13,000 * 5 == $65,000 for 50 oz. per minimum inc.</span>
<a name="l01501"></a>01501 
<a name="l01502"></a>01502             <span class="comment">// Why am I using the OTHER Offer&#39;s price limit, and not my own?</span>
<a name="l01503"></a>01503             <span class="comment">// See notes at top and bottom of this function for the answer.</span>
<a name="l01504"></a>01504             <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l01505"></a>01505             <span class="comment">// There&#39;s two ways to process this: in rounds (by minimum increment), for which the numbers were</span>
<a name="l01506"></a>01506             <span class="comment">// just calulated above...</span>
<a name="l01507"></a>01507             <span class="comment">// </span>
<a name="l01508"></a>01508             <span class="comment">// ...OR based on whatever is the MOST available from BOTH parties. (Whichever is the least of the </span>
<a name="l01509"></a>01509             <span class="comment">// two parties&#39; &quot;Most Available Left To Trade&quot;.) So I&#39;ll try THAT first, to avoid processing in </span>
<a name="l01510"></a>01510             <span class="comment">// rounds. (Since the funds SHOULD be there...)</span>
<a name="l01511"></a>01511             
<a name="l01512"></a>01512             int64_t lMostAvailable = ((theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()      &gt; theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()) ?
<a name="l01513"></a>01513                                     theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>() : theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>());
<a name="l01514"></a>01514             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01515"></a>01515             int64_t lTemp = lMostAvailable % <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(); <span class="comment">// The Scale may not evenly divide into the amount available</span>
<a name="l01516"></a>01516             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01517"></a>01517             lMostAvailable -= lTemp;    <span class="comment">// We&#39;ll subtract remainder amount, so it&#39;s even to scale (which is how it&#39;s priced.)</span>
<a name="l01518"></a>01518             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01519"></a>01519             <span class="comment">// We KNOW the amount available on the offer is at least as much as the minimum increment (on both sides)</span>
<a name="l01520"></a>01520             <span class="comment">// because that is verified in the caller function. So we KNOW either side can process the minimum, at least</span>
<a name="l01521"></a>01521             <span class="comment">// based on the authorization in the offers (not necessarily in the accounts themselves, though they are </span>
<a name="l01522"></a>01522             <span class="comment">// SUPPOSED to have enough funds to cover it...)</span>
<a name="l01523"></a>01523             <span class="comment">//</span>
<a name="l01524"></a>01524             <span class="comment">// Next question is: can both sides process the MOST AVAILABLE? If so, do THAT, instead of processing by rounds.</span>
<a name="l01525"></a>01525             
<a name="l01526"></a>01526             <span class="keyword">const</span> int64_t lOverallMultiplier = lMostAvailable / <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(); <span class="comment">// Price is per scale  // This line was commented with the line below it. They go together.</span>
<a name="l01527"></a>01527             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01528"></a>01528             <span class="comment">// Why theOtherOffer&#39;s price limit instead of theOffer&#39;s? See notes top/bottom this function.</span>
<a name="l01529"></a>01529             <span class="keyword">const</span> int64_t lMostPrice = ( lOverallMultiplier * theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() );
<a name="l01530"></a>01530             <span class="comment">// TO REMOVE MULTIPLIER FROM PRICE, AT LEAST THE ABOVE LINE WOULD REMOVE MULTIPLIER.</span>
<a name="l01531"></a>01531             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01532"></a>01532             <span class="comment">// To avoid rounds, first I see if I can satisfy the entire order at once on either side...</span>
<a name="l01533"></a>01533             <span class="keywordflow">if</span> ((pAssetAccountToDebit   -&gt;GetBalance() &gt;= lMostAvailable) &amp;&amp;
<a name="l01534"></a>01534                 (pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &gt;= lMostPrice)
<a name="l01535"></a>01535                 )
<a name="l01536"></a>01536             {   <span class="comment">// There&#39;s enough the accounts to do it all at once! No need for rounds.</span>
<a name="l01537"></a>01537                 
<a name="l01538"></a>01538                 lMinIncrementPerRound   = lMostAvailable;
<a name="l01539"></a>01539                 lPrice                  = lMostPrice;
<a name="l01540"></a>01540                 
<a name="l01541"></a>01541                 <span class="comment">// By setting the ABOVE two values the way that I did, it means the below loop</span>
<a name="l01542"></a>01542                 <span class="comment">// will execute properly, BUT ONLY ITERATING ONCE. Basically this section of</span>
<a name="l01543"></a>01543                 <span class="comment">// code just optimizes that loop when possible by allowing it to execute</span>
<a name="l01544"></a>01544                 <span class="comment">// only once.</span>
<a name="l01545"></a>01545             }
<a name="l01546"></a>01546             <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l01547"></a>01547             <span class="comment">// Otherwise, I go ahead and process it in rounds, by minimum increment...</span>
<a name="l01548"></a>01548             <span class="comment">// (Since the funds ARE supposed to be there to process the whole thing, I COULD</span>
<a name="l01549"></a>01549             <span class="comment">// choose to cancel the offender right now! I might put an extra fee in this loop or</span>
<a name="l01550"></a>01550             <span class="comment">// just remove it. The software would still be functional, it would just enforce the</span>
<a name="l01551"></a>01551             <span class="comment">// account having enough funds to cover the full offer at all times--if it wants to</span>
<a name="l01552"></a>01552             <span class="comment">// trade at all.)</span>
<a name="l01553"></a>01553             
<a name="l01554"></a>01554             <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l01555"></a>01555             
<a name="l01556"></a>01556             int64_t lOfferFinished      = 0,
<a name="l01557"></a>01557                  lOtherOfferFinished = 0, <span class="comment">// We store these up and then add the totals to the offers at the end (only upon success.)</span>
<a name="l01558"></a>01558                  lTotalPaidOut       = 0; <span class="comment">// However much is paid for the assets, total.</span>
<a name="l01559"></a>01559             
<a name="l01560"></a>01560             <span class="comment">// Continuing the example from above, each round I will trade:</span>
<a name="l01561"></a>01561             <span class="comment">//      50 oz lMinIncrementPerRound, in return for $65,000 lPrice.</span>
<a name="l01562"></a>01562             <span class="keywordflow">while</span> ((lMinIncrementPerRound   &lt;= (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()-lOfferFinished))          &amp;&amp;  <span class="comment">// The primary offer has at least 50 available to trade (buy OR sell)</span>
<a name="l01563"></a>01563                    (lMinIncrementPerRound   &lt;= (theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()-lOtherOfferFinished))&amp;&amp;  <span class="comment">// The other offer has at least 50 available for trade also.</span>
<a name="l01564"></a>01564                    (lMinIncrementPerRound   &lt;= pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>())                      &amp;&amp;  <span class="comment">// Asset Acct to be debited has at least 50 available.</span>
<a name="l01565"></a>01565                    (lPrice                  &lt;= pCurrencyAccountToDebit-&gt;GetBalance()) )                     <span class="comment">// Currency Acct to be debited has at least 65000 available.</span>
<a name="l01566"></a>01566             {
<a name="l01567"></a>01567                 <span class="comment">// Within this block, the offer is authorized on both sides, and there is enough in</span>
<a name="l01568"></a>01568                 <span class="comment">// each of the relevant accounts to cover the round, (for SURE.) So let&#39;s DO it.</span>
<a name="l01569"></a>01569                 
<a name="l01570"></a>01570                 bMove1 = pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lMinIncrementPerRound);            
<a name="l01571"></a>01571                 bMove2 = pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lPrice);
<a name="l01572"></a>01572                 
<a name="l01573"></a>01573                 bMove3 = pAssetAccountToCredit-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lMinIncrementPerRound);      
<a name="l01574"></a>01574                 bMove4 = pCurrencyAccountToCredit-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lPrice);      
<a name="l01575"></a>01575                 
<a name="l01576"></a>01576                 <span class="comment">// If ANY of these failed, then roll them all back and break.</span>
<a name="l01577"></a>01577                 <span class="keywordflow">if</span> (!bMove1 || !bMove2 || !bMove3 || !bMove4)
<a name="l01578"></a>01578                 {
<a name="l01579"></a>01579                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Very strange! Funds were available, yet debit or credit failed while performing trade. &quot;</span>
<a name="l01580"></a>01580                                  <span class="stringliteral">&quot;Attempting rollback!\n&quot;</span>);
<a name="l01581"></a>01581                     <span class="comment">// We won&#39;t save the files anyway, if this failed. So the rollback is actually superfluous but somehow worthwhile.</span>
<a name="l01582"></a>01582                     <a class="code" href="_o_t_market_8cpp.html#abbc90643987323e470c2d23f8de34193">rollback_four_accounts</a>(*pAssetAccountToDebit,       bMove1, lMinIncrementPerRound, 
<a name="l01583"></a>01583                                            *pCurrencyAccountToDebit,    bMove2, lPrice, 
<a name="l01584"></a>01584                                            *pAssetAccountToCredit,      bMove3, lMinIncrementPerRound, 
<a name="l01585"></a>01585                                            *pCurrencyAccountToCredit,   bMove4, lPrice);
<a name="l01586"></a>01586                 
<a name="l01587"></a>01587                     bSuccess = <span class="keyword">false</span>;
<a name="l01588"></a>01588                     <span class="keywordflow">break</span>;
<a name="l01589"></a>01589                 }
<a name="l01590"></a>01590                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01591"></a>01591                 <span class="comment">// At this point, we know all the debits and credits were successful (FOR THIS ROUND.)</span>
<a name="l01592"></a>01592                 <span class="comment">// Also notice that the Trades and Offers have not been changed at all--only the accounts.</span>
<a name="l01593"></a>01593                 bSuccess = <span class="keyword">true</span>;
<a name="l01594"></a>01594                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01595"></a>01595                 <span class="comment">// So let&#39;s adjust the offers to reflect this also...</span>
<a name="l01596"></a>01596                 <span class="comment">// The while() above checks these values in GetAmountAvailable().</span>
<a name="l01597"></a>01597                 lOfferFinished      += lMinIncrementPerRound;
<a name="l01598"></a>01598                 lOtherOfferFinished += lMinIncrementPerRound;
<a name="l01599"></a>01599                 
<a name="l01600"></a>01600                 lTotalPaidOut       += lPrice;
<a name="l01601"></a>01601             }
<a name="l01602"></a>01602             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01603"></a>01603             <span class="comment">// At this point, it has gone god-knows-how-many rounds, (or just one) and then broke out,</span>
<a name="l01604"></a>01604             <span class="comment">// with bSuccess=false, OR finished properly when the while() terms were fulfilled, with bSuccess = true.</span>
<a name="l01605"></a>01605             <span class="comment">//</span>
<a name="l01606"></a>01606             <span class="comment">// My point? If there was a screw-up, EVEN if the rollback was successful, it STILL only rolled-back</span>
<a name="l01607"></a>01607             <span class="comment">// the most RECENT round -- There still might have been 20 rounds processed before the break.</span>
<a name="l01608"></a>01608             <span class="comment">// (Funds could still have been moved, even if rollback was successful.) THEREFORE, DO NOT SAVE if false.</span>
<a name="l01609"></a>01609             <span class="comment">// We only save those accounts if bSuccess == true.  The Rollback is not good enough</span>
<a name="l01610"></a>01610             
<a name="l01611"></a>01611             <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
<a name="l01612"></a>01612             {
<a name="l01613"></a>01613                 <span class="comment">// ALL of the four accounts involved need to get a receipt of this trade in their inboxes...</span>
<a name="l01614"></a>01614                 pItem1-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pFirstAssetAcct      </span>
<a name="l01615"></a>01615                 pItem2-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pFirstCurrencyAcct</span>
<a name="l01616"></a>01616                 pItem3-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pOtherAssetAcct</span>
<a name="l01617"></a>01617                 pItem4-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pOtherCurrencyAcct               </span>
<a name="l01618"></a>01618 
<a name="l01619"></a>01619                 <span class="comment">// Everytime a trade processes, a receipt is put in each account&#39;s inbox.</span>
<a name="l01620"></a>01620                 <span class="comment">// This contains a copy of the current trade (which took money from the acct.)</span>
<a name="l01621"></a>01621                 <span class="comment">//</span>
<a name="l01622"></a>01622                 <span class="comment">// ==&gt; So I increment the trade count each time before dropping the receipt. (I also use a fresh</span>
<a name="l01623"></a>01623                 <span class="comment">// transaction number when I put it into the inbox.) That way, the user will never get the same</span>
<a name="l01624"></a>01624                 <span class="comment">// receipt for the same trade twice. It cannot take funds from his account, without a new trade</span>
<a name="l01625"></a>01625                 <span class="comment">// count and a new transaction number on a new receipt. Until the user accepts the receipt out</span>
<a name="l01626"></a>01626                 <span class="comment">// of his inbox with a new balance agreement, the existing receipts can be added up and compared</span>
<a name="l01627"></a>01627                 <span class="comment">// to the last balance agreement, to verify the current balance. Every receipt from a processing</span>
<a name="l01628"></a>01628                 <span class="comment">// trade will have the user&#39;s authorization, signature, and terms, as well as the update in balances</span>
<a name="l01629"></a>01629                 <span class="comment">// due to the trade, signed by the server.</span>
<a name="l01630"></a>01630                 
<a name="l01631"></a>01631                 theTrade    .<a class="code" href="class_o_t_trade.html#acc7070bba01b1e1b9dcadf1bb880083c">IncrementTradesAlreadyDone</a>();
<a name="l01632"></a>01632                 pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#acc7070bba01b1e1b9dcadf1bb880083c">IncrementTradesAlreadyDone</a>();
<a name="l01633"></a>01633                 
<a name="l01634"></a>01634                 theOffer     .<a class="code" href="class_o_t_offer.html#a3074fd63f4efd160d36d7a40e6b90852">IncrementFinishedSoFar</a>(lOfferFinished);      <span class="comment">// I was storing these up in the loop above.</span>
<a name="l01635"></a>01635                 theOtherOffer.<a class="code" href="class_o_t_offer.html#a3074fd63f4efd160d36d7a40e6b90852">IncrementFinishedSoFar</a>(lOtherOfferFinished); <span class="comment">// I was storing these up in the loop above.</span>
<a name="l01636"></a>01636             
<a name="l01637"></a>01637                 <span class="comment">// These have updated values, so let&#39;s save them.</span>
<a name="l01638"></a>01638                 theTrade.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01639"></a>01639                 theTrade.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01640"></a>01640                 theTrade.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01641"></a>01641 
<a name="l01642"></a>01642                 pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01643"></a>01643                 pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01644"></a>01644                 pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01645"></a>01645 
<a name="l01646"></a>01646                 theOffer.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01647"></a>01647                 theOffer.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01648"></a>01648                 theOffer.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01649"></a>01649 
<a name="l01650"></a>01650                 theOtherOffer.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01651"></a>01651                 theOtherOffer.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01652"></a>01652                 theOtherOffer.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01653"></a>01653                 
<a name="l01654"></a>01654                 <span class="comment">// -----------------------------------------------------------</span>
<a name="l01655"></a>01655                 
<a name="l01656"></a>01656                 m_lLastSalePrice = theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>(); <span class="comment">// Priced per scale.</span>
<a name="l01657"></a>01657                 
<a name="l01658"></a>01658                 <span class="comment">// -----------------------------------------------------------</span>
<a name="l01659"></a>01659                 <span class="comment">// Here we save this trade in a list of the most recent 50 trades.</span>
<a name="l01660"></a>01660                 {
<a name="l01661"></a>01661                     <span class="keywordflow">if</span> (NULL == m_pTradeList)
<a name="l01662"></a>01662                     {
<a name="l01663"></a>01663                         m_pTradeList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>));
<a name="l01664"></a>01664                     }
<a name="l01665"></a>01665                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01666"></a>01666                     <a class="code" href="class_o_t_d_b_1_1_trade_data_market.html">OTDB::TradeDataMarket</a> * pTradeData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_data_market.html">OTDB::TradeDataMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82adda8d82429f1fc73e0ce76464532b05d">OTDB::STORED_OBJ_TRADE_DATA_MARKET</a>));
<a name="l01667"></a>01667                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeDataMarket&gt;</a> theDataAngel(*pTradeData);
<a name="l01668"></a>01668                     <span class="comment">// --------------------------------------------</span>
<a name="l01669"></a>01669                     <span class="keyword">const</span> int64_t &amp; lTransactionNum = theOffer.<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
<a name="l01670"></a>01670                     <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> theDate         = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>();
<a name="l01671"></a>01671                     <span class="keyword">const</span> int64_t &amp; lPriceLimit     = theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>(); <span class="comment">// Priced per scale.</span>
<a name="l01672"></a>01672                     <span class="keyword">const</span> int64_t &amp; lAmountSold     = lOfferFinished;
<a name="l01673"></a>01673                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01674"></a>01674                     pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a05f595532ff4d68296d037278eb9667c">transaction_id</a> = to_string&lt;int64_t&gt;(lTransactionNum);
<a name="l01675"></a>01675                     pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a37ffb91335f3f2a17ecfa977c33a87cd">date</a>           = to_string&lt;time64_t&gt;(theDate);
<a name="l01676"></a>01676                     pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#adf3ccb40b8b57663ece8864b72e50127">price</a>          = to_string&lt;int64_t&gt;(lPriceLimit);
<a name="l01677"></a>01677                     pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#ac0ab38ef41c6ab1b1082902f8ab38aea">amount_sold</a>    = to_string&lt;int64_t&gt;(lAmountSold);
<a name="l01678"></a>01678                     <span class="comment">// ------------------------------------------------------</span>
<a name="l01679"></a>01679                     m_strLastSaleDate = pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a37ffb91335f3f2a17ecfa977c33a87cd">date</a>;
<a name="l01680"></a>01680                     <span class="comment">// ------------------------------------------------------</span>
<a name="l01681"></a>01681                     <span class="comment">// *pTradeData is CLONED at this time (I&#39;m still responsible to delete.)</span>
<a name="l01682"></a>01682                     <span class="comment">// That&#39;s also why I add it here, after all the above: So the data is set right BEFORE the cloning occurs.</span>
<a name="l01683"></a>01683                     <span class="comment">//</span>
<a name="l01684"></a>01684                     m_pTradeList-&gt;AddTradeDataMarket(*pTradeData);
<a name="l01685"></a>01685                     
<a name="l01686"></a>01686                     <span class="comment">// Here we erase the oldest elements so the list never exceeds 50 elements total.</span>
<a name="l01687"></a>01687                     <span class="comment">//</span>
<a name="l01688"></a>01688                     <span class="keywordflow">while</span> (m_pTradeList-&gt;GetTradeDataMarketCount() &gt; <a class="code" href="_o_t_market_8hpp.html#ad3557119e36c729a56ea7448245c116a">MAX_MARKET_QUERY_DEPTH</a>)
<a name="l01689"></a>01689                         m_pTradeList-&gt;RemoveTradeDataMarket(0);
<a name="l01690"></a>01690                 }       
<a name="l01691"></a>01691                 <span class="comment">// -------------------------------------------------------------</span>
<a name="l01692"></a>01692                 <span class="comment">// Account balances have changed based on these trades that we just processed.</span>
<a name="l01693"></a>01693                 <span class="comment">// Make sure to save the Market since it contains those offers that have just updated.</span>
<a name="l01694"></a>01694                 <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>();
<a name="l01695"></a>01695                 
<a name="l01696"></a>01696                 <span class="comment">// The Trade has changed, and it is stored as a CronItem. So I save Cron as well, for</span>
<a name="l01697"></a>01697                 <span class="comment">// the same reason I saved the Market.</span>
<a name="l01698"></a>01698                 pCron-&gt;<a class="code" href="class_o_t_cron.html#a24df32b4bf36e48867e7afda0955bb72">SaveCron</a>();
<a name="l01699"></a>01699             }
<a name="l01700"></a>01700             
<a name="l01701"></a>01701             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l01702"></a>01702             <span class="comment">//</span>
<a name="l01703"></a>01703             <span class="comment">// EVERYTHING BELOW is just about notifying the users, by dropping the receipt in their</span>
<a name="l01704"></a>01704             <span class="comment">// inboxes. </span>
<a name="l01705"></a>01705             <span class="comment">//</span>
<a name="l01706"></a>01706             <span class="comment">// (The Trade, Offer, Cron, and Market are ALL updated and SAVED as of this point.)</span>
<a name="l01707"></a>01707             <span class="comment">//</span>
<a name="l01708"></a>01708             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l01709"></a>01709             <span class="comment">// The TRANSACTION will be sent with &quot;In Reference To&quot; information containing the</span>
<a name="l01710"></a>01710             <span class="comment">// ORIGINAL SIGNED TRADE (which includes the ORIGINAL SIGNED OFFER inside of it.)</span>
<a name="l01711"></a>01711             <span class="comment">//</span>
<a name="l01712"></a>01712             <span class="comment">// Whereas the TRANSACTION ITEM includes a &quot;Note&quot; containing the UPDATED TRADE, </span>
<a name="l01713"></a>01713             <span class="comment">// (with the SERVER&#39;s SIGNATURE) as well as an &quot;attachment&quot; containing the UPDATED</span>
<a name="l01714"></a>01714             <span class="comment">// OFFER (again, with the server&#39;s signature on it.)</span>
<a name="l01715"></a>01715             
<a name="l01716"></a>01716             <span class="comment">// I was doing this above, but had to move it all down here, since the Trade</span>
<a name="l01717"></a>01717             <span class="comment">//  and Offer have just finally been updated to their final values...</span>
<a name="l01718"></a>01718             
<a name="l01719"></a>01719             <span class="comment">// Here I make sure that each trader&#39;s receipt (each inbox notice) references the</span>
<a name="l01720"></a>01720             <span class="comment">// transaction number that the trader originally used to issue the trade...</span>
<a name="l01721"></a>01721             <span class="comment">// This number is used to match up offers to trades, and used to track all cron items.</span>
<a name="l01722"></a>01722             <span class="comment">// (All Cron items require a transaction from the user to add them to Cron in the</span>
<a name="l01723"></a>01723             <span class="comment">// first place.)</span>
<a name="l01724"></a>01724             <span class="comment">// </span>
<a name="l01725"></a>01725             pTrans1-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01726"></a>01726             pTrans2-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01727"></a>01727             pTrans3-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01728"></a>01728             pTrans4-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01729"></a>01729 
<a name="l01730"></a>01730             <span class="comment">// Then, I make sure the Reference string on the Transaction contains the </span>
<a name="l01731"></a>01731             <span class="comment">// ORIGINAL TRADE (with the TRADER&#39;s SIGNATURE ON IT!) For both traders.</span>
<a name="l01732"></a>01732             
<a name="l01733"></a>01733             <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pOrigTrade         = NULL;
<a name="l01734"></a>01734             <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pOrigOtherTrade    = NULL;
<a name="l01735"></a>01735             
<a name="l01736"></a>01736             <span class="comment">// OTCronItem::LoadCronReceipt loads the original version with the user&#39;s signature.</span>
<a name="l01737"></a>01737             <span class="comment">// (Updated versions, as processing occurs, are signed by the server.)</span>
<a name="l01738"></a>01738             pOrigTrade      = <a class="code" href="class_o_t_cron_item.html#a368603ca2196ecb8817d42a24138f5d7">OTCronItem::LoadCronReceipt</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01739"></a>01739             pOrigOtherTrade = <a class="code" href="class_o_t_cron_item.html#a368603ca2196ecb8817d42a24138f5d7">OTCronItem::LoadCronReceipt</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01740"></a>01740             
<a name="l01741"></a>01741             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOrigTrade);
<a name="l01742"></a>01742             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOrigOtherTrade);
<a name="l01743"></a>01743             
<a name="l01744"></a>01744             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pOrigTrade-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pFirstNym), 
<a name="l01745"></a>01745                           <span class="stringliteral">&quot;Signature was already verified on Trade when first added to market, but now it fails.\n&quot;</span>);
<a name="l01746"></a>01746             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pOrigOtherTrade-&gt;VerifySignature(*pOtherNym), 
<a name="l01747"></a>01747                           <span class="stringliteral">&quot;Signature was already verified on Trade when first added to market, but now it fails.\n&quot;</span>);
<a name="l01748"></a>01748             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01749"></a>01749             <span class="comment">// I now have String copies (PGP-signed XML files) of the original Trade requests...</span>
<a name="l01750"></a>01750             <span class="comment">// Plus I know they were definitely signed by the Nyms (even though that was already</span>
<a name="l01751"></a>01751             <span class="comment">// verified when they were first added to the market--and they have been signed by the</span>
<a name="l01752"></a>01752             <span class="comment">// server nym ever since.)</span>
<a name="l01753"></a>01753             <a class="code" href="class_o_t_string.html">OTString</a> strOrigTrade(*pOrigTrade), strOrigOtherTrade(*pOrigOtherTrade);
<a name="l01754"></a>01754             
<a name="l01755"></a>01755             <span class="comment">// The reference on the transaction contains OTCronItem, in this case.</span>
<a name="l01756"></a>01756             <span class="comment">// The original trade for each party, versus the updated trade (which is stored</span>
<a name="l01757"></a>01757             <span class="comment">// on the marketReceipt item just below here.)</span>
<a name="l01758"></a>01758             <span class="comment">//</span>
<a name="l01759"></a>01759             pTrans1-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigTrade);
<a name="l01760"></a>01760             pTrans2-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigTrade);
<a name="l01761"></a>01761             pTrans3-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigOtherTrade);
<a name="l01762"></a>01762             pTrans4-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigOtherTrade);
<a name="l01763"></a>01763             
<a name="l01764"></a>01764             <span class="comment">// Make sure to clean these up.</span>
<a name="l01765"></a>01765             <span class="comment">// TODO: Run a scanner on the code for memory leaks and buffer overflows.</span>
<a name="l01766"></a>01766             <span class="keyword">delete</span> pOrigTrade; pOrigTrade = NULL;
<a name="l01767"></a>01767             <span class="keyword">delete</span> pOrigOtherTrade; pOrigOtherTrade = NULL;
<a name="l01768"></a>01768             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l01769"></a>01769             <span class="comment">// Here&#39;s where the item stores the UPDATED TRADE (in its Note)</span>
<a name="l01770"></a>01770             <span class="comment">// and the UPDATED OFFER (in its attachment) with the SERVER&#39;s SIGNATURE</span>
<a name="l01771"></a>01771             <span class="comment">// on both.</span>
<a name="l01772"></a>01772             <span class="comment">// (As a receipt for each trader, so they can see their offer updating.)</span>
<a name="l01773"></a>01773 
<a name="l01774"></a>01774             <span class="comment">// Lucky I just signed and saved these trades / offers above, or they would </span>
<a name="l01775"></a>01775             <span class="comment">// still have the old data in them.</span>
<a name="l01776"></a>01776             <a class="code" href="class_o_t_string.html">OTString</a>    strTrade(theTrade), strOtherTrade(*pOtherTrade), 
<a name="l01777"></a>01777                         strOffer(theOffer), strOtherOffer(theOtherOffer);
<a name="l01778"></a>01778 
<a name="l01779"></a>01779             <span class="comment">// The marketReceipt ITEM&#39;s NOTE contains the UPDATED TRADE.</span>
<a name="l01780"></a>01780             <span class="comment">//</span>
<a name="l01781"></a>01781             pItem1-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strTrade);
<a name="l01782"></a>01782             pItem2-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strTrade);
<a name="l01783"></a>01783             pItem3-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strOtherTrade);
<a name="l01784"></a>01784             pItem4-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strOtherTrade);
<a name="l01785"></a>01785             
<a name="l01786"></a>01786             <span class="comment">/*</span>
<a name="l01787"></a>01787 <span class="comment">             </span>
<a name="l01788"></a>01788 <span class="comment">             NOTE, todo: Someday, need to reverse these, so that the updated Trade is stored in </span>
<a name="l01789"></a>01789 <span class="comment">             the attachment, and the updated offer is stored in the note. This is much more consistent</span>
<a name="l01790"></a>01790 <span class="comment">             with other cron receipts, such as paymentReceipt, and finalReceipt. Unfortunately,</span>
<a name="l01791"></a>01791 <span class="comment">             marketReceipt is already implemented the opposite of these, but I will fix it someday just</span>
<a name="l01792"></a>01792 <span class="comment">             for consistency. See large notes 2/3rds of the way down in OTTrade::onFinalReceipt().</span>
<a name="l01793"></a>01793 <span class="comment">             </span>
<a name="l01794"></a>01794 <span class="comment">             Todo security: really each receipt should contain a copy of BOTH (asset+currency) so</span>
<a name="l01795"></a>01795 <span class="comment">             the user can calculate the sale price and compare it to the terms on the original offer.</span>
<a name="l01796"></a>01796 <span class="comment">             */</span>
<a name="l01797"></a>01797             
<a name="l01798"></a>01798             <span class="comment">// Also set the ** UPDATED OFFER ** as the ATTACHMENT on the ** item.** </span>
<a name="l01799"></a>01799             <span class="comment">// (With the SERVER&#39;s signature on it!)</span>
<a name="l01800"></a>01800             <span class="comment">// (As a receipt for each trader, so they can see their offer updating.)</span>
<a name="l01801"></a>01801             pItem1-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOffer);
<a name="l01802"></a>01802             pItem2-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOffer);
<a name="l01803"></a>01803             pItem3-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOtherOffer);
<a name="l01804"></a>01804             pItem4-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOtherOffer);
<a name="l01805"></a>01805             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01806"></a>01806             <span class="comment">// Inbox receipts need to clearly show the AMOUNT moved...</span>
<a name="l01807"></a>01807             <span class="comment">// Also need to clearly show negative or positive, since that</span>
<a name="l01808"></a>01808             <span class="comment">// is otherwise not obvious just because you have a marketReceipt...</span>
<a name="l01809"></a>01809             <span class="comment">// </span>
<a name="l01810"></a>01810             <span class="comment">// The AMOUNT is stored on the marketReceipt ITEM, on the item list for</span>
<a name="l01811"></a>01811             <span class="comment">// the marketReceipt TRANSACTION.</span>
<a name="l01812"></a>01812             <span class="comment">//</span>
<a name="l01813"></a>01813             <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()) <span class="comment">// I&#39;m selling, he&#39;s buying</span>
<a name="l01814"></a>01814             {
<a name="l01815"></a>01815                 pItem1-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOfferFinished*(-1)); <span class="comment">// first asset</span>
<a name="l01816"></a>01816                 pItem2-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut);       <span class="comment">// first currency</span>
<a name="l01817"></a>01817                 pItem3-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOtherOfferFinished); <span class="comment">// other asset</span>
<a name="l01818"></a>01818                 pItem4-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut*(-1));  <span class="comment">// other currency</span>
<a name="l01819"></a>01819             }
<a name="l01820"></a>01820             <span class="keywordflow">else</span>    <span class="comment">// I&#39;m buying, he&#39;s selling</span>
<a name="l01821"></a>01821             {
<a name="l01822"></a>01822                 pItem1-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOfferFinished);      <span class="comment">// first asset</span>
<a name="l01823"></a>01823                 pItem2-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut*(-1));  <span class="comment">// first currency</span>
<a name="l01824"></a>01824                 pItem3-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOtherOfferFinished*(-1)); <span class="comment">// other asset</span>
<a name="l01825"></a>01825                 pItem4-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut);       <span class="comment">// other currency</span>
<a name="l01826"></a>01826             }
<a name="l01827"></a>01827             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l01828"></a>01828             <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
<a name="l01829"></a>01829             {                   
<a name="l01830"></a>01830                 <span class="comment">// sign the item</span>
<a name="l01831"></a>01831                 pItem1-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01832"></a>01832                 pItem2-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01833"></a>01833                 pItem3-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01834"></a>01834                 pItem4-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01835"></a>01835                 
<a name="l01836"></a>01836                 pItem1-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01837"></a>01837                 pItem2-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01838"></a>01838                 pItem3-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01839"></a>01839                 pItem4-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01840"></a>01840                 
<a name="l01841"></a>01841                 <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l01842"></a>01842                 pTrans1-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem1);
<a name="l01843"></a>01843                 pTrans2-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem2);
<a name="l01844"></a>01844                 pTrans3-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem3);
<a name="l01845"></a>01845                 pTrans4-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem4);
<a name="l01846"></a>01846                 
<a name="l01847"></a>01847                 pTrans1-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01848"></a>01848                 pTrans2-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01849"></a>01849                 pTrans3-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01850"></a>01850                 pTrans4-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01851"></a>01851                 
<a name="l01852"></a>01852                 pTrans1-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01853"></a>01853                 pTrans2-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01854"></a>01854                 pTrans3-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01855"></a>01855                 pTrans4-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01856"></a>01856                 
<a name="l01857"></a>01857                 <span class="comment">// Here the transactions we just created are actually added to the ledgers.</span>
<a name="l01858"></a>01858                 theFirstAssetInbox.         AddTransaction(*pTrans1);
<a name="l01859"></a>01859                 theFirstCurrencyInbox.      AddTransaction(*pTrans2);
<a name="l01860"></a>01860                 theOtherAssetInbox.         AddTransaction(*pTrans3);
<a name="l01861"></a>01861                 theOtherCurrencyInbox.      AddTransaction(*pTrans4);
<a name="l01862"></a>01862                 <span class="comment">// -------------------------------------------------------------------</span>
<a name="l01863"></a>01863                 <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
<a name="l01864"></a>01864                 <span class="comment">// verify anymore anyway, since the content has changed.)</span>
<a name="l01865"></a>01865                 theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01866"></a>01866                 theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01867"></a>01867                 theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01868"></a>01868                 theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01869"></a>01869                                 
<a name="l01870"></a>01870                 <span class="comment">// Sign all four of them.               </span>
<a name="l01871"></a>01871                 theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01872"></a>01872                 theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01873"></a>01873                 theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01874"></a>01874                 theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01875"></a>01875                 
<a name="l01876"></a>01876                 <span class="comment">// Save all four of them internally</span>
<a name="l01877"></a>01877                 theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01878"></a>01878                 theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01879"></a>01879                 theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01880"></a>01880                 theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01881"></a>01881                                 
<a name="l01882"></a>01882                 <span class="comment">// TODO: Better rollback capabilities in case of failures here:</span>
<a name="l01883"></a>01883                 
<a name="l01884"></a>01884                 <span class="comment">// Save the four inboxes to storage. (File, DB, wherever it goes.)</span>
<a name="l01885"></a>01885                 
<a name="l01886"></a>01886                 pFirstAssetAcct-&gt;       SaveInbox(theFirstAssetInbox);  
<a name="l01887"></a>01887                 pFirstCurrencyAcct-&gt;    SaveInbox(theFirstCurrencyInbox);
<a name="l01888"></a>01888                 pOtherAssetAcct-&gt;       SaveInbox(theOtherAssetInbox);  
<a name="l01889"></a>01889                 pOtherCurrencyAcct-&gt;    SaveInbox(theOtherCurrencyInbox);
<a name="l01890"></a>01890                 <span class="comment">// -------------------------------------------------------------------</span>
<a name="l01891"></a>01891                 <span class="comment">// These correspond to the AddTransaction() calls just above.</span>
<a name="l01892"></a>01892                 <span class="comment">// The actual receipts are stored in separate files now.</span>
<a name="l01893"></a>01893                 <span class="comment">//</span>
<a name="l01894"></a>01894                 pTrans1-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theFirstAssetInbox);
<a name="l01895"></a>01895                 pTrans2-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theFirstCurrencyInbox);
<a name="l01896"></a>01896                 pTrans3-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theOtherAssetInbox);
<a name="l01897"></a>01897                 pTrans4-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theOtherCurrencyInbox);
<a name="l01898"></a>01898                 <span class="comment">// -------------------------------------------------------------------</span>
<a name="l01899"></a>01899                 <span class="comment">// Save the four accounts.</span>
<a name="l01900"></a>01900                 pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();    
<a name="l01901"></a>01901                 pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01902"></a>01902                 pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();    
<a name="l01903"></a>01903                 pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01904"></a>01904                 pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);  
<a name="l01905"></a>01905                 pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01906"></a>01906                 pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);  
<a name="l01907"></a>01907                 pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01908"></a>01908                 pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
<a name="l01909"></a>01909                 pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01910"></a>01910                 pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
<a name="l01911"></a>01911                 pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01912"></a>01912                 pFirstAssetAcct-&gt;       SaveAccount();  
<a name="l01913"></a>01913                 pFirstCurrencyAcct-&gt;    SaveAccount();
<a name="l01914"></a>01914                 pOtherAssetAcct-&gt;       SaveAccount();  
<a name="l01915"></a>01915                 pOtherCurrencyAcct-&gt;    SaveAccount();
<a name="l01916"></a>01916             }
<a name="l01917"></a>01917             <span class="comment">// If money was short, let&#39;s see WHO was short so we can remove his trade.</span>
<a name="l01918"></a>01918             <span class="comment">// Also, if money was short, inbox notices only go to the rejectees. </span>
<a name="l01919"></a>01919             <span class="comment">// But if success, then notices go to all four inboxes.</span>
<a name="l01920"></a>01920             <span class="keywordflow">else</span>
<a name="l01921"></a>01921             {
<a name="l01922"></a>01922                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Unable to perform trade in OTMarket::%s\n&quot;</span>, __FUNCTION__);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924                 <span class="comment">// Let&#39;s figure out which one it was and remove his trade and offer.</span>
<a name="l01925"></a>01925                 <span class="keywordtype">bool</span>    bFirstTraderIsBroke = <span class="keyword">false</span>,
<a name="l01926"></a>01926                         bOtherTraderIsBroke = <span class="keyword">false</span>;
<a name="l01927"></a>01927                 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l01928"></a>01928 
<a name="l01929"></a>01929                 <span class="comment">// Here&#39;s what&#39;s going on here:</span>
<a name="l01930"></a>01930                 <span class="comment">// &quot;Figure out if this guy was short, or if it was that guy. Send a notice</span>
<a name="l01931"></a>01931                 <span class="comment">// to the one who got rejected for being short on cash. </span>
<a name="l01932"></a>01932                 <span class="comment">//</span>
<a name="l01933"></a>01933                 <span class="comment">// Else NEITHER was short, so delete them both with no notice.</span>
<a name="l01934"></a>01934                 <span class="comment">//</span>
<a name="l01935"></a>01935                 <span class="comment">// (After checking both asset accounts, there&#39;s another If statement below where</span>
<a name="l01936"></a>01936                 <span class="comment">// I repeat this process for the currency accounts as well.) </span>
<a name="l01937"></a>01937                 <span class="comment">//</span>
<a name="l01938"></a>01938                 <span class="comment">// This whole section occurs because even though the trade and offer were valid</span>
<a name="l01939"></a>01939                 <span class="comment">// and good to go, at least one of the four accounts was short of funds.</span>
<a name="l01940"></a>01940                 <span class="comment">// </span>
<a name="l01941"></a>01941                 <span class="keywordflow">if</span> (pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lMinIncrementPerRound)
<a name="l01942"></a>01942                 {
<a name="l01943"></a>01943                     <a class="code" href="class_o_t_item.html">OTItem</a>          * pTempItem         = NULL;
<a name="l01944"></a>01944                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a>   * pTempTransaction  = NULL;
<a name="l01945"></a>01945                     <a class="code" href="class_o_t_ledger.html">OTLedger</a>        * pTempInbox        = NULL;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947                     <span class="keywordflow">if</span> (pAssetAccountToDebit == pFirstAssetAcct)
<a name="l01948"></a>01948                     {   pTempItem           = pItem1;   bFirstTraderIsBroke = <span class="keyword">true</span>; 
<a name="l01949"></a>01949                         pTempTransaction    = pTrans1;  pTempInbox = &amp;theFirstAssetInbox; 
<a name="l01950"></a>01950                         
<a name="l01951"></a>01951                         <span class="keyword">delete</span> pItem3;  pItem3  = NULL;
<a name="l01952"></a>01952                         <span class="keyword">delete</span> pTrans3; pTrans3 = NULL;
<a name="l01953"></a>01953                     }
<a name="l01954"></a>01954                     <span class="keywordflow">else</span> <span class="comment">// it&#39;s the other asset account</span>
<a name="l01955"></a>01955                     {   pTempItem           = pItem3;   bOtherTraderIsBroke = <span class="keyword">true</span>; 
<a name="l01956"></a>01956                         pTempTransaction    = pTrans3;  pTempInbox = &amp;theOtherAssetInbox; 
<a name="l01957"></a>01957                         
<a name="l01958"></a>01958                         <span class="keyword">delete</span> pItem1;  pItem1  = NULL;
<a name="l01959"></a>01959                         <span class="keyword">delete</span> pTrans1; pTrans1 = NULL;
<a name="l01960"></a>01960                     }
<a name="l01961"></a>01961                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01962"></a>01962                     pTempItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>);
<a name="l01963"></a>01963                     pTempItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);                   
<a name="l01964"></a>01964                     pTempItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01965"></a>01965                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01966"></a>01966                     pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pTempItem);
<a name="l01967"></a>01967                     pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01968"></a>01968                     pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01969"></a>01969                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01970"></a>01970                     pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTempTransaction);
<a name="l01971"></a>01971                     
<a name="l01972"></a>01972                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01973"></a>01973                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l01974"></a>01974                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01975"></a>01975                     pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
<a name="l01976"></a>01976                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l01977"></a>01977                     pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pTempInbox);
<a name="l01978"></a>01978                 }
<a name="l01979"></a>01979                 <span class="keywordflow">else</span>
<a name="l01980"></a>01980                 {
<a name="l01981"></a>01981                     <span class="keyword">delete</span> pItem1;  pItem1  = NULL;
<a name="l01982"></a>01982                     <span class="keyword">delete</span> pTrans1; pTrans1 = NULL;
<a name="l01983"></a>01983                     <span class="keyword">delete</span> pItem3;  pItem3  = NULL;
<a name="l01984"></a>01984                     <span class="keyword">delete</span> pTrans3; pTrans3 = NULL;
<a name="l01985"></a>01985                 }
<a name="l01986"></a>01986                 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l01987"></a>01987                 <span class="comment">// This section is identical to the one above, except for the currency accounts.</span>
<a name="l01988"></a>01988                 <span class="comment">//</span>
<a name="l01989"></a>01989                 <span class="keywordflow">if</span> (pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lPrice)
<a name="l01990"></a>01990                 {
<a name="l01991"></a>01991                     <a class="code" href="class_o_t_item.html">OTItem</a>          * pTempItem         = NULL;
<a name="l01992"></a>01992                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a>   * pTempTransaction  = NULL;
<a name="l01993"></a>01993                     <a class="code" href="class_o_t_ledger.html">OTLedger</a>        * pTempInbox        = NULL;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995                     <span class="keywordflow">if</span> (pCurrencyAccountToDebit == pFirstCurrencyAcct)
<a name="l01996"></a>01996                     {   pTempItem           = pItem2;   bFirstTraderIsBroke = <span class="keyword">true</span>; 
<a name="l01997"></a>01997                         pTempTransaction    = pTrans2;  pTempInbox = &amp;theFirstCurrencyInbox; 
<a name="l01998"></a>01998                         
<a name="l01999"></a>01999                         <span class="keyword">delete</span> pItem4;  pItem4  = NULL;
<a name="l02000"></a>02000                         <span class="keyword">delete</span> pTrans4; pTrans4 = NULL;
<a name="l02001"></a>02001                     }
<a name="l02002"></a>02002                     <span class="keywordflow">else</span> <span class="comment">// it&#39;s the other asset account</span>
<a name="l02003"></a>02003                     {   pTempItem           = pItem4;   bOtherTraderIsBroke = <span class="keyword">true</span>; 
<a name="l02004"></a>02004                         pTempTransaction    = pTrans4;  pTempInbox = &amp;theOtherCurrencyInbox; 
<a name="l02005"></a>02005                         
<a name="l02006"></a>02006                         <span class="keyword">delete</span> pItem2;  pItem2  = NULL;
<a name="l02007"></a>02007                         <span class="keyword">delete</span> pTrans2; pTrans2 = NULL;
<a name="l02008"></a>02008                     }
<a name="l02009"></a>02009                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l02010"></a>02010                     pTempItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>);
<a name="l02011"></a>02011                     pTempItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);                   
<a name="l02012"></a>02012                     pTempItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02013"></a>02013                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l02014"></a>02014                     pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pTempItem);
<a name="l02015"></a>02015                     pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l02016"></a>02016                     pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02017"></a>02017                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l02018"></a>02018                     pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTempTransaction);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l02021"></a>02021                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
<a name="l02022"></a>02022                     pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02023"></a>02023                     pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
<a name="l02024"></a>02024                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l02025"></a>02025                     pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pTempInbox);
<a name="l02026"></a>02026                 }
<a name="l02027"></a>02027                 <span class="keywordflow">else</span> 
<a name="l02028"></a>02028                 {
<a name="l02029"></a>02029                     <span class="keyword">delete</span> pItem2;  pItem2  = NULL;
<a name="l02030"></a>02030                     <span class="keyword">delete</span> pTrans2; pTrans2 = NULL;
<a name="l02031"></a>02031                     <span class="keyword">delete</span> pItem4;  pItem4  = NULL;
<a name="l02032"></a>02032                     <span class="keyword">delete</span> pTrans4; pTrans4 = NULL;
<a name="l02033"></a>02033                 }
<a name="l02034"></a>02034                 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l02035"></a>02035                 <span class="comment">// If either trader is broke, we flag the trade for removal.</span>
<a name="l02036"></a>02036                 <span class="comment">// No other trades will process against it and it will be removed from market soon.</span>
<a name="l02037"></a>02037                 <span class="comment">//</span>
<a name="l02038"></a>02038                 <span class="keywordflow">if</span> (bFirstTraderIsBroke)
<a name="l02039"></a>02039                     theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l02040"></a>02040                 <span class="keywordflow">if</span> (bOtherTraderIsBroke)
<a name="l02041"></a>02041                     pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
<a name="l02042"></a>02042                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l02043"></a>02043             } <span class="comment">// success == false</span>
<a name="l02044"></a>02044         } <span class="comment">// all four boxes were successfully loaded or generated.</span>
<a name="l02045"></a>02045     } <span class="comment">// &quot;this entire function can be divided...&quot;</span>
<a name="l02046"></a>02046     
<a name="l02047"></a>02047     <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
<a name="l02048"></a>02048 }
<a name="l02049"></a>02049 <span class="comment">// Let&#39;s say pBid-&gt;Price is $10. He&#39;s bidding $10 as his price limit. </span>
<a name="l02050"></a>02050 <span class="comment">// If I was ALREADY selling at $11, then NOTHING HAPPENS. (If we&#39;re the only two people on the market.)</span>
<a name="l02051"></a>02051 <span class="comment">// If I was ALREADY SELLING at $8, and a $10 bid came in, it would immediately process our orders and be done.</span>
<a name="l02052"></a>02052 <span class="comment">// If I was ALREADY BIDDING at $10, and an $8 ask came in, it would immediately process our orders and be done.</span>
<a name="l02053"></a>02053 <span class="comment">//</span>
<a name="l02054"></a>02054 <span class="comment">// So the question is, who gets WHAT price? Does the transaction occur at $8 or at $10? Do I get my price limit,</span>
<a name="l02055"></a>02055 <span class="comment">// or does he? Do you split the difference? I decided what to do... here is the REASONING, then CONCLUSION:</span>
<a name="l02056"></a>02056 <span class="comment">//</span>
<a name="l02057"></a>02057 <span class="comment">// REASONING:</span>
<a name="l02058"></a>02058 <span class="comment">//</span>
<a name="l02059"></a>02059 <span class="comment">// If I&#39;m already selling for $8, and a $10 bid comes in, he&#39;s only going to choose me since I&#39;m the lowest</span>
<a name="l02060"></a>02060 <span class="comment">// one on the market (and first in line for my price.) Otherwise he has no reason not to choose one of the</span>
<a name="l02061"></a>02061 <span class="comment">// others who are also available at that low price, instead of choosing me. The server would just pick</span>
<a name="l02062"></a>02062 <span class="comment">// whoever was next in line.</span>
<a name="l02063"></a>02063 <span class="comment">//</span>
<a name="l02064"></a>02064 <span class="comment">// And the other sellers also do have a right to get their sales completed, since they ARE willing to sell</span>
<a name="l02065"></a>02065 <span class="comment">// for $8. Obviously none of the other bids wanted me so far, even though I&#39;m the best deal on my market,</span>
<a name="l02066"></a>02066 <span class="comment">// or I would have been snapped up already. But I&#39;m still here. The bidder shouldn&#39;t pay more than fair market</span>
<a name="l02067"></a>02067 <span class="comment">// rate, which means more than whatever my competition is charging, and as long as I&#39;m not getting any less</span>
<a name="l02068"></a>02068 <span class="comment">// than my own ask limit, then I HAVE agreed to the price, and it&#39;s fair. (I always could have set it higher.)</span>
<a name="l02069"></a>02069 <span class="comment">//</span>
<a name="l02070"></a>02070 <span class="comment">// The prices also were different when I came onto the market. Things were different then. Obviously</span>
<a name="l02071"></a>02071 <span class="comment">// since I&#39;m still here, I wasn&#39;t ALWAYS the lowest price. Maybe in fact the price was $3 before, and I had a</span>
<a name="l02072"></a>02072 <span class="comment">// int64_t-standing trade there that said not to sell for less than $8 (with a stop order too, so it didn&#39;t even</span>
<a name="l02073"></a>02073 <span class="comment">// activate until then.) THE POINT? I COULD have had the best price on the market THEN, whatever it was, simply</span>
<a name="l02074"></a>02074 <span class="comment">// by checking it and then setting my limit to match. But I didn&#39;t choose that. Instead, I set it to $8 limit,</span>
<a name="l02075"></a>02075 <span class="comment">// and then my trade sat there waiting for 6 months or god knows how int64_t until it became valid, when market</span>
<a name="l02076"></a>02076 <span class="comment">// conditions became more favorable to my trade.</span>
<a name="l02077"></a>02077 <span class="comment">// THEN my trade, at some point, became the lowest price on the market (finally) so when someone&#39;s brand</span>
<a name="l02078"></a>02078 <span class="comment">// new $10 limit bid comes in, he ALSO deserves the best price on the market, just as I had the same</span>
<a name="l02079"></a>02079 <span class="comment">// opportunity to get the best price when *I* first entered the market. And since I am now first in line with</span>
<a name="l02080"></a>02080 <span class="comment">// $8 as the best price in the market, he should get it at that $8 price. We have both agreed to it! It is</span>
<a name="l02081"></a>02081 <span class="comment">// within BOTH of our limits! Notice we also BOTH got our fair shot up front to have the absolute best price,</span>
<a name="l02082"></a>02082 <span class="comment">// and instead we set our limit outside of what prices were available in order to wait for better offers.</span>
<a name="l02083"></a>02083 <span class="comment">//</span>
<a name="l02084"></a>02084 <span class="comment">//</span>
<a name="l02085"></a>02085 <span class="comment">// CONCLUSION:</span>
<a name="l02086"></a>02086 <span class="comment">//</span>
<a name="l02087"></a>02087 <span class="comment">// THEREFORE: The new Trade should always get the better deal in this function, in the sense that he gets</span>
<a name="l02088"></a>02088 <span class="comment">// the best price possible (the limit) from the other trade (that was already on the market.) And he gets the</span>
<a name="l02089"></a>02089 <span class="comment">// number-one best deal available from that side of the market. The existing trade does NOT get theOffer&#39;s</span>
<a name="l02090"></a>02090 <span class="comment">// limit price, but theOffer DOES get the other trade&#39;s limit price. This is how it should work. We are not</span>
<a name="l02091"></a>02091 <span class="comment">// going to &quot;split the difference&quot; -- although we might split a percentage off the difference as a server fee.</span>
<a name="l02092"></a>02092 <span class="comment">// I haven&#39;t thought that through yet (it&#39;s an idea suggested by Andrew Muck.)</span>
<a name="l02093"></a>02093 
<a name="l02094"></a>02094 
<a name="l02095"></a>02095 <span class="comment">// Return True if Trade should stay on the Cron list for more processing.</span>
<a name="l02096"></a>02096 <span class="comment">// Return False if it should be removed and deleted.</span>
<a name="l02097"></a><a class="code" href="class_o_t_market.html#a0814323a286be01f0b69b2b24b8030f3">02097</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">OTMarket::ProcessTrade</a>(<a class="code" href="class_o_t_trade.html">OTTrade</a> &amp; theTrade, <a class="code" href="class_o_t_offer.html">OTOffer</a> &amp; theOffer)
<a name="l02098"></a>02098 {
<a name="l02099"></a>02099     <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>() &lt; theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())
<a name="l02100"></a>02100     {
<a name="l02101"></a>02101         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTMarket::%s: Removing offer from market. (Amount Available is less than Min Increment.)\n&quot;</span>,
<a name="l02102"></a>02102                        __FUNCTION__);
<a name="l02103"></a>02103         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02104"></a>02104     }
<a name="l02105"></a>02105     <span class="comment">// --------------------------------------------------</span>
<a name="l02106"></a>02106     int64_t lRelevantPrice = 0;
<a name="l02107"></a>02107     
<a name="l02108"></a>02108     <span class="comment">// If I&#39;m trying to SELL something, then I care about the highest bidder.</span>
<a name="l02109"></a>02109     <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>())
<a name="l02110"></a>02110         lRelevantPrice = <a class="code" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">GetHighestBidPrice</a>();
<a name="l02111"></a>02111     <span class="comment">// --------------------------------------------------</span>
<a name="l02112"></a>02112     <span class="comment">// ...But if I&#39;m trying to BUY something, then I care about the lowest ask price.</span>
<a name="l02113"></a>02113     <span class="keywordflow">else</span>
<a name="l02114"></a>02114         lRelevantPrice = <a class="code" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">GetLowestAskPrice</a>();
<a name="l02115"></a>02115     <span class="comment">// --------------------------------------------------</span>
<a name="l02116"></a>02116     <span class="comment">// If there were no relevant offers (or if they were all market orders, aka: 0 == lRelevantPrice),</span>
<a name="l02117"></a>02117     <span class="comment">// AND if *I* am a market order, then REMOVE me from the market. (Market orders only process once,</span>
<a name="l02118"></a>02118     <span class="comment">// so if we are processing here and we haven&#39;t found any potential matches, we&#39;re REMOVED.)</span>
<a name="l02119"></a>02119     <span class="comment">//</span>
<a name="l02120"></a>02120     <span class="keywordflow">if</span> ((0 == lRelevantPrice) &amp;&amp; theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>()) <span class="comment">// Market order has 0 price.</span>
<a name="l02121"></a>02121         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02122"></a>02122     <span class="comment">// --------------------------------------------------</span>
<a name="l02123"></a>02123     <span class="comment">// If there were no bids/asks (whichever is relevant to this trade) on the market at ALL,</span>
<a name="l02124"></a>02124     <span class="comment">// then lRelevant price will be 0 at this point. In which case we&#39;re DONE.</span>
<a name="l02125"></a>02125     <span class="comment">//</span>
<a name="l02126"></a>02126     <span class="comment">// If I&#39;m selling, and the highest bid is less than my price limit, then we&#39;re DONE.</span>
<a name="l02127"></a>02127     <span class="comment">// If I&#39;m buying, and the lowest ask price is higher than my price limit, then we&#39;re DONE.</span>
<a name="l02128"></a>02128     <span class="comment">//</span>
<a name="l02129"></a>02129     <span class="keywordflow">if</span> ((0 == lRelevantPrice) || <span class="comment">// If 0, we KNOW we&#39;re not a market order, since we would have returned already (above.)</span>
<a name="l02130"></a>02130         
<a name="l02131"></a>02131         <span class="comment">// We only care about price-based restrictions if we&#39;re a limit order.</span>
<a name="l02132"></a>02132         <span class="comment">// (Market orders don&#39;t care about price, so they skip this condition.)</span>
<a name="l02133"></a>02133         
<a name="l02134"></a>02134         (   theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>() &amp;&amp;
<a name="l02135"></a>02135             (
<a name="l02136"></a>02136                 (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()   &amp;&amp; (lRelevantPrice &lt; theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) ||
<a name="l02137"></a>02137                 (theOffer.<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>()   &amp;&amp; (lRelevantPrice &gt; theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>()))
<a name="l02138"></a>02138             )
<a name="l02139"></a>02139         )
<a name="l02140"></a>02140     )
<a name="l02141"></a>02141     {
<a name="l02142"></a>02142         <span class="comment">// There is nothing on the market currently within my price limits.</span>
<a name="l02143"></a>02143         <span class="comment">// We&#39;re DONE. (For now.)</span>
<a name="l02144"></a>02144         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02145"></a>02145     }
<a name="l02146"></a>02146     <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l02147"></a>02147     <span class="comment">// If I got this far, that means there ARE bidders or sellers (whichever the current trade cares about)</span>
<a name="l02148"></a>02148     <span class="comment">// in the market WITHIN THIS TRADE&#39;S PRICE LIMITS. So we&#39;re going to go up the list of what&#39;s available, and trade.</span>
<a name="l02149"></a>02149     
<a name="l02150"></a>02150     <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>())   <span class="comment">// If I&#39;m selling,</span>
<a name="l02151"></a>02151     {                       
<a name="l02152"></a>02152         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pBid = NULL; <span class="comment">// then I want to start at the highest bidder and loop DOWN until hitting my price limit.</span>
<a name="l02153"></a>02153         
<a name="l02154"></a>02154         <span class="comment">// rbegin puts us on the upper bound of the highest bidder (any new bidders at the same price would</span>
<a name="l02155"></a>02155         <span class="comment">// be added at the lower bound, where they are last in line.) The upper bound, on the other hand, is</span>
<a name="l02156"></a>02156         <span class="comment">// first in line.  So we start there, and loop backwards until there are no other bids within my price range.</span>
<a name="l02157"></a>02157         <span class="keywordflow">for</span> (mapOfOffers::reverse_iterator rr = m_mapBids.rbegin(); 
<a name="l02158"></a>02158              rr != m_mapBids.rend(); 
<a name="l02159"></a>02159              rr++)
<a name="l02160"></a>02160         {       
<a name="l02161"></a>02161             pBid = (*rr).second;
<a name="l02162"></a>02162             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBid);
<a name="l02163"></a>02163             <span class="comment">// ---------------------------------------------------</span>
<a name="l02164"></a>02164             <span class="comment">// NOTE: Market orders only process once, and they are processed in</span>
<a name="l02165"></a>02165             <span class="comment">// the order they were added to the market.</span>
<a name="l02166"></a>02166             <span class="comment">//</span>
<a name="l02167"></a>02167             <span class="comment">// If BOTH offers are market orders, we just skip this bid.</span>
<a name="l02168"></a>02168             <span class="comment">//</span>
<a name="l02169"></a>02169             <span class="comment">// But FURTHERMORE: We ONLY process a market order as theOffer, not as pBid!</span>
<a name="l02170"></a>02170             <span class="comment">// Imagine if pBid is a market order and theOffer isn&#39;t -- that would mean pBid</span>
<a name="l02171"></a>02171             <span class="comment">// hasn&#39;t been processed yet (since it will only process once.) So it needs to</span>
<a name="l02172"></a>02172             <span class="comment">// wait its turn! It will get its one shot WHEN ITS TURN comes.</span>
<a name="l02173"></a>02173             <span class="comment">//</span>
<a name="l02174"></a>02174             <span class="keywordflow">if</span> (                            pBid-&gt;<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
<a name="l02175"></a>02175 <span class="comment">//          if (theOffer.IsMarketOrder() &amp;&amp; pBid-&gt;IsMarketOrder())</span>
<a name="l02176"></a>02176 <span class="comment">//              continue;</span>
<a name="l02177"></a>02177                 <span class="keywordflow">break</span>;
<a name="l02178"></a>02178             <span class="comment">// NOTE: Why break, instead of continue? Because since we are looping through the bids,</span>
<a name="l02179"></a>02179             <span class="comment">// from the HIGHEST down to the LOWEST, and since market orders have a ZERO price, we know</span>
<a name="l02180"></a>02180             <span class="comment">// for a fact that there are not any other non-zero bids. (So we might as well break.)</span>
<a name="l02181"></a>02181             <span class="comment">// ---------------------------------------------------</span>
<a name="l02182"></a>02182             <span class="comment">// I&#39;m selling.</span>
<a name="l02183"></a>02183             <span class="comment">//</span>
<a name="l02184"></a>02184             <span class="comment">// If the bid is larger than, or equal to, my low-side-limit,</span>
<a name="l02185"></a>02185             <span class="comment">// and the amount available is at least my minimum increment, (and vice versa),</span>
<a name="l02186"></a>02186             <span class="comment">// ...then let&#39;s trade!</span>
<a name="l02187"></a>02187             <span class="comment">// </span>
<a name="l02188"></a>02188             <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>() || <span class="comment">// If I don&#39;t care about price...</span>
<a name="l02189"></a>02189                 (pBid-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) <span class="comment">// Or if this bid is within my price range...</span>
<a name="l02190"></a>02190             {
<a name="l02191"></a>02191                 <span class="comment">// Notice the above &quot;if&quot; is ONLY based on price... because the &quot;else&quot; returns!</span>
<a name="l02192"></a>02192                 <span class="comment">// (Once I am out of my price range, no point to continue looping.)</span>
<a name="l02193"></a>02193                 <span class="comment">//</span>
<a name="l02194"></a>02194                 <span class="comment">// ...So all the other &quot;if&quot;s have to go INSIDE the block here:</span>
<a name="l02195"></a>02195                 <span class="comment">//</span>
<a name="l02196"></a>02196                 <span class="keywordflow">if</span> ((pBid-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()     &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>()) &amp;&amp;
<a name="l02197"></a>02197                     (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()  &gt;= pBid-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())    &amp;&amp;
<a name="l02198"></a>02198                     (NULL != pBid-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()) &amp;&amp; !pBid-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()-&gt;<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>())
<a name="l02199"></a>02199                     <span class="comment">// ------------------------------------</span>
<a name="l02200"></a>02200                     <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">ProcessTrade</a>(theTrade, theOffer, *pBid); <span class="comment">// &lt;========</span>
<a name="l02201"></a>02201             }
<a name="l02202"></a>02202             <span class="comment">// ---------------------------------------------------</span>
<a name="l02203"></a>02203             <span class="comment">// Else, the bid is lower than I am willing to sell. (And all the remaining bids are even lower.)</span>
<a name="l02204"></a>02204             <span class="comment">//</span>
<a name="l02205"></a>02205             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>())
<a name="l02206"></a>02206             {
<a name="l02207"></a>02207                 pBid = NULL;
<a name="l02208"></a>02208                 <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on cron for more processing (for now.)</span>
<a name="l02209"></a>02209             }
<a name="l02210"></a>02210             <span class="comment">// ---------------------------------------------------</span>
<a name="l02211"></a>02211             <span class="comment">// The offer has no more trading to do--it&#39;s done.</span>
<a name="l02212"></a>02212             <span class="keywordflow">if</span> (theTrade.<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>() || <span class="comment">// during processing, the trade may have gotten flagged.</span>
<a name="l02213"></a>02213                 (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()))
<a name="l02214"></a>02214                 <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove this trade from cron</span>
<a name="l02215"></a>02215 
<a name="l02216"></a>02216             pBid = NULL;
<a name="l02217"></a>02217         }
<a name="l02218"></a>02218     }
<a name="l02219"></a>02219     <span class="comment">// I&#39;m buying</span>
<a name="l02220"></a>02220     <span class="keywordflow">else</span> 
<a name="l02221"></a>02221     {
<a name="l02222"></a>02222         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pAsk = NULL; <span class="comment">// then I want to start at the lowest seller and loop UP until hitting my price limit.</span>
<a name="l02223"></a>02223         
<a name="l02224"></a>02224         <span class="comment">// Begin puts us on the lower bound of the lowest seller (any new sellers at the same price would</span>
<a name="l02225"></a>02225         <span class="comment">// be added at the upper bound for that price, where they are last in line.) The lower bound, on the other hand, is</span>
<a name="l02226"></a>02226         <span class="comment">// first in line.  So we start there, and loop forwards until there are no other asks within my price range.</span>
<a name="l02227"></a>02227         <span class="comment">//</span>
<a name="l02228"></a>02228         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
<a name="l02229"></a>02229         {       
<a name="l02230"></a>02230             pAsk = (*it).second;
<a name="l02231"></a>02231             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAsk);
<a name="l02232"></a>02232             <span class="comment">// ---------------------------------------------------</span>
<a name="l02233"></a>02233             <span class="comment">// NOTE: Market orders only process once, and they are processed in</span>
<a name="l02234"></a>02234             <span class="comment">// the order they were added to the market.</span>
<a name="l02235"></a>02235             <span class="comment">//</span>
<a name="l02236"></a>02236             <span class="comment">// If BOTH offers are market orders, we just skip this ask.</span>
<a name="l02237"></a>02237             <span class="comment">//</span>
<a name="l02238"></a>02238             <span class="comment">// But FURTHERMORE: We ONLY process a market order as theOffer, not as pAsk!</span>
<a name="l02239"></a>02239             <span class="comment">// Imagine if pAsk is a market order and theOffer isn&#39;t -- that would mean pAsk</span>
<a name="l02240"></a>02240             <span class="comment">// hasn&#39;t been processed yet (since it will only process once.) So it needs to</span>
<a name="l02241"></a>02241             <span class="comment">// wait its turn! It will get its one shot WHEN ITS TURN comes.</span>
<a name="l02242"></a>02242             <span class="comment">//</span>
<a name="l02243"></a>02243             <span class="keywordflow">if</span> (                            pAsk-&gt;<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
<a name="l02244"></a>02244 <span class="comment">//          if (theOffer.IsMarketOrder() &amp;&amp; pAsk-&gt;IsMarketOrder())</span>
<a name="l02245"></a>02245                 <span class="keywordflow">continue</span>;
<a name="l02246"></a>02246             <span class="comment">// ---------------------------------------------------</span>
<a name="l02247"></a>02247             <span class="comment">// I&#39;m buying.</span>
<a name="l02248"></a>02248             <span class="comment">// If the ask price is less than, or equal to, my price limit,</span>
<a name="l02249"></a>02249             <span class="comment">// and the amount available for purchase is at least my minimum increment, (and vice versa),</span>
<a name="l02250"></a>02250             <span class="comment">// ...then let&#39;s trade!</span>
<a name="l02251"></a>02251             <span class="comment">//</span>
<a name="l02252"></a>02252             <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>() || <span class="comment">// If I don&#39;t care about price...</span>
<a name="l02253"></a>02253                 (pAsk-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() &lt;= theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) <span class="comment">// Or if this ask is within my price range...</span>
<a name="l02254"></a>02254             {
<a name="l02255"></a>02255                 <span class="comment">// Notice the above &quot;if&quot; is ONLY based on price... because the &quot;else&quot; returns!</span>
<a name="l02256"></a>02256                 <span class="comment">// (Once I am out of my price range, no point to continue looping.)</span>
<a name="l02257"></a>02257                 <span class="comment">// So all the other &quot;if&quot;s have to go INSIDE the block here:</span>
<a name="l02258"></a>02258                 <span class="comment">//</span>
<a name="l02259"></a>02259                 <span class="keywordflow">if</span> ((pAsk-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()     &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())  &amp;&amp;
<a name="l02260"></a>02260                     (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()  &gt;= pAsk-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())     &amp;&amp;
<a name="l02261"></a>02261                     (NULL != pAsk-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()) &amp;&amp; !pAsk-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()-&gt;<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>())
<a name="l02262"></a>02262                     <span class="comment">// ------------------------------------</span>
<a name="l02263"></a>02263                     <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">ProcessTrade</a>(theTrade, theOffer, *pAsk); <span class="comment">// &lt;=======</span>
<a name="l02264"></a>02264             }
<a name="l02265"></a>02265             <span class="comment">// Else, the ask price is higher than I am willing to pay. (And all the remaining sellers are even HIGHER.)</span>
<a name="l02266"></a>02266             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>())
<a name="l02267"></a>02267             {
<a name="l02268"></a>02268                 pAsk = NULL;
<a name="l02269"></a>02269                 <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on the market for now.</span>
<a name="l02270"></a>02270             }
<a name="l02271"></a>02271             <span class="comment">// -------------------------------------------------</span>
<a name="l02272"></a>02272             <span class="comment">// The offer has no more trading to do--it&#39;s done.</span>
<a name="l02273"></a>02273             <span class="keywordflow">if</span> (theTrade.<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>() || <span class="comment">// during processing, the trade may have gotten flagged.</span>
<a name="l02274"></a>02274                 (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()))
<a name="l02275"></a>02275                 <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove this trade from the market.</span>
<a name="l02276"></a>02276             
<a name="l02277"></a>02277             pAsk = NULL;
<a name="l02278"></a>02278         }       
<a name="l02279"></a>02279     }
<a name="l02280"></a>02280     <span class="comment">// --------------------------------------------------------</span>
<a name="l02281"></a>02281     <span class="comment">// Market orders only process once.</span>
<a name="l02282"></a>02282     <span class="comment">// (So tell the caller to remove it.)</span>
<a name="l02283"></a>02283     <span class="comment">//</span>
<a name="l02284"></a>02284     <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
<a name="l02285"></a>02285         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove from market.</span>
<a name="l02286"></a>02286     <span class="comment">// --------------------------------------------------------</span>
<a name="l02287"></a>02287     <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on the market for now.</span>
<a name="l02288"></a>02288 }
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 
<a name="l02291"></a>02291 <span class="comment">// Make sure the offer is for the right asset type, the right currency, etc.</span>
<a name="l02292"></a><a class="code" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">02292</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">OTMarket::ValidateOfferForMarket</a>(<a class="code" href="class_o_t_offer.html">OTOffer</a> &amp; theOffer, <a class="code" href="class_o_t_string.html">OTString</a> * pReason<span class="comment">/*=NULL*/</span>)
<a name="l02293"></a>02293 {
<a name="l02294"></a>02294     <span class="keywordtype">bool</span>     bValidOffer = <span class="keyword">true</span>;
<a name="l02295"></a>02295     <a class="code" href="class_o_t_string.html">OTString</a> strReason(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02296"></a>02296     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02297"></a>02297     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a>() != theOffer.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>())
<a name="l02298"></a>02298     {
<a name="l02299"></a>02299         bValidOffer = <span class="keyword">false</span>;
<a name="l02300"></a>02300         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>());
<a name="l02301"></a>02301         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Server ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
<a name="l02302"></a>02302     }
<a name="l02303"></a>02303     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02304"></a>02304     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>() != theOffer.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>())
<a name="l02305"></a>02305     {
<a name="l02306"></a>02306         bValidOffer = <span class="keyword">false</span>;
<a name="l02307"></a>02307         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>());
<a name="l02308"></a>02308         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Asset ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
<a name="l02309"></a>02309     }
<a name="l02310"></a>02310     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02311"></a>02311     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>() != theOffer.<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>())
<a name="l02312"></a>02312     {
<a name="l02313"></a>02313         bValidOffer = <span class="keyword">false</span>;
<a name="l02314"></a>02314         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>());
<a name="l02315"></a>02315         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Currency ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
<a name="l02316"></a>02316     }
<a name="l02317"></a>02317     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02318"></a>02318     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>() != theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>())
<a name="l02319"></a>02319     {
<a name="l02320"></a>02320         bValidOffer = <span class="keyword">false</span>;
<a name="l02321"></a>02321         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Market Scale on offer. Expected %lld, but found %lld&quot;</span>, <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(), theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>());
<a name="l02322"></a>02322     }
<a name="l02323"></a>02323     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02324"></a>02324     <span class="comment">// The above four items must match in order for it to even be the same MARKET.</span>
<a name="l02325"></a>02325     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02326"></a>02326     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &lt;= 0)
<a name="l02327"></a>02327     {
<a name="l02328"></a>02328         bValidOffer = <span class="keyword">false</span>;
<a name="l02329"></a>02329         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Minimum Increment on offer is &lt;= 0: %lld&quot;</span>, theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>());
<a name="l02330"></a>02330     }
<a name="l02331"></a>02331     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02332"></a>02332     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &lt; <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>())
<a name="l02333"></a>02333     {
<a name="l02334"></a>02334         bValidOffer = <span class="keyword">false</span>;
<a name="l02335"></a>02335         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) is less than market scale (%lld).&quot;</span>,
<a name="l02336"></a>02336                          theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());
<a name="l02337"></a>02337     }
<a name="l02338"></a>02338     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02339"></a>02339     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() % <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>()) != 0)
<a name="l02340"></a>02340     {
<a name="l02341"></a>02341         bValidOffer = <span class="keyword">false</span>;
<a name="l02342"></a>02342         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) Mod market scale (%lld) is not equal to zero.&quot;</span>,
<a name="l02343"></a>02343                          theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());
<a name="l02344"></a>02344     }
<a name="l02345"></a>02345     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02346"></a>02346     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>())
<a name="l02347"></a>02347     {
<a name="l02348"></a>02348         bValidOffer = <span class="keyword">false</span>;
<a name="l02349"></a>02349         strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) is more than the amount of assets available for trade on that same offer (%lld).&quot;</span>,
<a name="l02350"></a>02350                          theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>());
<a name="l02351"></a>02351     }
<a name="l02352"></a>02352     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l02353"></a>02353     <span class="keywordflow">if</span> (bValidOffer)
<a name="l02354"></a>02354         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer is valid for market.\n&quot;</span>);
<a name="l02355"></a>02355     <span class="keywordflow">else</span>
<a name="l02356"></a>02356     {
<a name="l02357"></a>02357         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Offer is invalid for this market: %s\n&quot;</span>, __FUNCTION__, strReason.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02358"></a>02358         
<a name="l02359"></a>02359         <span class="keywordflow">if</span> (NULL != pReason)
<a name="l02360"></a>02360             *pReason = strReason;
<a name="l02361"></a>02361     }
<a name="l02362"></a>02362     <span class="comment">// -----------------------------------------</span>
<a name="l02363"></a>02363     <span class="keywordflow">return</span> bValidOffer;
<a name="l02364"></a>02364 }
<a name="l02365"></a>02365 
<a name="l02366"></a>02366 
<a name="l02367"></a><a class="code" href="class_o_t_market.html#acabac79f968b3db2ef9fe05f57f73277">02367</a> <a class="code" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename) : <a class="code" href="class_o_t_contract.html">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
<a name="l02368"></a>02368 {
<a name="l02369"></a>02369     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != szFilename);
<a name="l02370"></a>02370     
<a name="l02371"></a>02371     m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
<a name="l02372"></a>02372     <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
<a name="l02373"></a>02373     
<a name="l02374"></a>02374     <a class="code" href="class_o_t_contract.html#ab7ab1f1fe7ff7e52f2c126404a8f4f92">m_strFilename</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(szFilename);
<a name="l02375"></a>02375     <a class="code" href="class_o_t_contract.html#ab1e11693a38a1673037b1f29c9d84010">m_strFoldername</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get());
<a name="l02376"></a>02376 }
<a name="l02377"></a>02377 
<a name="l02378"></a>02378 
<a name="l02379"></a><a class="code" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">02379</a> <a class="code" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a>() : <a class="code" href="class_o_t_contract.html">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
<a name="l02380"></a>02380 {
<a name="l02381"></a>02381     m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
<a name="l02382"></a>02382     <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
<a name="l02383"></a>02383 }
<a name="l02384"></a>02384 
<a name="l02385"></a>02385 
<a name="l02386"></a><a class="code" href="class_o_t_market.html#a45d1559b24c78a58b28f05f7626ef126">02386</a> <a class="code" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l02387"></a>02387                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; CURRENCY_TYPE_ID, <span class="keyword">const</span> int64_t &amp; lScale) : 
<a name="l02388"></a>02388     <a class="code" href="class_o_t_contract.html">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
<a name="l02389"></a>02389 {
<a name="l02390"></a>02390     m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
<a name="l02391"></a>02391     <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
<a name="l02392"></a>02392     
<a name="l02393"></a>02393     m_ASSET_TYPE_ID     = ASSET_TYPE_ID;    
<a name="l02394"></a>02394     m_CURRENCY_TYPE_ID  = CURRENCY_TYPE_ID; 
<a name="l02395"></a>02395     
<a name="l02396"></a>02396     m_SERVER_ID         = SERVER_ID;
<a name="l02397"></a>02397     
<a name="l02398"></a>02398     <a class="code" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">SetScale</a>(lScale);
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401 
<a name="l02402"></a><a class="code" href="class_o_t_market.html#ac1fca3bb237c7c710039fa09156ae3c9">02402</a> <a class="code" href="class_o_t_market.html#ac1fca3bb237c7c710039fa09156ae3c9">OTMarket::~OTMarket</a>()
<a name="l02403"></a>02403 {
<a name="l02404"></a>02404     <a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">Release_Market</a>();
<a name="l02405"></a>02405 }
<a name="l02406"></a>02406 
<a name="l02407"></a>02407 
<a name="l02408"></a><a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">02408</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">OTMarket::InitMarket</a>()
<a name="l02409"></a>02409 {
<a name="l02410"></a>02410     <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a> = <span class="stringliteral">&quot;MARKET&quot;</span>;
<a name="l02411"></a>02411     
<a name="l02412"></a>02412     <a class="code" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">SetScale</a>(1);
<a name="l02413"></a>02413 }
<a name="l02414"></a>02414 
<a name="l02415"></a>02415 
<a name="l02416"></a><a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">02416</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">OTMarket::Release_Market</a>()
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418     m_ASSET_TYPE_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();  
<a name="l02419"></a>02419     m_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();   
<a name="l02420"></a>02420     
<a name="l02421"></a>02421     m_SERVER_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();
<a name="l02422"></a>02422     
<a name="l02423"></a>02423     <span class="comment">// Elements of this list are cleaned up automatically.</span>
<a name="l02424"></a>02424     <span class="keywordflow">if</span> (NULL != m_pTradeList)
<a name="l02425"></a>02425     {
<a name="l02426"></a>02426         <span class="keyword">delete</span> m_pTradeList; 
<a name="l02427"></a>02427         m_pTradeList = NULL;
<a name="l02428"></a>02428     }
<a name="l02429"></a>02429     
<a name="l02430"></a>02430     <span class="comment">// If there were any dynamically allocated objects, clean them up here.</span>
<a name="l02431"></a>02431     <span class="keywordflow">while</span> (!m_mapBids.empty())
<a name="l02432"></a>02432     {       
<a name="l02433"></a>02433         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = m_mapBids.begin()-&gt;second;
<a name="l02434"></a>02434         m_mapBids.erase(m_mapBids.begin());
<a name="l02435"></a>02435         <span class="keyword">delete</span> pOffer;
<a name="l02436"></a>02436         pOffer = NULL;
<a name="l02437"></a>02437     }
<a name="l02438"></a>02438     <span class="keywordflow">while</span> (!m_mapAsks.empty())
<a name="l02439"></a>02439     {       
<a name="l02440"></a>02440         <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = m_mapAsks.begin()-&gt;second;
<a name="l02441"></a>02441         m_mapAsks.erase(m_mapAsks.begin());
<a name="l02442"></a>02442         <span class="keyword">delete</span> pOffer;
<a name="l02443"></a>02443         pOffer = NULL;
<a name="l02444"></a>02444     }
<a name="l02445"></a>02445 }
<a name="l02446"></a>02446 
<a name="l02447"></a>02447 
<a name="l02448"></a><a class="code" href="class_o_t_market.html#a052638ef7aebad8f0eaaa148d7e1546f">02448</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_market.html#a052638ef7aebad8f0eaaa148d7e1546f">OTMarket::Release</a>()
<a name="l02449"></a>02449 {
<a name="l02450"></a>02450     <a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">Release_Market</a>(); <span class="comment">// since I&#39;ve overridden the base class, I call it now...</span>
<a name="l02451"></a>02451     
<a name="l02452"></a>02452     <a class="code" href="class_o_t_contract.html#a15e423ca0d650858a23e54f8285feae1">ot_super::Release</a>(); <span class="comment">// since I&#39;ve overridden the base class, I call it now...</span>
<a name="l02453"></a>02453 
<a name="l02454"></a>02454     <span class="comment">// Then I call this to re-initialize everything (just out of convenience. Not always the right move.)</span>
<a name="l02455"></a>02455     <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();   
<a name="l02456"></a>02456 }
<a name="l02457"></a>02457 
<a name="l02458"></a>02458 
<a name="l02459"></a><a class="code" href="class_o_t_market.html#adf9018b289268d0439d92f4176094392">02459</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_market.html#adf9018b289268d0439d92f4176094392">OTMarket::SaveContractWallet</a>(std::ofstream &amp; ofs)
<a name="l02460"></a>02460 {
<a name="l02461"></a>02461     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02462"></a>02462 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_market_8cpp.html">OTMarket.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:03 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
