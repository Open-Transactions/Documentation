<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: include/otlib/OTCachedKey.hpp File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_cached_key_8hpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a>  </div>
  <div class="headertitle">
<div class="title">include/otlib/OTCachedKey.hpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="_o_t_common_8hpp_source.html">OTCommon.hpp</a>&quot;</code><br/>
<code>#include &lt;map&gt;</code><br/>
<code>#include &lt;string&gt;</code><br/>
<code>#include &quot;tinythread.hpp&quot;</code><br/>
</div>
<p><a href="_o_t_cached_key_8hpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_cached_key.html">OTCachedKey</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_o_t_cached_key_8hpp.html#a359f8993fefe08ca989f8715ec6f0a43">OT_MASTER_KEY_TIMEOUT</a>&#160;&#160;&#160;300</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef std::map&lt; std::string, <br class="typebreak"/>
<a class="el" href="_t_r1___wrapper_8hpp.html#a4081b6aa22d0f454ce7498756ea212ff">_SharedPtr</a>&lt; <a class="el" href="class_o_t_cached_key.html">OTCachedKey</a> &gt; &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_o_t_cached_key_8hpp.html#a32c9259e56d708a983d9fb79fee41403">mapOfCachedKeys</a></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a359f8993fefe08ca989f8715ec6f0a43"></a><!-- doxytag: member="OTCachedKey.hpp::OT_MASTER_KEY_TIMEOUT" ref="a359f8993fefe08ca989f8715ec6f0a43" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="_o_t_cached_key_8hpp.html#a359f8993fefe08ca989f8715ec6f0a43">OT_MASTER_KEY_TIMEOUT</a>&#160;&#160;&#160;300</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p><a class="el" href="class_o_t_cached_key.html">OTCachedKey</a> This class handles the functionality of caching the master key for X seconds as an <a class="el" href="class_o_t_password.html">OTPassword</a>, and then deleting it. It also caches the encrypted version in an <a class="el" href="class_o_t_symmetric_key.html">OTSymmetricKey</a>, which can be unlocked to an <a class="el" href="class_o_t_password.html">OTPassword</a> again for X more seconds (by entering the passphrase...) How does <a class="el" href="class_o_t_cached_key.html">OTCachedKey</a> work, in a nutshell?</p>
<p>-- It's a singleton. There's only one "master key" for the application and it's available globally like this: <a class="el" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It()</a>. For example: <a class="el" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It()</a>-&gt;IsGenerated()</p>
<p>-- m_pSymmetricKey contains a symmetric key in ENCRYPTED form, which loads up from the wallet, and which is always kept in RAM (as on the hard drive) ONLY in encrypted form.</p>
<p>-- m_pMasterPassword is the DECRYPTED version of m_pSymmetricKey. When a user enters his password, a key derivation hash is used to transform it, and the result is used to get an unlocked copy of m_pSymmetricKey, putting the cleartext version into m_pMasterPassword.</p>
<p>-- Why store a decrypted version in memory? So we can set a timer using another thread, and thereby return X seconds later, and destroy that decrypted version. In the meantime, until it is destroyed, it will be used automatically by OT, every time a password is needed until those X seconds are over.</p>
<p>-- That's still not good enough: the decrypted version should still be stored in protected memory, using some standard API such as gpg-agent or Windows VirtualProtect. And whatever is stored there, should ALSO be encrypted to a session key which is re-generated for every run of the application. Furthermore, the decrypted version being stored isn't the user's actual passphrase, nor is it the key derived from it via some password hash algorithm, but instead is a random number that was generated in order to be used as the master key.</p>
<p>-- This means that the actual password the user enters, is never stored anywhere. Neither is the key derived from that password, since both can instantly be erased after using them to unlock the master key. Furthermore the master key is encrypted to a temporary session key, which is different for every run of the application, so it is never stored cleartext in memory, either, nor is it thus available to anyone with backdoors into protected memory.</p>
<p>-- Not only does the session key change after each run of the application, but it is possible to replace the master key without forcing a change of the password itself. Likewise it is also possible to change the password, without changing the underlying key that it opens. Adding the session key will further ensure that neither password nor master key ever appears in RAM (for very int64_t) nor on the harddrive in cleartext form.</p>
<p>-- Adding the use of a standard protected memory API such as gpg-agent means there is no risk of swapping or core dumps revealing vital information from within OT itself. Nevertheless, the <a class="el" href="class_o_t_password.html">OTPassword</a> class takes pains to prevent core dumps and swapping, and also uses tricks to zero sensitive memory after it has been used.</p>
<p>-- The protected memory API has no access to what it is storing, due to the session key. I will make this configurable so that users can choose their own authentication mechanisms.</p>
<p>-- Since a thread is used to implement a timer for wiping the master key after X seconds, a mutex appears in the class below, which must be locked by any functions in order to use the master key. (They do this behind the scenes automatically.)</p>
<p>-- An OT operation will behave in this way: The user tries to withdraw cash, and thus must sign a withdrawal request. An OpenSSL call is used to sign the request, and the OT password callback is passed to the OpenSSL call, which OpenSSL will call in the event that it needs a password. When that happens, OT will, instead of popping up the password dialog to the user, will notice that the master key password has been decrypted already and is within the X seconds window, so it will use that password to unlock the master key, which it passes to OpenSSL instead of asking the user to enter his passphrase. If the timer had already been expired by that time, then the master key password would have been destroyed already, meaning OT has no way to open the master key, so OT would then pop up the passphrase dialog and ask the user to enter his passphrase, use that to derive a key, and use that to unlock the master key password, and then use that to unlock the master key and pass that back to OpenSSL via the callback function.</p>
<p>-- OT might do several operations within a SINGLE USE CASE. For example, for a cash withdrawal, OT might sign the transaction item, sign the balance agreement item, sign the main transaction containing those items, AND sign the message containing that transaction. Perhaps OT has to use that private key 4 or 5 times in a row, all within a fraction of a second. Should the user therefore have to enter his passphrase 4 or 5 times, for a cash withdrawal? Isn't once enough? But it's not that simple, because each operation opens the master key just int64_t enough for OpenSSL to perform the requested operation, and then destroys it again immediately after the operation is completed. (Even when the timeout is active, what's being stored isn't the master key itself, but the master key password used to open it JUST LONG ENOUGH to use it, and then destroy it again.) The critical point to understand is that, especially with the introduction of the session key, EVEN though a timeout is happening, the master key itself is STILL destroyed after each operation, even 4 or 5 times in a row really fast, for some single use case transaction to occur.</p>
<p>-- If you set your timeout to -1, then the master key passphrase will never expire. But if your timeout is set to 0, then you will have to type your password 4 or 5 times for a single transaction. Get it? If you set it to 300 (seconds) then you will only have to type your passphrase once and then your application will work for 5 minutes without having to type it again, not even once more, until that 5 minutes are up, and then you will definitely have to type that password again before doing another operation.</p>
<p>-- This is an area where much can be gained through the study of code obfuscation, randomizing memory locations, zeroing memory after use, using protected memory APIs, using session keys, using outsourced authentication systems such as ssh-agent instead of handling it internally, stack smashing techniques such as canaries, etc etc. This is always a moving target. </p>

<p>Definition at line <a class="el" href="_o_t_cached_key_8hpp_source.html#l00247">247</a> of file <a class="el" href="_o_t_cached_key_8hpp_source.html">OTCachedKey.hpp</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a32c9259e56d708a983d9fb79fee41403"></a><!-- doxytag: member="OTCachedKey.hpp::mapOfCachedKeys" ref="a32c9259e56d708a983d9fb79fee41403" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef std::map&lt;std::string, <a class="el" href="_t_r1___wrapper_8hpp.html#a4081b6aa22d0f454ce7498756ea212ff">_SharedPtr</a>&lt;<a class="el" href="class_o_t_cached_key.html">OTCachedKey</a>&gt; &gt; <a class="el" href="_o_t_cached_key_8hpp.html#a32c9259e56d708a983d9fb79fee41403">mapOfCachedKeys</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_cached_key_8hpp_source.html#l00249">249</a> of file <a class="el" href="_o_t_cached_key_8hpp_source.html">OTCachedKey.hpp</a>.</p>

</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_cached_key_8hpp.html">OTCachedKey.hpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:05 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
