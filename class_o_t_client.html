<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: OTClient Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_t_client.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a>  </div>
  <div class="headertitle">
<div class="title">OTClient Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="OTClient" -->
<p><code>#include &lt;<a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>&gt;</code></p>

<p><a href="class_o_t_client-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-types"></a>
Public Types</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7">OT_CLIENT_CMD_TYPE</a> { <br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">checkServerID</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">createUserAccount</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821">deleteUserAccount</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871">checkUser</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b">sendUserMessage</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">getRequest</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee">issueAssetType</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13">createAccount</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3">issueBasket</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374">exchangeBasket</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">getTransactionNum</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a">getNymbox</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76">getInbox</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113">getOutbox</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">processNymbox</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00">processEntireNymbox</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">processInbox</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222">processEntireInbox</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06">getAccount</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c">getContract</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4">getMint</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc">writeCheque</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd">signContract</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697">proposePaymentPlan</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad">confirmPaymentPlan</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec">notarizeTransfer</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654">notarizeWithdrawal</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c">withdrawVoucher</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602">notarizeDeposit</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506">notarizePurse</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209">notarizeCheque</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e">marketOffer</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75">paymentPlan</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9">setAccountName</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5">setNymName</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2">setServerName</a>, 
<br/>
&#160;&#160;<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f">setAssetName</a>, 
<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a62bf08fd3c45ca28403d88ac48400400">badID</a>
<br/>
 }</td></tr>
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a> (const int64_t &amp;lRequestNumber)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a4e77549b8bf6f582f8c30a361b42b1c7">IsRunningAsScript</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a7b1155d15226f5b512d7dd2c839a8cb9">SetRunningAsScript</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_message_buffer.html">OTMessageBuffer</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a36e39a99ff4495af7c8766da81d7b29b">GetMessageBuffer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_message_outbuffer.html">OTMessageOutbuffer</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a> (<a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServerContract, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="struct_transport_callback.html">TransportCallback</a> *pCallback)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a77bd8f98f5d1a62e37e233b9542337a7">ConnectToTheFirstServerOnList</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strCA_FILE, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strKEY_FILE, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strKEY_PASSWORD)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#aaed4f52867ed4de23ba1871aef930a5d">OTClient</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#adb75966e8195f25807fa5f521709109e">~OTClient</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#af93ba422f820281eb6022798563d588d">InitClient</a> (<a class="el" href="class_o_t_wallet.html">OTWallet</a> &amp;theWallet)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Need to call this before using.  <a href="#af93ba422f820281eb6022798563d588d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a> (char *buf, int32_t *pnExpectReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#afdce1f6ff6989facd771283605f4a3c4">ProcessMessageOut</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a198acbb6ccb266904ade30a94f9ed066">ProcessInBuffer</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theServerReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a> (<a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7">OT_CLIENT_CMD_TYPE</a> requestedCommand, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServer, <a class="el" href="class_o_t_account.html">OTAccount</a> *pAccount=NULL, int64_t lTransactionAmount=0, <a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> *pMyAssetContract=NULL, <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> *pHisNymID=NULL, <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> *pHisAcctID=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">ProcessServerReply</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply, <a class="el" href="class_o_t_ledger.html">OTLedger</a> *pNymbox=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">ProcessIncomingTransactions</a> (<a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;theConnection, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">ProcessWithdrawalResponse</a> (<a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;theTransaction, <a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;theConnection, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">ProcessDepositResponse</a> (<a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;theTransaction, <a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;theConnection, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">ProcessPayDividendResponse</a> (<a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;theTransaction, <a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;theConnection, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">AcceptEntireInbox</a> (<a class="el" href="class_o_t_ledger.html">OTLedger</a> &amp;theInbox, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;theServerID, <a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServerContract, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage, <a class="el" href="class_o_t_account.html">OTAccount</a> &amp;theAccount)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">AcceptEntireNymbox</a> (<a class="el" href="class_o_t_ledger.html">OTLedger</a> &amp;theNymbox, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;theServerID, <a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServerContract, <a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td colspan="2"><h2><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a056ffd57844757386743f7aac5cf1a32">m_lMostRecentRequestNumber</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00163">163</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
</div><hr/><h2>Member Enumeration Documentation</h2>
<a class="anchor" id="af16093cbd49040c8968e26f8456da0f7"></a><!-- doxytag: member="OTClient::OT_CLIENT_CMD_TYPE" ref="af16093cbd49040c8968e26f8456da0f7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7">OTClient::OT_CLIENT_CMD_TYPE</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13"></a><!-- doxytag: member="checkServerID" ref="af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13" args="" -->checkServerID</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2"></a><!-- doxytag: member="createUserAccount" ref="af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2" args="" -->createUserAccount</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821"></a><!-- doxytag: member="deleteUserAccount" ref="af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821" args="" -->deleteUserAccount</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871"></a><!-- doxytag: member="checkUser" ref="af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871" args="" -->checkUser</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b"></a><!-- doxytag: member="sendUserMessage" ref="af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b" args="" -->sendUserMessage</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004"></a><!-- doxytag: member="getRequest" ref="af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004" args="" -->getRequest</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee"></a><!-- doxytag: member="issueAssetType" ref="af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee" args="" -->issueAssetType</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13"></a><!-- doxytag: member="createAccount" ref="af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13" args="" -->createAccount</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3"></a><!-- doxytag: member="issueBasket" ref="af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3" args="" -->issueBasket</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374"></a><!-- doxytag: member="exchangeBasket" ref="af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374" args="" -->exchangeBasket</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645"></a><!-- doxytag: member="getTransactionNum" ref="af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645" args="" -->getTransactionNum</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a"></a><!-- doxytag: member="getNymbox" ref="af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a" args="" -->getNymbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76"></a><!-- doxytag: member="getInbox" ref="af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76" args="" -->getInbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113"></a><!-- doxytag: member="getOutbox" ref="af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113" args="" -->getOutbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7"></a><!-- doxytag: member="processNymbox" ref="af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7" args="" -->processNymbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00"></a><!-- doxytag: member="processEntireNymbox" ref="af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00" args="" -->processEntireNymbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97"></a><!-- doxytag: member="processInbox" ref="af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97" args="" -->processInbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222"></a><!-- doxytag: member="processEntireInbox" ref="af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222" args="" -->processEntireInbox</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06"></a><!-- doxytag: member="getAccount" ref="af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06" args="" -->getAccount</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c"></a><!-- doxytag: member="getContract" ref="af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c" args="" -->getContract</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4"></a><!-- doxytag: member="getMint" ref="af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4" args="" -->getMint</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc"></a><!-- doxytag: member="writeCheque" ref="af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc" args="" -->writeCheque</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd"></a><!-- doxytag: member="signContract" ref="af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd" args="" -->signContract</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697"></a><!-- doxytag: member="proposePaymentPlan" ref="af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697" args="" -->proposePaymentPlan</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad"></a><!-- doxytag: member="confirmPaymentPlan" ref="af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad" args="" -->confirmPaymentPlan</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec"></a><!-- doxytag: member="notarizeTransfer" ref="af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec" args="" -->notarizeTransfer</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654"></a><!-- doxytag: member="notarizeWithdrawal" ref="af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654" args="" -->notarizeWithdrawal</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c"></a><!-- doxytag: member="withdrawVoucher" ref="af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c" args="" -->withdrawVoucher</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602"></a><!-- doxytag: member="notarizeDeposit" ref="af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602" args="" -->notarizeDeposit</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506"></a><!-- doxytag: member="notarizePurse" ref="af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506" args="" -->notarizePurse</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209"></a><!-- doxytag: member="notarizeCheque" ref="af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209" args="" -->notarizeCheque</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e"></a><!-- doxytag: member="marketOffer" ref="af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e" args="" -->marketOffer</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75"></a><!-- doxytag: member="paymentPlan" ref="af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75" args="" -->paymentPlan</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9"></a><!-- doxytag: member="setAccountName" ref="af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9" args="" -->setAccountName</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5"></a><!-- doxytag: member="setNymName" ref="af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5" args="" -->setNymName</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2"></a><!-- doxytag: member="setServerName" ref="af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2" args="" -->setServerName</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f"></a><!-- doxytag: member="setAssetName" ref="af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f" args="" -->setAssetName</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="af16093cbd49040c8968e26f8456da0f7a62bf08fd3c45ca28403d88ac48400400"></a><!-- doxytag: member="badID" ref="af16093cbd49040c8968e26f8456da0f7a62bf08fd3c45ca28403d88ac48400400" args="" -->badID</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00192">192</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
<div class="fragment"><pre class="fragment">    {
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">checkServerID</a>, <span class="comment">// Your public key is sent along with this message so the server can reply to </span>
                       <span class="comment">// you even without your being a registered user. Other than these top two commands,</span>
                       <span class="comment">// all other commands can only be executed by registered users.</span>
                       <span class="comment">//</span>
                       <span class="comment">// The server ID is a hash of the server contract. The signature on the contract</span>
                       <span class="comment">// can be verified by a public key that appears in a standard section of any server</span>
                       <span class="comment">// contract. The URL/port information is also derived from the contract.</span>
                       <span class="comment">//</span>
                       <span class="comment">// Simply by importing the server contract into your wallet, you are able to connect</span>
                       <span class="comment">// to it and encrypt all of your communications to it.</span>
                       <span class="comment">//</span>
                       <span class="comment">// Thus, the check server ID command really just confirms what you should already know...</span>
                       <span class="comment">// Your wallet still wants to see that the server agrees with the server ID, and that</span>
                       <span class="comment">// the server is able to read messages that were encrypted to the public key in the</span>
                       <span class="comment">// contract, and that the server is able to sign all of its future correspondence with</span>
                       <span class="comment">// the same public key.</span>
                       <span class="comment">//</span>
                       <span class="comment">// It is the server operator&#39;s responsibility to secure the domain name and web host</span>
                       <span class="comment">// that users will connect to when they import the contract, as well as the private</span>
                       <span class="comment">// key that matches the public key from the contract.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">createUserAccount</a>, <span class="comment">// Create user account on a specific server, with public key. User ID will be hash of said public key.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821">deleteUserAccount</a>, <span class="comment">// Delete user account from a specific server.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871">checkUser</a>, <span class="comment">// Request a user&#39;s public key based on User ID included with the request.</span>
                   <span class="comment">// (If you want to send him cash or a check, your wallet will encrypt portions</span>
                   <span class="comment">// of the tokens, etc, to the Nym of the recipient.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b">sendUserMessage</a>, <span class="comment">// Send a message to another user, encrypted to his public key and dropped into his nymbox.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">getRequest</a>, <span class="comment">// Get the next request number from the server (for this user). Most requests must be</span>
                    <span class="comment">// accompanied by a request number, which increments for each Nym with each request.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee">issueAssetType</a>, <span class="comment">// Upload a currency contract to the server and create an asset ID from a hash of that. </span>
                        <span class="comment">// contract. Also creates an issuer account for that asset ID. This ONLY works if public</span>
                        <span class="comment">// key of the user matches the contract key found in the currency contract, AND if the</span>
                        <span class="comment">// contract is signed by the same key.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13">createAccount</a>,  <span class="comment">// Create an asset account for a certain serverID, UserID, and Asset Type ID.</span>
                        <span class="comment">// These accounts are where users actually store their digital assets of various</span>
                        <span class="comment">// types. Account files are stored on user&#39;s computer, signed by notary server.</span>
                        <span class="comment">// Server also maintains its own copy. Users can create an unlimited number of accounts</span>
                        <span class="comment">// for any asset type that they choose.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3">issueBasket</a>, <span class="comment">// Create a basket account, which is like an issuer account, but based on a basket of </span>
                     <span class="comment">// other asset types. This way, users can trade with what is apparently a single currency,</span>
                     <span class="comment">// when in fact the issuence is delegated and distributed across multiple issuers.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374">exchangeBasket</a>, <span class="comment">// Use this to exchange assets in and out of a basket currency.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">getTransactionNum</a>, <span class="comment">// Every transaction requires a transaction number. If your wallet doesn&#39;t have one,</span>
                           <span class="comment">// then here it can request the server to send one over. (Or several.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a">getNymbox</a>, <span class="comment">// Grab a copy of my nymbox (contains messages and new transaction numbers)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76">getInbox</a>, <span class="comment">// Grab a copy of my inbox from the server so I can decide what to do with it.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113">getOutbox</a>, <span class="comment">// Grab a copy of my outbox from the server so I can decide what to do with it.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">processNymbox</a>, <span class="comment">// Used by AcceptEntireNymbox() as it&#39;s setting everything up.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00">processEntireNymbox</a>,<span class="comment">// Instruct the server what to do with the various items sitting in my nymbox. (per user)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">processInbox</a>, <span class="comment">// Instruct the server what to do with the various items sitting in my inbox. (per asset acct)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222">processEntireInbox</a>, <span class="comment">// Just accept everything in the server (used in the command line test client.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06">getAccount</a>, <span class="comment">// Grab the server&#39;s copy of my asset account file, in case mine is lost.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c">getContract</a>, <span class="comment">// Grab the server&#39;s copy of any asset contract. Input is the asset type ID.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4">getMint</a>, <span class="comment">// Grab the server&#39;s copy of any mint based on Asset ID. (For blinded tokens.)</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc">writeCheque</a>, <span class="comment">// Write a cheque. (Actually sends no message to the server -- returns false.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd">signContract</a>, <span class="comment">// Sign a contract. (Sends no message to the server.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697">proposePaymentPlan</a>, <span class="comment">// (Merchant) Propose a payment plan. (Sends no message to the server.)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad">confirmPaymentPlan</a>, <span class="comment">// (Customer) Confirm a payment plan. (Sends no message to the server.)</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec">notarizeTransfer</a>, <span class="comment">// Request the server to transfer from one account to another.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654">notarizeWithdrawal</a>, <span class="comment">// Request the server to withdraw from an asset account and return digital cash tokens to the wallet.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c">withdrawVoucher</a>, <span class="comment">// Request the server to withdraw from an asset account and issue a voucher (cashier&#39;s cheque)</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602">notarizeDeposit</a>, <span class="comment">// Request the server to accept some digital cash and deposit it to an asset account.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506">notarizePurse</a>, <span class="comment">// Same as the above, but sends an entire purse of tokens at once instead of sending individual tokens.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209">notarizeCheque</a>, <span class="comment">// Deposit like the above, but deposits a cheque instead of cash tokens.</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e">marketOffer</a>, <span class="comment">// Create an Offer object and add it to one of the server&#39;s Market objects.</span>
        <span class="comment">// This will also create a Trade object and add it to the server&#39;s Cron object.</span>
        <span class="comment">// (The Trade provides the payment authorization for the Offer, as well as the rules</span>
        <span class="comment">// for processing and expiring it.)</span>

        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75">paymentPlan</a>, <span class="comment">// Send a payment plan to the server (request to activate one onto yourself, basically.)</span>
        <span class="comment">// The test client will ask you to input the plan, which you must already have (like a cheque).</span>
        <span class="comment">// The Payee must create it and sign it, then he sends it to the Payer, who uses this command</span>
        <span class="comment">// to sign it and submit it to the server.</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9">setAccountName</a>, <span class="comment">// For setting the client-side label on an asset account.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5">setNymName</a>, <span class="comment">// For setting the client-side label on a Nym.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2">setServerName</a>, <span class="comment">// For setting the client-side label on a server contract.</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f">setAssetName</a>, <span class="comment">// For setting the client-side label on an asset contract.</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a62bf08fd3c45ca28403d88ac48400400">badID</a>
    };
</pre></div>
</div>
</div>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="aaed4f52867ed4de23ba1871aef930a5d"></a><!-- doxytag: member="OTClient::OTClient" ref="aaed4f52867ed4de23ba1871aef930a5d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_client.html#aaed4f52867ed4de23ba1871aef930a5d">OTClient::OTClient</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l10720">10720</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                   :
    m_pWallet(NULL), 
    m_bRunningAsScript(<span class="keyword">false</span>), 
    <a class="code" href="class_o_t_client.html#a056ffd57844757386743f7aac5cf1a32">m_lMostRecentRequestNumber</a>(0), 
    <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>(NULL), 
    <a class="code" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a>(<span class="keyword">false</span>)
{

}
</pre></div>
</div>
</div>
<a class="anchor" id="adb75966e8195f25807fa5f521709109e"></a><!-- doxytag: member="OTClient::~OTClient" ref="adb75966e8195f25807fa5f521709109e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_client.html#adb75966e8195f25807fa5f521709109e">OTClient::~OTClient</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l10730">10730</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>)
        <span class="keyword">delete</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>;
    <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a> = NULL;

    <span class="comment">// (FYI, Moved openssl cleanup to OT_Cleanup.)</span>
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a8e026d8854d91883c369c486c8355eb7"></a><!-- doxytag: member="OTClient::AcceptEntireInbox" ref="a8e026d8854d91883c369c486c8355eb7" args="(OTLedger &amp;theInbox, const OTIdentifier &amp;theServerID, OTServerContract &amp;theServerContract, OTPseudonym &amp;theNym, OTMessage &amp;theMessage, OTAccount &amp;theAccount)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">OTClient::AcceptEntireInbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_ledger.html">OTLedger</a> &amp;&#160;</td>
          <td class="paramname"><em>theInbox</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerContract</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> &amp;&#160;</td>
          <td class="paramname"><em>theAccount</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Without regard to WHAT those transactions ARE that are in my inbox, just process and accept them all!!! (This is AUTO-ACCEPT functionality built into the test client and not the library itself.) </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00920">920</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
    <span class="comment">// ---------------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym      = &amp;theNym;
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theAccountID(theInbox);
    <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount  = &amp;theAccount;
    <a class="code" href="class_o_t_ledger.html">OTLedger</a>    * pOutbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym); <span class="comment">// Need this for balance agreement (outbox hash)</span>
    <span class="comment">// ---------------------------------------------</span>
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox); <span class="comment">// auto cleanup.</span>
    <span class="comment">// ---------------------------------------------</span>
    <span class="keywordflow">if</span> (NULL == pOutbox)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTClient::AcceptEntireInbox: Failed loading outbox!\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------------------    </span>
    <span class="keywordflow">if</span> (theInbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &lt; 1) 
    {
        <span class="comment">// If there aren&#39;t any transactions in the inbox, no point wasting a # to process an empty box.</span>
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTClient::AcceptEntireInbox: no point wasting a transaction number in order to process an empty box\n&quot;</span>);

        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------------------</span>
    <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
    int64_t lStoredTransactionNumber=0;
    <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber); <span class="comment">// Warning: this saves the nym if successful.</span>
    <span class="comment">// ---------------------------------------------</span>
    <span class="keywordflow">if</span> (!bGotTransNum)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: No transaction numbers are available. Suggest requesting the server for a new one.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// the message to the server will contain a ledger to be processed for a specific acct.</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> processLedger(theInbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theAccountID, theServerID);    

    <span class="comment">// bGenerateFile defaults to false on GenerateLedger call, so I left out the false.</span>
    processLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(theAccountID, theServerID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// Can&#39;t just use one of these. It either has to be read out of a file or</span>
    <span class="comment">// a string, or it has to be generated. So you construct it, then you either</span>
    <span class="comment">// call GenerateLedger or LoadInbox, then you call VerifyContractID to make sure</span>
    <span class="comment">// it loaded securely. (No need to verify if you just generated it.)</span>

    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pAcceptTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theInbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), 
        theAccountID, theServerID, <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTTransaction::processInbox</a>, lStoredTransactionNumber);

    <span class="comment">// ---------------------------------------------</span>
    <span class="comment">// This insures that the ledger will handle cleaning up the transaction, so I don&#39;t have to delete it later.</span>
    processLedger.AddTransaction(*pAcceptTransaction);

    <span class="comment">// loop through the transactions in theInbox, and create corresponding &quot;accept&quot; items</span>
    <span class="comment">// for each one of the transfer requests. Each of those items will go into a single</span>
    <span class="comment">// &quot;process inbox&quot; transaction that I will add to the processledger and thus to the </span>
    <span class="comment">// outgoing message.</span>

    int64_t lAdjustment = 0; <span class="comment">// If I accept any pending transactions, I must take note of any adjustment when I sign the balance agreement.</span>

    <span class="comment">// If transaction #s that have been ISSUED to pNym are being REMOVED by this transaction,</span>
    <span class="comment">// then we use this temporary Nym (theIssuedNym) to store the ones that are being removed,</span>
    <span class="comment">// so that we can remove them from the Nym, calculate the balance agreement, and then add them</span>
    <span class="comment">// back on again. (They aren&#39;t removed for real until the server &quot;success&quot; reply comes back.)</span>
    <span class="comment">//</span>
    <span class="comment">// WARNING: Take care not to add them BACK, unless they really were there in the first place!</span>
    <span class="comment">// Otherwise you have just been tricked into adding numbers to pNym that weren&#39;t even there,</span>
    <span class="comment">// versus what you thought you were doing (re-adding numbers to pNym that HAD been there, and</span>
    <span class="comment">// had only been temporarily removed in order to perform a calculation.)</span>
    <span class="comment">//</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theIssuedNym;

    <span class="comment">// For each transaction in the inbox, if it&#39;s in reference to a transfer request,</span>
    <span class="comment">// then create an &quot;accept&quot; item for that transfer request, and add it to my own, new,</span>
    <span class="comment">// &quot;process inbox&quot; transaction that I&#39;m sending out.</span>
    <span class="comment">//</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
    {
        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);

        <span class="comment">// If this transaction references the item that I&#39;m trying to accept...</span>
        <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() &gt; 0) <span class="comment">// if pointer not null AND it refers to some other transaction</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strRespTo;
            pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strRespTo);

            <span class="comment">// Sometimes strRespTo contains an OTPaymentPlan or an OTTrade. (Or an OTSmartContract.)</span>
            <span class="comment">// The rest of the time, it contains an OTItem.</span>
            <span class="comment">//</span>
            <span class="comment">// The reason is because in most cases I have the original item</span>
            <span class="comment">// right there, so I attach it. But with payment plans and trades,</span>
            <span class="comment">// the original payment plan itself, or trade itself, is being loaded</span>
            <span class="comment">// by Cron (as a cron receipt) for reference reasons, and thus it is</span>
            <span class="comment">// the most appropriate object to attach in that case, and also, the</span>
            <span class="comment">// OTItem is not available in that context, since we aren&#39;t even processing</span>
            <span class="comment">// a message, but rather, we are in Cron, processing a trade or some</span>
            <span class="comment">// other sort of cron item.</span>

            <span class="comment">// ************************************************************************</span>

            <span class="comment">// PAYMENT RECEIPT, MARKET RECEIPT</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>  == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
            {               
                <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>);

                <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                <span class="comment">// Set up the &quot;accept&quot; transaction item to be sent to the server, by referencing</span>
                <span class="comment">// the transaction number of the receipt. Normally, when accepting a pending</span>
                <span class="comment">// transaction, I set the &quot;in reference to&quot; to the transaction number of the</span>
                <span class="comment">// original transfer that I am accepting.</span>
                <span class="comment">//</span>
                <span class="comment">// But I cannot do this with a market receipt, or a payment plan receipt,</span>
                <span class="comment">// since there may be MULTIPLE RECEIPTS REFERENCING THE SAME NUMBER (they will</span>
                <span class="comment">// all reference the original payment plan / offer.) Thus, in the case of receipts,</span>
                <span class="comment">// I accept by setting the &quot;in reference to&quot; to the RECEIPT&#39;s transaction number,</span>
                <span class="comment">// since each receipt represents a distinct transaction anyway, and I must</span>
                <span class="comment">// accept them individually, and that is the number that identifies them uniquely.</span>

                pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pTransaction);

                pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my inbox.</span>
                <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                <span class="comment">// Nothing here to remove via theIssuedNym. In this case, the transaction came from the server.</span>
                <span class="comment">// Only my ORIGINAL request to enter the payment plan can be removed, and that only happens when the</span>
                <span class="comment">// finalReceipt is issued, not when a single receipt is removed. Therefore, I can only accept the</span>
                <span class="comment">// receipt from my inbox, but this moment here doesn&#39;t free up any of my issued transaction numbers.</span>
                <span class="comment">//</span>
<span class="comment">//              if (pNym-&gt;VerifyIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum()))</span>
<span class="comment">//                  theIssuedNym.AddIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum());</span>
<span class="comment">//              else {error}</span>

                <span class="comment">// I don&#39;t attach the original payment plan or trade here, </span>
                <span class="comment">// because I already reference it by transaction num of the receipt,</span>
                <span class="comment">// and the server can look it up in my inbox from there.</span>

                <span class="comment">// This just makes it convenient later.</span>
                pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()); <span class="comment">// The server will verify this actually matches, or reject the message.</span>

                <span class="comment">// sign the item</span>
                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            } <span class="comment">// if market receipt or payment receipt (cron receipt)</span>

            <span class="comment">// ************************************************************************</span>

            <span class="comment">// FINAL RECEIPT, BASKET RECEIPT</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
            {       
                <span class="comment">// Since the &quot;in reference to&quot; is supposedly already closed, then let&#39;s just</span>
                <span class="comment">// MAKE SURE of that, since otherwise it&#39;ll screw up my future balance agreements.</span>
                <span class="comment">// (The instant a finalReceipt appears, the &quot;in ref to&quot; is already gone. Let it go.)</span>
                <span class="comment">//</span>
                <span class="comment">//  todo security: make sure not to actually remove this number unless I double check</span>
                <span class="comment">// it against a client-side list of open transaction numbers for cron items (expecting</span>
                <span class="comment">// final receipts.) Unless the number appears on that list, don&#39;t remove it. And then,</span>
                <span class="comment">// remove it from the list as well. The server already has a mechanism like this.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                {
                    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                    <span class="comment">// ----------------------------------------------</span>
                    <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
                    <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
                    <span class="comment">// market offers in that list, since we already have a list of active</span>
                    <span class="comment">// market offers separately. And market offers produce final receipts,</span>
                    <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
                    <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
                    <span class="comment">// It is for the others.</span>
                    <span class="comment">//</span>
                    <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
                    <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
                    <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
                    <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
                    <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                                       pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                                       pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
                }
                <span class="comment">// ----------------------------------------------</span>
                <span class="comment">//</span>
                <span class="comment">// pNym won&#39;t actually save unless it actually removes that #. If the #&#39;s already NOT THERE,</span>
                <span class="comment">// then the removal will fail, and thus it won&#39;t bother saving here.</span>

                <span class="comment">// If I accept the finalReceipt or basketReceipt, that will remove its CLOSING NUM from my issued list.</span>
                <span class="comment">// (Its &quot;in reference to&quot; num is already closed by now.)</span>
                <span class="comment">//  </span>
                <span class="comment">// For security, ONLY add the number to theIssuedNym (to indicate it&#39;s being removed) if</span>
                <span class="comment">// it WAS actually already there on the Nym. Otherwise it&#39;ll get &quot;re-added&quot; when it wasn&#39;t</span>
                <span class="comment">// there in the first place!</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::AcceptEntireInbox: final or basket receipt, trying to &#39;remove&#39; an issued &quot;</span>
                    <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
                    <span class="stringliteral">&quot;then? Maybe you need to download a fresh copy of it.)\n&quot;</span>, 
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());

                <span class="keywordflow">else</span> <span class="comment">// Success.</span>
                {
                    theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());

                    <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = 
                        <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, 
                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ?
                        <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a> : <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>);

                    <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                    pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                    pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pTransaction);

                    pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my inbox.</span>
                    <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                    <span class="comment">// This just makes it convenient later.</span>
                    pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());
                    <span class="comment">// The server will verify this actually matches, or reject the message.</span>

                    <span class="comment">// sign the item</span>
                    pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                    pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();        
                }

                <span class="comment">// -----------------------------------------------</span>
            } <span class="comment">// if finalReceipt or basketReceipt</span>

            <span class="comment">// ************************************************************************</span>

            <span class="comment">// PENDING (incoming transfer)</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                )
            {               
                <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strRespTo, theServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theAngel(pOriginalItem);

                <span class="comment">// This item was attached as the &quot;in reference to&quot; item. Perhaps Bob sent it to me.</span>
                <span class="comment">// Since that item was initiated by him, HIS would be the account ID on it, not mine.</span>
                <span class="comment">// So I DON&#39;T want to create it with my account ID on it.</span>
                <span class="keywordflow">if</span> (pOriginalItem)
                {
                    <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>  == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
                        (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a>    == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))  <span class="comment">// I&#39;m accepting a transfer that was sent to me. (A .PENDING .TRANSFER .REQUEST)</span>
                    {
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>);
                        <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                        pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                        <span class="comment">// Set up the &quot;accept&quot; transaction item to be sent to the server </span>
                        <span class="comment">// (this item references and accepts another item by its transaction number--</span>
                        <span class="comment">// But on the server side, it doesn&#39;t look for the inbox item with that number.</span>
                        <span class="comment">// Rather, it looks for the inbox item that is &quot;in reference to&quot; that number. Notice</span>
                        <span class="comment">// therefore, my own accept item is below ALSO set to be &quot;in reference to&quot; the number</span>
                        <span class="comment">// of the original item.  The server uses this info to find the pending transaction.</span>

                        <a class="code" href="class_o_t_string.html">OTString</a> strNote;
                        pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strNote);

                        <span class="keywordflow">if</span> (strNote.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                            pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
                        <span class="comment">// ----------------------------------------------</span>
                        pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pOriginalItem);
                        pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
                        <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                        <span class="comment">// This just makes it convenient later.</span>
                        pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()); <span class="comment">// The server will verify this actually matches, or reject the message.</span>

                        lAdjustment += (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()); <span class="comment">// Bob transferred me 50 clams. If my account was 100, it WILL be 150. Therefore, adjustment is +50. </span>

                        <span class="comment">// Nothing to remove in this case, since the transfer was initiated by someone else.</span>
                        <span class="comment">//                      if (pNym-&gt;VerifyIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum()))</span>
                        <span class="comment">//                          theIssuedNym.AddIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum());</span>
                        <span class="comment">// else { error }</span>

                        <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
                        <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
                        <span class="comment">// enough info to look it up again.</span>

                        <span class="comment">// sign the item</span>
                        pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                        pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <span class="keyword">const</span> int32_t nOriginalType = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>( <span class="stringliteral">&quot;Unrecognized item type (%d) while processing inbox.\n&quot;</span>
                            <span class="stringliteral">&quot;(Only pending transfers, payment receipts, market receipts, &quot;</span>
                            <span class="stringliteral">&quot;cheque receipts, and transfer receipts are operational inbox items at this time.)\n&quot;</span>,
                            nOriginalType);
                    }
                }
                <span class="keywordflow">else</span> 
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading transaction item from string in OTClient::AcceptEntireInbox\n&quot;</span>);
                }
            } <span class="comment">// else if pending</span>

            <span class="comment">// ************************************************************************</span>

            <span class="comment">// TRANSFER RECEIPT, CHEQUE RECEIPT</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>     == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>      == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                )
            {               
                <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strRespTo, theServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theAngel(pOriginalItem);

                <span class="comment">// This item was attached as the &quot;in reference to&quot; item. Perhaps Bob sent it to me.</span>
                <span class="comment">// Since that item was initiated by him, HIS would be the account ID on it, not mine.</span>
                <span class="comment">// So I DON&#39;T want to create it with my account ID on it.</span>
                <span class="keywordflow">if</span> (pOriginalItem)
                {
                    <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                        &amp;&amp;
                        <span class="comment">// In a real client, the user would pick and choose which items he wanted</span>
                        <span class="comment">// to accept or reject. We, on the other hand, are blindly accepting all of</span>
                        <span class="comment">// these types:</span>
                        (
                        (
                        (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>          == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp; <span class="comment">// I&#39;m accepting a transfer receipt.</span>
                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                        )  
                        || 
                        (
                        (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>        == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;    <span class="comment">// I&#39;m accepting a notice that someone cashed my cheque or voucher.</span>
                        ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>  == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
                        )
                        )
                        )
                    {                       
                        <span class="comment">// If pOriginalItem is acceptPending, that means I&#39;m accepting the transfer receipt from the server,</span>
                        <span class="comment">// which has the recipient&#39;s acceptance inside of it as the original item. This means the transfer that</span>
                        <span class="comment">// *I* originally sent is now finally closed!</span>
                        <span class="comment">// </span>
                        <span class="comment">// If it&#39;s a depositCheque, that means I&#39;m accepting the cheque receipt from the server,</span>
                        <span class="comment">// which has the recipient&#39;s deposit inside of it as the original item. This means that the cheque that</span>
                        <span class="comment">// *I* originally wrote is now finally closed!</span>
                        <span class="comment">//</span>
                        <span class="comment">// In both cases, the &quot;original item&quot; itself is not from me, but from the recipient! Therefore,</span>
                        <span class="comment">// the number on that item is useless to me (for removing numbers from my own list of issued numbers.)</span>
                        <span class="comment">// Rather, I need to load that original cheque, or pending transfer, from WITHIN the original item,</span>
                        <span class="comment">// in order to get THAT number, to remove it from my issued list. *sigh*</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// We&#39;re accepting a chequeReceipt or voucherReceipt.</span>
                        {
                            <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);

                            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>

                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp; 
                                theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: ERROR loading cheque or voucher from string:\n%s\n&quot;</span>,
                                    __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            }
                            <span class="keywordflow">else</span>
                            {
                                <span class="comment">// IF it&#39;s actually there on pNym, then schedule it for removal.</span>
                                <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>()))
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: cheque or voucher receipt, trying to &#39;remove&#39; an issued &quot;</span>
                                    <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
                                    <span class="stringliteral">&quot;then? Maybe need to download a fresh copy of it.)\n&quot;</span>, __FUNCTION__,
                                    theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
                                <span class="keywordflow">else</span>
                                {
                                    theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());

                                    <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>);
                                    <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                                    pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                                    pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());

                                    <span class="comment">// In this case, this reference number is someone else&#39;s responsibility, not mine. (Someone ELSE deposited my cheque.) ...But I still reference it.</span>
                                    pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
                                    <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                                    <span class="comment">// Server rejects the message if these don&#39;t match.</span>
                                    pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());

                                    <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
                                    <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
                                    <span class="comment">// enough info to look it up again.</span>

                                    <span class="comment">// sign the item</span>
                                    pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                    pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                }
                            }
                        }
                        <span class="comment">// ---------------------------------------------------------</span>

                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// We&#39;re accepting a transferReceipt.</span>
                        {
                            <span class="comment">// IF it&#39;s actually there on pNym, then schedule it for removal.</span>
                            <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>()))
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: transfer receipt, trying to &#39;remove&#39; an issued &quot;</span>
                                <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
                                <span class="stringliteral">&quot;then? Maybe need to download a fresh copy of it.)\n&quot;</span>, 
                                __FUNCTION__, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
                            <span class="keywordflow">else</span>
                            {
                                theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());

                                <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>);
                                <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                                pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                                pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pOriginalItem);

                                <span class="comment">// In this case, this reference number is someone else&#39;s responsibility, not mine. (Someone ELSE deposited my cheque.) ...But I still reference it.</span>
                                pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
                                <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                                pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());

                                <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
                                <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
                                <span class="comment">// enough info to look it up again.</span>

                                <span class="comment">// sign the item</span>
                                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                            }
                        }
                        <span class="keywordflow">else</span> 
                        {
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::AcceptEntireInbox: Error: wrong pOriginalItem type.\n&quot;</span>);
                        }
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <span class="keyword">const</span> int32_t nOriginalType = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>( <span class="stringliteral">&quot;Unrecognized item type (%d) while processing inbox.\n&quot;</span>
                            <span class="stringliteral">&quot;(Only pending transfers, payment receipts, market receipts, cheque &quot;</span>
                            <span class="stringliteral">&quot;receipts, and transfer receipts are operational inbox items at this time.)\n&quot;</span>, 
                            nOriginalType);
                    }
                }
                <span class="keywordflow">else</span> 
                {
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading transaction item from string in OTClient::AcceptEntireInbox\n&quot;</span>);
                }               
            } <span class="comment">// else if transfer receipt or cheque receipt. (item receipt)</span>

            <span class="comment">// ************************************************************************</span>

        } <span class="comment">// if pTransaction</span>

        <span class="comment">// This will have to go through the nymbox from now on, so I get explicit sign-off on each number.</span>
        <span class="comment">//      if (pTransaction)     </span>
        <span class="comment">//      {</span>
        <span class="comment">//          HarvestTransactionNumbers(*pTransaction, *pNym);    </span>
        <span class="comment">//      }</span>
    } <span class="comment">// for --------------------------------------------</span>


    <span class="comment">// If the above processing resulted in us actually accepting certain specific items,</span>
    <span class="comment">// then let&#39;s process the message out to the server.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aab7ec90e81dc8f273b8c29617e40bab6">GetItemCount</a>())
    {
        <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<span class="comment">//      OTAssetContract * pAssetContract    = theConnection.GetWallet()-&gt;GetAssetContract(pAccount-&gt;GetAssetTypeID());</span>

        <span class="keywordflow">if</span> (pAccount &amp;&amp; (<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTClient::processInbox</a>, theMessage, 
            *pNym, 
            <span class="comment">//                                         *(pAssetContract),</span>
            theServerContract,
            <span class="comment">//                                         *(theConnection.GetServerContract()), </span>
            pAccount) &gt; 0)) 
        {
            <span class="comment">// the message is all set up and ready to go out... it&#39;s even signed.</span>
            <span class="comment">// Except the ledger we&#39;re sending, still needs to be added, and then the</span>
            <span class="comment">// message needs to be re-signed as a result of that.</span>

            theInbox.<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>(); <span class="comment">// Since this function accepts them ALL, the new balance agreement needs to show it as empty.</span>

            <span class="comment">// -----------------------------------------</span>

            <span class="comment">// By this point, theIssuedNym contains a list of all the transaction numbers that are issued to me,</span>
            <span class="comment">// but that will NOT be issued to me anymore once this processInbox is processed.</span>
            <span class="comment">// Therefore I need to REMOVE those items from my issued list (at least temporarily) in order to</span>
            <span class="comment">// calculate the balance agreement properly. So I used theIssueNym as a temp variable to store those</span>
            <span class="comment">// numbers, so I can remove them from my Nym and them add them again after generating the statement.</span>
            <span class="comment">//</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
            {
                int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp);
            }

            <span class="comment">// -----------------------------------------</span>

            <span class="comment">// BALANCE AGREEMENT </span>
            <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = theInbox.<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lAdjustment, *pAcceptTransaction, *pNym, *pAccount, *pOutbox);

            <span class="comment">// -----------------------------------------</span>

            <span class="comment">// Here I am adding these numbers back again, since I removed them to calculate the balance agreement.</span>
            <span class="comment">// (They won&#39;t be removed for real until I receive the server&#39;s acknowledgment that those numbers</span>
            <span class="comment">// really were removed. Until then I have to keep them and use them for my balance agreements.)</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
            {
                int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTemp);
            }

            <span class="comment">// -----------------------------------------</span>

            <span class="keywordflow">if</span> (NULL != pBalanceItem)
                pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Should never happen.\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------</span>

            <span class="comment">// Sign the accept transaction, as well as the message ledger </span>
            <span class="comment">// that we&#39;ve just constructed containing it.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            processLedger.SignContract(*pNym);
            processLedger.SaveContract();

            <span class="comment">// Extract the ledger into string form and add it as the payload on the message.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strLedger(processLedger);
            theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);

            <span class="comment">// Release any other signatures from the message, since I know it</span>
            <span class="comment">// was signed already in the above call to ProcessUserCommand.</span>
            theMessage.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();

            <span class="comment">// Sign it and send it out.</span>
            <span class="comment">//          theConnection.SignAndSend(theMessage);</span>
            <span class="comment">// I could have called SignContract() and then theConnection.ProcessMessageOut(message) </span>
            <span class="comment">// but I used the above function instead.</span>

            bSuccess = <span class="keyword">true</span>; <span class="comment">// Otherwise we haven&#39;t really burned the transaction num, and need to put it back (below).</span>
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error processing processInbox command in OTClient::AcceptEntireInbox\n&quot;</span>);
    }

    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccess)
        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>

    <span class="keywordflow">return</span> bSuccess;
}
</pre></div>
</div>
</div>
<a class="anchor" id="acba6f91239e6035d1c426d0d00e7537e"></a><!-- doxytag: member="OTClient::AcceptEntireNymbox" ref="acba6f91239e6035d1c426d0d00e7537e" args="(OTLedger &amp;theNymbox, const OTIdentifier &amp;theServerID, OTServerContract &amp;theServerContract, OTPseudonym &amp;theNym, OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">OTClient::AcceptEntireNymbox</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_ledger.html">OTLedger</a> &amp;&#160;</td>
          <td class="paramname"><em>theNymbox</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerContract</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This is standard behavior for the Nymbox (NOT the inbox.) That is, to just accept everything there. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00254">254</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (theNymbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &lt; 1) 
    {
        <span class="comment">// If there aren&#39;t any notices in the nymbox, no point wasting a # to process an empty box.</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;%s: Nymbox is empty.\n&quot;</span>, __FUNCTION__);

        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNymbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(theNym)) 
    {
        <span class="comment">// If there aren&#39;t any notices in the nymbox, no point wasting a # to process an empty box.</span>
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: VerifyAccount() failed.\n&quot;</span>, __FUNCTION__);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym  = &amp;theNym;
<span class="comment">//  OTPseudonym * pNym  = theConnection.GetNym();</span>

<span class="comment">//  OTIdentifier theServerID;</span>
<span class="comment">//  theConnection.GetServerID(theServerID);</span>
<span class="comment">//</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNymID(*pNym);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID), strNymID(theNymID);

    int64_t lHighestNum=0;
    <span class="comment">// get the last/current highest transaction number for the serverID.</span>
    <span class="comment">// (making sure we&#39;re not being slipped any new ones with a lower value</span>
    <span class="comment">// than this.)</span>
    <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotHighestNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a519cdd66f0b7eccb54e77ced3b827cb8">GetHighestNum</a>(strServerID, lHighestNum); 

    <span class="comment">// Contrasting Inbox and Nymbox.</span>
    <span class="comment">//</span>
    <span class="comment">// In &quot;AcceptEntireInbox&quot;, I have to have a transaction number in order to accept the inbox.</span>
    <span class="comment">// But I ALSO need to RECEIVE my transaction number THROUGH an inbox, so the server can get </span>
    <span class="comment">// my signature on that number (that&#39;s the only way to hold me responsible for it, AND to</span>
    <span class="comment">// later prove I&#39;m NOT responsible for it when it&#39;s spent, without having to worry about</span>
    <span class="comment">// saving account history forever, via so-called &quot;destruction of account history.&quot;)</span>
    <span class="comment">//</span>
    <span class="comment">// So how can I receive a number, if I don&#39;t have anymore?  My solution is to receive all</span>
    <span class="comment">// transaction numbers through the NYMBOX, which is associated with Nym instead of asset account.</span>
    <span class="comment">// That is: you RECEIVE numbers through the Nymbox, and you SPEND numbers through the Inbox.</span>
    <span class="comment">//</span>
    <span class="comment">// (You can also receive messages through your nymbox.)  This way, I can require a transaction</span>
    <span class="comment">// number for an INBOX (since asset accounts can have changing balances) but I do NOT have</span>
    <span class="comment">// to require one for processing the NYMBOX (since users HAVE NO balances.) I can still </span>
    <span class="comment">// get the signed receipt during this time in order to satisfy destruction of acct history.</span>
    <span class="comment">// Perfect!</span>
    <span class="comment">//</span>
    <span class="comment">// Due to all this, lStoredTransactionNumber will be 0 for now.  If I have to assign a number</span>
    <span class="comment">// to it, then I will (probably the request number) but I will NOT be using a real</span>
    <span class="comment">// transaction number here, since this is the NYMBOX.</span>
    <span class="comment">//</span>
    int64_t lStoredTransactionNumber=0;

    <span class="comment">// the message to the server will contain a ledger to be processed for a specific acct. (in this case no acct, but user ID used twice instead.)</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> processLedger(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID);  

    <span class="comment">// bGenerateFile defaults to false on GenerateLedger call, so I left out the false.</span>
    processLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>);    <span class="comment">// Can&#39;t just use one of these. It either has to be read out of a file or</span>
    <span class="comment">// a string, or it has to be generated. So you construct it, then you either</span>
    <span class="comment">// call GenerateLedger or LoadInbox, then you call VerifyContractID to make sure</span>
    <span class="comment">// it loaded securely. (No need to verify if you just generated it.)</span>

    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pAcceptTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), 
        theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID, 
        <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTTransaction::processNymbox</a>, lStoredTransactionNumber);


    <span class="comment">// This insures that the ledger will handle cleaning up the transaction, so I don&#39;t have to delete it later.</span>
    processLedger.AddTransaction(*pAcceptTransaction);

    <span class="comment">// loop through the transactions in theNymbox, and create corresponding &quot;accept&quot; items</span>
    <span class="comment">// for each one of the transfer requests. Each of those items will go into a single</span>
    <span class="comment">// &quot;process nymbox&quot; transaction that I will add to the processledger and thus to the </span>
    <span class="comment">// outgoing message.</span>

    <span class="comment">// theIssuedNym     == transaction numbers being added.</span>
    <span class="comment">// theRemovedNym    == transaction numbers being removed. (finalReceipt notices about opening numbers for cron items.)</span>
    <span class="comment">// theTentativeNym  == transaction numbers being tentatively added. (I keep a )</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theIssuedNym, theRemovedNym;

    std::set&lt;int64_t&gt; setNoticeNumbers;  <span class="comment">// Trans#s I&#39;ve successfully signed for, and have a notice of this from the server.</span>

    <span class="comment">// For each transaction in the nymbox, if it&#39;s in reference to a transaction request,</span>
    <span class="comment">// then create an &quot;accept&quot; item for that blank transaction, and add it to my own, new,</span>
    <span class="comment">// &quot;process nymbox&quot; transaction that I&#39;m sending out.</span>
    <span class="comment">//</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theNymbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
    {
        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
        <span class="comment">// ------------------------------------------------------------     </span>
        <span class="comment">// This is now possible (abbreviated notices in the box), since we try to avoid </span>
        <span class="comment">// downloading replyNotices if we can help it. So we only error if it&#39;s abbreviated</span>
        <span class="comment">// but NOT a replyNotice.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>() &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>))
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%sx: Error: Unexpected abbreviated receipt in Nymbox, even after supposedly &quot;</span>
                <span class="stringliteral">&quot;loading all box receipts. (And it&#39;s not a replyNotice, either!)\n&quot;</span>, __FUNCTION__);
<span class="comment">//          return false;</span>
        }
        <span class="comment">// -----------------------------------------------------    </span>
        <span class="comment">//      OTString strTransaction(*pTransaction);</span>
        <span class="comment">//      OTLog::vError(&quot;TRANSACTION CONTENTS:\n%s\n&quot;, strTransaction.Get());</span>

        <a class="code" href="class_o_t_string.html">OTString</a> strRespTo;
        pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strRespTo);
        <span class="comment">//      OTLog::vError(&quot;TRANSACTION \&quot;IN REFERENCE TO\&quot; CONTENTS:\n%s\n&quot;, strRespTo.Get());  </span>
        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// MESSAGE (From Another Nym)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
        {               
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>);

            <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
            <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

            <span class="comment">// sign the item</span>
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Received an encrypted message in your Nymbox:\n%s\n&quot;</span>, __FUNCTION__,
                strRespTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="comment">// Todo: really shouldn&#39;t do this until we get a successful REPLY from the server.</span>
            <span class="comment">// That&#39;s when I do a lot of other things. But this is a no-biggie thing. It will almost</span>
            <span class="comment">// always succeed and in the odd-event that it fails, I&#39;ll end up with a duplicate message</span>
            <span class="comment">// in my mail. So what?</span>
            <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;

            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);

            <span class="comment">// The original message that was sent to me (with an encrypted envelope in the payload,</span>
            <span class="comment">// and with the sender&#39;s ID and recipient IDs as m_strNymID and m_strNymID2) is stored</span>
            <span class="comment">// within strRespTo. Let&#39;s load it up into an OTMessage instance, and add it to pNym&#39;s mail.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (pMessage-&gt;LoadContractFromString(strRespTo))
            {
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#abda249e911a4ddc8db3c97e58b3423fb">AddMail</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;mail&quot;.</span>
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
            <span class="keywordflow">else</span> 
            {
                <span class="keyword">delete</span> pMessage; <span class="comment">// Don&#39;t want to leak otherwise.</span>
                pMessage = NULL;
            }
        } <span class="comment">// if message</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// INSTRUMENT (From Another Nym)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
        {               
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);

            <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
            <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

            <span class="comment">// sign the item</span>
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Received an encrypted instrument in your Nymbox:\n%s\n&quot;</span>,
                __FUNCTION__, strRespTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        } <span class="comment">// if instrument</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// SERVER NOTIFICATION </span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
        {               
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);

            <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
            <span class="comment">// FYI, we don&#39;t need to set transaction num on item, since the constructor already got it off the owner transaction.</span>

            <span class="comment">// sign the item</span>
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

<span class="comment">//          OTLog::vOutput(0, &quot;%s: Received a server notification in your Nymbox:\n%s\n&quot;,</span>
<span class="comment">//                         __FUNCTION__, strRespTo.Get());</span>

            <span class="comment">// Todo: stash these somewhere, just like messages are in the pNym-&gt;AddMail() feature.</span>
            <span class="comment">// NOTE: Most likely we still stash these in the paymentInbox just the same as instrumentNotice (above)</span>

        } <span class="comment">// if notice</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// It&#39;s a NEW Transaction Number that I ALREADY signed for, and this notice means it was a success.</span>
        <span class="comment">// The server puts these in the Nymbox just in case -- helps to prevent synchronization issues.</span>
        <span class="comment">//</span>
        <span class="comment">// This means the new number was successfully already added to me.</span>
        <span class="comment">// Therefore I need to add it to my side also, so my balance agreements will work.</span>
        <span class="comment">// However, ONLY if I find the number on my tentative list, where I stored when I</span>
        <span class="comment">// first signed for the number, in order to make sure the server couldn&#39;t lie to me</span>
        <span class="comment">// later by slipping me a successNotice for one I never really signed for.</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if successNotice (new; ALREADY just added) transaction number.</span>
            )
        {
            <span class="comment">// The numbers on this set were (1) received in a successNotice, (2) found on my Tentative list,</span>
            <span class="comment">// and (3) Therefore have ALREADY been added as numbers in the past. Therefore I need to REMOVE</span>
            <span class="comment">// them from my tentative list, and add them as actual transactions. I also need to update my</span>
            <span class="comment">// &quot;most recent&quot; highest trans # to reflect these new numbers.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_num_list.html">OTNumList</a> theOutput;
            pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(theOutput); <span class="comment">// Get the numlist from the successNotice transaction</span>
            <span class="comment">// ----------------------------------</span>
            std::set&lt;int64_t&gt; theNumbers;          <span class="comment">// </span>
            theOutput.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theNumbers);       <span class="comment">// Get the actual set of numbers from the numlist object.</span>
            <span class="comment">// --------------------------------</span>
            <span class="comment">// Iterate through those numbers...</span>
            <span class="comment">//</span>
            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theNumbers)
            {
                <span class="keyword">const</span> int64_t lValue = *it;
                <span class="comment">// ----------------------</span>

                <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac05ddbd6036b5304b7215251d1b7c9b0">VerifyTentativeNum</a>(strServerID, lValue))
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: OTTransaction::successNotice: This wasn&#39;t on my tentative list (%lld), I must have already processed it. &quot;</span>
                    <span class="stringliteral">&quot;(Or there was dropped message when I did, or the server is trying to slip me an old number.\n)&quot;</span>, __FUNCTION__, lValue);
                <span class="keywordflow">else</span>
                    setNoticeNumbers.insert(lValue); <span class="comment">// I only take the numbers that I had been expecting, as tentative numbers, </span>
            }            
            <span class="comment">// -----------------------------------------------</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
            <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

            <span class="comment">// sign the item</span>
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

        } <span class="comment">// else if successNotice</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="comment">// if replyNotice -- notice of a server reply I should have already received when I first sent the request.</span>
            <span class="comment">// (Some server replies are important enough that they have a copy dropped into your Nymbox to make SURE you</span>
            <span class="comment">// receive and process them.) I&#39;ll accept the notice (clear it from my nymbox) and also I&#39;ll process the </span>
            <span class="comment">// original server reply message inside of it, in case due to some network issue, I&#39;ve never seen it before.</span>
            <span class="comment">//</span>
            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
            )
            <span class="comment">// UPDATE: Clearly if I ALREADY processed the server reply, then I don&#39;t need to process it AGAIN, right?</span>
            <span class="comment">// This replyNotice is only here JUST IN CASE. (In case I missed the reply originally.) Well, guess what?</span>
            <span class="comment">// Now I have a list of request numbers stored on the Nym, that tells me definitively whether or not that</span>
            <span class="comment">// Nym has seen the reply. (Clearly if the Nym has processed the reply already, he doesn&#39;t have to do it </span>
            <span class="comment">// AGAIN, now does he? This notice was &quot;just in case.&quot;) </span>
            <span class="comment">//</span>
            <span class="comment">// Therefore I will check to see if the request number for this replyNotice is in my list of &quot;replies I&#39;ve</span>
            <span class="comment">// already seen.&quot; If it is, I can entirely skip this step, which would otherwise end up trying erroneously</span>
            <span class="comment">// to process a server reply even though I had already processed it before.</span>
        {   <span class="comment">// -----------------------------------------------</span>

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bAlreadySeenIt = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a11fd56ffbcef5fcebbd259bdb1bd7c8e">VerifyAcknowledgedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aa90624fb50b1b0edb72c6d4bd7b01a4c">GetRequestNum</a>()); <span class="comment">// Client verifies it has already seen a server reply. </span>

            <span class="keywordflow">if</span> (bAlreadySeenIt) <span class="comment">// if we&#39;ve already seen the reply, then we&#39;re already signalling the server to remove this</span>
                <span class="keywordflow">continue</span>;       <span class="comment">// replyNotice on its side anyway, since the notification is clearly accomplished.</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span>    <span class="comment">// But if we HAVEN&#39;T already seen the server&#39;s reply, then lucky for us he dropped a copy into the Nymbox! Now we can process it!</span>
            {
                <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);
                <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pAcceptItem, <span class="stringliteral">&quot;OTItem * pAcceptItem = OTItem::CreateItemFromTransaction(*pAcceptTransaction, OTItem::acceptNotice); for replyNotice.&quot;</span>);

                <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
                pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

                pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
                <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

                <span class="comment">// Load up the server&#39;s original reply message (from the server&#39;s transaction item, on the receipt from my Nymbox.)</span>
                <span class="comment">// The whole reason that notice was placed in the Nymbox is so we would be guaranteed to receive and process it, in</span>
                <span class="comment">// case the original reply was lost due to network problems. Some messages are too important to just &quot;get lost.&quot;</span>
                <span class="comment">// Therefore, even though we most likely ALREADY processed this server reply, we&#39;re still going to give it a shot</span>
                <span class="comment">// to process right here and now, just as we&#39;re also telling the server to go ahead and clear it out of the Nymbox.</span>
                <span class="comment">// The server&#39;s conscience is clear: he knows for SURE that I DID receive notice.</span>

                <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2e7b5819c105436d507ee05b176026d2">OTItem::replyNotice</a>);

                <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
                    <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                {
                    <a class="code" href="class_o_t_string.html">OTString</a> strOriginalReply;
                    pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strOriginalReply);

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == strOriginalReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading original server reply message from replyNotice. (It appears to be zero length.)\n&quot;</span>,
                            __FUNCTION__);
                    }               
                    <span class="keywordflow">else</span> <span class="comment">// strOriginalReply.Exists() == true.</span>
                    {
                        <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
                        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pMessage != NULL, <span class="stringliteral">&quot;OTClient::AcceptEntireNymbox: OTMessage * pMessage = new OTMessage;&quot;</span>);

                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMessage-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalReply))
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading original server reply message from replyNotice:\n\n%s\n\n&quot;</span>,
                                __FUNCTION__, strOriginalReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            <span class="keyword">delete</span> pMessage;
                            pMessage = NULL;
                        }
                        <span class="keywordflow">else</span> <span class="comment">// Success loading the server&#39;s original reply up into an OTMessage, from a string.</span>
                        {
                            <span class="comment">//</span>
                            <span class="comment">// pMessage needs to be allocated on the heap since ProcessServerReply takes ownership of it.</span>
                            <span class="comment">// theNymbox is passed in as a pointer because it&#39;s an optional parameter, precisely meant for this</span>
                            <span class="comment">// situation, where theNymbox happens to be already loaded and we don&#39;t want it loading it again,</span>
                            <span class="comment">// with one copy ending up overwriting the other.</span>
                            <span class="comment">//</span>
                            <span class="comment">//                          const bool bProcessed =</span>
                            <a class="code" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">ProcessServerReply</a>(*pMessage, &amp;theNymbox); <span class="comment">// ProcessServerReply sometimes has to load the Nymbox. Since we already have it loaded here, we pass it in so it won&#39;t get loaded twice.</span>

                            pMessage = NULL; <span class="comment">// We&#39;re done with it now.</span>

                            <span class="comment">// By this point, I KNOW FOR A FACT that IF there was some network problem that caused a Nym to </span>
                            <span class="comment">// lose an important server message, that by now, the Nym HAS received and processed that server</span>
                            <span class="comment">// reply as appropriate, using the exact same function that would have been called, had the reply</span>
                            <span class="comment">// been properly received in the first place. It&#39;s as if it was never lost. (Vital for syncing.)</span>
                            <span class="comment">// --------------------------------------------------------------------------</span>
                        } <span class="comment">// if success loading original reply message from server.</span>
                    } <span class="comment">// if strOriginalReply.Exists()</span>
                } <span class="comment">// if the replyNotice item is not-NULL and status is &quot;success&quot;</span>
                <span class="keywordflow">else</span> 
                {   <span class="comment">// NULL or &quot;rejected&quot;</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: the replyNotice item was either NULL, or rejected. (Unexpectedly on either count.)\n&quot;</span>,
                        __FUNCTION__);
                }
                <span class="comment">// -------------------------</span>
                <span class="comment">//</span>
                <span class="comment">// sign the item</span>
                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            } <span class="comment">// If we haven&#39;t &quot;already seen it&quot; then we loaded it up (above) and processed the server reply.</span>
            <span class="comment">// -----------------------------------------</span>

            <span class="comment">// Todo: notice that we remove the replyNotice from the Nymbox, whether we are actually able to successfully</span>
            <span class="comment">// load the original message or not. But what if that fails? We have now just discarded the message. In the</span>
            <span class="comment">// future, perhaps have a place where &quot;failed messages go to die&quot; so that vital data isn&#39;t lost in the event</span>
            <span class="comment">// of some unanticipated future bug.</span>

        } <span class="comment">// else if replyNotice</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// It&#39;s a NEW Transaction Number (I need to sign for it.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if blank (new; just added) transaction number.</span>
            )
        {               
            <span class="comment">// My new transaction agreement needs to reflect all these new transaction numbers</span>
            <span class="comment">// that I&#39;m signing for (or at least this one in this block) so I add them to this</span>
            <span class="comment">// temp nym, and then harvest the ones onto it from theNym, and then send those</span>
            <span class="comment">// numbers in the new transaction agreement. (Removing them immediately after, and</span>
            <span class="comment">// then only adding them for real if we get a server acknowledgment.)</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_num_list.html">OTNumList</a> theNumlist, theBlankList;
            pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(theNumlist);
            std::set&lt;int64_t&gt; theNumbers;
            theNumlist.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theNumbers);

            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theNumbers)
            {
                <span class="keyword">const</span> int64_t lTransactionNumber = *it;
                <span class="comment">// -----------------------------------------</span>
                <span class="comment">// Loop FOR EACH TRANSACTION NUMBER in the &quot;blank&quot; (there could be 20 of them...)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lTransactionNumber)) <span class="comment">// Trans number is already issued to this nym (must be an old notice.)</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I &quot;</span>
                    <span class="stringliteral">&quot;ALREADY HAD...(Skipping.)\n&quot;</span>, __FUNCTION__);
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac05ddbd6036b5304b7215251d1b7c9b0">VerifyTentativeNum</a>(strServerID, lTransactionNumber)) <span class="comment">// Trans number is already on the tentative list (meaning it&#39;s already been accepted.)</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I ALREADY &quot;</span>
                    <span class="stringliteral">&quot;ACCEPTED (it&#39;s on my tentative list already; Skipping.)\n&quot;</span>, __FUNCTION__);
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bGotHighestNum &amp;&amp; (lTransactionNumber &lt;= lHighestNum)) <span class="comment">// Man, this is old numbers we&#39;ve already HAD before!</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I&#39;ve HAD BEFORE, &quot;</span>
                    <span class="stringliteral">&quot;or at least, is &lt;= to ones I&#39;ve had before. (Skipping...)\n&quot;</span>, __FUNCTION__);
                <span class="keywordflow">else</span>
                {
                    theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTransactionNumber);
                    <span class="comment">// -------------------------------------</span>
                    theBlankList.Add(lTransactionNumber);
                }
            }<span class="comment">// for-each</span>
            <span class="comment">// -----------------------------------------------</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>);

            pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#af71be628017c874b5bd63fafa277ee0e">AddBlankNumbersToItem</a>(theBlankList);

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
            <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

            <span class="comment">// sign the item</span>
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            <span class="comment">// ------------------------------------------------------------</span>
        } <span class="comment">// else if blank</span>

        <span class="comment">// ------------------------------------------------------------</span>
        <span class="comment">// It&#39;s a Final Receipt (In the Nymbox, this means an opening transaction </span>
        <span class="comment">// number has been removed from my issued list on the server side.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if finalReceipt (just removed) transaction number.</span>
            )
        {               
            <span class="comment">// Todo security: make sure this is only possible for finalReceipts, in case of abuse.</span>
            <span class="comment">// Not only for finalReceipts, but for specific finalReceipt #s that I store a local list of, perhaps</span>
            <span class="comment">// in my Nym, to track until they are closed. No other number should get through here.</span>
            <span class="comment">// Otherwise the server could trick you into removing your issued numbers, simply by dropping </span>
            <span class="comment">// a final receipt for the appropriate number!</span>
            <span class="comment">// The server already keeps a list on its side to protect it from this possibility, but now it</span>
            <span class="comment">// appears that the client-side will have to do a similar thing. Sigh.</span>


            <span class="comment">// Since the &quot;in reference to&quot; (the original &quot;opening&quot; transaction#) is supposedly</span>
            <span class="comment">// already closed, then let&#39;s just MAKE SURE of that, since otherwise it&#39;ll screw up</span>
            <span class="comment">// my future balance agreements. (The instant a finalReceipt appears, the &quot;in ref to&quot; # is already gone..)</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: **** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
                __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: **** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

            <span class="comment">//</span>
            <span class="comment">// pNym won&#39;t actually save unless it actually removes that #. If the #&#39;s already NOT THERE,</span>
            <span class="comment">// then the removal will fail, and thus it won&#39;t bother saving here.</span>

            <span class="comment">// ----------------------------------------------</span>
            <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
            <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
            <span class="comment">// market offers in that list, since we already have a list of active</span>
            <span class="comment">// market offers separately. And market offers produce final receipts,</span>
            <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
            <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
            <span class="comment">// It is for the others.</span>
            <span class="comment">//</span>
            <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
            <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
            <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
            <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
            <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                               pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                               pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
            <span class="comment">// ----------------------------------------------</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>);

            <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);

            pAcceptItem-&gt;SetReferenceToNum(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
            <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>

            pAcceptItem-&gt;SignContract(*pNym);
            pAcceptItem-&gt;SaveContract();
        } <span class="comment">// else if finalReceipt (in Nymbox, this signals that an OPENING number has closed ALREADY. Thus no need to have a &quot;closing process.&quot;)</span>
    }


    <span class="comment">// If the above processing resulted in us actually accepting certain specific items,</span>
    <span class="comment">// then let&#39;s process the message out to the server.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aab7ec90e81dc8f273b8c29617e40bab6">GetItemCount</a>())
    {
        <span class="comment">// IF there were transactions that were approved for me, (and I have notice of them in my nymbox)</span>
        <span class="comment">// then they will be in this set. Also, they&#39;ll only be here IF they were verified as ACTUALLY being</span>
        <span class="comment">// on my tentative list.</span>
        <span class="comment">// Therefore need to REMOVE from Tentative list, and add to actual issued/available lists.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (setNoticeNumbers.size() &gt; 0)
        {
            <span class="comment">//</span>
            <span class="comment">// Note: No need to update highest num here, since that should have already been done when they were</span>
            <span class="comment">// added to my issued list in the first place. (Removed from tentative.)</span>
            <span class="comment">//</span>
            <span class="comment">//          int64_t lViolator = pNym-&gt;UpdateHighestNum(*pNym, strServerID, setNoticeNumbers); // bSave=false (saved below if necessary)</span>
            <span class="comment">//          </span>
            <span class="comment">//          if (lViolator != 0)</span>
            <span class="comment">//              OTLog::vError(&quot;OTClient::AcceptEntireNymbox: ERROR: Tried to update highest trans # for a server, with lower numbers!\n&quot;</span>
            <span class="comment">//                            &quot;This should NEVER HAPPEN, since these numbers are supposedly verified already before even getting this far.\n&quot;</span>
            <span class="comment">//                            &quot;Violating number (too low): %lld, Nym ID: %s \n&quot;, lViolator, strNymID.Get());</span>
            <span class="comment">//          else</span>
            {
                <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, setNoticeNumbers)
                {
                    <span class="keyword">const</span> int64_t lNoticeNum = (*it);

                    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#af39adadda751a07bcd5388cd3528674f">RemoveTentativeNum</a>(strServerID, lNoticeNum)) <span class="comment">// doesn&#39;t save (but saved below)</span>
                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lNoticeNum, <span class="keyword">false</span>); <span class="comment">// bSave = false (but saved below...)</span>
                }

                <span class="comment">// The notice means it already happened in the past. I already accepted the transaction # in my past,</span>
                <span class="comment">// and now there is a notice of that fact sitting in my Nymbox. Until I recognize it, all my transaction</span>
                <span class="comment">// statements will fail. (Like the one a few lines below here...)</span>
                <span class="comment">//</span>
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym); 
            }           
        }
        <span class="comment">//*********************************************************************************</span>

        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTClient::processNymbox</a>, theMessage, 
            *pNym, 
            <span class="comment">//                              *(pAssetContract),</span>
            theServerContract,
            <span class="comment">//                             *(theConnection.GetServerContract()), </span>
            NULL) &gt; 0) 
        {
            <span class="comment">// the message is all set up and ready to go out... it&#39;s even signed.</span>
            <span class="comment">// Except the ledger we&#39;re sending, still needs to be added, and then the</span>
            <span class="comment">// message needs to be re-signed as a result of that.</span>

            theNymbox.<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>(); <span class="comment">// Since this function accepts them ALL, the new balance agreement needs to show it as empty.</span>

            <span class="comment">// -----------------------------------------</span>

            <span class="comment">// By this point, theIssuedNym contains a list of all the transaction numbers that are in my</span>
            <span class="comment">// nymbox, and that WILL be ADDED to me once this processNymbox is processed.</span>
            <span class="comment">// Therefore I need to ADD those items to my issued list (at least temporarily) in order to</span>
            <span class="comment">// calculate the transaction agreement properly. So I used theIssueNym as a temp variable to store those</span>
            <span class="comment">// numbers, so I can add them to my Nym and them remove them again after generating the statement.</span>
            <span class="comment">//</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
            {
                int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
                <span class="comment">// We know it&#39;s not already issued on the Nym, or it wouldn&#39;t have even gotten</span>
                <span class="comment">// set inside theIssuedNym in the first place (further up above.) That&#39;s why</span>
                <span class="comment">// we are confident now that we can add it, generate the transaction statement,</span>
                <span class="comment">// and then remove it again.</span>
                <span class="comment">//</span>
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
            }

            <span class="comment">//*********************************************************************************</span>
            <span class="comment">// TRANSACTION STATEMENT</span>
            <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pAcceptTransaction);

            <span class="comment">//*********************************************************************************</span>

            <span class="comment">// Here I am removing the new numbers again, now that the statement has been generated.</span>
            <span class="comment">// If the message is successful, then I will need to add them for real.</span>
            <span class="comment">//</span>
            <span class="keywordtype">bool</span> bAddedTentative=<span class="keyword">false</span>;
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
            {
                int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a154a958a9f3cfdb07167858579f74037">AddTentativeNum</a>(strServerID, lTemp); <span class="comment">// So when I see the success notice later, I&#39;ll know the server isn&#39;t lying. (Store a copy here until then.)</span>
                bAddedTentative = <span class="keyword">true</span>;
            }

            <span class="keywordflow">if</span> (bAddedTentative)
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
            <span class="comment">// -----------------------------------------</span>

            <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// This can&#39;t be NULL BTW, since there is an OT_ASSERT in Generate call. But I hate to use a pointer without checking it.</span>
                pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: This should never happen.\n&quot;</span>, __FUNCTION__);

            <span class="comment">// ------------------------------------------------------------</span>

            <span class="comment">// Sign the accept transaction, as well as the message ledger </span>
            <span class="comment">// that we&#39;ve just constructed containing it.</span>
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            processLedger.SignContract(*pNym);
            processLedger.SaveContract();

            <span class="comment">// Extract the ledger into string form and add it as the payload on the message.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strLedger(processLedger);
            theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);

            <span class="comment">// Release any other signatures from the message, since I know it</span>
            <span class="comment">// was signed already in the above call to ProcessUserCommand.</span>
            theMessage.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();

            <span class="keywordflow">return</span> <span class="keyword">true</span>;

            <span class="comment">// Sign it and send it out.</span>
            <span class="comment">//          theConnection.SignAndSend(theMessage);</span>
            <span class="comment">// I could have called SignContract() and then theConnection.ProcessMessageOut(message) </span>
            <span class="comment">// but I used the above function instead.</span>

        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error processing processNymbox command.\n&quot;</span>, __FUNCTION__);
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa8dd2177f0b88bc2ac38b6abac24d4e3"></a><!-- doxytag: member="OTClient::CalcReturnVal" ref="aa8dd2177f0b88bc2ac38b6abac24d4e3" args="(const int64_t &amp;lRequestNumber)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t <a class="el" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">OTClient::CalcReturnVal</a> </td>
          <td>(</td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lRequestNumber</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00159">159</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_client.html#a056ffd57844757386743f7aac5cf1a32">m_lMostRecentRequestNumber</a> = lRequestNumber;
    <span class="comment">// --------------------------------------------</span>
    <span class="keywordflow">if</span> ((-1) == lRequestNumber)
        <span class="keywordflow">return</span> (-1);
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == lRequestNumber)
        <span class="keywordflow">return</span> 0;

    <span class="keyword">const</span> int32_t nRequestNum = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(lRequestNumber);

    <span class="keywordflow">if</span> (lRequestNumber == nRequestNum) <span class="comment">// In this case, it works!</span>
        <span class="keywordflow">return</span> nRequestNum;

    <span class="keywordflow">return</span> (-2); <span class="comment">// some other call can return this-&gt;m_lMostRecentRequestNumber if needed.</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a77bd8f98f5d1a62e37e233b9542337a7"></a><!-- doxytag: member="OTClient::ConnectToTheFirstServerOnList" ref="a77bd8f98f5d1a62e37e233b9542337a7" args="(OTPseudonym &amp;theNym, OTString &amp;strCA_FILE, OTString &amp;strKEY_FILE, OTString &amp;strKEY_PASSWORD)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a77bd8f98f5d1a62e37e233b9542337a7">OTClient::ConnectToTheFirstServerOnList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strCA_FILE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strKEY_FILE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strKEY_PASSWORD</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>used for testing. Once the wallet is loaded, we are assuming there is at least one server contract in the wallet, and we are asking the wallet to look it up, find the hostname and port inside that contract, and establish a connection to the server.</p>
<p>Whereas in a nice user interface, you would loop through all the servers in the wallet and display them in a nice list on the screen, and the user could just click on one, and you would just call Wallet.Connect(ServerID) and do your thing. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l10643">10643</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    SERVER_ID;
    <a class="code" href="class_o_t_string.html">OTString</a>        SERVER_NAME;

    <span class="keywordflow">if</span> (m_pWallet &amp;&amp; m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aad6abb5e5fd19ffd69a9b6f0eb75f1c7">GetServer</a>(0, SERVER_ID, SERVER_NAME))
    {
        <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(SERVER_ID);

        <span class="keywordflow">if</span> (NULL != pServer)
        {
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);
            <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#a3ffc7dae5e742e234cea0d63a6624b67">Connect</a>(theNym, *pServer, strCA_FILE, strKEY_FILE, strKEY_PASSWORD);
        }
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a36e39a99ff4495af7c8766da81d7b29b"></a><!-- doxytag: member="OTClient::GetMessageBuffer" ref="a36e39a99ff4495af7c8766da81d7b29b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_message_buffer.html">OTMessageBuffer</a>&amp; <a class="el" href="class_o_t_client.html#a36e39a99ff4495af7c8766da81d7b29b">OTClient::GetMessageBuffer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00294">294</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_MessageBuffer; }
</pre></div>
</div>
</div>
<a class="anchor" id="a86b6fe9628f0b065e7f35dd68c02b3e6"></a><!-- doxytag: member="OTClient::GetMessageOutbuffer" ref="a86b6fe9628f0b065e7f35dd68c02b3e6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_message_outbuffer.html">OTMessageOutbuffer</a>&amp; <a class="el" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">OTClient::GetMessageOutbuffer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00295">295</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_MessageOutbuffer; }
</pre></div>
</div>
</div>
<a class="anchor" id="af93ba422f820281eb6022798563d588d"></a><!-- doxytag: member="OTClient::InitClient" ref="af93ba422f820281eb6022798563d588d" args="(OTWallet &amp;theWallet)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#af93ba422f820281eb6022798563d588d">OTClient::InitClient</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_wallet.html">OTWallet</a> &amp;&#160;</td>
          <td class="paramname"><em>theWallet</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Need to call this before using. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l10680">10680</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// only run once.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a>)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTClient::InitClient: Already initialized. (Returning true.)\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <a class="code" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a>  = <span class="keyword">true</span>;
    <span class="comment">// -----------------------</span>


    <span class="comment">// UPDATE: SSL is now initialized in OTLog::OT_Init(), not in OTServerConnection.</span>
    <span class="comment">//</span>
    <span class="comment">// Old:</span>
    <span class="comment">// SSL gets initialized in the OTServerConnection, so no need to do it here twice.</span>
    <span class="comment">// BUT warning: don&#39;t load any private keys until this happens, or that won&#39;t work.</span>
    <span class="comment">//  SSL_library_init();</span>
    <span class="comment">//  SSL_load_error_strings();   // UPDATE: Moved to OTLog::OT_Init();</span>



    <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>   = <span class="keyword">new</span> <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a>(theWallet, *<span class="keyword">this</span>);
    m_pWallet       = &amp;theWallet;



    <span class="comment">// openssl initialization</span>
    <span class="comment">// UPDATE: Moved to OTLog::OT_Init()</span>
    <span class="comment">//</span>
    <span class="comment">//  ERR_load_crypto_strings();  // Todo deal with error logging mechanism later.</span>
    <span class="comment">//  OpenSSL_add_all_algorithms();  </span>

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4e77549b8bf6f582f8c30a361b42b1c7"></a><!-- doxytag: member="OTClient::IsRunningAsScript" ref="a4e77549b8bf6f582f8c30a361b42b1c7" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a4e77549b8bf6f582f8c30a361b42b1c7">OTClient::IsRunningAsScript</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00189">189</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_bRunningAsScript; }
</pre></div>
</div>
</div>
<a class="anchor" id="a50baddc0e9243a64e8ba5b8e76acbdb2"></a><!-- doxytag: member="OTClient::ProcessDepositResponse" ref="a50baddc0e9243a64e8ba5b8e76acbdb2" args="(OTTransaction &amp;theTransaction, OTServerConnection &amp;theConnection, OTMessage &amp;theReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">OTClient::ProcessDepositResponse</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>theTransaction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;&#160;</td>
          <td class="paramname"><em>theConnection</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l02407">2407</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
    theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
    <span class="comment">//  OTWallet * pWallet = theConnection.GetWallet();</span>

    <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to deposit.</span>

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
    {
        <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pReplyItem);

        <span class="comment">// if pointer not null, and it&#39;s a deposit, and it&#39;s an acknowledgement (not a rejection or error)</span>

        <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()))
        {            
            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION SUCCESS -- Server acknowledges deposit.\n&quot;</span>);

                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                {
                    <span class="comment">// Inside OT, when processing a successful server reply to a depositCheque request,</span>
                    <span class="comment">// and if that cheque is found inside the Payments Inbox, ==&gt; move it to the record box.</span>
                    <span class="comment">//</span>
                    <span class="comment">// -----------------------------------------------------</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theLedgerAngel(pLedger);
                    <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
                    <span class="comment">// ------------------------------------------------------</span>
                    <span class="keywordflow">if</span> ((NULL != pLedger) &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a2089e14094b2047e668bc50e2d5d3eb2">LoadPaymentInbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
                    {
                        <span class="comment">// If an incoming payment exists that matches the instrument inside the server&#39;s deposit response,</span>
                        <span class="comment">// then remove it from the payments inbox and save. Save a copy to the records box.</span>
                        <span class="comment">//</span>
                        <span class="comment">// --------------------------------------------------</span>
                        <span class="comment">// Response item contains a copy of the original item, as reference string.</span>
                        <span class="comment">//</span>
                        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalDepositItem;
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL;
                        pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalDepositItem);

                        <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalDepositItem);
                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType);

                        <span class="keywordflow">if</span> (NULL != pTransType)
                        {
                            pOriginalItem = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_item.html">OTItem</a> *<span class="keyword">&gt;</span>(pTransType);
                        }
                        <span class="comment">// ------------------------------------------------</span>
                        <span class="keywordflow">if</span> (NULL != pOriginalItem)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);

                            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque;
                            <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque);

                            <span class="keywordflow">if</span> (!bLoadContractFromString)
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading cheque from string:\n%s\n&quot;</span>,
                                    __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            }
                            <span class="keywordflow">else</span> <span class="comment">// Okay, we&#39;ve got the cheque!</span>
                            {
                                <span class="comment">// Let&#39;s loop through the payment inbox and see if there&#39;s a matching cheque.</span>
                                <span class="comment">//</span>
                                <span class="keyword">const</span> int64_t lChequeTransNum = theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>();
                                <span class="keyword">const</span> int32_t  nTransCount = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>();

                                <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// going backwards since we are deleting something. (Probably only one thing, but still...)</span>
                                {
                                    <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym, ii);
                                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);

                                    int64_t lPaymentTransNum = 0;

                                    <span class="keywordflow">if</span> ((NULL != pPayment) &amp;&amp; pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>() &amp;&amp;
                                        pPayment-&gt;<a class="code" href="class_o_t_payment.html#a02ffc34caf84cf6e9f88910b6354fbd8">GetTransactionNum</a>(lPaymentTransNum) &amp;&amp; (lPaymentTransNum == lChequeTransNum))                                    
                                    {
                                        <span class="comment">// -----------------------------------------------</span>
                                        <span class="comment">// It&#39;s the same cheque.</span>
                                        <span class="comment">// Remove it from the payments inbox, and save.</span>
                                        <span class="comment">//</span>
                                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(ii);
                                        <a class="code" href="class_o_t_string.html">OTString</a> strPmntInboxTransaction;
                                        int64_t lRemoveTransaction = 0;

                                        <span class="keywordflow">if</span> (NULL != pTransaction)
                                        {
                                            pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPmntInboxTransaction);
                                            <span class="comment">// -----------------------------------------------------</span>
                                            lRemoveTransaction = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

                                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pLedger-&gt;<a class="code" href="class_o_t_ledger.html#aea09d3dd8bf2fc5630ce87184fc937c1">DeleteBoxReceipt</a>(lRemoveTransaction))
                                            {
                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a cheque being removed &quot;</span>
                                                    <span class="stringliteral">&quot;from a payments inbox: %lld\n&quot;</span>, __FUNCTION__, lRemoveTransaction);
                                            }
                                            <span class="comment">// -----------------------------------------------------</span>
                                            <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lRemoveTransaction))
                                            {
                                                pLedger-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                                pLedger-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                                pLedger-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                                <span class="keywordflow">if</span> (!pLedger-&gt;<a class="code" href="class_o_t_ledger.html#ab6f6af26a690d49f61ec7ffcc557a302">SavePaymentInbox</a>())
                                                {
                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
                                                }
                                                <span class="keywordflow">else</span>
                                                {
                                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed cheque from payments inbox. (Deposited successfully.)\n&quot;</span>
                                                        <span class="stringliteral">&quot;Saved payments inbox.\n&quot;</span>, __FUNCTION__);
                                                }
                                            }
                                        } <span class="comment">// if (NULL != pTransaction)</span>
                                        <span class="comment">// -----------------------------------------------</span>
                                        <span class="comment">// We&#39;re still in the loop backwards through the paymentInbox, checking each for</span>
                                        <span class="comment">// a payment instrument. Specifically, theCheque&#39;s cheque. That&#39;s because this is</span>
                                        <span class="comment">// processChequeResponse. If there was a cheque in my payments inbox, and I just</span>
                                        <span class="comment">// successfully deposited the cheque, then I want to remove it from my payments</span>
                                        <span class="comment">// inbox. We already just did that -- so now we want to drop a copy of it into</span>
                                        <span class="comment">// the record box.</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// Save a copy to the record box.</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (strPmntInboxTransaction.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                        {
                                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID     (USER_ID);
                                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
                                            <span class="comment">// -----------------------------------------------------</span>
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                                            <span class="comment">// -----------------------------------------------------</span>
                                            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
                                            <span class="comment">// ------------------------------------------------------</span>
                                            <span class="keywordtype">bool</span> bSuccessLoading = (bExists &amp;&amp; theRecordBox.LoadRecordBox());
                                            <span class="comment">// -----------------------------------------------------</span>
                                            <span class="keywordflow">if</span> (bExists &amp;&amp; bSuccessLoading)
                                                bSuccessLoading = (theRecordBox.VerifyContractID() &amp;&amp;
                                                theRecordBox.VerifySignature(*pNym));
                                            <span class="comment">//                                              bSuccessLoading = (theRecordBox.VerifyAccount(*pNym)); // (No need here to load all the Box Receipts by using VerifyAccount)</span>
                                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists)
                                                bSuccessLoading = theRecordBox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                            <span class="comment">// -----------------------------------------------------</span>
                                            <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
                                            <span class="comment">//</span>
                                            <span class="keywordflow">if</span> (!bSuccessLoading)
                                            {
                                                <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
                                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: WARNING: Unable to load, verify, or &quot;</span>
                                                    <span class="stringliteral">&quot;generate recordBox, with IDs: %s / %s\n&quot;</span>,
                                                    __FUNCTION__, strUserID.Get(), strAcctID.Get());
                                            }
                                            <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the recordBox and verifying its contractID and signature, (OR success generating the ledger.)</span>
                                            {
                                                <span class="comment">// Currently in @getBoxReceipt, we are taking an incoming cheque from the nymbox</span>
                                                <span class="comment">// and adding it to the payments inbox. From there the user might choose to deposit it.</span>
                                                <span class="comment">// When he does that, he&#39;ll receive a server reply, which is what we&#39;re processing here</span>
                                                <span class="comment">// in this function. So now that we&#39;ve got that reply, we want to move the cheque notice</span>
                                                <span class="comment">// from the payments inbox, and into the record box at this point HERE, when we&#39;ve just</span>
                                                <span class="comment">// above removed it from the payments inbox (on successful deposit.)</span>
                                                <span class="comment">//</span>
                                                <a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">load_str_trans_add_to_ledger</a>(USER_ID, strPmntInboxTransaction, <span class="stringliteral">&quot;recordBox&quot;</span>, lRemoveTransaction, *pNym, theRecordBox);
                                            }
                                        }
                                    } <span class="comment">// pPayment</span>
                                }
                                <span class="comment">// for (payments inbox) ----------------------------------</span>
                            }
                        } <span class="comment">// if NULL != pOriginalItem</span>
                        <span class="comment">// ------------------------------------------------</span>
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify payments inbox: User %s / Acct %s\n&quot;</span>,
                            __FUNCTION__, strUserID.Get(), strAcctID.Get());
                    }
                }
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: TRANSACTION FAILURE -- Server rejects deposit.\n&quot;</span>, __FUNCTION__);
            }
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a198acbb6ccb266904ade30a94f9ed066"></a><!-- doxytag: member="OTClient::ProcessInBuffer" ref="a198acbb6ccb266904ade30a94f9ed066" args="(OTMessage &amp;theServerReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a198acbb6ccb266904ade30a94f9ed066">OTClient::ProcessInBuffer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerReply</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00242">242</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>, <span class="stringliteral">&quot;OTClient::ProcessInBuffer: ASSERT: NULL != m_pConnection\n&quot;</span>);

    <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#aec033a0cae7e314846b73dbcedca6709">ProcessInBuffer</a>(theServerReply);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac5e35c630a2d920dd510c23815c70ab5"></a><!-- doxytag: member="OTClient::ProcessIncomingTransactions" ref="ac5e35c630a2d920dd510c23815c70ab5" args="(OTServerConnection &amp;theConnection, OTMessage &amp;theReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">OTClient::ProcessIncomingTransactions</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;&#160;</td>
          <td class="paramname"><em>theConnection</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>We have received the server reply (ProcessServerReply) which has vetted it and determined that it is legitimate and safe, and that it is a reply to a transaction request.</p>
<p>At that point, this function is called to open the reply, go through the transaction responses, and potentially grab any bearer certificates that are inside and save them in a purse somewhere. (And do any other necessary processing on that reply.)</p>
<p>Also: Need to call this function after Nymbox notices of old server replies (to prevent sync issues). But what if already processed? Call pNym-VerifyIssuedNum(strServerID, pTrans-&gt;GetTransactionNum() and if you discover that it's already been removed, then discard it (or save it in your auto-receipt storage. But if you discover that the number is STILL issued to you, the simply call the below function, the same as you would have normally if you had received the server reply in the first place! That way transaction sync issues become impossible. SOLUTION: bool OTClient::ProcessServerReply(OTMessage &amp; theReply) Any message deemed important enough to have a notice containing the reply dropped into my nymbox, I will just take that message and pass it to <a class="el" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">ProcessServerReply()</a>, which will then call THIS function (ProcessIncomingTransactions) where appropriate, and THIS function should therefore then be smart enough to ignore transactions that aren't VERIFIED as issued numbers on this Nym still! (An easy enough test for determining whether it's already been processed...) If it's not on the issued list, then skip it! I must have processed it already. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l01596">1596</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
    theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
    <span class="comment">// --------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
    <span class="comment">// --------------------------------------</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
    <span class="comment">// --------------------------------------</span>
    <a class="code" href="class_o_t_string.html">OTString</a>    strServerID(SERVER_ID), 
        strReceiptID(<span class="stringliteral">&quot;ID_NOT_SET_YET&quot;</span>); <span class="comment">// This will be user ID or acct ID depending on whether trans statement or balance statement.</span>
    <span class="comment">// --------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>()); <span class="comment">// todo fix cast.</span>
    <span class="comment">// --------------------------------------</span>
    <span class="comment">// The only incoming transactions that we actually care about are responses to cash</span>
    <span class="comment">// WITHDRAWALS.  (Cause we want to get that money off of the response, not lose it.)</span>
    <span class="comment">// So let&#39;s just check to see if it&#39;s a withdrawal...</span>
    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID); 
    <a class="code" href="class_o_t_string.html">OTString</a> strLedger(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

    <span class="comment">// The ledger we received from the server was generated there, so we don&#39;t</span>
    <span class="comment">// have to call GenerateLedger. We just load it.</span>
    <span class="keywordtype">bool</span> bSuccess = theLedger.LoadLedgerFromString(strLedger); <span class="comment">// This is a MESSAGE ledger. </span>

    <span class="keywordflow">if</span> (bSuccess)
        bSuccess = theLedger.VerifyAccount((<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)*pServerNym);

    <span class="keywordflow">if</span> (!bSuccess)
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading ledger from message payload in OTClient::ProcessIncomingTransactions.\n&quot;</span>);
        <span class="keywordflow">return</span>;
    }

    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Loaded ledger out of message payload.\n&quot;</span>);

    <span class="comment">// Loop through ledger transactions,        </span>

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theLedger.GetTransactionMap())
    {   
        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTransaction, <span class="stringliteral">&quot;NULL transaction pointer in OTServer::UserCmdNotarizeTransactions\n&quot;</span>);

        <span class="comment">// ---------------------------------------------------------------</span>
        <span class="comment">// See note above function. In this loop, it&#39;s possible that we&#39;ve already processed these </span>
        <span class="comment">// transactions. Therefore we ignore the ones that are already released from our issued list.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> ( <span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()) )
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTClient::ProcessIncomingTransactions: Skipping processing of server reply to transaction number %lld &quot;</span>
                <span class="stringliteral">&quot;since the number isn&#39;t even issued to me. Usually this means that I ALREADY processed it, and we are now &quot;</span>
                <span class="stringliteral">&quot;processing the nymbox notice for the same transaction.\n&quot;</span>, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
            <span class="keywordflow">continue</span>;   <span class="comment">// If this trans# isn&#39;t even signed out to me anymore, then skip it. It&#39;s already closed.</span>
        }
        <span class="comment">// ---------------------------------------------------------------</span>

        <span class="comment">// Each transaction in the ledger is a server reply to our original transaction request.</span>
        <span class="comment">// </span>
        <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">VerifyAccount</a>(*pServerNym)) <span class="comment">// if not null &amp;&amp; valid transaction reply from server</span>
        {           
            <span class="comment">// We had to burn a transaction number to run the transaction that the server has now replied to,</span>
            <span class="comment">// so let&#39;s remove that number from our list of responsibility. Whether it was successful or not,</span>
            <span class="comment">// the server has removed it from our list of responsibility, so we need to remove it on our side as well.</span>
            <span class="comment">// so that we can properly calculate our balance agreements in the future.</span>
            <span class="comment">//</span>
            <span class="comment">// NOTE: not for all types! See the switch statements:</span>

            <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

            <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
            {
                <span class="comment">// ----------------------------------------</span>
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>:
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCash    = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>);
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItemVoucher = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>);

                    <span class="keywordflow">if</span> (NULL != pItemCash)
                        theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>;
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pItemVoucher)
                        theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>;
                }
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac310111eca8eb295fb5dafddd884fc82">OTItem::atTransfer</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a229f0c7ace7a51840d7632910a0b92a6">OTItem::atMarketOffer</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afbc3c7556a790e7a7b6be464f8ea058b">OTItem::atPaymentPlan</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1fe91e4cadee24de6acb9de56a55e4eb">OTItem::atSmartContract</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ab3ded9d37de3a75d4b39735bb9aff341">OTItem::atCancelCronItem</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>:
                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0b62f8efea6ed9bdefbc48ce2e97a8b6">OTItem::atExchangeBasket</a>;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">default</span>:
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>: <span class="comment">// not handled here...</span>
                <span class="keywordflow">continue</span>;
            }

            <span class="comment">// ----------------------------------------</span>

            <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
            {
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>:
                <a class="code" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">ProcessDepositResponse</a>(*pTransaction, theConnection, theReply);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>:
                <a class="code" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">ProcessPayDividendResponse</a>(*pTransaction, theConnection, theReply);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>:
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
                <span class="comment">// If the exchangeBasket FAILS, then I put all the transaction numbers BACK on the Nym,</span>
                <span class="comment">// that had been taken for the exchange (for all the basketReceipts.)</span>
                <span class="comment">// ---------------------------------------</span>
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);

                    <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
                        <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION</span>
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                        pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                        <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType = 
                            strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;

                        <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);

                        <span class="keywordflow">if</span> (NULL != pOriginalItem)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strBasket;
                            <a class="code" href="class_o_t_basket.html">OTBasket</a> theRequestBasket;

                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strBasket);

                            <span class="keywordflow">if</span> (strBasket.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theRequestBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strBasket))
                                theRequestBasket.<a class="code" href="class_o_t_basket.html#a4fa7db8a28ae3adb021cd343b69fe2ff">HarvestClosingNumbers</a>(*pNym, SERVER_ID, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                            <span class="keywordflow">else</span>
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atExchangeBasket) Error loading original basket request in OTClient::ProcessIncomingTransactions\n&quot;</span>);
                        } <span class="comment">// if success loading original item.</span>
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atExchangeBasket) Error loading original item from string in OTClient::ProcessIncomingTransactions\n&quot;</span>);
                        }                        
                    } <span class="comment">// if exchangeBasket was a failure</span>
                }
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>:
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
                <span class="comment">// Just above, we remove the issued number that was used to initiate the cancelCronItem. (Regardless of success.)</span>
                <span class="comment">// Below, we remove the issued number that was ON that Cron Item (IF SUCCESS.)</span>
                <span class="comment">// ---------------------------------------</span>
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);

                    <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
                        <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                    {   <span class="comment">// If it was a success cancelling the cron item, then the final receipt has been created, and</span>
                        <span class="comment">// the transaction number is closed out, and only the closing number is left. If that is the case</span>
                        <span class="comment">// then I can remove the transaction number from my issued list, presumably the server already has.</span>
                        <span class="comment">// </span>
                        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                        pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                        <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType = 
                            strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;

                        <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);

                        <span class="keywordflow">if</span> (NULL != pOriginalItem)
                        {
                            <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                            {
                                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atCancelCronItem) Error removing issued number from user nym in OTClient::ProcessIncomingTransactions\n&quot;</span>);
                            }
                            <span class="comment">// I don&#39;t have to call RemoveTransactionNum for the closing number (though the server does.) Why not?</span>
                            <span class="comment">// Because I already called GetNextTransactionNum() to use it in the first place, so it&#39;s already off my</span>
                            <span class="comment">// list of usable transaction numbers here on the client side.</span>
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: (atCancelCronItem) Error loading original item from string.\n&quot;</span>,
                                __FUNCTION__);
                        }                        
                    }
                }
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>:
                <a class="code" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">ProcessWithdrawalResponse</a>(*pTransaction, theConnection, theReply);
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>:
                <span class="comment">// Nothing removed here since the transaction number is still in play, in this cases.</span>
                <span class="comment">// ACTUALLY, if this is a failure, we need to REMOVE from issued list. (It&#39;s burned.)</span>
                <span class="comment">// But if success, the number stays in play until a later time. (So we leave it issued.)</span>
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);

                    <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
                        <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                    {
                        <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
                        <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
                        <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a transfer.)\n&quot;</span>,
                                __FUNCTION__);
                        }
                    }
                }
                <span class="keywordflow">break</span>;

                <span class="comment">// ********************************************************************</span>

            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>:
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>:
            <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>:

                <span class="comment">// Nothing removed here since the transaction number is still in play, in these cases.</span>
                <span class="comment">// ACTUALLY, if these are a failure, we need to REMOVE from issued list.</span>
                <span class="comment">// But if success, the number stays in play until a later time.</span>
                {
                    <span class="comment">// ----------------------------------------------------</span>
                    <span class="keyword">const</span> int64_t    lNymOpeningNumber = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
                    <a class="code" href="class_o_t_item.html">OTItem</a>      * pReplyItem        = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);
                    <span class="comment">// ----------------------------------------------------</span>
                    <span class="keywordflow">if</span> (NULL != pReplyItem) 
                    {
                        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                        pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                        <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType =
                            strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;

                        <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);

                        <span class="keywordflow">if</span> (NULL != pOriginalItem)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strCronItem;
                            pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCronItem);

                            <span class="comment">// What kind of cron item is it?</span>
                            <span class="comment">// Well (todo) we should probably double-check, but the only cron items we</span>
                            <span class="comment">// send notices for are payment plans and smart contracts. Market offers don&#39;t</span>
                            <span class="comment">// need notices, since anyone activating a market offer is already getting the</span>
                            <span class="comment">// reply. (AND getting a copy of that reply, already, inside a replyNotice in</span>
                            <span class="comment">// his Nymbox...) So he can&#39;t possibly miss the server&#39;s reply, and there aren&#39;t</span>
                            <span class="comment">// any other parties to notify (re: successful activation), besides the Nym himself.</span>
                            <span class="comment">//</span>
                            <span class="comment">// Only payment plans and smart contracts could potentially have some other signer, who</span>
                            <span class="comment">// would want to get notified, and to whom the notice is send.</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = (strCronItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strCronItem) : NULL);
                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel(pCronItem);

                            <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// the original smart contract or payment plan object.</span>
                            {
                                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION (This is where we remove the opening number, and harvest the closing numbers.)</span>
                                {
                                    <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
                                    <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
                                    <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
                                    <span class="comment">//</span>
                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID,
                                        lNymOpeningNumber,
                                        <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                                    {
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a cron item.)\n&quot;</span>,
                                            __FUNCTION__);
                                    }
                                    <span class="comment">// ---------------------------------------</span>
                                    <span class="comment">// If the activation was a failure, we can add all the extra transaction numbers BACK to the</span>
                                    <span class="comment">// Nym, that were being used as CLOSING numbers, and use them later. (They aren&#39;t burned.)</span>
                                    <span class="comment">// They&#39;re still all signed-out, so we should harvest them so we can still use them on something.</span>
                                    <span class="comment">// (Whereas if it had been a success, then we would have left them in their existing state, since</span>
                                    <span class="comment">// the transaction would then be in play, and the numbers could not be used again, nor removed as</span>
                                    <span class="comment">// issued numbers until the transaction itself had finished and its receipts had been signed-off.)</span>
                                    <span class="comment">//</span>
                                    pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// saves.</span>
                                }
                                <span class="comment">// ------------------------------------------------------</span>
                                <span class="comment">// When party receives notice that smart contract has been activated,</span>
                                <span class="comment">// remove the instrument from outpayments box. (If it&#39;s there -- it can be.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// (This happens for acknowledged AND rejected smart contracts.)</span>
                                <span class="comment">//</span>

                                <a class="code" href="class_o_t_string.html">OTString</a> strInstrument; <span class="comment">// If the instrument is in the outpayments box, we put a copy of it here.</span>

                                <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || <span class="comment">// No need to do this for market offers. (Because they don&#39;t</span>
                                    (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))   <span class="comment">// go into the outpayments box in the first place.)</span>
                                {
                                    <span class="comment">// --------------------------------------------</span>
                                    <span class="comment">// If success, save a copy in my &quot;active cron items&quot; folder.</span>
                                    <span class="comment">//</span>
                                    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                                    {
                                        pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a215530a92d43d8260dfe8f42327cb3de">SaveActiveCronReceipt</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
                                    }
                                    <span class="comment">// --------------------------------------------</span>
                                    <a class="code" href="class_o_t_num_list.html">OTNumList</a>   numlistOutpayment(lNymOpeningNumber);
                                    <span class="keyword">const</span> int32_t   nOutpaymentIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(lNymOpeningNumber);
                                    <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg             = NULL;
                                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMessageAngel;

                                    <span class="keywordflow">if</span> (nOutpaymentIndex &gt;= 0)
                                    {
                                        pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acb808e89943f1f2d0009825a3fbcb34f">GetOutpaymentsByIndex</a>(nOutpaymentIndex);

                                        <span class="keywordflow">if</span> (NULL == pMsg)
                                        {
                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment message in outpayment box based on index %d.\n&quot;</span>,
                                                __FUNCTION__, nOutpaymentIndex);
                                        }
                                        <span class="keywordflow">else</span>
                                        {
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemovedOutpayment = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(nOutpaymentIndex, <span class="keyword">false</span>); <span class="comment">//bDeleteIt=false (deleted later on.)</span>
                                            theMessageAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pMsg); <span class="comment">// Since we chose to keep pMsg alive and undeleted, after removing it from the outpayments box, we set the angel here to make sure it gets cleaned up later, whenever we return out of this godforsaken function.</span>
                                            <span class="comment">// --------------------------------------------------</span>
                                            <span class="keywordflow">if</span> (bRemovedOutpayment)
                                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
                                            <span class="keywordflow">else</span>
                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove outpayment at index: %d\n&quot;</span>, __FUNCTION__, nOutpaymentIndex);
                                            <span class="comment">// --------------------------------------------------</span>
                                            <span class="keywordflow">if</span> (!pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strInstrument))
                                            {
                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment instrument in outpayment message at index %d.\n&quot;</span>,
                                                    __FUNCTION__, nOutpaymentIndex);
                                            }
                                            <span class="comment">// --------------------------------------------------</span>
                                            <span class="keywordflow">else</span>
                                            {                                                
                                                <span class="comment">// At this point, we&#39;ve removed the outpayment already, and it will be deleted</span>
                                                <span class="comment">// when it goes out of scope already. And we&#39;ve got a copy of the original financial</span>
                                                <span class="comment">// instrument that was SENT in that outpayment.</span>
                                                <span class="comment">//</span>
                                                <span class="comment">// But what for? Why did I want that instrument here in a string, in strInstrument?</span>
                                                <span class="comment">// Do I still need to do something with it? Yes: I need to drop a copy of it into</span>
                                                <span class="comment">// the record box!</span>

                                                <span class="comment">// NOTE: strInstrument is added to the RecordBox below. So there&#39;s no need to</span>
                                                <span class="comment">// do that here, ATM.</span>
                                            }
                                        }
                                    } <span class="comment">// if (nOutpaymentIndex &gt;= 0)</span>
                                    <span class="comment">// ------------------------------------------------------</span>
                                    <span class="comment">// When party receives notice that smart contract has failed activation attempt, then remove</span>
                                    <span class="comment">// the instrument from payments inbox AND outpayments box. (If there -- could be for either.)</span>
                                    <span class="comment">// (Outbox is done just above, so now let&#39;s do inbox...)</span>
                                    <span class="comment">//</span>

                                    <span class="comment">// Why only rejected items? Why not remove it from the payments inbox on success as well?</span>
                                    <span class="comment">// Normally wouldn&#39;t we expect that a successful activation of an inbox item, should remove</span>
                                    <span class="comment">// that inbox item? Especially if there&#39;s already a copy in the outbox as well...</span>
                                    <span class="comment">//</span>
<span class="comment">//                                  if (OTItem::rejection == pReplyItem-&gt;GetStatus()) // REJECTION</span>
                                    {
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists1   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists2   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>()   .Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
                                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
                                        <span class="comment">// ------------------------------------------------------</span>
                                        <span class="keywordtype">bool</span> bSuccessLoading1 = (bExists1 &amp;&amp; thePmntInbox.LoadPaymentInbox());
                                        <span class="keywordtype">bool</span> bSuccessLoading2 = (bExists2 &amp;&amp; theRecordBox.LoadRecordBox());
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="keywordflow">if</span> (bExists1 &amp;&amp; bSuccessLoading1)
                                            bSuccessLoading1  = (thePmntInbox.VerifyContractID() &amp;&amp;
                                            thePmntInbox.VerifySignature(*pNym));
<span class="comment">//                                      bSuccessLoading1      = (thePmntInbox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
                                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists1)
                                            bSuccessLoading1  = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="keywordflow">if</span> (bExists2 &amp;&amp; bSuccessLoading2)
                                            bSuccessLoading2  = (theRecordBox.VerifyContractID() &amp;&amp;
                                            theRecordBox.VerifySignature(*pNym));
<span class="comment">//                                      bSuccessLoading2      = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
                                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists2)
                                            bSuccessLoading2  = theRecordBox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="comment">// by this point, the boxes DEFINITELY exist -- or not. (generation might have failed, or verification.)</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (!bSuccessLoading1 || !bSuccessLoading2)
                                        {
                                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server reply containing rejection of cron item: &quot;</span>
                                                <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate paymentInbox or recordBox, with IDs: %s / %s\n&quot;</span>,
                                                __FUNCTION__, strNymID.Get(), strNymID.Get());
                                        }
                                        <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying</span>
                                        {   <span class="comment">// their contractID and signature, (OR success generating the ledger.)</span>
                                            <span class="comment">// -------------------------------------------------------------------------------</span>
                                            <span class="comment">// See if there&#39;s a receipt in the payments inbox.</span>
                                            <span class="comment">// If so, remove it.</span>
                                            <span class="comment">//                                            </span>
                                            <span class="comment">// ------------------------------------------------------</span>
                                            <span class="comment">// What&#39;s going on here?</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// Well let&#39;s say Alice sends Bob a payment plan. (This applies to smart contracts, too.)</span>
                                            <span class="comment">// This means Bob has a payment plan in his PAYMENTS INBOX, with the recipient&#39;s (Alice)</span>
                                            <span class="comment">// transaction number set to X, and the sender&#39;s transaction number set to 0. It&#39;s 0 because</span>
                                            <span class="comment">// the instrument is still in Bob&#39;s inbox -- he hasn&#39;t signed it yet -- so his transaction</span>
                                            <span class="comment">// number isn&#39;t on it yet. It&#39;s blank (0).</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// Next, let&#39;s say Bob signs/confirms the contract, which puts a copy of it into his PAYMENTS</span>
                                            <span class="comment">// OUTBOX. On the outbox version, Alice&#39;s transaction number is X, and Bob&#39;s transaction number</span>
                                            <span class="comment">// is Y.</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// Later on, Bob needs to lookup the payment plan in his PAYMENTS INBOX (for example, to remove</span>
                                            <span class="comment">// it, AS YOU SEE IN THE BELOW LOOP.) Remember, Bob&#39;s transaction number is Y. But he can&#39;t use</span>
                                            <span class="comment">// that number (Y) to lookup the payment plan in his inbox, since it&#39;s set to ZERO in his inbox!</span>
                                            <span class="comment">// The inbox version simply doesn&#39;t HAVE Y set onto it yet -- only the outbox version does.</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// So how in the fuck does Bob lookup the inbox version, if the transaction number isn&#39;t SET on</span>
                                            <span class="comment">// it yet??</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// The solution:</span>
                                            <span class="comment">// 1. Bob grabs an OTNumList containing all the transaction numbers from the OUTBOX VERSION,</span>
                                            <span class="comment">//    which ends up containing &quot;X,Y&quot; (that happens in this block.)</span>
                                            <span class="comment">// 2. Bob loops through the payments INBOX, and for each, he grabs an OTNumList containing all</span>
                                            <span class="comment">//    the transaction numbers. One of those (the matching one) will contain &quot;X,0&quot;. (Except it</span>
                                            <span class="comment">//    will actually only contain &quot;X&quot;, since 0 is ignored in the call to GetAllTransactionNumbers.)</span>
                                            <span class="comment">// 3. Bob then checks like this:    if (numlistOutpayment.VerifyAny(numlistIncomingPayment))</span>
                                            <span class="comment">//    This is equivalent to saying: if (&quot;X,Y&quot;.VerifyAny(&quot;X&quot;)) which RETURNS TRUE -- and we have</span>
                                            <span class="comment">//    found the instrument!</span>

                                            <a class="code" href="class_o_t_payment.html">OTPayment</a> theOutpayment;

                                            <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()                  &amp;&amp;
                                                theOutpayment.<a class="code" href="class_o_t_payment.html#a294a4886d8701ff1366bca5fdd1e7b56">SetPayment</a>(strInstrument) &amp;&amp;
                                                theOutpayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
                                            {
                                                theOutpayment.<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistOutpayment);
                                            }
                                            <span class="comment">// ------------------------------------------------------</span>
                                            <span class="keyword">const</span> int32_t nTransCount = thePmntInbox.GetTransactionCount();

                                            <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// Count backwards since we are removing things.</span>
                                            {
                                                int64_t lPaymentTransNum = 0;
                                                <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = thePmntInbox.GetInstrument(*pNym, ii);
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);

                                                <span class="keywordflow">if</span> (NULL == pPayment)
                                                {
                                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: While looping payments inbox to remove a payment, unable to retrieve payment at index %d (skipping.)\n&quot;</span>,
                                                        __FUNCTION__, ii);
                                                    <span class="keywordflow">continue</span>;
                                                }
                                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
                                                {
                                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: While looping payments inbox to remove a payment, unable to set temp values for payment at index %d (skipping.)\n&quot;</span>,
                                                        __FUNCTION__, ii);
                                                    <span class="keywordflow">continue</span>;
                                                }
                                                <span class="comment">// ---------------------------------------------------</span>

                                                <a class="code" href="class_o_t_num_list.html">OTNumList</a> numlistIncomingPayment;

                                                pPayment-&gt;<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistIncomingPayment);

                                                <span class="comment">// ---------------------------------------------------                                                    </span>

                                                <span class="keywordflow">if</span> (numlistOutpayment.VerifyAny(numlistIncomingPayment))
                                                {
                                                    <span class="comment">// ** It&#39;s the same instrument.**</span>
                                                    <span class="comment">// Remove it from the payments inbox, and save.</span>
                                                    <span class="comment">//</span>
                                                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a>    * pTransPaymentInbox = thePmntInbox.GetTransactionByIndex(ii);
                                                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL  != pTransPaymentInbox); <span class="comment">// It DEFINITELY should be there. (Assert otherwise.)</span>
                                                    lPaymentTransNum = pTransPaymentInbox-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

                                                    <span class="comment">// DON&#39;T I NEED to call DeleteBoxReceipt at this point?</span>
                                                    <span class="comment">// Since that needs to be called now whenever removing something from any box?</span>
                                                    <span class="comment">//</span>
                                                    <span class="comment">// NOTE: might need to just MOVE this box receipt to the record box, instead of</span>
                                                    <span class="comment">// deleting it.</span>
                                                    <span class="comment">//</span>
                                                    <span class="comment">// Probably I need to do that ONLY if the version in the payments outbox doesn&#39;t exist.</span>
                                                    <span class="comment">// For example, if strInstrument doesn&#39;t exist, then there was nothing in the payments</span>
                                                    <span class="comment">// outbox, and therefore the version in the payment INBOX is the ONLY version I have,</span>
                                                    <span class="comment">// and therefore I should stick it in the Record Box.</span>
                                                    <span class="comment">//</span>
                                                    <span class="comment">// HOWEVER, if strInstrument DOES exist, then I should create its own transaction to add</span>
                                                    <span class="comment">// to the record box, and delete the one that was in the payment inbox. Why delete it? Because</span>
                                                    <span class="comment">// otherwise I would be adding the same thing TWICE to the record box, which I don&#39;t really</span>
                                                    <span class="comment">// need to do. And if I&#39;m going to choose one of the two, the one in the outpayments box will</span>
                                                    <span class="comment">// be the more recent / more relevant one of the two. So I favor that one, unless it doesn&#39;t</span>
                                                    <span class="comment">// exist, in which case I should add the other one instead. (Todo.)</span>
                                                    <span class="comment">//</span>
                                                    <span class="comment">// NOTE: Until the above is completed, the current behavior is that the outpayments box item</span>
                                                    <span class="comment">// will be moved to the record box if it exists, and otherwise nothing will be, since any payments</span>
                                                    <span class="comment">// inbox item will be deleted.</span>

                                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePmntInbox.DeleteBoxReceipt(lPaymentTransNum))
                                                    {
                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
                                                            <span class="stringliteral">&quot;from the payment inbox.\n&quot;</span>, __FUNCTION__);
                                                    }
                                                    <span class="comment">// --------------------------------------------------</span>
                                                    <span class="keywordflow">if</span> (thePmntInbox.RemoveTransaction(lPaymentTransNum))
                                                    {
                                                        thePmntInbox.ReleaseSignatures();
                                                        thePmntInbox.SignContract(*pNym);
                                                        thePmntInbox.SaveContract();

                                                        <span class="keywordflow">if</span> (!thePmntInbox.SavePaymentInbox())
                                                        {
                                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
                                                        }
                                                        <span class="keywordflow">else</span>
                                                        {
                                                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed instrument from payment inbox.\n&quot;</span>
                                                                <span class="stringliteral">&quot;Saved payment inbox.\n&quot;</span>, __FUNCTION__);
                                                        }
                                                    }
                                                    <span class="keywordflow">else</span>
                                                    {
                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove transaction from payment inbox. &quot;</span>
                                                            <span class="stringliteral">&quot;(Should never happen.)\n&quot;</span>, __FUNCTION__);
                                                    }
                                                    <span class="comment">// -----------------------------------------------</span>
                                                    <span class="comment">// Note: I could break right here, if this is the only transaction in the</span>
                                                    <span class="comment">// payment inbox which contains the instrument in question. Which I believe</span>
                                                    <span class="comment">// it is.  Todo: if that&#39;s true, which I think it is, then call break here.</span>
                                                    <span class="comment">// After all, you wouldn&#39;t send me the SAME instrument TWICE, would you?</span>
                                                    <span class="comment">// But it still seems theoretically possible (albeit stupid.)</span>
                                                }
                                            }
                                            <span class="comment">// for (int32_t ii = 0; ii &lt; nTransCount; ++ii)</span>
                                            <span class="comment">// -------------------------------------------------------------------------------</span>
                                            <span class="comment">// Also, if there was a message in the outpayments box (which we already removed</span>
                                            <span class="comment">// a bit above), go ahead and add a receipt for it into the record box.</span>
                                            <span class="comment">//</span>
                                            <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// Found the instrument in the outpayments box.</span>
                                            {
                                                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pNewTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theRecordBox, <span class="comment">// recordbox.</span>
                                                    <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>,
                                                    lNymOpeningNumber);
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel(pNewTransaction);

                                                <span class="keywordflow">if</span> (NULL != pNewTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
                                                {
                                                    pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lNymOpeningNumber); <span class="comment">// Referencing myself here. We&#39;ll see how it works out.</span>
                                                    pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInstrument);    <span class="comment">// The cheque, invoice, etc that used to be in the outpayments box.</span>
                                                    pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                                    pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.AddTransaction(*pNewTransaction);

                                                    <span class="keywordflow">if</span> (!bAdded)
                                                    {
                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (after tentatively removing &quot;</span>
                                                            <span class="stringliteral">&quot;from payment outbox, an action that is now canceled.)\n&quot;</span>, __FUNCTION__,
                                                            pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                                                    }
                                                    <span class="keywordflow">else</span>
                                                    {
                                                        theTransactionAngel.SetCleanupTargetPointer(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>

                                                        theRecordBox.ReleaseSignatures();
                                                        theRecordBox.SignContract(*pNym);
                                                        theRecordBox.SaveContract();
                                                        <span class="comment">// -------------------------------</span>
                                                        theRecordBox.SaveRecordBox(); <span class="comment">// todo log failure.</span>

                                                        <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                                                        <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                                                        <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                                                        <span class="comment">// is removed from a box.</span>
                                                        <span class="comment">//</span>
                                                        <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
                                                        {
                                                            <a class="code" href="class_o_t_string.html">OTString</a> strNewTransaction(*pNewTransaction);
                                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... &quot;</span>
                                                                <span class="stringliteral">&quot;Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
                                                                __FUNCTION__, strNewTransaction.Get());
                                                        }
                                                    }
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                } <span class="comment">// if (NULL != pNewTransaction)</span>
                                                <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
                                                {
                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
                                                        <span class="stringliteral">&quot;add a new transaction to record box (for a payment instrument we just removed &quot;</span>
                                                        <span class="stringliteral">&quot;from the outpayments box): %s\n&quot;</span>, __FUNCTION__, strNymID.Get());
                                                }
                                            } <span class="comment">// if (strInstrument.Exists()) (then add a copy to record box.)</span>
                                        } <span class="comment">// else (Success loading the payment inbox and recordBox)</span>
                                    } <span class="comment">// (OTItem::rejection == pReplyItem-&gt;GetStatus()) (loading payment inbox and record box.)</span>
                                } <span class="comment">// if payment plan or smart contract.</span>
                            } <span class="comment">// if (NULL != pCronItem)</span>
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading cronitem from original item, from string:\n%s\n&quot;</span>,
                                    __FUNCTION__, strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            }
                        } <span class="comment">// if (NULL != pOriginalItem)</span>
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading original item from string:\n%s\n\n&quot;</span>,
                                __FUNCTION__, strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        }
                    } <span class="comment">// if (NULL != pReplyItem)</span>
                } <span class="comment">// Case market offer, payment plan, or smart contract.</span>
                <span class="keywordflow">break</span>;

            <span class="keywordflow">default</span>: 
                <span class="comment">// Error</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: wrong transaction type: %s\n&quot;</span>,
                    __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
                <span class="keywordflow">break</span>;
            } <span class="comment">// switch</span>
            <span class="comment">// -----------------------------------------------------------------            </span>
            <span class="comment">// atTransfer:      If success, KEEP the number on my list of responsibility. If fail, REMOVE it.</span>
            <span class="comment">//                  (Do the same for atMarketOffer, atPaymentPlan, and atSmartContract.)</span>
            <span class="comment">// atDeposit:       Whether success or fail, remove the number from my list of responsibility.</span>
            <span class="comment">// atWithdrawal:    Whether success or fail, remove the number from my list of responsibility.</span>
            <span class="comment">// atAcceptPending: Whether success or fail, remove the number from my list of responsibility.</span>
            <span class="comment">// -----------------------------------------------------------------</span>
            <span class="comment">//</span>
            <span class="comment">// SAVE THE RECEIPT....</span>
            <span class="comment">//</span>
            <span class="comment">//OTFolders::Receipt().Get()</span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
            <a class="code" href="class_o_t_string.html">OTString</a> strReceiptFilename; <span class="comment">//contains: strReceiptID .success, fail, or error.</span>
            <span class="comment">// ---------------------------------------------------------</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);

            <span class="keywordflow">if</span> (NULL == pItem)
            {
                pItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);

                <span class="keywordflow">if</span> (NULL != pItem)
                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strReceiptID); <span class="comment">// In this case, the receipt ID is the Nym ID</span>
            }
            <span class="keywordflow">else</span> 
            {
                strReceiptID = theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>; <span class="comment">// If a balance statement, then the receipt ID is the Account ID.</span>
            }
            <span class="comment">// --------------------------------------------------------------------</span>
            <span class="comment">// Try to save the transaction receipt to local storage.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strTransaction;
            pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTransaction);
            <span class="comment">// --------------------------------------------------------------------</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
            <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(strTransaction);

            <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.WriteArmoredString(strFinal, <span class="stringliteral">&quot;TRANSACTION&quot;</span>)) <span class="comment">// todo hardcoding.</span>
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving transaction receipt (failed writing armored string):\n&quot;</span>
                    <span class="stringliteral">&quot;%s%s%s%s%s\n&quot;</span>, __FUNCTION__,
                    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
                    strServerID.Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keywordflow">return</span>;
            }
            <span class="comment">// ------------------------------------------------------------------------</span>
            <span class="keywordflow">if</span> (NULL != pItem)
            {
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Filename is based on transaction success/failure.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
                    strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.Get());
                <span class="keywordflow">else</span>
                    strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.fail&quot;</span>,    strReceiptID.Get());
                <span class="comment">// --------------------------------------------------------------------</span>

                <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                    strServerID.Get(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="comment">// This should never happen...</span>
            {
                strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.error&quot;</span>, strReceiptID.Get());

                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving transaction receipt, since pItem was NULL: %s\n&quot;</span>,
                    __FUNCTION__, strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                    strServerID.Get(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());               
            }

            <span class="comment">// No matter what kind of transaction it is,</span>
            <span class="comment">// let&#39;s see if the server gave us some new transaction numbers with it...</span>
            <span class="comment">// UPDATE: the server will not give me transaction numbers unless I have SIGNED FOR THEM.</span>
            <span class="comment">// Therefore, they are now dropped into the Nymbox, and that is where they will be.</span>
            <span class="comment">//          HarvestTransactionNumbers(*pTransaction, *pNym);</span>
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying server ownership of this transaction.\n&quot;</span>,
                __FUNCTION__);
        }       
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="acba8ab65dfe62afdc219277c9d44b546"></a><!-- doxytag: member="OTClient::ProcessMessageOut" ref="acba8ab65dfe62afdc219277c9d44b546" args="(char *buf, int32_t *pnExpectReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">OTClient::ProcessMessageOut</a> </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t *&#160;</td>
          <td class="paramname"><em>pnExpectReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00179">179</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
<span class="comment">//  OTLog::vError(&quot;OTClient::ProcessMessageOut: \n\n%s\n\n&quot;,</span>
<span class="comment">//               buf);</span>
<span class="comment">//</span>
<span class="comment">//  const OTString strMessage(buf);</span>
<span class="comment">//  OTMessage tempMsg;</span>
<span class="comment">//  tempMsg.LoadContractFromString(strMessage);</span>

    <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(buf, pnExpectReply);

    <span class="comment">//  OTLog::Error(&quot;OTClient::ProcessMessageOut: FINISHED.\n&quot;);</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="afdce1f6ff6989facd771283605f4a3c4"></a><!-- doxytag: member="OTClient::ProcessMessageOut" ref="afdce1f6ff6989facd771283605f4a3c4" args="(OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">OTClient::ProcessMessageOut</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l00196">196</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strMessage(theMessage);
<span class="comment">//  OTLog::vError(&quot;OTClient::ProcessMessageOut: \n\n%s\n\n&quot;,</span>
<span class="comment">//                strMessage.Get());</span>
<span class="comment">//</span>
    <span class="comment">// ----------------------------------------</span>

    <span class="comment">// WHAT DOES THIS MEAN?</span>

    <span class="comment">// I means that later, if a message with a certain request number</span>
    <span class="comment">// fails to reply, or show its face in the replies box, then I will</span>
    <span class="comment">// have the option to look it up in the Outbuffer, based on that</span>
    <span class="comment">// same request number, and send a re-try, or claw back any transaction</span>
    <span class="comment">// numbers that might be on that message.</span>

    <span class="comment">// Should probably add an API call for specifically doing this, agnostic</span>
    <span class="comment">// to whatever kind of transaction it actually is. Something like, </span>
    <span class="comment">// OT_API_Message_HarvestClosingNumbers, and OT_API_Message_HarvestAllNumbers</span>

    <span class="comment">// So I can save the request number when sending a message, check for it later</span>
    <span class="comment">// in the Nymbox, and then worst case, look it up in the Outbuffer and get my</span>
    <span class="comment">// fucking transaction numbers back again!</span>

    <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>; <span class="comment">// a copy.</span>
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMsg);

    <span class="keywordflow">if</span> (pMsg-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strMessage))
        m_MessageOutbuffer.<a class="code" href="class_o_t_message_outbuffer.html#ac51b8628eaa4367261e4ac86c2309404">AddSentMessage</a>(*pMsg);
    <span class="keywordflow">else</span>
    {
        <span class="comment">// todo, log here.</span>
        <span class="keyword">delete</span> pMsg;
        pMsg = NULL;
    }
    <span class="comment">// ----------------------------------------</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>, <span class="stringliteral">&quot;OTClient::ProcessMessageOut: ASSERT: NULL != m_pConnection\n&quot;</span>);

    <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(theMessage);  <span class="comment">// &lt;===========</span>

    <span class="comment">//  OTLog::Error(&quot;OTClient::ProcessMessageOut: FINISHED.\n&quot;);</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="aef4ff4a25033a395f916881a074c58fb"></a><!-- doxytag: member="OTClient::ProcessPayDividendResponse" ref="aef4ff4a25033a395f916881a074c58fb" args="(OTTransaction &amp;theTransaction, OTServerConnection &amp;theConnection, OTMessage &amp;theReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">OTClient::ProcessPayDividendResponse</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>theTransaction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;&#160;</td>
          <td class="paramname"><em>theConnection</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l02370">2370</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
    theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
    <span class="comment">//  OTWallet * pWallet = theConnection.GetWallet();</span>

    <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to pay dividend.</span>

    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
    {
        <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);

        <span class="comment">// if pointer not null, and it&#39;s a dividend payout, and it&#39;s an acknowledgement (not a rejection or error)</span>

        <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
        { 
            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION SUCCESS -- Server acknowledges dividend payout.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION FAILURE -- Server rejects dividend payout.\n&quot;</span>);
            }

        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a79bcaacfd59042d3e3b384d34f6b16e9"></a><!-- doxytag: member="OTClient::ProcessServerReply" ref="a79bcaacfd59042d3e3b384d34f6b16e9" args="(OTMessage &amp;theReply, OTLedger *pNymbox=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">OTClient::ProcessServerReply</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_ledger.html">OTLedger</a> *&#160;</td>
          <td class="paramname"><em>pNymbox</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>We have just received a message from the server. Find out what it is and do the appropriate processing. Perhaps we just tried to create an account -- this could be our new account! Let's make sure we receive it and save it to disk somewhere.</p>
<p>PS... The Client TAKES OWNERSHIP of this message (adding it to a message buffer) and will store it until the buffer is flushed, or until the messages are popped back off later for processing by the client API. THEREFORE -- theReply MUST be allocated on the heap, and is only passed in as a reference here in order to make sure it's real.</p>
<p>returns true/false on whether or not the reply was actually verified and processed, versus whether </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l02800">2800</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);

    <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection = (*m_pConnection);

    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID;
    theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);

    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>   * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    USER_ID(*pNym);
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(SERVER_ID), strNymID(USER_ID);
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>   * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>());

    <span class="comment">// Just like the server verifies all messages before processing them,</span>
    <span class="comment">// so does the client need to verify the signatures against each message</span>
    <span class="comment">// and verify the various contract IDs and signatures.</span>
    <span class="keywordflow">if</span> (!theReply.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pServerNym)) 
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Server reply signature failed to verify.\n&quot;</span>,
            __FUNCTION__);

        <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = &amp;theReply; <span class="comment">// I&#39;m responsible to cleanup this object.</span>
        <span class="keyword">delete</span> pMessage;
        pMessage = NULL;
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------</span>
    <a class="code" href="class_o_t_message.html">OTMessage</a> * pSentMsg = this-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#ad60d6fcacb284e4ab9a3acde35bfc796">GetSentMessage</a>(atol(theReply.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()),
                                                                      strServerID,
                                                                      strNymID); <span class="comment">// doesn&#39;t delete.</span>
    <span class="comment">// ------------------------------------</span>
    <span class="comment">// We couldn&#39;t find it in the &quot;sent message&quot; outbuffer (todo: persist this buffer on the Nym.)</span>
    <span class="comment">// That means we must have missed the original server reply, even though it DID happen. Then we</span>
    <span class="comment">// downloaded the Nymbox to re-sync after that failure occurred, and found the reply there, and</span>
    <span class="comment">// processed it--removing it from the sent messages outbuffer at the same time, since it was now</span>
    <span class="comment">// definitely handled.</span>
    <span class="comment">// FINALLY the network comes through with the server reply, and here we are trying to process it</span>
    <span class="comment">// twice? But this time, it&#39;s NOT in the sent buffer, because we already processed it -- so we</span>
    <span class="comment">// discard it! (todo: in a nice future version, save all of these in the recordbox or something.)</span>
    <span class="comment">//</span>
    <span class="comment">// Here&#39;s another plausible scenario:  You RECEIVE the server&#39;s reply properly the first time, and</span>
    <span class="comment">// you process it. Of course, you STILL get the Nymbox copy of that same message (&quot;just in case&quot;) and</span>
    <span class="comment">// thus ProcessServerReply gets called a second time, again leading us to this block of code right here...</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (NULL == pSentMsg) <span class="comment">// </span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: FYI: no record of server reply in sent messages buffer. &quot;</span>
            <span class="stringliteral">&quot;We must have already processed it, and then removed it, earlier. &quot;</span>
            <span class="stringliteral">&quot;(Discarding.) Reply message:\n\n%s\n\n&quot;</span>, __FUNCTION__, strReply.Get());

        <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = &amp;theReply; <span class="comment">// I&#39;m responsible to cleanup this object.</span>
        <span class="keyword">delete</span> pMessage;
        pMessage = NULL;
        <span class="comment">// --------------------</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// ------------------------------------------------</span>
    <span class="comment">// Below this point, we know we found the original sent message--still cached as though its reply</span>
    <span class="comment">// hasn&#39;t been processed yet. We haven&#39;t processed it yet! We are now supposedly, processing it for</span>
    <span class="comment">// the first and proper time! Therefore, let&#39;s remove it from the &quot;sent messages&quot; outbuffer, so we</span>
    <span class="comment">// are able to tell, next time around, that this has already happened. (After all, we don&#39;t want</span>
    <span class="comment">// the next FlushSentMessages call to claw back any transaction numbers when we clearly had a proper</span>
    <span class="comment">// reply come through!)</span>
    <span class="comment">//</span>
    <span class="comment">// ------------------------------------</span>
    <span class="keyword">const</span> int64_t lReplyRequestNum = atol(theReply.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

    <span class="comment">//  bool bRemoved = </span>
    this-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#aefe611bcb8fab3e6fe763bfb98ccf86a">RemoveSentMessage</a>(lReplyRequestNum,
        strServerID,
        strNymID); <span class="comment">// deletes.</span>
    <span class="comment">// ------------------------------------</span>
    <span class="keywordtype">bool</span> bDirtyNym = <span class="keyword">false</span>;

    <span class="comment">// Similarly we keep a client side list of all the request numbers that we KNOW we have</span>
    <span class="comment">// a server reply for. (Each ID is maintained until we see a mirror of it appear in the server&#39;s</span>
    <span class="comment">// copy of that same list, and then we go ahead and remove it. This is basically an optimization</span>
    <span class="comment">// trick that enables us to avoid downloading many box receipts -- the replyNotices, specifically.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ae6b11aa38ba2894e1d8386d6e5589e2f">AddAcknowledgedNum</a>(strServerID, lReplyRequestNum)) <span class="comment">// doesn&#39;t save (here).</span>
    {
        bDirtyNym = <span class="keyword">true</span>;
    }

    <span class="comment">// Okay, we received a reply, so we added its request number to our list of &quot;replies we have definitely received.&quot;</span>
    <span class="comment">// But what about when the server sees that, and mirrors our list? It will send its own list, containing that mirror.</span>
    <span class="comment">// Any number that appears there, can be removed from the local list (confirmation is total by that point.)</span>
    <span class="comment">// Clearly the server KNOWS I saw his reply, since he copied my ack into his ack mirror list. Therefore I have no</span>
    <span class="comment">// more reason to continue telling him that I got the reply -- he already knows it!  So I can remove the number from</span>
    <span class="comment">// my ack list, which will cause the server to do the same to match, once he gets my next message.</span>
    <span class="comment">//</span>
    <span class="comment">// So next step: Loop through the ack list on the server reply, and any numbers there can be REMOVED from the local</span>
    <span class="comment">// list...</span>
    <span class="comment">//</span>
    std::set&lt;int64_t&gt; numlist_ack_reply;    
    <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a8ebd61b24f8b983cf02a1a49d21e3ec4">m_AcknowledgedReplies</a>.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(numlist_ack_reply)) <span class="comment">// returns false if the numlist was empty.</span>
    {
        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, numlist_ack_reply)
        {
            <span class="keyword">const</span> int64_t lTempRequestNum = *it;
            <span class="comment">// ----------------------------</span>
            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;

            <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0d8fd416811828f1eb8c07eb141790c2">RemoveAcknowledgedNum</a>(*pSignerNym, strServerID, lTempRequestNum, <span class="keyword">false</span>)) <span class="comment">// bSave=false</span>
                bDirtyNym = <span class="keyword">true</span>;
        }
    }
    <span class="comment">// ------------------------------------</span>

    <span class="keywordflow">if</span> (bDirtyNym)
    {
        <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
    }

    <span class="comment">// ------------------------------------</span>

    <span class="comment">// Done:  Do a Get Sent Message based on request number. If we find the</span>
    <span class="comment">// sent message, then process the reply and Remove the sent message.</span>
    <span class="comment">// But if we do NOT find the sent message, then we must have processed it</span>
    <span class="comment">// already -- in which case discard it and return.</span>

    <span class="comment">// Here, the Client takes ownership of the message (so make sure it&#39;s heap-allocated.)</span>
    m_MessageBuffer.<a class="code" href="class_o_t_message_buffer.html#ab7ed0d229c3d12cdf3c7d29e9a8b9192">Push</a>(theReply);

    <span class="comment">// Once that process is done, everything below that line, in this function,</span>
    <span class="comment">// will be able to assume there is a verified Nym available, and a Server Contract,</span>
    <span class="comment">// and an asset contract where applicable, and an account where applicable.</span>
    <span class="comment">//</span>
    <span class="comment">// Until that code is written, I do not have those things available to me.</span>
    <span class="comment">//</span>
    <span class="comment">// Furthermore also need to verify the payloads...</span>
    <span class="comment">// If &quot;Command Responding To&quot; was not actually signed by me, and I wasn&#39;t</span>
    <span class="comment">// expecting the new account request, then I do NOT want to sign it.</span>
    <span class="comment">//</span>
    <span class="comment">// Also if the new account is not signed by the server, I don&#39;t want to sign</span>
    <span class="comment">// it either. Need to check for all these things. Right now just proof of concept.</span>

    <span class="comment">// Also, assuming all the verification shit is done here, I will have the Nym</span>
    <span class="comment">// Wait a second, I think I have the Nym already cause there&#39;s a pointer on</span>
    <span class="comment">// the server connection that was passed in here...</span>

    <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@triggerClause&quot;</span>))
    {       
        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getRequest&quot;</span>))
    {
        int64_t lNewRequestNumber = theReply.<a class="code" href="class_o_t_message.html#a2d3fecf3324ca955abb23d0a4be0af6b">m_lNewRequestNum</a>;

        <span class="comment">// so the proper request number is sent next time, we take the one that</span>
        <span class="comment">// the server just sent us, and we ask the wallet to save it somewhere safe </span>
        <span class="comment">// (like in the nymfile)</span>

        <span class="comment">// In the future, I will have to write a function on the wallet that actually</span>
        <span class="comment">// takes the reply, looks up the associated nym in the wallet, verifies</span>
        <span class="comment">// that it was EXPECTING a response to GetRequest, (cause otherwise it won&#39;t</span>
        <span class="comment">// know which one to update) and then updates the request number there.</span>
        <span class="comment">// In the meantime there is only one connection, and it already has a pointer to</span>
        <span class="comment">// the Nym,  so I&#39;ll just tell it to update the request number that way for now.</span>

        theConnection.<a class="code" href="class_o_t_server_connection.html#a61901c8c0744a4746b019cfb56973ed6">OnServerResponseToGetRequestNumber</a>(lNewRequestNumber);

        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@checkUser&quot;</span>))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strNymID2(theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>),
                        strPubkey(theReply.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// Old style (It&#39;s deprecated to pass a pubkey directly like this.)</span>

        <span class="comment">// First try to get Credentials, if there are any.</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor  = theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>;  <span class="comment">// credentialList  (New style! Credentials.)</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor2 = theReply.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>; <span class="comment">// credentials</span>
        <span class="comment">// -----------------------------------------------------</span>
        <span class="keyword">const</span> <span class="keywordtype">bool</span> bHasCredentials = (ascArmor.Exists() &amp;&amp; ascArmor2.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
        <span class="comment">// -------------------------------------------------</span>
        <span class="keywordflow">if</span> (bHasCredentials) <span class="comment">// New style of doing things, for Nym keys. Credentials!</span>
        {            
            <span class="comment">// -------------------------------------------------</span>
            <span class="comment">// credentialList</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strCredentialList;
            ascArmor.GetString(strCredentialList);

            <span class="keywordflow">if</span> (strCredentialList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
                <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
                <span class="comment">// -------------------------------------------------</span>
                <span class="keywordflow">if</span> (NULL == pMap)
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object in @checkUser.\n&quot;</span>, __FUNCTION__);
                <span class="keywordflow">else</span> <span class="comment">// IF the list saved, then we save the credentials themselves...</span>
                {
                    <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
                    <span class="comment">// ----------------------------------------</span>
                    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theTargetNym;
                    theTargetNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(strNymID2);

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == theTargetNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strCredentialList, &amp;theMap))
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @checkUser: Failure loading nym %s &quot;</span>
                            <span class="stringliteral">&quot;from credential string.\n&quot;</span>,
                            __FUNCTION__, strNymID2.Get());
                    }
                    <span class="comment">// Now that the Nym has been loaded up from the message parameters,</span>
                    <span class="comment">// including the list of credential IDs, and the map containing the</span>
                    <span class="comment">// credentials themselves, let&#39;s try to Verify the pseudonym. If we</span>
                    <span class="comment">// verify, then we&#39;re safe to save the credentials to storage.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theTargetNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @checkUser: Loaded nym %s &quot;</span>
                            <span class="stringliteral">&quot;from credentials, but then it failed verifying.\n&quot;</span>,
                            __FUNCTION__, strNymID2.Get());
                    }
                    <span class="keywordflow">else</span><span class="comment">// Okay, we loaded the Nym up from the credentials in the message, AND</span>
                    {   <span class="comment">// verified the Nym (including the credentials.)</span>
                        <span class="comment">// So let&#39;s save it to local storage...</span>
                        <span class="comment">//</span>
                        <span class="comment">// -------------------------------------------------------------</span>
                        std::string str_nym_id = strNymID2.Get();
                        <a class="code" href="class_o_t_string.html">OTString</a> strFilename;
                        strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.cred&quot;</span>, str_nym_id.c_str());

                        <span class="keywordtype">bool</span> bStoredList = <span class="keyword">false</span>;
                        <a class="code" href="class_o_t_string.html">OTString</a> strOutput;
                        <span class="keywordflow">if</span> (ascArmor.Exists() &amp;&amp;
                            ascArmor.WriteArmoredString(strOutput, <span class="stringliteral">&quot;CREDENTIAL LIST&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
                            strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                            bStoredList = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                            <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                            strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="keywordflow">if</span> (!bStoredList)
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to armor or store %s.\n&quot;</span>,
                            __FUNCTION__, strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="comment">// -------------------------------------------------</span>
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: Success saving public credential list for Nym: %s\n&quot;</span>, strNymID2.Get());
                            <span class="comment">// ----------------------------------------</span>
                            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>, theMap)
                            {
                                std::string str_cred_id = (*it).first;
                                <a class="code" href="class_o_t_string.html">OTString</a>    strCredential((*it).second);
                                <span class="comment">// ------------------------------------------</span>
                                <span class="keywordtype">bool</span> bStoredCredential = <span class="keyword">false</span>;
                                strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascLoopArmor(strCredential);
                                <span class="keywordflow">if</span> (ascLoopArmor.Exists() &amp;&amp;
                                    ascLoopArmor.WriteArmoredString(strOutput, <span class="stringliteral">&quot;CREDENTIAL&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
                                    strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                    bStoredCredential = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                    <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                                    str_nym_id,
                                    str_cred_id);
                                <span class="keywordflow">if</span> (!bStoredCredential)
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to store credential %s for nym %s.\n&quot;</span>,
                                    __FUNCTION__, str_cred_id.c_str(), str_nym_id.c_str());
                                <span class="keywordflow">else</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: Success saving public credential ID: %s\n&quot;</span>, str_cred_id.c_str());
                                <span class="comment">// -------------------------------------------------</span>
                            } <span class="comment">//FOR_EACH</span>
                            <span class="comment">// ----------------------------------------</span>
                        } <span class="comment">// Success decoding string map of credential contents.</span>
                    }
                }
            } <span class="comment">// credential list exists, after base64-decoding.</span>
        } <span class="comment">// Has Credentials.</span>
        <span class="comment">// ---------------------------------------------------</span>
        <span class="comment">// Old-style (deprecated.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strPubkey.Exists())
        {
            <span class="comment">// ----------------------------------</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strPath = strNymID2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
            <span class="comment">// ----------------------------------</span>
            <span class="comment">// Next we save the public key in the pubkeys folder...</span>
            <span class="comment">//            </span>
            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> thePubkeyNym(strNymID2);

            <span class="keywordflow">if</span> (thePubkeyNym.SetPublicKey(strPubkey) &amp;&amp; thePubkeyNym.VerifyPseudonym())
            {
                <span class="keywordflow">if</span> (thePubkeyNym.SavePublicKey(strPath))
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: (Deprecated.) Success saving public key file for Nym: %s\n&quot;</span>, strNymID2.Get());
            }
        }
        <span class="comment">// ---------------------------------------------------</span>

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@notarizeTransactions&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to notarize Transactions message.\n&quot;</span>);
        <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to notarize Transactions message:\n%s\n&quot;, strReply.Get());</span>
        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>
        <a class="code" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">ProcessIncomingTransactions</a>(theConnection, theReply);

        <span class="comment">//todo (gui):</span>
        <span class="comment">// This block assumes that the above &quot;@notarizeTransactions&quot;, being successful, probably changed</span>
        <span class="comment">// the account balance. A nice GUI would probably interpret the reply and edit the local files</span>
        <span class="comment">// to update them to match (since it was successful). In fact, the above call to ProcessIncomingTransactions</span>
        <span class="comment">// does some of that sort of stuff already, at least for issued numbers on the nym.</span>
        <span class="comment">//</span>
        <span class="comment">// (For now we just re-download the files.)</span>
        
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getTransactionNum&quot;</span>))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to Get Transaction Num message.\n&quot;</span>);
        <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to Get Transaction Num message:\n%s\n&quot;, strReply.Get());</span>

        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getNymbox&quot;</span>))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received @getNymbox server response (%s)\n&quot;</span>,
            theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;failure&quot;</span>);

        <span class="comment">// base64-Decode the server reply&#39;s payload into strInbox</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strNymbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

        <span class="comment">// IF pNymbox NOT NULL, THEN USE IT INSTEAD OF LOADING MY OWN.</span>
        <span class="comment">// Except... @getNymbox isn&#39;t dropped as a replyNotice into the Nymbox,</span>
        <span class="comment">// so we&#39;ll never end up here except in cases where it needs to be</span>
        <span class="comment">// loaded. I can even ASSERT here, that the pointer is actually NULL!</span>
        <span class="comment">//</span>
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL == pNymbox, <span class="stringliteral">&quot;Nymbox pointer is expected to be NULL here, since @getNymbox isn&#39;t dropped as a server replyNotice into the nymbox.&quot;</span>);      

        <span class="comment">// Load the ledger object from that string.             </span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(USER_ID, USER_ID, SERVER_ID);    

        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH, RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ad4e740d990aa8aca410c0923dcde1737">SetNymboxHash</a>(str_server, NYMBOX_HASH);
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bNymboxHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting NymboxHash on Nym for server: %s\n&quot;</span>,
                str_server.c_str());
            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="comment">// ----------------------------------------------------</span>
            <span class="keywordflow">if</span> (bNymboxHash || bRecentHash)
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>

        <span class="comment">// I receive the nymbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
        <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this nymbox</span>
        <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
        <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
        <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (theNymbox.LoadNymboxFromString(strNymbox)) <span class="comment">// &amp;&amp; theNymbox.VerifyAccount(*pServerNym)) No point doing this, since the client hasn&#39;t even had a chance to download the box receipts yet. (VerifyAccount will fail before then...)</span>
        {

            <span class="comment">// -----------------------------------------------------------------</span>

            <span class="comment">//</span>
            <span class="comment">// UPDATE: We will have to rely on the Developer using the OT API to call</span>
            <span class="comment">// OT_API_FlushSentMessages IMMEDIATELY after calling getNymbox and receiving</span>
            <span class="comment">// a successful reply. Why? Because that&#39;s the only way to give him the chance</span>
            <span class="comment">// to see if certain replies are there or not (before they get removed.) That way</span>
            <span class="comment">// he can do his own harvesting, do a re-try, etc and then finally when he is done</span>
            <span class="comment">// with that, do the flush.</span>
            <span class="comment">//</span>
            <span class="comment">// -----------------------------------------------------------------</span>

            theNymbox.ReleaseSignatures(); <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own.</span>
            theNymbox.SignContract(*pNym); <span class="comment">// UPDATE: Releasing the signature again, since Receipts are now fully functional.</span>
            theNymbox.SaveContract();       <span class="comment">// Thus we can prove the Nymbox using the last signed transaction receipt. This means</span>
            theNymbox.SaveNymbox();         <span class="comment">// the receipt is our proof, and the nymbox becomes just an intermediary file that is</span>
                                            <span class="comment">// downloaded occasionally (like checking for new email) but no trust is risked since</span>
                                            <span class="comment">// the downloaded file is always verified against the receipt!</span>
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error loading or verifying nymbox during @getNymbox:\n\n%s\n&quot;</span>, strNymbox.Get());
        }

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="comment">// ------------------------------------------------------------------------</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getBoxReceipt&quot;</span>))
    {
        <span class="comment">//      OTString strReply(theReply);</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received server response to getBoxReceipt request (%s)\n&quot;</span>,
            theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;failure&quot;</span>);

        <span class="comment">// IF pNymbox NOT NULL, THEN USE IT INSTEAD OF LOADING MY OWN.</span>
        <span class="comment">// Except... @getNymbox isn&#39;t dropped as a replyNotice into the Nymbox,</span>
        <span class="comment">// so we&#39;ll never end up here except in cases where it needs to be</span>
        <span class="comment">// loaded. I can even ASSERT here, that the pointer is actually NULL!</span>
        <span class="comment">//</span>
        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL == pNymbox, <span class="stringliteral">&quot;Nymbox pointer is expected to be NULL here, since @getBoxReceipt isn&#39;t dropped as a server replyNotice into the nymbox.&quot;</span>);

        <span class="comment">// Note: I don&#39;t HAVE to load the ledger, and what if there are 500000 receipts in it?</span>
        <span class="comment">// Do I want to reload it EVERY time? Therefore     </span>
        <span class="keywordtype">bool</span> bErrorCondition = <span class="keyword">false</span>;
        <span class="keywordtype">bool</span> bSuccessLoading = <span class="keyword">true</span>;    <span class="comment">// We don&#39;t need to load the ledger, so that&#39;s commented out.</span>

        <span class="keywordflow">switch</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>)
        {   <span class="comment">// No need to load the ledger at this point...  plus, it would slow things down.</span>
        <span class="keywordflow">case</span> 0: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadNymbox();  break;</span>
        <span class="keywordflow">case</span> 1: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadInbox();   break;</span>
        <span class="keywordflow">case</span> 2: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadOutbox();  break;</span>
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Unknown box type: %lld\n&quot;</span>, __FUNCTION__, theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>);
            bErrorCondition = <span class="keyword">true</span>;
            <span class="keywordflow">break</span>;
        }
        <span class="comment">// ----------------------------------</span>

        <span class="keywordflow">if</span> (    bSuccessLoading &amp;&amp; !bErrorCondition)
            <span class="comment">//          &amp;&amp;  pLedger-&gt;VerifyAccount(*pServerNym)) // commenting this out for now -- unnecessary. Plus, it speeds things up to remove this.</span>
        {
            <span class="comment">// At this point, the ledger is loaded. Now let&#39;s use it for what we really</span>
            <span class="comment">// wanted: To save the Box Receipt!</span>
            <span class="comment">// Update: not loading ledger -- it would slow things down. Added a method that allowed me to circumvent loading it.</span>

            <span class="comment">// base64-Decode the server reply&#39;s payload into strTransaction</span>
            <span class="comment">//</span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransType(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
            <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = NULL;

            <span class="keywordflow">if</span> (strTransType.Exists())
                pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strTransType);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType); <span class="comment">// Still works if NULL argument. (Does nothing.)</span>

            <span class="keywordflow">if</span> (NULL == pTransType)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error instantiating transaction &quot;</span>
                <span class="stringliteral">&quot;type based on decoded theReply.m_ascPayload:\n\n%s\n&quot;</span>,
                __FUNCTION__, strTransType.Get());
            <span class="keywordflow">else</span> <span class="comment">// --------------------------------------------------------------------</span>
            {
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxReceipt = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);

                <span class="keywordflow">if</span> (NULL == pBoxReceipt)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error dynamic_cast from transaction &quot;</span>
                    <span class="stringliteral">&quot;type to transaction, based on decoded theReply.m_ascPayload:\n\n%s\n\n&quot;</span>,
                    __FUNCTION__, strTransType.Get());
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">VerifyAccount</a>(*pServerNym))
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: Box Receipt %lld in %s fails VerifyAccount().\n&quot;</span>,
                    __FUNCTION__, pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
                    (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>)); <span class="comment">// outbox is 2.);</span>
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>() != theReply.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: Transaction Number doesn&#39;t match &quot;</span>
                    <span class="stringliteral">&quot;on the box receipt itself (%lld), versus the one listed in the reply message (%lld).\n&quot;</span>,
                    __FUNCTION__, pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), theReply.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="comment">// Note: Account ID and Server ID were already verified, in VerifyAccount().                </span>
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>() != USER_ID)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPurportedUserID(pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>());
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: NymID doesn&#39;t match &quot;</span>
                        <span class="stringliteral">&quot;on the box receipt itself (%s), versus the one listed in the reply message (%s).\n&quot;</span>,
                        __FUNCTION__, strPurportedUserID.Get(), theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                }
                <span class="comment">// --------------------------------------------------------------------</span>
                <span class="keywordflow">else</span>    <span class="comment">// FINALLY we have the Ledger AND the Box Receipt both loaded at the same time.</span>

                {       <span class="comment">// UPDATE: Not loading the ledger at this point. Not necessary. Faster without it.</span>

                    <span class="comment">// UPDATE: We will ASSUME the abbreviated receipt is in the NYMBOX, which is WHY</span>
                    <span class="comment">// we are now downloading the FULL BOX RECEIPT. We will SAVE it for the Nymbox,</span>
                    <span class="comment">// which finishes the Nymbox (already in box as abbreviated, and already saved in full</span>
                    <span class="comment">// in box receipts folder). Next we will also add it to the PAYMENT INBOX and RECORD BOX,</span>
                    <span class="comment">// if it&#39;s the right sort of receipt. We will also save THEIR versions of the FULL BOX RECEIPT,</span>
                    <span class="comment">// just as we did for the Nymbox here.</span>

                    <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>    == pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || 
                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a> == pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
                    {
                        <span class="comment">// Just make sure not to add it if it&#39;s already there...</span>
                        <span class="comment">// ------------------------------------------------------</span>
                        <span class="keywordflow">if</span> (!strServerID.Exists()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %s dosn&#39;t Exist!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;strServerID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
                        <span class="keywordflow">if</span> (!strNymID.Exists())    { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %s dosn&#39;t Exist!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;strNymID&quot;</span>    ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
                        <span class="comment">// -----------------------------------------------------</span>
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                        <span class="comment">// -----------------------------------------------------</span>
                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
                        <span class="comment">// ------------------------------------------------------</span>
                        <span class="keywordtype">bool</span> bSuccessLoading = (bExists &amp;&amp; thePmntInbox.LoadPaymentInbox());
                        <span class="comment">// -----------------------------------------------------</span>
                        <span class="keywordflow">if</span> (bExists &amp;&amp; bSuccessLoading)
                            bSuccessLoading = (thePmntInbox.VerifyContractID() &amp;&amp; 
                            thePmntInbox.VerifySignature(*pNym));
                        <span class="comment">//                          bSuccessLoading = (thePmntInbox.VerifyAccount(*pNym)); // (No need here to load all the Box Receipts by using VerifyAccount)</span>
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists)
                            bSuccessLoading = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                        <span class="comment">// -----------------------------------------------------</span>
                        <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>

                        <span class="keywordflow">if</span> (!bSuccessLoading)
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: @getBoxReceipt: WARNING: Unable to load, verify, or &quot;</span>
                                <span class="stringliteral">&quot;generate paymentInbox, with IDs: %s / %s\n&quot;</span>,
                                __FUNCTION__, strUserID.Get(), strAcctID.Get());
                        }
                        <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying their contractID and signature, (OR success generating the ledger.)</span>
                        {
                            <span class="comment">// The transaction (which we are putting into the payment inbox) will not</span>
                            <span class="comment">// be removed from the nymbox until we receive the server&#39;s success reply to</span>
                            <span class="comment">// this &quot;process Nymbox&quot; message. That&#39;s why you see me adding it here to</span>
                            <span class="comment">// the payment inbox, while not removing it from the Nymbox (because that</span>
                            <span class="comment">// will happen once the reply is received.) NOTE: Need to make sure the</span>
                            <span class="comment">// associated box receipt doesn&#39;t get MARKED FOR DELETION when being removed</span>
                            <span class="comment">// at that time.</span>
                            <span class="comment">//</span>
                            <span class="comment">//                          void load_str_trans_add_to_ledger( const OTIdentifier &amp; the_nym_id,</span>
                            <span class="comment">//                                                             const OTString &amp; str_trans,</span>
                            <span class="comment">//                                                             const OTString str_box_type,</span>
                            <span class="comment">//                                                             const int64_t &amp; lTransNum,</span>
                            <span class="comment">//                                                             OTPseudonym &amp; the_nym,</span>
                            <span class="comment">//                                                             OTLedger &amp; ledger );</span>

                            <span class="comment">// Basically we are taking this receipt from the Nymbox, and also adding copies of it</span>
                            <span class="comment">// to the paymentInbox and the recordBox.</span>
                            <span class="comment">//</span>
                            <span class="comment">// QUESTION: what if I ERASE it out of my recordBox. Won&#39;t it pop back up again?</span>
                            <span class="comment">// ANSWER: YES, but not if I do this instead at @getBoxReceipt which will only happen once. </span>
                            <span class="comment">//         UPDATE: which I now AM (see our location here...)</span>
                            <span class="comment">// HOWEVER: Most likely not, because this notice will no longer BE in my Nymbox...</span>
                            <span class="comment">//</span>
                            <span class="comment">// QUESTION: What if I ERASE it out of my paymentInbox? Won&#39;t this pop back there again?</span>
                            <span class="comment">// ANSWER: I can&#39;t erase it out of there. I can either accept it or reject it. Either way,</span>
                            <span class="comment">// it is removed from my paymentInbox at that time by OT. Like above, if a copy were still</span>
                            <span class="comment">// in the Nymbox, I would get a duplicate here when processing Nymbox again. But MOST TIMES,</span>
                            <span class="comment">// there will be no duplicate, because it will already be cleaned out of my Nymbox anyway.</span>
                            <span class="comment">//</span>
                            <span class="comment">// </span>
                            <span class="keyword">const</span> int64_t lTransNum = pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

                            <span class="comment">// If pBoxReceipt-&gt;GetType() is instrument notice, add to the payments inbox.</span>
                            <span class="comment">// (It will be moved to record box after the incoming payment is deposited or discarded.)</span>
                            <span class="comment">// </span>
                            <a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">load_str_trans_add_to_ledger</a>(USER_ID, strTransType, <span class="stringliteral">&quot;paymentInbox&quot;</span>, lTransNum, *pNym, thePmntInbox);
                            <span class="comment">//                          load_str_trans_add_to_ledger(USER_ID, strTransType, &quot;recordBox&quot;,    lTransNum, *pNym, theRecordBox); // No longer here. Moved to processDepositResponse</span>
                            <span class="comment">// --------------------------------------------------------------</span>

                        } <span class="comment">// --- ELSE --- Success loading the payment inbox and verifying its contractID and signature, OR success generating the ledger.</span>
                    } <span class="comment">// if pBoxReceipt is instrumentNotice or instrumentRejection...</span>
                    <span class="comment">// *********************************************************************</span>

                    <span class="comment">//                  pBoxReceipt-&gt;ReleaseSignatures();</span>

                    <span class="comment">// I don&#39;t release the server&#39;s signature, so later on I can verify either</span>
                    <span class="comment">// signature -- the server&#39;s or pNym&#39;s. Both should be on the receipt.</span>
                    <span class="comment">// UPDATE: We&#39;re not changing the content of the Box Receipt AT ALL</span>
                    <span class="comment">// because we don&#39;t want to already its message digest, which will be</span>
                    <span class="comment">// compared to the hash stored in the abbreviated version of the same receipt.</span>
                    <span class="comment">//</span>
                    <span class="comment">//                  pBoxReceipt-&gt;SignContract(*pNym);</span>
                    <span class="comment">//                  pBoxReceipt-&gt;SaveContract();</span>

                    <span class="comment">//                  if (!pBoxReceipt-&gt;SaveBoxReceipt(*pLedger))             // &lt;===================</span>
                    <span class="keywordflow">if</span> (!pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>))    <span class="comment">// &lt;===================</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt(): Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
                        __FUNCTION__, strTransType.Get());
                    <span class="comment">/* theReply.m_lDepth in this context stores boxType. Value can be: 0/nymbox,1/inbox,2/outbox*/</span>

                } <span class="comment">// We can save the box receipt.</span>
            } <span class="comment">// Success loading the boxReceipt from the server reply</span>
        } <span class="comment">// No error condition.</span>
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: SHOULD NEVER HAPPEN: @getBoxReceipt: failure &quot;</span>
                <span class="stringliteral">&quot;loading box, or verifying it. UserID: %s  AcctID: %s \n&quot;</span>,
                __FUNCTION__, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }
        <span class="comment">// ----------------------------------</span>

        <span class="keywordflow">return</span> <span class="keyword">true</span>;

    }   <span class="comment">// @getBoxReceipt</span>
    <span class="comment">// ------------------------------------------------------------------------</span>
    <span class="comment">// IN EITHER of these cases, the number of transaction numbers on my Nym has probably changed.</span>
    <span class="comment">// But the server acknowledgment here confirms it, so I should remove any issued numbers, </span>
    <span class="comment">// save the nym, etc.</span>
    <span class="comment">//</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp;
        (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processInbox&quot;</span> ) ||
        theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processNymbox&quot;</span>) )
        )
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strReply(theReply);

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received server response: %s \n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to processInbox or processNymbox message:\n%s\n&quot;, strReply.Get());</span>
        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
        <span class="keyword">const</span> std::string str_server(strServerID.Get());

        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);

            <span class="keywordflow">if</span> (!bRecentHash)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
            }
        }
        <span class="comment">// -------------------------------</span>
        <span class="comment">// If the server acknowledges either of the above commands, then my transaction</span>
        <span class="comment">// numbers have changed. I need to read the numbers from my last transaction agreement</span>
        <span class="comment">// (which should be saved in this server reply) and make sure to update my nym accordingly.</span>
        <span class="comment">//</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);

        <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;

        <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
            theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym)
            )
        {
            <a class="code" href="class_o_t_string.html">OTString</a>    strLedger, strReplyLedger;

            <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processNymbox&quot;</span>))
                ACCOUNT_ID = USER_ID; <span class="comment">// For Nymbox, UserID *is* AcctID.</span>

            <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theLedger     (USER_ID, ACCOUNT_ID, SERVER_ID),
                        theReplyLedger(USER_ID, ACCOUNT_ID, SERVER_ID);

            theOriginalMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strLedger);
            theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strReplyLedger);
            <span class="comment">// -----------------------------------------</span>

            <span class="keywordflow">if</span> (!strLedger.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                <a class="code" href="class_o_t_string.html">OTString</a> strLogData(theOriginalMessage);
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but found no request ledger within your original message:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLogData.Get());             
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strReplyLedger.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... received server acknowledgment (%s), but found no reply ledger within:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReply.Get());               
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theLedger.LoadLedgerFromString(strLedger))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to load original request ledger from string:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());              
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theLedger.VerifySignature(*pNym))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to verify your signature on the original request ledger:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());              
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theReplyLedger.LoadLedgerFromString(strReplyLedger))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to load the reply ledger from string:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReplyLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theReplyLedger.VerifySignature(*pServerNym))
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to verify server&#39;s signature on the reply ledger within:\n\n%s\n\n&quot;</span>,
                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReplyLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            }
            <span class="keywordflow">else</span> 
            {
                <span class="comment">// atAcceptItemReceipt: Whether success or fail, remove the number used from list of responsibility.</span>
                <span class="comment">//                      ALSO, if success, remove the number from the original cheque or the original transfer request.</span>
                <span class="comment">//</span>
                <span class="comment">// Other options are not handled here, but they ARE handled elsewhere (above). They are:</span>
                <span class="comment">//</span>
                <span class="comment">// atDeposit:       Whether success or fail, remove the number from my list of responsibility.</span>
                <span class="comment">// atWithdrawal:    Whether success or fail, remove the number from my list of responsibility.</span>
                <span class="comment">// atAcceptPending: Whether success or fail, remove the number from my list of responsibility.</span>
                <span class="comment">// atTransfer:      If success, KEEP the number on my issued list. (Remove when transfer receipt is accepted.)</span>
                <span class="comment">//                  If failure, REMOVE the number from my issued list. (Use a new one next time.)</span>
                <span class="comment">// atMarketOffer:   If success, KEEP the number on my issued list. (Removed when final receipt is created.)</span>
                <span class="comment">//                  If failure, REMOVE the number from my issued list. (Use a new one next time.)</span>
                <span class="comment">// atCancelCronItem: Whether success or fail, remove the number from my list of responsibility.</span>
                <span class="comment">// atExchangeBasket: Whether success or fail, remove the number from my list of responsibility.</span>

                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction        = NULL;
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pReplyTransaction   = NULL;

                <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processInbox&quot;</span>)) <span class="comment">// We&#39;re processing the SERVER&#39;s REPLY to our processInbox request.</span>
                {
                    pTransaction        = theLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>);
                    pReplyTransaction   = theReplyLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>);

                    <span class="keywordflow">if</span> (NULL != pTransaction)
                    {
                        <span class="comment">// pNym-&gt;RemoveTransactionNum() happened whenever I first fired off the processInbox request.</span>
                        <span class="comment">// Now let&#39;s remove that number from our ISSUED list of responsibility, since we got a server reply...</span>
                        <span class="comment">//  &lt;====&gt; Whatever trans num I used to process inbox is now OFF my issued list on server side! </span>
                        <span class="comment">// (Therefore remove here too, to match..)</span>
                        <span class="comment">//</span>
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsSignedOut = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                        <span class="comment">// Why? Because we might have already processed this, when it first happened, and now we&#39;re just</span>
                        <span class="comment">// seeing a repeat of the message from a nymbox notice. (Some messages are so important, you get</span>
                        <span class="comment">// a nymbox notice including a copy of the message, so the server can make SURE you have processed</span>
                        <span class="comment">// the reply. This was added to prevent syncing issues between client and server.)</span>
                        <span class="comment">//</span>
                        <span class="keywordflow">if</span> (bIsSignedOut)
                            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
                        <span class="comment">// --------------------------------------------</span>
                        <span class="keywordflow">if</span> (bIsSignedOut &amp;&amp; (NULL != pReplyTransaction))
                        {
                            <span class="comment">// Load the inbox.              </span>
                            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox    (USER_ID, ACCOUNT_ID, SERVER_ID);
                            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, ACCOUNT_ID, SERVER_ID);

                            <span class="keywordtype">bool</span> bInbox = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a6f314709ced53a8c542eb5ef53126b39">OTFolders::Inbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                            <span class="keywordflow">if</span> (bInbox &amp;&amp; theInbox.LoadInbox())
                                bInbox = theInbox.VerifyAccount(*pNym);

                            <span class="comment">// I JUST had this loaded if I sent acceptWhatever just instants ago, (which I am now processing the reply for.)</span>
                            <span class="comment">// Therefore I&#39;m just ASSUMING here that it loads successfully here, since it worked an instant ago. Todo.</span>
                            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bInbox, <span class="stringliteral">&quot;Was trying to load / verify Inbox.&quot;</span>);
                            <span class="comment">// -------------------------------------</span>
                            <span class="keywordtype">bool</span> bLoadedRecordBox  = <span class="keyword">false</span>;
                            <span class="keywordtype">bool</span> bRecordBoxExists  = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            <span class="comment">// -------------------------------------</span>
                            <span class="comment">// Next, loop through the reply items for each &quot;process inbox&quot; item that I must have previously sent.</span>
                            <span class="comment">// For each, if successful, remove from inbox.</span>
                            <span class="comment">// For item receipts, if successful, also remove the appropriate trans# </span>
                            <span class="comment">// from my issued list of transaction numbers (like above.)</span>

                            <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>(), it_bigloop)
                            {
                                <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it_bigloop;
                                <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pReplyItem, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Pointer should not have been NULL.&quot;</span>);

                                <span class="comment">//                              OTLog::Error(&quot; *** TOP OF LOOP of Reply items, one presumably for each processInbox that I sent previously.\n&quot;);</span>

                                <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

                                <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
                                {       
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>: 
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>;
                                    <span class="keywordflow">break</span>;
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>;
                                    <span class="keywordflow">break</span>;
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>;
                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// ------------------------</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a84f21da0049c428f2e74c573dfaff067">OTItem::atRejectPending</a>: <span class="comment">// turn down the money!</span>
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a873fcfb43e552e1f81d475fb898e9ac8">OTItem::rejectPending</a>;
                                    <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a15fb11d5243db9056a4c340bc49cea43">OTItem::atDisputeCronReceipt</a>: <span class="comment">// dispute a market trade or payment for a payment plan</span>
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0ae31723e4a6a715f4de40bf18aa932f">OTItem::disputeCronReceipt</a>;
                                    <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acd9426f6754691aebb202e9c14cdc681">OTItem::atDisputeItemReceipt</a>: <span class="comment">// dispute a cheque receipt or transfer receipt.</span>
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4eb8608cbf2db1dd590856c3777e70a2">OTItem::disputeItemReceipt</a>;
                                    <span class="keywordflow">continue</span>; <span class="comment">// unused</span>

                                    <span class="comment">// ------------------------</span>

                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>;
                                    <span class="keywordflow">break</span>;

                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>;
                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// ------------------------</span>

                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9b353f70c54facca58998d250badcf27">OTItem::atDisputeFinalReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a62442ecb84d96e94176c7f9b533a9061">OTItem::disputeFinalReceipt</a>;
                                    <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9fc8674f161335439c48b2e9db277b9b">OTItem::atDisputeBasketReceipt</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a69a150fe3a7ec3726dc71d183d572a87">OTItem::disputeBasketReceipt</a>;
                                    <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
                                    <span class="comment">// ------------------------</span>

                                    <span class="comment">// We don&#39;t care about these here.</span>
                                    <span class="comment">//</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>;
                                    <span class="keywordflow">continue</span>;
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>:
                                    theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>;
                                    <span class="keywordflow">continue</span>;

                                    <span class="comment">// FYI, on server side, it does not bother to process an item,</span>
                                    <span class="comment">// if the balance statement or transaction statement has not succeeded.</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// Thus, if the ITEM ITSELF has succeeded, that means the balance or</span>
                                    <span class="comment">// transaction statement MUST have succeeded! Because server wouldn&#39;t have</span>
                                    <span class="comment">// even bothered to process the item otherwise.</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// There still might be some future application in doing something with these</span>
                                    <span class="comment">// statements when they come in.</span>

                                    <span class="comment">// -----------------------------------------------------</span>

                                <span class="keywordflow">default</span>:
                                    {
                                        <span class="keyword">const</span> int32_t nReplyItemType = pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();

                                        <a class="code" href="class_o_t_string.html">OTString</a> strTheType;
                                        pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTheType);

                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;*** Unexpected reply item type (%d) in @processInbox, while processing server reply: %s \n&quot;</span>,
                                            nReplyItemType, strTheType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                        <span class="keywordflow">continue</span>;
                                    }
                                } <span class="comment">// SWITCH</span>

                                <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <span class="comment">// The below actions are only necessary if pReplyItem was a SUCCESS.</span>
                                <span class="comment">// (Otherwise we skip them...)</span>
                                <span class="comment">//</span>
                                <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
                                pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);

                                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                                {
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processInbox reply item %s: status == FAILED\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    <span class="keywordflow">continue</span>;
                                }
                                <span class="comment">// else</span>
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processInbox reply item %s: status == SUCCESS\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                                <span class="comment">// ------------------------------------------------------------------------------------    </span>

                                <span class="comment">// WTF IS THIS? There could be 3 acceptPendings, 5 acceptCronReceipts, 3 acceptFinalReceipts, etc </span>
                                <span class="comment">// in a single ProcessInbox transaction. Therefore this &quot;get by type&quot; will NOT fly in this case.</span>
                                <span class="comment">// (Fixing this now to look it up by ID instead of type.)</span>
                                <span class="comment">//</span>
                                <span class="comment">//OTItem * pItem = pTransaction-&gt;GetItem(theItemType);</span>
                                <span class="comment">//</span>
                                <span class="comment">// Can&#39;t do this either:</span>
                                <span class="comment">// OTItem * pItem = pTransaction-&gt;GetItemInRefTo(pReplyItem-&gt;GetReferenceToNum());</span>
                                <span class="comment">//</span>
                                <span class="comment">// (pReplyItem-&gt;GetReferenceToNum() contains the processInbox transaction# of pItem, not</span>
                                <span class="comment">//  the inbox receipt # that pItem is in reference to.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// pTransaction is the processInbox transaction request that I sent.</span>
                                <span class="comment">// (The items within it all share its same transaction number, but they are IN REFERENCE TO</span>
                                <span class="comment">//  the inbox receipts that they accept/reject.)</span>
                                <span class="comment">// pReplyTransaction is the server&#39;s reply to that.</span>
                                <span class="comment">// pReplyItem is the current item when iterating through pReplyTransaction.</span>
                                <span class="comment">// pItem is the corresponding REQUEST item from pTransaction, that pReplyItem is responding to.</span>
                                <span class="comment">//</span>
                                <span class="comment">// Therefore: I need to load the original item from pReplyItem&#39;s reference string (it&#39;s bundled in there).</span>
                                <span class="comment">// THEN I will get the &quot;in reference to&quot; number from THAT (which is the inbox Receipt #).</span>
                                <span class="comment">// THEN I will use that number to look up the SAME original item from pTransaction.</span>
                                <span class="comment">// The last step isn&#39;t technically necessary, but may be useful for security.</span>
                                <span class="comment">//</span>
                                <span class="comment">// Sheesh!</span>

                                <a class="code" href="class_o_t_string.html">OTString</a> strProcessInboxItem;
                                pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strProcessInboxItem);

                                <a class="code" href="class_o_t_item.html">OTItem</a> * pProcessInboxItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strProcessInboxItem, SERVER_ID, pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theProcessInboxItemGuardian(pProcessInboxItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>

                                <span class="comment">// pProcessInboxItem is already a copy of the correct processInbox item that I need. But still, it&#39;s a copy that the SERVER</span>
                                <span class="comment">// sent me. So I&#39;m going to use it to get the reference number that I need, in order to look up MY copy of the item.</span>
                                <span class="comment">// So pItem is my original request, inside a processInbox transaction, to accept some receipt from my inbox.</span>
                                <span class="comment">// </span>
                                <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = 
                                    (pProcessInboxItem != NULL) ? pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">GetItemInRefTo</a>(pProcessInboxItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()) : NULL;

                                <span class="keywordflow">if</span> (NULL == pItem)
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to find original item in original processInbox transaction request, based on reply item.\n&quot;</span>);
                                    <span class="keywordflow">continue</span>;
                                }

                                <span class="comment">// If this happens, it means the item we found in our original process inbox transaction, which matched the</span>
                                <span class="comment">// &quot;in reference to&quot; number that we expected from the copy of that original item we loaded from within the </span>
                                <span class="comment">// pReplyItem that&#39;s supposedly responding to it, does not have the same TYPE that we would have expected it to</span>
                                <span class="comment">// have, based on the intelligence in the above switch statement.</span>
                                <span class="comment">//</span>
                                <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != theItemType)
                                {   <span class="comment">// (Possible types for pItem: acceptItemReceipt, acceptPending, acceptCronReceipt, acceptFinalReceipt, acceptBasketReceipt.)</span>
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong original item TYPE, on reply item&#39;s copy of original item, &quot;</span>
                                        <span class="stringliteral">&quot;than what was expected based on reply item&#39;s type.\n&quot;</span>);
                                    <span class="keywordflow">continue</span>;
                                }

                                <span class="comment">// Todo here: any other verification of pItem against pProcessInboxItem, which are supposedly copies of the same item.</span>

                                <span class="comment">// FYI, pItem-&gt;GetReferenceToNum() is the ID of the receipt that&#39;s in the inbox.</span>
                                <span class="comment">//</span>
                                <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;

                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Checking client-side inbox for expected pending or receipt transaction: %lld... \n&quot;</span>,
                                    pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// temp remove</span>

                                <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                {
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>:       <span class="comment">// Server reply to my acceptance of pending transfer.</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>:   <span class="comment">// Server reply to my acceptance of chequeReceipt, voucherReceipt or transferReceipt.</span>

                                    pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                    <span class="keywordflow">break</span>;
                                    <span class="comment">// -----------------------</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
                                    pServerTransaction = theInbox.GetTransaction(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                    <span class="keywordflow">break</span>;

                                <span class="keywordflow">default</span>:
                                    {
                                        <span class="keyword">const</span> int32_t nReplyItemType = pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();

                                        <a class="code" href="class_o_t_string.html">OTString</a> strTheType;
                                        pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTheType);

                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;*** Unexpected reply item type (%d) in @processInbox, while processing server reply: %s\n&quot;</span>,
                                            nReplyItemType, strTheType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                        <span class="keywordflow">break</span>; <span class="comment">// will return just below, where it checks pServerTransaction for NULL.</span>
                                    }
                                }

                                <span class="keywordflow">if</span> (NULL == pServerTransaction)
                                {
                                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to find the server&#39;s receipt, in my inbox, that &quot;</span>
                                        <span class="stringliteral">&quot;my original processInbox&#39;s item was referring to.\n&quot;</span>);
                                    <span class="keywordflow">break</span>;  <span class="comment">// We must&#39;ve processed this already, and it came through again cause a copy was in a nymbox notice.</span>
                                }

                                <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <span class="keywordtype">bool</span> bAddToRecordBox = <span class="keyword">true</span>;

                                <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())  <span class="comment">// All of these need to remove something from the client-side inbox. (Which happens below this switch.)</span>
                                {                               <span class="comment">// Some also need to remove an issued transaction number from pNym.</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>: 

                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// ---------------------------------------------------------------</span>
                                    <span class="comment">// In the case of item receipt (not cron receipt or pending) I need to</span>
                                    <span class="comment">// remove the issued num from my list of responsibility. (Since I finally</span>
                                    <span class="comment">// accepted the receipt and closed it out.)</span>
                                    <span class="comment">//</span>
                                    <span class="comment">// (Basically closing out the original transfer I must have sent, or cheque I must have written.)</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>: <span class="comment">// &lt;==================================================</span>
                                    {
                                        <span class="comment">// What number do I remove here? the user is accepting a transfer receipt, which</span>
                                        <span class="comment">// is in reference to the recipient&#39;s acceptPending. THAT item is in reference to</span>
                                        <span class="comment">// my original transfer (or contains a cheque with my original number.) (THAT&#39;s the # I need.)</span>
                                        <span class="comment">//</span>
                                        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
                                        pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);

                                        <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strOriginalItem, SERVER_ID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theOrigItemGuardian(pOriginalItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>

                                        <span class="keywordflow">if</span> (NULL != pOriginalItem)
                                        {
                                            <span class="comment">// If pOriginalItem is acceptPending, that means I am accepting the transfer receipt from the server, (from my inbox),</span>
                                            <span class="comment">// which has the recipient&#39;s acceptance inside of my transfer as the original item. This means the transfer that</span>
                                            <span class="comment">// I originally sent is now finally closed!</span>
                                            <span class="comment">// </span>
                                            <span class="comment">// If it&#39;s a depositCheque, that means I am accepting the cheque receipt from the server, (from my inbox)</span>
                                            <span class="comment">// which has the recipient&#39;s deposit inside of it as the original item. This means that the cheque that</span>
                                            <span class="comment">// I originally wrote is now finally closed!</span>
                                            <span class="comment">//</span>
                                            <span class="comment">// In both cases, the &quot;original item&quot; itself is not from me, but from the recipient! Therefore,</span>
                                            <span class="comment">// the number on that item is useless for removing numbers from my list of issued numbers.</span>
                                            <span class="comment">// Rather, I need to load that original cheque, or pending transfer, from WITHIN the original item,</span>
                                            <span class="comment">// in order to get THAT number, to remove it from my issued list. </span>
                                            <span class="comment">//                      </span>
                                            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// I am accepting a CHEQUE RECEIPT, which has a depositCheque request (from the recipient) as the original item within.</span>
                                            {
                                                <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
                                                <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
                                                pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);

                                                <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>

                                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp; 
                                                    theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
                                                {
                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque from string in OTClient::ProcessServerReply:\n%s\n&quot;</span>,
                                                        strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                                }
                                                <span class="keywordflow">else</span>    <span class="comment">// Since I wrote the cheque, and I am now accepting the cheque receipt, I can now be cleared</span>
                                                    <span class="comment">// for that issued number. (Because the server reply said SUCCESS accepting the chequeReceipt/voucherReceipt.)</span>
                                                {       
                                                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
                                                    <span class="comment">// ----------------------------------------------------------------------------</span>
                                                    <span class="comment">/* Inside OT, when processing successful server reply to processInbox request, if a chequeReceipt</span>
<span class="comment">                                                    was processed out successfully (here: YES), and if that cheque is found inside the outpayments,</span>
<span class="comment">                                                    then move it at that time to the record box. */</span>

                                                    int32_t lOutpaymentsIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());

                                                    <span class="keywordflow">if</span> (lOutpaymentsIndex &gt; (-1)) <span class="comment">// found something that matches...</span>
                                                    {
                                                        <span class="comment">// Remove it from Outpayments box. We&#39;re done with it -- we accepted the chequeReceipt now.</span>
                                                        <span class="comment">// (Dump it in records for your app, but OT itself is done with it.)</span>
                                                        <span class="comment">//</span>
                                                        <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(lOutpaymentsIndex))
                                                        {
                                                            <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym)) <span class="comment">// &lt;== save Nym to local storage, since an outpayment was erased.</span>
                                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving Nym: %s\n&quot;</span>, __FUNCTION__, strNymID.Get());
                                                        }
                                                        <span class="comment">// -------------------------------------------------------</span>
                                                    }
                                                    <span class="comment">// --------------------------------------------------------</span>
                                                }
                                            }
                                            <span class="comment">//--------------</span>
                                            <span class="comment">// I am accepting a TRANSFER RECEIPT, which has an acceptPending inside FROM THE RECIPIENT,</span>
                                            <span class="comment">// as the original item within, (which is in reference to my outoing original transfer.)</span>
                                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                                            {
                                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
                                            }
                                            <span class="keywordflow">else</span> 
                                            {
                                                <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItemType;
                                                pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strOriginalItemType);
                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Original item has wrong type, while accepting item receipt:\n%s\n&quot;</span>,
                                                    strOriginalItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                            }
                                        }
                                        <span class="keywordflow">else</span> 
                                        {
                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Unable to load original item from string while accepting item receipt:\n%s\n&quot;</span>,
                                                strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                        }
                                    } <span class="comment">// OTItem::atAcceptItemReceipt.</span>

                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// -------------------------------------------------------------------------------------</span>

                                    <span class="comment">// Cron Receipt: We do not remove the original trans# until the Cron job is entirely </span>
                                    <span class="comment">// complete. (Many Cron receipts may breeze through here before that happens.)</span>
                                    <span class="comment">//</span>
                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:  
                                    {
                                        <span class="comment">// ------------------------------------------------------------------------------------</span>
                                        <span class="comment">// If it&#39;s a CRON receipt, find out if it&#39;s from a MARKET TRADE, and if so,</span>
                                        <span class="comment">// add it to my local list of Market Trades, for the GUI to use on the market panel.</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// Todo security: add the actual sale price to boths receipts, along with both amounts,</span>
                                        <span class="comment">// in order to verify the amount moved is in keeping with the terms of the original offer.</span>
                                        <span class="comment">//</span>
                                        <a class="code" href="class_o_t_item.html">OTItem</a> * pServerItem = pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>); <span class="comment">// paymentPlan and smartContract are also POSSIBLE here.</span>

                                        <span class="keywordflow">if</span> (NULL != pServerItem)
                                        {
                                            <a class="code" href="class_o_t_string.html">OTString</a> strOffer, strTrade;
                                            pServerItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strOffer);   <span class="comment">// contains updated offer.</span>
                                            pServerItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strTrade);         <span class="comment">// contains updated trade.</span>

                                            <a class="code" href="class_o_t_offer.html">OTOffer</a> theOffer;
                                            <a class="code" href="class_o_t_trade.html">OTTrade</a> theTrade;

                                            <span class="keywordtype">bool</span> bLoadOfferFromString = theOffer.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOffer);
                                            <span class="keywordtype">bool</span> bLoadTradeFromString = theTrade.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTrade);
                                            <span class="comment">// --------------------------------------------------</span>
                                            <span class="keywordflow">if</span> (bLoadOfferFromString &amp;&amp; bLoadTradeFromString)
                                            {
                                                <a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> * pData = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a10229b66b8d123dc3eda6370c1ddb022">OTDB::STORED_OBJ_TRADE_DATA_NYM</a>));
                                                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pData);
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeDataNym&gt;</a> theDataAngel(*pData);

                                                <span class="comment">/*</span>
<span class="comment">                                                std::stringstream ss;</span>
<span class="comment">                                                ss &lt;&lt; theTrade.GetTransactionNum();</span>
<span class="comment">                                                pData-&gt;transaction_id = ss.str(); ss.str(&quot;&quot;); */</span>
                                                <span class="comment">// --------------------------------------------------</span>
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#af0dff6aa9d349d3c1db793371479f5b0">transaction_id</a>  = to_string&lt;int64_t&gt;(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());     <span class="comment">// TransID for original offer. (Offer may trade many times.)</span>
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>      = to_string&lt;int64_t&gt;(pServerItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// TransID for BOTH receipts for current trade. (Asset/Currency.)</span>
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a4b63388a4e4a5b41301e179b6e7b2959">completed_count</a> = to_string&lt;int32_t&gt;(theTrade.<a class="code" href="class_o_t_trade.html#a632e944d79fe44e9cd503a41674b58fd">GetCompletedCount</a>());
                                                <span class="comment">// --------------------------------------------------</span>
                                                <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(ACCOUNT_ID, SERVER_ID);
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
                                                
                                                <span class="keywordtype">bool</span> bIsAsset    = (theTrade.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()    == pAccount-&gt;GetAssetTypeID());
                                                <span class="keywordtype">bool</span> bIsCurrency = (theTrade.<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>() == pAccount-&gt;GetAssetTypeID());
                                                
                                                <span class="keywordflow">if</span> (bIsAsset)
                                                {
<span class="comment">//                                                  pServerItem-&gt;GetAmount() contains:  (lAmountSold); // asset</span>
                                                    
                                                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(theTrade.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>());
                                                    int64_t lAssetsThisTrade = pServerItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
                                                    pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>       = strAssetID.Get();
                                                    pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>    = to_string&lt;int64_t&gt;(lAssetsThisTrade); <span class="comment">// The amount of ASSETS moved, this trade.</span>
                                                }
                                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bIsCurrency)
                                                {
<span class="comment">//                                                  pServerItem-&gt;GetAmount() contains:  (lTotalPaidOut); // currency</span>
                                                    
                                                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyID(theTrade.<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>());
                                                    int64_t lCurrencyThisTrade = pServerItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
                                                    pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>      = strCurrencyID.Get();
                                                    pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>    = to_string&lt;int64_t&gt;(lCurrencyThisTrade);
                                                }
                                                <span class="comment">// --------------------------------------------------</span>
                                                <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> &amp; tProcessDate = theTrade.<a class="code" href="class_o_t_cron_item.html#ad8f19edf794a54644ed4822d0bc120a4">GetLastProcessDate</a>();
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ab8aac05fb4457db454bb285419b46484">date</a> = to_string&lt;time64_t&gt;(tProcessDate);
                                                <span class="comment">// --------------------------------------------------</span>
                                                <span class="comment">// The original offer price. (Might be 0, if it&#39;s a market order.)</span>
                                                <span class="comment">//</span>
                                                <span class="keyword">const</span> int64_t &amp; lPriceLimit = theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a4e628be7c68588a5100f7da1f9db40c5">offer_price</a> = to_string&lt;int64_t&gt;(lPriceLimit);
                                                <span class="comment">// --------------------------------------------------</span>
                                                <span class="keyword">const</span> int64_t &amp; lFinishedSoFar = theOffer.<a class="code" href="class_o_t_offer.html#ab3b709080aa7c81dcd268fd78eaef262">GetFinishedSoFar</a>();
                                                pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a422a8af72d297339f7dab0c54c165616">finished_so_far</a> = to_string&lt;int64_t&gt;(lFinishedSoFar);
                                                <span class="comment">// --------------------------------------------------</span>
                                                <span class="comment">// save to local storage...</span>
                                                <span class="comment">//</span>
                                                <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);

                                                <a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a> * pList = NULL;

                                                <span class="keywordflow">if</span> (<a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
                                                    <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
                                                    strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                                                    strUserID.Get()))
                                                    pList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#aaf0caee055f843a828e3bac094321886">OTDB::QueryObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2172f96c85edc950ecd14d6c51c71c57">OTDB::STORED_OBJ_TRADE_LIST_NYM</a>, 
                                                    <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
                                                    <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
                                                    strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                                                    strUserID.Get()));
                                                <span class="keywordflow">if</span> (NULL == pList)
                                                {
                                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;Creating storage list of trade receipts for Nym: %s\n&quot;</span>, strUserID.Get());
                                                    pList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a>*<span class="keyword">&gt;</span>
                                                        (<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2172f96c85edc950ecd14d6c51c71c57">OTDB::STORED_OBJ_TRADE_LIST_NYM</a>));
                                                }
                                                <span class="comment">// -----------------------------------------------------</span>
                                                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pList);
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeListNym&gt;</a> theListAngel(*pList);
                                                <span class="comment">// -----------------------------------------------------</span>
                                                <span class="comment">// Loop through and see if we can find one that&#39;s ALREADY there.</span>
                                                <span class="comment">// We can match the asset receipt and currency receipt.</span>
                                                <span class="comment">// This way we insure there is only one in the end, which combines info from both.</span>
                                                <span class="comment">// This also enables us to calculate the sale price!</span>
                                                <span class="comment">//</span>
                                                <span class="keywordtype">bool</span> bWeFoundIt = <span class="keyword">false</span>;
                                                
                                                <span class="keywordtype">size_t</span> nTradeDataNymCount = pList-&gt;GetTradeDataNymCount();
                                                
                                                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> nym_count = 0; nym_count &lt; nTradeDataNymCount; ++nym_count)
                                                {
                                                    <a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> * pTradeData = pList-&gt;GetTradeDataNym(nym_count);
                                                    
                                                    <span class="keywordflow">if</span> (NULL == pTradeData) <span class="comment">// Should never happen.</span>
                                                        <span class="keywordflow">continue</span>;
                                                    <span class="comment">// -----------------------------------------------------------------------</span>
                                                    <span class="keywordflow">if</span> (0 == pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>.compare(pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>)) <span class="comment">// Found it!</span>
                                                    {
                                                        <span class="comment">// It&#39;s a repeat of the same one. (Discard.)</span>
                                                        <span class="keywordflow">if</span> ((!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>   .empty() &amp;&amp; !pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>   .empty()) ||
                                                            (!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty() &amp;&amp; !pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty()))
                                                            <span class="keywordflow">break</span>;
                                                        <span class="comment">// --------------------------------------------------</span>
                                                        <span class="comment">// Okay looks like one is the asset receipt, and the other is the currency receipt.</span>
                                                        <span class="comment">// Therefore let&#39;s combine them into pTradeData!</span>
                                                        <span class="comment">//</span>
                                                        <span class="keywordflow">if</span> (pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>.empty())
                                                        {
                                                            pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>    = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>;
                                                            pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a> = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>;
                                                        }
                                                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty())
                                                        {
                                                            pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>   = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>;
                                                            pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a> = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>;
                                                        }
                                                        <span class="comment">// --------------------------------------------------</span>
                                                        <span class="keywordflow">if</span> (!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>.empty() &amp;&amp; !pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>.empty())
                                                        {
                                                            <span class="keyword">const</span> int64_t lAmountSold   = <a class="code" href="class_o_t_string.html#a3f2489a8c996db1df14479d36af3b76b">OTString::StringToLong</a>(pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>);
                                                            <span class="keyword">const</span> int64_t lCurrencyPaid = <a class="code" href="class_o_t_string.html#a3f2489a8c996db1df14479d36af3b76b">OTString::StringToLong</a>(pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>);
                                                            
                                                            <span class="keywordflow">if</span> (lAmountSold != 0) <span class="comment">// just in case (divide by 0.)</span>
                                                            {
                                                                <span class="keyword">const</span> int64_t lSalePrice = (lCurrencyPaid / lAmountSold);
                                                                
                                                                <a class="code" href="class_o_t_string.html">OTString</a> strSalePrice;
                                                                strSalePrice.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;&quot;</span>, lSalePrice);
                                                                
                                                                pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a7be3a27c6e1a914dbc8bd8cbde4e7e5c">price</a> = strSalePrice.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
                                                            }
                                                        }
                                                        <span class="comment">// ------------------------</span>
                                                        
                                                        bWeFoundIt = <span class="keyword">true</span>;
                                                        
                                                        <span class="keywordflow">break</span>;
                                                        
                                                    } <span class="comment">// if we found it.</span>
                                                } <span class="comment">// for</span>
                                                <span class="comment">// -----------------------------------------------------</span>
                                                <span class="keywordflow">if</span> (!bWeFoundIt) <span class="comment">// We didn&#39;t find it. So let&#39;s add it.</span>
                                                {
                                                    pList-&gt;AddTradeDataNym(*pData);
                                                }
                                                <span class="comment">// -----------------------------------------------------</span>
                                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a394420b02f48d3ebdfebb75d92a4d6dd">OTDB::StoreObject</a>(*pList,
                                                    <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
                                                    <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
                                                    strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                                                    strUserID.Get()))
                                                    <span class="comment">// ----------------</span>
                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: Failed storing list of trades for Nym. Server ID: %s Nym ID: %s \n&quot;</span>,
                                                                  __FUNCTION__, strServerID.Get(), strUserID.Get());
                                                <span class="comment">// -----------------------------------------------------</span>
                                            }
                                        }
                                        <span class="comment">//else</span>
                                        <span class="comment">//    OTLog::Error(&quot;OTClient::ProcessServerReply: &quot;</span>
                                        <span class="comment">//                 &quot;Expected marketReceipt item in transaction in inbox.&quot;);</span>
                                    } <span class="comment">// OTItem::atAcceptCronReceipt</span>

                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
                                    {
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Successfully removed finalReceipt with closing num: %lld\n&quot;</span>, 
                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
                                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>

                                        <span class="comment">// -----------------</span>
                                        <span class="comment">// This should have already been done by this point, but I&#39;m putting it here just in case,</span>
                                        <span class="comment">// while debugging:</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                        <span class="keywordflow">else</span>
                                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                        <span class="comment">// ----------------------------------------------</span>
                                        <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
                                        <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
                                        <span class="comment">// market offers in that list, since we already have a list of active</span>
                                        <span class="comment">// market offers separately. And market offers produce final receipts,</span>
                                        <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
                                        <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
                                        <span class="comment">// It is for the others.</span>
                                        <span class="comment">//</span>
                                        <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                                                           pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                                                           pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
                                    } <span class="comment">// OTItem::atAcceptFinalReceipt</span>

                                    <span class="keywordflow">break</span>;


                                    <span class="comment">// ------------------------------------------------------------------------------------</span>

                                <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
                                    {
                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Successfully removed basketReceipt with closing num: %lld\n&quot;</span>, 
                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
                                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true    </span>
                                    } <span class="comment">// OTItem::atAcceptBasketReceipt</span>

                                    <span class="keywordflow">break</span>;

                                    <span class="comment">// ---------------------------------------------------------------</span>

                                <span class="keywordflow">default</span>: <span class="comment">// Error</span>
                                    {
                                        bAddToRecordBox = <span class="keyword">false</span>;
                                        <span class="comment">// -----------------------</span>
                                        pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: wrong reply item transaction type: %s\n&quot;</span>,
                                            strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    }
                                    <span class="keywordflow">break</span>;
                                }   <span class="comment">// switch replyItem type</span>
                                <span class="comment">// ---------------------------------------------------------------------------</span>
                                <span class="keywordflow">if</span> (bAddToRecordBox)
                                {
                                    <span class="keywordflow">if</span> (!bLoadedRecordBox) <span class="comment">// We haven&#39;t loaded / created it yet.</span>
                                    {
                                        bLoadedRecordBox = (bRecordBoxExists &amp;&amp; theRecordBox.LoadRecordBox());
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="keywordflow">if</span> (bRecordBoxExists &amp;&amp; bLoadedRecordBox)
                                            bLoadedRecordBox  = (theRecordBox.VerifyContractID() &amp;&amp;
                                            theRecordBox.VerifySignature(*pNym));
                                        <span class="comment">//                                          bLoadedRecordBox  = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
                                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bLoadedRecordBox)
                                            bLoadedRecordBox  = theRecordBox.GenerateLedger(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                        <span class="comment">// -----------------------------------------------------</span>
                                        <span class="comment">// by this point, the box DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
                                        <span class="comment">//</span>
                                        <span class="keywordflow">if</span> (!bLoadedRecordBox)
                                        {
                                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server reply to processInbox: &quot;</span>
                                                <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate recordBox, with IDs: %s / %s\n&quot;</span>,
                                                __FUNCTION__, strNymID.Get(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                        }
                                    }
                                    <span class="comment">// ------------------------------------------------------</span>
                                    <span class="keywordflow">if</span> (bLoadedRecordBox)
                                    {
                                        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerTransaction(*pServerTransaction);
                                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a>     * pNewTransaction = NULL;
                                        <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strServerTransaction);
                                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType);

                                        <span class="keywordflow">if</span> (NULL != pTransType)
                                        {
                                            pNewTransaction = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);
                                        }
                                        <span class="comment">// ------------------------------------------------</span>
                                        <span class="keywordflow">if</span> (NULL != pNewTransaction)
                                        {
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.AddTransaction(*pNewTransaction);

                                            <span class="keywordflow">if</span> (!bAdded)
                                            {
                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (still removing &quot;</span>
                                                    <span class="stringliteral">&quot;it from asset account inbox, however.)\n&quot;</span>, __FUNCTION__,
                                                    pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                                            }
                                            <span class="keywordflow">else</span> <span class="comment">// Success adding it to the record box (let&#39;s save it.)</span>
                                            {
                                                theTransTypeAngel.SetCleanupTargetPointer(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>

                                                theRecordBox.ReleaseSignatures();
                                                theRecordBox.SignContract(*pNym);
                                                theRecordBox.SaveContract();
                                                <span class="comment">// -------------------------------</span>
                                                theRecordBox.SaveRecordBox(); <span class="comment">// todo log failure.</span>

                                                <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                                                <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                                                <span class="comment">//</span>
                                                <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                                                <span class="comment">// whenever a receipt is added to a box (here), and deleted after a receipt</span>
                                                <span class="comment">// is removed from a box.</span>
                                                <span class="comment">//</span>
                                                <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
                                                    __FUNCTION__, strServerTransaction.Get());
                                            }
                                        } <span class="comment">// if (NULL != pNewTransaction)</span>
                                        <span class="comment">// -----------------------------------------------------</span>
                                    } <span class="comment">// if (bLoadedRecordBox)</span>
                                } <span class="comment">// if (bAddToRecordBox)</span>
                                <span class="comment">// ---------------------------------------------------------------------------</span>
                                <span class="comment">// REMOVE IT FROM THE INBOX.</span>
                                <span class="comment">//</span>
                                <span class="comment">// This removal happens for ALL of the above cases.</span>
                                <span class="comment">// Update: Now when removing receipts from any box, we have to</span>
                                <span class="comment">// also delete the box receipt, which is stored as a separate file.</span>
                                <span class="comment">//</span>
                                pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster</span>
                                <span class="comment">//                              theInbox.DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                                theInbox.RemoveTransaction(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                            } <span class="comment">// for loop (reply items)</span>
                            <span class="comment">// ---------------------------------------</span>
                            <span class="comment">// Save the Inbox</span>
                            <span class="comment">//</span>
                            theInbox.ReleaseSignatures();
                            theInbox.SignContract(*pNym);
                            theInbox.SaveContract();
                            theInbox.SaveInbox();                                            
                            <span class="comment">// ---------------------------------------</span>
                        } <span class="comment">// if pReplyTransaction</span>
                    } <span class="comment">// if pTransaction                    </span>
                }
                <span class="comment">// *********************************************************************************</span>
                <span class="comment">//</span>
                <span class="keywordflow">else</span>  <span class="comment">// @processNymbox.  // We&#39;re processing the SERVER&#39;s REPLY to our processNymbox request.</span>
                {
                    pTransaction        = theLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac0914e62639aebd987882e21bdff890d">OTTransaction::processNymbox</a>);
                    pReplyTransaction   = theReplyLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">OTTransaction::atProcessNymbox</a>);

                    <span class="comment">// If I have already processed this reply, </span>

                    <span class="comment">// We did NOT have to burn a transaction number to process the Nymbox, so we don&#39;t</span>
                    <span class="comment">// have to remove it from the list of responsibility, like we do above.</span>
                    <span class="comment">// The reason is because the Nymbox cannot be used for financial transactions, since</span>
                    <span class="comment">// it is associated with a user acct (instead of asset account.)</span>
                    <span class="comment">// THIS IS ACTUALLY the WHOLE POINT of the Nymbox: If it required a transaction number</span>
                    <span class="comment">// to process the Nymbox, and you use the Nymbox to get transaction numbers, then how</span>
                    <span class="comment">// can you ever get a new number if you run out?  You need a number to get a number?</span>
                    <span class="comment">//</span>
                    <span class="comment">// That makes no logical sense.  Therefore, the Nymbox provides a way to get new transaction</span>
                    <span class="comment">// numbers WITHOUT HAVING TO BURN ONE TO DO IT.  You still have to do a transaction statement</span>
                    <span class="comment">// to do it (sign off on the ones that you actually do have), but you can still process</span>
                    <span class="comment">// the Nymbox even if you have zero transaction numbers, whereas with the inbox for an asset</span>
                    <span class="comment">// account, you cannot process it until you burn a transaction number to do so. And if you</span>
                    <span class="comment">// don&#39;t have any transaction numbers to do that with, that&#39;s fine: you just get a new one</span>
                    <span class="comment">// via your nymbox.  This is the original reason that I added nymboxes in the first place.</span>
                    <span class="comment">//</span>
                    <span class="comment">// SIMILARLY, when a transaction number is REMOVED from our list via the Nymbox, it&#39;s only</span>
                    <span class="comment">// a NOTIFICATION. The Nymbox cannot actually REMOVE your transaction numbers, but it CAN</span>
                    <span class="comment">// be used to drop a notice informing you that one was removed. (Usually by a recurring </span>
                    <span class="comment">// transaction, such as a market offer, where you had already provided the closing number in</span>
                    <span class="comment">// advance, and you expected that it could be closed at anytime.)</span>
                    <span class="comment">//</span>
                    <span class="comment">// ------------------------------------------------------------------</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">if</span> ((NULL != pTransaction) &amp;&amp; (NULL != pReplyTransaction))
                    {
                        <span class="comment">// HARVEST TRANSACTION NUMBERS (Nymbox only)</span>
                        <span class="comment">//</span>
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);

                        <span class="comment">// We found it!</span>
                        <span class="keywordflow">if</span> (NULL == pStatementItem)
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found transaction in ledger in %s, but didn&#39;t find a transactionStatement item within.\n&quot;</span>,
                                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        }                           
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Found the receipt you&#39;re talking about, in ledger in %s, but the Server&#39;s Reply transaction says FAILED.\n&quot;</span>,
                                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_string.html">OTString</a>    strMessageNym;
                            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theMessageNym;

                            pStatementItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strMessageNym);

                            <span class="keywordflow">if</span> (strMessageNym.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theMessageNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strMessageNym))
                            {
                                <span class="comment">// Success!</span>
                                <span class="comment">// Whatever Trans#&#39;s I accepted when I processed my nymbox, I now</span>
                                <span class="comment">// harvest them onto my Nym for use. (Couldn&#39;t be sure until server replied &quot;success&quot;.)</span>
                                <span class="comment">//</span>
                                <span class="comment">// Contrast this with the numbers removed. In the case of Nymbox, I cannot</span>
                                <span class="comment">// remove numbers, only receive notice that a number was already removed.</span>
                                <span class="comment">// Therefore, I might as well remove it on my side also, as soon as I see that</span>
                                <span class="comment">// notice (and approve of it.) There&#39;s no need juggling it in that case -- it&#39;s </span>
                                <span class="comment">// already gone. (Therefore it&#39;s already been done by the time we&#39;re in this</span>
                                <span class="comment">// function reading the server&#39;s reply. Removals for Nymbox happen in Finalize for</span>
                                <span class="comment">// processNymbox, and in AcceptEntireNymbox.)</span>
                                <span class="comment">// Below however, are additions, not removals, so we don&#39;t add them until the</span>
                                <span class="comment">// server has DEFINITELY responded in the affirmative (here):</span>
                                <span class="comment">//</span>
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac140c0c6ab67bb633b0826ad7914761f">HarvestTransactionNumbers</a>(pStatementItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
                                    *pNym, theMessageNym, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                                <span class="comment">// New version now takes tentative numbers into account, to reduce sync issues.</span>
                                <span class="comment">//                              pNym-&gt;HarvestIssuedNumbers(pStatementItem-&gt;GetPurportedServerID(), </span>
                                <span class="comment">//                                                           *pNym, theMessageNym, true); // bSave=true</span>
                            }
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found transaction item in ledger in %s, but didn&#39;t find theMessageNym within.\n&quot;</span>,
                                    theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            }
                        }

                        <span class="comment">// *******************************************************************************</span>
                        <span class="comment">//</span>
                        <span class="comment">// REMOVE VARIOUS ITEMS FROM THE LOCAL NYMBOX (THEIR TIME IS DONE.)</span>

                        <span class="comment">// Load the Nymbox.             </span>
                        <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theNymbox(USER_ID, USER_ID, SERVER_ID);
                        <span class="keywordtype">bool</span>        bLoadedNymbox = <span class="keyword">false</span>;
                        <span class="comment">// ---------------------------------------------------</span>
                        <span class="keywordflow">if</span> (NULL != pNymbox) <span class="comment">// If a pointer was passed in, then we&#39;ll just use it.</span>
                        {
                            bLoadedNymbox = <span class="keyword">true</span>;
                        }
                        <span class="keywordflow">else</span> <span class="comment">// Otherwise, we have to load it ourselves. (And point the pointer to it.)</span>
                        {
                            pNymbox = &amp;theNymbox;
                            bLoadedNymbox = (pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>() &amp;&amp; pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym));
                        }
                        <span class="comment">// ---------------------------------------------------</span>
                        <span class="comment">// I JUST had this loaded if I sent acceptWhatever just instants ago, (which I am now processing the reply for.)</span>
                        <span class="comment">// Therefore I&#39;m just ASSUMING here that it loads successfully here, since it worked an instant ago. Todo.</span>
                        <span class="comment">//</span>
                        <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bLoadedNymbox, <span class="stringliteral">&quot;Was trying to load Nymbox.&quot;</span>);
                        <span class="comment">// ---------------------------------------------------</span>
                        <span class="comment">// Next, loop through the reply items for each &quot;process nymbox&quot; item that I must have previously sent.</span>
                        <span class="comment">// For each, if successful, remove from inbox.</span>
                        <span class="comment">// For item receipts, if successful, also remove the appropriate trans# </span>
                        <span class="comment">// from my issued list of transaction numbers (like above.)</span>
                        <span class="comment">//</span>
                        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
                        {
                            <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it;
                            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pReplyItem, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Pointer should not have been NULL.&quot;</span>);

                            <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;

                            <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
                            {       
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:  <span class="comment">// for inbox this is a closing issued number being removed from your list.</span>
                                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>;<span class="comment">// but for Nymbox, this is only a notification that it already happened previously.</span>
                                <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>;     <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:      theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>;      <span class="keywordflow">break</span>;
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>: theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>; <span class="keywordflow">break</span>;
                                <span class="comment">// ---------------------------------------------------</span>
                                <span class="comment">// FYI, on server side, it does not bother to process an item,</span>
                                <span class="comment">// if the balance statement or transaction statement has not succeeded.</span>
                                <span class="comment">//</span>
                                <span class="comment">// Thus, if the ITEM ITSELF has succeeded, that means the balance or</span>
                                <span class="comment">// transaction statement MUST have succeeded! Because server wouldn&#39;t have</span>
                                <span class="comment">// even bothered to process the item otherwise.</span>
                                <span class="comment">//</span>
                                <span class="comment">// There still might be some future application in doing something with these</span>
                                <span class="comment">// statements when they come in.</span>
                                <span class="comment">// -----------------------------------------------------</span>
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>:
                                theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>; <span class="comment">// We just continue; when this happens, and skip this one.</span>
                                <span class="keywordflow">continue</span>; <span class="comment">// (The transaction statement itself is already handled before this &quot;for&quot; loop.)</span>

                            <span class="keywordflow">default</span>:
                                {
                                    <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
                                    pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected replyItem:type while processing Nymbox: %s \n&quot;</span>,
                                        __FUNCTION__, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    <span class="keywordflow">continue</span>;
                                }
                            } <span class="comment">// SWITCH</span>
                            <span class="comment">// ------------------------------------------------------------------------------------</span>
                            <span class="comment">// The below actions are only necessary if pReplyItem was a SUCCESS.</span>
                            <span class="comment">// (Otherwise we skip them...)</span>
                            <span class="comment">//</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
                            pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);

                            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processNymbox reply item %s: status == FAILED\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                <span class="keywordflow">continue</span>;
                            }
                            <span class="comment">// else</span>
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processNymbox reply item %s: status == SUCCESS\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());                            
                            <span class="comment">// ------------------------------------------------------------------------------------    </span>
                            <span class="comment">//</span>
                            <span class="comment">// pReplyItem-&gt;GetReferenceToNum() contains the process transaction# of pItem (0, in</span>
                            <span class="comment">// a transaction statement, since it usually has no transaction number of its own), not</span>
                            <span class="comment">// the inbox receipt # that pItem is in reference to.</span>
                            <span class="comment">//</span>
                            <span class="comment">// pTransaction is the processNymbox transaction request that I sent.</span>
                            <span class="comment">// (The items within it all share its same transaction number, but they are IN REFERENCE TO</span>
                            <span class="comment">//  the Nymbox receipts that they accept/reject.)</span>
                            <span class="comment">// pReplyTransaction is the server&#39;s reply to that.</span>
                            <span class="comment">// pReplyItem is the current item when iterating through pReplyTransaction.</span>
                            <span class="comment">// pItem is the corresponding REQUEST item from pTransaction, that pReplyItem is responding to.</span>
                            <span class="comment">//</span>
                            <span class="comment">// Therefore: I need to load the original item from pReplyItem&#39;s reference string (it&#39;s bundled in there).</span>
                            <span class="comment">// THEN I will get the &quot;in reference to&quot; number from THAT (which is the nymbox Receipt #).</span>
                            <span class="comment">// THEN I will use that number to look up the SAME original item from pTransaction.</span>
                            <span class="comment">// The last step isn&#39;t technically necessary, but may be useful for security.</span>
                            <span class="comment">//</span>
                            <span class="comment">// Sheesh!</span>

                            <a class="code" href="class_o_t_string.html">OTString</a> strProcessNymboxItem;
                            pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strProcessNymboxItem);

                            <a class="code" href="class_o_t_item.html">OTItem</a> * pProcessNymboxItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strProcessNymboxItem, 
                                SERVER_ID, 
                                0 <span class="comment">/* 0 is the &quot;transaction number&quot;*/</span>); <span class="comment">// todo stop hardcoding.</span>

                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theProcessNymboxItemGuardian(pProcessNymboxItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>

                            <span class="comment">// pProcessNymboxItem is already a copy of the correct processNymbox item that I need. </span>
                            <span class="comment">// But still, it&#39;s a copy that the SERVER sent me. So I&#39;m going to use it to get the</span>
                            <span class="comment">// reference number that I need, in order to look up MY copy of the item.</span>
                            <span class="comment">// </span>
                            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = 
                                (pProcessNymboxItem != NULL) ? pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">GetItemInRefTo</a>(pProcessNymboxItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()) : NULL;

                            <span class="keywordflow">if</span> (NULL == pItem)
                            {
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find original item in original processNymbox &quot;</span>
                                    <span class="stringliteral">&quot;transaction request, based on reply item.\n&quot;</span>, __FUNCTION__);
                                <span class="keywordflow">continue</span>;
                            }
                            <span class="comment">// ---------------------------------------------------</span>
                            <span class="comment">// If this happens, it means the item we found in our original process Nymbox transaction, which matched the</span>
                            <span class="comment">// &quot;in reference to&quot; number that we expected from the copy of that original item we loaded from within the </span>
                            <span class="comment">// pReplyItem that&#39;s supposedly responding to it, does not have the same TYPE that we would have expected it to</span>
                            <span class="comment">// have, based on the intelligence in the above switch statement.</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != theItemType)
                            {   <span class="comment">// (Possible types for pItem: acceptMessage, acceptNotice, acceptTransactions, acceptFinalReceipt.)</span>
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong original item TYPE, on reply item&#39;s copy of original item, &quot;</span>
                                    <span class="stringliteral">&quot;than what was expected based on reply item&#39;s type.\n&quot;</span>, __FUNCTION__);
                                <span class="keywordflow">continue</span>;
                            }

                            <span class="comment">// Todo here: any other verification of pItem against pProcessNymboxItem, which are supposedly copies of the same item.</span>
                            <span class="comment">// (Potentially todo security.)</span>

                            <span class="comment">// FYI, pItem-&gt;GetReferenceToNum() is the ID of the receipt that&#39;s in the Nymbox.</span>
                            <span class="comment">//                                </span>
                            <span class="comment">// ------------------------------------------------------------------------------------</span>
                            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;

                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Checking client-side Nymbox for expected Nymbox item: %lld... \n&quot;</span>,
                                __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// temp remove</span>

                            <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
                            {
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>:
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
                                pServerTransaction = pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                <span class="keywordflow">break</span>;

                            <span class="keywordflow">default</span>:
                                {
                                    <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
                                    pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected replyItem::type while processing Nymbox: %s \n&quot;</span>, 
                                        __FUNCTION__, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    <span class="keywordflow">break</span>;
                                }
                            }
                            <span class="comment">// ---------------------------------------------------</span>
                            <span class="keywordflow">if</span> (NULL == pServerTransaction)
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: The original processNymbox item referred to trans number %lld, but that receipt wasn&#39;t in my Nymbox. &quot;</span>
                                    <span class="stringliteral">&quot;(We probably processed this server reply ALREADY, and now we&#39;re just seeing it again, since an extra copy &quot;</span>
                                    <span class="stringliteral">&quot;was dropped into the Nymbox originally. It happens. Skipping.)&quot;</span>, __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                <span class="keywordflow">break</span>; <span class="comment">// We must have processed this reply already, and it just came through again cause a copy was in a nymbox notice.</span>
                            }
                            <span class="comment">// ------------------------------------------------------------------------------------</span>
                            <span class="comment">// All of these need to remove something from the client-side Nymbox. (Which happens below this switch.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())  
                            {   <span class="comment">// Some also need to remove an issued transaction number from pNym.</span>

                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:

                                <span class="comment">// There are many different types of notices.</span>
                                <span class="comment">// We just indiscriminately accept them all from the Nymbox.</span>
                                <span class="comment">// The replyNotice tells you that a transaction was processed.</span>
                                <span class="comment">// (We put a copy of the server reply into your Nymbox, to make sure</span>
                                <span class="comment">// you get it, so you stay in sync with which transaction numbers are signed out.)</span>
                                <span class="comment">// The successNotice tells you that you successfully signed out new transaction numbers</span>
                                <span class="comment">// (to use on transactions.)</span>
                                <span class="comment">// The &quot;plain-ole&quot; OTTransaction::notice is used to notice the parties to a smart</span>
                                <span class="comment">// contract that it has activated (or failed to activate.)</span>

                                <span class="comment">// if pReplyItem is atAcceptNotice, then pItem is acceptNotice.</span>
                                <span class="comment">// Then pItem is accepting (IN REFERENCE TO) the original OTItem::notice that&#39;s</span>
                                <span class="comment">// sitting in the Nymbox!</span>

                                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                                {

                                    <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>       == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) || <span class="comment">// REJECTION</span>
                                        (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))   <span class="comment">// ACKNOWLEDGMENT</span>
                                    {
                                        <span class="comment">// NOTE: NORMALLY we do this sort of thing in the server reply to the actual</span>
                                        <span class="comment">// transaction request (by the activating party.)</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// For example, if you tried to activate a smart contract, and that failed, then</span>
                                        <span class="comment">// the atSmartContract server reply will be processed, and the opening issued# will</span>
                                        <span class="comment">// be removed at that time, and the closing numbers will be harvested. So then, why</span>
                                        <span class="comment">// this additional notice in my Nymbox? If that will already happen?</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// ===&gt; Because of ALL THE OTHER PARTIES to the smart contract! (This may be necessary</span>
                                        <span class="comment">// for payment plans, too.) The activating party got his reply (he even had a back-up</span>
                                        <span class="comment">// reply stuffed into his Nymbox to make SURE he got it.) But all the other parties will</span>
                                        <span class="comment">// only know, if they are sent a notice! Therefore a notice is sent by the server, to all</span>
                                        <span class="comment">// parties.</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// ===&gt; This also means that the ACTIVATING party himself will ALSO get this same notice!</span>
                                        <span class="comment">// But since we&#39;ve already established above that the activating party ALREADY processes</span>
                                        <span class="comment">// his activation reply, we don&#39;t want him to process it TWICE!</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// Therefore, we will process the notice like normal, UNLESS pNym is the activating Nym for</span>
                                        <span class="comment">// the smart contract, in which case we skip it, since we assume he already processed the</span>
                                        <span class="comment">// reply directly when he activated the smart contract.</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// You might ask, then why not just let the activating party, process this notice here the</span>
                                        <span class="comment">// same as all the other parties, and just NOT have him process it on the direct reply, as</span>
                                        <span class="comment">// he is now? The answer is, because he will stay in sync better if we just give him that</span>
                                        <span class="comment">// info as soon as he&#39;s able to receive it, which is preferably RIGHT when he performs the</span>
                                        <span class="comment">// activation. The other parties are not currently present, so they HAVE to be informed by</span>
                                        <span class="comment">// notices. But the ACTIVATING party might as well be informed instantly. Otherwise he will</span>
                                        <span class="comment">// just be out of sync until the next time he processes his Nymbox, which causes unnecessary</span>
                                        <span class="comment">// delays as it will result in unnecessary server messages to resync the situation.</span>
                                        <span class="comment">// </span>
                                        <span class="comment">// THEREFORE: We will skip this step if pNym is the activating Nym, since he&#39;s assumed to</span>
                                        <span class="comment">// have done this already. Otherwise, pNym is NOT the activating Nym, and he&#39;s one of the</span>
                                        <span class="comment">// other parties receiving this notice, and therefore he needs to process it accordingly</span>
                                        <span class="comment">// (He, in fact, processes it here IDENTICALLY as the activating Nym does when he receives</span>
                                        <span class="comment">// the reply to his transaction request: by removing the issued opening number, and by</span>
                                        <span class="comment">// harvesting the closing numbers.)</span>
                                        <span class="comment">// ----------------------------------------------------------</span>
                                        <span class="comment">// If it was a failure, harvest the extra transaction numbers that were used as</span>
                                        <span class="comment">// CLOSING numbers. They can go back on my Nym and be used another day! Remove</span>
                                        <span class="comment">// the opening number and harvest the closing ones, basically.</span>
                                        <span class="comment">//</span>

                                        <a class="code" href="class_o_t_string.html">OTString</a> strCronItem;
                                        pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strCronItem);

                                        <span class="comment">// What kind of cron item is it?</span>
                                        <span class="comment">// Well (todo) we should probably double-check, but the only cron items we</span>
                                        <span class="comment">// send notices for are payment plans and smart contracts. Market offers don&#39;t</span>
                                        <span class="comment">// need notices, since anyone activating a market offer is already getting the</span>
                                        <span class="comment">// reply. (AND getting a copy of that reply, already, inside a replyNotice in</span>
                                        <span class="comment">// his Nymbox...) So he can&#39;t possibly miss the server&#39;s reply, and there aren&#39;t</span>
                                        <span class="comment">// any other parties to notify (re: successful activation), besides the Nym himself.</span>
                                        <span class="comment">//</span>
                                        <span class="comment">// Only payment plans and smart contracts could potentially have some other signer, who</span>
                                        <span class="comment">// would want to get notified, and to whom the notice is send.</span>
                                        <span class="comment">//</span>
                                        <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = (strCronItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strCronItem) : NULL);
                                        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel(pCronItem);

                                        <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// the original smart contract or payment plan object.</span>
                                        {                                                
                                            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theCancelerNymID;
                                            <span class="keyword">const</span> int64_t   lNymOpeningNumber =  pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a8f59139b6000733ec3c1df6d1dbc7632">GetOpeningNumber</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>   bCancelling       = (pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>() &amp;&amp; pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#ac9031aa34854265423155e448be01120">GetCancelerID</a>(theCancelerNymID));
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>   bIsCancelerNym    = (bCancelling &amp;&amp; (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>() == theCancelerNymID));
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>   bIsActivatingNym  = (pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#acd198571145b47602c121a419723b39a">GetOpeningNum</a>() == lNymOpeningNumber); <span class="comment">// If the opening number for the cron item is the SAME as Nym&#39;s opening number, then Nym is the ACTIVATING NYM (Skip him, since he does this same stuff when he receives the actual server reply. The notices are for the OTHER parties)...</span>

                                            <span class="comment">// Canceler (if cancelling) or activator (if activating) are handled already elsewhere, when they receive</span>
                                            <span class="comment">// the server reply. A notice is also sent to all the parties (and we&#39;re processing that notice now) so here</span>
                                            <span class="comment">// we just need to handle everyone else but him.</span>
                                            <span class="comment">// </span>
                                            <span class="keywordflow">if</span> ( ( bCancelling &amp;&amp; !bIsCancelerNym) ||  <span class="comment">// If canceling, and Nym is not the canceler...</span>
                                                (!bCancelling &amp;&amp; !bIsActivatingNym)   <span class="comment">// or if activating, and Nym is not the activator...</span>
                                                )
                                            {                                                    
                                                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION (This is where we remove the opening number, and harvest the closing numbers.)</span>
                                                {
                                                    <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
                                                    <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
                                                    <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
                                                    <span class="comment">//</span>
                                                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID,
                                                        lNymOpeningNumber,
                                                        <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                                                    {
                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a cron item.)\n&quot;</span>,
                                                            __FUNCTION__);
                                                    }
                                                    <span class="comment">// ---------------------------------------</span>
                                                    <span class="comment">// If the activation was a failure, we can add all the extra transaction numbers BACK to the</span>
                                                    <span class="comment">// Nym, that were being used as CLOSING numbers, and use them later. (They aren&#39;t burned.)</span>
                                                    <span class="comment">// They&#39;re still all signed-out, so we should harvest them so we can still use them on something.</span>
                                                    <span class="comment">// (Whereas if it had been a success, then we would have left them in their existing state, since</span>
                                                    <span class="comment">// the transaction would then be in play, and the numbers could not be used again, nor removed as</span>
                                                    <span class="comment">// issued numbers until the transaction itself had finished and its receipts had been signed-off.)</span>
                                                    <span class="comment">//</span>
                                                    pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// saves.</span>
                                                }
                                                <span class="comment">// --------------------------------------------</span>
                                                <span class="comment">// If success, save a copy in my &quot;active cron items&quot; folder.</span>
                                                <span class="comment">//</span>
                                                <span class="keywordflow">else</span> <span class="comment">//if (OTItem::acknowledged == pReplyItem-&gt;GetStatus())</span>
                                                {
                                                    pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a215530a92d43d8260dfe8f42327cb3de">SaveActiveCronReceipt</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
                                                }
                                                <span class="comment">// --------------------------------------------</span>
                                                <span class="comment">// When party receives notice that smart contract has been activated,</span>
                                                <span class="comment">// remove the instrument from outpayments box. (If it&#39;s there -- it can be.)</span>
                                                <span class="comment">//</span>
                                                <span class="comment">// (This happens for acknowledged AND rejected smart contracts.)</span>
                                                <span class="comment">//</span>
                                                <a class="code" href="class_o_t_num_list.html">OTNumList</a>   numlistOutpayment(lNymOpeningNumber);
                                                <a class="code" href="class_o_t_string.html">OTString</a>    strInstrument; <span class="comment">// If the instrument is in the outpayments box, we put a copy of it here.</span>
                                                <span class="keyword">const</span> int32_t   nOutpaymentIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(lNymOpeningNumber);
                                                <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg             = NULL;
                                                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMessageAngel;

                                                <span class="keywordflow">if</span> (nOutpaymentIndex &gt;= 0)
                                                {
                                                    pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acb808e89943f1f2d0009825a3fbcb34f">GetOutpaymentsByIndex</a>(nOutpaymentIndex);

                                                    <span class="keywordflow">if</span> (NULL == pMsg)
                                                    {
                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment message in outpayment box based on index %d.\n&quot;</span>,
                                                            __FUNCTION__, nOutpaymentIndex);
                                                    }
                                                    <span class="keywordflow">else</span>
                                                    {
                                                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemovedOutpayment = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(nOutpaymentIndex, <span class="keyword">false</span>); <span class="comment">//bDeleteIt=false (deleted later on.)</span>
                                                        theMessageAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pMsg); <span class="comment">// Since we chose to keep pMsg alive and undeleted, after removing it from the outpayments box, we set the angel here to make sure it gets cleaned up later, whenever we return out of this godforsaken function.</span>
                                                        <span class="comment">// --------------------------------------------------</span>
                                                        <span class="keywordflow">if</span> (bRemovedOutpayment)
                                                            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
                                                        <span class="keywordflow">else</span>
                                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove outpayment at index: %d\n&quot;</span>, __FUNCTION__, nOutpaymentIndex);
                                                        <span class="comment">// --------------------------------------------------</span>
                                                        <span class="keywordflow">if</span> (!pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strInstrument))
                                                        {
                                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment instrument in outpayment message at index %d.\n&quot;</span>,
                                                                __FUNCTION__, nOutpaymentIndex);
                                                        }
                                                        <span class="comment">// --------------------------------------------------</span>
                                                        <span class="keywordflow">else</span>
                                                        {
                                                            <span class="comment">// At this point, we&#39;ve removed the outpayment already, and it will be deleted</span>
                                                            <span class="comment">// when it goes out of scope already. And we&#39;ve got a copy of the original financial</span>
                                                            <span class="comment">// instrument that was SENT in that outpayment.</span>
                                                            <span class="comment">//</span>
                                                            <span class="comment">// But what for? Why did I want that instrument here in a string, in strInstrument?</span>
                                                            <span class="comment">// Do I still need to do something with it? Yes: I need to drop a copy of it into</span>
                                                            <span class="comment">// the record box!</span>

                                                            <span class="comment">// NOTE: strInstrument is added to the RecordBox below. So there&#39;s no need to</span>
                                                            <span class="comment">// do that here, ATM.</span>
                                                        }
                                                    }
                                                }
                                                <span class="comment">// ------------------------------------------------------</span>
                                                <span class="comment">// When party receives notice that smart contract has failed activation attempt, then remove</span>
                                                <span class="comment">// the instrument from payments inbox AND outpayments box. (If there -- could be for either.)</span>
                                                <span class="comment">// (Outbox is done just above, so now let&#39;s do inbox...)</span>
                                                <span class="comment">//</span>

                                                <span class="comment">// Why only rejected items? Why not remove it from the payments inbox on success as well?</span>
                                                <span class="comment">// Normally wouldn&#39;t we expect that a successful activation of an inbox item, should remove</span>
                                                <span class="comment">// that inbox item? Especially if there&#39;s already a copy in the outbox as well...</span>
                                                <span class="comment">//</span>
<span class="comment">//                                              if (OTItem::rejection == pReplyItem-&gt;GetStatus()) // REJECTION</span>
                                                {
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists1   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                                                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists2   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>()   .Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
                                                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
                                                    <span class="comment">// ------------------------------------------------------</span>
                                                    <span class="keywordtype">bool</span> bSuccessLoading1 = (bExists1 &amp;&amp; thePmntInbox.LoadPaymentInbox());
                                                    <span class="keywordtype">bool</span> bSuccessLoading2 = (bExists2 &amp;&amp; theRecordBox.LoadRecordBox());
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <span class="keywordflow">if</span> (bExists1 &amp;&amp; bSuccessLoading1)
                                                        bSuccessLoading1  = (thePmntInbox.VerifyContractID() &amp;&amp;
                                                        thePmntInbox.VerifySignature(*pNym));
<span class="comment">//                                                      bSuccessLoading1      = (thePmntInbox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
                                                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists1)
                                                        bSuccessLoading1  = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <span class="keywordflow">if</span> (bExists2 &amp;&amp; bSuccessLoading2)
                                                        bSuccessLoading2  = (theRecordBox.VerifyContractID() &amp;&amp;
                                                        theRecordBox.VerifySignature(*pNym));
<span class="comment">//                                                      bSuccessLoading2      = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
                                                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists2)
                                                        bSuccessLoading2  = theRecordBox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
                                                    <span class="comment">// -----------------------------------------------------</span>
                                                    <span class="comment">// by this point, the boxes DEFINITELY exist -- or not. (generation might have failed, or verification.)</span>
                                                    <span class="comment">//</span>
                                                    <span class="keywordflow">if</span> (!bSuccessLoading1 || !bSuccessLoading2)
                                                    {
                                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server rejection of cron item: &quot;</span>
                                                            <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate paymentInbox or recordBox, with IDs: %s / %s\n&quot;</span>,
                                                            __FUNCTION__, strNymID.Get(), strNymID.Get());
                                                    }
                                                    <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying</span>
                                                    {   <span class="comment">// their contractID and signature, (OR success generating the ledger.)</span>
                                                        <span class="comment">// -------------------------------------------------------------------------------</span>
                                                        <span class="comment">// See if there&#39;s a receipt in the payments inbox.</span>
                                                        <span class="comment">// If so, remove it.</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// ------------------------------------------------------</span>
                                                        <span class="comment">// What&#39;s going on here?</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// Well let&#39;s say Alice sends Bob a payment plan. (This applies to smart contracts, too.)</span>
                                                        <span class="comment">// This means Bob has a payment plan in his PAYMENTS INBOX, with the recipient&#39;s (Alice)</span>
                                                        <span class="comment">// transaction number set to X, and the sender&#39;s transaction number set to 0. It&#39;s 0 because</span>
                                                        <span class="comment">// the instrument is still in Bob&#39;s inbox -- he hasn&#39;t signed it yet -- so his transaction</span>
                                                        <span class="comment">// number isn&#39;t on it yet. It&#39;s blank (0).</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// Next, let&#39;s say Bob signs/confirms the contract, which puts a copy of it into his PAYMENTS</span>
                                                        <span class="comment">// OUTBOX. On the outbox version, Alice&#39;s transaction number is X, and Bob&#39;s transaction number</span>
                                                        <span class="comment">// is Y.</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// Later on, Bob needs to lookup the payment plan in his PAYMENTS INBOX (for example, to remove</span>
                                                        <span class="comment">// it, AS YOU SEE IN THE BELOW LOOP.) Remember, Bob&#39;s transaction number is Y. But he can&#39;t use</span>
                                                        <span class="comment">// that number (Y) to lookup the payment plan in his inbox, since it&#39;s set to ZERO in his inbox!</span>
                                                        <span class="comment">// The inbox version simply doesn&#39;t HAVE Y set onto it yet -- only the outbox version does.</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// So how in the fuck does Bob lookup the inbox version, if the transaction number isn&#39;t SET on</span>
                                                        <span class="comment">// it yet??</span>
                                                        <span class="comment">//</span>
                                                        <span class="comment">// The solution:</span>
                                                        <span class="comment">// 1. Bob grabs an OTNumList containing all the transaction numbers from the OUTBOX VERSION,</span>
                                                        <span class="comment">//    which ends up containing &quot;X,Y&quot; (that happens in this block.)</span>
                                                        <span class="comment">// 2. Bob loops through the payments INBOX, and for each, he grabs an OTNumList containing all</span>
                                                        <span class="comment">//    the transaction numbers. One of those (the matching one) will contain &quot;X,0&quot;. (Except it</span>
                                                        <span class="comment">//    will actually only contain &quot;X&quot;, since 0 is ignored in the call to GetAllTransactionNumbers.)</span>
                                                        <span class="comment">// 3. Bob then checks like this:    if (numlistOutpayment.VerifyAny(numlistIncomingPayment))</span>
                                                        <span class="comment">//    This is equivalent to saying: if (&quot;X,Y&quot;.VerifyAny(&quot;X&quot;)) which RETURNS TRUE -- and we have</span>
                                                        <span class="comment">//    found the instrument!</span>

                                                        <a class="code" href="class_o_t_payment.html">OTPayment</a> theOutpayment;

                                                        <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()                  &amp;&amp;
                                                            theOutpayment.<a class="code" href="class_o_t_payment.html#a294a4886d8701ff1366bca5fdd1e7b56">SetPayment</a>(strInstrument) &amp;&amp;
                                                            theOutpayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
                                                        {
                                                            theOutpayment.<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistOutpayment);
                                                        }
                                                        <span class="comment">// ------------------------------------------------------                                                            </span>
                                                        <span class="keyword">const</span> int32_t nTransCount = thePmntInbox.GetTransactionCount();

                                                        <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// Count backwards since we are removing things.</span>
                                                        {
                                                            int64_t lPaymentTransNum = 0;
                                                            <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = thePmntInbox.GetInstrument(*pNym, ii);
                                                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);

                                                            <span class="keywordflow">if</span> (NULL == pPayment)
                                                            {
                                                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: (Upon receiving notice) While looping payments inbox to remove a payment, &quot;</span>
                                                                    <span class="stringliteral">&quot;unable to retrieve payment at index %d (skipping.)\n&quot;</span>,
                                                                    __FUNCTION__, ii);
                                                                <span class="keywordflow">continue</span>;
                                                            }
                                                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
                                                            {
                                                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: (Upon receiving notice) While looping payments inbox to remove a payment, &quot;</span>
                                                                    <span class="stringliteral">&quot;unable to set temp values for payment at index %d (skipping.)\n&quot;</span>,
                                                                    __FUNCTION__, ii);
                                                                <span class="keywordflow">continue</span>;
                                                            }
                                                            <span class="comment">// ---------------------------------------------------</span>

                                                            <a class="code" href="class_o_t_num_list.html">OTNumList</a> numlistIncomingPayment;

                                                            pPayment-&gt;<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistIncomingPayment);

                                                            <span class="comment">// ---------------------------------------------------</span>

                                                            <span class="keywordflow">if</span> (numlistOutpayment.VerifyAny(numlistIncomingPayment))  <span class="comment">// Found it.</span>
                                                            {                                                                    
                                                                <span class="comment">// ** It&#39;s the same instrument.**</span>
                                                                <span class="comment">// Remove it from the payments inbox, and save.</span>
                                                                <span class="comment">//</span>
                                                                <a class="code" href="class_o_t_transaction.html">OTTransaction</a>    * pTransPaymentInbox = thePmntInbox.GetTransactionByIndex(ii);
                                                                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL  != pTransPaymentInbox); <span class="comment">// It DEFINITELY should be there. (Assert otherwise.)</span>
                                                                lPaymentTransNum = pTransPaymentInbox-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();

                                                                <span class="comment">// DON&#39;T I NEED to call DeleteBoxReceipt at this point?</span>
                                                                <span class="comment">// Since that needs to be called now whenever removing something from any box?</span>
                                                                <span class="comment">//</span>
                                                                <span class="comment">// NOTE: might need to just MOVE this box receipt to the record box, instead of</span>
                                                                <span class="comment">// deleting it.</span>
                                                                <span class="comment">//</span>
                                                                <span class="comment">// Probably I need to do that ONLY if the version in the payments outbox doesn&#39;t exist.</span>
                                                                <span class="comment">// For example, if strInstrument doesn&#39;t exist, then there was nothing in the payments</span>
                                                                <span class="comment">// outbox, and therefore the version in the payment INBOX is the ONLY version I have,</span>
                                                                <span class="comment">// and therefore I should stick it in the Record Box.</span>
                                                                <span class="comment">//</span>
                                                                <span class="comment">// HOWEVER, if strInstrument DOES exist, then I should create its own transaction to add</span>
                                                                <span class="comment">// to the record box, and delete the one that was in the payment inbox. Why delete it? Because</span>
                                                                <span class="comment">// otherwise I would be adding the same thing TWICE to the record box, which I don&#39;t really</span>
                                                                <span class="comment">// need to do. And if I&#39;m going to choose one of the two, the one in the outpayments box will</span>
                                                                <span class="comment">// be the more recent / more relevant one of the two. So I favor that one, unless it doesn&#39;t</span>
                                                                <span class="comment">// exist, in which case I should add the other one instead. (Todo.)</span>
                                                                <span class="comment">//</span>
                                                                <span class="comment">// NOTE: Until the above is completed, the current behavior is that the outpayments box item</span>
                                                                <span class="comment">// will be moved to the record box if it exists, and otherwise nothing will be, since any payments</span>
                                                                <span class="comment">// inbox item will be deleted.</span>


                                                                <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePmntInbox.DeleteBoxReceipt(lPaymentTransNum))
                                                                {
                                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
                                                                        <span class="stringliteral">&quot;from the payment inbox.\n&quot;</span>, __FUNCTION__);
                                                                }
                                                                <span class="comment">// --------------------------------------------------</span>
                                                                <span class="keywordflow">if</span> (thePmntInbox.RemoveTransaction(lPaymentTransNum))
                                                                {
                                                                    thePmntInbox.ReleaseSignatures();
                                                                    thePmntInbox.SignContract(*pNym);
                                                                    thePmntInbox.SaveContract();

                                                                    <span class="keywordflow">if</span> (!thePmntInbox.SavePaymentInbox())
                                                                    {
                                                                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
                                                                    }
                                                                    <span class="keywordflow">else</span>
                                                                    {
                                                                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed instrument from payment inbox.\n&quot;</span>
                                                                            <span class="stringliteral">&quot;Saved payment inbox.\n&quot;</span>, __FUNCTION__);
                                                                    }
                                                                }
                                                                <span class="keywordflow">else</span>
                                                                {
                                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove transaction from payment inbox. &quot;</span>
                                                                        <span class="stringliteral">&quot;(Should never happen.)\n&quot;</span>, __FUNCTION__);
                                                                }
                                                                <span class="comment">// -----------------------------------------------</span>
                                                                <span class="comment">// Todo: save a copy to the record box.</span>
                                                                <span class="comment">// -----------------------------------------------</span>
                                                                <span class="comment">// Note: I could break right here, if this is the only transaction in the</span>
                                                                <span class="comment">// payment inbox which contains the instrument in question. Which I believe</span>
                                                                <span class="comment">// it is.  Todo: if that&#39;s true, which I think it is, then call break here.</span>
                                                                <span class="comment">// After all, you wouldn&#39;t send me the SAME instrument TWICE, would you?</span>
                                                                <span class="comment">// But it still seems theoretically possible (albeit stupid.)</span>
                                                            }
                                                        }
                                                        <span class="comment">// for (int32_t ii = 0; ii &lt; nTransCount; ++ii)</span>
                                                        <span class="comment">// -------------------------------------------------------------------------------</span>
                                                        <span class="comment">// Also, if there was a message in the outpayments box (which we already removed</span>
                                                        <span class="comment">// a bit above), go ahead and add a receipt for it into the record box.</span>
                                                        <span class="comment">//</span>
                                                        <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// Found the instrument in the outpayments box.</span>
                                                        {
                                                            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pNewTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theRecordBox, <span class="comment">// recordbox.</span>
                                                                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>,
                                                                lNymOpeningNumber);
                                                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel(pNewTransaction);

                                                            <span class="keywordflow">if</span> (NULL != pNewTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
                                                            {
                                                                pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lNymOpeningNumber); <span class="comment">// Referencing myself here. We&#39;ll see how it works out.</span>
                                                                pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInstrument);    <span class="comment">// The cheque, invoice, etc that used to be in the outpayments box.</span>
                                                                pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                                                pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                                                <span class="comment">// -----------------------------------------------------</span>
                                                                <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.AddTransaction(*pNewTransaction);

                                                                <span class="keywordflow">if</span> (!bAdded)
                                                                {
                                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (after tentatively removing &quot;</span>
                                                                        <span class="stringliteral">&quot;from payment outbox, an action that is now canceled.)\n&quot;</span>, __FUNCTION__,
                                                                        pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
                                                                    <span class="keywordflow">return</span> <span class="keyword">false</span>;
                                                                }
                                                                <span class="keywordflow">else</span>
                                                                    theTransactionAngel.SetCleanupTargetPointer(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>

                                                                theRecordBox.ReleaseSignatures();
                                                                theRecordBox.SignContract(*pNym);
                                                                theRecordBox.SaveContract();
                                                                <span class="comment">// -------------------------------</span>
                                                                theRecordBox.SaveRecordBox(); <span class="comment">// todo log failure.</span>

                                                                <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
                                                                <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
                                                                <span class="comment">//</span>
                                                                <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
                                                                <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
                                                                <span class="comment">// is removed from a box.</span>
                                                                <span class="comment">//</span>
                                                                <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
                                                                {
                                                                    <a class="code" href="class_o_t_string.html">OTString</a> strNewTransaction(*pNewTransaction);
                                                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... &quot;</span>
                                                                        <span class="stringliteral">&quot;Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
                                                                        __FUNCTION__, strNewTransaction.Get());
                                                                }
                                                                <span class="comment">// -----------------------------------------------------</span>
                                                            }
                                                            <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
                                                            {
                                                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
                                                                    <span class="stringliteral">&quot;add a new transaction to record box (for a payment instrument we just removed &quot;</span>
                                                                    <span class="stringliteral">&quot;from the outpayments box): %s\n&quot;</span>, __FUNCTION__, strNymID.Get());
                                                            }
                                                        } <span class="comment">// if (strInstrument.Exists()) (then add a copy to record box.)</span>
                                                    } <span class="comment">// else (Success loading the payment inbox and recordBox)</span>
                                                } <span class="comment">// (OTItem::rejection == pReplyItem-&gt;GetStatus())</span>
                                            } <span class="comment">// if (!bIsActivatingNym)</span>
                                        } <span class="comment">// if (NULL != pCronItem)</span>
                                        <span class="keywordflow">else</span>
                                        {
                                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading cronitem from Nymbox receipt, from string:\n%s\n&quot;</span>,
                                                __FUNCTION__, strCronItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                        }

                                    } <span class="comment">// pReplyItem is a rejection.</span>
                                } <span class="comment">// pServerTransaction (the Nymbox receipt we just accepted / removed) is a notice.</span>

                                <span class="keywordflow">break</span>;

                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:
                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>:
                                <span class="keywordflow">break</span>;
                                <span class="comment">// I don&#39;t think we need to do anything here...</span>

                            <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Successfully removed finalReceipt &quot;</span>
                                    <span class="stringliteral">&quot;from Nymbox with opening num: %lld\n&quot;</span>, __FUNCTION__,
                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                                <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                <span class="keywordflow">else</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                                <span class="comment">// BUG: RemoveIssuedNum shouldn&#39;t be here. In Nymbox, finalReceipt is only a notice, and I shoulda</span>
                                <span class="comment">// removed the number the instant that I saw it. (Back when processing the Nymbox, before even</span>
                                <span class="comment">// calculating the request.) Therefore, this is moved to AcceptEntireNymbox and Finalize for Process Inbox.</span>
                                <span class="comment">//</span>
<span class="comment">//                              pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pServerTransaction-&gt;GetReferenceToNum(), true); // bool bSave=true</span>
                                <span class="comment">// ----------------------------------------------</span>
                                <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
                                <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
                                <span class="comment">// market offers in that list, since we already have a list of active</span>
                                <span class="comment">// market offers separately. And market offers produce final receipts,</span>
                                <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
                                <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
                                <span class="comment">// It is for the others.</span>
                                <span class="comment">//</span>
                                <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
                                <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
                                <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
                                <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
                                <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
                                <span class="comment">//</span>
                                <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                                                   pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                                                   pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
                                <span class="comment">// ----------------------------------------------</span>

                                <span class="keywordflow">break</span>;

                            <span class="keywordflow">default</span>:
                                {
                                    <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
                                    pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Unexpected replyItem:type while processing Nymbox: %s \n&quot;</span>, 
                                        strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                    <span class="keywordflow">continue</span>;
                                }
                            }   <span class="comment">// switch replyItem type</span>

                            <span class="comment">// Remove from pNymbox</span>
                            <span class="comment">// This happens for ALL of the above cases.</span>
                            <span class="comment">// Update: Now whenever removing a receipt from any box, we also have</span>
                            <span class="comment">// to delete the box receipt, which is stored as a separate file.</span>
                            <span class="comment">//</span>
                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(*pNymbox); <span class="comment">// faster.</span>
<span class="comment">//                          pNymbox-&gt;DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
                            pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                        } <span class="comment">// for loop (reply items)</span>
                        <span class="comment">// ---------------------------------------</span>
                        <span class="comment">// All done? Let&#39;s save up...</span>
                        <span class="comment">//</span>
                        pNymbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                        pNymbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                        pNymbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                        pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#aa2dec5beccd6e4a55cfe45788ebd2137">SaveNymbox</a>();

                        pNymbox = NULL;  <span class="comment">// Since it could be pointing to a variable that&#39;s in this block (now out of scope) then we clear the pointer.</span>
                    } <span class="comment">// pTransaction and pReplyTransaction are both NOT NULL.</span>
                    <span class="comment">// ------------------------------------------------------------------</span>
                }

                <span class="comment">// *******************************************************************************</span>
                <span class="comment">//</span>
                <span class="comment">// The below happens BOTH for Inbox AND Nymbox.</span>

                <span class="keywordflow">if</span> ((NULL != pTransaction) &amp;&amp; (NULL != pReplyTransaction))
                {                   
                    <span class="comment">// -----------------------------------------------------------------</span>
                    <span class="comment">//</span>
                    <span class="comment">// SAVE THE RECEIPT....</span>

                    <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);

                    <a class="code" href="class_o_t_string.html">OTString</a> strReceiptID(<span class="stringliteral">&quot;NOT_SET_YET&quot;</span>);

                    <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);

                    <span class="keywordflow">if</span> (NULL == pReplyItem)
                    {
                        pReplyItem = pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);

                        <span class="keywordflow">if</span> (NULL != pReplyItem)
                            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strReceiptID); <span class="comment">// In this case, the receipt ID is the Nym ID</span>
                    }
                    <span class="keywordflow">else</span> 
                    {
                        strReceiptID = theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>; <span class="comment">// If a balance statement, then the receipt ID is the Account ID.</span>
                    }
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <a class="code" href="class_o_t_string.html">OTString</a> strTransaction;
                    pReplyTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTransaction); <span class="comment">// &lt;=========== Save that receipt!</span>
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <a class="code" href="class_o_t_string.html">OTString</a> strReceiptFilename;

                    <span class="keywordflow">if</span> (pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())                    
                        strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.Get());
                    <span class="keywordflow">else</span>
                        strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.fail&quot;</span>, strReceiptID.Get());
                    <span class="comment">// --------------------------------------------------------------------</span>
                    <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
                    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(strTransaction);

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.WriteArmoredString(strFinal, <span class="stringliteral">&quot;TRANSACTION&quot;</span>)) <span class="comment">// todo hardcoding.</span>
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error saving transaction receipt &quot;</span>
                            <span class="stringliteral">&quot;(failed writing armored string):\n%s%s%s%s%s\n Contents:\n%s\n&quot;</span>, 
                            <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
                            strServerID.Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                            strTransaction.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }
                    <span class="comment">// ------------------------------------------------------------------------</span>
                    <span class="keywordflow">else</span> <span class="comment">// success writing armored string</span>
                    {                        
                        <span class="keywordflow">if</span> (NULL != pReplyItem)
                        {
                            <span class="comment">// -------------------------------------------------</span>
                            <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                                strServerID.Get(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                            <span class="comment">// -------------------------------------------------</span>
                        }
                        <span class="keywordflow">else</span> <span class="comment">// This should never happen...</span>
                        {
                            strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.error&quot;</span>, strReceiptID.Get());

                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error saving transaction receipt:  %s%s%s\n&quot;</span>, 
                                strServerID.Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                            <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                                strServerID.Get(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        }
                    } <span class="comment">// success writing armored string</span>
                    <span class="comment">// ------------------------------------------------------------------------</span>
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTheLedger(theLedger), strTheReplyLedger(theReplyLedger);
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found ledger in %s, but didn&#39;t find the right transaction type within.\n&quot;</span>
                        <span class="stringliteral">&quot;(pTransaction == %s) &amp;&amp; (pReplyTransaction == %s)\n&quot;</span>
                        <span class="stringliteral">&quot;theLedger: \n\n%s\n\n&quot;</span>
                        <span class="stringliteral">&quot;theReplyLedger:\n\n%s\n\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
                        (NULL != pTransaction) ? <span class="stringliteral">&quot;NOT NULL&quot;</span> : <span class="stringliteral">&quot;NULL&quot;</span>, (NULL != pReplyTransaction) ? <span class="stringliteral">&quot;NOT NULL&quot;</span> : <span class="stringliteral">&quot;NULL&quot;</span>,
                        strTheLedger.Get(), strTheReplyLedger.Get());
                }
            }
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Strange... received server acknowledgment but &#39;in reference to&#39; message was blank.\n&quot;</span>);
        }

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getAccountFiles&quot;</span>)) <span class="comment">// Replaces getAccount, getInbox, and getOutbox</span>
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to getAccountFiles message.\n&quot;</span>);

        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor  = theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>;  <span class="comment">// containing account file + inbox and outbox.</span>
        <span class="keyword">const</span> <span class="keywordtype">bool</span>     bHasFiles = ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
        <span class="comment">// -------------------------------------------------</span>
        <span class="keywordflow">if</span> (bHasFiles)
        {
            <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
            <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
            <span class="comment">// -------------------------------------------------</span>
            <span class="keywordflow">if</span> (NULL == pMap)
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object in @getAccountFiles.\n&quot;</span>, __FUNCTION__);
            <span class="keywordflow">else</span>
            {
                <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
                <span class="comment">// ----------------------------------------</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strAccount, strInbox, strOutbox;
                <span class="comment">// ----------------------------------------</span>
                mapOfStrings::iterator it_account = theMap.find(<span class="stringliteral">&quot;account&quot;</span>);
                mapOfStrings::iterator it_inbox   = theMap.find(<span class="stringliteral">&quot;inbox&quot;</span>  );
                mapOfStrings::iterator it_outbox  = theMap.find(<span class="stringliteral">&quot;outbox&quot;</span> );
                <span class="comment">// ------------------------------------------------------------</span>
                <span class="keywordflow">if</span> ((theMap.end() != it_account) &amp;&amp; (it_account-&gt;second.size() &gt; 0))
                    strAccount = it_account-&gt;second.c_str();
                <span class="comment">// ------------------------------------------------------------</span>
                <span class="keywordflow">if</span> ((theMap.end() != it_inbox) &amp;&amp; (it_inbox-&gt;second.size() &gt; 0))
                    strInbox = it_inbox-&gt;second.c_str();
                <span class="comment">// ------------------------------------------------------------</span>
                <span class="keywordflow">if</span> ((theMap.end() != it_outbox) &amp;&amp; (it_outbox-&gt;second.size() &gt; 0))
                    strOutbox = it_outbox-&gt;second.c_str();
                <span class="comment">// ********************************************************************************************************</span>
                <span class="keywordflow">if</span> (strAccount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                {
                    <span class="comment">// Load the account object from that string.</span>
                    <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
                    
                    <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAccount) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Saving updated account file to disk...\n&quot;</span>);
                        pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
                        <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
                        <span class="comment">// UPDATE (above) I now release signatures again since we have receipts functional. As long as receipt has server&#39;s signature, it can prove the others.</span>
                        pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                        pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                        pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
                        
                        <span class="comment">// Next let&#39;s make sure the wallet&#39;s copy of this account is replaced with the new one...</span>
                        <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
                        
                        <span class="keywordflow">if</span> (NULL != pWallet)
                        {
                            pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
                            pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
                            <span class="comment">// --------------------------------------------------</span>
                            theAngel.SetCleanupTargetPointer(NULL); <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
                        }
                    }
                }
                <span class="comment">// ********************************************************************************************************</span>
                
                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strAcctID   (ACCOUNT_ID);
                <span class="keyword">const</span> std::string str_acct_id (strAcctID.Get());

                
                <span class="keywordflow">if</span> (strInbox.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
                    
                    <span class="comment">// Load the ledger object from strInbox</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);
                    
                    <span class="comment">// I receive the inbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
                    <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this inbox</span>
                    <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot,</span>
                    <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
                    <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
                    <span class="keywordflow">if</span> (theInbox.LoadInboxFromString(strInbox) &amp;&amp; theInbox.VerifySignature(*pServerNym)) <span class="comment">// No VerifyAccount. Can&#39;t, because client hasn&#39;t had a chance yet to download the box receipts that go with this inbox -- and VerifyAccount() tries to load those, which would fail here...</span>
                    {
                        <span class="comment">// -----------------------------</span>
                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
                        
                        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                        {
                            THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>);
                            
                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adddd63c949620e826177926f8ecae533">SetInboxHash</a>(str_acct_id, THE_HASH);
                            
                            <span class="keywordflow">if</span> (!bHash)
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting InboxHash on Nym for account: %s\n&quot;</span>,
                                              __FUNCTION__, str_acct_id.c_str());
                            <span class="comment">// ----------------------------------------------------</span>
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
                            }
                        }
                        <span class="comment">// -------------------------------</span>
                        
                        <span class="comment">// If I have Transaction #35 signed out, and I use it to start a market offer (or any other cron item)</span>
                        <span class="comment">// then it&#39;s always possible that a finalReceipt will pop into my Inbox while I&#39;m asleep, closing</span>
                        <span class="comment">// that transaction #. The server officially believes 35 is closed. Unfortunately, I still have it signed</span>
                        <span class="comment">// out, on my side anyway, because I didn&#39;t know the finalReceipt came in.</span>
                        <span class="comment">//</span>
                        <span class="comment">// THEREFORE, WHEN A FINAL RECEIPT COMES IN, I NEED TO REMOVE ITS &quot;in reference to&quot; NUMBER FROM MY</span>
                        <span class="comment">// ISSUED LIST. Here is clearly the best place for that:</span>
                        <span class="comment">//</span>
                        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.GetTransactionMap())
                        {
                            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTempTrans = (*it).second;
                            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTempTrans);
                            
                            <span class="comment">// TODO security: Keep a client-side list of issued #s for finalReceipts. That way,</span>
                            <span class="comment">// I&#39;ll be smart enough here not to actually remove just any number, unless it&#39;s actually</span>
                            <span class="comment">// on my list of final receipts.  (The server does a similar thing already.)</span>
                            <span class="comment">//</span>
                            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTempTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;*** Removing opening issued number (%lld), since finalReceipt found when retrieving asset account inbox. ***\n&quot;</span>,
                                               pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                
                                <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>,
                                                   pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                <span class="keywordflow">else</span>
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                                                   pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                                
<span class="comment">//                              pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pTempTrans-&gt;GetReferenceToNum(), true); // bSave = true;</span>
                                <span class="comment">// ----------------------------------------------</span>
                                <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
                                <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
                                <span class="comment">// market offers in that list, since we already have a list of active</span>
                                <span class="comment">// market offers separately. And market offers produce final receipts,</span>
                                <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
                                <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
                                <span class="comment">// It is for the others.</span>
                                <span class="comment">//</span>
                                OTCronItem::EraseActiveCronReceipt(pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                                                   pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                                                   pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
                                <span class="comment">// ----------------------------------------------</span>
                                
                            } <span class="comment">// We also do this in AcceptEntireNymbox</span>
                        }
                        
                        <span class="comment">// -----------------------------------------------</span>
                        <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own. </span>
                        theInbox.ReleaseSignatures(); <span class="comment">// This is back. Why? Because we have receipts functional now.</span>
                        theInbox.SignContract(*pNym);
                        theInbox.SaveContract();
                        theInbox.SaveInbox();
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading (from string) or verifying inbox:\n\n%s\n&quot;</span>,
                                      __FUNCTION__, strInbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }
                }
                <span class="comment">// ********************************************************************************************************</span>
                <span class="keywordflow">if</span> (strOutbox.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                {
                    <span class="comment">// Load the ledger object from strOutbox.</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theOutbox(USER_ID, ACCOUNT_ID, SERVER_ID);

                    <span class="comment">// I receive the outbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
                    <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this outbox</span>
                    <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
                    <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
                    <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
                    <span class="keywordflow">if</span> (theOutbox.LoadOutboxFromString(strOutbox) &amp;&amp; theOutbox.VerifySignature(*pServerNym)) <span class="comment">// No point calling VerifyAccount since the client hasn&#39;t even had a chance to download the box receipts yet...</span>
                    {
                        <span class="comment">// -----------------------------</span>
                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;

                        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                        {
                            THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>);

                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac5af6ed289cfcd77c388ab750da28ccc">SetOutboxHash</a>(str_acct_id, THE_HASH);

                            <span class="keywordflow">if</span> (!bHash)
                                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting OutboxHash on Nym for account: %s\n&quot;</span>,
                                              __FUNCTION__, str_acct_id.c_str());
                            <span class="comment">// ----------------------------------------------------</span>
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
                            }
                        }
                        <span class="comment">// -------------------------------</span>
                        theOutbox.ReleaseSignatures();  <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
                        theOutbox.SignContract(*pNym);  <span class="comment">// ANOTHER UPDATE: Removing signature again, since we have receipts functional now.</span>
                        theOutbox.SaveContract();
                        theOutbox.SaveOutbox();
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading (from string) or verifying outbox:\n\n%s\n&quot;</span>,
                                      __FUNCTION__, strOutbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    }
                }
                <span class="comment">// ********************************************************************************************************</span>
            } <span class="comment">// pMap loaded successfully.</span>
        } <span class="comment">// Has the files.</span>
        <span class="comment">// ---------------------------------------------------</span>

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getAccount&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
    {
        <span class="comment">// base64-Decode the server reply&#39;s payload into strAccount</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strAccount(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
        
        <span class="comment">// Load the account object from that string.</span>
        <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
        
        <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAccount) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Saving updated account file to disk...\n&quot;</span>);
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
            <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
            <span class="comment">// UPDATE (above) I now release signatures again since we have receipts functional. As long as receipt has server&#39;s signature, it can prove the others.</span>
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
            pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
            pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
            
            <span class="comment">// Next let&#39;s make sure the wallet&#39;s copy of this account is replaced with the new one...</span>
            <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
            
            <span class="keywordflow">if</span> (NULL != pWallet)
            {
                pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
                pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
                <span class="comment">// --------------------------------------------------</span>
                theAngel.SetCleanupTargetPointer(NULL); <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
            }
        }
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getInbox&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);

        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Received server response to Get Inbox message.\n&quot;</span>);

        <span class="comment">// base64-Decode the server reply&#39;s payload into strInbox</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strInbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

        <span class="comment">// Load the ledger object from that string.</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);  

        <span class="comment">// I receive the inbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
        <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this inbox</span>
        <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
        <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
        <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
        <span class="keywordflow">if</span> (theInbox.LoadInboxFromString(strInbox) &amp;&amp; theInbox.VerifySignature(*pServerNym)) <span class="comment">// No VerifyAccount. Can&#39;t, because client hasn&#39;t had a chance yet to download the box receipts that go with this inbox -- and VerifyAccount() tries to load those, which would fail here...</span>
        {
            <span class="comment">// -----------------------------</span>
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);
            <span class="keyword">const</span> std::string str_acct_id(strAcctID.Get());

            <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>);

                <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adddd63c949620e826177926f8ecae533">SetInboxHash</a>(str_acct_id, THE_HASH);

                <span class="keywordflow">if</span> (!bHash)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting InboxHash on Nym for account: %s\n&quot;</span>,
                    str_acct_id.c_str());
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
                }
            }
            <span class="comment">// -------------------------------            </span>

            <span class="comment">// If I have Transaction #35 signed out, and I use it to start a market offer (or any other cron item)</span>
            <span class="comment">// then it&#39;s always possible that a finalReceipt will pop into my Inbox while I&#39;m asleep, closing</span>
            <span class="comment">// that transaction #. The server officially believes 35 is closed. Unfortunately, I still have it signed</span>
            <span class="comment">// out, on my side anyway, because I didn&#39;t know the finalReceipt came in.</span>
            <span class="comment">//</span>
            <span class="comment">// THEREFORE, WHEN A FINAL RECEIPT COMES IN, I NEED TO REMOVE ITS &quot;in reference to&quot; NUMBER FROM MY</span>
            <span class="comment">// ISSUED LIST. Here is clearly the best place for that:</span>
            <span class="comment">//</span>
            <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.GetTransactionMap())
            {   
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTempTrans = (*it).second;
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTempTrans);

                <span class="comment">// TODO security: Keep a client-side list of issued #s for finalReceipts. That way,</span>
                <span class="comment">// I&#39;ll be smart enough here not to actually remove just any number, unless it&#39;s actually</span>
                <span class="comment">// on my list of final receipts.  (The server does a similar thing already.)</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTempTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;*** Removing opening issued number (%lld), since finalReceipt found when getting asset account inbox. ***\n&quot;</span>, 
                        pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

                    <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
                        pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
                        pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());

<span class="comment">//                  pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pTempTrans-&gt;GetReferenceToNum(), true); // bSave = true;</span>

                    <span class="comment">// ----------------------------------------------</span>
                    <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
                    <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
                    <span class="comment">// market offers in that list, since we already have a list of active</span>
                    <span class="comment">// market offers separately. And market offers produce final receipts,</span>
                    <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
                    <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
                    <span class="comment">// It is for the others.</span>
                    <span class="comment">//</span>
                    <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
                    <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
                    <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
                    <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
                    <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
                    <span class="comment">//</span>
                    OTCronItem::EraseActiveCronReceipt(pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
                                                       pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
                                                       pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
                    <span class="comment">// ----------------------------------------------</span>

                } <span class="comment">// We also do this in AcceptEntireNymbox</span>
            }

            <span class="comment">// -----------------------------------------------</span>
            <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own. </span>
            theInbox.ReleaseSignatures(); <span class="comment">// This is back. Why? Because we have receipts functional now.</span>
            theInbox.SignContract(*pNym);
            theInbox.SaveContract();
            theInbox.SaveInbox();
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading (from string) or verifying inbox:\n\n%s\n&quot;</span>, strInbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getOutbox&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
    {

        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Received server response to Get Outbox message.\n&quot;</span>);
<span class="comment">//      OTString strReply(theReply);</span>
<span class="comment">//      OTLog::vOutput(0, &quot;Received server response to Get Outbox message:\n%s\n&quot;, strReply.Get());</span>

        <span class="comment">// base64-Decode the server reply&#39;s payload into strOutbox</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strOutbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

<span class="comment">//      OTLog::vError(&quot;OUTBOX CONTENTS:\n%s\n&quot;, strOutbox.Get());</span>

        <span class="comment">// Load the ledger object from that string.             </span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theOutbox(USER_ID, ACCOUNT_ID, SERVER_ID); 


        <span class="comment">// I receive the outbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
        <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this outbox</span>
        <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
        <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
        <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
        <span class="keywordflow">if</span> (theOutbox.LoadOutboxFromString(strOutbox) &amp;&amp; theOutbox.VerifySignature(*pServerNym)) <span class="comment">// No point calling VerifyAccount since the client hasn&#39;t even had a chance to download the box receipts yet...</span>
        {
            <span class="comment">// -----------------------------</span>
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);
            <span class="keyword">const</span> std::string str_acct_id(strAcctID.Get());

            <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>);

                <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac5af6ed289cfcd77c388ab750da28ccc">SetOutboxHash</a>(str_acct_id, THE_HASH);

                <span class="keywordflow">if</span> (!bHash)
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting OutboxHash on Nym for account: %s\n&quot;</span>,
                    str_acct_id.c_str());
                <span class="comment">// ----------------------------------------------------</span>
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
                }
            }
            <span class="comment">// -------------------------------</span>
            theOutbox.ReleaseSignatures();  <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
            theOutbox.SignContract(*pNym);  <span class="comment">// ANOTHER UPDATE: Removing signature again, since we have receipts functional now.</span>
            theOutbox.SaveContract();
            theOutbox.SaveOutbox();
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading (from string) or verifying outbox:\n\n%s\n&quot;</span>, strOutbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
        }

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getContract&quot;</span>))
    {
        <span class="comment">// base64-Decode the server reply&#39;s payload into strContract</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strContract(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

        <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
        <a class="code" href="class_o_t_string.html">OTString</a> strFilename;   <span class="comment">// In this case the filename isn&#39;t actually used, since SaveToContractFolder will</span>
        <span class="comment">// handle setting up the filename and overwrite it anyway. But I still prefer to set it</span>
        <span class="comment">// up correctly, rather than pass a blank. I&#39;m just funny like that.</span>
        strFilename = theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();

        <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername, 
            strFilename, theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);

        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);

        <span class="comment">// Check the server signature on the contract here. (Perhaps the message is good enough?</span>
        <span class="comment">// After all, the message IS signed by the server and contains the Account.</span>
        <span class="comment">//      if (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract())</span>
        <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strContract) &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
        {
            <span class="comment">// Next make sure the wallet has this contract on its list...</span>
            <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();

            <span class="keywordflow">if</span> (NULL != pWallet)
            {
                pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(*pContract);
                pContract = NULL; <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
            }
        }
        <span class="comment">// cleanup</span>
        <span class="keywordflow">if</span> (pContract)
        {
            <span class="keyword">delete</span> pContract;
            pContract = NULL;
        }
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMint&quot;</span>))
    {
        <span class="comment">// base64-Decode the server reply&#39;s payload into strMint</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strMint(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
        <span class="comment">// ------------------------------------------------</span>
        <span class="comment">// Load the mint object from that string...</span>
        <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>, theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
        <span class="comment">// ------------------------------------------------</span>
        <span class="comment">// TODO check the server signature on the mint here...</span>
        <span class="keywordflow">if</span> (pMint-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strMint))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Saving mint file to disk...\n&quot;</span>);
            pMint-&gt;<a class="code" href="class_o_t_mint.html#a3ec3a56c4654df4843466194b8d5dcf9">SaveMint</a>();
        }
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketList&quot;</span>))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strMarketDatafile;
        strMarketDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;market_data.bin&quot;</span>);

        <span class="comment">// ----------------------------------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);

        <span class="comment">// --------------------------------</span>
        <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
        <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
        <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
        <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
        {
            <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
                theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
                strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());       <span class="comment">// &quot;markets/&lt;serverID&gt;/market_data.bin&quot;</span>
            <span class="keywordflow">if</span> (!bSuccessErase)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing market list from market folder: %s \n&quot;</span>, strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------</span>

        <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;

        <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketList reply.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// -------------------------------------------------------------</span>
        <span class="comment">// Unpack the market list...</span>

        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>

        pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a> * pMarketList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a7a0f581c82f5599271fcd57d0a020f99">OTDB::STORED_OBJ_MARKET_LIST</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::MarketList&gt;</a> theListAngel(*pMarketList);

        <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pMarketList);

        <span class="comment">// ----------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Process Server Reply: Failed unpacking data for @getMarketList.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------------------------------</span>


        <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pMarketList,    
            <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
            theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
            strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());       <span class="comment">// &quot;markets/&lt;serverID&gt;/market_data.bin&quot;</span>
        <span class="keywordflow">if</span> (!bSuccessStore)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing market list to market folder: %s \n&quot;</span>, strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketOffers&quot;</span>))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMarketID = theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>; <span class="comment">// market ID stored here.</span>

        <a class="code" href="class_o_t_string.html">OTString</a> strOfferDatafile;
        strOfferDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, strMarketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// ---------------------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);

        <span class="comment">// --------------------------------</span>
        <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
        <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
        <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
        <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
        {
            <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
                theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
                <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
                strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/offers/&lt;marketID&gt;.bin&quot;</span>
            <span class="keywordflow">if</span> (!bSuccessErase)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing offers list from market folder: %s \n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------</span>

        <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;

        <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketOffers reply.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// -------------------------------------------------------------</span>
        <span class="comment">// Unpack the market list...</span>

        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>

        pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> * pOfferList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2b54a22ce17683d3970981ec94203ad1">OTDB::STORED_OBJ_OFFER_LIST_MARKET</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListMarket&gt;</a> theListAngel(*pOfferList);

        <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pOfferList);

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getMarketOffers.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pOfferList, 
            <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
            theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
            <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
            strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/offers/&lt;marketID&gt;.bin&quot;</span>
        <span class="keywordflow">if</span> (!bSuccessStore)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to market folder.\n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketRecentTrades&quot;</span>))
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMarketID = theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>; <span class="comment">// market ID stored here.</span>

        <a class="code" href="class_o_t_string.html">OTString</a> strTradeDatafile;
        strTradeDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, strMarketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// -------------------------------------------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);

        <span class="comment">// --------------------------------</span>
        <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
        <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
        <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
        <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
        {
            <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
                theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
                <span class="stringliteral">&quot;recent&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/recent&quot;   // todo stop hardcoding.</span>
                strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/recent/&lt;marketID&gt;.bin&quot;</span>
            <span class="keywordflow">if</span> (!bSuccessErase)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing recent trades list from market folder: %s \n&quot;</span>, strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------</span>

        <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;

        <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketRecentTrades reply.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// -------------------------------------------------------------</span>
        <span class="comment">// Unpack the market list...</span>

        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>

        pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a> * pTradeList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeListMarket&gt;</a> theListAngel(*pTradeList);

        <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pTradeList);

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getMarketRecentTrades.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pTradeList, 
            <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
            theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
            <span class="stringliteral">&quot;recent&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/recent&quot;   // todo stop hardcoding.</span>
            strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/recent/&lt;marketID&gt;.bin&quot;</span>
        <span class="keywordflow">if</span> (!bSuccessStore)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to market folder.\n&quot;</span>, strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getNym_MarketOffers&quot;</span>))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strOfferDatafile;
        strOfferDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="comment">// -------------------------------------------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);

        <span class="comment">// --------------------------------</span>
        <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
        <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
        <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
        <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
        {
            <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),              <span class="comment">// &quot;nyms&quot;</span>
                theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;nyms/&lt;serverID&gt;&quot;</span>
                <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
                strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers/&lt;NymID&gt;.bin&quot;</span>
            <span class="keywordflow">if</span> (!bSuccessErase)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing offers list from nyms folder: %s \n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------</span>

        <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;

        <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getNym_MarketOffers reply.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// -------------------------------------------------------------</span>
        <span class="comment">// Unpack the nym&#39;s offer list...</span>

        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>

        pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());

        <span class="comment">// -----------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> * pOfferList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a976d0f2d070c94e031644952c6fb78d4">OTDB::STORED_OBJ_OFFER_LIST_NYM</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListNym&gt;</a> theListAngel(*pOfferList);

        <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pOfferList);

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getNym_MarketOffers.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="comment">// --------------------------------------------------------</span>

        <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pOfferList, 
            <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),             <span class="comment">// &quot;nyms&quot;</span>
            theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;nyms/&lt;serverID&gt;&quot;</span>
            <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
            strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers/&lt;NymID&gt;.bin&quot;</span>
        <span class="keywordflow">if</span> (!bSuccessStore)
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to nyms folder.\n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="comment">// ----------------------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@deleteUserAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);

        <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;

        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);

        <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
            theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteUserAccount&quot;</span>)
            )
        {
            <span class="comment">// O-kayy!!</span>

            <span class="comment">// ------------------------------------------------</span>
            <span class="keywordflow">while</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &gt; 0)
            {
                int64_t lTemp = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3fb93588f8e68c7f56cee00930f07d34">RemoveTransactionNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
            }
            <span class="comment">// ------------------------------------------------</span>
            <span class="keywordflow">while</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID) &gt; 0)
            {
                int64_t lTemp = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
            }       
            <span class="comment">// ------------------------------------------------</span>
            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aec22b071d4218d5b49ce88236cd8cfb5">UnRegisterAtServer</a>(strServerID); <span class="comment">// Remove request number for that server.</span>
            <span class="comment">// ------------------------------------------------</span>

            <span class="comment">// SAVE the updated Nym to local storage.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; extraNym = *pNym;
            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(extraNym);

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Successfully DELETED Nym from Server: removed request number, plus all issued and transaction numbers &quot;</span>
                <span class="stringliteral">&quot;for Nym %s for Server %s.\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.Get());
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;The server just for some reason tried to trick me into erasing my issued &quot;</span>
            <span class="stringliteral">&quot;and transaction numbers for Nym %s, Server %s.\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.Get());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="comment">// ----------------------------------------------------------------------------------</span>

    <span class="comment">// ----------------------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@deleteAssetAccount&quot;</span>))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);

        <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;

        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);

        <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
            theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>) &amp;&amp;
            theOriginalMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteAssetAccount&quot;</span>)
            )
        {
            <span class="comment">// O-kayy!!</span>

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);

            <a class="code" href="class_o_t_account.html">OTAccount</a> * pDeletedAcct = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);

            <span class="keywordflow">if</span> (NULL != pDeletedAcct)
            {
                pDeletedAcct-&gt;<a class="code" href="class_o_t_account.html#aea147dd5991690f6a6f9e2500cf39872">MarkForDeletion</a>();
                <span class="comment">// ---------------------------------</span>
                pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
                pDeletedAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
                <span class="comment">// (The account still exists in storage, but has been MARKED FOR DELETION.)</span>

                <span class="comment">// ---------------------------------</span>
                <span class="comment">// Remove the account from the wallet:</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#abc47515d8104ba094bab2417d66a5161">RemoveAccount</a>(theAccountID))
                {
                    m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
                }
                <span class="comment">// ---------------------------------</span>
            }

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Successfully DELETED Asset Acct %s from Server: %s.\n&quot;</span>,
                theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.Get());
        }
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;The server just for some reason tried to trick me into erasing my account %s on Server %s.\n&quot;</span>,
            theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.Get());

        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="comment">// ----------------------------------------------------------------------------------</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@issueAssetType&quot;</span>))
    {
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
        {
            <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount = NULL;

            <span class="comment">// this decodes the ascii-armor payload where the new account file</span>
            <span class="comment">// is stored, and returns a normal string in strAcctContents.</span>
            <a class="code" href="class_o_t_string.html">OTString</a>    strAcctContents(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

            <span class="comment">// TODO check return value</span>
            pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);

            <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAcctContents) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
            {
                <span class="comment">// (2) Sign the Account </span>
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);      
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// (3) Save the Account to file</span>
                pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                <span class="comment">// Need to consider other security considerations.</span>
                <span class="comment">// What if I wasn&#39;t EXPECTING a @issueAssetType message?</span>
                <span class="comment">// Well actually, in that case, the server wouldn&#39;t have a</span>
                <span class="comment">// copy of my request to send back to me, would he? So I should</span>
                <span class="comment">// check that request to make sure it&#39;s good.</span>
                <span class="comment">// Also maybe should check to see if I was expecting this message</span>
                <span class="comment">// in the first place.</span>

                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);               
                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); 

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span> 
            {
                <span class="keyword">delete</span> pAccount;
                pAccount = NULL;
            }

        }
    }

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@createAccount&quot;</span>))
    {
        <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
        {
            <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount = NULL;

            <span class="comment">// this decodes the ascii-armor payload where the new account file</span>
            <span class="comment">// is stored, and returns a normal string in strAcctContents.</span>
            <a class="code" href="class_o_t_string.html">OTString</a>    strAcctContents(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);

            pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);

            <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAcctContents) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
            {
                <span class="comment">// (2) Sign the Account</span>
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
                <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
                <span class="comment">// UPDATE (above) we are releasing these now, for good, since server&#39;s signature is not needed. Receipts are functional now, </span>
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);      <span class="comment">// and the last receipt IS signed by the server, and it can be used to verify the nym, account, inbox, and outbox. Nifty!</span>
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// (3) Save the Account to file</span>
                pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                <span class="comment">// Need to consider other security considerations.</span>
                <span class="comment">// What if I wasn&#39;t EXPECTING a @createAccount message?</span>
                <span class="comment">// Well actually, in that case, the server wouldn&#39;t have a</span>
                <span class="comment">// copy of my request to send back to me, would he? So I should</span>
                <span class="comment">// check that request to make sure it&#39;s good.</span>
                <span class="comment">// Also maybe should check to see if I was expecting this message</span>
                <span class="comment">// in the first place.</span>

                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span> 
            {
                <span class="keyword">delete</span> pAccount;
                pAccount = NULL;
            }

        }
    }
    <span class="keywordflow">else</span> 
    {

    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a65b35501e13456c8086c66d4dfda2545"></a><!-- doxytag: member="OTClient::ProcessUserCommand" ref="a65b35501e13456c8086c66d4dfda2545" args="(OT_CLIENT_CMD_TYPE requestedCommand, OTMessage &amp;theMessage, OTPseudonym &amp;theNym, OTServerContract &amp;theServer, OTAccount *pAccount=NULL, int64_t lTransactionAmount=0, OTAssetContract *pMyAssetContract=NULL, OTIdentifier *pHisNymID=NULL, OTIdentifier *pHisAcctID=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t <a class="el" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">OTClient::ProcessUserCommand</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7">OTClient::OT_CLIENT_CMD_TYPE</a>&#160;</td>
          <td class="paramname"><em>requestedCommand</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_account.html">OTAccount</a> *&#160;</td>
          <td class="paramname"><em>pAccount</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int64_t&#160;</td>
          <td class="paramname"><em>lTransactionAmount</em> = <code>0</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_asset_contract.html">OTAssetContract</a> *&#160;</td>
          <td class="paramname"><em>pMyAssetContract</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> *&#160;</td>
          <td class="paramname"><em>pHisNymID</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> *&#160;</td>
          <td class="paramname"><em>pHisAcctID</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function sets up "theMessage" so that it is ready to be sent out to the server. If you want to set up a checkServerID command and send it to the server, then you just call this to get the <a class="el" href="class_o_t_message.html">OTMessage</a> object all set up and ready to be sent. returns -1 if error, don't send message. returns 0 if NO error, but still, don't send message. returns 1 if message is sent but there's not request number returns &gt;0 for processInbox, containing the number that was there before processing. returns &gt;0 for nearly everything else, containing the request number itself. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l06178">6178</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// This is all preparatory work to get the various pieces of data together -- only</span>
    <span class="comment">// then can we put those pieces into a message.</span>
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> CONTRACT_ID;
    <a class="code" href="class_o_t_string.html">OTString</a> strNymID, strContractID, strServerID, strNymPublicKey, strAccountID;
    int64_t lRequestNumber = 0;

    theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strNymID);
    theServer.<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strServerID);

    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(strServerID);

    <span class="keywordflow">if</span> (NULL != pAccount)
    {
        pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strAccountID);

        <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
            <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(-1);;
        }
    }
    <span class="comment">// -------------------------------------------------------------------- </span>
    <span class="keywordtype">bool</span> bSendCommand = <span class="keyword">false</span>;
    int64_t lReturnValue = 0;


    <span class="comment">// -------------------------------------------------------------------- </span>
    <span class="comment">// -------------------------------------------------------------------- </span>

    <span class="comment">// THE BIG SWITCH (inside a code block for neatness</span>
    <span class="keywordflow">switch</span>(requestedCommand)
    {

    <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">OTClient::checkServerID</a>) :
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strAuthentKey, strEncryptionKey;

            theNym.<a class="code" href="class_o_t_pseudonym.html#add05942697a8f16ee9259d8cccc271c8">GetPublicAuthKey</a>().<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strAuthentKey   );
            theNym.<a class="code" href="class_o_t_pseudonym.html#a7a7b836bb9e8e0df7b3601f44e1b7220">GetPublicEncrKey</a>().<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strEncryptionKey);

            <span class="comment">// (1) set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;checkServerID&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;          <span class="comment">// Not expected to verify in any way (for this message.) Just mirrored back in the reply.</span>
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a> = strAuthentKey;     <span class="comment">// Authentication public key for this Nym. (That he&#39;s signing this message with...)</span>
            theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strEncryptionKey;  <span class="comment">// Encryption public key for this Nym (to send an encrypted reply back.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>

            <span class="comment">// (2) Sign the Message </span>
            <span class="comment">// When a message is signed, it updates its m_xmlUnsigned contents to</span>
            <span class="comment">// the values in the member variables</span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            <span class="comment">//</span>
            <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
            <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = 1;

            <span class="comment">// ------------------------------------------------------------------------</span>
        }
        <span class="keywordflow">break</span>;
            
    <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">OTClient::createUserAccount</a>):
        {
            <span class="comment">// -----------------------------</span>
            <span class="comment">// Create a new OTDB::StringMap object.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
            <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
            <span class="comment">// --------------------------------------------------------------</span>
            pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
            theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
            pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
            <span class="comment">// --------------------------------------------------------------</span>
            <span class="keywordflow">if</span> (NULL == pMap)
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to load or create a STORED_OBJ_STRING_MAP.\n&quot;</span>,
                __FUNCTION__);        
            <span class="keywordflow">else</span> <span class="comment">// It instantiated.</span>
            {    <span class="comment">// -----------------------------------------------</span>
                <a class="code" href="class_o_t_string.html">OTString</a>       strCredList;
                <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;

                <span class="comment">// Credentials exist already.</span>
                <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0)
                {
                    theNym.<a class="code" href="class_o_t_pseudonym.html#a356d33b203d025ec66a43e23c63c55ed">GetPublicCredentials</a>(strCredList, &amp;theMap);
                }
                <span class="keywordflow">else</span> <span class="comment">// No credentials? Create them, then.</span>
                {
                    <a class="code" href="class_o_t_string.html">OTString</a> strMasterCredID;
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bAddedMaster = theNym.<a class="code" href="class_o_t_pseudonym.html#aca99509bdb4ceb7ff4fdb793998aa794">AddNewMasterCredential</a>(strMasterCredID);

                    <span class="keywordflow">if</span> (bAddedMaster &amp;&amp; strMasterCredID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theNym.<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Adding new keyCredential to master credential: %s\n&quot;</span>,
                            __FUNCTION__, strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theMasterCredID(strMasterCredID);

                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bAddedSubkey = theNym.<a class="code" href="class_o_t_pseudonym.html#a85bd691ffa8d5f066ba04886dccd0d4d">AddNewSubkey</a>(theMasterCredID);

                        <span class="keywordflow">if</span> (bAddedSubkey)
                        {
                            theNym.<a class="code" href="class_o_t_pseudonym.html#af3709c1b5203330b607ca0f0acff9c53">SaveCredentialList</a>();
                            theNym.<a class="code" href="class_o_t_pseudonym.html#a356d33b203d025ec66a43e23c63c55ed">GetPublicCredentials</a>(strCredList, &amp;theMap);
                        }
                        <span class="keywordflow">else</span>
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to add new keyCredential to new Master credential.\n&quot;</span>,
                            __FUNCTION__);
                    }
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to add new master credential (for Nym who doesn&#39;t have one yet.)\n&quot;</span>,
                        __FUNCTION__);
                }
                <span class="comment">// -----------------------------------------------</span>
                <span class="comment">// Serialize the StringMap to a string...</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (strCredList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theMap.size() &gt; 0)) <span class="comment">// Won&#39;t bother if there are zero credentials somehow.</span>
                {
                    std::string str_Encoded     = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessEncoding = (str_Encoded.size() &gt; 0);
                    <span class="keywordflow">if</span> (bSuccessEncoding)
                    {
                        theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strCredList);   <span class="comment">// &lt;========== Success</span>
                        theMessage.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str());  <span class="comment">// Payload contains credentials list, payload2 contains actual credentials.</span>
                    }
                }
            }
            <span class="comment">// ----------------------------------------------</span>
            <span class="keywordflow">if</span> (!theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !theMessage.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to assemble a createUserAccount message: This Nym &quot;</span>
                    <span class="stringliteral">&quot;has no credentials to use for registration. Convert this Nym &quot;</span>
                    <span class="stringliteral">&quot;first to the new credential system, then try again.\n&quot;</span>, __FUNCTION__);
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// ----------------------------------------------</span>
                <span class="comment">// (1) set up member variables</span>
                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;createUserAccount&quot;</span>;
                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;

                <span class="comment">//          theNym.GetPublicKey().GetPublicKey(strNymPublicKey);</span>
                <span class="comment">//          theMessage.m_strNymPublicKey    = strNymPublicKey; // Deprecated. (Credentials are new.)</span>

                <span class="comment">// THIS APPEARS SLIGHTLY ABOVE. Just leaving as a comment</span>
                <span class="comment">// here so it&#39;s not forgotten that this is also happening.</span>
                <span class="comment">//</span>
                <span class="comment">//          theMessage.m_ascPayload.SetString(strCredList);   // &lt;========== Success</span>
                <span class="comment">//          theMessage.m_ascPayload2.Set(str_Encoded.c_str());  // Payload contains credentials list, payload2 contains actual credentials.</span>

                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>

                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
                lReturnValue = 1;
            }
        }

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">OTClient::getRequest</a>):
        {
            <span class="comment">//      OTLog::vOutput(0, &quot;(User has instructed to send a getRequest command to the server...)\n&quot;);</span>

            <span class="comment">// (1) set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getRequest&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;

            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = 1;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="comment">// **************************************************************************************</span>
        <span class="comment">// EVERY COMMAND BELOW THIS POINT (THEY ARE ALL OUTGOING TO THE SERVER) MUST INCLUDE THE</span>
        <span class="comment">// CORRECT REQUEST NUMBER, OR BE REJECTED BY THE SERVER.</span>
        <span class="comment">//</span>
        <span class="comment">// The same commands must also increment the local counter of the request number by calling theNym.IncrementRequestNum</span>
        <span class="comment">// Otherwise it will get out of sync, and future commands will start failing (until it is resynchronized with</span>
        <span class="comment">// a getRequest message to the server, which replies with the latest number. The code on this side that processes</span>
        <span class="comment">// that server reply is already smart enough to update the local nym&#39;s copy of the request number when it is received.</span>
        <span class="comment">// In this way, the client becomes resynchronized and the next command will work again. But it&#39;s better to increment the</span>
        <span class="comment">// counter properly.</span>
        <span class="comment">// PROPERLY == every time you actually get the request number from a nym and use it to make a server request,</span>
        <span class="comment">// then you should therefore also increment that counter. If you call GetCurrentRequestNum AND USE IT WITH THE SERVER,</span>
        <span class="comment">// then make sure you call IncrementRequestNum immediately after. Otherwise future commands will start failing.</span>
        <span class="comment">//</span>
        <span class="comment">// This is all because the server requres a new request number (last one +1) with each request. This is in</span>
        <span class="comment">// order to thwart would-be attackers who cannot break the crypto, but try to capture encrypted messages and</span>
        <span class="comment">// send them to the server twice. Better that new requests requre new request numbers :-)</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821">OTClient::deleteUserAccount</a>:
        {
            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">//      OTLog::vOutput(0, &quot;(User has instructed to send a deleteUserAccount command to the server...)\n&quot;);</span>

            <span class="comment">// (1) set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;deleteUserAccount&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b">OTClient::sendUserMessage</a>: <span class="comment">// SEND USER MESSAGE</span>
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a NymID (for recipient): &quot;</span>);

            <span class="comment">// User input.</span>
            <span class="comment">// I need a second NymID, so I allow the user to enter it here.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID2;
            strNymID2.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="comment">// -----------------------------------</span>

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter recipient&#39;s public key:\n&gt; &quot;</span>);

            <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> theArmoredText;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof - 1.</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0;
                <span class="keywordflow">if</span> (NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin))
                {
                    theArmoredText.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (strlen(decode_buffer)&gt;1);

            <span class="comment">// ----------------------------------------</span>

            decode_buffer[0] = <span class="charliteral">&#39;\0&#39;</span>;
            <a class="code" href="class_o_t_string.html">OTString</a> strPlaintext;

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a plaintext message, terminate with ~ on a new line:\n&gt; &quot;</span>);

            <span class="keywordflow">do</span> {
                fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer), stdin);

                <span class="keywordflow">if</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>)
                {
                    strPlaintext.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

            <span class="comment">// -----------------------------------</span>

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;sendUserMessage&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
            <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pPubkey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPubkey);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theKeyAngel(pPubkey);

            <span class="keywordflow">if</span> (theArmoredText.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; !pPubkey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(theArmoredText))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed setting public key.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strPlaintext.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
                theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pPubkey, strPlaintext) &amp;&amp;
                theEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>))
            {
                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// (Send it)</span>
                bSendCommand = <span class="keyword">true</span>;
                lReturnValue = lRequestNumber;

                <span class="comment">// -----------------------------------</span>
                <span class="comment">// store a copy in the outmail.</span>
                <span class="comment">// (not encrypted, since the Nymfile will be encrypted anyway.</span>
                <span class="comment">//</span>
                <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;

                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);

                pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outmailMessage&quot;</span>;
                pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
                pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
                pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;          
                pMessage-&gt;<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber);

                pMessage-&gt;<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPlaintext);

                pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);     
                pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                theNym.<a class="code" href="class_o_t_pseudonym.html#a908900d7fa217571e2dd3a6c06789a9b">AddOutmail</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outmail&quot;.</span>

                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; extraNym = theNym;
                theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(extraNym);
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed sealing envelope.\n&quot;</span>);
            }   
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871">OTClient::checkUser</a>: <span class="comment">// CHECK USER</span>
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a NymID: &quot;</span>);

            <span class="comment">// User input.</span>
            <span class="comment">// I need a second NymID, so I allow the user to enter it here.</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID2;
            strNymID2.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;checkUser&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="comment">// The standard &quot;contract&quot; key inside the new currency contract must be the same key</span>
        <span class="comment">// used by the Nym who is signing the requests to issue the currency.</span>
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee">OTClient::issueAssetType</a>: <span class="comment">// ISSUE ASSET TYPE</span>
        {               
            <a class="code" href="class_o_t_string.html">OTString</a> strSourceContract;

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter currency contract, terminate with ~ on a new line:\n&gt; &quot;</span>);
            <span class="keywordtype">char</span> decode_buffer[200];

            <span class="keywordflow">do</span> {
                fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer), stdin);

                <span class="keywordflow">if</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>)
                {
                    strSourceContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

            <span class="comment">/*</span>
<span class="comment">            // While debugging, sometimes I just want it to read the source contract directly out of a test file.</span>
<span class="comment">            // So I use this code, instead of the above code, when I am doing that, to set strSourceContract&#39;s value...</span>
<span class="comment">            //</span>
<span class="comment"></span>
<span class="comment">            OTString strTempPath;</span>
<span class="comment">            strTempPath.Format(&quot;%s%s%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(), &quot;sample-contract&quot;, OTLog::PathSeparator(), &quot;tokens.xml&quot;);</span>
<span class="comment">            std::ifstream in(strTempPath.Get(), std::ios::binary);</span>
<span class="comment"></span>
<span class="comment">            std::ifstream in(strTempPath.Get(), std::ios::binary);</span>
<span class="comment"></span>
<span class="comment">            if (in.fail())</span>
<span class="comment">            {</span>
<span class="comment">            OTLog::vError(&quot;Error opening file WHILE DEBUGGING: %s\n&quot;, strTempPath.Get());</span>
<span class="comment">            }</span>
<span class="comment">            OT_ASSERT(!in.fail());</span>
<span class="comment"></span>
<span class="comment">            std::stringstream buffer;</span>
<span class="comment">            buffer &lt;&lt; in.rdbuf();</span>
<span class="comment"></span>
<span class="comment">            std::string contents(buffer.str());</span>
<span class="comment"></span>
<span class="comment">            strSourceContract = contents.c_str();</span>
<span class="comment">            */</span>

            <span class="comment">// -------------------------------------------------------------------</span>

            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;

            <span class="keywordflow">if</span> (theAssetContract.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strSourceContract))
            {
                <span class="comment">// In some places the ID is already set, and I&#39;d verify it here.</span>
                <span class="comment">// But in this place, I am adding it and generating the ID from the string.</span>
                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    newID;
                theAssetContract.<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(newID);    
                theAssetContract.<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(newID); <span class="comment">// probably unnecessary</span>

                <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                <span class="comment">// (1) Set up member variables </span>
                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueAssetType&quot;</span>;
                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                newID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>); <span class="comment">// I&#39;ve calculated the ID, and now put it on the message...</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strAssetContract(theAssetContract);
                theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strAssetContract);

                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;        
                lReturnValue = lRequestNumber;

                <span class="comment">// ------------------------------------ </span>
                <span class="comment">// Save the contract to local storage and add to wallet.</span>

                <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
                <a class="code" href="class_o_t_string.html">OTString</a> strFilename(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());    <span class="comment">// In this case the filename isn&#39;t actually used, since SaveToContractFolder will</span>
                <span class="comment">// handle setting up the filename and overwrite it anyway. But I still prefer to set it</span>
                <span class="comment">// up correctly, rather than pass a blank. I&#39;m just funny like that.</span>

                <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername, 
                    strFilename, theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);

                <span class="comment">// Check the server signature on the contract here. (Perhaps the message is good enough?</span>
                <span class="comment">// After all, the message IS signed by the server and contains the Account.</span>
                <span class="comment">//          if (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract())</span>
                <span class="keywordflow">if</span> (pContract-&gt;LoadContractFromString(strSourceContract) &amp;&amp; pContract-&gt;VerifyContract())
                {
                    <span class="comment">// Next make sure the wallet has this contract on its list...</span>
                    <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = NULL;

                    <span class="keywordflow">if</span> (NULL != (pWallet = m_pWallet))
                    {
                        pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(*pContract); <span class="comment">// this saves both the contract and the wallet.</span>
                        pContract = NULL; <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
                    }
                }
                <span class="comment">// cleanup</span>
                <span class="keywordflow">if</span> (pContract)
                {
                    <span class="keyword">delete</span> pContract;
                    pContract = NULL;
                }
            }       
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="comment">// DONE: This will have to be changed from a simple message, to a transaction,</span>
        <span class="comment">// BECAUSE IT CHANGES ACCOUNT BALANCES, and thus requires balance agreement for all affected accounts!</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374">OTClient::exchangeBasket</a>: <span class="comment">// EXCHANGE BASKET</span>
        {               
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym);

            <a class="code" href="class_o_t_string.html">OTString</a> strBasketInfo, strNymID(USER_ID);
            <a class="code" href="class_o_t_string.html">OTString</a> str_BASKET_CONTRACT_ID, str_MAIN_ACCOUNT_ID, strTemp;

            <span class="comment">// FIRST get the Asset Type ID for the basket</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the basket&#39;s Asset Type ID (aka Contract ID): &quot;</span>);
            str_BASKET_CONTRACT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="comment">// FIRST get the Asset Type ID for the basket</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours for an account that has the same asset type: &quot;</span>);
            str_MAIN_ACCOUNT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MAIN_ACCOUNT_ID(str_MAIN_ACCOUNT_ID);

            <span class="comment">// which direction is the exchange?</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strDirection;
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Are you exchanging in or out? [in]: &quot;</span>);
            strDirection.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bDirection = (strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;in&quot;</span>) || strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;In&quot;</span>));

            <span class="comment">// load up the asset contract</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
            <a class="code" href="class_o_t_string.html">OTString</a> strContractPath(str_BASKET_CONTRACT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(str_BASKET_CONTRACT_ID, strFoldername,
                strContractPath, str_BASKET_CONTRACT_ID);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAssetContract&gt;</a> theAssetContractAngel(*pContract);

            <span class="keywordflow">if</span> (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract()) 
            {
                <span class="comment">// Next load the OTBasket object out of that contract.</span>
                <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;

                <span class="comment">// todo perhaps verify the basket here, even though I just verified the asset contract itself...</span>
                <span class="comment">// Can&#39;t never be too sure.</span>
                <span class="keywordflow">if</span> (pContract-&gt;GetBasketInfo().GetLength() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;GetBasketInfo()))
                {                
                    <span class="comment">// We need a transaction number just to send this thing. Plus, we need a number for</span>
                    <span class="comment">// each sub-account to the basket, as well as the basket&#39;s main account.</span>
                    <span class="comment">// That is: 1 + theBasket.Count() + 1</span>

                    <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &lt; (2 + theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>()))
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Trying to exchange basket: you don&#39;t have enough transaction numbers &quot;</span>
                            <span class="stringliteral">&quot;to perform the exchange.\n&quot;</span>, __FUNCTION__);
                    }
                    <span class="keywordflow">else</span>
                    {
                        int64_t lStoredTransactionNumber=0;
                        <span class="keywordtype">bool</span> bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber); <span class="comment">// this saves</span>

                        <span class="keywordflow">if</span> (bGotTransNum)
                        {
                            <span class="comment">// Create a transaction</span>
                            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = 
                                <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, MAIN_ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>, lStoredTransactionNumber); 

                            <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1332f32813f158436fd58abdddec855c">OTItem::exchangeBasket</a>);

                            <span class="comment">// This pItem is where the Basket Info will be stored. (So it ends up on receipts...)                        </span>
                            pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                            <span class="comment">// ----------------------------------------------------</span>
                            <span class="comment">// GET / LOAD the ACCOUNT / INBOX /OUTBOX for the MAIN ACCOUNT</span>

                            <a class="code" href="class_o_t_account.html">OTAccount</a> * pMainAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(MAIN_ACCOUNT_ID);
                            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMainAccount); <span class="comment">// todo. better than nothing for now.</span>

                            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pMainAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
                            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pMainAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);

                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
                            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

                            <span class="keywordflow">if</span> (NULL == pInbox)
                            {
                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);

                                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                            }
                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
                            {
                                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);

                                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                            }
                            <span class="comment">// Set up the Request Basket! ------------------------------</span>
                            <span class="keywordflow">else</span>
                            {
                                int32_t nTransferMultiple = 0;

                                <a class="code" href="class_o_t_basket.html">OTBasket</a> theRequestBasket(theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(), theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>());

                                theRequestBasket.<a class="code" href="class_o_t_basket.html#a75757d74f9e52043611a7ac6bedcb362">SetExchangingIn</a>(bDirection);
                                <span class="comment">// --------------------------------------------------</span>
                                <span class="comment">// Show the minimum transfer amount to the customer and ask him to choose a multiple for the transfer</span>
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;The minimum transfer amount for this basket is %lld. You may only exchange in multiples of it.\n&quot;</span>
                                    <span class="stringliteral">&quot;Choose any multiple [1]: &quot;</span>, theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>());
                                strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                                nTransferMultiple = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); 
                                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                                <span class="keywordflow">if</span> (nTransferMultiple &lt;= 0)
                                    nTransferMultiple = 1;

                                theRequestBasket.SetTransferMultiple(nTransferMultiple);

                                <span class="comment">// NOTE: I&#39;m not checking this call for success...</span>
                                <span class="comment">// But, I DID check the count beforehand, and I know there are enough numbers.</span>
                                <span class="comment">//</span>
                                int64_t lClosingTransactionNo = 0;
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lClosingTransactionNo); <span class="comment">// this saves</span>

                                theRequestBasket.SetClosingNum(lClosingTransactionNo); <span class="comment">// For the basketReceipt (Closing Transaction Num) for main account.</span>

                                <span class="comment">// -----------------------------------------------------------</span>

                                <span class="comment">// Then loop through the BasketItems... </span>
                                <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
                                {
                                    <span class="comment">// pItem-&gt; contains SUB_CONTRACT_ID, SUB_ACCOUNT_ID, and lMinimumTransferAmount.</span>
                                    <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);

                                    <span class="comment">// ...and for each one, ask the user to enter his corresponding account ID.</span>
                                    <span class="comment">// IT MUST BE THE SAME ASSET TYPE AS THE BASKET ITEM, SO SHOW USER THE ASSET ID!</span>
                                    <a class="code" href="class_o_t_string.html">OTString</a> str_SUB_CONTRACT_ID(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>);
                                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nBasket currency type (Asset Type) #%d is:\n%s\n\nPlease enter your own &quot;</span>
                                        <span class="stringliteral">&quot;existing Account ID of the same asset type: &quot;</span>, 
                                        i+1, str_SUB_CONTRACT_ID.Get());
                                    <a class="code" href="class_o_t_string.html">OTString</a> str_TEMP_ACCOUNT_ID;
                                    str_TEMP_ACCOUNT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> TEMP_ACCOUNT_ID(str_TEMP_ACCOUNT_ID);


                                    <span class="comment">// TODO (later) Load up the user&#39;s account at this point to make sure it even exists.</span>
                                    <span class="comment">// Then check the asset type on that account against pItem-&gt;SUB_CONTRACT_ID and make sure they match.</span>
                                    <span class="comment">// The server will definitely have to do this anyway. The client can skip it, but the command</span>
                                    <span class="comment">// won&#39;t work unless the user enters this data properly. UI will have to do a popup here if something is wrong.</span>


                                    <span class="comment">// As this is happening, we&#39;re creating ANOTHER basket object (theRequestBasket), with items that </span>
                                    <span class="comment">// contain MY account IDs. </span>
                                    <span class="comment">// The minimum transfer amounts on the new basket are set based on a multiple of the original.</span>
                                    <span class="comment">// (I already set the multiple just above this loop.)</span>

                                    <span class="comment">// NOTE: I&#39;m not checking this call for success...</span>
                                    <span class="comment">// But, I DID check the count beforehand, and I know there are enough numbers.</span>
                                    <span class="comment">//</span>
                                    int64_t lSubClosingTransactionNo = 0; <span class="comment">// For the basketReceipt (closing transaction num) for the sub account.</span>
                                    theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lSubClosingTransactionNo); <span class="comment">// this saves</span>
                                    <span class="comment">// -------------------------------------------------------------------------------------</span>
                                    theRequestBasket.AddRequestSubContract(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>, TEMP_ACCOUNT_ID, lSubClosingTransactionNo);
                                }

                                <span class="comment">// Make sure the server knows where to put my new basket currency once the exchange is done.</span>
                                theRequestBasket.SetRequestAccountID(MAIN_ACCOUNT_ID);

                                <span class="comment">// Export the OTBasket object into a string, add it as</span>
                                <span class="comment">// a payload on my request, and send to server.</span>
                                theRequestBasket.SignContract(theNym);
                                theRequestBasket.SaveContractRaw(strBasketInfo);

                                <span class="comment">//***********************************************************************</span>

                                pItem-&gt;SetAttachment(strBasketInfo);

                                <span class="comment">// sign the item. save it.</span>
                                <span class="comment">//</span>
                                pItem-&gt;SignContract(theNym);
                                pItem-&gt;SaveContract();

                                <span class="comment">//***********************************************************************</span>

                                <span class="comment">// ---------------------------------------------</span>
                                <span class="comment">// BALANCE AGREEMENT!</span>
                                <span class="comment">//</span>
                                <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                                <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(0, <span class="comment">// Change in balance is 0. (The accounts will all be changed, </span>
                                    *pTransaction, theNym, *pMainAccount, *pOutbox); <span class="comment">// but basketReceipts will be used to account for it.) </span>

                                <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                                <span class="comment">// ---------------------------------------------</span>

                                <span class="comment">// sign the transaction</span>
                                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                <span class="comment">// set up the ledger</span>
                                <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, MAIN_ACCOUNT_ID, SERVER_ID);
                                theLedger.GenerateLedger(MAIN_ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                                theLedger.AddTransaction(*pTransaction);

                                <span class="comment">// sign the ledger</span>
                                theLedger.SignContract(theNym);
                                theLedger.SaveContract();

                                <span class="comment">// extract the ledger in ascii-armored form</span>
                                <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                                <span class="comment">// Encoding...</span>
                                ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);


                                <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
                                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                                theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                                <span class="comment">// (1) Set up member variables </span>
                                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                                theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                                theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_MAIN_ACCOUNT_ID;
                                theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                                <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                                <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);

                                <span class="keywordflow">if</span> (bNymboxHash)
                                    NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                                <span class="keywordflow">else</span>
                                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                                    str_server.c_str());

                                <span class="comment">// (2) Sign the Message </span>
                                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                bSendCommand = <span class="keyword">true</span>;
                                lReturnValue = lRequestNumber;                            
                            } <span class="comment">// Inbox loaded.</span>
                        } <span class="comment">// successfully got first transaction number.</span>
                        <span class="keywordflow">else</span> 
                        {
                            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;SUPPOSEDLY transaction numbers were available, but the call failed...\n&quot;</span>);
                        }

                    } <span class="comment">// theNym apparently has enough transaction numbers to exchange the basket.</span>

                    <span class="comment">// ----------------------------------------------------------------</span>

                } <span class="comment">// loaded Basket Info from string.</span>
                <span class="keywordflow">else</span> {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error loading basket info from asset contract. Are you SURE this is a basket currency?\n&quot;</span>);
                }
            }
            <span class="keywordflow">else</span> {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Failure loading or verifying %s\n&quot;</span>, strContractPath.Get());
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3">OTClient::issueBasket</a>: <span class="comment">// ISSUE BASKET</span>
        {               
            <a class="code" href="class_o_t_string.html">OTString</a> strTemp, strBasketInfo;

            <span class="comment">// Collect NUMBER OF CONTRACTS for the basket.</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many different asset types will compose this new basket? [2]: &quot;</span>);
            strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            int32_t nBasketCount = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keywordflow">if</span> (0 &gt;= nBasketCount)
                nBasketCount = 2;

            <span class="comment">// Collect the MINIMUM TRANSFER AMOUNT for the basket. Default 100.</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;If your basket has a minimum transfer amount of 100, you might have 2 or 3 sub-currencies,\n&quot;</span>
                <span class="stringliteral">&quot;with the first being a minimum of 2 gold, the second being a minimum of 50 dollars, and the\n&quot;</span>
                <span class="stringliteral">&quot;third being a minimum of 30 silver. In this example, 100 units of the basket currency is\n&quot;</span>
                <span class="stringliteral">&quot;transferrable in or out of the basket currency, in return for 2 gold, 50 dollars, and 30 silver.\n&quot;</span>
                <span class="stringliteral">&quot;As those are only the *minimum* amounts, you could also transfer (in or out) in *any* multiple of\n&quot;</span>
                <span class="stringliteral">&quot;those numbers.\n\n&quot;</span>);
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the minimum transfer amount for the basket currency itself? [100]: &quot;</span>);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            int64_t lMinimumTransferAmount = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keywordflow">if</span> (0 == lMinimumTransferAmount)
                lMinimumTransferAmount = 100;

            <span class="comment">// ADD THESE VALUES TO A BASKET OBJECT HERE SO I CAN RE-USE lMinimumTransferAmount for the loop below.</span>
            <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket(nBasketCount, lMinimumTransferAmount);

            <span class="comment">// Collect all the contract IDs for the above contracts</span>
            <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nBasketCount; i++)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Enter contract ID # %d: &quot;</span>, i+1);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SUB_CONTRACT_ID(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// After each ID, collect the minimum transfer amount for EACH contract.</span>
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter minimum transfer amount for that asset type: &quot;</span>);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                lMinimumTransferAmount = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// ADD THE CONTRACT ID TO A LIST TO BE SENT TO THE SERVER.</span>
                <span class="comment">// ADD THE MINIMUM TRANSFER AMOUNT TO THE SAME OBJECT</span>
                theBasket.<a class="code" href="class_o_t_basket.html#ae0a4fc1320ad66dd613b70cbc8e6a32b">AddSubContract</a>(SUB_CONTRACT_ID, lMinimumTransferAmount);

                <span class="comment">// The object storing these should also have a space for storing</span>
                <span class="comment">// the account ID that will go with each one. The server will add</span>
                <span class="comment">// the Account ID when the reserve accounts are generated.</span>
                <span class="comment">//</span>
                <span class="comment">// (The basket issuer account will contain sub-accounts for the</span>
                <span class="comment">// reserves, which are stored there and 100% redeemable at all times.)</span>
            }

            <span class="comment">// Export the OTBasket object into a string, add it as</span>
            <span class="comment">// a payload on message, and send to server.</span>
            theBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
            theBasket.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBasketInfo);

            <span class="comment">// The user signs and saves the contract, but once the server gets it,</span>
            <span class="comment">// the server releases signatures and signs it, calculating the hash from the result,</span>
            <span class="comment">// in order to form the ID.</span>
            <span class="comment">//</span>
            <span class="comment">// The result is the same as any other currency contract, but with the server&#39;s signature</span>
            <span class="comment">// on it (and thus it must store the server&#39;s public key).  The server handles all</span>
            <span class="comment">// transactions in and out of the basket currency based upon the rules set up by the user.</span>
            <span class="comment">//</span>
            <span class="comment">// The user who created the currency has no more control over it. The server reserves the</span>
            <span class="comment">// right to exchange out to the various users and close the basket.</span>

            <span class="comment">// AT SOME POINT, strBasketInfo has been populated with the relevant data.</span>

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueBasket&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strBasketInfo);

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;            
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13">OTClient::createAccount</a>: <span class="comment">// CREATE ACCOUNT</span>
        {   
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type (contract ID): &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a from account</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
            strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;createAccount&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;<span class="comment">// the hash of the contract is the AssetID</span>

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec">OTClient::notarizeTransfer</a>: <span class="comment">// NOTARIZE TRANSFER</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (FROM acct): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to transfer without a &#39;FROM&#39; account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
                CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// -----------------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcct;

            <span class="keywordflow">if</span> (NULL == pHisAcctID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s asset account ID (no partial IDs here): &quot;</span>);

                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strRecipientAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strRecipientAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);            
            }
            <span class="keywordflow">else</span>
            {
                pHisAcctID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientAcct);            
            }

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_ACCT_ID(strRecipientAcct);

            <span class="comment">// ----------------------------------------------   </span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
            <span class="keywordflow">if</span> (0 == lTransactionAmount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need an amount</span>
                strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            }

            <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
                (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
            <span class="comment">// ----------------------------------------------</span>

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    ACCT_FROM_ID(strFromAcct), USER_ID(theNym);

            int64_t lStoredTransactionNumber=0;
            <span class="keywordtype">bool</span> bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber); <span class="comment">// this saves</span>

            <span class="comment">//      int32_t GetTransactionNumCount(const OTIdentifier &amp; theServerID); // count</span>

            <span class="keywordflow">if</span> (bGotTransNum)
            {
                <span class="comment">// Create a transaction</span>
                <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>, lStoredTransactionNumber); 

                <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>, &amp;HIS_ACCT_ID);

                pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);

                <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Just testing the notes...blah blah blah blah blah blah&quot;</span>);
                pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

                <span class="comment">// sign the item</span>
                pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                <span class="comment">// ---------------------------------------------</span>

                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);

                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

                <span class="keywordflow">if</span> (NULL == pInbox)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);

                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
                }

                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);

                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
                }
                <span class="comment">// BALANCE AGREEMENT </span>

                <span class="keywordflow">else</span> 
                {
                    <span class="comment">// Need to setup a dummy outbox transaction (to mimic the one that will be on the server side when this pending transaction is actually put into the real outbox.)</span>
                    <span class="comment">// When the server adds its own, and then compares the two, they should both show the same pending transaction, in order for this balance agreement to be valid..</span>
                    <span class="comment">// Otherwise the server would have to refuse it for being inaccurate (server can&#39;t sign something inaccurate!) So I throw a dummy on there before generating balance statement.</span>

                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pOutboxTransaction  = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pOutbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
                        1<span class="comment">/*todo pick some number that everyone agrees doesn&#39;t matter, like 1. The referring-to is the important </span>
<span class="comment">                         number in this case, and perhaps server should update this value too before signing and returning.*/</span>); <span class="comment">// todo use a constant instead of &#39;1&#39;</span>

                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOutboxTransaction); <span class="comment">// for now.</span>

                    <a class="code" href="class_o_t_string.html">OTString</a> strItem(*pItem);
                    pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strItem); <span class="comment">// So the GenerateBalanceStatement function below can get the other info off this item (like amount, etc)</span>
                    pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());

                    <span class="comment">//              pOutboxTransaction-&gt;SignContract(theNym);   // Unnecessary to sign/save, since this is just a dummy data for verification</span>
                    <span class="comment">//              pOutboxTransaction-&gt;SaveContract();         // purposes, and isn&#39;t being serialized anywhere.</span>

                    pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pOutboxTransaction);  <span class="comment">// no need to cleanup pOutboxTransaction since pOutbox will handle it now.</span>

                    <span class="comment">// ---------------------------------------------</span>

                    <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(atol(strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())*(-1), *pTransaction, theNym, *pAccount, *pOutbox);               

                    <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                    <span class="comment">// ---------------------------------------------</span>


                    <span class="comment">// sign the transaction</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();


                    <span class="comment">// set up the ledger</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
                    theLedger.GenerateLedger(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                    theLedger.AddTransaction(*pTransaction);

                    <span class="comment">// sign the ledger</span>
                    theLedger.SignContract(theNym);
                    theLedger.SaveContract();

                    <span class="comment">// extract the ledger in ascii-armored form</span>
                    <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                    <span class="comment">// Encoding...</span>
                    ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);


                    <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                    theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                    theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                    theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                    <span class="comment">// (1) Set up member variables </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                    theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                    theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                    theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                    theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                    theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                    <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                    <span class="keywordflow">if</span> (bNymboxHash)
                        NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                        str_server.c_str());

                    <span class="comment">// (2) Sign the Message </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                    theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    bSendCommand = <span class="keyword">true</span>;
                    lReturnValue = lRequestNumber;
                }

            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No transaction numbers were available. Suggest requesting the server for one.\n&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f">OTClient::setAssetName</a>: <span class="comment">// SET ASSET CONTRACT NAME (wallet label only)</span>
        {   
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Type ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a server ID</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strContractID;
            strContractID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetID(strContractID);

            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pTargetContract = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a4daee51036b24439e687383a6c66c6f7">GetAssetContract</a>(theTargetID);

            <span class="keywordflow">if</span> (NULL != pTargetContract)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that asset type: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a name</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
                strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                pTargetContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);

                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the server&#39;s name is stored here.</span>
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Asset Contract found with that ID. Try &#39;load&#39;.\n&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2">OTClient::setServerName</a>: <span class="comment">// SET SERVER CONTRACT NAME (wallet label only)</span>
        {   
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a Server ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a server ID</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strContractID;
            strContractID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetID(strContractID);

            <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pTargetContract = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(theTargetID);

            <span class="keywordflow">if</span> (NULL != pTargetContract)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that transaction server: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a name</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
                strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                pTargetContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);

                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the server&#39;s name is stored here.</span>
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Server Contract found with that ID. Try &#39;load&#39;.\n&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5">OTClient::setNymName</a>: <span class="comment">// SET NYM NAME (wallet label only)</span>
        {   
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a Nym ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a nym ID</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID;
            strNymID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetNymID(strNymID);

            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pTargetNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(theTargetNymID);

            <span class="keywordflow">if</span> (NULL != pTargetNym)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that Nym: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a name</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
                strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <a class="code" href="class_o_t_string.html">OTString</a> strOldName(pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a42e63697c3c3b1bdb526ee7990a9c0e7">GetNymName</a>()); <span class="comment">// just in case.</span>

                pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strNewName);

                <span class="keywordflow">if</span> (pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(theNym)) <span class="comment">// theNym is signer on this file.</span>
                {
                    m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the nym&#39;s name is stored here, too.</span>
                }
                <span class="keywordflow">else</span>
                    pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strOldName);
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Nym found with that ID. Try &#39;load&#39;.\n&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9">OTClient::setAccountName</a>: <span class="comment">// SET ACCOUNT NAME (wallet label only)</span>
        {   
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset account ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need an account</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
            strAcctID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strAcctID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                <span class="keywordflow">return</span> (-1);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID(strAcctID);

            <a class="code" href="class_o_t_account.html">OTAccount</a> * pTheAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);

            <span class="keywordflow">if</span> (NULL != pTheAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that Account: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a name</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
                strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);
                pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();

                pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pTheAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();

                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No account found with that ID. Try &#39;load&#39;.\n&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a">OTClient::getNymbox</a>: <span class="comment">// GET NYMBOX</span>
        {           

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getNymbox&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76">OTClient::getInbox</a>: <span class="comment">// GET INBOX</span>
        {           
            <span class="comment">// --------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to get its INBOX): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ( (pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL )
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download Inbox without an account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;

            pAccount-&gt;GetIdentifier(theAccountID);
            theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getInbox&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113">OTClient::getOutbox</a>: <span class="comment">// GET OUTBOX</span>
        {   
            <span class="comment">// --------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to get its OUTBOX): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download outbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;

            pAccount-&gt;GetIdentifier(theAccountID);
            theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getOutbox&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;
        }


        <span class="comment">/*</span>
<span class="comment">        bool OTClient::ProcessUserCommand(OTClient::OT_CLIENT_CMD_TYPE requestedCommand,</span>
<span class="comment">        OTMessage &amp; theMessage,</span>
<span class="comment">        OTPseudonym &amp; theNym,</span>
<span class="comment">        //                                OTAssetContract &amp; theContract,</span>
<span class="comment">        OTServerContract &amp; theServer,</span>
<span class="comment">        OTAccount * pAccount=NULL,</span>
<span class="comment">        int64_t lTransactionAmount=0,</span>
<span class="comment">        OTAssetContract * pMyAssetContract=NULL,</span>
<span class="comment">        OTIdentifier * pHisNymID=NULL,</span>
<span class="comment">        OTIdentifier * pHisAcctID=NULL)</span>
<span class="comment">        {</span>
<span class="comment">        // This is all preparatory work to get the various pieces of data together -- only</span>
<span class="comment">        // then can we put those pieces into a message.</span>
<span class="comment">        OTIdentifier CONTRACT_ID;</span>
<span class="comment">        OTString strNymID, strContractID, strServerID, strNymPublicKey, strAccountID;</span>
<span class="comment">        int64_t lRequestNumber = 0;</span>
<span class="comment"></span>
<span class="comment">        theNym.GetIdentifier(strNymID);</span>
<span class="comment">        theServer.GetIdentifier(strServerID);</span>
<span class="comment"></span>
<span class="comment">        const OTIdentifier SERVER_ID(strServerID);</span>
<span class="comment">        */</span>

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="comment">// This is called by the command line user.</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00">OTClient::processEntireNymbox</a>: <span class="comment">// PROCESS ENTIRE NYMBOX</span>
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);

            <span class="comment">// Load up the appropriate Nymbox... </span>
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(MY_NYM_ID, MY_NYM_ID, SERVER_ID);

            <span class="keywordtype">bool</span> bSuccess           = <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bLoadedNymbox      = theNymbox.LoadNymbox();
            <span class="keywordtype">bool</span> bVerifiedNymbox    = bLoadedNymbox ? theNymbox.VerifyAccount(theNym) : <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bIsEmpty           = theNymbox.GetTransactionCount() &lt; 1;

            <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedNymbox)
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed loading Nymbox: %s \n&quot;</span>,
                strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bVerifiedNymbox)
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed verifying Nymbox: %s \n&quot;</span>,
                strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bIsEmpty)
                bSuccess = <a class="code" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">AcceptEntireNymbox</a>(theNymbox, SERVER_ID, theServer, theNym, theMessage);
            <span class="comment">// -----------------</span>

            <span class="keywordflow">if</span> (!bSuccess)
            {
                <span class="keywordflow">if</span> (bIsEmpty)
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Nymbox (%s) is empty (so, skipping processNymbox.)\n&quot;</span>,
                    strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed trying to accept the entire Nymbox.\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="comment">// This is called by AcceptEntireNymbox().</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTClient::processNymbox</a>: <span class="comment">// PROCESS NYMBOX</span>
        {           
            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;processNymbox&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> EXISTING_NYMBOX_HASH;
            <span class="keyword">const</span> std::string str_server_id(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = theNym.GetNymboxHash(str_server_id, EXISTING_NYMBOX_HASH);

            <span class="keywordflow">if</span> (bSuccess)
                EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="comment">// This is called by the user of the command line utility.</span>
        <span class="comment">//</span>
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222">OTClient::processEntireInbox</a>: <span class="comment">// PROCESS ENTIRE INBOX</span>
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);

            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to PROCESS its INBOX): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL )
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to process inbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ------------------------------------</span>

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
            pAccount-&gt;GetIdentifier(theAccountID);

            <span class="comment">// ----------------------------------------------------</span>
            <span class="comment">// Load up the appropriate Inbox... </span>
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(MY_NYM_ID, theAccountID, SERVER_ID);

            <span class="keywordtype">bool</span> bLoadedInbox   = theInbox.LoadInbox();

            <span class="keywordtype">bool</span> bVerifiedInbox = (bLoadedInbox ? theInbox.VerifyAccount(theNym) : <span class="keyword">false</span>);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            <span class="comment">// (1) Set up member variables </span>
            <span class="keywordtype">bool</span> bSuccess = (bLoadedInbox &amp;&amp; 
                bVerifiedInbox &amp;&amp; 
                <a class="code" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">AcceptEntireInbox</a>(theInbox, SERVER_ID, theServer, theNym, theMessage, *pAccount));
            <span class="comment">// -----------------        </span>

            <span class="keywordflow">if</span> (bSuccess)
            {
                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::processEntireInbox: Failure Inbox: Loading (%s), verifying (%s), or accepting (%s) entire Inbox.\n&quot;</span>,
                    bLoadedInbox ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>, bVerifiedInbox ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>, bSuccess ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>);
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="comment">// This is called by AcceptEntireInbox(). </span>
        <span class="comment">//</span>
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTClient::processInbox</a>: <span class="comment">// PROCESS INBOX</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to PROCESS its INBOX): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to process inbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;

            pAccount-&gt;GetIdentifier(theAccountID);
            theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  


            <span class="comment">// Normally processInbox command is sent with a transaction ledger</span>
            <span class="comment">// in the payload, accepting or rejecting various transactions in</span>
            <span class="comment">// my inbox.</span>
            <span class="comment">// If pAccount was passed in, that means somewhere else in the code</span>
            <span class="comment">// a ledger is being added to this message after this point, and it</span>
            <span class="comment">// is being re-signed and sent out.</span>
            <span class="comment">// That&#39;s why you don&#39;t see a ledger being constructed and added to</span>
            <span class="comment">// the payload here. Because it&#39;s being done somewhere else, and that</span>
            <span class="comment">// same place is what passed the account pointer in here.</span>
            <span class="comment">// I only put this block here for now because I&#39;d rather have it with</span>
            <span class="comment">// all the others.</span>


            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;processInbox&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
            <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

            <span class="keywordflow">if</span> (bNymboxHash)
                NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                str_server.c_str());

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }

        <span class="comment">// ------------------------------------------------------------------------</span>


        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06">OTClient::getAccount</a>: <span class="comment">// GET ACCOUNT</span>
        {   
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to download its intermediary file): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download account without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;

            pAccount-&gt;GetIdentifier(theAccountID);
            theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  


            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getAccount&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }

        <span class="comment">// ------------------------------------------------------------------------</span>


        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c">OTClient::getContract</a>: <span class="comment">// GET CONTRACT</span>
        {   
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need an account</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
            strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strAssetID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                <span class="keywordflow">return</span> (-1);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getContract&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }

        <span class="comment">// ------------------------------------------------------------------------</span>


        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4">OTClient::getMint</a>: <span class="comment">// GET MINT</span>
        {   
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type ID: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need an account</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
            strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strAssetID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                <span class="keywordflow">return</span> (-1);

            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMint&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }


        <span class="comment">// ------------------------------------------------------------------------</span>



        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602">OTClient::notarizeDeposit</a>: <span class="comment">// NOTARIZE DEPOSIT</span>
        {   
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID to deposit your tokens to: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit tokens without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);

            <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, CONTRACT_ID);

            <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();

            int64_t lStoredTransactionNumber=0;
            <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;

            <span class="comment">// ---------------------------------------------</span>

            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(theNym);
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(theNym);

            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

            <span class="keywordflow">if</span> (NULL == pInbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">if</span> (NULL == pOutbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            bGotTransNum = theNym.GetNextTransactionNum(theNym, strServerID, lStoredTransactionNumber);
            <span class="keywordflow">if</span> (!bGotTransNum)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">if</span> (!pServerNym)
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                <span class="keywordflow">break</span>;
            }

            <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

            <span class="comment">// Create a transaction</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 

            <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);

            <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cash, please!&quot;</span>);
            pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many tokens would you like to deposit? &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strTokenCount;
            strTokenCount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            <span class="keyword">const</span> int32_t nTokenCount = atoi(strTokenCount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> theNymAsOwner(theNym), theServerNymAsOwner(*pServerNym);

            <span class="keywordflow">for</span> (int32_t nTokenIndex = 1; nTokenIndex &lt;= nTokenCount; nTokenIndex++)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Please enter plaintext token # %d; terminate with ~ on a new line:\n&gt; &quot;</span>, nTokenIndex);
                <a class="code" href="class_o_t_string.html">OTString</a> strToken;
                <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

                <span class="keywordflow">do</span> {
                    decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                    <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                        (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                    {
                        strToken.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <span class="keywordflow">break</span>;
                    }

                } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

                <span class="comment">// Create the relevant token request with same server/asset ID as the purse.</span>
                <span class="comment">// the purse does NOT own the token at this point. the token&#39;s constructor</span>
                <span class="comment">// just uses it to copy some IDs, since they must match.</span>
                <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ac758de04ed60991098005a7ac9578d71">OTToken::TokenFactory</a>(strToken, thePurse);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);

                <span class="keywordflow">if</span> (NULL != pToken) <span class="comment">// TODO verify the token contract</span>
                {
                    <span class="comment">// TODO need 2-recipient envelopes. My request to the server is encrypted to the server&#39;s nym,</span>
                    <span class="comment">// but it should be encrypted to my Nym also, so both have access to decrypt it.</span>

                    <span class="comment">// Now the token is ready, let&#39;s add it to a purse</span>
                    <span class="comment">// By pushing pToken into thePurse with *pServerNym, I encrypt it to pServerNym.</span>
                    <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(theNymAsOwner, theServerNymAsOwner))
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error re-assigning ownership of token (to server.)\n&quot;</span>);
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>;
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Success re-assigning ownership of token (to server.)\n&quot;</span>);

                        bSuccess = <span class="keyword">true</span>;

                        pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                        pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                        pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        thePurse.Push(theServerNymAsOwner, *pToken);

                        int64_t lTemp = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
                        pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTemp + pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>());
                    }
                }
                <span class="keywordflow">else</span> 
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading token from string.\n&quot;</span>);
                }
            } <span class="comment">// for</span>

            <span class="keywordflow">if</span> (bSuccess)
            {
                thePurse.SignContract(theNym);
                thePurse.SaveContract(); <span class="comment">// I think this one is unnecessary.</span>

                <span class="comment">// Save the purse into a string...</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
                thePurse.SaveContractRaw(strPurse);

                <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
                pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>

                <span class="comment">// sign the item</span>
                pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                <span class="comment">// ---------------------------------------------</span>
                <span class="comment">// BALANCE AGREEMENT</span>

                <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), *pTransaction, theNym, *pAccount, *pOutbox);

                <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                <span class="comment">// ---------------------------------------------</span>

                <span class="comment">// sign the transaction</span>
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// set up the ledger</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
                theLedger.GenerateLedger(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                theLedger.AddTransaction(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>

                <span class="comment">// sign the ledger</span>
                theLedger.SignContract(theNym);
                theLedger.SaveContract();

                <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
                <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger); <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                <span class="comment">// (1) Set up member variables </span>
                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                <span class="keywordflow">if</span> (bNymboxHash)
                    NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                    str_server.c_str());

                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
                lReturnValue = lRequestNumber;

            } <span class="comment">// bSuccess</span>
            <span class="keywordflow">else</span> 
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                                </span>

                <span class="keyword">delete</span> pItem;       pItem = NULL;
                <span class="keyword">delete</span> pTransaction;pTransaction = NULL;
            }           
        }

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506">OTClient::notarizePurse</a>: <span class="comment">// NOTARIZE PURSE (deposit)</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ---------------------------------------------------------</span>
            <span class="comment">//</span>
            <span class="comment">// &quot;from acct&quot; is the acct we are depositing this cash to. aka MyAcct.</span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);

            <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, CONTRACT_ID);

            <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();

            <span class="comment">// ---------------------------------------------</span>

            <a class="code" href="class_o_t_purse.html">OTPurse</a> theSourcePurse(thePurse);

            <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID;

            <span class="keywordtype">bool</span> bUseThePurseInStorage = <span class="keyword">false</span>; <span class="comment">// deposit the purse stored in local storage, versus one supplied on stdin.</span>

            <span class="comment">// If no asset contract was passed in, then --mypurse was not specified. Therefore,</span>
            <span class="comment">// we can get the purse from the user, and verify that it has the same asset type ID</span>
            <span class="comment">// as pAccount does. (No need to ask for the type.)</span>
            <span class="comment">//</span>
            <span class="comment">// But if an asset contract WAS passed in, then we will assume (for now) that the purse</span>
            <span class="comment">// from local storage will be used, of that same type, and thus no need to ask for the type.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (NULL == pMyAssetContract)
            {
                bUseThePurseInStorage = <span class="keyword">false</span>;
                <a class="code" href="class_o_t_string.html">OTString</a> strSourcePurse;

                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a plaintext purse (of the same asset type as the account), \n&quot;</span>
                    <span class="stringliteral">&quot;and terminate with a ~ (tilde character) on a new line:\n&gt; &quot;</span>);
                <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

                <span class="keywordflow">do</span> {
                    decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                    <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                        (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                    {
                        strSourcePurse.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <span class="keywordflow">break</span>;
                    }

                } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

                <span class="keywordflow">if</span> (<span class="keyword">false</span> == theSourcePurse.LoadContractFromString(strSourcePurse))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failure trying to load purse from string provided by user.\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }

                <span class="comment">// todo verify signature?</span>

                theSourcePurse.GetAssetID().GetString(strAssetTypeID);
            }
            <span class="keywordflow">else</span>
            {
                bUseThePurseInStorage = <span class="keyword">true</span>;
                pMyAssetContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strAssetTypeID);

                <span class="keywordtype">bool</span> bLoadedSourcePurse = theSourcePurse.LoadPurse(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedSourcePurse)
                {
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Deposit purse: Failure trying to load purse from local storage:\n&quot;</span>
                        <span class="stringliteral">&quot;Server %s  Nym %s  Asset Type %s\n&quot;</span>,
                        strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="keywordflow">return</span> (-1);
                }
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;WARNING: This operation is very low-level. Once you deposit the purse in local storage,\n&quot;</span>
                    <span class="stringliteral">&quot;you need to erase the purse file from local storage, since the tokens within it are\n&quot;</span>
                    <span class="stringliteral">&quot;all spent. (Otherwise, when you withdraw again, good tokens would be mixed in with\n&quot;</span>
                    <span class="stringliteral">&quot;the spent ones, and then you&#39;ll have to sit there depositing them one-by-one, in order\n&quot;</span>
                    <span class="stringliteral">&quot;to sort it all out.\n (So just use the GUI and save yourself the trouble.)\n\n&quot;</span>
                    <span class="stringliteral">&quot;Deposit purse: using purse from local storage.\n Server %s  Nym %s  Asset Type %s\n&quot;</span>,
                    strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                theSourcePurse.GetAssetID().GetString(strAssetTypeID);
            }

            <span class="comment">// By this point, theSourcePurse is DEFINITELY good,</span>
            <span class="comment">// and strAssetTypeID contains its ID. </span>
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ASSET_TYPE_ID(strAssetTypeID);

            <span class="keywordflow">if</span> (ASSET_TYPE_ID != CONTRACT_ID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Asset ID on purse didn&#39;t match asset ID on account. \n&quot;</span>
                    <span class="stringliteral">&quot;Try: --myacct ACCT_ID  (to specify a different account.)\n&quot;</span>
                    <span class="stringliteral">&quot;To use the purse in local storage, try:  --mypurse ASSET_TYPE_ID\n&quot;</span>
                    <span class="stringliteral">&quot;FYI, if you PREFER to provide the purse from user input, OT *will* ask you to\n&quot;</span>
                    <span class="stringliteral">&quot;input a purse when doing this, just as long as --mypurse is NOT provided. (And\n&quot;</span>
                    <span class="stringliteral">&quot;that includes the defaultmypurse value stored in ~/.ot/command-line-ot.opt)\n\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// By this point, I have theSourcePurse loaded, whether from local storage or from </span>
            <span class="comment">// the command-line, and I know that it has the same asset type as pAccount.</span>
            <span class="comment">//</span>
            <span class="comment">// ----------------------------------------------------------</span>

            int64_t lStoredTransactionNumber=0;
            <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;

            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(theNym);
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(theNym);

            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

            <span class="keywordflow">if</span> (NULL == pInbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">if</span> (NULL == pOutbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            bGotTransNum = theNym.GetNextTransactionNum(theNym, strServerID, lStoredTransactionNumber);
            <span class="keywordflow">if</span> (!bGotTransNum)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">if</span> (!pServerNym)
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                <span class="keywordflow">break</span>;
            }

            <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

            <span class="comment">// Create a transaction</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 

            <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);

            <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cash, please!&quot;</span>);
            pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

            <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> theNymAsOwner(theNym), theServerNymAsOwner(*pServerNym);

            <span class="keywordflow">while</span> (!theSourcePurse.IsEmpty()) 
            {
                <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = theSourcePurse.Pop(theNym);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);

                <span class="keywordflow">if</span> (pToken)
                {
                    <span class="comment">// TODO need 2-recipient envelopes. My request to the server is encrypted to the server&#39;s nym,</span>
                    <span class="comment">// but it should be encrypted to my Nym also, so both have access to decrypt it.</span>
                    <span class="comment">// TODO: AHH OR I could just put a copy of everything into a SINGLE-recipient envelope made out to ME!!</span>
                    <span class="comment">//</span>

                    <span class="comment">// Now the token is ready, let&#39;s add it to a purse</span>
                    <span class="comment">// By pushing theToken into thePurse with *pServerNym, I encrypt it to pServerNym.</span>
                    <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(theNymAsOwner, theServerNymAsOwner))
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error re-assigning ownership of token (to server.)\n&quot;</span>);
                        bSuccess = <span class="keyword">false</span>;
                        <span class="keywordflow">break</span>;
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Success re-assigning ownership of token (to server.)\n&quot;</span>);

                        bSuccess = <span class="keyword">true</span>;

                        pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                        pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                        pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        thePurse.Push(theServerNymAsOwner, *pToken); <span class="comment">// &lt;================</span>

                        int64_t lTemp = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
                        pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTemp + pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()); <span class="comment">// &lt;==================</span>
                    }
                }
                <span class="keywordflow">else</span> 
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading token from purse.\n&quot;</span>);
                    bSuccess = <span class="keyword">false</span>;
                    <span class="keywordflow">break</span>;
                }
            }

            <span class="keywordflow">if</span> (bSuccess)
            {
                thePurse.SignContract(theNym);
                thePurse.SaveContract(); <span class="comment">// I think this one is unnecessary. UPDATE: WRONG. It&#39;s necessary.</span>

                <span class="comment">// Save the purse into a string...</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
                thePurse.SaveContractRaw(strPurse);

                <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
                pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>

                <span class="comment">// sign the item</span>
                pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                <span class="comment">// ---------------------------------------------</span>
                <span class="comment">// BALANCE AGREEMENT</span>

                <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), *pTransaction, theNym, *pAccount, *pOutbox);

                <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                <span class="comment">// ---------------------------------------------</span>

                <span class="comment">// sign the transaction</span>
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                <span class="comment">// set up the ledger</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
                theLedger.GenerateLedger(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                theLedger.AddTransaction(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>

                <span class="comment">// sign the ledger</span>
                theLedger.SignContract(theNym);
                theLedger.SaveContract();

                <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
                <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger); <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                <span class="comment">// (1) Set up member variables </span>
                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                <span class="keywordflow">if</span> (bNymboxHash)
                    NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                    str_server.c_str());

                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
                lReturnValue = lRequestNumber;                
            } <span class="comment">// bSuccess</span>
            <span class="keywordflow">else</span> 
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>

                <span class="keyword">delete</span> pItem;       pItem = NULL;
                <span class="keyword">delete</span> pTransaction;pTransaction = NULL;
            }
        } <span class="comment">// else if (OTClient::notarizePurse == requestedCommand) // NOTARIZE PURSE</span>

        <span class="comment">// ------------------------------------------------------------------------</span>


        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209">OTClient::notarizeCheque</a>: <span class="comment">// DEPOSIT CHEQUE</span>
        {   
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to deposit to): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);

            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(SERVER_ID, CONTRACT_ID);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext cheque, terminate with ~ on a new line:\n&gt; &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer) - 1</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0; <span class="comment">// Make sure it&#39;s starting out fresh.</span>

                <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer) - 1, stdin)) &amp;&amp; 
                    (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                {
                    strCheque.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

            int64_t lStoredTransactionNumber=0;
            <span class="keywordtype">bool</span> bGotTransNum = theNym.GetNextTransactionNum(theNym, strServerID, lStoredTransactionNumber);

            <span class="keywordflow">if</span> (!bGotTransNum)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.LoadContractFromString(strCheque))
            {
                <span class="keywordflow">if</span> (theCheque.HasRecipient() &amp;&amp; (theCheque.GetRecipientUserID() != USER_ID))
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym(theCheque.GetRecipientUserID());
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;This cheque is made out to the Nym: %s (and that is NOT you, so you can&#39;t deposit it!)\n You are: %s \n&quot;</span>,
                        strRecipientNym.Get(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                }
                <span class="keywordflow">else</span> <span class="comment">// the cheque is blank, or is made out to me.</span>
                {
                    <span class="comment">// Create a transaction</span>
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
                        <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 

                    <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>);

                    <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cheque, please!&quot;</span>);
                    pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

                    strCheque.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                    theCheque.SaveContractRaw(strCheque);

                    <span class="comment">// Add the cheque string as the attachment on the transaction item.</span>
                    pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strCheque); <span class="comment">// The cheque is contained in the reference string.</span>

                    <span class="comment">// sign the item</span>
                    pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                    <span class="comment">// ---------------------------------------------</span>

                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(theNym);
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(theNym);

                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

                    <span class="keywordflow">if</span> (NULL == pInbox)
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);

                        <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                        theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>
                    }
                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);

                        <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                        theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
                    }
                    <span class="keywordflow">else</span> 
                    {
                        <span class="comment">// BALANCE AGREEMENT </span>
                        <span class="comment">// ---------------------------------------------</span>

                        <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(theCheque.GetAmount(), *pTransaction, theNym, *pAccount, *pOutbox);

                        <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                            pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                        <span class="comment">// ---------------------------------------------</span>

                        <span class="comment">// sign the transaction</span>
                        pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                        pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        <span class="comment">// set up the ledger</span>
                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
                        theLedger.GenerateLedger(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                        theLedger.AddTransaction(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>

                        <span class="comment">// sign the ledger</span>
                        theLedger.SignContract(theNym);
                        theLedger.SaveContract();

                        <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
                        <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);

                        <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                        theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                        theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                        theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                        <span class="comment">// (1) Set up member variables </span>
                        theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                        theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                        theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                        theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                        theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                        theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                        <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                        <span class="keywordflow">if</span> (bNymboxHash)
                            NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                        <span class="keywordflow">else</span>
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                            str_server.c_str());

                        <span class="comment">// (2) Sign the Message </span>
                        theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                        <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                        theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        bSendCommand = <span class="keyword">true</span>;
                        lReturnValue = lRequestNumber;        

                    } <span class="comment">// inbox/outbox loaded</span>
                } <span class="comment">// the cheque is blank, or is made out to me</span>
            } <span class="comment">// cheque loaded</span>
            <span class="keywordflow">else</span> <span class="comment">// cheque failed to load </span>
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
            }       
        } <span class="comment">// else if (OTClient::notarizeCheque == requestedCommand) // DEPOSIT CHEQUE</span>


        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c">OTClient::withdrawVoucher</a>: <span class="comment">// WITHDRAW VOUCHER</span>
        {       
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
            <span class="comment">// --------------------------------</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;This is like a banker&#39;s cheque, aka cashier&#39;s cheque.\n&quot;</span>
                    <span class="stringliteral">&quot;Please enter an asset Account ID (FROM acct): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to purchase voucher without a &#39;FROM&#39; account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }
            <span class="comment">// ---------------------------------------------------------</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym;

            <span class="keywordflow">if</span> (NULL == pHisNymID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s Nym ID (full ID -- no partials here.) Blank IS allowed: &quot;</span>);

                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strRecipientNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="comment">//          if (strRecipientNym.GetLength() &lt; 2) // blank cheques are allowed.</span>
                <span class="comment">//              return (-1);            </span>
            }
            <span class="keywordflow">else</span>
            {
                pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientNym);            
            }

            <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID (theNym);
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strRecipientNym);
            <span class="comment">// ----------------------------------------------   </span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
            <span class="keywordflow">if</span> (0 == lTransactionAmount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need an amount</span>
                strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            }

            <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount),</span>
                (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
            <span class="comment">// ----------------------------------------------</span>
            int64_t lWithdrawTransNum = 0,
                lVoucherTransNum  = 0;

            <span class="keywordtype">bool</span> bGotTransNum1 = theNym.GetNextTransactionNum(theNym, strServerID, lWithdrawTransNum);
            <span class="keywordtype">bool</span> bGotTransNum2 = theNym.GetNextTransactionNum(theNym, strServerID, lVoucherTransNum);

            <span class="keywordflow">if</span> (!bGotTransNum1 || !bGotTransNum2)
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Not enough Transaction Numbers were available. &quot;</span>
                    <span class="stringliteral">&quot;(Suggest requesting the server for more.)\n&quot;</span>, __FUNCTION__);

                <span class="keywordflow">if</span> (bGotTransNum1)
                    theNym.AddTransactionNum(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                <span class="keywordflow">if</span> (bGotTransNum2)
                    theNym.AddTransactionNum(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
            }
            <span class="keywordflow">else</span>
            {
                <span class="comment">// -----------------------------------------------------------------------</span>
                <span class="comment">// Memo</span>
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo for your check: &quot;</span>);
                <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo;
                strChequeMemo.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                <span class="comment">// -----------------------------------------------------------------------</span>
                <span class="comment">// Expiration (ignored by server -- it sets its own for its vouchers.)</span>
                <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
                <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>)); <span class="comment">// 6 months.</span>
                <span class="comment">// -----------------------------------------------------------------------</span>
                <span class="comment">// The server only uses the memo, amount, and recipient from this cheque when it</span>
                <span class="comment">// constructs the actual voucher.</span>
                <a class="code" href="class_o_t_cheque.html">OTCheque</a> theRequestVoucher(SERVER_ID, CONTRACT_ID);
                <span class="keywordtype">bool</span> bIssueCheque = theRequestVoucher.IssueCheque(lTotalAmount, lVoucherTransNum,
                    VALID_FROM, VALID_TO, ACCOUNT_ID, MY_NYM_ID, strChequeMemo,
                    (strRecipientNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) ? &amp;(HIS_NYM_ID) : NULL);

                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(theNym);
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(theNym);

                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

                <span class="keywordflow">if</span> (NULL == pInbox)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);

                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.AddTransactionNum(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                    theNym.AddTransactionNum(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);

                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.AddTransactionNum(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                    theNym.AddTransactionNum(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                }           
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bIssueCheque)
                {
                    <span class="comment">// Create a transaction</span>
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (MY_NYM_ID, ACCOUNT_ID, SERVER_ID, 
                        <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lWithdrawTransNum); 

                    <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>);
                    pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
                    <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Withdraw Voucher: &quot;</span>);
                    pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

                    <span class="comment">// Add the voucher request string as the attachment on the transaction item.</span>
                    <a class="code" href="class_o_t_string.html">OTString</a> strVoucher;
                    theRequestVoucher.SignContract(theNym);
                    theRequestVoucher.SaveContract();
                    theRequestVoucher.SaveContractRaw(strVoucher);          
                    pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strVoucher); <span class="comment">// The voucher request is contained in the reference string.</span>

                    <span class="comment">// sign the item</span>
                    pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
                    <span class="comment">// ---------------------------------------------</span>
                    <span class="comment">// BALANCE AGREEMENT </span>

                    <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalAmount*(-1), *pTransaction, theNym, *pAccount, *pOutbox);

                    <span class="keywordflow">if</span> (NULL != pBalanceItem)
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
                    <span class="comment">// ---------------------------------------------</span>
                    <span class="comment">// sign the transaction</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="comment">// set up the ledger</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(MY_NYM_ID, ACCOUNT_ID, SERVER_ID);
                    theLedger.GenerateLedger(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                    theLedger.AddTransaction(*pTransaction);

                    <span class="comment">// sign the ledger</span>
                    theLedger.SignContract(theNym);
                    theLedger.SaveContract();

                    <span class="comment">// extract the ledger in ascii-armored form</span>
                    <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                    <span class="comment">// Encoding...</span>
                    ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);

                    <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                    theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                    theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                    theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                    <span class="comment">// (1) Set up member variables </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                    theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                    theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                    theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                    theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                    theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                    <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                    <span class="keywordflow">if</span> (bNymboxHash)
                        NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                        str_server.c_str());

                    <span class="comment">// (2) Sign the Message </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                    theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    bSendCommand = <span class="keyword">true</span>;
                    lReturnValue = lRequestNumber;
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                    theNym.AddTransactionNum(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                    theNym.AddTransactionNum(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                }
            }
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="comment">/*</span>
<span class="comment">        bool ProcessUserCommand(OT_CLIENT_CMD_TYPE requestedCommand,</span>
<span class="comment">        OTMessage &amp; theMessage,</span>
<span class="comment">        OTPseudonym &amp; theNym,</span>
<span class="comment">        //                          OTAssetContract &amp; theContract,</span>
<span class="comment">        OTServerContract &amp; theServer,</span>
<span class="comment">        OTAccount * pAccount=NULL,</span>
<span class="comment">        int64_t lTransactionAmount = 0,</span>
<span class="comment">        OTAssetContract * pMyAssetContract=NULL,</span>
<span class="comment">        OTAccount * pHisAcct=NULL,</span>
<span class="comment">        OTPseudonym * pHisNym=NULL);</span>
<span class="comment">        */</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654">OTClient::notarizeWithdrawal</a>: <span class="comment">// NOTARIZE WITHDRAWAL</span>
        {   
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Account ID: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to withdraw without account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ----------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
            <span class="keywordflow">if</span> (0 == lTransactionAmount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need an amount</span>
                strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            }

            <span class="keyword">const</span>   int64_t lTotalAmount    = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
                (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
            int64_t lAmount     = lTotalAmount; <span class="comment">// Used in calculating the denominations of tokens needed for the withdrawal.</span>

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);

            int64_t lStoredTransactionNumber=0;
            <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;

            <span class="comment">// ---------------------------------------------</span>

            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(theNym);
            <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(theNym);

            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);

            <span class="keywordflow">if</span> (NULL == pInbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            bGotTransNum = theNym.GetNextTransactionNum(theNym, strServerID, lStoredTransactionNumber);
            <span class="keywordflow">if</span> (!bGotTransNum)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Suggest requesting the server for a new one.\n&quot;</span>);
                <span class="keywordflow">break</span>;
            }

            <span class="comment">// Create a transaction</span>
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lStoredTransactionNumber); 

            <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>);
            pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
            <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Gimme cash!&quot;</span>);
            pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);

            <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
            <span class="comment">// -----------------------------------------------------------------</span>
            <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strContractID);
            <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
            <span class="comment">// ------------------------------</span>
            <span class="keywordflow">if</span> (pServerNym &amp;&amp;
                pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>() &amp;&amp;
                pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>((<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>&amp;)*pServerNym))
            {
                <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse        = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID);
                <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurseMyCopy  = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID);

                <span class="comment">// Create all the necessary tokens for the withdrawal amount.</span>
                <span class="comment">// Push copies of each token into a purse to be sent to the server,</span>
                <span class="comment">// as well as a purse to be kept for unblinding when we receive the</span>
                <span class="comment">// server response.  (Coin private unblinding keys are not sent to</span>
                <span class="comment">// the server, obviously.)</span>
                int64_t lTokenAmount = 0;
                <span class="keywordflow">while</span> ((lTokenAmount = pMint-&gt;<a class="code" href="class_o_t_mint.html#a623b821ad01b8c0ce2568b6d84102c35">GetLargestDenomination</a>(lAmount)) &gt; 0)
                {
                    lAmount -= lTokenAmount;

                    <span class="comment">// Create the relevant token request with same server/asset ID as the purse.</span>
                    <span class="comment">// the purse does NOT own the token at this point. the token&#39;s constructor</span>
                    <span class="comment">// just uses it to copy some IDs, since they must match.</span>
                    <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ad661596f621b1b697f1e8328cdbc3683">OTToken::InstantiateAndGenerateTokenRequest</a>(*pPurse, theNym, *pMint, lTokenAmount);
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
                    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);

                    <span class="comment">// GENERATE new token, sign it and save it. </span>
                    pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="comment">// Now the proto-token is generated, let&#39;s add it to a purse</span>
                    <span class="comment">// By pushing pToken into pPurse with *pServerNym, I encrypt it to pServerNym.</span>
                    <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
                    pPurse-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pServerNym, *pToken);

                    <span class="comment">// I&#39;m saving my own copy of all this, encrypted to my nym</span>
                    <span class="comment">// instead of the server&#39;s, so I can get to my private coin data.</span>
                    <span class="comment">// The server&#39;s copy of pToken is already Pushed, so I can re-use</span>
                    <span class="comment">// the variable now for my own purse.</span>
                    pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pToken-&gt;<a class="code" href="class_o_t_token.html#a8666afcdee1f4cb0b45e278d7196d6db">SetSavePrivateKeys</a>(); <span class="comment">// This time it will save the private keys when I sign it</span>
                    pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    pPurseMyCopy-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(theNym, *pToken);    <span class="comment">// Now my copy of the purse has a version of the token,</span>
                }

                pPurse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pPurse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// I think this one is unnecessary.</span>

                <span class="comment">// Save the purse into a string...</span>
                <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
                pPurse-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);

                <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
                pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>


                pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);     <span class="comment">// encrypted to me instead of the server, and including </span>
                pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();           <span class="comment">// the private keys for unblinding the server response.</span>
                <span class="comment">// This thing is neat and tidy. The wallet can just save it as an ascii-armored string as a</span>
                <span class="comment">// purse field inside the wallet file.  It doesn&#39;t do that for now (TODO) but it easily could.</span>


                <span class="comment">// Add the purse to the wallet</span>
                <span class="comment">// (We will need it to look up the private coin info for unblinding the token,</span>
                <span class="comment">//  when the response comes from the server.)</span>
                m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a098029976b57c592f220ae6bf0cc3822">AddPendingWithdrawal</a>(*pPurseMyCopy);

                <span class="keyword">delete</span> pPurse;
                pPurse          = NULL; <span class="comment">// We&#39;re done with this one.</span>
                pPurseMyCopy    = NULL; <span class="comment">// The wallet owns my copy now and will handle cleaning it up.</span>


                <span class="comment">// sign the item</span>
                pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                <span class="comment">// ---------------------------------------------</span>
                <span class="comment">// BALANCE AGREEMENT</span>

                <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalAmount*(-1), *pTransaction, theNym, *pAccount, *pOutbox);

                <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                <span class="comment">// ---------------------------------------------</span>

                <span class="comment">// sign the transaction</span>
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();


                <span class="comment">// set up the ledger</span>
                <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
                theLedger.GenerateLedger(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                theLedger.AddTransaction(*pTransaction);

                <span class="comment">// sign the ledger</span>
                theLedger.SignContract(theNym);
                theLedger.SaveContract();

                <span class="comment">// extract the ledger in ascii-armored form</span>
                <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>

                <span class="comment">// Encoding...</span>
                ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);


                <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                <span class="comment">// (1) Set up member variables </span>
                theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                <span class="keywordflow">if</span> (bNymboxHash)
                    NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                    str_server.c_str());

                <span class="comment">// (2) Sign the Message </span>
                theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                bSendCommand = <span class="keyword">true</span>;
                lReturnValue = lRequestNumber;                
            }
            <span class="keywordflow">else</span> 
            {
                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>
            }

        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">OTClient::getTransactionNum</a>: <span class="comment">// GET TRANSACTION NUM</span>
        {   
            <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
            theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
            theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
            theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

            <span class="comment">// (1) Set up member variables </span>
            theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getTransactionNum&quot;</span>;
            theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
            theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
            theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
            <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

            <span class="keywordflow">if</span> (bNymboxHash)
                NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                str_server.c_str());

            <span class="comment">// (2) Sign the Message </span>
            theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

            <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
            theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            bSendCommand = <span class="keyword">true</span>;
            lReturnValue = lRequestNumber;        
        }


        <span class="comment">// ------------------------------------------------------------------------</span>


        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e">OTClient::marketOffer</a>: <span class="comment">// PUT AN OFFER ON A MARKET</span>
        {
            <span class="keywordflow">if</span> (theNym.GetTransactionNumCount(strServerID) &lt; 3)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;You need at least 3 transaction numbers to do this (You don&#39;t have enough.)\n&quot;</span>);
            }
            <span class="keywordflow">else</span>
            {
                int64_t lStoredTransactionNumber=0, lClosingTransactionNoAssetAcct=0, lClosingTransactionNoCurrencyAcct=0;
                <span class="keywordtype">bool</span> bGotTransNum   = theNym.GetNextTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>);
                <span class="keywordtype">bool</span> bGotClosingNumAssetAcct = theNym.GetNextTransactionNum(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>);
                <span class="keywordtype">bool</span> bGotClosingNumCurrencyAcct = theNym.GetNextTransactionNum(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">true</span>);

                <span class="keywordflow">if</span> (!bGotTransNum || !bGotClosingNumAssetAcct || !bGotClosingNumCurrencyAcct)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Strange... had enough transcation numbers, but error trying to get one (or both.)\n&quot;</span>);

                    <span class="keywordflow">if</span> (bGotTransNum)
                        theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>);

                    <span class="keywordflow">if</span> (bGotClosingNumAssetAcct)
                        theNym.AddTransactionNum(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>);

                    <span class="keywordflow">if</span> (bGotClosingNumCurrencyAcct)
                        theNym.AddTransactionNum(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">false</span>);

                    <span class="keywordflow">if</span> (bGotTransNum || bGotClosingNumAssetAcct || bGotClosingNumCurrencyAcct)
                        theNym.SaveSignedNymfile(theNym);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_string.html">OTString</a> str_ASSET_TYPE_ID, str_CURRENCY_TYPE_ID, str_ASSET_ACCT_ID, str_CURRENCY_ACCT_ID;

                    <span class="comment">// FIRST get the Asset Type ID</span>
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the Asset Type ID of the market you want to trade in: &quot;</span>);
                    str_ASSET_TYPE_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                    <span class="comment">// THEN GET AN ACCOUNT ID FOR THAT ASSET TYPE</span>
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours for an account of the same asset type: &quot;</span>);
                    str_ASSET_ACCT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);        

                    <span class="comment">// NEXT get the Currency Type ID (which is also an asset type ID, FYI.)</span>
                    <span class="comment">// The trader just chooses one of them to be the &quot;asset&quot; and the other, the &quot;currency&quot;.</span>
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the Currency Type ID of the market you want to trade in: &quot;</span>);
                    str_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                    <span class="comment">// THEN GET AN ACCOUNT ID FOR THAT CURRENCY TYPE</span>
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours, for an account of that same currency type: &quot;</span>);
                    str_CURRENCY_ACCT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);     


                    <span class="comment">// Get a few int64_t integers that we need...</span>

                    <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
                    int64_t lTotalAssetsOnOffer = 0, 
                        lMinimumIncrement = 0, 
                        lPriceLimit = 0,
                        lMarketScale = 1;

                    <span class="comment">// -------------------------------------------------------------------</span>

                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the market granularity (or &#39;scale&#39;)? [1]: &quot;</span>);
                    strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                    lMarketScale = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                    <span class="keywordflow">if</span> (lMarketScale &lt; 1)
                        lMarketScale = 1;

                    <span class="comment">// -------------------------------------------------------------------</span>

                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the minimum increment per trade? (will be multiplied by the scale) [1]: &quot;</span>);
                    strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                    lMinimumIncrement = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                    lMinimumIncrement *= lMarketScale;

                    <span class="comment">// In case they entered 0.</span>
                    <span class="keywordflow">if</span> (lMinimumIncrement &lt; 1)
                        lMinimumIncrement = lMarketScale;

                    <span class="comment">// -------------------------------------------------------------------</span>

                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many assets total do you have available for sale or purchase?\n&quot;</span>
                        <span class="stringliteral">&quot;(Will be multiplied by minimum increment) [1]: &quot;</span>);
                    strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                    lTotalAssetsOnOffer = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                    <span class="comment">//              lTotalAssetsOnOffer *= lMinimumIncrement;  // this was a bug.</span>

                    <span class="keywordflow">if</span> (lTotalAssetsOnOffer &lt; 1)
                        lTotalAssetsOnOffer = lMinimumIncrement;



                    <span class="keywordflow">for</span> (;;)
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;The Market Scale is: %lld\n&quot;</span>
                            <span class="stringliteral">&quot;What is your price limit, in currency, PER SCALE of assets?\n&quot;</span>
                            <span class="stringliteral">&quot;That is, what is the lowest amount of currency you&#39;d sell for, (if selling)\n&quot;</span>
                            <span class="stringliteral">&quot;Or the highest amount you&#39;d pay (if you are buying).\nAgain, PER SCALE: &quot;</span>,
                            lMarketScale);
                        strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                        lPriceLimit = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                        <span class="keywordflow">if</span> (lPriceLimit &lt; 1)
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Price must be at least 1.\n\n&quot;</span>);
                        <span class="keywordflow">else</span>
                            <span class="keywordflow">break</span>;          
                    }

                    <span class="comment">// which direction is the offer? Buy or sell?</span>
                    <span class="keywordtype">bool</span> bBuyingOrSelling;
                    <a class="code" href="class_o_t_string.html">OTString</a> strDirection;
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Are you in the market to buy the asset type, or to sell? [buy]: &quot;</span>);
                    strDirection.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                    <span class="keywordflow">if</span> (strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;sell&quot;</span>) || strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;Sell&quot;</span>))
                        bBuyingOrSelling    = <span class="keyword">true</span>;
                    <span class="keywordflow">else</span>
                        bBuyingOrSelling    = <span class="keyword">false</span>;


                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(strNymID),
                        ASSET_TYPE_ID(str_ASSET_TYPE_ID),   CURRENCY_TYPE_ID(str_CURRENCY_TYPE_ID),
                        ASSET_ACCT_ID(str_ASSET_ACCT_ID),   CURRENCY_ACCT_ID(str_CURRENCY_ACCT_ID);


                    <a class="code" href="class_o_t_offer.html">OTOffer</a> theOffer(SERVER_ID, ASSET_TYPE_ID, CURRENCY_TYPE_ID, lMarketScale);


                    <span class="keywordtype">bool</span> bCreateOffer = theOffer.MakeOffer(bBuyingOrSelling,    <span class="comment">// True == SELLING, False == BUYING</span>
                        lPriceLimit,            <span class="comment">// Per Minimum Increment...</span>
                        lTotalAssetsOnOffer,    <span class="comment">// Total assets available for sale or purchase.</span>
                        lMinimumIncrement,  <span class="comment">// The minimum increment that must be bought or sold for each transaction</span>
                        lStoredTransactionNumber); <span class="comment">// Transaction number matches on transaction, item, offer, and trade.</span>

                    <span class="keywordflow">if</span> (bCreateOffer)
                    {
                        bCreateOffer =  theOffer.SignContract(theNym);

                        <span class="keywordflow">if</span> (bCreateOffer)
                            bCreateOffer = theOffer.SaveContract();
                    }

                    <a class="code" href="class_o_t_trade.html">OTTrade</a> theTrade(SERVER_ID, 
                        ASSET_TYPE_ID, ASSET_ACCT_ID, 
                        USER_ID, 
                        CURRENCY_TYPE_ID, CURRENCY_ACCT_ID);


                    <span class="keywordtype">bool</span> bIssueTrade = theTrade.IssueTrade(theOffer);

                    <span class="keywordflow">if</span> (bIssueTrade)
                    {
                        theTrade.AddClosingTransactionNo(lClosingTransactionNoAssetAcct);
                        theTrade.AddClosingTransactionNo(lClosingTransactionNoCurrencyAcct);

                        bIssueTrade =   theTrade.SignContract(theNym);

                        <span class="keywordflow">if</span> (bIssueTrade)
                            bIssueTrade = theTrade.SaveContract();
                    }


                    <span class="keywordflow">if</span> (bCreateOffer &amp;&amp; bIssueTrade)
                    {
                        <span class="comment">// Create a transaction</span>
                        <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ASSET_ACCT_ID, SERVER_ID, 
                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>, lStoredTransactionNumber); 

                        <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae973afad2dc8a8349e8889304b20e73b">OTItem::marketOffer</a>, 
                            &amp;CURRENCY_ACCT_ID); <span class="comment">// the &quot;To&quot; account (normally used for a TRANSFER transaction) is used here </span>
                        <span class="comment">// storing the Currency Acct ID. The Server will expect the Trade object bundled </span>
                        <span class="comment">// within this item to have an Asset Acct ID and &quot;Currency&quot; Acct ID that match</span>
                        <span class="comment">// those on this Item. Otherwise it will reject the offer.</span>

                        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);

                        <a class="code" href="class_o_t_string.html">OTString</a> strTrade;
                        theTrade.SaveContractRaw(strTrade);

                        <span class="comment">// Add the trade string as the attachment on the transaction item.</span>
                        pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strTrade); <span class="comment">// The trade is contained in the attachment string. (The offer is within the trade.)</span>

                        <span class="comment">// sign the item</span>
                        pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                        pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                        <span class="comment">// ---------------------------------------------</span>
                        <span class="comment">// TRANSACTION AGREEMENT</span>

                        <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                        <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = theNym.GenerateTransactionStatement(*pTransaction);

                        <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                            pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                        <span class="comment">// ---------------------------------------------</span>

                        <span class="comment">// sign the transaction</span>
                        pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                        pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        <span class="comment">// set up the ledger</span>
                        <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ASSET_ACCT_ID, SERVER_ID);
                        theLedger.GenerateLedger(ASSET_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                        theLedger.AddTransaction(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>

                        <span class="comment">// sign the ledger</span>
                        theLedger.SignContract(theNym);
                        theLedger.SaveContract();

                        <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
                        <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);

                        <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                        theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                        theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                        theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                        <span class="comment">// (1) Set up member variables </span>
                        theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                        theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                        theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                        theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                        theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_ASSET_ACCT_ID;
                        theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                        <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                        <span class="keywordflow">if</span> (bNymboxHash)
                            NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                        <span class="keywordflow">else</span>
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                            str_server.c_str());

                        <span class="comment">// (2) Sign the Message </span>
                        theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                        <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                        theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                        bSendCommand = <span class="keyword">true</span>;
                        lReturnValue = lRequestNumber;
                    }

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSendCommand)  
                    {
                        <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                        theNym.AddTransactionNum(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
                        theNym.AddTransactionNum(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
                        theNym.AddTransactionNum(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
                    }
                } <span class="comment">// Got Transaction Num</span>
            }
        } <span class="comment">// else if (OTClient::marketOffer == requestedCommand) // MARKET OFFER</span>


        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd">OTClient::signContract</a>: <span class="comment">// Sign a CONTRACT. (Sends no message to server.)</span>
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract a server contract, or an asset contract [s/a]: &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strContractType;
            strContractType.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordtype">char</span> cContractType=<span class="charliteral">&#39;s&#39;</span>;
            <span class="keywordtype">bool</span> bIsAssetContract = strContractType.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cContractType);

            <span class="keywordflow">if</span> (bIsAssetContract)
            {
                <span class="keywordflow">if</span> (<span class="charliteral">&#39;S&#39;</span> == cContractType || <span class="charliteral">&#39;s&#39;</span> == cContractType)
                    bIsAssetContract = <span class="keyword">false</span>;
            }
            <span class="comment">// ----------------------------</span>

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract properly escaped already? (If escaped, all lines beginning with ----- will instead appear as - ----- ) [y/n]: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a from account, Yes even in a deposit, it&#39;s still the &quot;From&quot; account.</span>
            <span class="comment">// The &quot;To&quot; account is only used for a transfer. (And perhaps for a 2-way trade.)</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strEscape;
            strEscape.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordtype">char</span> cEscape=<span class="charliteral">&#39;n&#39;</span>;
            <span class="keywordtype">bool</span> bEscaped = strEscape.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cEscape);

            <span class="keywordflow">if</span> (bEscaped)
            {
                <span class="keywordflow">if</span> (<span class="charliteral">&#39;N&#39;</span> == cEscape || <span class="charliteral">&#39;n&#39;</span> == cEscape)
                    bEscaped = <span class="keyword">false</span>;
            }

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an unsigned asset contract; terminate with ~ on a new line:\n&gt; &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strContract;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                    (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                {
                    <span class="keywordflow">if</span> (!bEscaped &amp;&amp; decode_buffer[0] == <span class="charliteral">&#39;-&#39;</span>)
                    {
                        strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;- &quot;</span>);
                    }
                    strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

            <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> theServerContract;
            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;

            <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = bIsAssetContract ? <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_contract.html">OTContract</a>*<span class="keyword">&gt;</span>(&amp;theAssetContract) : dynamic_cast&lt;OTContract*&gt;(&amp;theServerContract);

            pContract-&gt;<a class="code" href="class_o_t_contract.html#aefeed014e39aa6dc843d090e03769b5d">CreateContract</a>(strContract, theNym);

            <span class="comment">// re-using strContract here for output this time.</span>
            strContract.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
            pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strContract);

            <a class="code" href="class_o_t_string.html">OTString</a> strNewID;
            pContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strNewID);

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;.\n..\n...\n....\n.....\n......\n.......\n........\n.........\n\n&quot;</span>
                <span class="stringliteral">&quot;NEW CONTRACT ID:  %s\n\n&quot;</span>, strNewID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            std::cout &lt;&lt; strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;

            <span class="comment">// ------------------------------------------------------------------------</span>

            <span class="keywordflow">return</span> 0;
        }

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc">OTClient::writeCheque</a>: <span class="comment">// Write a CHEQUE. (Sends no message to server.)</span>
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Account ID (to draw the cheque from): &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> (-1);

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strFromAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to write cheque without account to draw from. On comand line, try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> (-1);
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strFromAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }

            <span class="comment">// ---------------------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym;

            <span class="keywordflow">if</span> (NULL == pHisNymID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s Nym ID (full ID -- no partials here.) Blank IS allowed: &quot;</span>);

                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strRecipientNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="comment">//          if (strRecipientNym.GetLength() &lt; 2) // blank cheques are allowed.</span>
                <span class="comment">//              return (-1);            </span>
            }
            <span class="keywordflow">else</span>
            {
                pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientNym);
            }

            <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strRecipientNym);

            <span class="comment">// ----------------------------------------------   </span>
            <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
            <span class="keywordflow">if</span> (0 == lTransactionAmount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need an amount</span>
                strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            }

            <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
                (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
            <span class="comment">// ----------------------------------------------</span>

            <span class="comment">// To write a cheque, we need to burn one of our transaction numbers. (Presumably the wallet</span>
            <span class="comment">// is also storing a couple of these, since they are needed to perform any transaction.)</span>
            <span class="comment">//</span>
            <span class="comment">// I don&#39;t have to contact the server to write a cheque -- as long as I already have a transaction</span>
            <span class="comment">// number I can use to write it. Otherwise I&#39;d have to ask the server to send me one first.</span>

            int64_t lTransactionNumber=0;

            <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.GetNextTransactionNum(theNym, strServerID, lTransactionNumber))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Cheques are written offline, but you still need a transaction number\n&quot;</span>
                    <span class="stringliteral">&quot;(and you have none, currently.) Try using &#39;n&#39; to request another transaction number.\n&quot;</span>);
                <span class="keywordflow">return</span> (-1);
            }


            <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(pAccount-&gt;GetRealServerID(), pAccount-&gt;GetAssetTypeID());

            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="comment">// Memo</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo for your check: &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo;
            strChequeMemo.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="comment">// Valid date range (in seconds)</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, 
                <span class="stringliteral">&quot; 6 minutes ==      360 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;10 minutes ==      600 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;1 hour     ==     3600 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;1 day      ==    86400 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;30 days    ==  2592000 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;3 months   ==  7776000 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;6 months   == 15552000 Seconds\n\n&quot;</span>
                );

            int64_t lExpirationInSeconds = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ace532edc311602e99a6821d417fec988">OT_TIME_HOUR_IN_SECONDS</a>);
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;How many seconds before cheque expires? (defaults to 1 hour: %lld): &quot;</span>, lExpirationInSeconds);
            <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
            strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
                lExpirationInSeconds = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());


            <span class="comment">// -----------------------------------------------------------------------</span>

            <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Cheque may be cashed STARTING date (defaults to now, in seconds) [%lld]: &quot;</span>, VALID_FROM);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
            strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2)
                VALID_FROM = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());


            <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, lExpirationInSeconds); <span class="comment">// now + 3600</span>

            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="keywordtype">bool</span> bIssueCheque = theCheque.IssueCheque(lTotalAmount, lTransactionNumber, VALID_FROM, VALID_TO, 
                ACCOUNT_ID, MY_NYM_ID, strChequeMemo,
                (strRecipientNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) ? &amp;(HIS_NYM_ID) : NULL); <span class="comment">// blank cheques are allowed.</span>

            <span class="keywordflow">if</span> (bIssueCheque)
            {
                theCheque.SignContract(theNym);
                theCheque.SaveContract();

                <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);

                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n\nOUTPUT (writeCheque):\n\n\n&quot;</span>);
                <span class="comment">// OTLog::Output actually goes to stderr, whereas the cout below is actually sent to standard output.</span>
                std::cout &lt;&lt; strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed trying to issue the cheque!\n&quot;</span>);

                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                theNym.AddTransactionNum(theNym, strServerID, lTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                              </span>
            }

            <span class="keywordflow">return</span> -1;
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697">OTClient::proposePaymentPlan</a> : <span class="comment">// Propose a payment plan (sends no message to server.)</span>
        {   
            <a class="code" href="class_o_t_string.html">OTString</a> strMerchantAcct;

            <span class="keywordflow">if</span> (NULL == pAccount)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;You are the Merchant, proposing this payment plan so your customer can confirm it.\n&quot;</span>
                    <span class="stringliteral">&quot;After this command, use &#39;confirm&#39; (customer) to confirm it, and then activate it using\n&quot;</span>
                    <span class="stringliteral">&quot;&#39;plan&#39; (customer) from the OT prompt, or &#39;--activateplan&#39; from the command line.\n\n&quot;</span>
                    <span class="stringliteral">&quot;Enter the Merchant&#39;s (your) Asset Account ID that the payments will go to: &quot;</span>);
                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strMerchantAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strMerchantAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> -1;

                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strMerchantAcct);

                <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strMerchantAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strMerchantAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
                {
                    pAccount-&gt;GetIdentifier(strMerchantAcct);
                    CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                    CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to propose payment plan without account to pay to. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
                    <span class="keywordflow">return</span> -1;
                }
            }
            <span class="keywordflow">else</span>
            {
                pAccount-&gt;GetIdentifier(strMerchantAcct);
                CONTRACT_ID = pAccount-&gt;GetAssetTypeID();
                CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_ACCT_ID(strMerchantAcct);

            <span class="keywordflow">if</span> (pAccount-&gt;GetPurportedServerID() != SERVER_ID)
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
                    <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
                <span class="keywordflow">return</span> -1;
            }

            <span class="comment">// pAccount is the MERCHANT&#39;s (recipient) account. CONTRACT_ID is its ASSET_TYPE.</span>
            <span class="comment">// strContractID is the string version of that. And strMerchantAcct is the string</span>
            <span class="comment">// version of pAccount&#39;s ID.</span>
            <span class="comment">// theNym, FYI, is the Merchant&#39;s Nym.</span>

            <span class="comment">// -----------------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strCustomerAcct;

            <span class="keywordflow">if</span> (NULL == pHisAcctID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Customer&#39;s Asset Account ID that payments will come FROM (no partials): &quot;</span>);

                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strCustomerAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strCustomerAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> -1;          
            }
            <span class="keywordflow">else</span>
            {
                pHisAcctID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strCustomerAcct);            
            }

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_ACCT_ID(strCustomerAcct);

            <span class="comment">// HIS_ACCT_ID is the Customer&#39;s asset account id.</span>
            <span class="comment">// strCustomerAcct is the OTString version of that.</span>
            <span class="comment">// -----------------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strCustomerNym;

            <span class="keywordflow">if</span> (NULL == pHisNymID)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Customer&#39;s Nym ID (full ID -- no partials here): &quot;</span>);

                <span class="comment">// User input.</span>
                <span class="comment">// I need a from account</span>
                strCustomerNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strCustomerNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
                    <span class="keywordflow">return</span> -1;          
            }
            <span class="keywordflow">else</span>
            {
                pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strCustomerNym);
            }

            <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);

            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strCustomerNym);

            <span class="comment">// HIS_NYM_ID is the Customer&#39;s nym id. MY_NYM_ID is the Merchant&#39;s.</span>
            <span class="comment">// strCustomerNym is the OTString version of HIS_NYM_ID.</span>
            <span class="comment">// -----------------------------------------------------</span>

            <a class="code" href="class_o_t_string.html">OTString</a> strConsideration, strTemp;

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo describing consideration for the payment plan: &quot;</span>);
            strConsideration.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);     

            <span class="comment">// To write a payment plan, like a cheque, we need to burn one of our transaction numbers. (Presumably</span>
            <span class="comment">// the wallet is also storing a couple of these, since they are needed to perform any transaction.)</span>
            <span class="comment">//</span>
            <span class="comment">// I don&#39;t have to contact the server to write a payment plan -- as long as I already have a transaction</span>
            <span class="comment">// number I can use to write it. Otherwise I&#39;d have to ask the server to send me one first.</span>

            <span class="keywordflow">if</span> (theNym.GetTransactionNumCount(strServerID) &lt; 2)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Payment Plans are written offline, but you still need a 2 transaction numbers\n&quot;</span>
                    <span class="stringliteral">&quot;(and you don&#39;t, currently.) Try using &#39;n&#39; to request another transaction number.\n&quot;</span>);
                <span class="keywordflow">return</span> -1;
            }

            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="comment">/*</span>
<span class="comment">            OTPaymentPlan( const OTIdentifier &amp; SERVER_ID,          const OTIdentifier &amp; ASSET_ID,</span>
<span class="comment">            const OTIdentifier &amp; SENDER_ACCT_ID,    const OTIdentifier &amp; SENDER_USER_ID,</span>
<span class="comment">            const OTIdentifier &amp; RECIPIENT_ACCT_ID, const OTIdentifier &amp; RECIPIENT_USER_ID);</span>
<span class="comment"></span>
<span class="comment">            */</span>
            <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan(pAccount-&gt;GetRealServerID(), pAccount-&gt;GetAssetTypeID(),
                HIS_ACCT_ID,  HIS_NYM_ID,
                MY_ACCT_ID,   MY_NYM_ID);

            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="comment">// Valid date range (in seconds)</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, 
                <span class="stringliteral">&quot; 6 minutes ==      360 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;10 minutes ==      600 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;1 hour     ==     3600 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;1 day      ==    86400 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;30 days            ==  2592000 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;3 months       ==  7776000 Seconds\n&quot;</span>
                <span class="stringliteral">&quot;6 months       == 15552000 Seconds\n\n&quot;</span>
                );

            int64_t lExpirationInSeconds = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ae431139997436f8522341a67e64d0d32">OT_TIME_DAY_IN_SECONDS</a>);
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;How many seconds before payment plan expires? (defaults to 1 day: %lld): &quot;</span>, 
                lExpirationInSeconds);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
            strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
                lExpirationInSeconds = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());


            <span class="comment">// -----------------------------------------------------------------------</span>

            <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Payment plan becomes valid for processing STARTING date\n&quot;</span>
                <span class="stringliteral">&quot;(defaults to now, in seconds) [%lld]: &quot;</span>, VALID_FROM);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
            strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2)
                VALID_FROM = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, lExpirationInSeconds); <span class="comment">// now + 86400</span>

            <span class="comment">// ************************************************************************</span>
            <span class="comment">// This pulls two transaction numbers off of pMerchantNym.</span>
            <span class="comment">// (So we have to put them back if there is some early failure and crap-out...)</span>
            <span class="comment">//</span>
            <span class="keywordtype">bool</span> bSuccessSetAgreement = thePlan.SetProposal(theNym, strConsideration, VALID_FROM, VALID_TO);

            <span class="keywordflow">if</span> (!bSuccessSetAgreement)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed trying to set the proposal!\n&quot;</span>);

                <span class="keywordflow">return</span> -1;
            }
            <span class="comment">// ************************************************************************</span>

            <span class="keywordtype">bool</span> bSuccessSetInitialPayment  = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to even have this payment.</span>
            <span class="keywordtype">bool</span> bSuccessSetPaymentPlan     = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to have a payment plan</span>

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the Initial Payment Amount, if any? [0]: &quot;</span>);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            int64_t lInitialPayment = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">if</span> (lInitialPayment &gt; 0)
            {
                <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a0267b9efa7d67ca819f176d0a234213f">OT_TIME_MINUTE_IN_SECONDS</a>; <span class="comment">// 60 seconds.</span>

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From the Start Date forward, how int64_t until the Initial Payment should charge?\n&quot;</span>
                    <span class="stringliteral">&quot;(defaults to one minute, in seconds) [%d]: &quot;</span>, PAYMENT_DELAY);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
                    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// -----------------------------------------------------------------------</span>

                bSuccessSetInitialPayment = thePlan.SetInitialPayment(lInitialPayment, PAYMENT_DELAY);
            }

            <span class="keywordflow">if</span> (!bSuccessSetInitialPayment)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed trying to set the initial payment!\n&quot;</span>);

                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                thePlan.HarvestClosingNumbers(theNym); <span class="comment">// puts the relevant numbers back onto Nym.</span>

                <span class="keywordflow">return</span> -1;
            }

            <span class="comment">// -----------------------------------------------------------------------</span>

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the regular payment amount, if any? [0]: &quot;</span>);
            strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
            int64_t lRegularPayment = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

            <span class="keywordflow">if</span> (lRegularPayment &gt; 0) <span class="comment">// If there are regular payments.</span>
            {
                <span class="comment">// -----------------------------------------------------------------------</span>

                <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(120); <span class="comment">// 120 seconds.</span>

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From the Start Date forward, how int64_t until the Regular Payments start?\n&quot;</span>
                    <span class="stringliteral">&quot;(defaults to two minutes, in seconds) [%d]: &quot;</span>, PAYMENT_DELAY);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
                    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// -----------------------------------------------------------------------</span>

                <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_PERIOD = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(30); <span class="comment">// 30 seconds.</span>

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Once payments begin, how much time should elapse between each payment?\n&quot;</span>
                    <span class="stringliteral">&quot;(defaults to thirty seconds) [%d]: &quot;</span>, PAYMENT_PERIOD);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
                    PAYMENT_PERIOD = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// -----------------------------------------------------------------------</span>

                <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> PLAN_LENGTH = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>; <span class="comment">// 0 seconds (for no max length).</span>

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From start date, do you want the plan to expire after a certain maximum time?\n&quot;</span>
                    <span class="stringliteral">&quot;(defaults to 0 for no) [%d]: &quot;</span>, PLAN_LENGTH);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

                <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
                    PLAN_LENGTH = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// -----------------------------------------------------------------------</span>

                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Should there be some maximum number of payments? (Zero for no maximum.) [0]: &quot;</span>);
                strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
                int32_t nMaxPayments = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                bSuccessSetPaymentPlan = thePlan.SetPaymentPlan(lRegularPayment, PAYMENT_DELAY, 
                    PAYMENT_PERIOD, PLAN_LENGTH, nMaxPayments);
            }

            <span class="keywordflow">if</span> (!bSuccessSetPaymentPlan)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed trying to set the payment plan!\n&quot;</span>);

                <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
                thePlan.HarvestClosingNumbers(theNym); <span class="comment">// puts the relevant numbers back onto Nym.</span>

                <span class="keywordflow">return</span> -1;
            }

            thePlan.SignContract(theNym);
            thePlan.SaveContract();

            <a class="code" href="class_o_t_string.html">OTString</a> strPlan(thePlan);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n\n(Make sure to have your Customer &#39;confirm&#39; the payment plan, before he activates it at &quot;</span>
                <span class="stringliteral">&quot;the server using the &#39;plan&#39; command in the OT prompt, or --activateplan at the command-line):\n\n&quot;</span>);

            std::cout &lt;&lt; strPlan.Get() &lt;&lt; std::endl;

            <span class="keywordflow">return</span> 0; <span class="comment">// sends no server message in this case.</span>
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad">OTClient::confirmPaymentPlan</a>: <span class="comment">// Confirm a payment plan (sends no message to server.)</span>
        {   
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(You are the customer, confirming a payment plan that the merchant has just sent you.)\n\n&quot;</span>);

            <span class="comment">// -----------------------------------------------</span>

            <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan;

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext payment plan. Terminate with ~ on a new line:\n&gt; &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strPlan;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                    (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                {
                    strPlan.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);


            <span class="keywordflow">if</span> (!thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPlan))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load payment plan from string.\n&quot;</span>);
                <span class="keywordflow">return</span> -1;
            }

            <span class="comment">// -----------------------------------------------------------------------</span>

            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pCustomerNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(thePlan.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>());

            <span class="keywordflow">if</span> (NULL == pCustomerNym)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;The customer Nym on this payment plan (you, supposedly) wasn&#39;t found in the wallet. Try &#39;load&#39;.\n&quot;</span>);
                <span class="keywordflow">return</span> -1;
            }
            <span class="comment">// -----------------------------------------------------------------------</span>
            <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pMerchantNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(thePlan.<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>());

            <span class="comment">//      if (NULL == pMerchantNym)</span>
            <span class="comment">//      {</span>
            <span class="comment">//          OTLog::Output(0, &quot;Merchant Nym wasn&#39;t found in the wallet. Try &#39;load&#39;.\n&quot;);</span>
            <span class="comment">//          // TODO add lookups from address book here as well?</span>
            <span class="comment">//          return -1;</span>
            <span class="comment">//      }</span>
            <span class="comment">// -----------------------------------------------------------------------</span>
            <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePlan.<a class="code" href="class_o_t_agreement.html#aa58d2054b933bffe9c2b2ca5564b7f49">Confirm</a>(*pCustomerNym, pMerchantNym, &amp;thePlan.<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>()))
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error while confirming payment plan. Sorry.\n&quot;</span>);
                <span class="keywordflow">return</span> -1;
            }

            thePlan.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pCustomerNym);
            thePlan.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

            <a class="code" href="class_o_t_string.html">OTString</a> strOutput(thePlan);

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n\nMake sure to submit the payment plan to the server, to activate it:\n\n&quot;</span>);

            <span class="comment">// The above OTLog::Output() actually outputs to stderr (cerr). That&#39;s on purpose.</span>
            <span class="comment">// But the below output actually outputs to stdout, which is also on purpose.</span>
            <span class="comment">//</span>
            std::cout &lt;&lt; strOutput.Get() &lt;&lt; std::endl;

            <span class="keywordflow">return</span> 0; <span class="comment">// no server message being sent, in this case.</span>
        }

        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75">OTClient::paymentPlan</a>: <span class="comment">// Activate a PAYMENT PLAN</span>
        {   
            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym);

            <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan;

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext payment plan. Terminate with ~ on a new line:\n&gt; &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strPlan;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                    (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                {
                    strPlan.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);


            <span class="keywordflow">if</span> (thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPlan))
            {
                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(thePlan.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>());

                <a class="code" href="class_o_t_account.html">OTAccount</a> * pSenderAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID);

                <span class="keywordflow">if</span> (NULL == pSenderAccount)
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;There is no account loaded on this wallet with that sender acct ID, sorry.\n&quot;</span>);
                }
                <span class="keywordflow">if</span> ((NULL != pAccount) &amp;&amp; (pSenderAccount != pAccount))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;This Payment Plan is already confirmed, yet now you try to activate it, and you \n&quot;</span>
                        <span class="stringliteral">&quot;have supplied a different account ID than the one that originally confirmed it.\n&quot;</span>
                        <span class="stringliteral">&quot;Perhaps it&#39;s just an unfortunate default in your ~/.ot/command-line-ot.opt file.\n&quot;</span>
                        <span class="stringliteral">&quot;Be explicit, and use:  --myacct &lt;acct_id&gt;\n&quot;</span>);
                }
                <span class="keywordflow">else</span>
                {   
                    <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct(ACCOUNT_ID);

                    <span class="comment">// Create a transaction</span>
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCOUNT_ID, SERVER_ID, 
                        <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>, thePlan.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>()); 

                    <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);

                    strPlan.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
                    thePlan.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPlan);

                    <span class="comment">// Add the payment plan string as the attachment on the transaction item.</span>
                    pItem-&gt;SetAttachment(strPlan); <span class="comment">// The payment plan is contained in the reference string.</span>

                    <span class="comment">// sign the item</span>
                    pItem-&gt;SignContract(theNym);
                    pItem-&gt;SaveContract();

                    <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>

                    <span class="comment">// ---------------------------------------------</span>
                    <span class="comment">// TRANSACTION AGREEMENT</span>

                    <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
                    <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = theNym.GenerateTransactionStatement(*pTransaction);

                    <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
                        pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>

                    <span class="comment">// ---------------------------------------------</span>

                    <span class="comment">// sign the transaction</span>
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
                    pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="comment">// set up the ledger</span>
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);
                    theLedger.GenerateLedger(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
                    theLedger.AddTransaction(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>

                    <span class="comment">// sign the ledger</span>
                    theLedger.SignContract(theNym);
                    theLedger.SaveContract();

                    <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
                    <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
                    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);

                    <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
                    theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
                    theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
                    theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>

                    <span class="comment">// (1) Set up member variables </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
                    theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
                    theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
                    theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>

                    theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
                    theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;

                    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
                    <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);

                    <span class="keywordflow">if</span> (bNymboxHash)
                        NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
                    <span class="keywordflow">else</span>
                        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
                        str_server.c_str());

                    <span class="comment">// (2) Sign the Message </span>
                    theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        

                    <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
                    theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    bSendCommand = <span class="keyword">true</span>;
                    lReturnValue = lRequestNumber;

                } <span class="comment">// pAccount not NULL          </span>
            } <span class="comment">// thePlan.LoadContractFromString()</span>
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load payment plan from string. Sorry.\n&quot;</span>);
            }

        } <span class="comment">// else if (OTClient::paymentPlan == requestedCommand) // PAYMENT PLAN</span>


        <span class="comment">// ------------------------------------------------------------------------</span>

        <span class="comment">/*</span>
<span class="comment">        else if (OTClient::withdrawTest == requestedCommand) // TEST OF TOKEN BLINDING. NOT PART OF THE REAL PROTOCOL.</span>
<span class="comment">        {   </span>
<span class="comment">        // (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<span class="comment">        theNym.GetCurrentRequestNum(strServerID, lRequestNumber);</span>
<span class="comment">        theMessage.m_strRequestNum.Format(&quot;%lld&quot;, lRequestNumber); // Always have to send this.</span>
<span class="comment">        theNym.IncrementRequestNum(strServerID); // since I used it for a server request, I have to increment it</span>
<span class="comment"></span>
<span class="comment">        // (1) Set up member variables </span>
<span class="comment">        theMessage.m_strCommand         = &quot;debitAccount&quot;;</span>
<span class="comment">        theMessage.m_strNymID           = strNymID;</span>
<span class="comment">        theMessage.m_strServerID        = strServerID;</span>
<span class="comment">        theMessage.SetAcknowledgments(theNym); // Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<span class="comment"></span>
<span class="comment">        theMessage.m_strAssetID         = strContractID;// the hash of the contract is the AssetID</span>
<span class="comment"></span>
<span class="comment">        // (2) Sign the Message </span>
<span class="comment">        OTContract &amp; aSigningDoc = theMessage;</span>
<span class="comment">        aSigningDoc.SignContract(theNym);       </span>
<span class="comment"></span>
<span class="comment">        // (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<span class="comment">        theMessage.SaveContract();</span>
<span class="comment"></span>
<span class="comment">        bSendCommand = true;</span>
<span class="comment">        }</span>
<span class="comment">        */</span>
        <span class="comment">// ------------------------------------------------------------------------</span>
        <span class="keywordflow">break</span>;

    <span class="keywordflow">default</span>:
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
        }
    } <span class="comment">// Get out og the big switch statement!</span>


    <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lReturnValue);

    <span class="comment">//  return bSendCommand;</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a51c30a192bba147351ac5b1e83620afb"></a><!-- doxytag: member="OTClient::ProcessWithdrawalResponse" ref="a51c30a192bba147351ac5b1e83620afb" args="(OTTransaction &amp;theTransaction, OTServerConnection &amp;theConnection, OTMessage &amp;theReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">OTClient::ProcessWithdrawalResponse</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_transaction.html">OTTransaction</a> &amp;&#160;</td>
          <td class="paramname"><em>theTransaction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a> &amp;&#160;</td>
          <td class="paramname"><em>theConnection</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>It's definitely a withdrawal, we just need to iterate through the items in the transaction and grab any cash tokens that are inside, to save inside a purse. Also want to display any vouchers. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l02606">2606</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
    theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);

    <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);

    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);

    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);

    <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>());

    <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to withdrawal.</span>

    <span class="comment">// if pointer not null, and it&#39;s a withdrawal, and it&#39;s an acknowledgement (not a rejection or error)</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
    {
        <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
        <span class="comment">// ----------------------------------------------------------------------------------------</span>
        <span class="comment">// VOUCHER WITHDRAWAL</span>
        <span class="comment">//</span>
        <span class="comment">// If we got a reply to a voucher withdrawal, we&#39;ll just display the voucher</span>
        <span class="comment">// on the screen (if the server sent us one...)</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>  == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
            (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>    == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))
        { 
            <a class="code" href="class_o_t_string.html">OTString</a>    strVoucher;
            <a class="code" href="class_o_t_cheque.html">OTCheque</a>    theVoucher;

            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strVoucher);

            <span class="keywordflow">if</span> (theVoucher.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strVoucher))
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nReceived voucher from server:\n\n%s\n\n&quot;</span>, strVoucher.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());   
            }
        }
        <span class="comment">// ----------------------------------------------------------------------------------------</span>
        <span class="comment">// CASH WITHDRAWAL</span>
        <span class="comment">//</span>
        <span class="comment">// If the item is a response to a cash withdrawal, we want to save the coins into a purse</span>
        <span class="comment">// somewhere on the computer. That&#39;s cash! Gotta keep it safe.</span>
        <span class="comment">//</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>      == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
                 (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>   == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))
        { 
            <a class="code" href="class_o_t_string.html">OTString</a>    strPurse;
            pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPurse);

            <a class="code" href="class_o_t_purse.html">OTPurse</a>     thePurse(SERVER_ID);

            <span class="keywordflow">if</span> (thePurse.LoadContractFromString(strPurse))
            {
                <span class="comment">// When we made the withdrawal request, we saved that purse pointer in the</span>
                <span class="comment">// wallet so that we could get to the private coin unblinding data when we </span>
                <span class="comment">// needed it (now).</span>
                <a class="code" href="class_o_t_purse.html">OTPurse</a> * pRequestPurse     = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a08f39d74540ac2c100ee28d8689af969">GetPendingWithdrawal</a>();
                <a class="code" href="class_o_t_token.html">OTToken</a> * pToken            = NULL;
                <a class="code" href="class_o_t_token.html">OTToken</a> * pOriginalToken    = NULL;

                <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(thePurse.GetAssetID());
                <span class="comment">// -----------------------------------------------------------------</span>
                <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strAssetID);
                <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
                <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
                <span class="comment">// -----------------------------------------------------------------</span>
                <span class="comment">// Unlike the purse which we read out of a message,</span>
                <span class="comment">// now we try to open a purse as a file on the client side,</span>
                <span class="comment">// keyed by Asset ID.  (The client should already have one</span>
                <span class="comment">// purse file for each asset type, if he already has cash.)</span>
                <span class="comment">// </span>
                <span class="comment">// We don&#39;t want to just overwrite that file. So instead, we</span>
                <span class="comment">// try to load that purse first, then add the token, then save it</span>
                <span class="comment">// again.</span>
                <a class="code" href="class_o_t_purse.html">OTPurse</a> theWalletPurse(thePurse);
                <span class="comment">// TODO verify the wallet purse when loaded. My signature should be the last thing on it.</span>

                <span class="comment">// TODO: I don&#39;t check this for failure. If the file doesn&#39;t exist,</span>
                <span class="comment">// we are still going to save the purse there regardless.</span>
                <span class="comment">// HOWEVER need to make sure the wallet software has good backup</span>
                <span class="comment">// strategy.  In the event that tokens are overwritten here, it</span>
                <span class="comment">// shouldn&#39;t be a problem since they would be in the archive somewhere.</span>

                theWalletPurse.LoadPurse(strServerID.Get(), strUserID.Get(), strAssetID.Get());
                <span class="comment">//              if Load, theWalletPurse.VerifySignature();</span>

                <span class="comment">// -------------------------------------------------------------</span>

                <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

                <span class="keywordflow">if</span> ((NULL != pRequestPurse) &amp;&amp; (NULL != pServerNym) &amp;&amp; 
                    pMint-&gt;LoadMint() &amp;&amp; pMint-&gt;VerifyMint(*pServerNym))
                    <span class="keywordflow">while</span> ((pToken = thePurse.Pop(*pNym)) != NULL)
                    {
                        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);

                        pOriginalToken = pRequestPurse-&gt;<a class="code" href="class_o_t_purse.html#a84b70b093c79a796815d9a42c8d3bd74">Pop</a>(*pNym);

                        <span class="keywordflow">if</span> (NULL == pOriginalToken)
                        {
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR, processing withdrawal response, but couldn&#39;t find original token:%s\n&quot;</span>, strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_token.html#ad0fb0c562a9e37fcdb561e56075672ddade23d1dd76bccd72a985f722f6ce74bd">OTToken::signedToken</a> == pToken-&gt;<a class="code" href="class_o_t_token.html#a0b7813d8f9c8564904a7efa3be0f5a7e">GetState</a>())
                        {
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Retrieved signed token from purse, and have corresponding withdrawal request in wallet. Unblinding...\n\n&quot;</span>);

                            <span class="keywordflow">if</span> (pToken-&gt;<a class="code" href="class_o_t_token.html#a088fd14cc04aabcf3fcd47a7028b461d">ProcessToken</a>(*pNym, *pMint, *pOriginalToken))
                            {
                                <span class="comment">// Now that it&#39;s processed, let&#39;s save it again.</span>
                                pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
                                pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                                bSuccess = <span class="keyword">true</span>;

                                <span class="comment">// add it to the existing client-side purse for storing tokens of that asset type</span>
                                theWalletPurse.Push(*pNym, *pToken);
                            }
                            <span class="keywordflow">else</span> 
                            {
                                bSuccess = <span class="keyword">false</span>;
                                <span class="keywordflow">if</span> (pToken)
                                {
                                    <span class="keyword">delete</span> pToken;
                                    pToken = NULL;
                                }
                                <span class="comment">// The while loop starts by allocating a pOriginalToken, so I want to </span>
                                <span class="comment">// delete it for each iteration and keep things clean.</span>
                                <span class="keywordflow">if</span> (pOriginalToken)
                                {
                                    <span class="keyword">delete</span> pOriginalToken;
                                    pOriginalToken = NULL;
                                }                           
                                <span class="keywordflow">break</span>;
                            }
                        }

                        <span class="comment">// The while loop starts by allocating a pToken, so I want to </span>
                        <span class="comment">// delete it for each iteration and keep things clean.</span>
                        <span class="keywordflow">if</span> (NULL != pToken)
                        {
                            <span class="keyword">delete</span> pToken;
                            pToken = NULL;
                        }
                        <span class="comment">// The while loop starts by allocating a pOriginalToken, so I want to </span>
                        <span class="comment">// delete it for each iteration and keep things clean.</span>
                        <span class="keywordflow">if</span> (pOriginalToken)
                        {
                            <span class="keyword">delete</span> pOriginalToken;
                            pOriginalToken = NULL;
                        }
                    } <span class="comment">// while (pToken = thePurse.Pop(*pNym))</span>

                    <span class="keywordflow">if</span> (bSuccess)
                    {
                        <span class="comment">// Sign it, save it.</span>
                        theWalletPurse.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// Might as well, they&#39;re no good anyway once the data has changed.</span>
                        theWalletPurse.SignContract(*pNym);
                        theWalletPurse.SaveContract();
                        theWalletPurse.SavePurse(strServerID.Get(), strUserID.Get(), strAssetID.Get());

                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;SUCCESSFULLY UNBLINDED token, and added the cash to the local purse, and saved.\n&quot;</span>);
                    }
            } <span class="comment">// if (thePurse.LoadContractFromString(strPurse))</span>
        }
    } <span class="comment">// for</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a36a2c3be7c495a38f4ee0089527df638"></a><!-- doxytag: member="OTClient::SetFocusToServerAndNym" ref="a36a2c3be7c495a38f4ee0089527df638" args="(OTServerContract &amp;theServerContract, OTPseudonym &amp;theNym, TransportCallback *pCallback)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">OTClient::SetFocusToServerAndNym</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerContract</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_transport_callback.html">TransportCallback</a> *&#160;</td>
          <td class="paramname"><em>pCallback</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Used in RPC mode (instead of Connect.) Whenever a message needs to be processed, this function is called first, in lieu of Connect(), so that the right pointers and IDs are in place for <a class="el" href="class_o_t_client.html">OTClient</a> to do its thing. </p>

<p>Definition at line <a class="el" href="_o_t_client_8cpp_source.html#l10666">10666</a> of file <a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pCallback);
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);

    <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#a7415f258bbfe6295f87a366b1c93dde0">SetFocus</a>(theNym, theServerContract, pCallback);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7b1155d15226f5b512d7dd2c839a8cb9"></a><!-- doxytag: member="OTClient::SetRunningAsScript" ref="a7b1155d15226f5b512d7dd2c839a8cb9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client.html#a7b1155d15226f5b512d7dd2c839a8cb9">OTClient::SetRunningAsScript</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00190">190</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ m_bRunningAsScript = <span class="keyword">true</span>; } <span class="comment">// (default is false.)</span>
</pre></div>
</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a8d45ac1c031bb12782e5ce0d2ca60597"></a><!-- doxytag: member="OTClient::m_bInitialized" ref="a8d45ac1c031bb12782e5ce0d2ca60597" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">OTClient::m_bInitialized</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00314">314</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>

</div>
</div>
<a class="anchor" id="a056ffd57844757386743f7aac5cf1a32"></a><!-- doxytag: member="OTClient::m_lMostRecentRequestNumber" ref="a056ffd57844757386743f7aac5cf1a32" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int64_t <a class="el" href="class_o_t_client.html#a056ffd57844757386743f7aac5cf1a32">OTClient::m_lMostRecentRequestNumber</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Any time a message is sent to the server, its request number is copied here. Most server message functions return int32_t, but technically a request number can be int64_t. So if the number being returned is too large for that int32_t, it will return -2 instead, and then another function can be called that returns lMostRecentRequestNumber in string form, or whatever is easiest. </p>

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00185">185</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>

</div>
</div>
<a class="anchor" id="a28169697045727fc9e3bb2228a0fd21d"></a><!-- doxytag: member="OTClient::m_pConnection" ref="a28169697045727fc9e3bb2228a0fd21d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a>* <a class="el" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">OTClient::m_pConnection</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_8hpp_source.html#l00292">292</a> of file <a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/otapi/<a class="el" href="_o_t_client_8hpp_source.html">OTClient.hpp</a></li>
<li>src/otapi/<a class="el" href="_o_t_client_8cpp_source.html">OTClient.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_o_t_client.html">OTClient</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:11 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
