<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otlib/OTTransaction.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_transaction_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otlib/OTTransaction.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_transaction_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *    </span>
<a name="l00003"></a>00003 <span class="comment"> *  OTTransaction.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *  </span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"> </span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"> </span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"> </span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_transaction_8hpp.html">OTTransaction.hpp</a>&gt;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00138"></a>00138 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cheque_8hpp.html">OTCheque.hpp</a>&gt;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_ledger_8hpp.html">OTLedger.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_pseudonym_8hpp.html">OTPseudonym.hpp</a>&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_trade_8hpp.html">OTTrade.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_plan_8hpp.html">OTPaymentPlan.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_smart_contract_8hpp.html">OTSmartContract.hpp</a>&gt;</span>
<a name="l00145"></a>00145 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_basket_8hpp.html">OTBasket.hpp</a>&gt;</span>
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_message_8hpp.html">OTMessage.hpp</a>&gt;</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="preprocessor">#include &quot;irrxml/irrXML.hpp&quot;</span>
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="_o_t_transaction_8cpp.html#a26fff90a622c312ec2140eb6ae9f819c">00151</a> <span class="keywordtype">char</span> <span class="keyword">const</span> * <span class="keyword">const</span> <a class="code" href="_o_t_account_8cpp.html#a26fff90a622c312ec2140eb6ae9f819c">__TypeStrings</a>[] = 
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="stringliteral">&quot;blank&quot;</span>,            <span class="comment">// freshly issued, not used yet  // comes from server, stored on Nym. (Nymbox.)</span>
<a name="l00154"></a>00154     <span class="stringliteral">&quot;message&quot;</span>,          <span class="comment">// in nymbox, message from one user to another.</span>
<a name="l00155"></a>00155     <span class="stringliteral">&quot;notice&quot;</span>,           <span class="comment">// in nymbox, notice from the server. Probably contains an updated smart contract.</span>
<a name="l00156"></a>00156     <span class="stringliteral">&quot;replyNotice&quot;</span>,      <span class="comment">// When you send a request to the server, sometimes its reply is so important, </span>
<a name="l00157"></a>00157                         <span class="comment">// that it drops a copy into your Nymbox to make you receive and process it.</span>
<a name="l00158"></a>00158     <span class="stringliteral">&quot;successNotice&quot;</span>,    <span class="comment">// A transaction # has successfully been signed out. (Nymbox.)</span>
<a name="l00159"></a>00159     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00160"></a>00160     <span class="stringliteral">&quot;pending&quot;</span>,          <span class="comment">// Pending transfer, in the inbox/outbox.</span>
<a name="l00161"></a>00161     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00162"></a>00162     <span class="stringliteral">&quot;transferReceipt&quot;</span>,  <span class="comment">// the server drops this into your inbox, when someone accepts your transfer.</span>
<a name="l00163"></a>00163     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00164"></a>00164     <span class="stringliteral">&quot;chequeReceipt&quot;</span>,    <span class="comment">// the server drops this into your inbox, when someone deposits your cheque.</span>
<a name="l00165"></a>00165     <span class="stringliteral">&quot;voucherReceipt&quot;</span>,   <span class="comment">// the server drops this into your inbox, when someone deposits your voucher.</span>
<a name="l00166"></a>00166     <span class="stringliteral">&quot;marketReceipt&quot;</span>,    <span class="comment">// server drops this into inbox periodically, if you have an offer on the market.</span>
<a name="l00167"></a>00167     <span class="stringliteral">&quot;paymentReceipt&quot;</span>,   <span class="comment">// the server drops this into people&#39;s inboxes, periodically, if they have payment plans.</span>
<a name="l00168"></a>00168     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00169"></a>00169     <span class="stringliteral">&quot;finalReceipt&quot;</span>,     <span class="comment">// the server drops this into your inbox(es), when a CronItem expires or is canceled.</span>
<a name="l00170"></a>00170     <span class="stringliteral">&quot;basketReceipt&quot;</span>,    <span class="comment">// the server drops this into your inboxes, when a basket exchange is processed.</span>
<a name="l00171"></a>00171     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00172"></a>00172     <span class="stringliteral">&quot;instrumentNotice&quot;</span>,     <span class="comment">// Receive these in paymentInbox (by way of Nymbox), and send in Outpayments (like outMail.) (When done, they go to recordBox or expiredBox to await deletion.)</span>
<a name="l00173"></a>00173     <span class="stringliteral">&quot;instrumentRejection&quot;</span>,  <span class="comment">// When someone rejects your invoice from his paymentInbox, you get one of these in YOUR paymentInbox.</span>
<a name="l00174"></a>00174     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00175"></a>00175     <span class="stringliteral">&quot;processNymbox&quot;</span>,    <span class="comment">// process nymbox transaction    // comes from client</span>
<a name="l00176"></a>00176     <span class="stringliteral">&quot;atProcessNymbox&quot;</span>,  <span class="comment">// process nymbox reply          // comes from server</span>
<a name="l00177"></a>00177     <span class="stringliteral">&quot;processInbox&quot;</span>,     <span class="comment">// process inbox transaction     // comes from client</span>
<a name="l00178"></a>00178     <span class="stringliteral">&quot;atProcessInbox&quot;</span>,   <span class="comment">// process inbox reply           // comes from server</span>
<a name="l00179"></a>00179     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00180"></a>00180     <span class="stringliteral">&quot;transfer&quot;</span>,         <span class="comment">// or &quot;spend&quot;. This transaction is a transfer from one account to another</span>
<a name="l00181"></a>00181     <span class="stringliteral">&quot;atTransfer&quot;</span>,       <span class="comment">// reply from the server regarding a transfer request</span>
<a name="l00182"></a>00182     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00183"></a>00183     <span class="stringliteral">&quot;deposit&quot;</span>,          <span class="comment">// this transaction is a deposit of bearer tokens (from client)</span>
<a name="l00184"></a>00184     <span class="stringliteral">&quot;atDeposit&quot;</span>,        <span class="comment">// reply from the server regarding a deposit request</span>
<a name="l00185"></a>00185     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00186"></a>00186     <span class="stringliteral">&quot;withdrawal&quot;</span>,       <span class="comment">// this transaction is a withdrawal of bearer tokens</span>
<a name="l00187"></a>00187     <span class="stringliteral">&quot;atWithdrawal&quot;</span>,     <span class="comment">// reply from the server regarding a withdrawal request</span>
<a name="l00188"></a>00188     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00189"></a>00189     <span class="stringliteral">&quot;marketOffer&quot;</span>,      <span class="comment">// this transaction is a market offer</span>
<a name="l00190"></a>00190     <span class="stringliteral">&quot;atMarketOffer&quot;</span>,    <span class="comment">// reply from the server regarding a market offer</span>
<a name="l00191"></a>00191     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00192"></a>00192     <span class="stringliteral">&quot;paymentPlan&quot;</span>,      <span class="comment">// this transaction is a payment plan</span>
<a name="l00193"></a>00193     <span class="stringliteral">&quot;atPaymentPlan&quot;</span>,    <span class="comment">// reply from the server regarding a payment plan</span>
<a name="l00194"></a>00194     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00195"></a>00195     <span class="stringliteral">&quot;smartContract&quot;</span>,    <span class="comment">// this transaction is a smart contract</span>
<a name="l00196"></a>00196     <span class="stringliteral">&quot;atSmartContract&quot;</span>,  <span class="comment">// reply from the server regarding a smart contract</span>
<a name="l00197"></a>00197     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00198"></a>00198     <span class="stringliteral">&quot;cancelCronItem&quot;</span>,   <span class="comment">// this transaction is a cancellation of a cron item (payment plan etc)</span>
<a name="l00199"></a>00199     <span class="stringliteral">&quot;atCancelCronItem&quot;</span>, <span class="comment">// reply from the server regarding said cancellation.</span>
<a name="l00200"></a>00200     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00201"></a>00201     <span class="stringliteral">&quot;exchangeBasket&quot;</span>,   <span class="comment">// this transaction is an exchange in/out of a basket currency.</span>
<a name="l00202"></a>00202     <span class="stringliteral">&quot;atExchangeBasket&quot;</span>, <span class="comment">// reply from the server regarding said exchange.</span>
<a name="l00203"></a>00203     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00204"></a>00204     <span class="stringliteral">&quot;payDividend&quot;</span>,      <span class="comment">// this transaction is a dividend payment (to the shareholders.)</span>
<a name="l00205"></a>00205     <span class="stringliteral">&quot;atPayDividend&quot;</span>,    <span class="comment">// reply from the server regarding said dividend payment.</span>
<a name="l00206"></a>00206     <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00207"></a>00207     <span class="stringliteral">&quot;error_state&quot;</span>   
<a name="l00208"></a>00208 };
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="class_o_t_transaction.html#ab32a4098c75d0e48616e65caafa60fe0">00211</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="class_o_t_transaction.html#ab32a4098c75d0e48616e65caafa60fe0">OTTransaction::_GetTypeString</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">transactionType</a> theType) {
<a name="l00212"></a>00212     int32_t nType = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span> (theType);
<a name="l00213"></a>00213     <span class="keywordflow">return</span> <a class="code" href="_o_t_account_8cpp.html#a26fff90a622c312ec2140eb6ae9f819c">__TypeStrings</a>[nType];
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="comment">// Used in balance agreement, part of the inbox report.</span>
<a name="l00218"></a><a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">00218</a> int64_t <a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">OTTransaction::GetClosingNum</a>()<span class="keyword"> const</span>
<a name="l00219"></a>00219 <span class="keyword"></span>{
<a name="l00220"></a>00220     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a>; 
<a name="l00221"></a>00221 }   
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a><a class="code" href="class_o_t_transaction.html#af3c025bbdeb70a053c6149a32d8b9940">00224</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#af3c025bbdeb70a053c6149a32d8b9940">OTTransaction::SetClosingNum</a>(<span class="keyword">const</span> int64_t lClosingNum)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a> = lClosingNum;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="comment">// Make sure this contract checks out. Very high level. </span>
<a name="l00231"></a>00231 <span class="comment">// Verifies ID and signature.</span>
<a name="l00232"></a>00232 <span class="comment">// I do NOT call VerifyOwner() here, because the server may</span>
<a name="l00233"></a>00233 <span class="comment">// wish to verify its signature on this account, even though</span>
<a name="l00234"></a>00234 <span class="comment">// the server may not be the actual owner.</span>
<a name="l00235"></a>00235 <span class="comment">// So if you wish to VerifyOwner(), then call it.</span>
<a name="l00236"></a>00236 <span class="comment">//</span>
<a name="l00237"></a>00237 <span class="comment">// This overrides from OTTransactionType::VerifyAccount()</span>
<a name="l00238"></a>00238 <span class="comment">//</span>
<a name="l00239"></a><a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">00239</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">OTTransaction::VerifyAccount</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pParent = <span class="keyword">const_cast&lt;</span><a class="code" href="class_o_t_ledger.html">OTLedger</a> *<span class="keyword">&gt;</span>(<a class="code" href="class_o_t_transaction.html#abb869752baf350d380c0afa81d84d1de">m_pParent</a>);
<a name="l00242"></a>00242     
<a name="l00243"></a>00243     <span class="comment">// Make sure that the supposed AcctID matches the one read from the file.</span>
<a name="l00244"></a>00244     <span class="comment">//</span>
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>())
<a name="l00246"></a>00246     {
<a name="l00247"></a>00247         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error verifying account ID.\n&quot;</span>,
<a name="l00248"></a>00248                       __FUNCTION__);
<a name="l00249"></a>00249         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     <span class="comment">// todo security audit:</span>
<a name="l00252"></a>00252     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>() &amp;&amp; (pParent != NULL) &amp;&amp; !pParent-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym))
<a name="l00253"></a>00253     {
<a name="l00254"></a>00254         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error verifying signature on parent ledger for abbreviated transaction receipt.\n&quot;</span>,
<a name="l00255"></a>00255                       __FUNCTION__);
<a name="l00256"></a>00256         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>() &amp;&amp; (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym)))
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error verifying signature.\n&quot;</span>, __FUNCTION__);
<a name="l00261"></a>00261         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263     
<a name="l00264"></a>00264     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;\nWe now know that...\n&quot;</span>
<a name="l00265"></a>00265                   <span class="stringliteral">&quot;1) The expected Account ID matches the ID that was found on the object.\n&quot;</span>
<a name="l00266"></a>00266                   <span class="stringliteral">&quot;2) The SIGNATURE VERIFIED on the object.\n\n&quot;</span>);
<a name="l00267"></a>00267     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="comment">/*</span>
<a name="l00272"></a>00272 <span class="comment">//                      **** MESSAGE TRANSACTIONS ****</span>
<a name="l00273"></a>00273 <span class="comment">// --------------------------------------------------------------------------------------       </span>
<a name="l00274"></a>00274 <span class="comment">        processNymbox,  // process nymbox transaction    // comes from client</span>
<a name="l00275"></a>00275 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00276"></a>00276 <span class="comment">        processInbox,   // process inbox transaction     // comes from client</span>
<a name="l00277"></a>00277 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00278"></a>00278 <span class="comment">        transfer,       // or &quot;spend&quot;. This transaction is a request to transfer from one account to another</span>
<a name="l00279"></a>00279 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00280"></a>00280 <span class="comment">        deposit,        // this transaction is a deposit (cash or cheque)</span>
<a name="l00281"></a>00281 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00282"></a>00282 <span class="comment">        withdrawal,     // this transaction is a withdrawal (cash or voucher)</span>
<a name="l00283"></a>00283 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00284"></a>00284 <span class="comment">        marketOffer,    // this transaction is a market offer</span>
<a name="l00285"></a>00285 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00286"></a>00286 <span class="comment">        paymentPlan,    // this transaction is a payment plan</span>
<a name="l00287"></a>00287 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00288"></a>00288 <span class="comment">        smartContract,  // this transaction is a smart contract</span>
<a name="l00289"></a>00289 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00290"></a>00290 <span class="comment">        cancelCronItem, // this transaction is intended to cancel a market offer or payment plan.</span>
<a name="l00291"></a>00291 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00292"></a>00292 <span class="comment">        exchangeBasket, // this transaction is an exchange in/out of a basket currency.</span>
<a name="l00293"></a>00293 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00294"></a>00294 <span class="comment">        payDividend,    // this transaction is a dividend payment (to shareholders.)</span>
<a name="l00295"></a>00295 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l00296"></a>00296 <span class="comment"> </span>
<a name="l00297"></a>00297 <span class="comment"></span>
<a name="l00298"></a>00298 <span class="comment"> HarvestOpeningNumber:</span>
<a name="l00299"></a>00299 <span class="comment"> </span>
<a name="l00300"></a>00300 <span class="comment">// processNymbox,     // process nymbox transaction  // comes from client  // HUH?? This message doesn&#39;t use a transaction number. That&#39;s the whole point of processNymbox is that it doesn&#39;t require such a number.</span>
<a name="l00301"></a>00301 <span class="comment"> processInbox,      // process inbox transaction     // comes from client</span>
<a name="l00302"></a>00302 <span class="comment"> transfer,          // or &quot;spend&quot;. This transaction is a request to transfer from one account to another</span>
<a name="l00303"></a>00303 <span class="comment"> deposit,           // this transaction is a deposit (cash or cheque)</span>
<a name="l00304"></a>00304 <span class="comment"> withdrawal,        // this transaction is a withdrawal (cash or voucher)</span>
<a name="l00305"></a>00305 <span class="comment"> marketOffer,       // this transaction is a market offer</span>
<a name="l00306"></a>00306 <span class="comment"> paymentPlan,       // this transaction is a payment plan</span>
<a name="l00307"></a>00307 <span class="comment"> smartContract,     // this transaction is a smart contract</span>
<a name="l00308"></a>00308 <span class="comment"> cancelCronItem,    // this transaction is intended to cancel a market offer or payment plan.</span>
<a name="l00309"></a>00309 <span class="comment"> exchangeBasket,    // this transaction is an exchange in/out of a basket currency.</span>
<a name="l00310"></a>00310 <span class="comment"> payDividend,       // this transaction is dividend payment (to shareholders.)</span>
<a name="l00311"></a>00311 <span class="comment"></span>
<a name="l00312"></a>00312 <span class="comment"> // --------------------------------------------------------------------------------------</span>
<a name="l00313"></a>00313 <span class="comment"></span>
<a name="l00314"></a>00314 <span class="comment"> HarvestClosingNumbers:    (The X&#39;s means &quot;not needed for closing numbers)</span>
<a name="l00315"></a>00315 <span class="comment"> </span>
<a name="l00316"></a>00316 <span class="comment">// X processNymbox,     // process nymbox transaction    // comes from client  // HUH?? The whole point of processNymbox is that it uses no transaction numbers.</span>
<a name="l00317"></a>00317 <span class="comment"> X processInbox,      // process inbox transaction   // comes from client</span>
<a name="l00318"></a>00318 <span class="comment"> X transfer,          // or &quot;spend&quot;. This transaction is a request to transfer from one account to another</span>
<a name="l00319"></a>00319 <span class="comment"> X deposit,           // this transaction is a deposit (cash or cheque)</span>
<a name="l00320"></a>00320 <span class="comment"> X withdrawal,        // this transaction is a withdrawal (cash or voucher)</span>
<a name="l00321"></a>00321 <span class="comment"> X cancelCronItem,    // this transaction is intended to cancel a market offer or payment plan.</span>
<a name="l00322"></a>00322 <span class="comment"> X payDividend,       // this transaction is a dividend payment (to shareholders.)</span>
<a name="l00323"></a>00323 <span class="comment"> </span>
<a name="l00324"></a>00324 <span class="comment"> // ONLY THESE:</span>
<a name="l00325"></a>00325 <span class="comment"> marketOffer,       // This contains one opening number, and two closing numbers.</span>
<a name="l00326"></a>00326 <span class="comment"> paymentPlan,       // This contains one primary opening number (from the payer) and his closing number,</span>
<a name="l00327"></a>00327 <span class="comment"> // as well as the opening and closing numbers for the payee. NOTE: Unless the paymentPlan SUCCEEDED in </span>
<a name="l00328"></a>00328 <span class="comment"> // activating, then the SENDER&#39;s numbers are both still good. (Normally even attempting a transaction</span>
<a name="l00329"></a>00329 <span class="comment"> // will burn the opening number, which IS the case here, for the payer. But the PAYEE only burns his</span>
<a name="l00330"></a>00330 <span class="comment"> // opening number IF SUCCESS. Thus, even if the message succeeded but the transaction failed, where</span>
<a name="l00331"></a>00331 <span class="comment"> // normally the opening number is burned, it&#39;s still good for the PAYEE (not the payer.) Therefore we</span>
<a name="l00332"></a>00332 <span class="comment"> // need to make sure, in the case of paymentPlan, that we still claw back the opening number (FOR THE</span>
<a name="l00333"></a>00333 <span class="comment"> // PAYEE) in the place where we normally would only claw back the closing number. </span>
<a name="l00334"></a>00334 <span class="comment"> smartContract,     // This contains an opening number for each party, and a closing number for each</span>
<a name="l00335"></a>00335 <span class="comment"> // asset account. </span>
<a name="l00336"></a>00336 <span class="comment"> </span>
<a name="l00337"></a>00337 <span class="comment"> </span>
<a name="l00338"></a>00338 <span class="comment"> </span>
<a name="l00339"></a>00339 <span class="comment"> exchangeBasket,    // this transaction is an exchange in/out of a basket currency.</span>
<a name="l00340"></a>00340 <span class="comment"></span>
<a name="l00341"></a>00341 <span class="comment"> // --------------------------------------------------------------------------------------</span>
<a name="l00342"></a>00342 <span class="comment"></span>
<a name="l00343"></a>00343 <span class="comment"> */</span>
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment">// Only do this if the message itself failed, meaning this transaction never even</span>
<a name="l00346"></a>00346 <span class="comment">// attempted, and thus this transaction NEVER EVEN HAD A *CHANCE* TO FAIL, and thus</span>
<a name="l00347"></a>00347 <span class="comment">// the opening number never got burned (Normally no point in harvesting a burned</span>
<a name="l00348"></a>00348 <span class="comment">// number, now is there?)</span>
<a name="l00349"></a>00349 <span class="comment">//</span>
<a name="l00350"></a>00350 <span class="comment">// Client-side.</span>
<a name="l00351"></a>00351 <span class="comment">//</span>
<a name="l00352"></a>00352 <span class="comment">// Returns true/false whether it actually harvested a number.</span>
<a name="l00353"></a>00353 <span class="comment">//</span>
<a name="l00354"></a><a class="code" href="class_o_t_transaction.html#ac8a30dd62230f12131a77471796fd88a">00354</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#ac8a30dd62230f12131a77471796fd88a">OTTransaction::HarvestOpeningNumber</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l00355"></a>00355                                          <span class="keyword">const</span> <span class="keywordtype">bool</span> bHarvestingForRetry,    <span class="comment">// The message was sent, failed somehow, and is now being re-tried.</span>
<a name="l00356"></a>00356                                          <span class="keyword">const</span> <span class="keywordtype">bool</span> bReplyWasSuccess,       <span class="comment">// Message was a success? false until positively asserted.</span>
<a name="l00357"></a>00357                                          <span class="keyword">const</span> <span class="keywordtype">bool</span> bReplyWasFailure,       <span class="comment">// Message received &quot;failure&quot; ? false until positively asserted.</span>
<a name="l00358"></a>00358                                          <span class="keyword">const</span> <span class="keywordtype">bool</span> bTransactionWasSuccess, <span class="comment">// false until positively asserted.</span>
<a name="l00359"></a>00359                                          <span class="keyword">const</span> <span class="keywordtype">bool</span> bTransactionWasFailure) <span class="comment">// false until positively asserted.</span>
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>)
<a name="l00364"></a>00364     {
<a name="l00365"></a>00365             <span class="comment">// Note: the below remarks about &quot;success or fail&quot; are specific to TRANSACTION success, not message success.</span>
<a name="l00366"></a>00366 <span class="comment">//      case OTTransaction::processNymbox:  // NOTE: why was this here? You don&#39;t need trans#s to process a Nymbox--that&#39;s the whole point of a Nymbox.</span>
<a name="l00367"></a>00367         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>:   <span class="comment">// Uses 1 transaction #, the opening number, and burns it whether transaction is success-or-fail.</span>
<a name="l00368"></a>00368         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>:     <span class="comment">// Uses 1 transaction #, the opening number, and burns it whether transaction is success-or-fail.</span>
<a name="l00369"></a>00369         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>:        <span class="comment">// Uses 1 transaction #, the opening number, and burns it whether transaction is success-or-fail.</span>
<a name="l00370"></a>00370         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>: <span class="comment">// Uses 1 transaction #, the opening number, and burns it whether transaction is success-or-fail. </span>
<a name="l00371"></a>00371         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>:    <span class="comment">// Uses 1 transaction #, the opening number, and burns it whether transaction is success-or-fail. </span>
<a name="l00372"></a>00372             
<a name="l00373"></a>00373             <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00374"></a>00374             <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00375"></a>00375             <span class="comment">//</span>
<a name="l00376"></a>00376             <span class="comment">// Note: what if, instead, I don&#39;t know whether the transaction itself failed, because I don&#39;t have a reply message?</span>
<a name="l00377"></a>00377             <span class="comment">// In that case, I cannot claw back the numbers because I don&#39;t know for sure. But my future transactions WILL fail if</span>
<a name="l00378"></a>00378             <span class="comment">// my nymbox hash goes out of sync, so if that transaction DID process, then I&#39;ll find out right away, and I&#39;ll be forced</span>
<a name="l00379"></a>00379             <span class="comment">// to download the nymbox and box receipts in order to get back into sync again. And if the transaction did NOT process,</span>
<a name="l00380"></a>00380             <span class="comment">// then I&#39;ll know it when I don&#39;t find it among the receipts. In which case I can pull the original message from the</span>
<a name="l00381"></a>00381             <span class="comment">// outbuffer, using the request number from when it was sent, and then harvest it from there.</span>
<a name="l00382"></a>00382             <span class="comment">//</span>
<a name="l00383"></a>00383             <span class="keywordflow">if</span> (bReplyWasFailure)   <span class="comment">// NOTE: If I&#39;m harvesting for a re-try, </span>
<a name="l00384"></a>00384             {
<a name="l00385"></a>00385                 bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l00386"></a>00386                                                             <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00387"></a>00387             }
<a name="l00388"></a>00388             <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY BURNED.</span>
<a name="l00389"></a>00389             <span class="comment">// (Why? Because that means the transaction definitely ran--and the opener is burned success-or-fail, if the transaction runs.)</span>
<a name="l00390"></a>00390             <span class="comment">//</span>
<a name="l00391"></a>00391             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00392"></a>00392             {
<a name="l00393"></a>00393                 <span class="comment">// The opener is DEFINITELY BAD, so therefore, we&#39;re definitely not going to claw it back!</span>
<a name="l00394"></a>00394                 <span class="comment">//</span>
<a name="l00395"></a>00395 <span class="comment">//              bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00396"></a>00396 <span class="comment">//                                                          GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398             <span class="keywordflow">break</span>;
<a name="l00399"></a>00399             
<a name="l00400"></a>00400         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>:       <span class="comment">// Uses 1 transaction #, the opening number, and burns it if failure. But if success, merely marks it as &quot;used.&quot;</span>
<a name="l00401"></a>00401             
<a name="l00402"></a>00402             <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00403"></a>00403             <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00404"></a>00404             <span class="comment">//</span>
<a name="l00405"></a>00405             <span class="keywordflow">if</span> (bReplyWasFailure)
<a name="l00406"></a>00406             {
<a name="l00407"></a>00407                 bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(),
<a name="l00408"></a>00408                                                             <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00409"></a>00409             }
<a name="l00410"></a>00410             <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l00411"></a>00411             <span class="comment">// Why? Because that means the transaction definitely ran--and the opener is marked as &quot;used&quot; on success, and &quot;burned&quot; on</span>
<a name="l00412"></a>00412             <span class="comment">// failure--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l00413"></a>00413             <span class="comment">//</span>
<a name="l00414"></a>00414             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00415"></a>00415             {
<a name="l00416"></a>00416                 <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00417"></a>00417                 {
<a name="l00418"></a>00418                     <span class="comment">// This means the &quot;transfer&quot; transaction# is STILL MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00419"></a>00419                     <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l00420"></a>00420 <span class="comment">//                  bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00421"></a>00421 <span class="comment">//                                                              GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00422"></a>00422                 }
<a name="l00423"></a>00423                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure)
<a name="l00424"></a>00424                 {
<a name="l00425"></a>00425                     <span class="comment">// Whereas if the transaction was a failure, that means the transaction number was DEFINITELY burned.</span>
<a name="l00426"></a>00426                     <span class="comment">// (No point clawing it back now--it&#39;s gone already.)</span>
<a name="l00427"></a>00427 <span class="comment">//                  bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00428"></a>00428 <span class="comment">//                                                              GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00429"></a>00429                 }
<a name="l00430"></a>00430             }
<a name="l00431"></a>00431             <span class="keywordflow">break</span>;            
<a name="l00432"></a>00432             
<a name="l00433"></a>00433         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>:    <span class="comment">// Uses 3 transaction #s, the opening number and 2 closers. If failure, opener is burned.</span>
<a name="l00434"></a>00434                                             <span class="comment">// But if success, merely marks it as &quot;used.&quot; Closers are also marked &quot;used&quot; if success,</span>
<a name="l00435"></a>00435                                             <span class="comment">// but if message succeeds while transaction fails, then closers can be harvested.</span>
<a name="l00436"></a>00436             <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00437"></a>00437             <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00438"></a>00438             <span class="comment">//</span>
<a name="l00439"></a>00439             <span class="keywordflow">if</span> (bReplyWasFailure)
<a name="l00440"></a>00440             {
<a name="l00441"></a>00441                 bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l00442"></a>00442                                                             <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00443"></a>00443             }
<a name="l00444"></a>00444             <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l00445"></a>00445             <span class="comment">// Why? Because that means the transaction definitely ran--and the opener is marked as &quot;used&quot; on success, and &quot;burned&quot; on</span>
<a name="l00446"></a>00446             <span class="comment">// failure--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l00447"></a>00447             <span class="comment">//</span>
<a name="l00448"></a>00448             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00449"></a>00449             {
<a name="l00450"></a>00450                 <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00451"></a>00451                 {
<a name="l00452"></a>00452                     <span class="comment">// This means the &quot;marketOffer&quot; transaction# is STILL MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00453"></a>00453                     <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l00454"></a>00454 <span class="comment">//                  bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00455"></a>00455 <span class="comment">//                                                              GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00456"></a>00456                 }
<a name="l00457"></a>00457                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure)
<a name="l00458"></a>00458                 {
<a name="l00459"></a>00459                     <span class="comment">// Whereas if the transaction was a failure, that means the transaction number was DEFINITELY burned.</span>
<a name="l00460"></a>00460                     <span class="comment">// (No point clawing it back now--it&#39;s gone already.)</span>
<a name="l00461"></a>00461 <span class="comment">//                  bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00462"></a>00462 <span class="comment">//                                                              GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00463"></a>00463                 }
<a name="l00464"></a>00464             }
<a name="l00465"></a>00465             
<a name="l00466"></a>00466             <span class="keywordflow">break</span>;
<a name="l00467"></a>00467             
<a name="l00468"></a>00468         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>: <span class="comment">// Uses X transaction #s: the opener, which is burned success-or-fail, and Y closers (one for</span>
<a name="l00469"></a>00469                                             <span class="comment">// each account.) Closers are marked &quot;used&quot; if success transaction, but if message succeeds while</span>
<a name="l00470"></a>00470                                             <span class="comment">// transaction fails, then closers can be harvested.</span>
<a name="l00471"></a>00471             <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00472"></a>00472             <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00473"></a>00473             <span class="comment">//</span>
<a name="l00474"></a>00474             <span class="keywordflow">if</span> (bReplyWasFailure)
<a name="l00475"></a>00475             {
<a name="l00476"></a>00476                 bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l00477"></a>00477                                                             <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00478"></a>00478             }
<a name="l00479"></a>00479             <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY BURNED.</span>
<a name="l00480"></a>00480             <span class="comment">// (Why? Because that means the transaction definitely ran--and the opener is burned &quot;success-or-fail&quot;, if this transaction runs.)</span>
<a name="l00481"></a>00481             <span class="comment">//</span>
<a name="l00482"></a>00482             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00483"></a>00483             {
<a name="l00484"></a>00484                 <span class="comment">// The opener is DEFINITELY BURNED, so therefore, we&#39;re definitely not going to claw it back!</span>
<a name="l00485"></a>00485                 <span class="comment">//</span>
<a name="l00486"></a>00486 <span class="comment">//              bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00487"></a>00487 <span class="comment">//                                                          GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00488"></a>00488             }
<a name="l00489"></a>00489             <span class="keywordflow">break</span>;
<a name="l00490"></a>00490             
<a name="l00491"></a>00491             <span class="comment">// These aren&#39;t AS simple.</span>
<a name="l00492"></a>00492         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>:    <span class="comment">// Uses 4 transaction #s: the opener (sender&#39;s #), which burned on failure but kept alive on success,</span>
<a name="l00493"></a>00493                                             <span class="comment">// the sender&#39;s closer, which is only marked as &quot;used&quot; upon success, and the recipient&#39;s opening and</span>
<a name="l00494"></a>00494                                             <span class="comment">// closing numbers, which are both only marked as &quot;used&quot; upon success.</span>
<a name="l00495"></a>00495         {
<a name="l00496"></a>00496             <span class="comment">// The PAYER&#39;s (sender) opening number is burned just from TRYING a transaction. It&#39;s only left</span>
<a name="l00497"></a>00497             <span class="comment">// open if the transaction succeeds (but in that case, it&#39;s still marked as &quot;used.&quot;) But the</span>
<a name="l00498"></a>00498             <span class="comment">// PAYEE&#39;s (recipient) opening number isn&#39;t marked as &quot;used&quot; UNLESS the transaction succeeds.</span>
<a name="l00499"></a>00499             <span class="comment">//</span>
<a name="l00500"></a>00500             <span class="comment">// Basically a failed transaction means the sender&#39;s opening number is burned and gone, but the</span>
<a name="l00501"></a>00501             <span class="comment">// recipient&#39;s must be clawed back!! Whereas if the message fails (before transaction even has a</span>
<a name="l00502"></a>00502             <span class="comment">// chance to run) then BOTH sender and recipient can claw back their numbers. The only way to tell</span>
<a name="l00503"></a>00503             <span class="comment">// the difference is to look at the message itself (the info isn&#39;t stored here in the transaction.)</span>
<a name="l00504"></a>00504             <span class="comment">//</span>
<a name="l00505"></a>00505             <span class="comment">// 1.</span>
<a name="l00506"></a>00506             <span class="comment">// Therefore we must assume that the CALLER OF THIS FUNCTION knows. If the message failed, he knows</span>
<a name="l00507"></a>00507             <span class="comment">// this, and he SPECIFICALLY called HarvestOpeningNumber() ANYWAY, to get the opening number back</span>
<a name="l00508"></a>00508             <span class="comment">// (when normally he would only recoup the closed numbers--therefore he MUST know that the message</span>
<a name="l00509"></a>00509             <span class="comment">// failed and that the number is thus still good!)</span>
<a name="l00510"></a>00510             <span class="comment">//</span>
<a name="l00511"></a>00511             <span class="comment">// 2.</span>
<a name="l00512"></a>00512             <span class="comment">// WHEREAS if the message SUCCEEDED (followed by transaction FAIL), then the payer/sender already</span>
<a name="l00513"></a>00513             <span class="comment">// used his opening number, whereas the recipient DID NOT! Again, the caller MUST KNOW THIS ALREADY.</span>
<a name="l00514"></a>00514             <span class="comment">// The caller wouldn&#39;t call &quot;HarvestOpeningNumber&quot; for a burned number (of the sender.) Therefore</span>
<a name="l00515"></a>00515             <span class="comment">// he must be calling it to recoup the (still issued) opening number of the RECIPIENT.</span>
<a name="l00516"></a>00516             <span class="comment">// </span>
<a name="l00517"></a>00517             <span class="comment">// Problems:</span>
<a name="l00518"></a>00518             <span class="comment">// 1. What if caller is stupid, and message hasn&#39;t actually failed? What if caller is mistakenly</span>
<a name="l00519"></a>00519             <span class="comment">//    trying to recoup numbers that are actually burned already? Well, the opening number is already </span>
<a name="l00520"></a>00520             <span class="comment">//    marked as &quot;used but still issued&quot; so when I try to claw it back, that will work (because it</span>
<a name="l00521"></a>00521             <span class="comment">//    only adds a number BACK after it can confirm that the number WAS issued to me in the first place,</span>
<a name="l00522"></a>00522             <span class="comment">//    and in this case, that verification will succeed.) </span>
<a name="l00523"></a>00523             <span class="comment">//    THEREFORE: need to explicitly pass the message&#39;s success/failure status into the current</span>
<a name="l00524"></a>00524             <span class="comment">//    function. IF the msg was a failure, the transaction never had a chance to run and thus the</span>
<a name="l00525"></a>00525             <span class="comment">//    opening number is still good, and we can claw it back. But if the message was a SUCCESS, then</span>
<a name="l00526"></a>00526             <span class="comment">//    the transaction definitely TRIED to run, which means the opening number is now burned. (IF</span>
<a name="l00527"></a>00527             <span class="comment">//    the transaction itself failed, that is. Otherwise if it succeeded, then it&#39;s possible, in the</span>
<a name="l00528"></a>00528             <span class="comment">//    cases of transfer and marketOffer, that the opening number is STILL &quot;used but issued&quot;, until</span>
<a name="l00529"></a>00529             <span class="comment">//    you finally close out your transferReceipt or the finalReceipt for your market offer.)</span>
<a name="l00530"></a>00530             <span class="comment">//</span>
<a name="l00531"></a>00531             <span class="comment">// 2. What if caller is stupid, and he called HarvestOpeningNumber for the sender, even though the</span>
<a name="l00532"></a>00532             <span class="comment">//    number was already burned in the original attempt? (Which we know it was, since the message</span>
<a name="l00533"></a>00533             <span class="comment">//    itself succeeded.) The sender, of course, has that number on his &quot;issued&quot; list, so his clawback</span>
<a name="l00534"></a>00534             <span class="comment">//    will succeed, putting him out of sync.</span>
<a name="l00535"></a>00535             <span class="comment">//</span>
<a name="l00536"></a>00536             <span class="comment">// 3. What if the recipient is passed into this function? His &quot;opening number&quot; is not the primary</span>
<a name="l00537"></a>00537             <span class="comment">//    one, but rather, there are three &quot;closing numbers&quot; on a payment plan. One for the sender, to</span>
<a name="l00538"></a>00538             <span class="comment">//    match his normal opening number, and 2 more for the recipient (an opening and closing number).</span>
<a name="l00539"></a>00539             <span class="comment">//    Therefore in the case of the recipient, need to grab HIS opening number, not the sender&#39;s.</span>
<a name="l00540"></a>00540             <span class="comment">//    (Therefore need to know whether Nym is sender or recipient.) Is that actually true? Or won&#39;t</span>
<a name="l00541"></a>00541             <span class="comment">//    the harvest process be smart enough to figure that out already? And will it know that the</span>
<a name="l00542"></a>00542             <span class="comment">//    recipient still needs to harvest HIS opening number, even if the transaction was attempted,</span>
<a name="l00543"></a>00543             <span class="comment">//    since the recipient&#39;s number wasn&#39;t marked as &quot;used&quot; unless the transaction itself succeeded.</span>
<a name="l00544"></a>00544             <span class="comment">//    NOTE: CronItem/Agreement/PaymentPlan is definitely smart enough already to know if the Nym is</span>
<a name="l00545"></a>00545             <span class="comment">//    the sender or recipient. It will only grab the appropriate number for the right Nym. But here</span>
<a name="l00546"></a>00546             <span class="comment">//    in THIS function we still have to be smart enough not to call it for the SENDER if the transaction</span>
<a name="l00547"></a>00547             <span class="comment">//    was attempted (because it must be burned already), but TO call it for the sender if the transaction</span>
<a name="l00548"></a>00548             <span class="comment">//    was not even attempted (meaning it wasn&#39;t burned yet.) Similarly, this function has to be smart</span>
<a name="l00549"></a>00549             <span class="comment">//    enough TO call it for the recipient if transaction was attempted but didn&#39;t succeed, since the</span>
<a name="l00550"></a>00550             <span class="comment">//    recipient&#39;s opening number is still good in that case.</span>
<a name="l00551"></a>00551             <span class="comment">//</span>
<a name="l00552"></a>00552             <span class="comment">// --------------------------------------------------------------------</span>
<a name="l00553"></a>00553             
<a name="l00554"></a>00554             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNymID(theNym);
<a name="l00555"></a>00555             
<a name="l00556"></a>00556             <span class="comment">// Assumption: if theNymID matches this-&gt;GetUserID(), then theNym must be the SENDER / PAYER!</span>
<a name="l00557"></a>00557             <span class="comment">// Else, he must be RECIPIENT / PAYEE, instead!</span>
<a name="l00558"></a>00558             <span class="comment">// This assumption is not for proving, since the harvest functions will verify the Nym&#39;s identity</span>
<a name="l00559"></a>00559             <span class="comment">// anyway. Instead, this assumption is merely for deciding which logic to use about which harvest</span>
<a name="l00560"></a>00560             <span class="comment">// functions to call.</span>
<a name="l00561"></a>00561             <span class="comment">//</span>
<a name="l00562"></a>00562             <span class="keywordflow">if</span> (theNymID == this-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>())  <span class="comment">// theNym is SENDER / PAYER</span>
<a name="l00563"></a>00563             {
<a name="l00564"></a>00564                 <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00565"></a>00565                 <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00566"></a>00566                 <span class="comment">//</span>
<a name="l00567"></a>00567                 <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry)
<a name="l00568"></a>00568                 {                                            
<a name="l00569"></a>00569                     bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l00570"></a>00570                                                                 <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00571"></a>00571                 }
<a name="l00572"></a>00572                 <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY</span>
<a name="l00573"></a>00573                 <span class="comment">// NOT HARVESTABLE. (For the sender, anyway.) Why not? Because that means the transaction definitely ran--and</span>
<a name="l00574"></a>00574                 <span class="comment">// the opener is marked as &quot;used&quot; on success, and &quot;burned&quot; on failure--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l00575"></a>00575                 <span class="comment">//</span>
<a name="l00576"></a>00576                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00577"></a>00577                 {
<a name="l00578"></a>00578                     <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00579"></a>00579                     {
<a name="l00580"></a>00580                         <span class="comment">// This means the &quot;paymentPlan&quot; transaction# is MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00581"></a>00581                         <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l00582"></a>00582 <span class="comment">//                      bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00583"></a>00583 <span class="comment">//                                                                  GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00584"></a>00584                     }
<a name="l00585"></a>00585                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure)
<a name="l00586"></a>00586                     {
<a name="l00587"></a>00587                         <span class="comment">// Whereas if the transaction was a failure, that means the transaction number was DEFINITELY burned.</span>
<a name="l00588"></a>00588                         <span class="comment">// (No point clawing it back now--it&#39;s gone already.)</span>
<a name="l00589"></a>00589 <span class="comment">//                      bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00590"></a>00590 <span class="comment">//                                                                  GetTransactionNum()); //bSave=false, pSignerNym=NULL</span>
<a name="l00591"></a>00591                     }
<a name="l00592"></a>00592                 }
<a name="l00593"></a>00593             }
<a name="l00594"></a>00594             <span class="comment">// --------------------------------------------</span>
<a name="l00595"></a>00595             <span class="comment">// theNym is RECIPIENT / PAYEE</span>
<a name="l00596"></a>00596             <span class="comment">//</span>
<a name="l00597"></a>00597             <span class="comment">// This case is slightly different because above, a successful message with a failed transaction will burn the</span>
<a name="l00598"></a>00598             <span class="comment">// opening number, whereas here, if the message is successful but the transaction is failed, the recipient&#39;s</span>
<a name="l00599"></a>00599             <span class="comment">// opening transaction number is STILL GOOD and can be harvested!  TODO: Make sure payment plans drop a NOTICE</span>
<a name="l00600"></a>00600             <span class="comment">// to the recipient, so he can harvest his numbers when this happens (similar to todos I have for smart contracts.)</span>
<a name="l00601"></a>00601             <span class="comment">//</span>
<a name="l00602"></a>00602             <span class="comment">// The other big difference with the recipient is that he has a different opening and closing number than the sender</span>
<a name="l00603"></a>00603             <span class="comment">// does, so I need to see if I can get those from the transaction, or if I have to load up the attached cron item</span>
<a name="l00604"></a>00604             <span class="comment">// to get that data.            </span>
<a name="l00605"></a>00605             <span class="comment">//</span>
<a name="l00606"></a>00606             <span class="keywordflow">else</span>  <span class="comment">// theNym is RECIPIENT / PAYEE</span>
<a name="l00607"></a>00607             {
<a name="l00608"></a>00608                 <span class="comment">// What is this class doing here?</span>
<a name="l00609"></a>00609                 <span class="comment">// Answer: it&#39;s the C++ equivalent of local functions.</span>
<a name="l00610"></a>00610                 <span class="comment">//</span>
<a name="l00611"></a>00611                 <span class="keyword">class </span>_getRecipientOpeningNum
<a name="l00612"></a>00612                 {
<a name="l00613"></a>00613                 <span class="keyword">public</span>:
<a name="l00614"></a>00614                     int64_t Run(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction)
<a name="l00615"></a>00615                     {
<a name="l00616"></a>00616                         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = theTransaction.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);
<a name="l00617"></a>00617                         <span class="keywordflow">if</span> (NULL != pItem)
<a name="l00618"></a>00618                         {
<a name="l00619"></a>00619                             <span class="comment">// Also load up the Payment Plan from inside the transaction item.</span>
<a name="l00620"></a>00620                             <span class="comment">//</span>
<a name="l00621"></a>00621                             <a class="code" href="class_o_t_string.html">OTString</a>        strPaymentPlan;
<a name="l00622"></a>00622                             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   thePlan;
<a name="l00623"></a>00623                             pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPaymentPlan);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625                             <span class="keywordflow">if</span> (strPaymentPlan.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPaymentPlan))
<a name="l00626"></a>00626                                 <span class="keywordflow">return</span> thePlan.<a class="code" href="class_o_t_agreement.html#a3602a1424347da4b23e06b65005148f9">GetRecipientOpeningNum</a>();
<a name="l00627"></a>00627                             <span class="keywordflow">else</span>
<a name="l00628"></a>00628                                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestOpeningNumber: Error: Unable to load &quot;</span>
<a name="l00629"></a>00629                                              <span class="stringliteral">&quot;paymentPlan object from paymentPlan transaction item.\n&quot;</span>);
<a name="l00630"></a>00630                         }
<a name="l00631"></a>00631                         <span class="keywordflow">else</span>
<a name="l00632"></a>00632                             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestOpeningNumber: Error: Unable to find &quot;</span>
<a name="l00633"></a>00633                                          <span class="stringliteral">&quot;paymentPlan item in paymentPlan transaction.\n&quot;</span>);
<a name="l00634"></a>00634                         <span class="keywordflow">return</span> 0;
<a name="l00635"></a>00635                     }
<a name="l00636"></a>00636                 }; <span class="comment">// class _getRecipientOpeningNum</span>
<a name="l00637"></a>00637                 <span class="comment">// ----------------------------------</span>
<a name="l00638"></a>00638                 
<a name="l00639"></a>00639                 <span class="comment">// If the server reply message was unambiguously a FAIL, that means the opening number is STILL GOOD.</span>
<a name="l00640"></a>00640                 <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l00641"></a>00641                 <span class="comment">//</span>
<a name="l00642"></a>00642                 <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry)
<a name="l00643"></a>00643                 {
<a name="l00644"></a>00644                     _getRecipientOpeningNum getRecipientOpeningNum;
<a name="l00645"></a>00645                     <span class="keyword">const</span> int64_t lRecipientOpeningNum = getRecipientOpeningNum.Run(*<span class="keyword">this</span>);
<a name="l00646"></a>00646                     
<a name="l00647"></a>00647                     <span class="keywordflow">if</span> (lRecipientOpeningNum &gt; 0)
<a name="l00648"></a>00648                         bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), lRecipientOpeningNum); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00649"></a>00649                 }
<a name="l00650"></a>00650                 <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, then the next question is whether the</span>
<a name="l00651"></a>00651                 <span class="comment">// TRANSACTION INSIDE IT was also a success, or if there&#39;s a &quot;success message / failed transaction&quot; situation</span>
<a name="l00652"></a>00652                 <span class="comment">// going on here. For the recipient, that&#39;s important: in the first case, his opener is definitely marked as &quot;used</span>
<a name="l00653"></a>00653                 <span class="comment">// but still outstanding&quot; and CANNOT be harvested. But in the second case, unlike with the sender, his opener IS harvestable!</span>
<a name="l00654"></a>00654                 <span class="comment">// This is because of a peculiarity with payment plans: the recipient&#39;s opening number is not marked as used until</span>
<a name="l00655"></a>00655                 <span class="comment">// the transaction itself is a success!                </span>
<a name="l00656"></a>00656                 <span class="comment">//</span>
<a name="l00657"></a>00657                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00658"></a>00658                 {
<a name="l00659"></a>00659                     <span class="keywordflow">if</span> (bTransactionWasSuccess) <span class="comment">// The opener is DEFINITELY marked as &quot;used but still outstanding&quot; and CANNOT be harvested.</span>
<a name="l00660"></a>00660                     {
<a name="l00661"></a>00661                         <span class="comment">// This means the &quot;paymentPlan&quot; transaction# is MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00662"></a>00662                         <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l00663"></a>00663 <span class="comment">//                      bSuccess = theNym.ClawbackTransactionNumber(GetPurportedServerID(), </span>
<a name="l00664"></a>00664 <span class="comment">//                                                                  RECIPIENTS--OPENING--NUMBER--GOES--HERE); //bSave=false, pSignerNym=NULL</span>
<a name="l00665"></a>00665                     }
<a name="l00666"></a>00666                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure &amp;&amp; !bHarvestingForRetry)
<a name="l00667"></a>00667                     {
<a name="l00668"></a>00668                         <span class="comment">// In this case, unlike with the sender, the recipient&#39;s opener IS still harvestable! This is because</span>
<a name="l00669"></a>00669                         <span class="comment">// of a peculiarity with payment plans: the recipient&#39;s opening number is not marked as used until the</span>
<a name="l00670"></a>00670                         <span class="comment">// transaction itself is a success! Therefore, if the transaction was a failure, that means the recipient&#39;s </span>
<a name="l00671"></a>00671                         <span class="comment">// opening number is DEFINITELY STILL GOOD.</span>
<a name="l00672"></a>00672                         <span class="comment">//</span>
<a name="l00673"></a>00673                         _getRecipientOpeningNum getRecipientOpeningNum;
<a name="l00674"></a>00674                         <span class="keyword">const</span> int64_t lRecipientOpeningNum = getRecipientOpeningNum.Run(*<span class="keyword">this</span>);
<a name="l00675"></a>00675                         
<a name="l00676"></a>00676                         <span class="keywordflow">if</span> (lRecipientOpeningNum &gt; 0)
<a name="l00677"></a>00677                             bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), lRecipientOpeningNum); <span class="comment">//bSave=false, pSignerNym=NULL</span>
<a name="l00678"></a>00678                     }
<a name="l00679"></a>00679                 }
<a name="l00680"></a>00680             }
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682             <span class="keywordflow">break</span>;
<a name="l00683"></a>00683             
<a name="l00684"></a>00684             <span class="comment">// --------------------------------------------------------------------------------------------------</span>
<a name="l00685"></a>00685             
<a name="l00686"></a>00686             <span class="comment">// TODO: Make sure that when a user receives a success notice that a smart contract has been started up,</span>
<a name="l00687"></a>00687             <span class="comment">// that he marks his opener as &quot;burned&quot; instead of as &quot;used.&quot; It&#39;s gone!</span>
<a name="l00688"></a>00688             <span class="comment">// Also: if the user receives a message failure notice (not done yet) then he can mark his opening #</span>
<a name="l00689"></a>00689             <span class="comment">// as &quot;new&quot; again! But if he instead receives a &quot;message success but transaction failure&quot;, (todo: notice)</span>
<a name="l00690"></a>00690             <span class="comment">// then he must burn his opening #, as that is what the server has already done.</span>
<a name="l00691"></a>00691             <span class="comment">//</span>
<a name="l00692"></a>00692             <span class="comment">// In the case where message and transaction were BOTH success, then the user&#39;s existing setup is already</span>
<a name="l00693"></a>00693             <span class="comment">// correct. (The openers AND closers are already marked as &quot;used but still issued&quot; on the client side, and </span>
<a name="l00694"></a>00694             <span class="comment">// the server-side sees things that way already as well.)</span>
<a name="l00695"></a>00695             <span class="comment">// </span>
<a name="l00696"></a>00696             
<a name="l00697"></a>00697         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>:  <span class="comment">// Uses X transaction #s, with an opener for each party and a closer for each asset account.</span>
<a name="l00698"></a>00698                                             <span class="comment">// If the message is rejected by the server, then ALL openers can be harvested. But if the</span>
<a name="l00699"></a>00699                                             <span class="comment">// message was successful (REGARDLESS of whether the transaction was successful) then all of</span>
<a name="l00700"></a>00700                                             <span class="comment">// the openers for all of the parties have been burned. The closers, meanwhile, can be recovered</span>
<a name="l00701"></a>00701                                             <span class="comment">// if the message is a failure, as well as in cases where message succeeds but transaction failed.</span>
<a name="l00702"></a>00702                                             <span class="comment">// But if transaction succeeded, then the closers CANNOT be recovered. (Only removed, once you sign</span>
<a name="l00703"></a>00703                                             <span class="comment">// off on the receipt.)</span>
<a name="l00704"></a>00704         {
<a name="l00705"></a>00705             <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00706"></a>00706             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1adb560811f0265d344fac45c9333bc25d">OTItem::smartContract</a>);
<a name="l00707"></a>00707             
<a name="l00708"></a>00708             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00709"></a>00709             {
<a name="l00710"></a>00710                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestOpeningNumber: Error: Unable to find &quot;</span>
<a name="l00711"></a>00711                              <span class="stringliteral">&quot;smartContract item in smartContract transaction.\n&quot;</span>);
<a name="l00712"></a>00712             }
<a name="l00713"></a>00713             <span class="keywordflow">else</span> <span class="comment">// Load up the smart contract...</span>
<a name="l00714"></a>00714             {
<a name="l00715"></a>00715                 <a class="code" href="class_o_t_string.html">OTString</a>        strSmartContract;
<a name="l00716"></a>00716                 <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> theSmartContract(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l00717"></a>00717                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strSmartContract);
<a name="l00718"></a>00718                 
<a name="l00719"></a>00719                 <span class="comment">// If we failed to load the smart contract...</span>
<a name="l00720"></a>00720                 <span class="keywordflow">if</span> (!strSmartContract.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || (<span class="keyword">false</span> == theSmartContract.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strSmartContract)))
<a name="l00721"></a>00721                 {
<a name="l00722"></a>00722                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestOpeningNumber: Error: Unable to load &quot;</span>
<a name="l00723"></a>00723                                  <span class="stringliteral">&quot;smartContract object from smartContract transaction item.\n&quot;</span>);
<a name="l00724"></a>00724                 }
<a name="l00725"></a>00725                 <span class="keywordflow">else</span> <span class="comment">// theSmartContract is ready to go....</span>
<a name="l00726"></a>00726                 {
<a name="l00727"></a>00727                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00728"></a>00728                     <span class="comment">// The message reply itself was a failure. This means the transaction itself never got a chance</span>
<a name="l00729"></a>00729                     <span class="comment">// to run... which means ALL the opening numbers on that transaction are STILL GOOD.</span>
<a name="l00730"></a>00730                     <span class="comment">//</span>
<a name="l00731"></a>00731                     <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry)
<a name="l00732"></a>00732                     {                 
<a name="l00733"></a>00733                         <span class="comment">// If I WAS harvesting for a re-try, I&#39;d want to leave the opening number</span>
<a name="l00734"></a>00734                         <span class="comment">// on this smart contract</span>
<a name="l00735"></a>00735                         theSmartContract.<a class="code" href="class_o_t_smart_contract.html#a6eaf2a458eb665dae9e25f026db27f8f">HarvestOpeningNumber</a>(theNym);
<a name="l00736"></a>00736                         bSuccess = <span class="keyword">true</span>;
<a name="l00737"></a>00737                     }
<a name="l00738"></a>00738                     <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l00739"></a>00739                     <span class="comment">// Why? Because that means the transaction definitely ran--and the opener is marked as &quot;used&quot; on SUCCESS, or &quot;burned&quot; on</span>
<a name="l00740"></a>00740                     <span class="comment">// FAILURE--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l00741"></a>00741                     <span class="comment">//</span>
<a name="l00742"></a>00742                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00743"></a>00743                     {
<a name="l00744"></a>00744                         <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00745"></a>00745                         {
<a name="l00746"></a>00746                             <span class="comment">// This means the &quot;smartContract&quot; opening trans# is MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00747"></a>00747                             <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l00748"></a>00748                             <span class="comment">//</span>
<a name="l00749"></a>00749 <span class="comment">//                          theSmartContract.HarvestOpeningNumber(theNym);</span>
<a name="l00750"></a>00750 <span class="comment">//                          bSuccess = true;</span>
<a name="l00751"></a>00751                         }
<a name="l00752"></a>00752                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure)
<a name="l00753"></a>00753                         {
<a name="l00754"></a>00754                             <span class="comment">// Whereas if the transaction was a failure, that means the opening trans number was DEFINITELY burned.</span>
<a name="l00755"></a>00755                             <span class="comment">// (No point clawing it back now--it&#39;s gone already.)</span>
<a name="l00756"></a>00756                             <span class="comment">//</span>
<a name="l00757"></a>00757 <span class="comment">//                          theSmartContract.HarvestOpeningNumber(theNym);</span>
<a name="l00758"></a>00758 <span class="comment">//                          bSuccess = true;                            </span>
<a name="l00759"></a>00759                         }
<a name="l00760"></a>00760                     } <span class="comment">// else if (bReplyWasSuccess)</span>
<a name="l00761"></a>00761                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00762"></a>00762                 } <span class="comment">// else (smart contract loaded successfully)</span>
<a name="l00763"></a>00763             } <span class="comment">// pItem was found.</span>
<a name="l00764"></a>00764             <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00765"></a>00765         }
<a name="l00766"></a>00766             <span class="keywordflow">break</span>;
<a name="l00767"></a>00767             
<a name="l00768"></a>00768         <span class="keywordflow">default</span>:
<a name="l00769"></a>00769             <span class="keywordflow">break</span>;
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     
<a name="l00772"></a>00772     <span class="keywordflow">return</span> bSuccess;
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 <span class="comment">// Normally do this if your transaction ran--and failed--so you can get most of</span>
<a name="l00777"></a>00777 <span class="comment">// your transaction numbers back. (The opening number is usually already gone,</span>
<a name="l00778"></a>00778 <span class="comment">// but any others are still salvageable.)</span>
<a name="l00779"></a>00779 <span class="comment">//</span>
<a name="l00780"></a><a class="code" href="class_o_t_transaction.html#a024827b70ceaf1f9fbf10bd505de348a">00780</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a024827b70ceaf1f9fbf10bd505de348a">OTTransaction::HarvestClosingNumbers</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l00781"></a>00781                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bHarvestingForRetry,    <span class="comment">// false until positively asserted.</span>
<a name="l00782"></a>00782                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bReplyWasSuccess,       <span class="comment">// false until positively asserted.</span>
<a name="l00783"></a>00783                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bReplyWasFailure,       <span class="comment">// false until positively asserted.</span>
<a name="l00784"></a>00784                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bTransactionWasSuccess, <span class="comment">// false until positively asserted.</span>
<a name="l00785"></a>00785                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bTransactionWasFailure) <span class="comment">// false until positively asserted.</span>
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l00788"></a>00788     
<a name="l00789"></a>00789     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>)
<a name="l00790"></a>00790     {   <span class="comment">// Note: the below remarks about &quot;success or fail&quot; are specific to TRANSACTION success, not message success.</span>
<a name="l00791"></a>00791             
<a name="l00792"></a>00792 <span class="comment">//      case OTTransaction::processNymbox:  // Why is this even here? processNymbox uses NO trans#s--that&#39;s the purpose of processNymbox.</span>
<a name="l00793"></a>00793         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>:   <span class="comment">// Has no closing numbers.</span>
<a name="l00794"></a>00794         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>:        <span class="comment">// Has no closing numbers.</span>
<a name="l00795"></a>00795         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>:     <span class="comment">// Has no closing numbers.</span>
<a name="l00796"></a>00796         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>: <span class="comment">// Has no closing numbers.</span>
<a name="l00797"></a>00797         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>:    <span class="comment">// Has no closing numbers.</span>
<a name="l00798"></a>00798         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>:       <span class="comment">// Has no closing numbers.</span>
<a name="l00799"></a>00799             
<a name="l00800"></a>00800             <span class="keywordflow">break</span>;
<a name="l00801"></a>00801             
<a name="l00802"></a>00802         <span class="comment">// --------------------------------------------------------------------------------------------------</span>
<a name="l00803"></a>00803             
<a name="l00804"></a>00804         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>:    <span class="comment">// Uses 3 transaction #s, the opening number and 2 closers.</span>
<a name="l00805"></a>00805                                             <span class="comment">// If message fails, all closing numbers are harvestable.</span>
<a name="l00806"></a>00806                                             <span class="comment">// If message succeeds but transaction fails, closers can also be harvested.</span>
<a name="l00807"></a>00807                                             <span class="comment">// If message succeeds and transaction succeeds, closers are marked as &quot;used&quot; (like opener.)</span>
<a name="l00808"></a>00808                                             <span class="comment">// In that last case, you can&#39;t claw them back since they are used.</span>
<a name="l00809"></a>00809         {
<a name="l00810"></a>00810             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae973afad2dc8a8349e8889304b20e73b">OTItem::marketOffer</a>);
<a name="l00811"></a>00811             
<a name="l00812"></a>00812             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00813"></a>00813             {
<a name="l00814"></a>00814                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: Error: Unable to find &quot;</span>
<a name="l00815"></a>00815                              <span class="stringliteral">&quot;marketOffer item in marketOffer transaction.\n&quot;</span>);
<a name="l00816"></a>00816             }
<a name="l00817"></a>00817             <span class="keywordflow">else</span> <span class="comment">// pItem is good. Let&#39;s load up the OTTrade object...</span>
<a name="l00818"></a>00818             {
<a name="l00819"></a>00819                 <a class="code" href="class_o_t_trade.html">OTTrade</a>     theTrade;
<a name="l00820"></a>00820                 <a class="code" href="class_o_t_string.html">OTString</a>    strTrade;
<a name="l00821"></a>00821                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strTrade);
<a name="l00822"></a>00822                 
<a name="l00823"></a>00823                 <span class="comment">// First load the Trade up...</span>
<a name="l00824"></a>00824                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadContractFromString = (strTrade.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theTrade.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTrade));
<a name="l00825"></a>00825                 
<a name="l00826"></a>00826                 <span class="comment">// If failed to load the trade...</span>
<a name="l00827"></a>00827                 <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l00828"></a>00828                 {
<a name="l00829"></a>00829                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: ERROR: Failed loading trade from string:\n\n%s\n\n&quot;</span>,
<a name="l00830"></a>00830                                   strTrade.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00831"></a>00831                 }
<a name="l00832"></a>00832                 <span class="keywordflow">else</span> <span class="comment">// theTrade is ready to go....</span>
<a name="l00833"></a>00833                 {
<a name="l00834"></a>00834                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00835"></a>00835                     <span class="comment">// The message reply itself was a failure. This means the transaction itself never got a chance</span>
<a name="l00836"></a>00836                     <span class="comment">// to run... which means ALL the closing numbers on that transaction are STILL GOOD.</span>
<a name="l00837"></a>00837                     <span class="comment">//</span>
<a name="l00838"></a>00838                     <span class="keywordflow">if</span> (bReplyWasFailure)<span class="comment">// &amp;&amp; !bHarvestingForRetry) // on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l00839"></a>00839                     {                   <span class="comment">// NOTE: We do NOT exclude harvesting of closing numbers, for a marketoffer, based on bHarvestingForRetry. Why not?</span>
<a name="l00840"></a>00840                                         <span class="comment">// Because with marketOffer, ALL transaction #s are re-set EACH re-try, not just the opening #. Therefore ALL must be clawed back.</span>
<a name="l00841"></a>00841                         theTrade.<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(theNym); <span class="comment">// (Contrast this with payment plan, exchange basket, smart contract...)</span>
<a name="l00842"></a>00842                         bSuccess = <span class="keyword">true</span>;
<a name="l00843"></a>00843                         <span class="comment">// ------------------------------------</span>
<a name="l00844"></a>00844 <span class="comment">//                      theTrade.GetAssetAcctClosingNum();      // For reference.</span>
<a name="l00845"></a>00845 <span class="comment">//                      theTrade.GetCurrencyAcctClosingNum();   // (The above harvest call grabs THESE numbers.)</span>
<a name="l00846"></a>00846                         <span class="comment">// ------------------------------------</span>
<a name="l00847"></a>00847                     }
<a name="l00848"></a>00848                     <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l00849"></a>00849                     <span class="comment">// Why? Because that means the transaction definitely ran--and the opener is marked as &quot;used&quot; on SUCCESS, or &quot;burned&quot; on</span>
<a name="l00850"></a>00850                     <span class="comment">// FAILURE--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l00851"></a>00851                     <span class="comment">//</span>
<a name="l00852"></a>00852                     <span class="comment">// ===&gt; But the CLOSING numbers are harvestable on transaction *failure.*</span>
<a name="l00853"></a>00853                     <span class="comment">// (They are not harvestable on transaction *success* though.)</span>
<a name="l00854"></a>00854                     <span class="comment">//</span>
<a name="l00855"></a>00855                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00856"></a>00856                     {
<a name="l00857"></a>00857                         <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00858"></a>00858                         {
<a name="l00859"></a>00859                             <span class="comment">// (They are not harvestable on transaction success though.)</span>
<a name="l00860"></a>00860                             <span class="comment">// This means the &quot;marketOffer&quot; closing trans#s (one for asset account, and one for currency account) are both</span>
<a name="l00861"></a>00861                             <span class="comment">// MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00862"></a>00862                             <span class="comment">// EITHER WAY, you certainly can&#39;t claw those numbers back now! (They are still outstanding, though. They&#39;re not gone, yet...)</span>
<a name="l00863"></a>00863                             <span class="comment">//</span>
<a name="l00864"></a>00864 <span class="comment">//                          theTrade.HarvestClosingNumbers(theNym);</span>
<a name="l00865"></a>00865 <span class="comment">//                          bSuccess = true;</span>
<a name="l00866"></a>00866                         }
<a name="l00867"></a>00867                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure)
<a name="l00868"></a>00868                         {
<a name="l00869"></a>00869                             <span class="comment">// But the CLOSING numbers ARE harvestable on transaction failure.</span>
<a name="l00870"></a>00870                             <span class="comment">// (Closing numbers for marketOffers are only marked &quot;used&quot; if the</span>
<a name="l00871"></a>00871                             <span class="comment">// marketOffer transaction was a success.)</span>
<a name="l00872"></a>00872                             <span class="comment">//</span>
<a name="l00873"></a>00873                             theTrade.<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(theNym);
<a name="l00874"></a>00874                             bSuccess = <span class="keyword">true</span>;                            
<a name="l00875"></a>00875                         }
<a name="l00876"></a>00876                     } <span class="comment">// else if (bReplyWasSuccess)</span>
<a name="l00877"></a>00877                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00878"></a>00878                 } <span class="comment">// else (the trade loaded successfully)</span>
<a name="l00879"></a>00879             } <span class="comment">// pItem was found.</span>
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881             <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00882"></a>00882             <span class="keywordflow">break</span>;
<a name="l00883"></a>00883             
<a name="l00884"></a>00884         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>: <span class="comment">// Uses X transaction #s: the opener, which is burned success-or-fail, and Y closers</span>
<a name="l00885"></a>00885                                             <span class="comment">// (one for each account.) Closers are marked &quot;used&quot; if success transaction,</span>
<a name="l00886"></a>00886                                             <span class="comment">// but if message succeeds while transaction fails, then closers can be harvested.</span>
<a name="l00887"></a>00887         {
<a name="l00888"></a>00888             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1332f32813f158436fd58abdddec855c">OTItem::exchangeBasket</a>);
<a name="l00889"></a>00889             
<a name="l00890"></a>00890             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00891"></a>00891             {
<a name="l00892"></a>00892                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: Error: Unable to find &quot;</span>
<a name="l00893"></a>00893                              <span class="stringliteral">&quot;exchangeBasket item in exchangeBasket transaction.\n&quot;</span>);
<a name="l00894"></a>00894             }
<a name="l00895"></a>00895             <span class="keywordflow">else</span> <span class="comment">// pItem is good. Let&#39;s load up the OTBasket object...</span>
<a name="l00896"></a>00896             {
<a name="l00897"></a>00897                 <a class="code" href="class_o_t_string.html">OTString</a> strBasket;
<a name="l00898"></a>00898                 <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l00899"></a>00899                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strBasket);
<a name="l00900"></a>00900                 
<a name="l00901"></a>00901                 <span class="comment">// First load the Basket up...</span>
<a name="l00902"></a>00902                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadContractFromString = (strBasket.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strBasket));
<a name="l00903"></a>00903                 
<a name="l00904"></a>00904                 <span class="comment">// If failed to load the request basket...</span>
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l00906"></a>00906                 {
<a name="l00907"></a>00907                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: ERROR: Failed loading basket request from string:\n\n%s\n\n&quot;</span>,
<a name="l00908"></a>00908                                   strBasket.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00909"></a>00909                 }
<a name="l00910"></a>00910                 <span class="keywordflow">else</span> <span class="comment">// theBasket is ready to go....</span>
<a name="l00911"></a>00911                 {
<a name="l00912"></a>00912                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00913"></a>00913                     <span class="comment">// The message reply itself was a failure. This means the transaction itself never got a chance</span>
<a name="l00914"></a>00914                     <span class="comment">// to run... which means ALL the closing numbers on that transaction are STILL GOOD.</span>
<a name="l00915"></a>00915                     <span class="comment">//</span>
<a name="l00916"></a>00916                     
<a name="l00917"></a>00917                     <span class="comment">// NOTE: if reply was failure, then I DO want to re-try my basket exchange, without having to call</span>
<a name="l00918"></a>00918                     <span class="comment">// all the API functions to build the exchange object again (instead just re-use the existing one.)</span>
<a name="l00919"></a>00919                     <span class="comment">//</span>
<a name="l00920"></a>00920                     <span class="comment">// So... the closing numbers ARE all harvestable, in the event, for example, that I was out of re-tries</span>
<a name="l00921"></a>00921                     <span class="comment">// and I just wanted to claw ALL the numbers back.</span>
<a name="l00922"></a>00922                     <span class="comment">// But what if I just want the opening one at first, and leave the others for my retries?</span>
<a name="l00923"></a>00923                     <span class="comment">//</span>
<a name="l00924"></a>00924                     <span class="comment">// ===&gt; DONE:  SOunds like I need an API call like OT_API_Msg_HarvestTransactionNumbers</span>
<a name="l00925"></a>00925                     <span class="comment">// except called OT_API_Msg_HarvestOpeningNumber. Then it just only calls the opening version.</span>
<a name="l00926"></a>00926                     <span class="comment">//</span>
<a name="l00927"></a>00927                     <span class="comment">// Better: (done) Add a boolean to existing functions: &quot;bHarvestingForRetry&quot;. The code can just be smart enough,</span>
<a name="l00928"></a>00928                     <span class="comment">// based on that!</span>
<a name="l00929"></a>00929                     
<a name="l00930"></a>00930                     <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry)   
<a name="l00931"></a>00931                     {
<a name="l00932"></a>00932                         <span class="comment">// if we WERE harvesting for a re-try, then we would LEAVE the closing numbers, so that the re-try would </span>
<a name="l00933"></a>00933                         <span class="comment">// work, since otherwise a new basket object would need to be setup in order to make the call, with new</span>
<a name="l00934"></a>00934                         <span class="comment">// closing numbers.</span>
<a name="l00935"></a>00935                         <span class="comment">//</span>
<a name="l00936"></a>00936                         theBasket.<a class="code" href="class_o_t_basket.html#a4fa7db8a28ae3adb021cd343b69fe2ff">HarvestClosingNumbers</a>(theNym, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <span class="keyword">true</span>); <span class="comment">//bSave=true</span>
<a name="l00937"></a>00937                         bSuccess = <span class="keyword">true</span>;
<a name="l00938"></a>00938                         <span class="comment">// ------------------------------------</span>
<a name="l00939"></a>00939                     }
<a name="l00940"></a>00940                     <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l00941"></a>00941                     <span class="comment">// Why? Because that means the transaction definitely ran--and the opener for exchangeBasket is always burned, success-or-fail.</span>
<a name="l00942"></a>00942                     <span class="comment">// The CLOSING numbers also are not harvestable on transaction success, since this marks them as &quot;USED.&quot; </span>
<a name="l00943"></a>00943                     <span class="comment">// ===&gt; But the CLOSING numbers ARE harvestable on transaction *failure.*</span>
<a name="l00944"></a>00944                     <span class="comment">//</span>
<a name="l00945"></a>00945                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l00946"></a>00946                     {
<a name="l00947"></a>00947                         <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l00948"></a>00948                         {
<a name="l00949"></a>00949                             <span class="comment">// (They are not harvestable on transaction success though.)</span>
<a name="l00950"></a>00950                             <span class="comment">// This means the &quot;exchangeBasket&quot; closing trans#s (one for each asset account involved in the exchange)</span>
<a name="l00951"></a>00951                             <span class="comment">// are all MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l00952"></a>00952                             <span class="comment">// EITHER WAY, you certainly can&#39;t claw those numbers back now! (They are still outstanding, though. They&#39;re not gone, yet...)</span>
<a name="l00953"></a>00953                             <span class="comment">//</span>
<a name="l00954"></a>00954 <span class="comment">//                          theBasket.HarvestClosingNumbers(theNym, GetPurportedServerID(), true); //bSave=true</span>
<a name="l00955"></a>00955 <span class="comment">//                          bSuccess = true;</span>
<a name="l00956"></a>00956                         }
<a name="l00957"></a>00957                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure &amp;&amp; !bHarvestingForRetry) <span class="comment">// on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l00958"></a>00958                         {
<a name="l00959"></a>00959                             <span class="comment">// But the CLOSING numbers ARE harvestable on transaction FAILURE.</span>
<a name="l00960"></a>00960                             <span class="comment">// (Closing numbers for exchangeBasket are only marked &quot;used&quot; if the</span>
<a name="l00961"></a>00961                             <span class="comment">// exchangeBasket transaction was a success. But in this case since</span>
<a name="l00962"></a>00962                             <span class="comment">// the transaction was NOT a success, ergo they were never marked as</span>
<a name="l00963"></a>00963                             <span class="comment">// &quot;used,&quot; either. So let&#39;s harvest them...)</span>
<a name="l00964"></a>00964                             <span class="comment">//</span>
<a name="l00965"></a>00965                             theBasket.<a class="code" href="class_o_t_basket.html#a4fa7db8a28ae3adb021cd343b69fe2ff">HarvestClosingNumbers</a>(theNym, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <span class="keyword">true</span>); <span class="comment">//bSave=true</span>
<a name="l00966"></a>00966                             bSuccess = <span class="keyword">true</span>;                            
<a name="l00967"></a>00967                         }
<a name="l00968"></a>00968                     } <span class="comment">// else if (bReplyWasSuccess)</span>
<a name="l00969"></a>00969                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l00970"></a>00970                 } <span class="comment">// else (the basket loaded successfully)</span>
<a name="l00971"></a>00971             } <span class="comment">// pItem was found.</span>
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973             <span class="keywordflow">break</span>;
<a name="l00974"></a>00974             <span class="comment">// --------------------------------------------------------------------------------------------------</span>
<a name="l00975"></a>00975 
<a name="l00976"></a>00976             <span class="comment">// These aren&#39;t AS simple.</span>
<a name="l00977"></a>00977         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>:    <span class="comment">// Uses 4 transaction #s: the opener (sender&#39;s #), which is burned on transaction failure, but kept alive on success,</span>
<a name="l00978"></a>00978                                             <span class="comment">// ===&gt; the sender&#39;s closing #, which is only marked as &quot;used&quot; upon success (harvestable up until that point.)</span>
<a name="l00979"></a>00979                                             <span class="comment">// ===&gt; and the recipient&#39;s opening/closing numbers, which are also both only marked as &quot;used&quot; upon success, and are harvestable up until that point.</span>
<a name="l00980"></a>00980             
<a name="l00981"></a>00981         {
<a name="l00982"></a>00982             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);
<a name="l00983"></a>00983             
<a name="l00984"></a>00984             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00985"></a>00985             {
<a name="l00986"></a>00986                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: Error: Unable to find &quot;</span>
<a name="l00987"></a>00987                              <span class="stringliteral">&quot;paymentPlan item in paymentPlan transaction.\n&quot;</span>);
<a name="l00988"></a>00988             }
<a name="l00989"></a>00989             <span class="keywordflow">else</span> <span class="comment">// pItem is good. Let&#39;s load up the OTPaymentPlan object...</span>
<a name="l00990"></a>00990             {
<a name="l00991"></a>00991                 <a class="code" href="class_o_t_string.html">OTString</a>        strPaymentPlan;
<a name="l00992"></a>00992                 <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   thePlan;
<a name="l00993"></a>00993                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPaymentPlan);
<a name="l00994"></a>00994                 
<a name="l00995"></a>00995                 <span class="comment">// First load the payment plan up...</span>
<a name="l00996"></a>00996                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadContractFromString = (strPaymentPlan.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPaymentPlan));
<a name="l00997"></a>00997 
<a name="l00998"></a>00998                 <span class="comment">// If failed to load the payment plan from string...</span>
<a name="l00999"></a>00999                 <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l01000"></a>01000                 {
<a name="l01001"></a>01001                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: ERROR: Failed loading payment plan from string:\n\n%s\n\n&quot;</span>,
<a name="l01002"></a>01002                                   strPaymentPlan.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01003"></a>01003                 }
<a name="l01004"></a>01004                 <span class="keywordflow">else</span> <span class="comment">// thePlan is ready to go....</span>
<a name="l01005"></a>01005                 {
<a name="l01006"></a>01006                     <span class="comment">// If the server reply message was unambiguously a FAIL, that means the closing numbers are STILL GOOD.</span>
<a name="l01007"></a>01007                     <span class="comment">// (Because the transaction therefore never even had a chance to run.)</span>
<a name="l01008"></a>01008                     <span class="comment">//</span>
<a name="l01009"></a>01009                     <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry) <span class="comment">// on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l01010"></a>01010                     {
<a name="l01011"></a>01011                         thePlan.<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(theNym); 
<a name="l01012"></a>01012                         bSuccess = <span class="keyword">true</span>;
<a name="l01013"></a>01013                     }
<a name="l01014"></a>01014                     <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY</span>
<a name="l01015"></a>01015                     <span class="comment">// NOT HARVESTABLE. (For the sender, anyway.) Why not? Because that means the transaction definitely ran--and</span>
<a name="l01016"></a>01016                     <span class="comment">// the opener is marked as &quot;used&quot; on success, and &quot;burned&quot; on failure--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l01017"></a>01017                     <span class="comment">// The recipient, by contrast, actually retains harvestability on his opening number up until the very point of </span>
<a name="l01018"></a>01018                     <span class="comment">// transaction success.</span>
<a name="l01019"></a>01019                     <span class="comment">//</span>
<a name="l01020"></a>01020                     <span class="comment">// ====&gt; I know you are wondering: </span>
<a name="l01021"></a>01021                     <span class="comment">// ====&gt;    HOW ABOUT THE CLOSING NUMBERS?  (When message is success)</span>
<a name="l01022"></a>01022                     <span class="comment">//  1. Transaction success: Sender and Recipient CANNOT harvest closing numbers, which are now marked as &quot;used.&quot;</span>
<a name="l01023"></a>01023                     <span class="comment">//  2. Transaction failed:  Sender and Recipient **CAN** both harvest their closing numbers.</span>
<a name="l01024"></a>01024                     <span class="comment">//</span>
<a name="l01025"></a>01025                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l01026"></a>01026                     {
<a name="l01027"></a>01027                         <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l01028"></a>01028                         {
<a name="l01029"></a>01029                             <span class="comment">// This means the &quot;paymentPlan&quot; closing trans#s are MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l01030"></a>01030                             <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l01031"></a>01031 <span class="comment">//                          thePlan.HarvestClosingNumbers(theNym); </span>
<a name="l01032"></a>01032 <span class="comment">//                          bSuccess = true;</span>
<a name="l01033"></a>01033                         }
<a name="l01034"></a>01034                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure &amp;&amp; !bHarvestingForRetry) <span class="comment">// on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l01035"></a>01035                         {
<a name="l01036"></a>01036                             <span class="comment">// Whereas if the payment plan was a failure, that means the closing numbers are harvestable!</span>
<a name="l01037"></a>01037                             thePlan.<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(theNym); 
<a name="l01038"></a>01038                             bSuccess = <span class="keyword">true</span>;
<a name="l01039"></a>01039                         }
<a name="l01040"></a>01040                     }
<a name="l01041"></a>01041                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l01042"></a>01042                 } <span class="comment">// else (the payment plan loaded successfully)</span>
<a name="l01043"></a>01043             } <span class="comment">// pItem was found.</span>
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045             <span class="keywordflow">break</span>;
<a name="l01046"></a>01046             
<a name="l01047"></a>01047             <span class="comment">// --------------------------------------------------------------------------------------------------</span>
<a name="l01048"></a>01048                         
<a name="l01049"></a>01049         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>:  <span class="comment">// Uses X transaction #s, with an opener for each party and a closer for each asset account.</span>
<a name="l01050"></a>01050                                             <span class="comment">// If the message is rejected by the server, then ALL openers can be harvested. But if the</span>
<a name="l01051"></a>01051                                             <span class="comment">// message was successful (REGARDLESS of whether the transaction was successful) then all of</span>
<a name="l01052"></a>01052                                             <span class="comment">// the openers for all of the parties have been burned. The closers, meanwhile, can be recovered</span>
<a name="l01053"></a>01053                                             <span class="comment">// if the message is a failure, as well as in cases where message succeeds but transaction failed.</span>
<a name="l01054"></a>01054                                             <span class="comment">// But if transaction succeeded, then the closers CANNOT be recovered. (Only removed, once you sign</span>
<a name="l01055"></a>01055                                             <span class="comment">// off on the receipt.)</span>
<a name="l01056"></a>01056         {
<a name="l01057"></a>01057             <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l01058"></a>01058             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1adb560811f0265d344fac45c9333bc25d">OTItem::smartContract</a>);
<a name="l01059"></a>01059             
<a name="l01060"></a>01060             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l01061"></a>01061             {
<a name="l01062"></a>01062                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: Error: Unable to find &quot;</span>
<a name="l01063"></a>01063                              <span class="stringliteral">&quot;smartContract item in smartContract transaction.\n&quot;</span>);
<a name="l01064"></a>01064             }
<a name="l01065"></a>01065             <span class="keywordflow">else</span> <span class="comment">// Load up the smart contract...</span>
<a name="l01066"></a>01066             {
<a name="l01067"></a>01067                 <a class="code" href="class_o_t_string.html">OTString</a>        strSmartContract;
<a name="l01068"></a>01068                 <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> theSmartContract(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l01069"></a>01069                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strSmartContract);
<a name="l01070"></a>01070                 
<a name="l01071"></a>01071                 <span class="comment">// If we failed to load the smart contract...</span>
<a name="l01072"></a>01072                 <span class="keywordflow">if</span> (!strSmartContract.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || (<span class="keyword">false</span> == theSmartContract.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strSmartContract)))
<a name="l01073"></a>01073                 {
<a name="l01074"></a>01074                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::HarvestClosingNumbers: Error: Unable to load &quot;</span>
<a name="l01075"></a>01075                                  <span class="stringliteral">&quot;smartContract object from smartContract transaction item.\n&quot;</span>);
<a name="l01076"></a>01076                 }
<a name="l01077"></a>01077                 <span class="keywordflow">else</span> <span class="comment">// theSmartContract is ready to go....</span>
<a name="l01078"></a>01078                 {
<a name="l01079"></a>01079                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l01080"></a>01080                     <span class="comment">// The message reply itself was a failure. This means the transaction itself never got a chance</span>
<a name="l01081"></a>01081                     <span class="comment">// to run... which means ALL the closing numbers on that transaction are STILL GOOD.</span>
<a name="l01082"></a>01082                     <span class="comment">//</span>
<a name="l01083"></a>01083                     <span class="keywordflow">if</span> (bReplyWasFailure &amp;&amp; !bHarvestingForRetry) <span class="comment">// on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l01084"></a>01084                     {
<a name="l01085"></a>01085                         theSmartContract.<a class="code" href="class_o_t_smart_contract.html#a40befd7381c6c5e68e7d1042c9a7f2d3">HarvestClosingNumbers</a>(theNym);
<a name="l01086"></a>01086                         bSuccess = <span class="keyword">true</span>;
<a name="l01087"></a>01087                     }
<a name="l01088"></a>01088                     <span class="comment">// Else if the server reply message was unambiguously a SUCCESS, that means the opening number is DEFINITELY NOT HARVESTABLE.</span>
<a name="l01089"></a>01089                     <span class="comment">// Why? Because that means the transaction definitely ran--and the opener is marked as &quot;used&quot; on SUCCESS, or &quot;burned&quot; on</span>
<a name="l01090"></a>01090                     <span class="comment">// FAILURE--either way, that&#39;s bad for harvesting (no point.)</span>
<a name="l01091"></a>01091                     <span class="comment">//</span>
<a name="l01092"></a>01092                     <span class="comment">// ===&gt; HOW ABOUT THE CLOSING NUMBERS?</span>
<a name="l01093"></a>01093                     <span class="comment">// In cases where the message succeeds but the transaction failed, the closing numbers are recoverable. (TODO send notice to the parties when this happens...)</span>
<a name="l01094"></a>01094                     <span class="comment">// But if transaction succeeded, then the closers CANNOT be recovered. They are now &quot;used&quot; on the server, so you might as well keep them in that format on the client side, since that&#39;s how the client has them already.</span>
<a name="l01095"></a>01095                     
<a name="l01096"></a>01096                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bReplyWasSuccess)
<a name="l01097"></a>01097                     {
<a name="l01098"></a>01098                         <span class="keywordflow">if</span> (bTransactionWasSuccess)
<a name="l01099"></a>01099                         {
<a name="l01100"></a>01100                             <span class="comment">// This means the &quot;smartContract&quot; opening trans# is MARKED AS &quot;USED&quot;, and will someday be marked as CLOSED.</span>
<a name="l01101"></a>01101                             <span class="comment">// EITHER WAY, you certainly can&#39;t claw that number back now! (It is still outstanding, though. It&#39;s not gone, yet...)</span>
<a name="l01102"></a>01102                             <span class="comment">//</span>
<a name="l01103"></a>01103 <span class="comment">//                          theSmartContract.HarvestClosingNumbers(theNym);</span>
<a name="l01104"></a>01104 <span class="comment">//                          bSuccess = true;</span>
<a name="l01105"></a>01105                         }
<a name="l01106"></a>01106                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTransactionWasFailure &amp;&amp; !bHarvestingForRetry) <span class="comment">// on re-try, we need the closing #s to stay put, so the re-try has a chance to work.</span>
<a name="l01107"></a>01107                         {
<a name="l01108"></a>01108                             <span class="comment">// If the transaction was a failure, the opening trans number was burned, </span>
<a name="l01109"></a>01109                             <span class="comment">// but the CLOSING numbers are still harvestable...</span>
<a name="l01110"></a>01110                             <span class="comment">//</span>
<a name="l01111"></a>01111                             theSmartContract.<a class="code" href="class_o_t_smart_contract.html#a40befd7381c6c5e68e7d1042c9a7f2d3">HarvestClosingNumbers</a>(theNym);
<a name="l01112"></a>01112                             bSuccess = <span class="keyword">true</span>;                            
<a name="l01113"></a>01113                         }
<a name="l01114"></a>01114                     } <span class="comment">// else if (bReplyWasSuccess)</span>
<a name="l01115"></a>01115                     <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l01116"></a>01116                 } <span class="comment">// else (smart contract loaded successfully)</span>
<a name="l01117"></a>01117             } <span class="comment">// pItem was found.</span>
<a name="l01118"></a>01118             <span class="comment">// ------------------------------------------------------------------------------------------</span>
<a name="l01119"></a>01119         }
<a name="l01120"></a>01120             <span class="keywordflow">break</span>;
<a name="l01121"></a>01121             
<a name="l01122"></a>01122         <span class="keywordflow">default</span>:
<a name="l01123"></a>01123             <span class="keywordflow">break</span>;
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125     
<a name="l01126"></a>01126     <span class="keywordflow">return</span> bSuccess;
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="comment">// Client-side.</span>
<a name="l01131"></a>01131 <span class="comment">//</span>
<a name="l01132"></a>01132 <span class="comment">// This transaction actually was saved as a transaction receipt (filename: nymID.success)</span>
<a name="l01133"></a>01133 <span class="comment">// and now, for whatever reason, I want to verify the receipt against the local data (the Nym).</span>
<a name="l01134"></a>01134 <span class="comment">//</span>
<a name="l01135"></a>01135 <span class="comment">// Let&#39;s say the Nym has the numbers 9 and 10. He signs a receipt to that effect. Until a new</span>
<a name="l01136"></a>01136 <span class="comment">// receipt is signed, they should STILL be 9 and 10!  Therefore I should be able to load up</span>
<a name="l01137"></a>01137 <span class="comment">// the last receipt, pass it the Nym, and verify this.</span>
<a name="l01138"></a>01138 <span class="comment">//</span>
<a name="l01139"></a>01139 <span class="comment">// But what if the last receipt is a balance receipt, instead of a transaction receipt? Let&#39;s</span>
<a name="l01140"></a>01140 <span class="comment">// say I grab the Nym and he has only a 9! And though this transaction receipt shows a 9</span>
<a name="l01141"></a>01141 <span class="comment">// and 10, there is a newer balance receipt that shows only a 9? That means even when</span>
<a name="l01142"></a>01142 <span class="comment">// verifying a transaction receipt, I need to also load the last balance receipt and (for</span>
<a name="l01143"></a>01143 <span class="comment">// transaction numbers, anyway) use whichever one is newer.</span>
<a name="l01144"></a>01144 <span class="comment">//</span>
<a name="l01145"></a>01145 <span class="comment">// From there, it&#39;s simple: Make sure they match.</span>
<a name="l01146"></a>01146 <span class="comment">// I should do this when I already have the last receipt and I just grabbed a copy of the Nym.</span>
<a name="l01147"></a>01147 <span class="comment">// </span>
<a name="l01148"></a>01148 <span class="comment">// BUT!! I can&#39;t load the last balance receipt, since I don&#39;t have the account number.</span>
<a name="l01149"></a>01149 <span class="comment">// So let&#39;s say #10 disappears, as the last balance receipt would show (but which I can&#39;t see.)</span>
<a name="l01150"></a>01150 <span class="comment">// That means THE_NYM will show that 10 is missing, even though *this shows that #10 is still</span>
<a name="l01151"></a>01151 <span class="comment">// on the list. Is that bad?</span>
<a name="l01152"></a>01152 <span class="comment">// </span>
<a name="l01153"></a>01153 <span class="comment">// New transaction numbers can only be issued to my signed-out list of responsibility in the</span>
<a name="l01154"></a>01154 <span class="comment">// case where I SIGNED for each number using a transaction agreement.</span>
<a name="l01155"></a>01155 <span class="comment">// Whereas transaction numbers can only be REMOVED via a balance agreement (processInbox.)</span>
<a name="l01156"></a>01156 <span class="comment">// (NOTE: or they can be removed from an expired or canceled cron item -- aka finalReceipt.)</span>
<a name="l01157"></a>01157 <span class="comment">// Therefore, at most, I will see that a number has disappeared, NOT that one was added.</span>
<a name="l01158"></a>01158 <span class="comment">//</span>
<a name="l01159"></a>01159 <span class="comment">// Conclusion: as long as numbers only DISAPPEAR, and are not ADDED, then this verify is good.</span>
<a name="l01160"></a>01160 <span class="comment">// But in VerifyBalanceReceipt (next function down) I will need to load the transaction receipt</span>
<a name="l01161"></a>01161 <span class="comment">// and use it for verifying issued numbers, in cases where that receipt is newer than the balance</span>
<a name="l01162"></a>01162 <span class="comment">// receipt. (Because in that case, numbers may have been ADDED..)</span>
<a name="l01163"></a>01163 <span class="comment">//</span>
<a name="l01164"></a><a class="code" href="class_o_t_transaction.html#a3133d3def40d31a08f169b406f847b5f">01164</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a3ce6cac1f366f808f0296473138363eb">OTTransaction::VerifyTransactionReceipt</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; SERVER_NYM, <span class="comment">// For verifying a signature.</span>
<a name="l01165"></a>01165                                              <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; THE_NYM)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01168"></a>01168     {
<a name="l01169"></a>01169         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Error: This is an abbreviated receipt. (Load the box receipt first.)\n&quot;</span>);
<a name="l01170"></a>01170         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172     <span class="comment">// ------------------------------------</span>
<a name="l01173"></a>01173     <span class="comment">// LOAD &quot;AT TRANSACTION STATEMENT&quot; (ITEM)</span>
<a name="l01174"></a>01174     
<a name="l01175"></a>01175     <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = NULL;
<a name="l01176"></a>01176     
<a name="l01177"></a>01177     <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
<a name="l01178"></a>01178     
<a name="l01179"></a>01179     <span class="keywordflow">if</span> (NULL == pResponseBalanceItem)
<a name="l01180"></a>01180     {
<a name="l01181"></a>01181         <span class="comment">// error, return.</span>
<a name="l01182"></a>01182         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No atTransactionStatement item found on receipt (strange.)\n&quot;</span>);
<a name="l01183"></a>01183         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01186"></a>01186     {
<a name="l01187"></a>01187         <span class="comment">// error, return.</span>
<a name="l01188"></a>01188         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: atTransactionStatement found on receipt, but not a successful one.\n&quot;</span>);
<a name="l01189"></a>01189         <span class="keywordflow">return</span> <span class="keyword">false</span>;       
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(SERVER_NYM))
<a name="l01192"></a>01192     {       
<a name="l01193"></a>01193         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on atTransactionStatement item in OTTransaction::VerifyTransactionReceipt.\n&quot;</span>);
<a name="l01194"></a>01194         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196     
<a name="l01197"></a>01197     <span class="comment">// ------------------------------------</span>
<a name="l01198"></a>01198     
<a name="l01199"></a>01199     <span class="comment">// LOAD &quot;TRANSACTION STATEMENT&quot; (ITEM)</span>
<a name="l01200"></a>01200     
<a name="l01201"></a>01201     <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;
<a name="l01202"></a>01202     pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strBalanceItem);
<a name="l01203"></a>01203     
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (!strBalanceItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01205"></a>01205     {
<a name="l01206"></a>01206         <span class="comment">// error, return.</span>
<a name="l01207"></a>01207         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No transactionStatement item found as &#39;in ref to&#39; string on a receipt containing atTransactionStatement item.\n&quot;</span>);
<a name="l01208"></a>01208         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     pBalanceItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strBalanceItem, 
<a name="l01212"></a>01212                                                 <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l01213"></a>01213                                                 pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01214"></a>01214     
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (NULL == pBalanceItem)
<a name="l01216"></a>01216     {
<a name="l01217"></a>01217         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load transactionStatement item from string (from a receipt containing an atTransactionStatement item.)\n&quot;</span>);
<a name="l01218"></a>01218         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01219"></a>01219     }
<a name="l01220"></a>01220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>)
<a name="l01221"></a>01221     {
<a name="l01222"></a>01222         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Wrong type on pBalanceItem (expected OTItem::transactionStatement)\n&quot;</span>);
<a name="l01223"></a>01223         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(THE_NYM))
<a name="l01226"></a>01226     {
<a name="l01227"></a>01227         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on transactionStatement item in OTTransaction::VerifyTransactionReceipt.\n&quot;</span>);
<a name="l01228"></a>01228         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01229"></a>01229     }
<a name="l01230"></a>01230     
<a name="l01231"></a>01231     <span class="comment">// ---------------------------------------------------------</span>
<a name="l01232"></a>01232     
<a name="l01233"></a>01233     <span class="comment">// LOAD MESSAGE NYM (THE LIST OF ISSUED NUMBERS ACCORDING TO THE RECEIPT.)</span>
<a name="l01234"></a>01234     
<a name="l01235"></a>01235     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theMessageNym;
<a name="l01236"></a>01236     <a class="code" href="class_o_t_string.html">OTString</a>    strMessageNym; <span class="comment">// Okay now we have the transaction numbers in this MessageNym string.</span>
<a name="l01237"></a>01237     
<a name="l01238"></a>01238     pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strMessageNym); 
<a name="l01239"></a>01239     
<a name="l01240"></a>01240     <span class="keywordflow">if</span> (!strMessageNym.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !theMessageNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strMessageNym))
<a name="l01241"></a>01241     {
<a name="l01242"></a>01242         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load message nym in OTTransaction::VerifyTransactionReceipt.\n&quot;</span>);
<a name="l01243"></a>01243         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245     
<a name="l01246"></a>01246     <span class="comment">// ------------------------------------</span>
<a name="l01247"></a>01247     
<a name="l01248"></a>01248     <span class="comment">// VERIFY THE LIST OF ISSUED (SIGNED FOR) TRANSACTION NUMBERS ON THE NYM AGAINST THE RECEIPT.</span>
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     <span class="comment">// It&#39;s okay if some transaction #s in theMessageNym (the receipt) aren&#39;t found on THE_NYM, (client-side)</span>
<a name="l01251"></a>01251     <span class="comment">// since the last balance agreement may have cleaned them out after they were recorded in</span>
<a name="l01252"></a>01252     <span class="comment">// theMessageNym (from the transaction statement receipt).</span>
<a name="l01253"></a>01253     <span class="comment">//</span>
<a name="l01254"></a>01254     <span class="comment">// But I should never see transaction #s APPEAR in THE_NYM that aren&#39;t in theMessageNym,</span>
<a name="l01255"></a>01255     <span class="comment">// since a balance agreement (or a finalReceipt) can ONLY remove numbers, not add them.</span>
<a name="l01256"></a>01256     <span class="comment">//</span>
<a name="l01257"></a>01257     <span class="comment">//</span>
<a name="l01258"></a>01258     <span class="keywordflow">if</span> (!THE_NYM.<a class="code" href="class_o_t_pseudonym.html#a52932b9c7bbb25ca21e1bf83d067e138">VerifyTransactionStatementNumbersOnNym</a>(theMessageNym))
<a name="l01259"></a>01259     {
<a name="l01260"></a>01260         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify issued numbers on last signed receipt with numbers on THE_NYM in OTTransaction::VerifyTransactionReceipt.\n&quot;</span>);
<a name="l01261"></a>01261         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263     
<a name="l01264"></a>01264     <span class="comment">// -------------------------------------------------------  </span>
<a name="l01265"></a>01265     
<a name="l01266"></a>01266     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01267"></a>01267 }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269 
<a name="l01270"></a>01270 <span class="comment">// static</span>
<a name="l01271"></a><a class="code" href="class_o_t_transaction.html#a3ce6cac1f366f808f0296473138363eb">01271</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a3ce6cac1f366f808f0296473138363eb">OTTransaction::VerifyTransactionReceipt</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; SERVER_NYM,
<a name="l01272"></a>01272                                              <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; THE_NYM,
<a name="l01273"></a>01273                                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID)
<a name="l01274"></a>01274 {
<a name="l01275"></a>01275     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(THE_NYM), SERVER_USER_ID(SERVER_NYM);
<a name="l01276"></a>01276     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strReceiptID(USER_ID);
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <a class="code" href="class_o_t_string.html">OTString</a> strFilename; strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01279"></a>01279     
<a name="l01280"></a>01280     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder1name  = <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();   <span class="comment">// receipts</span>
<a name="l01281"></a>01281     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder2name  = strServerID.Get();        <span class="comment">// receipts/SERVER_ID</span>
<a name="l01282"></a>01282     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();        <span class="comment">// receipts/SERVER_ID/USER_ID.success</span>
<a name="l01283"></a>01283     
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(szFolder1name, szFolder2name, szFilename))
<a name="l01285"></a>01285     {
<a name="l01286"></a>01286         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Receipt file doesn&#39;t exist in OTTransaction::VerifyTransactionReceipt.\n&quot;</span>);
<a name="l01287"></a>01287         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289     
<a name="l01290"></a>01290     <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l01291"></a>01291     <span class="comment">//</span>
<a name="l01292"></a>01292     std::string strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(szFolder1name, szFolder2name, szFilename)); <span class="comment">// &lt;=== LOADING FROM DATA STORE.</span>
<a name="l01293"></a>01293     
<a name="l01294"></a>01294     <span class="keywordflow">if</span> (strFileContents.length() &lt; 2)
<a name="l01295"></a>01295     {
<a name="l01296"></a>01296         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Error reading file: %s%s%s%s%s\n&quot;</span>, 
<a name="l01297"></a>01297                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01298"></a>01298         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01301"></a>01301         
<a name="l01302"></a>01302     <a class="code" href="class_o_t_string.html">OTString</a> strTransaction(strFileContents.c_str());
<a name="l01303"></a>01303 
<a name="l01304"></a>01304     <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pContents = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strTransaction);
<a name="l01305"></a>01305     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theAngel(pContents);
<a name="l01306"></a>01306     
<a name="l01307"></a>01307     <span class="keywordflow">if</span> ((NULL == pContents) || (<span class="keyword">false</span> == pContents-&gt;VerifySignature(SERVER_NYM)))
<a name="l01308"></a>01308     {
<a name="l01309"></a>01309         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Unable to load or verify transaction statement:&quot;</span>
<a name="l01310"></a>01310                       <span class="stringliteral">&quot; %s%s%s%s%s\n&quot;</span>,
<a name="l01311"></a>01311                       szFolder1name,            <span class="comment">// receipts</span>
<a name="l01312"></a>01312                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l01313"></a>01313                       szFolder2name,            <span class="comment">// receipts/SERVER_ID</span>
<a name="l01314"></a>01314                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l01315"></a>01315                       szFilename);              <span class="comment">// receipts/SERVER_ID/USER_ID.success</span>
<a name="l01316"></a>01316         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01317"></a>01317     }               
<a name="l01318"></a>01318     
<a name="l01319"></a>01319     <span class="comment">// At this point, pContents is successfully loaded and verified, containing the last transaction receipt.</span>
<a name="l01320"></a>01320     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pContents);
<a name="l01321"></a>01321     
<a name="l01322"></a>01322     <span class="keywordflow">if</span> (NULL != pTrans)
<a name="l01323"></a>01323     {
<a name="l01324"></a>01324         <span class="comment">// -----------------------------------------------------</span>
<a name="l01325"></a>01325         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = NULL;
<a name="l01326"></a>01326         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransAngel;
<a name="l01327"></a>01327         
<a name="l01328"></a>01328         <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01329"></a>01329         {
<a name="l01330"></a>01330             int64_t lBoxType = 0;
<a name="l01331"></a>01331             
<a name="l01332"></a>01332                  <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;nymboxRecord&quot;</span>))        lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>);
<a name="l01333"></a>01333             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;inboxRecord&quot;</span>))         lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>);
<a name="l01334"></a>01334             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;outboxRecord&quot;</span>))        lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>);
<a name="l01335"></a>01335             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;paymentInboxRecord&quot;</span>))  lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
<a name="l01336"></a>01336             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;recordBoxRecord&quot;</span>))     lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>);
<a name="l01337"></a>01337             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;expiredBoxRecord&quot;</span>))    lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>);
<a name="l01338"></a>01338             <span class="keywordflow">else</span>
<a name="l01339"></a>01339             {
<a name="l01340"></a>01340                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Error loading from abbreviated transaction: &quot;</span>
<a name="l01341"></a>01341                              <span class="stringliteral">&quot;couldn&#39;t find nymboxRecord or inboxRecord or outboxRecord in raw contents of abbreviated &quot;</span>
<a name="l01342"></a>01342                              <span class="stringliteral">&quot;transaction. Can&#39;t tell the ledger type from this.\n&quot;</span>);
<a name="l01343"></a>01343                 <span class="keywordflow">return</span> <span class="keyword">false</span>;           
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345             <span class="comment">// --------------</span>
<a name="l01346"></a>01346             pTransaction = <a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">OTTransaction::LoadBoxReceipt</a>(*pTrans, lBoxType);
<a name="l01347"></a>01347             <span class="keywordflow">if</span> (NULL == pTransaction)
<a name="l01348"></a>01348             {
<a name="l01349"></a>01349                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Error loading from abbreviated transaction: &quot;</span>
<a name="l01350"></a>01350                               <span class="stringliteral">&quot;failed loading box receipt.&quot;</span>);
<a name="l01351"></a>01351                 <span class="keywordflow">return</span> <span class="keyword">false</span>;           
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353             <span class="comment">// ----------------</span>
<a name="l01354"></a>01354             theTransAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pTransaction);
<a name="l01355"></a>01355         }
<a name="l01356"></a>01356         <span class="keywordflow">else</span>
<a name="l01357"></a>01357             pTransaction = pTrans;
<a name="l01358"></a>01358         <span class="comment">// -----------------------------------------------------        </span>
<a name="l01359"></a>01359         <span class="keywordflow">return</span> pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a3ce6cac1f366f808f0296473138363eb">VerifyTransactionReceipt</a>(SERVER_NYM, THE_NYM);
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     <span class="keywordflow">else</span>   
<a name="l01362"></a>01362         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::VerifyTransactionReceipt: Error... dynamic_cast failed.\n&quot;</span>);
<a name="l01363"></a>01363         
<a name="l01364"></a>01364     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01365"></a>01365 }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367 
<a name="l01368"></a>01368 <span class="comment">// static</span>
<a name="l01369"></a><a class="code" href="class_o_t_transaction.html#ae4bcd8edaf9b3cb72b0a68d503af804c">01369</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#ae4bcd8edaf9b3cb72b0a68d503af804c">OTTransaction::VerifyBalanceReceipt</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; SERVER_NYM,
<a name="l01370"></a>01370                                          <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; THE_NYM,
<a name="l01371"></a>01371                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l01372"></a>01372                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCT_ID)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(THE_NYM), SERVER_USER_ID(SERVER_NYM);
<a name="l01375"></a>01375     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strReceiptID(ACCT_ID);
<a name="l01376"></a>01376     
<a name="l01377"></a>01377     <span class="comment">// -----------------------------------</span>
<a name="l01378"></a>01378     
<a name="l01379"></a>01379     <span class="comment">// Load the last successful BALANCE STATEMENT...</span>
<a name="l01380"></a>01380     
<a name="l01381"></a>01381     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> tranOut(SERVER_USER_ID, ACCT_ID, SERVER_ID);
<a name="l01382"></a>01382     
<a name="l01383"></a>01383     <a class="code" href="class_o_t_string.html">OTString</a> strFilename; strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01384"></a>01384     
<a name="l01385"></a>01385     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder1name  = <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();   <span class="comment">// receipts</span>
<a name="l01386"></a>01386     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder2name  = strServerID.Get();        <span class="comment">// receipts/SERVER_ID</span>
<a name="l01387"></a>01387     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();        <span class="comment">// receipts/SERVER_ID/ACCT_ID.success</span>
<a name="l01388"></a>01388             
<a name="l01389"></a>01389     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(szFolder1name, szFolder2name, szFilename))
<a name="l01390"></a>01390     {
<a name="l01391"></a>01391         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Receipt file doesn&#39;t exist in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01392"></a>01392         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01393"></a>01393     }
<a name="l01394"></a>01394     
<a name="l01395"></a>01395     <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l01396"></a>01396     <span class="comment">//</span>
<a name="l01397"></a>01397     std::string strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(szFolder1name, szFolder2name, szFilename)); <span class="comment">// &lt;=== LOADING FROM DATA STORE.</span>
<a name="l01398"></a>01398     
<a name="l01399"></a>01399     <span class="keywordflow">if</span> (strFileContents.length() &lt; 2)
<a name="l01400"></a>01400     {
<a name="l01401"></a>01401         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Error reading file: %s%s%s%s%s\n&quot;</span>, 
<a name="l01402"></a>01402                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01403"></a>01403         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01406"></a>01406     
<a name="l01407"></a>01407     <a class="code" href="class_o_t_string.html">OTString</a> strTransaction(strFileContents.c_str());
<a name="l01408"></a>01408     
<a name="l01409"></a>01409     <span class="keywordflow">if</span> (!tranOut.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTransaction))
<a name="l01410"></a>01410     {
<a name="l01411"></a>01411         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Unable to load balance statement:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01412"></a>01412                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01413"></a>01413         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01414"></a>01414     }
<a name="l01415"></a>01415     <span class="comment">// -----------------------------------------------------</span>
<a name="l01416"></a>01416     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = NULL;
<a name="l01417"></a>01417     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransAngel;
<a name="l01418"></a>01418     
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>()) <span class="comment">// should never happen</span>
<a name="l01420"></a>01420     {
<a name="l01421"></a>01421         int64_t lBoxType = 0;
<a name="l01422"></a>01422         
<a name="l01423"></a>01423              <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;nymboxRecord&quot;</span>))          lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>);
<a name="l01424"></a>01424         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;inboxRecord&quot;</span>))           lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>);
<a name="l01425"></a>01425         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;outboxRecord&quot;</span>))          lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>);
<a name="l01426"></a>01426         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;paymentInboxRecord&quot;</span>))    lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
<a name="l01427"></a>01427         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;recordBoxRecord&quot;</span>))       lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>);
<a name="l01428"></a>01428         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction_type.html#a6551c3443c638e690ddd5eda535c0101">Contains</a>(<span class="stringliteral">&quot;expiredBoxRecord&quot;</span>))      lBoxType = static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>);
<a name="l01429"></a>01429         <span class="keywordflow">else</span>
<a name="l01430"></a>01430         {
<a name="l01431"></a>01431             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Error loading from abbreviated transaction: &quot;</span>
<a name="l01432"></a>01432                           <span class="stringliteral">&quot;unknown ledger type. (probably message but who knows.)\n&quot;</span>);
<a name="l01433"></a>01433             <span class="keywordflow">return</span> <span class="keyword">false</span>;           
<a name="l01434"></a>01434         }
<a name="l01435"></a>01435         <span class="comment">// --------------</span>
<a name="l01436"></a>01436         pTransaction = <a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">OTTransaction::LoadBoxReceipt</a>(tranOut, lBoxType);
<a name="l01437"></a>01437         <span class="keywordflow">if</span> (NULL == pTransaction)
<a name="l01438"></a>01438         {
<a name="l01439"></a>01439             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Error loading from abbreviated transaction: &quot;</span>
<a name="l01440"></a>01440                           <span class="stringliteral">&quot;failed loading box receipt.&quot;</span>);
<a name="l01441"></a>01441             <span class="keywordflow">return</span> <span class="keyword">false</span>;           
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443         <span class="comment">// ----------------</span>
<a name="l01444"></a>01444         theTransAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pTransaction);
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446     <span class="keywordflow">else</span>
<a name="l01447"></a>01447         pTransaction = &amp;tranOut;
<a name="l01448"></a>01448     <span class="comment">// -----------------------------------------------------    </span>
<a name="l01449"></a>01449     <span class="keywordflow">if</span> (!pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(SERVER_NYM))
<a name="l01450"></a>01450     {
<a name="l01451"></a>01451         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Unable to verify SERVER_NYM signature on balance statement:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01452"></a>01452                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01453"></a>01453         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01454"></a>01454     }               
<a name="l01455"></a>01455     
<a name="l01456"></a>01456     <span class="comment">// At this point, pTransaction is successfully loaded and verified, containing the last balance receipt.</span>
<a name="l01457"></a>01457     
<a name="l01458"></a>01458     <span class="keywordflow">return</span> pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ae4bcd8edaf9b3cb72b0a68d503af804c">VerifyBalanceReceipt</a>(SERVER_NYM, THE_NYM);
<a name="l01459"></a>01459 }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461 
<a name="l01462"></a>01462 <span class="comment">// Client-side</span>
<a name="l01463"></a>01463 <span class="comment">//</span>
<a name="l01464"></a>01464 <span class="comment">// This transaction actually was saved as a balance receipt (filename: accountID.success)</span>
<a name="l01465"></a>01465 <span class="comment">// and now, for whatever reason, I want to verify the receipt against the local data (the Nym,</span>
<a name="l01466"></a>01466 <span class="comment">// the inbox, the outbox, and the account balance).</span>
<a name="l01467"></a>01467 <span class="comment">//</span>
<a name="l01468"></a>01468 <span class="comment">// Let&#39;s say the Nym has the numbers 9 and 10. He signs a receipt to that effect. Until a new</span>
<a name="l01469"></a>01469 <span class="comment">// receipt is signed, they should STILL be 9 and 10!  Therefore I should be able to load up</span>
<a name="l01470"></a>01470 <span class="comment">// the last receipt, pass it the Nym, and verify this.</span>
<a name="l01471"></a>01471 <span class="comment">//</span>
<a name="l01472"></a>01472 <span class="comment">// But what if the last receipt is a transaction receipt, instead of a balance receipt? Let&#39;s</span>
<a name="l01473"></a>01473 <span class="comment">// say I grab the Nym and he has 9, 10, and 15! And though this balance receipt shows 9 and 10,</span>
<a name="l01474"></a>01474 <span class="comment">// there is a newer one that shows 9, 10, and 15? That means even when verifying a balance </span>
<a name="l01475"></a>01475 <span class="comment">// receipt, I need to also load the last transaction receipt and for transaction numbers, use</span>
<a name="l01476"></a>01476 <span class="comment">// whichever one is newer.</span>
<a name="l01477"></a>01477 <span class="comment">//</span>
<a name="l01478"></a>01478 <span class="comment">// When downloading the inbox, the outbox, the account, or the nym, if there is a receipt, I</span>
<a name="l01479"></a>01479 <span class="comment">// should compare what I&#39;ve downloaded with the last receipt. Because if there&#39;s a discrepancy,</span>
<a name="l01480"></a>01480 <span class="comment">// then I don&#39;t want to USE that inbox/outbox/account/nym to sign a NEW receipt, causing me</span>
<a name="l01481"></a>01481 <span class="comment">// to sign agreement to invalid data!  Instead, I want a red flag to go up, and the receipt</span>
<a name="l01482"></a>01482 <span class="comment">// automatically saved to a disputes folder, etc.</span>
<a name="l01483"></a>01483 <span class="comment">//</span>
<a name="l01484"></a><a class="code" href="class_o_t_transaction.html#abb94fbee174343f38ca30eaa25487cb4">01484</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#ae4bcd8edaf9b3cb72b0a68d503af804c">OTTransaction::VerifyBalanceReceipt</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; SERVER_NYM, <span class="comment">// For verifying a signature.</span>
<a name="l01485"></a>01485                                          <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; THE_NYM) <span class="comment">// transaction numbers issued according to nym must match this.</span>
<a name="l01486"></a>01486                                          <span class="comment">//OTLedger &amp; THE_INBOX,    // All inbox items on *this must also be found in THE_INBOX. All new items (on THE_INBOX only) must be accounted for in the balance. </span>
<a name="l01487"></a>01487                                          <span class="comment">//OTLedger &amp; THE_OUTBOX,   // All inbox items that changed balance (cheque, market, payment) must be found on the list of issued numbers.</span>
<a name="l01488"></a>01488                                          <span class="comment">//const OTAccount &amp; THE_ACCOUNT) // All outbox items must match, and the account balance must be accounted for as described.</span>
<a name="l01489"></a>01489 {                                       <span class="comment">// These are now loaded within this function, so no need to pass them in.</span>
<a name="l01490"></a>01490     <span class="comment">// Load the other receipt (see above) if necessary.</span>
<a name="l01491"></a>01491     
<a name="l01492"></a>01492     <span class="comment">// Compare the inbox I just downloaded with what my last signed receipt SAYS it should say.</span>
<a name="l01493"></a>01493     <span class="comment">// Let&#39;s say the inbox has transaction 9 in it -- well, my last signed receipt better show</span>
<a name="l01494"></a>01494     <span class="comment">// that 9 was in my inbox then, too. But what if 9 was on a cheque, and it only recently hit?</span>
<a name="l01495"></a>01495     <span class="comment">// Well it won&#39;t be in my old inbox, but it WILL still be signed for as an open transaction.</span>
<a name="l01496"></a>01496     
<a name="l01497"></a>01497     <span class="comment">// Since this involves verifying the outbox, inbox, AND account, this function should only</span>
<a name="l01498"></a>01498     <span class="comment">// be called after all three have been downloaded, not after each one.</span>
<a name="l01499"></a>01499     <span class="comment">// Basically the outbox should RARELY change, the inbox is EXPECTED to change, and the account</span>
<a name="l01500"></a>01500     <span class="comment">// is EXPECTED to change, BUT ONLY in cases where the inbox justifies it!</span>
<a name="l01501"></a>01501     <span class="comment">//</span>
<a name="l01502"></a>01502     <span class="comment">// -- Verify the transaction numbers on the nym match those exactly on the newest transaction or balance receipt. (this)</span>
<a name="l01503"></a>01503     <span class="comment">// -- Make sure outbox is the same.</span>
<a name="l01504"></a>01504     <span class="comment">// -- Loop through all items in the inbox, AND in the inbox according to the receipt, and total the</span>
<a name="l01505"></a>01505     <span class="comment">//    values of both. I might have 9 and 10 issued in the last receipt, with #9 in the inbox,</span>
<a name="l01506"></a>01506     <span class="comment">//    showing 50 clams and a balance of 93. But now I downloaded an inbox showing #9 AND #10,</span>
<a name="l01507"></a>01507     <span class="comment">//    with values of 50 and 4, and a balance of 89.</span>
<a name="l01508"></a>01508     <span class="comment">//    The new inbox is still valid, and the new account balance is still valid, because the</span>
<a name="l01509"></a>01509     <span class="comment">//    new number that appeared was issued to me and signed out, and because the last receipt&#39;s</span>
<a name="l01510"></a>01510     <span class="comment">//    balance of 93 with 50 clams worth of receipts, matches up to the new account/inbox</span>
<a name="l01511"></a>01511     <span class="comment">//    balance of 89 with 54 clams worth of receipts.</span>
<a name="l01512"></a>01512     <span class="comment">//    The two totals still match!  That&#39;s what we&#39;re checking for.</span>
<a name="l01513"></a>01513     <span class="comment">//</span>
<a name="l01514"></a>01514     <span class="comment">// Not JUST that actually, but that, if #10 is NOT found in the old one, THEN the amount (4)</span>
<a name="l01515"></a>01515     <span class="comment">// must be the DIFFERENCE between the balances (counting all new transactions like #10.)</span>
<a name="l01516"></a>01516     <span class="comment">// Meaning, the difference between the two balances MUST be made up EXACTLY by the transactions</span>
<a name="l01517"></a>01517     <span class="comment">// that are found now, that were not previously found, minus the total of the transactions</span>
<a name="l01518"></a>01518     <span class="comment">// from before that are no longer there, but are also no longer on my issued list and thus don&#39;t matter.</span>
<a name="l01519"></a>01519     <span class="comment">// </span>
<a name="l01520"></a>01520     <span class="comment">// Wow ! OTItem::VerifyBalanceStatement will have useful code but it doesn&#39;t encapsulate all this</span>
<a name="l01521"></a>01521     <span class="comment">// new functionality, since this version must assume differences are there, and STILL verify things</span>
<a name="l01522"></a>01522     <span class="comment">// by comparing details about those differences, whereas that version only serves to make sure</span>
<a name="l01523"></a>01523     <span class="comment">// everything still matches.</span>
<a name="l01524"></a>01524     <span class="comment">// ---------------------------------------------------</span>
<a name="l01525"></a>01525     
<a name="l01526"></a>01526     <span class="comment">// -- Verify nym transactions match. (issued.)</span>
<a name="l01527"></a>01527     <span class="comment">// -- Verify outbox matches.</span>
<a name="l01528"></a>01528     <span class="comment">// -- Loop through all items on receipt. If outbox item, should match exactly.</span>
<a name="l01529"></a>01529     <span class="comment">// -- But for inbox items, total up: the amount of the total of the items from the receipt,</span>
<a name="l01530"></a>01530     <span class="comment">//    for all those that would actually change the balance (chequeReceipt, marketReceipt, paymentReceipt, basketReceipt.)</span>
<a name="l01531"></a>01531     <span class="comment">//    These should ALL be found in the current version of the inbox. (They can only be removed by balance agreement,</span>
<a name="l01532"></a>01532     <span class="comment">//    which would update THIS RECEIPT to remove them...)</span>
<a name="l01533"></a>01533     <span class="comment">// -- That was the receipt. Now loop through the above inbox items and do the reverse: for each item in the NEW inbox, </span>
<a name="l01534"></a>01534     <span class="comment">//    add up the total of those that would change the balance, for receipts found on the new but not the old, and account for that exactly as a difference in balance.</span>
<a name="l01535"></a>01535     <span class="comment">/*</span>
<a name="l01536"></a>01536 <span class="comment">     </span>
<a name="l01537"></a>01537 <span class="comment">     Example.</span>
<a name="l01538"></a>01538 <span class="comment">     </span>
<a name="l01539"></a>01539 <span class="comment">     -- Oldest signed receipt shows a balance of 115 clams.</span>
<a name="l01540"></a>01540 <span class="comment">        But then, cheque #78 hits my inbox and though I haven&#39;t yet accepted the receipt, I still need to do a transaction, like a 5 clam withdrawal, or whatever,</span>
<a name="l01541"></a>01541 <span class="comment">        and somehow I end up doing a balance agreement.  That results in the below signed receipt:</span>
<a name="l01542"></a>01542 <span class="comment">     </span>
<a name="l01543"></a>01543 <span class="comment">     --- Old receipt shows inbox/account/nym as:</span>
<a name="l01544"></a>01544 <span class="comment">     Currently signed out: 8, 9, 10, and 15</span>
<a name="l01545"></a>01545 <span class="comment">     Balance of 100 clams (Last signed balance before this was for 115 clams above)</span>
<a name="l01546"></a>01546 <span class="comment">     Inbox items:</span>
<a name="l01547"></a>01547 <span class="comment">     #78 cheque receipt (#8) for 15 clams. (The missing money is already reflected in the above balance. BUT!! #8 must still be signed out for this to verify. Here I must sign to acknowledge the receipt is in my inbox, but I still have option to accept or dispute the receipt. Until then, server keeps it around since it has my signature on it and proves the current balance.)</span>
<a name="l01548"></a>01548 <span class="comment">     #82 incoming transfer for 50 clams (A new balance agreement occurs during acceptance of this. And the number doesn&#39;t belong to me. So, irrelevant here.) </span>
<a name="l01549"></a>01549 <span class="comment">     #10 transfer receipt for some old transfer (does NOT change balance, which already happened in the past, BUT!! #10 must still be signed out for this to verify.)</span>
<a name="l01550"></a>01550 <span class="comment">     </span>
<a name="l01551"></a>01551 <span class="comment">     My nym ISSUED list should not change unless I have a new transaction agreement, therefore I expect the list to match every time.</span>
<a name="l01552"></a>01552 <span class="comment">     My outbox should also match. Thus, only my account balance and inbox might change. (On the server side, which I&#39;ll see when I dl </span>
<a name="l01553"></a>01553 <span class="comment">     new versions of them and compare against my last receipt i.e. this function.)</span>
<a name="l01554"></a>01554 <span class="comment">     How?  NOT via transfer receipt, since I would sign a new balance agreement whenever that would actually impact my balance.</span>
<a name="l01555"></a>01555 <span class="comment">     But it could happen with a *** chequeReceipt, a paymentReceipt, marketReceipt, or basketReceipt. *** </span>
<a name="l01556"></a>01556 <span class="comment">     Those mean, my balance has changed.</span>
<a name="l01557"></a>01557 <span class="comment">     In those cases, my account balance WOULD be different, but there had better be matching receipts in the inbox!</span>
<a name="l01558"></a>01558 <span class="comment">     </span>
<a name="l01559"></a>01559 <span class="comment">     --- New inbox/account/nym shows:</span>
<a name="l01560"></a>01560 <span class="comment">     Currently signed out: 8, 9, 10, and 15</span>
<a name="l01561"></a>01561 <span class="comment">     Balance of 89 clams</span>
<a name="l01562"></a>01562 <span class="comment">     Inbox items:</span>
<a name="l01563"></a>01563 <span class="comment">     #78 cheque receipt (#8) for 15 clams. </span>
<a name="l01564"></a>01564 <span class="comment">     #82 incoming transfer for 50 clams (A new balance agreement occurs during acceptance. So this type has no affect on balance here.) </span>
<a name="l01565"></a>01565 <span class="comment">     #10 transfer receipt for some old transfer (does NOT change balance, which already happened in the past)</span>
<a name="l01566"></a>01566 <span class="comment">     #96 cheque receipt for 7 clams (cheque #9)</span>
<a name="l01567"></a>01567 <span class="comment">     #97 marketReceipt for 4 clams (marketOffer #15)</span>
<a name="l01568"></a>01568 <span class="comment">     #99 incoming transfer for 2000 clams (Accepting it will require a new balance agreement.)</span>
<a name="l01569"></a>01569 <span class="comment">     </span>
<a name="l01570"></a>01570 <span class="comment">     ---------------------------------</span>
<a name="l01571"></a>01571 <span class="comment">     </span>
<a name="l01572"></a>01572 <span class="comment">     How do I interpret all this data?</span>
<a name="l01573"></a>01573 <span class="comment">     -- Transaction numbers signed out had better match. (If #s issued had changed, I would have signed for it already.)</span>
<a name="l01574"></a>01574 <span class="comment">     </span>
<a name="l01575"></a>01575 <span class="comment">     Next loop through the inbox from the old receipt:</span>
<a name="l01576"></a>01576 <span class="comment">     -- #78, cheque receipt, had better be there in the new inbox, since removing it requires a balance agreement, meaning it would already be off the receipt that I&#39;m verifying... Since it&#39;s here in inbox, should therefore also be in the last receipt.</span>
<a name="l01577"></a>01577 <span class="comment">     -- #82, incoming transfer from old receipt, had better be also on the new inbox, since I could only accept or reject it with a balance agreement, which I&#39;m comparing the inbox to now.</span>
<a name="l01578"></a>01578 <span class="comment">     -- #10 had also better be there in the new inbox for the same reason: if I had accepted this transfer receipt, then my last balance receipt would reflect that.</span>
<a name="l01579"></a>01579 <span class="comment">     -- THEREFORE: ALL items from old receipt must be found inside new inbox!</span>
<a name="l01580"></a>01580 <span class="comment">     </span>
<a name="l01581"></a>01581 <span class="comment">     Next, loop through the new version of the inbox:</span>
<a name="l01582"></a>01582 <span class="comment">     -- #78, though found in the new inbox, wouldn&#39;t necessarily be expected to be found in the last receipt, since someone may have cashed my cheque since the receipt was made.</span>
<a name="l01583"></a>01583 <span class="comment">     -- #82, though found in the new inbox, wouldn&#39;t necessarily be expected to be found in the last receipt, since someone may have sent me the transfer since receipt was made.</span>
<a name="l01584"></a>01584 <span class="comment">     -- #10 in new inbox, same thing: Someone may have recently accepted my transfer, and thus #10 only would have popped in since the last agreement. (It was there before, but I couldn&#39;t EXPECT that in every case.)</span>
<a name="l01585"></a>01585 <span class="comment">     -- #96 and #97 represent balance CHANGES totalling -11 clams. They must correspond to a change in balance.</span>
<a name="l01586"></a>01586 <span class="comment">     -- #96 is a cheque receipt.. it has changed the balance and I must account for that. But #78 is ALSO a cheque receipt, so why am I not accounting for ITs total (instead just assuming it&#39;s accounted for already in the prior balance, like 78?) Because it&#39;s NEW and wasn&#39;t on the old receipt like 78 is!</span>
<a name="l01587"></a>01587 <span class="comment">     -- Due to the reasoning explained on the above line, ANY chequeReceipt, paymentReceipt, marketReceipt, or basketReceipt </span>
<a name="l01588"></a>01588 <span class="comment">        found on the new version of the inbox but NOT on the old one from the receipt, must be accounted for against the balance.</span>
<a name="l01589"></a>01589 <span class="comment">     -- #99 is an incoming transfer, but it will not change the balance until that transfer is accepted with a new balance agreement sometime in the future.</span>
<a name="l01590"></a>01590 <span class="comment">     */</span>
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01593"></a>01593     {
<a name="l01594"></a>01594         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Error: This is an abbreviated receipt. (Load the box receipt first.)\n&quot;</span>);
<a name="l01595"></a>01595         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597     <span class="comment">// ------------------------------------</span>
<a name="l01598"></a>01598     
<a name="l01599"></a>01599     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(THE_NYM), SERVER_USER_ID(SERVER_NYM);
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(<a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>()), strReceiptID(USER_ID);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603 <span class="comment">//  if (USER_ID != GetUserID())</span>
<a name="l01604"></a>01604 <span class="comment">//  {</span>
<a name="l01605"></a>01605 <span class="comment">//      OTLog::Error(&quot;*** OTIdentifier USER_ID(OTPseudonym THE_NYM) doesn&#39;t match OTTransactionType::GetUserID() in OTTransaction::VerifyBalanceReceipt\n&quot;);</span>
<a name="l01606"></a>01606 <span class="comment">//      return false;</span>
<a name="l01607"></a>01607 <span class="comment">//  }</span>
<a name="l01608"></a>01608     
<a name="l01609"></a>01609     <span class="comment">// -----------------------------------</span>
<a name="l01610"></a>01610     
<a name="l01611"></a>01611     <span class="comment">// Load the last TRANSACTION STATEMENT as well...</span>
<a name="l01612"></a>01612     
<a name="l01613"></a>01613     <a class="code" href="class_o_t_string.html">OTString</a> strFilename; strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01614"></a>01614     
<a name="l01615"></a>01615     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder1name  = <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();   <span class="comment">// receipts</span>
<a name="l01616"></a>01616     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFolder2name  = strServerID.Get();        <span class="comment">// receipts/SERVER_ID</span>
<a name="l01617"></a>01617     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();        <span class="comment">// receipts/SERVER_ID/USER_ID.success</span>
<a name="l01618"></a>01618     
<a name="l01619"></a>01619     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(szFolder1name, szFolder2name, szFilename))
<a name="l01620"></a>01620     {
<a name="l01621"></a>01621         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Receipt file doesn&#39;t exist in OTTransaction::VerifyBalanceReceipt:\n %s\n&quot;</span>, szFilename);
<a name="l01622"></a>01622         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624     
<a name="l01625"></a>01625     <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l01626"></a>01626     <span class="comment">//</span>
<a name="l01627"></a>01627     std::string strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(szFolder1name, szFolder2name, szFilename)); <span class="comment">// &lt;=== LOADING FROM DATA STORE.</span>
<a name="l01628"></a>01628     
<a name="l01629"></a>01629     <span class="keywordflow">if</span> (strFileContents.length() &lt; 2)
<a name="l01630"></a>01630     {
<a name="l01631"></a>01631         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Error reading transaction statement:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01632"></a>01632                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01633"></a>01633         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01634"></a>01634     }
<a name="l01635"></a>01635     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     
<a name="l01638"></a>01638     <a class="code" href="class_o_t_string.html">OTString</a> strTransaction(strFileContents.c_str());
<a name="l01639"></a>01639     
<a name="l01640"></a>01640 <span class="comment">//    OTTransaction tranOut(SERVER_USER_ID, USER_ID, GetRealServerID());</span>
<a name="l01641"></a>01641     <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pContents = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strTransaction);
<a name="l01642"></a>01642     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theAngel(pContents);
<a name="l01643"></a>01643     
<a name="l01644"></a>01644     <span class="keywordflow">if</span> (NULL == pContents)
<a name="l01645"></a>01645     {
<a name="l01646"></a>01646         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Unable to load transaction statement:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01647"></a>01647                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01648"></a>01648         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01649"></a>01649     }               
<a name="l01650"></a>01650     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pContents-&gt;VerifySignature(SERVER_NYM))
<a name="l01651"></a>01651     {
<a name="l01652"></a>01652         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Unable to verify signature on transaction statement:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01653"></a>01653                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01654"></a>01654         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01655"></a>01655     }               
<a name="l01656"></a>01656     
<a name="l01657"></a>01657     <span class="comment">// At this point, pContents is successfully loaded and verified, containing the last transaction receipt.</span>
<a name="l01658"></a>01658     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pContents);
<a name="l01659"></a>01659     
<a name="l01660"></a>01660     <span class="keywordflow">if</span> (NULL == pTrans)
<a name="l01661"></a>01661     {
<a name="l01662"></a>01662         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Was expecting an OTTransaction to be stored in the transaction statement at:\n %s%s%s%s%s\n&quot;</span>, 
<a name="l01663"></a>01663                       szFolder1name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFolder2name, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l01664"></a>01664         <span class="keywordflow">return</span> <span class="keyword">false</span>;        
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666         
<a name="l01667"></a>01667     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; tranOut = *pTrans;
<a name="l01668"></a>01668 
<a name="l01669"></a>01669     <span class="comment">// I ONLY need this transaction statement if it&#39;s newer than the balance statement.</span>
<a name="l01670"></a>01670     <span class="comment">// Otherwise, I don&#39;t use it at all.  But if it&#39;s newer, then I use it instead of the current </span>
<a name="l01671"></a>01671     <span class="comment">// balance statement (only for verifying the list of issued numbers, not for anything else.)</span>
<a name="l01672"></a>01672     
<a name="l01673"></a>01673     <span class="comment">// And in the case where that happens, I ONLY expect to see new numbers added, NOT removed.</span>
<a name="l01674"></a>01674     <span class="comment">// But again, ONLY if the transaction statement is MORE RECENT. Otherwise it may have extra</span>
<a name="l01675"></a>01675     <span class="comment">// numbers alright: ones that were already removed and I don&#39;t want to re-sign responsibility for!</span>
<a name="l01676"></a>01676     
<a name="l01677"></a>01677     
<a name="l01678"></a>01678     <span class="comment">// CHECK IF IT&#39;S NEWER AND SET A POINTER BASED ON THIS.</span>
<a name="l01679"></a>01679     
<a name="l01680"></a>01680     <a class="code" href="class_o_t_transaction.html">OTTransaction</a>   * pTranWithIssuedList = <span class="keyword">this</span>; <span class="comment">// the transaction that actually has the issued list we&#39;ll be using. (Might be balance receipt or transaction receipt, whichever is newer)</span>
<a name="l01681"></a>01681     <a class="code" href="class_o_t_item.html">OTItem</a>          * pItemWithIssuedList = NULL; <span class="comment">// the item from that transaction that actually has the issued list we&#39;ll be using.</span>
<a name="l01682"></a>01682     
<a name="l01683"></a>01683     <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseTransactionItem   = NULL; <span class="comment">// only if it&#39;s new than balance receipt does this get set, to: tranOut.GetItem(OTItem::atTransactionStatement);</span>
<a name="l01684"></a>01684     <a class="code" href="class_o_t_item.html">OTItem</a> * pTransactionItem           = NULL;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686     
<a name="l01687"></a>01687     <span class="keywordflow">if</span> (tranOut.<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>() &gt; this-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>()) <span class="comment">// it&#39;s newer.</span>
<a name="l01688"></a>01688     {
<a name="l01689"></a>01689         pTranWithIssuedList = &amp;tranOut;
<a name="l01690"></a>01690         
<a name="l01691"></a>01691         <span class="comment">// GET THE &quot;AT TRANSACTION STATEMENT&quot; ITEM</span>
<a name="l01692"></a>01692         pResponseTransactionItem = tranOut.<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
<a name="l01693"></a>01693         
<a name="l01694"></a>01694         <span class="keywordflow">if</span> (NULL == pResponseTransactionItem)
<a name="l01695"></a>01695         {
<a name="l01696"></a>01696             <span class="comment">// error, return.</span>
<a name="l01697"></a>01697             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No atTransactionStatement item found on receipt (strange.)\n&quot;</span>);
<a name="l01698"></a>01698             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01699"></a>01699         }
<a name="l01700"></a>01700         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pResponseTransactionItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01701"></a>01701         {
<a name="l01702"></a>01702             <span class="comment">// error, return.</span>
<a name="l01703"></a>01703             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: atTransactionStatement found on receipt, but not a successful one.\n&quot;</span>);
<a name="l01704"></a>01704             <span class="keywordflow">return</span> <span class="keyword">false</span>;       
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pResponseTransactionItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(SERVER_NYM))
<a name="l01707"></a>01707         {       
<a name="l01708"></a>01708             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on atTransactionStatement item in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01709"></a>01709             <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01710"></a>01710         }
<a name="l01711"></a>01711         
<a name="l01712"></a>01712         <span class="comment">// ------------------------------------</span>
<a name="l01713"></a>01713         
<a name="l01714"></a>01714         <span class="comment">// LOAD &quot;TRANSACTION STATEMENT&quot; (ITEM) from within the above item we got.</span>
<a name="l01715"></a>01715         
<a name="l01716"></a>01716         <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;
<a name="l01717"></a>01717         pResponseTransactionItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strBalanceItem);
<a name="l01718"></a>01718         
<a name="l01719"></a>01719         <span class="keywordflow">if</span> (!strBalanceItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01720"></a>01720         {
<a name="l01721"></a>01721             <span class="comment">// error, return.</span>
<a name="l01722"></a>01722             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No transactionStatement item found as &#39;in ref to&#39; string on a receipt containing atTransactionStatement item.\n&quot;</span>);
<a name="l01723"></a>01723             <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01724"></a>01724         }
<a name="l01725"></a>01725         
<a name="l01726"></a>01726         pTransactionItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strBalanceItem, <a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>(), pResponseTransactionItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01727"></a>01727         
<a name="l01728"></a>01728         <span class="keywordflow">if</span> (NULL == pTransactionItem)
<a name="l01729"></a>01729         {
<a name="l01730"></a>01730             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load transactionStatement item from string (from a receipt containing an atTransactionStatement item.)\n&quot;</span>);
<a name="l01731"></a>01731             <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01732"></a>01732         }
<a name="l01733"></a>01733         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTransactionItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>)
<a name="l01734"></a>01734         {
<a name="l01735"></a>01735             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Wrong type on pTransactionItem (expected OTItem::transactionStatement)\n&quot;</span>);
<a name="l01736"></a>01736             <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01737"></a>01737         }
<a name="l01738"></a>01738         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pTransactionItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(THE_NYM))
<a name="l01739"></a>01739         {
<a name="l01740"></a>01740             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on transactionStatement item in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01741"></a>01741             <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01742"></a>01742         }
<a name="l01743"></a>01743         
<a name="l01744"></a>01744         pItemWithIssuedList = pTransactionItem;
<a name="l01745"></a>01745     }
<a name="l01746"></a>01746     
<a name="l01747"></a>01747     <span class="comment">// Now use pTranWithIssuedList and pItemWithIssuedList for checking issued numbers.</span>
<a name="l01748"></a>01748     <span class="comment">// (Even though I&#39;ll continue to use *this for all other data being verified.)</span>
<a name="l01749"></a>01749         
<a name="l01750"></a>01750     <span class="comment">// -------------------------------------------------------</span>
<a name="l01751"></a>01751     
<a name="l01752"></a>01752     <span class="comment">// LOAD THE ACCOUNT </span>
<a name="l01753"></a>01753     
<a name="l01754"></a>01754     
<a name="l01755"></a>01755     <a class="code" href="class_o_t_account.html">OTAccount</a> THE_ACCOUNT(USER_ID, <a class="code" href="class_o_t_transaction_type.html#ac9b118b7db7ea538d6931dee6c2f34e2">GetRealAccountID</a>(), <a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>());
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     <span class="keywordflow">if</span> (!THE_ACCOUNT.<a class="code" href="class_o_t_account.html#a4b7e2c2774e3c70d1646f0121bc2ff3c">LoadContract</a>() || !THE_ACCOUNT.<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(THE_NYM))
<a name="l01758"></a>01758     {
<a name="l01759"></a>01759         <span class="comment">// error, return.</span>
<a name="l01760"></a>01760         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading or verifying account for THE_NYM in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01761"></a>01761         <span class="keywordflow">return</span> <span class="keyword">false</span>;       
<a name="l01762"></a>01762     }
<a name="l01763"></a>01763     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (THE_ACCOUNT.<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>()) <span class="comment">// the account, inbox, and outbox all have the same Server ID. But does it match *this receipt?</span>
<a name="l01764"></a>01764     {
<a name="l01765"></a>01765         <span class="comment">// error, return.</span>
<a name="l01766"></a>01766         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Account, inbox or outbox server ID fails to match receipt server ID.\n&quot;</span>);
<a name="l01767"></a>01767         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01768"></a>01768     }
<a name="l01769"></a>01769     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (THE_ACCOUNT.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>() != <a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()) <span class="comment">// Same as above except for account ID instead of server ID.</span>
<a name="l01770"></a>01770     {
<a name="l01771"></a>01771         <span class="comment">// error, return.</span>
<a name="l01772"></a>01772         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Account ID fails to match receipt account ID.\n&quot;</span>);
<a name="l01773"></a>01773         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01774"></a>01774     }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="comment">// -----------------------------------------------------</span>
<a name="l01777"></a>01777     
<a name="l01778"></a>01778     <span class="comment">// LOAD INBOX AND OUTBOX</span>
<a name="l01779"></a>01779     
<a name="l01780"></a>01780     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = THE_ACCOUNT.<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(THE_NYM); <span class="comment">// OTAccount::Load also calls VerifyAccount() already</span>
<a name="l01781"></a>01781     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = THE_ACCOUNT.<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(THE_NYM);  <span class="comment">// OTAccount::Load also calls VerifyAccount() already</span>
<a name="l01782"></a>01782     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l01783"></a>01783     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l01784"></a>01784     
<a name="l01785"></a>01785     <span class="keywordflow">if</span> ((NULL == pInbox) || (NULL == pOutbox))
<a name="l01786"></a>01786     {
<a name="l01787"></a>01787         <span class="comment">// error, return.</span>
<a name="l01788"></a>01788         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Inbox or outbox was NULL after THE_ACCOUNT.Load in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01789"></a>01789         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01790"></a>01790     }
<a name="l01791"></a>01791     
<a name="l01792"></a>01792     <span class="comment">// ------------------------------------</span>
<a name="l01793"></a>01793     
<a name="l01794"></a>01794     <span class="comment">// LOAD &quot;AT BALANCE STATEMENT&quot; (ITEM)</span>
<a name="l01795"></a>01795     
<a name="l01796"></a>01796     <a class="code" href="class_o_t_item.html">OTItem</a> * pResponseBalanceItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
<a name="l01797"></a>01797     
<a name="l01798"></a>01798     <span class="keywordflow">if</span> (NULL == pResponseBalanceItem)
<a name="l01799"></a>01799     {
<a name="l01800"></a>01800         <span class="comment">// error, return.</span>
<a name="l01801"></a>01801         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No atBalanceStatement item found on receipt (strange.)\n&quot;</span>);
<a name="l01802"></a>01802         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01805"></a>01805     {
<a name="l01806"></a>01806         <span class="comment">// error, return.</span>
<a name="l01807"></a>01807         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: atBalanceStatement found on receipt, but not a successful one.\n&quot;</span>);
<a name="l01808"></a>01808         <span class="keywordflow">return</span> <span class="keyword">false</span>;       
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pResponseBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(SERVER_NYM))
<a name="l01811"></a>01811     {       
<a name="l01812"></a>01812         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on atBalanceStatement item in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01813"></a>01813         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01814"></a>01814     }
<a name="l01815"></a>01815     
<a name="l01816"></a>01816     <span class="comment">// ------------------------------------</span>
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     <span class="comment">// LOAD &quot;BALANCE STATEMENT&quot; (ITEM)</span>
<a name="l01819"></a>01819 
<a name="l01820"></a>01820     <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = NULL;
<a name="l01821"></a>01821     
<a name="l01822"></a>01822     <a class="code" href="class_o_t_string.html">OTString</a> strBalanceItem;
<a name="l01823"></a>01823     pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strBalanceItem);
<a name="l01824"></a>01824         
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (!strBalanceItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01826"></a>01826     {
<a name="l01827"></a>01827         <span class="comment">// error, return.</span>
<a name="l01828"></a>01828         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No balanceStatement item found as &#39;in ref to&#39; string on a receipt containing atBalanceStatement item.\n&quot;</span>);
<a name="l01829"></a>01829         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01830"></a>01830     }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     pBalanceItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strBalanceItem, <a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>(), pResponseBalanceItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01833"></a>01833             
<a name="l01834"></a>01834     <span class="keywordflow">if</span> (NULL == pBalanceItem)
<a name="l01835"></a>01835     {
<a name="l01836"></a>01836         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load balanceStatement item from string (from a receipt containing an atBalanceStatement item.)\n&quot;</span>);
<a name="l01837"></a>01837         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01838"></a>01838     }
<a name="l01839"></a>01839     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>)
<a name="l01840"></a>01840     {
<a name="l01841"></a>01841         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Wrong type on pBalanceItem (expected OTItem::balanceStatement)\n&quot;</span>);
<a name="l01842"></a>01842         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01843"></a>01843     }
<a name="l01844"></a>01844     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pBalanceItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(THE_NYM))
<a name="l01845"></a>01845     {
<a name="l01846"></a>01846         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify signature on balanceStatement item in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01847"></a>01847         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849     
<a name="l01850"></a>01850 
<a name="l01851"></a>01851     <span class="comment">// ---------------------------------------------------------</span>
<a name="l01852"></a>01852 
<a name="l01853"></a>01853     <span class="comment">// LOAD MESSAGE NYM (THE LIST OF ISSUED NUMBERS ACCORDING TO THE RECEIPT.)</span>
<a name="l01854"></a>01854     
<a name="l01855"></a>01855     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theMessageNym;
<a name="l01856"></a>01856     <a class="code" href="class_o_t_string.html">OTString</a>    strMessageNym; <span class="comment">// Okay now we have the transaction numbers in this MessageNym string.</span>
<a name="l01857"></a>01857     
<a name="l01858"></a>01858     <span class="comment">//</span>
<a name="l01859"></a>01859     <span class="keywordflow">if</span> ((NULL != pTransactionItem) &amp;&amp; (tranOut.<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>() &gt; this-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>())) <span class="comment">// transaction statement is newer than (this) balance statement.</span>
<a name="l01860"></a>01860         pItemWithIssuedList = pTransactionItem; <span class="comment">// already set above, but I&#39;m re-stating here for clarity, since the else is now possible...</span>
<a name="l01861"></a>01861     <span class="keywordflow">else</span> 
<a name="l01862"></a>01862         pItemWithIssuedList = pBalanceItem; <span class="comment">// Hereafter we can use pItemWithIssuedList to verify issued transaction numbers (and NOTHING ELSE.)</span>
<a name="l01863"></a>01863 
<a name="l01864"></a>01864     <span class="comment">// ------------</span>
<a name="l01865"></a>01865     
<a name="l01866"></a>01866     pItemWithIssuedList-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strMessageNym);  <span class="comment">// Like right here, for example.</span>
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="keywordflow">if</span> (!strMessageNym.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !theMessageNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strMessageNym))
<a name="l01869"></a>01869     {
<a name="l01870"></a>01870         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load message nym in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01871"></a>01871         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01872"></a>01872     }
<a name="l01873"></a>01873             
<a name="l01874"></a>01874     <span class="comment">// ------------------------------------</span>
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="comment">// Finally everything is loaded and verified!</span>
<a name="l01877"></a>01877     <span class="comment">// I have the Nym and Server Nym</span>
<a name="l01878"></a>01878     <span class="comment">// I have the account, inbox, and outbox</span>
<a name="l01879"></a>01879     <span class="comment">// I have the original balance statement, AND the server&#39;s reply to it (a successful one)</span>
<a name="l01880"></a>01880     <span class="comment">// </span>
<a name="l01881"></a>01881     <span class="comment">// Repeating a note from above:</span>
<a name="l01882"></a>01882     <span class="comment">// -- Verify nym transactions match. (The issued / signed-for ones.)</span>
<a name="l01883"></a>01883     <span class="comment">// -- Verify outbox matches.</span>
<a name="l01884"></a>01884     <span class="comment">// -- Loop through all items on receipt. If outbox item, should match exactly.</span>
<a name="l01885"></a>01885     <span class="comment">// -- But for inbox items, total up: the amount of the total of the items from the receipt,</span>
<a name="l01886"></a>01886     <span class="comment">//    for all those that would actually change the balance (chequeReceipt, marketReceipt, paymentReceipt.)</span>
<a name="l01887"></a>01887     <span class="comment">//    These should ALL be found in the current version of the inbox. (They can only be removed by balance agreement which would update THIS RECEIPT to remove them...)</span>
<a name="l01888"></a>01888     <span class="comment">// -- That was the receipt. Now loop through the latest inbox items and do the reverse: for each item in the NEW inbox, </span>
<a name="l01889"></a>01889     <span class="comment">//    add up the total of those that would change the balance, for receipts found on the new but not the old, and account for that exactly as a difference in balance.</span>
<a name="l01890"></a>01890     <span class="comment">//    Also make sure each receipt in the inbox (new or old) is an issued transaction number, signed out to THE_NYM.</span>
<a name="l01891"></a>01891     
<a name="l01892"></a>01892         
<a name="l01893"></a>01893     <span class="comment">// VERIFY THE LIST OF ISSUED (SIGNED FOR) TRANSACTION NUMBERS ON THE NYM AGAINST THE RECEIPT.</span>
<a name="l01894"></a>01894     <span class="comment">// The Nym should match whatever is on the newest receipt (determined just above.)</span>
<a name="l01895"></a>01895     <span class="comment">//</span>
<a name="l01896"></a>01896     <span class="comment">// NOTE: I used to VerifyIssuedNumbersOnNym -- but that won&#39;t work. Why? Because let&#39;s say I signed a balance agreement with #s 9, 10, and 11.</span>
<a name="l01897"></a>01897     <span class="comment">// That&#39;s my last receipt. Now let&#39;s say, using a DIFFERENT ASSET ACCOUNT, I do a withdrawal, burning #9. Now my balance agreement says 10, 11 for</span>
<a name="l01898"></a>01898     <span class="comment">// that other account, which correctly matches the server.  Now when the FIRST ACCOUNT verifies his (formerly valid) receipt, 9 is missing from his nym,</span>
<a name="l01899"></a>01899     <span class="comment">// which doesn&#39;t match the receipt!  Of course that&#39;s because there&#39;s a newer balance receipt -- BUT ON A DIFFERENT ASSET ACCOUNT.</span>
<a name="l01900"></a>01900     <span class="comment">//</span>
<a name="l01901"></a>01901     <span class="comment">// VerifyTransactionStatement (vs VerifyBalanceStatement, where we are now) gets around this whole problem with VerifyTransactionStatementNumbersOnNym,</span>
<a name="l01902"></a>01902     <span class="comment">// which only verifies that every issued number found on THE_NYM (client-side) is definitely also found in the receipt (theMessageNym). It does NOT do the reverse.</span>
<a name="l01903"></a>01903     <span class="comment">// In other words, it does NOT make sure that every Trans# on theMessageNym (last receipt) is also found on THE_NYM (current client-side nym.)  Numbers may </span>
<a name="l01904"></a>01904     <span class="comment">// have been cleared since that receipt was signed, due to a balance agreement FROM A DIFFERENT ASSET ACCOUNT. This is okay since numbers have not been ADDED </span>
<a name="l01905"></a>01905     <span class="comment">// to your list of responsibility (which is the danger.) In order to ADD a number to your list, a transaction statement would have to be signed, since new</span>
<a name="l01906"></a>01906     <span class="comment">// transaction numbers can only be received through the Nymbox. Since this function (VerifyBalanceReceipt) uses the transactionStatement for verifying issued</span>
<a name="l01907"></a>01907     <span class="comment">// numbers in cases where it is newer than the balanceStatement, then if a new number was added, it will be on the receipt already.</span>
<a name="l01908"></a>01908     <span class="comment">//</span>
<a name="l01909"></a>01909 <span class="comment">//  if (!THE_NYM.VerifyIssuedNumbersOnNym(theMessageNym)) // Explained above. Balance Statements from other accts might be newer, and have burned #s already. Thus I</span>
<a name="l01910"></a>01910     <span class="keywordflow">if</span> (!THE_NYM.<a class="code" href="class_o_t_pseudonym.html#a52932b9c7bbb25ca21e1bf83d067e138">VerifyTransactionStatementNumbersOnNym</a>(theMessageNym)) <span class="comment">// Can&#39;t expect a # on the receipt to still be available, though I MUST verify that every number on current Nym IS on the receipt (just not the other way around.)</span>
<a name="l01911"></a>01911     {
<a name="l01912"></a>01912         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to verify issued numbers on last signed receipt with numbers on THE_NYM in OTTransaction::VerifyBalanceReceipt.\n&quot;</span>);
<a name="l01913"></a>01913         <span class="keywordflow">return</span> <span class="keyword">false</span>;               
<a name="l01914"></a>01914     }
<a name="l01915"></a>01915     
<a name="l01916"></a>01916     <span class="comment">// -------------------------------------------------------</span>
<a name="l01917"></a>01917     
<a name="l01918"></a>01918     <span class="comment">// LOOP THROUGH THE BALANCE STATEMENT ITEMS (INBOX AND OUTBOX) TO GATHER SOME DATA...</span>
<a name="l01919"></a>01919     
<a name="l01920"></a>01920     int32_t nInboxItemCount = 0, nOutboxItemCount = 0;
<a name="l01921"></a>01921     
<a name="l01922"></a>01922     
<a name="l01923"></a>01923 <span class="comment">//  OTLog::vError(&quot;BEFORE LOOP nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l01924"></a>01924     
<a name="l01925"></a>01925     <span class="keyword">const</span> <span class="keywordtype">char</span> * szInbox        = <span class="stringliteral">&quot;Inbox&quot;</span>;
<a name="l01926"></a>01926     <span class="keyword">const</span> <span class="keywordtype">char</span> * szOutbox       = <span class="stringliteral">&quot;Outbox&quot;</span>;
<a name="l01927"></a>01927     <span class="keyword">const</span> <span class="keywordtype">char</span> * pszLedgerType  = NULL;
<a name="l01928"></a>01928     int64_t lReceiptBalanceChange  = 0; <span class="comment">// For measuring the amount of the total of items in the inbox that have changed the balance (like cheque receipts)</span>
<a name="l01929"></a>01929     
<a name="l01930"></a>01930     <span class="comment">// Notice here, I&#39;m back to using pBalanceItem instead of pItemWithIssuedList, since this is the inbox/outbox section...</span>
<a name="l01931"></a>01931     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Number of inbox/outbox items on the balance statement: %d\n&quot;</span>, pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a67cec1836d8607311227b2526b0ec4f5">GetItemCount</a>());
<a name="l01932"></a>01932     
<a name="l01933"></a>01933     
<a name="l01934"></a>01934     <span class="comment">// TODO:  Note: If the balance item shows a FINAL RECEIPT present, then ALL the co-related cron receipts in</span>
<a name="l01935"></a>01935     <span class="comment">// the ACTUAL INBOX must ALSO be present on the balance item, just as the final receipt is present. IT cannot</span>
<a name="l01936"></a>01936     <span class="comment">// be there unless THEY are also there!  (The WHOLE PURPOSE of the final receipt is to MAKE SURE that all its</span>
<a name="l01937"></a>01937     <span class="comment">// related paymentReceipts/marketReceipts have been CLOSED OUT.)</span>
<a name="l01938"></a>01938     <span class="comment">//</span>
<a name="l01939"></a>01939     
<a name="l01940"></a>01940     <span class="keywordflow">for</span> (int32_t i=0; i &lt; pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a67cec1836d8607311227b2526b0ec4f5">GetItemCount</a>(); i++)
<a name="l01941"></a>01941     {
<a name="l01942"></a>01942         <span class="comment">// for outbox calculations. (It&#39;s the only case where GetReceiptAmount() is wrong and needs -1 multiplication.)</span>
<a name="l01943"></a>01943         int64_t lReceiptAmountMultiplier = 1; 
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         <a class="code" href="class_o_t_item.html">OTItem</a> * pSubItem = pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a3db78fb28bf4d93b477a382b900a45ca">GetItem</a>(i);
<a name="l01946"></a>01946         
<a name="l01947"></a>01947         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSubItem);
<a name="l01948"></a>01948         
<a name="l01949"></a>01949         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger  = NULL;
<a name="l01950"></a>01950                 
<a name="l01951"></a>01951         <span class="keywordflow">switch</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l01952"></a>01952         {
<a name="l01953"></a>01953             <span class="comment">// ------------------------------------------------------</span>
<a name="l01954"></a>01954             <span class="comment">// These types of receipts can actually change your balance.</span>
<a name="l01955"></a>01955             <span class="comment">//</span>
<a name="l01956"></a>01956             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6924070960c3d7889da9beaaa8484010">OTItem::chequeReceipt</a>: 
<a name="l01957"></a>01957             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>: 
<a name="l01958"></a>01958             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>:
<a name="l01959"></a>01959             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>:
<a name="l01960"></a>01960                 
<a name="l01961"></a>01961                 lReceiptBalanceChange += pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l01962"></a>01962                 
<a name="l01963"></a>01963 <span class="comment">//              OTLog::vError(&quot;RECEIPT: lReceiptBalanceChange: %lld  pSubItem-&gt;GetAmount()  %lld\n&quot;, </span>
<a name="l01964"></a>01964 <span class="comment">//                    lReceiptBalanceChange, pSubItem-&gt;GetAmount());</span>
<a name="l01965"></a>01965 
<a name="l01966"></a>01966                 <span class="comment">// DROPS THROUGH HERE...</span>
<a name="l01967"></a>01967             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6ccb74fdd8d6de9bdd3d4b20db8850be">OTItem::transferReceipt</a>:  <span class="comment">// These types of receipts do NOT change your balance.</span>
<a name="l01968"></a>01968             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a7d253a3cc42a3ac9f0c1a8e0e047610b">OTItem::voucherReceipt</a>:
<a name="l01969"></a>01969             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afb82e1e580788a5f6fa8450d81a74f0b">OTItem::finalReceipt</a>:
<a name="l01970"></a>01970                 
<a name="l01971"></a>01971                 nInboxItemCount++;
<a name="l01972"></a>01972 <span class="comment">//              OTLog::vError(&quot;RECEIPT: nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l01973"></a>01973                 pLedger = pInbox;
<a name="l01974"></a>01974                 pszLedgerType = szInbox;
<a name="l01975"></a>01975                 
<a name="l01976"></a>01976                 <span class="comment">// DROPS THROUGH HERE...</span>
<a name="l01977"></a>01977             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>:
<a name="l01978"></a>01978                 
<a name="l01979"></a>01979                 <span class="keywordflow">break</span>; <span class="comment">// we&#39;ll handle this in the next switch.</span>
<a name="l01980"></a>01980             <span class="comment">// ------------------------------------------------------</span>
<a name="l01981"></a>01981                 
<a name="l01982"></a>01982             <span class="keywordflow">default</span>:
<a name="l01983"></a>01983             {
<a name="l01984"></a>01984                 <a class="code" href="class_o_t_string.html">OTString</a> strItemType;
<a name="l01985"></a>01985                 pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strItemType);
<a name="l01986"></a>01986                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: Ignoring %s item &quot;</span>
<a name="l01987"></a>01987                                <span class="stringliteral">&quot;in balance statement while verifying it against inbox.\n&quot;</span>, strItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01988"></a>01988             }               
<a name="l01989"></a>01989                 <span class="keywordflow">continue</span>;
<a name="l01990"></a>01990         }
<a name="l01991"></a>01991         
<a name="l01992"></a>01992         <span class="comment">// -------------------------------------</span>
<a name="l01993"></a>01993         
<a name="l01994"></a>01994         <span class="keywordflow">switch</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l01995"></a>01995         {
<a name="l01996"></a>01996             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>:
<a name="l01997"></a>01997                 
<a name="l01998"></a>01998                 <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>() &lt; 0) <span class="comment">// it&#39;s an outbox item</span>
<a name="l01999"></a>01999                 {
<a name="l02000"></a>02000                     lReceiptAmountMultiplier = -1; <span class="comment">// transfers out always reduce your balance.</span>
<a name="l02001"></a>02001                     nOutboxItemCount++;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003 <span class="comment">//                  OTLog::vError(&quot;GetAmount() negative, OUTBOX ITEM: nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l02004"></a>02004 
<a name="l02005"></a>02005                     pLedger = pOutbox;
<a name="l02006"></a>02006                     pszLedgerType = szOutbox;
<a name="l02007"></a>02007                 }
<a name="l02008"></a>02008                 <span class="keywordflow">else</span>
<a name="l02009"></a>02009                 {
<a name="l02010"></a>02010                     lReceiptAmountMultiplier = 1; <span class="comment">// transfers in always increase your balance.</span>
<a name="l02011"></a>02011                     nInboxItemCount++;
<a name="l02012"></a>02012                     pLedger = pInbox;
<a name="l02013"></a>02013                     pszLedgerType = szInbox;
<a name="l02014"></a>02014 
<a name="l02015"></a>02015 <span class="comment">//                  OTLog::vError(&quot;GetAmount() POSITIVE, INBOX ITEM: nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l02016"></a>02016 
<a name="l02017"></a>02017                 }
<a name="l02018"></a>02018                 <span class="keywordflow">break</span>;
<a name="l02019"></a>02019                 
<a name="l02020"></a>02020             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afb82e1e580788a5f6fa8450d81a74f0b">OTItem::finalReceipt</a>:     <span class="comment">// will have a 0 receipt amount.</span>
<a name="l02021"></a>02021             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6ccb74fdd8d6de9bdd3d4b20db8850be">OTItem::transferReceipt</a>:  <span class="comment">// will have a 0 receipt amount.</span>
<a name="l02022"></a>02022             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a7d253a3cc42a3ac9f0c1a8e0e047610b">OTItem::voucherReceipt</a>:   <span class="comment">// will have a 0 receipt amount.</span>
<a name="l02023"></a>02023             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6924070960c3d7889da9beaaa8484010">OTItem::chequeReceipt</a>:
<a name="l02024"></a>02024             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>: <span class="comment">// will already be negative or positive based on whichever is appropriate.</span>
<a name="l02025"></a>02025             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>:<span class="comment">// will already be negative or positive based on whichever is appropriate.</span>
<a name="l02026"></a>02026             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>: <span class="comment">// will already be negative or positive based on whichever is appropriate.</span>
<a name="l02027"></a>02027                 lReceiptAmountMultiplier = 1;
<a name="l02028"></a>02028                 <span class="keywordflow">break</span>;
<a name="l02029"></a>02029             <span class="keywordflow">default</span>:
<a name="l02030"></a>02030                 <span class="keywordflow">continue</span>; <span class="comment">// This will never happen, due to the first continue above in the first switch.</span>
<a name="l02031"></a>02031         }
<a name="l02032"></a>02032         
<a name="l02033"></a>02033         <span class="comment">// ------------------------------------------------------------------</span>
<a name="l02034"></a>02034 
<a name="l02035"></a>02035         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = NULL;
<a name="l02036"></a>02036         
<a name="l02037"></a>02037         int64_t lTempTransactionNum = 0; <span class="comment">// Used for the below block.</span>
<a name="l02038"></a>02038         int64_t lTempReferenceToNum = 0; <span class="comment">// Used for the below block.</span>
<a name="l02039"></a>02039         int64_t lTempNumberOfOrigin = 0; <span class="comment">// Used for the below block.</span>
<a name="l02040"></a>02040         
<a name="l02041"></a>02041         <span class="comment">// What&#39;s going on here? In the original balance statement, ONLY IN CASES OF OUTOING TRANSFER, </span>
<a name="l02042"></a>02042         <span class="comment">// the user has put transaction # &quot;1&quot; in his outbox, in anticipation that</span>
<a name="l02043"></a>02043         <span class="comment">// the server, upon success, will actually put a real pending transfer into his outbox, and</span>
<a name="l02044"></a>02044         <span class="comment">// issue a number for it (like &quot;34&quot;).</span>
<a name="l02045"></a>02045         <span class="keywordflow">if</span> ((pOutbox == pLedger) &amp;&amp;     <span class="comment">// Thus it&#39;s understood that whenever the balanceStatement </span>
<a name="l02046"></a>02046                                         <span class="comment">// has a &quot;1&quot; in the outbox, I should find a corresponding &quot;34&quot; (or whatever # the</span>
<a name="l02047"></a>02047             (pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>() == 1) &amp;&amp; <span class="comment">// server chose) as the GetNewOutboxTransNum member on the atBalanceStatement.</span>
<a name="l02048"></a>02048                                                     <span class="comment">// Now here, when verifying the receipt, this allows me to verify the </span>
<a name="l02049"></a>02049             (pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#abe21495ffbdbf2c7f6dc3d0185295d87">GetNewOutboxTransNum</a>() &gt; 0)) <span class="comment">// outbox request &#39;1&#39; against the actual &#39;34&#39; that resulted.</span>
<a name="l02050"></a>02050         {
<a name="l02051"></a>02051             lTempTransactionNum = pResponseBalanceItem-&gt;<a class="code" href="class_o_t_item.html#abe21495ffbdbf2c7f6dc3d0185295d87">GetNewOutboxTransNum</a>();
<a name="l02052"></a>02052             pTransaction        = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(lTempTransactionNum);
<a name="l02053"></a>02053             
<a name="l02054"></a>02054             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;OTTransaction::VerifyBalanceReceipt: (This iteration, I&#39;m handling an item listed as &#39;1&#39; in the outbox.)\n&quot;</span>);
<a name="l02055"></a>02055         }
<a name="l02056"></a>02056         <span class="keywordflow">else</span> <span class="comment">// ---------------------------------------------------------------</span>
<a name="l02057"></a>02057         {   <span class="comment">// THE ABOVE IS THE *UNUSUAL* CASE, WHEREAS THIS IS THE NORMAL CASE:</span>
<a name="l02058"></a>02058             <span class="comment">//</span>
<a name="l02059"></a>02059             <span class="comment">// Make sure that the transaction number of each sub-item is found</span>
<a name="l02060"></a>02060             <span class="comment">// on the appropriate ledger (inbox or outbox).</span>
<a name="l02061"></a>02061 
<a name="l02062"></a>02062             lTempTransactionNum = pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l02063"></a>02063             pTransaction        = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(lTempTransactionNum);
<a name="l02064"></a>02064         }
<a name="l02065"></a>02065         <span class="comment">// *******************************************************************</span>
<a name="l02066"></a>02066         
<a name="l02067"></a>02067         <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l02068"></a>02068         {
<a name="l02069"></a>02069             lTempReferenceToNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>();
<a name="l02070"></a>02070             lTempNumberOfOrigin = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>();
<a name="l02071"></a>02071         }
<a name="l02072"></a>02072         
<a name="l02073"></a>02073         <span class="comment">// ------------------------------------------------------------------</span>
<a name="l02074"></a>02074         <span class="keywordtype">bool</span> bSwitchedBoxes = <span class="keyword">false</span>; <span class="comment">// In the event that an outbox pending transforms into an inbox transferReceipt, I set this true.</span>
<a name="l02075"></a>02075         
<a name="l02076"></a>02076         <span class="comment">// Let&#39;s say I sign a balance receipt showing a 100 clam pending transfer, sitting in my outbox.</span>
<a name="l02077"></a>02077         <span class="comment">// That means someday when I VERIFY that receipt, the 100 clam pending better still be in that</span>
<a name="l02078"></a>02078         <span class="comment">// outbox, or verification will fail. BUT WAIT -- if the receipient accepts the transfer, then it</span>
<a name="l02079"></a>02079         <span class="comment">// will disappear out of my outbox, and show up in my inbox as a transferReceipt. So when I go to</span>
<a name="l02080"></a>02080         <span class="comment">// verify my balance receipt, I have to expect that any outbox item might be missing, but if that is</span>
<a name="l02081"></a>02081         <span class="comment">// the case, there had better be a matching transferReceipt in the inbox. (That wouldn&#39;t disappear</span>
<a name="l02082"></a>02082         <span class="comment">// unless I processed my inbox, and signed a new balance agreement to get rid of it, so I know it</span>
<a name="l02083"></a>02083         <span class="comment">// has to be there in the inbox if the pending wasn&#39;t in the outbox. (If the receipt is any good.)</span>
<a name="l02084"></a>02084         <span class="comment">//</span>
<a name="l02085"></a>02085         <span class="comment">// Therefore the code has to specifically allow for this case, for outbox items...</span>
<a name="l02086"></a>02086         <span class="keywordflow">if</span> ((NULL == pTransaction) &amp;&amp; (pOutbox == pLedger))
<a name="l02087"></a>02087         {
<a name="l02088"></a>02088             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;OTTransaction::%s: Outbox pending found as inbox transferReceipt. (Normal.)\n&quot;</span>,
<a name="l02089"></a>02089                            __FUNCTION__);
<a name="l02090"></a>02090 
<a name="l02091"></a>02091             <span class="comment">// We didn&#39;t find the transaction that was expected to be in the outbox. (A pending.)</span>
<a name="l02092"></a>02092             <span class="comment">// Therefore maybe it is now a transfer receipt in the Inbox. We allow for this case.</span>
<a name="l02093"></a>02093 
<a name="l02094"></a>02094             pTransaction = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a82181e9dd053f165008b02b5827f784d">GetTransferReceipt</a>(pSubItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
<a name="l02095"></a>02095             
<a name="l02096"></a>02096             <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l02097"></a>02097             {
<a name="l02098"></a>02098                 lTempTransactionNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l02099"></a>02099                 lTempNumberOfOrigin = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>();
<a name="l02100"></a>02100                 <span class="comment">// --------------------------------------------------------------</span>
<a name="l02101"></a>02101                 <span class="comment">// re: the code below: lTempReferenceToNum  = pSubItem-&gt;GetReferenceToNum();</span>
<a name="l02102"></a>02102                 <span class="comment">//</span>
<a name="l02103"></a>02103                 <span class="comment">// If it had been in the outbox, the pending receipt would be &quot;in reference to&quot; my original</span>
<a name="l02104"></a>02104                 <span class="comment">// transfer.</span>
<a name="l02105"></a>02105                 <span class="comment">// But if it&#39;s since been processed into a transferReceipt in my inbox, that transferReceipt</span>
<a name="l02106"></a>02106                 <span class="comment">// is now &quot;in reference to&quot; the recipient&#39;s acceptPending, and thus is NOT in reference to</span>
<a name="l02107"></a>02107                 <span class="comment">// my original transfer.</span>
<a name="l02108"></a>02108                 <span class="comment">// Thus, when the ref num is compared (a little farther below) to pSubItem-&gt;RefNum, it&#39;s</span>
<a name="l02109"></a>02109                 <span class="comment">// GUARANTEED to fail. That is why we are using pSubItem-&gt;GetReferenceToNum here instead of</span>
<a name="l02110"></a>02110                 <span class="comment">// pTransaction-&gt;GetReferenceToNum.</span>
<a name="l02111"></a>02111                 <span class="comment">//</span>
<a name="l02112"></a>02112                 <span class="comment">// Now you might ask, &quot;Then why, below, are we comparing lTempReferenceToNum (containing</span>
<a name="l02113"></a>02113                 <span class="comment">// pSubItem-&gt;GetReferenceToNum) to pSubItem-&gt;GetReferenceToNum ?? Aren&#39;t we just comparing</span>
<a name="l02114"></a>02114                 <span class="comment">// it to itself?&quot;</span>
<a name="l02115"></a>02115                 <span class="comment">//</span>
<a name="l02116"></a>02116                 <span class="comment">// The answer is yes, in this specific case, we are. But remember, in most cases, lTempReferenceToNum</span>
<a name="l02117"></a>02117                 <span class="comment">// contains pTransaction-&gt;GetReferenceToNum, and so in most cases we are NOT comparing it</span>
<a name="l02118"></a>02118                 <span class="comment">// to itself. ONLY in this specific case where the receipt has changed from an outbox-based</span>
<a name="l02119"></a>02119                 <span class="comment">// pending to an inbox-based transferReceipt. And so here, lTempReferenceToNum is set to pSubItem&#39;s</span>
<a name="l02120"></a>02120                 <span class="comment">// version, so that it will not fail the below comparison, which would otherwise succeed properly</span>
<a name="l02121"></a>02121                 <span class="comment">// in all other cases.</span>
<a name="l02122"></a>02122                 <span class="comment">//</span>
<a name="l02123"></a>02123                 <span class="comment">// Next you might ask, &quot;But if we are comparing it to itself in this specific case, sure it will</span>
<a name="l02124"></a>02124                 <span class="comment">// pass the comparison, but then what happens to the security, in this specific case?&quot;</span>
<a name="l02125"></a>02125                 <span class="comment">//</span>
<a name="l02126"></a>02126                 <span class="comment">// The answer is, the very next comparison after that is for the NumberOfOrigin, which is unique</span>
<a name="l02127"></a>02127                 <span class="comment">// and which still must match. (Therefore we are still protected.)</span>
<a name="l02128"></a>02128                 <span class="comment">//</span>
<a name="l02129"></a>02129                 lTempReferenceToNum = pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>();
<a name="l02130"></a>02130                 
<a name="l02131"></a>02131                 lReceiptAmountMultiplier = 1;
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                 nInboxItemCount++;
<a name="l02134"></a>02134                 nOutboxItemCount--;
<a name="l02135"></a>02135                 
<a name="l02136"></a>02136 <span class="comment">//              OTLog::vError(&quot;PENDING-&gt;TransferReceipt. nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l02137"></a>02137 
<a name="l02138"></a>02138                 pLedger = pInbox;
<a name="l02139"></a>02139                 pszLedgerType = szInbox;
<a name="l02140"></a>02140                 
<a name="l02141"></a>02141                 bSwitchedBoxes = <span class="keyword">true</span>; <span class="comment">// We need to know this in one place below.</span>
<a name="l02142"></a>02142             }
<a name="l02143"></a>02143                         
<a name="l02144"></a>02144             <span class="comment">/*</span>
<a name="l02145"></a>02145 <span class="comment">             Pending:</span>
<a name="l02146"></a>02146 <span class="comment">             Outbox: 1901, referencing 1884</span>
<a name="l02147"></a>02147 <span class="comment">             Inbox:  1901, referencing 1884</span>
<a name="l02148"></a>02148 <span class="comment">             </span>
<a name="l02149"></a>02149 <span class="comment">             </span>
<a name="l02150"></a>02150 <span class="comment">             transfer receipt:</span>
<a name="l02151"></a>02151 <span class="comment">             Trans 1902, referencing 1884 (That&#39;s just the display, however. Really 1902 refs 781, which refs 1884.)</span>
<a name="l02152"></a>02152 <span class="comment">        </span>
<a name="l02153"></a>02153 <span class="comment">             </span>
<a name="l02154"></a>02154 <span class="comment">             The pending in the outbox REFERENCES the right number.</span>
<a name="l02155"></a>02155 <span class="comment">             </span>
<a name="l02156"></a>02156 <span class="comment">             The transfer receipt includes (ref string) an acceptPending that references the right number.</span>
<a name="l02157"></a>02157 <span class="comment">             </span>
<a name="l02158"></a>02158 <span class="comment">             So for pending in outbox, when failure, get ReferenceNum(), and use that to find item in Inbox using GetTransferReceipt().</span>
<a name="l02159"></a>02159 <span class="comment">             */</span>
<a name="l02160"></a>02160         }
<a name="l02161"></a>02161             
<a name="l02162"></a>02162         <span class="comment">// STILL not found?? </span>
<a name="l02163"></a>02163         <span class="keywordflow">if</span> (NULL == pTransaction)
<a name="l02164"></a>02164         {
<a name="l02165"></a>02165             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Expected %s transaction (%lld) not found. (Amount %lld.)\n&quot;</span>,
<a name="l02166"></a>02166                            __FUNCTION__, pszLedgerType, lTempTransactionNum, pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>());
<a name="l02167"></a>02167             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02168"></a>02168         }
<a name="l02169"></a>02169         <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02170"></a>02170         <span class="comment">// subItem is from the balance statement, and pTransaction is from the inbox/outbox</span>
<a name="l02171"></a>02171         <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() != lTempReferenceToNum)
<a name="l02172"></a>02172         {
<a name="l02173"></a>02173             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) mismatch Reference Num: %lld, expected %lld\n&quot;</span>,
<a name="l02174"></a>02174                            __FUNCTION__, pszLedgerType, lTempTransactionNum,
<a name="l02175"></a>02175                            pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), lTempReferenceToNum);
<a name="l02176"></a>02176             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02177"></a>02177         }
<a name="l02178"></a>02178         <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02179"></a>02179         <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>() != lTempNumberOfOrigin)
<a name="l02180"></a>02180         {
<a name="l02181"></a>02181             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) mismatch Number of Origin: %lld, expected %lld\n&quot;</span>,
<a name="l02182"></a>02182                            __FUNCTION__, pszLedgerType, lTempTransactionNum,
<a name="l02183"></a>02183                            pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(), lTempNumberOfOrigin);
<a name="l02184"></a>02184             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02185"></a>02185         }
<a name="l02186"></a>02186         <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02187"></a>02187         int64_t lTransactionAmount   =  pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l02188"></a>02188         lTransactionAmount      *=  lReceiptAmountMultiplier;
<a name="l02189"></a>02189         
<a name="l02190"></a>02190         <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>() != lTransactionAmount)
<a name="l02191"></a>02191         {
<a name="l02192"></a>02192             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) &quot;</span>
<a name="l02193"></a>02193                            <span class="stringliteral">&quot;amounts don&#39;t match: Report says %lld, but expected %lld. Trans recpt amt: %lld, (pBalanceItem-&gt;GetAmount() == %lld.)\n&quot;</span>,
<a name="l02194"></a>02194                            __FUNCTION__, pszLedgerType, lTempTransactionNum,
<a name="l02195"></a>02195                            pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), lTransactionAmount, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(),
<a name="l02196"></a>02196                            pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>());
<a name="l02197"></a>02197             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02198"></a>02198         }
<a name="l02199"></a>02199         <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02200"></a>02200         <span class="keywordflow">if</span> (
<a name="l02201"></a>02201             (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)   &amp;&amp; 
<a name="l02202"></a>02202                 (
<a name="l02203"></a>02203                  ((bSwitchedBoxes == <span class="keyword">true</span>) &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>))
<a name="l02204"></a>02204                  ||
<a name="l02205"></a>02205                  ((pLedger == pOutbox)  &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>))
<a name="l02206"></a>02206                  ||
<a name="l02207"></a>02207                  ((pLedger == pInbox)   &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>) &amp;&amp; 
<a name="l02208"></a>02208                   (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()  != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>))
<a name="l02209"></a>02209                 )
<a name="l02210"></a>02210            )
<a name="l02211"></a>02211         {
<a name="l02212"></a>02212             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (pending block)\n&quot;</span>,
<a name="l02213"></a>02213                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02214"></a>02214             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02215"></a>02215         }
<a name="l02216"></a>02216         
<a name="l02217"></a>02217         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTItem::chequeReceipt</a>) &amp;&amp;
<a name="l02218"></a>02218             (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>))
<a name="l02219"></a>02219         {
<a name="l02220"></a>02220             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (chequeReceipt block)\n&quot;</span>,
<a name="l02221"></a>02221                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02222"></a>02222             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224         
<a name="l02225"></a>02225         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTItem::voucherReceipt</a>) &amp;&amp;
<a name="l02226"></a>02226             (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>))
<a name="l02227"></a>02227         {
<a name="l02228"></a>02228             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (voucherReceipt block)\n&quot;</span>,
<a name="l02229"></a>02229                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02230"></a>02230             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02231"></a>02231         }
<a name="l02232"></a>02232         
<a name="l02233"></a>02233         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTItem::marketReceipt</a>) &amp;&amp;
<a name="l02234"></a>02234             (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>))
<a name="l02235"></a>02235         {
<a name="l02236"></a>02236             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (marketReceipt block)\n&quot;</span>,
<a name="l02237"></a>02237                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02238"></a>02238             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02239"></a>02239         }
<a name="l02240"></a>02240         
<a name="l02241"></a>02241         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTItem::paymentReceipt</a>) &amp;&amp; 
<a name="l02242"></a>02242             (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>))
<a name="l02243"></a>02243         {
<a name="l02244"></a>02244             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (paymentReceipt block)\n&quot;</span>,
<a name="l02245"></a>02245                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02246"></a>02246             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02247"></a>02247         }
<a name="l02248"></a>02248         
<a name="l02249"></a>02249         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTItem::transferReceipt</a>) &amp;&amp; 
<a name="l02250"></a>02250             (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>))
<a name="l02251"></a>02251         {
<a name="l02252"></a>02252             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type. (transferReceipt block)\n&quot;</span>,
<a name="l02253"></a>02253                            __FUNCTION__, pszLedgerType, lTempTransactionNum);
<a name="l02254"></a>02254             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02255"></a>02255         }
<a name="l02256"></a>02256         
<a name="l02257"></a>02257         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTItem::basketReceipt</a>) &amp;&amp; 
<a name="l02258"></a>02258             <span class="comment">// -------------------------------------------------------</span>
<a name="l02259"></a>02259             ((pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()   != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>) || 
<a name="l02260"></a>02260              (pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
<a name="l02261"></a>02261             )
<a name="l02262"></a>02262         {
<a name="l02263"></a>02263             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type or closing num (%lld). &quot;</span>
<a name="l02264"></a>02264                            <span class="stringliteral">&quot;(basketReceipt block)\n&quot;</span>, __FUNCTION__, pszLedgerType, lTempTransactionNum,
<a name="l02265"></a>02265                            pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>());
<a name="l02266"></a>02266             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02267"></a>02267         }
<a name="l02268"></a>02268         
<a name="l02269"></a>02269         <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTItem::finalReceipt</a>) &amp;&amp; 
<a name="l02270"></a>02270             <span class="comment">// -------------------------------------------------------</span>
<a name="l02271"></a>02271             ((pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()   != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>) || 
<a name="l02272"></a>02272              (pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
<a name="l02273"></a>02273              )
<a name="l02274"></a>02274         {
<a name="l02275"></a>02275             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: %s transaction (%lld) wrong type or closing num (%lld). &quot;</span>
<a name="l02276"></a>02276                            <span class="stringliteral">&quot;(finalReceipt block)\n&quot;</span>, __FUNCTION__, pszLedgerType, lTempTransactionNum,
<a name="l02277"></a>02277                            pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>());
<a name="l02278"></a>02278             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02279"></a>02279         }
<a name="l02280"></a>02280     }
<a name="l02281"></a>02281     
<a name="l02282"></a>02282     <span class="comment">// By this point, I have an accurate count of the inbox items, and outbox items, represented</span>
<a name="l02283"></a>02283     <span class="comment">// by *this receipt.</span>
<a name="l02284"></a>02284     <span class="comment">// I also know that I found each item from the receipt on the new inbox or outbox (as I should have)</span>
<a name="l02285"></a>02285     <span class="comment">// But do I have to verify that the items are all signed for. I&#39;ll do that below since this list</span>
<a name="l02286"></a>02286     <span class="comment">// is a subset of that one (supposedly.)</span>
<a name="l02287"></a>02287     
<a name="l02288"></a>02288     <span class="comment">//-----------------------------------------------------------------</span>
<a name="l02289"></a>02289     
<a name="l02290"></a>02290     
<a name="l02291"></a>02291 <span class="comment">//  OTLog::vError(&quot;BEFORE COUNT MATCH. nInboxItemCount: %d  nOutboxItemCount: %d\n&quot;, nInboxItemCount, nOutboxItemCount);</span>
<a name="l02292"></a>02292     
<a name="l02293"></a>02293     <span class="keywordflow">if</span> (nOutboxItemCount != pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>())
<a name="l02294"></a>02294     {
<a name="l02295"></a>02295         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Outbox mismatch in expected transaction count.\n&quot;</span>
<a name="l02296"></a>02296                        <span class="stringliteral">&quot; --- THE_INBOX count: %d --- THE_OUTBOX count: %d\n&quot;</span>
<a name="l02297"></a>02297                        <span class="stringliteral">&quot;--- nInboxItemCount: %d --- nOutboxItemCount: %d\n\n&quot;</span>, 
<a name="l02298"></a>02298                        __FUNCTION__, pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>(), pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>(),
<a name="l02299"></a>02299                        nInboxItemCount, nOutboxItemCount);
<a name="l02300"></a>02300         
<a name="l02301"></a>02301         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02302"></a>02302     }
<a name="l02303"></a>02303     
<a name="l02304"></a>02304     <span class="comment">// (Notice I don&#39;t check inbox item count here, since that actually CAN change.)</span>
<a name="l02305"></a>02305     
<a name="l02306"></a>02306     <span class="comment">//-----------------------------------------------------------------</span>
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="comment">// LOOP THROUGH LATEST INBOX AND GATHER DATA / VALIDATE AGAINST LAST RECEIPT.</span>
<a name="l02309"></a>02309     
<a name="l02310"></a>02310     int64_t lInboxBalanceChange = 0; <span class="comment">// Change in the account balance we&#39;d expect, based on TOTAL receipts in the inbox.</span>
<a name="l02311"></a>02311     int64_t lInboxSupposedDifference = 0; <span class="comment">// Change in the account balance we&#39;d expect, based on the NEW receipts in the inbox.</span>
<a name="l02312"></a>02312 
<a name="l02313"></a>02313     <span class="keywordflow">for</span> (int32_t i=0; i &lt; pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>(); i++)
<a name="l02314"></a>02314     {
<a name="l02315"></a>02315         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(i);
<a name="l02316"></a>02316         
<a name="l02317"></a>02317         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
<a name="l02318"></a>02318 
<a name="l02319"></a>02319         <span class="comment">// -----------------------------------------------</span>
<a name="l02320"></a>02320 
<a name="l02321"></a>02321         <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l02322"></a>02322         {
<a name="l02323"></a>02323             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>: 
<a name="l02324"></a>02324             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>: 
<a name="l02325"></a>02325             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l02326"></a>02326             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:
<a name="l02327"></a>02327                 
<a name="l02328"></a>02328                 lInboxBalanceChange += pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(); <span class="comment">// Here I total ALL relevant receipts.</span>
<a name="l02329"></a>02329                 
<a name="l02330"></a>02330 <span class="comment">//              OTLog::vError(&quot;ON INBOX:  lInboxBalanceChange: %lld  pTransaction-&gt;GetReceiptAmount(): %lld\n&quot;, // temp remove debugging todo</span>
<a name="l02331"></a>02331 <span class="comment">//                            lInboxBalanceChange, pTransaction-&gt;GetReceiptAmount());</span>
<a name="l02332"></a>02332                 
<a name="l02333"></a>02333             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:       <span class="comment">// finalReceipt has no amount.</span>
<a name="l02334"></a>02334             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:            <span class="comment">// pending has an amount, but it already came out of the account and thus isn&#39;t figured here.</span>
<a name="l02335"></a>02335             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: <span class="comment">// transferReceipt has an amount, but it already came out of account and thus isn&#39;t figured in here.</span>
<a name="l02336"></a>02336             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// voucherReceipt has an amount, but it already came out of account and thus isn&#39;t figured in here.</span>
<a name="l02337"></a>02337                 <span class="keywordflow">break</span>;
<a name="l02338"></a>02338             <span class="keywordflow">default</span>:
<a name="l02339"></a>02339             {
<a name="l02340"></a>02340                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;OTTransaction::%s: Ignoring %s item in inbox while verifying it against balance receipt.\n&quot;</span>,
<a name="l02341"></a>02341                                __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l02342"></a>02342             }               
<a name="l02343"></a>02343                 <span class="keywordflow">continue</span>;
<a name="l02344"></a>02344         }
<a name="l02345"></a>02345         
<a name="l02346"></a>02346         <span class="comment">// -----------------------------------------------</span>
<a name="l02347"></a>02347         <span class="comment">//</span>
<a name="l02348"></a>02348         <span class="comment">// This &quot;for&quot; loop is in the process of iterating the LATEST INBOX...</span>
<a name="l02349"></a>02349         <span class="comment">// ...For each receipt in that inbox, we try and look up a record of the exact same receipt in</span>
<a name="l02350"></a>02350         <span class="comment">// the INBOX REPORT (present in the balance agreement from the LAST SIGNED TRANSACTION RECEIPT.)</span>
<a name="l02351"></a>02351         <span class="comment">//</span>
<a name="l02352"></a>02352         <span class="comment">// It may or may not be found...</span>
<a name="l02353"></a>02353         
<a name="l02354"></a>02354         <a class="code" href="class_o_t_item.html">OTItem</a> * pSubItem = pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#ac4b56f3a97ca6b8fd44738c9beeba4d1">GetItemByTransactionNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02355"></a>02355         
<a name="l02356"></a>02356         <a class="code" href="class_o_t_item.html">OTItem</a> * pFinalReceiptItem = NULL;
<a name="l02357"></a>02357 
<a name="l02358"></a>02358         <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l02359"></a>02359         <span class="comment">//</span>
<a name="l02360"></a>02360         <span class="comment">// The above loop already verified that all items in the receipt&#39;s inbox were found in the new inbox.</span>
<a name="l02361"></a>02361         <span class="comment">//</span>
<a name="l02362"></a>02362         <span class="comment">// But THIS item, though found in the new inbox, WAS NOT FOUND in the OLD inbox (on the receipt.)</span>
<a name="l02363"></a>02363         <span class="comment">// That means it needs to be accounted for against the account balance!</span>
<a name="l02364"></a>02364         <span class="comment">//</span>
<a name="l02365"></a>02365         <span class="keywordflow">if</span> (NULL == pSubItem)
<a name="l02366"></a>02366         {
<a name="l02367"></a>02367             <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l02368"></a>02368             {
<a name="l02369"></a>02369                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>: 
<a name="l02370"></a>02370                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l02371"></a>02371                     <span class="comment">//</span>
<a name="l02372"></a>02372                     <span class="comment">// New thought: if this transaction is from cron (paymentReceipt or marketReceipt), AND THIS BEING A NEW ITEM</span>
<a name="l02373"></a>02373                     <span class="comment">// that IS in the latest inbox (but was NOT there before, in the receipt), THEN the finalReceipt for THIS</span>
<a name="l02374"></a>02374                     <span class="comment">// transaction had BETTER NOT BE in the old inbox from my last receipt!!</span>
<a name="l02375"></a>02375                     <span class="comment">//</span>
<a name="l02376"></a>02376                     <span class="comment">// Logic: Because the whole point of the finalReceipt is to prevent any NEW marketReceipts from popping in,</span>
<a name="l02377"></a>02377                     <span class="comment">// once it is present! It&#39;s like a &quot;red flag&quot; or a &quot;filing date&quot; -- once it is triggered, IT IS THE FINAL RECEIPT.</span>
<a name="l02378"></a>02378                     <span class="comment">// No other receipts can appear that reference the same transaction number!</span>
<a name="l02379"></a>02379                     <span class="comment">//</span>
<a name="l02380"></a>02380                     <span class="comment">// THEREFORE: If the FINAL RECEIPT is ALREADY in my last signed receipt, then WHY IN HELL are NEW marketReceipts or</span>
<a name="l02381"></a>02381                     <span class="comment">// paymentReceipts going into the latest inbox ??</span>
<a name="l02382"></a>02382                     <span class="comment">//</span>
<a name="l02383"></a>02383                     <span class="comment">// That is why I  verify here that, IF THIS IS A CRON TRANSACTION (payment, market), then the finalReceipt</span>
<a name="l02384"></a>02384                     <span class="comment">// should NOT be present in the inbox report from the last receipt!</span>
<a name="l02385"></a>02385                     <span class="comment">//</span>
<a name="l02386"></a>02386                     
<a name="l02387"></a>02387                     pFinalReceiptItem = pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a08f07e59cd535830b158d45730908ad7">GetFinalReceiptItemByReferenceNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l02388"></a>02388 
<a name="l02389"></a>02389                     <span class="comment">// If it was FOUND... (bad)</span>
<a name="l02390"></a>02390                     <span class="comment">//</span>
<a name="l02391"></a>02391                     <span class="keywordflow">if</span> (NULL != pFinalReceiptItem)
<a name="l02392"></a>02392                     {
<a name="l02393"></a>02393                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Malicious server? A new cronReceipt has appeared, &quot;</span>
<a name="l02394"></a>02394                                        <span class="stringliteral">&quot;even though its corresponding \nfinalReceipt was already present in the LAST SIGNED RECEIPT. &quot;</span>
<a name="l02395"></a>02395                                        <span class="stringliteral">&quot;In reference to: %lld\n&quot;</span>, __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l02396"></a>02396                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02397"></a>02397                     }
<a name="l02398"></a>02398                     <span class="comment">// else drop-through, since marketReceipts and paymentReceipts DO affect the balance...</span>
<a name="l02399"></a>02399                     
<a name="l02400"></a>02400                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:  <span class="comment">// Every one of these, we have to add up the total and reconcile against the latest balance.</span>
<a name="l02401"></a>02401                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:
<a name="l02402"></a>02402                     
<a name="l02403"></a>02403                     lInboxSupposedDifference += pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(); <span class="comment">// Here I only total the NEW receipts (not found in old receipt inbox but found in current inbox.)</span>
<a name="l02404"></a>02404                     
<a name="l02405"></a>02405 <span class="comment">//                  OTLog::vError(&quot;NOT ON RECEIPT:  lInboxSupposedDifference: %lld  pTransaction-&gt;GetReceiptAmount(): %lld\n&quot;, // temp remove debugging todo</span>
<a name="l02406"></a>02406 <span class="comment">//                                lInboxSupposedDifference, pTransaction-&gt;GetReceiptAmount());</span>
<a name="l02407"></a>02407                     
<a name="l02408"></a>02408                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:   <span class="comment">// This has no value. 0 amount.</span>
<a name="l02409"></a>02409                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// pending has value, why aren&#39;t we adding it? Because it hasn&#39;t changed the balance yet.</span>
<a name="l02410"></a>02410                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:  <span class="comment">// transferReceipt has an amount, but it already came out of the account and thus isn&#39;t figured in here.</span>
<a name="l02411"></a>02411                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:  <span class="comment">// voucherReceipt has an amount, but it already came out of the account and thus isn&#39;t figured in here.</span>
<a name="l02412"></a>02412                     <span class="keywordflow">break</span>;
<a name="l02413"></a>02413                     
<a name="l02414"></a>02414                 <span class="keywordflow">default</span>:
<a name="l02415"></a>02415                     <span class="keywordflow">break</span>; <span class="comment">// this should never happen due to above switch.</span>
<a name="l02416"></a>02416             }
<a name="l02417"></a>02417         }
<a name="l02418"></a>02418         <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l02419"></a>02419         <span class="comment">//</span>
<a name="l02420"></a>02420         <span class="keywordflow">else</span> <span class="comment">// If the transaction from the inbox WAS found as an item on the old receipt, let&#39;s verify the two against each other...</span>
<a name="l02421"></a>02421         {
<a name="l02422"></a>02422             <span class="comment">// subItem is from the balance statement, and pTransaction is from the inbox</span>
<a name="l02423"></a>02423             <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>())
<a name="l02424"></a>02424             {
<a name="l02425"></a>02425                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) mismatch Reference Num: %lld, expected %lld\n&quot;</span>,
<a name="l02426"></a>02426                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l02427"></a>02427                                pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l02428"></a>02428                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02429"></a>02429             }
<a name="l02430"></a>02430             <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02431"></a>02431             <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>())
<a name="l02432"></a>02432             {
<a name="l02433"></a>02433                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) mismatch Reference Num: %lld, expected %lld\n&quot;</span>,
<a name="l02434"></a>02434                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l02435"></a>02435                                pSubItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>(), pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l02436"></a>02436                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02437"></a>02437             }
<a name="l02438"></a>02438             <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l02439"></a>02439             <span class="comment">// We&#39;re looping through the inbox here, so no multiplier is needed for the amount</span>
<a name="l02440"></a>02440             <span class="comment">// (that was only for outbox items.)</span>
<a name="l02441"></a>02441             <span class="keywordflow">if</span> (pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()   != (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>() ))
<a name="l02442"></a>02442             {
<a name="l02443"></a>02443                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) &quot;</span>
<a name="l02444"></a>02444                                <span class="stringliteral">&quot;amounts don&#39;t match: %lld, expected %lld. (pBalanceItem-&gt;GetAmount() == %lld.)\n&quot;</span>,
<a name="l02445"></a>02445                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l02446"></a>02446                                pSubItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(),
<a name="l02447"></a>02447                                pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>());
<a name="l02448"></a>02448                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02449"></a>02449             }
<a name="l02450"></a>02450             
<a name="l02451"></a>02451             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>) &amp;&amp; 
<a name="l02452"></a>02452                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>))
<a name="l02453"></a>02453             {
<a name="l02454"></a>02454                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. (pending block)\n&quot;</span>,
<a name="l02455"></a>02455                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02456"></a>02456                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02457"></a>02457             }
<a name="l02458"></a>02458             
<a name="l02459"></a>02459             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTItem::chequeReceipt</a>) &amp;&amp;
<a name="l02460"></a>02460                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>))
<a name="l02461"></a>02461             {
<a name="l02462"></a>02462                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. &quot;</span>
<a name="l02463"></a>02463                                <span class="stringliteral">&quot;(chequeReceipt block)\n&quot;</span>,
<a name="l02464"></a>02464                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02465"></a>02465                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02466"></a>02466             }
<a name="l02467"></a>02467             
<a name="l02468"></a>02468             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTItem::voucherReceipt</a>) &amp;&amp;
<a name="l02469"></a>02469                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>))
<a name="l02470"></a>02470             {
<a name="l02471"></a>02471                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. &quot;</span>
<a name="l02472"></a>02472                                <span class="stringliteral">&quot;(voucherReceipt block)\n&quot;</span>,
<a name="l02473"></a>02473                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02474"></a>02474                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02475"></a>02475             }
<a name="l02476"></a>02476             
<a name="l02477"></a>02477             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTItem::marketReceipt</a>) &amp;&amp;
<a name="l02478"></a>02478                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>))
<a name="l02479"></a>02479             {
<a name="l02480"></a>02480                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. &quot;</span>
<a name="l02481"></a>02481                                <span class="stringliteral">&quot;(marketReceipt block)\n&quot;</span>,
<a name="l02482"></a>02482                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02483"></a>02483                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02484"></a>02484             }
<a name="l02485"></a>02485             
<a name="l02486"></a>02486             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTItem::paymentReceipt</a>) &amp;&amp; 
<a name="l02487"></a>02487                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>))
<a name="l02488"></a>02488             {
<a name="l02489"></a>02489                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. &quot;</span>
<a name="l02490"></a>02490                                <span class="stringliteral">&quot;(paymentReceipt block)\n&quot;</span>,
<a name="l02491"></a>02491                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02492"></a>02492                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02493"></a>02493             }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTItem::transferReceipt</a>) &amp;&amp; 
<a name="l02496"></a>02496                 (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()    != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>))
<a name="l02497"></a>02497             {
<a name="l02498"></a>02498                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type. &quot;</span>
<a name="l02499"></a>02499                                <span class="stringliteral">&quot;(transferReceipt block)\n&quot;</span>,
<a name="l02500"></a>02500                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02501"></a>02501                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02502"></a>02502             }
<a name="l02503"></a>02503             
<a name="l02504"></a>02504             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTItem::basketReceipt</a>) &amp;&amp; 
<a name="l02505"></a>02505                 <span class="comment">// ---------------------------------------------------------</span>
<a name="l02506"></a>02506                 ((pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()   != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>) ||
<a name="l02507"></a>02507                  (pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
<a name="l02508"></a>02508                 )
<a name="l02509"></a>02509             {
<a name="l02510"></a>02510                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type, &quot;</span>
<a name="l02511"></a>02511                                <span class="stringliteral">&quot;or mismatched closing num. (basketReceipt block)\n&quot;</span>,
<a name="l02512"></a>02512                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02513"></a>02513                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02514"></a>02514             }
<a name="l02515"></a>02515 
<a name="l02516"></a>02516             <span class="keywordflow">if</span> ((pSubItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()        == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTItem::finalReceipt</a>) &amp;&amp; 
<a name="l02517"></a>02517                 <span class="comment">// ---------------------------------------------------------</span>
<a name="l02518"></a>02518                 ((pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()   != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>) ||
<a name="l02519"></a>02519                  (pSubItem-&gt;<a class="code" href="class_o_t_item.html#ad0c9e5a00545fd6088f2317f65340daa">GetClosingNum</a>() != pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
<a name="l02520"></a>02520                 )
<a name="l02521"></a>02521             {
<a name="l02522"></a>02522                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::%s: Inbox transaction (%lld) wrong type, &quot;</span>
<a name="l02523"></a>02523                                <span class="stringliteral">&quot;or mismatched closing num. (finalReceipt block)\n&quot;</span>,
<a name="l02524"></a>02524                                __FUNCTION__, pSubItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02525"></a>02525                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02526"></a>02526             }
<a name="l02527"></a>02527 
<a name="l02528"></a>02528         } <span class="comment">// else pSubItem WAS found on the old receipt     </span>
<a name="l02529"></a>02529         
<a name="l02530"></a>02530         <span class="comment">// ---------------</span>
<a name="l02531"></a>02531         <span class="comment">// Next I need to find out the transaction number that I ORIGINALLY used, that&#39;s somehow associated with the receipt</span>
<a name="l02532"></a>02532         <span class="comment">// I found in my inbox, by looking up the number from within the receipt...</span>
<a name="l02533"></a>02533         <span class="comment">//</span>
<a name="l02534"></a>02534         <a class="code" href="class_o_t_string.html">OTString</a> strRespTo;
<a name="l02535"></a>02535         int64_t lIssuedNum = 0; <span class="comment">// The number that must STILL be signed out to me, in order for this receipt not be warrant disputing.</span>
<a name="l02536"></a>02536         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pFinalReceiptTransaction = NULL;
<a name="l02537"></a>02537         
<a name="l02538"></a>02538         <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l02539"></a>02539         {
<a name="l02540"></a>02540             <span class="comment">// ----------------------------------------------------------------------</span>
<a name="l02541"></a>02541             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: <span class="comment">// a transfer receipt is in reference to some guy&#39;s acceptPending</span>
<a name="l02542"></a>02542             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l02543"></a>02543             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l02544"></a>02544                 
<a name="l02545"></a>02545                 lIssuedNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>();
<a name="l02546"></a>02546                 <span class="keywordflow">break</span>;
<a name="l02547"></a>02547             <span class="comment">// ----------------------------------------------------------------------</span>
<a name="l02548"></a>02548             <span class="comment">// ANY cron-related receipts should go here...</span>
<a name="l02549"></a>02549             <span class="comment">//</span>
<a name="l02550"></a>02550             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>: 
<a name="l02551"></a>02551             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:     <span class="comment">// a payment receipt #92 is IN REFERENCE TO my payment plan #13, </span>
<a name="l02552"></a>02552                                                     <span class="comment">// which I am still signed out for... UNTIL the final receipt appears.</span>
<a name="l02553"></a>02553                 <span class="comment">// Once a final receipt appears that is &quot;in reference to&quot; the same number as a marketReceipt (or paymentReceipt)</span>
<a name="l02554"></a>02554                 <span class="comment">// then the paymentReceipt #92 is now IN REFERENCE TO my payment plan #13, WHICH IS CLOSED FOR NEW PAYMENTS, BUT</span>
<a name="l02555"></a>02555                 <span class="comment">// THE PAYMENT RECEIPT ITSELF IS STILL VALID UNTIL THE &quot;closing transaction num&quot; ON THAT FINAL RECEIPT IS CLOSED.</span>
<a name="l02556"></a>02556                 <span class="comment">//</span>
<a name="l02557"></a>02557                 <span class="comment">// Therefore I first need to see if the final receipt is PRESENT in the inbox, so I can then determine</span>
<a name="l02558"></a>02558                 <span class="comment">// which number should be expected to be found on my ISSUED list of transaction numbers.</span>
<a name="l02559"></a>02559                 <span class="comment">//</span>
<a name="l02560"></a>02560                 pFinalReceiptTransaction = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#ab4a37c7036b68bf5e4496848bddb1953">GetFinalReceipt</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l02561"></a>02561 
<a name="l02562"></a>02562                 <span class="keywordflow">if</span> (NULL != pFinalReceiptTransaction) <span class="comment">// FINAL RECEIPT WAS FOUND</span>
<a name="l02563"></a>02563                     lIssuedNum = pFinalReceiptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(); <span class="comment">// &lt;===============</span>
<a name="l02564"></a>02564                 <span class="keywordflow">else</span>    <span class="comment">// NOT found...</span>
<a name="l02565"></a>02565                     lIssuedNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(); <span class="comment">// &lt;===============</span>
<a name="l02566"></a>02566                 
<a name="l02567"></a>02567                 <span class="comment">// If marketReceipt #15 is IN REFERENCE TO original market offer #10,</span>
<a name="l02568"></a>02568                 <span class="comment">// then the &quot;ISSUED NUM&quot; that is still open on my &quot;signed out&quot; list is #10.</span>
<a name="l02569"></a>02569                 <span class="comment">//</span>
<a name="l02570"></a>02570                 <span class="comment">// UNLESS!! Unless a final receipt is present in reference to this same number, in which</span>
<a name="l02571"></a>02571                 <span class="comment">// case the CLOSING TRANSACTION NUMBER stored on that final receipt will become my ISSUED NUM</span>
<a name="l02572"></a>02572                 <span class="comment">// for the purposes of this code.  (Because the original number IS closed, but the marketReceipt is</span>
<a name="l02573"></a>02573                 <span class="comment">// also still valid until the FINAL RECEIPT is closed.)</span>
<a name="l02574"></a>02574                 <span class="comment">//               </span>
<a name="l02575"></a>02575                 <span class="keywordflow">break</span>;               
<a name="l02576"></a>02576             <span class="comment">// ----------------------------------------------------------------------</span>
<a name="l02577"></a>02577         
<a name="l02578"></a>02578                 <span class="comment">// basketReceipt always expects the issued num to be its &quot;closing num&quot;. The &quot;reference to&quot; is instead</span>
<a name="l02579"></a>02579                 <span class="comment">// expected to contain the basketExchange ID (Trans# of the original request to exchange, which is already closed.)</span>
<a name="l02580"></a>02580                 <span class="comment">//</span>
<a name="l02581"></a>02581                 <span class="comment">// Final Receipt expects that its &quot;in reference to&quot; is already closed (that&#39;s why the final receipt even exists...)</span>
<a name="l02582"></a>02582                 <span class="comment">// Its own GetClosingNum() now contains the only valid possible transaction number for this receipt (and for any related</span>
<a name="l02583"></a>02583                 <span class="comment">// to it in this same inbox, which share the same &quot;in reference to&quot; number...</span>
<a name="l02584"></a>02584                 
<a name="l02585"></a>02585             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:
<a name="l02586"></a>02586             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:
<a name="l02587"></a>02587                 
<a name="l02588"></a>02588                 lIssuedNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>();
<a name="l02589"></a>02589                 <span class="keywordflow">break</span>;
<a name="l02590"></a>02590                 
<a name="l02591"></a>02591             <span class="comment">// ----------------------------------------------------------------------</span>
<a name="l02592"></a>02592             <span class="keywordflow">default</span>:
<a name="l02593"></a>02593                 <span class="keywordflow">continue</span>; <span class="comment">// Below this point (inside the loop) is ONLY for receipts that somehow represent a transaction number that&#39;s still issued / signed out to me.</span>
<a name="l02594"></a>02594         }
<a name="l02595"></a>02595         <span class="comment">// -----------------------------------------------</span>
<a name="l02596"></a>02596         
<a name="l02597"></a>02597         <span class="comment">// Whether pSubItem is NULL or not, pTransaction DEFINITELY exists either way, in the newest inbox.</span>
<a name="l02598"></a>02598         <span class="comment">// Therefore, let&#39;s verify whether I&#39;m even responsible for that transaction number... (Just because I signed</span>
<a name="l02599"></a>02599         <span class="comment">// the instrument at some point in the past does NOT mean that I&#39;m still responsible for the transaction number</span>
<a name="l02600"></a>02600         <span class="comment">// that&#39;s listed on the instrument. Maybe I already used it up a long time ago...)</span>
<a name="l02601"></a>02601         <span class="comment">//</span>
<a name="l02602"></a>02602         <span class="keywordflow">if</span> (!theMessageNym.<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lIssuedNum))
<a name="l02603"></a>02603         {
<a name="l02604"></a>02604             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Error verifying if transaction num in inbox (%lld) was actually signed out (%lld)\n&quot;</span>,
<a name="l02605"></a>02605                           __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), lIssuedNum);
<a name="l02606"></a>02606             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02607"></a>02607         }
<a name="l02608"></a>02608         
<a name="l02609"></a>02609         <span class="comment">// NOTE: the above check to VerifyIssuedNum... in the case of basketReceipts and finalReceipts, lIssuedNum is the CLOSING num </span>
<a name="l02610"></a>02610         <span class="comment">// (this is already done.)</span>
<a name="l02611"></a>02611         <span class="comment">// With marketReceipts and paymentReceipts, they check for the existence of a FINAL receipt, and if it&#39;s there, they use its CLOSING</span>
<a name="l02612"></a>02612         <span class="comment">// NUM.  Otherwise they use the &quot;in reference to&quot; num.  With final receipts it uses its CLOSING NUM, since the original is </span>
<a name="l02613"></a>02613         <span class="comment">// presumed closed.</span>
<a name="l02614"></a>02614         
<a name="l02615"></a>02615     } <span class="comment">// for</span>
<a name="l02616"></a>02616     
<a name="l02617"></a>02617     <span class="comment">// BY THIS POINT, I have lReceiptBalanceChange with the total change in the receipt, and</span>
<a name="l02618"></a>02618     <span class="comment">// lInboxBalanceChange with the total change in the new inbox. The difference between the two</span>
<a name="l02619"></a>02619     <span class="comment">// is the difference I should expect also in the account balances! That amount should also</span>
<a name="l02620"></a>02620     <span class="comment">// be equal to lInboxSupposedDifference, which is the total of JUST the inbox receipts that</span>
<a name="l02621"></a>02621     <span class="comment">// I DIDN&#39;T find in the old receipt (they were ONLY in the new inbox.)</span>
<a name="l02622"></a>02622     <span class="comment">//</span>
<a name="l02623"></a>02623     <span class="comment">// I have looped through all inbox items, and I know they were either found in the receipt&#39;s inbox record </span>
<a name="l02624"></a>02624     <span class="comment">// (and verified), or their amounts were added to lInboxSupposedDifference as appropriate.</span>
<a name="l02625"></a>02625     <span class="comment">//</span>
<a name="l02626"></a>02626     <span class="comment">// I also verified, for each inbox item, IF IT TAKES MONEY, THEN IT MUST HAVE A TRANSACTION NUMBER</span>
<a name="l02627"></a>02627     <span class="comment">// SIGNED OUT TO ME... Otherwise I could dispute it. The last code above verifies this.</span>
<a name="l02628"></a>02628     <span class="comment">//</span>
<a name="l02629"></a>02629     <span class="comment">// All that&#39;s left is to make sure the balance is right...</span>
<a name="l02630"></a>02630     <span class="comment">//</span>
<a name="l02631"></a>02631     <span class="comment">// --------------------------------------------------</span>
<a name="l02632"></a>02632     
<a name="l02633"></a>02633     <span class="comment">// VERIFY ACCOUNT BALANCE (RECONCILING WITH NEW INBOX RECEIPTS)</span>
<a name="l02634"></a>02634 
<a name="l02635"></a>02635     <span class="comment">// lReceiptBalanceChange    -- The balance of all the inbox items on the receipt (at least, the items that change the balance.)</span>
<a name="l02636"></a>02636     <span class="comment">// lInboxBalanceChange      -- The balance of all the inbox items in the inbox (at least, the items that change the balance.)</span>
<a name="l02637"></a>02637     <span class="comment">// lInboxSupposedDifference -- The balance of all the inbox items in the inbox that were NOT found in the receipt (that change balance.)</span>
<a name="l02638"></a>02638     <span class="comment">// lAbsoluteDifference      -- The absolute difference between the inbox balance and the receipt balance. (Always positive.)</span>
<a name="l02639"></a>02639     <span class="comment">// lAbsoluteDifference      -- The balance of all the inbox items (including new items) minus the old ones that were on the receipt.</span>
<a name="l02640"></a>02640     
<a name="l02641"></a>02641     <span class="comment">// (Helping me to visualize lInboxBalanceChange and lReceiptBalanceChange)</span>
<a name="l02642"></a>02642     <span class="comment">//              ACTUAL          SIMPLE ADD/SUBTRACT     ADD/ABS</span>
<a name="l02643"></a>02643     <span class="comment">// -5 -100  difference == 95    (-5 + -100 == -105)     105</span>
<a name="l02644"></a>02644     <span class="comment">// 5   100  difference == 95    ( 5 +  100 ==  105)     105</span>
<a name="l02645"></a>02645     <span class="comment">// -5  100  difference == 105   (-5 +  100 ==   95)      95</span>
<a name="l02646"></a>02646     <span class="comment">// 5  -100  difference == 105   ( 5 + -100 ==  -95)      95</span>
<a name="l02647"></a>02647     
<a name="l02648"></a>02648     <span class="comment">// -100 -5  difference == 95    (-100 + -5 == -105)     105</span>
<a name="l02649"></a>02649     <span class="comment">// 100  -5  difference == 105   ( 100 + -5 ==   95)      95</span>
<a name="l02650"></a>02650     <span class="comment">// -100  5  difference == 105   (-100 +  5 ==  -95)      95</span>
<a name="l02651"></a>02651     <span class="comment">// 100   5  difference == 95    ( 100 +  5 ==  105)     105</span>
<a name="l02652"></a>02652     
<a name="l02653"></a>02653     <span class="comment">// Above == wrong, Below == right.</span>
<a name="l02654"></a>02654     
<a name="l02655"></a>02655     <span class="comment">//                                                  ***SUBTRACT/ABS***</span>
<a name="l02656"></a>02656     <span class="comment">// -5 -100  difference == 95    (-5 - -100 ==   95)      95 *</span>
<a name="l02657"></a>02657     <span class="comment">// 5   100  difference == 95    ( 5 -  100 ==  -95)      95 *</span>
<a name="l02658"></a>02658     <span class="comment">// -5  100  difference == 105   (-5 -  100 == -105)     105 *</span>
<a name="l02659"></a>02659     <span class="comment">// 5  -100  difference == 105   ( 5 - -100 ==  105)     105 *</span>
<a name="l02660"></a>02660     
<a name="l02661"></a>02661     <span class="comment">// -100 -5  difference == 95    (-100 - -5 ==  -95)      95 *</span>
<a name="l02662"></a>02662     <span class="comment">// 100  -5  difference == 105   ( 100 - -5 ==  105)     105 *</span>
<a name="l02663"></a>02663     <span class="comment">// -100  5  difference == 105   (-100 -  5 == -105)     105 *</span>
<a name="l02664"></a>02664     <span class="comment">// 100   5  difference == 95    ( 100 -  5 ==   95)      95 *</span>
<a name="l02665"></a>02665     
<a name="l02666"></a>02666     <span class="comment">// Based on the above table, the solution is to subtract one value from the other,</span>
<a name="l02667"></a>02667     <span class="comment">// and then take the absolute of that to get the actual difference. Then use an </span>
<a name="l02668"></a>02668     <span class="comment">// &#39;if&#39; statement to see which was larger, and based on that, calculate whether the</span>
<a name="l02669"></a>02669     <span class="comment">// balance is what would be expected.</span>
<a name="l02670"></a>02670     <span class="comment">//</span>
<a name="l02671"></a>02671                                     <span class="comment">// -1099                    // -99 (example of 1000 absolute difference)</span>
<a name="l02672"></a>02672     <span class="keyword">const</span> int64_t lAbsoluteDifference   = abs(lInboxBalanceChange - lReceiptBalanceChange); <span class="comment">// How much money came out? (Or went in, if the chequeReceipt was for an invoice...)</span>
<a name="l02673"></a>02673                                     <span class="comment">// 901                      // -99 (example of 1000 absolute difference)</span>
<a name="l02674"></a>02674     <span class="keyword">const</span> int64_t lNegativeDifference   = (lAbsoluteDifference*(-1));
<a name="l02675"></a>02675     
<a name="l02676"></a>02676     <span class="comment">// The new (current) inbox has a larger overall value than the balance in the old (receipt) inbox. (As shown by subitem.)</span>
<a name="l02677"></a>02677     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNewInboxWasBigger       = ((lInboxBalanceChange &gt; lReceiptBalanceChange) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l02678"></a>02678     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNewInboxWasSmaller      = ((lInboxBalanceChange &lt; lReceiptBalanceChange) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l02679"></a>02679     
<a name="l02680"></a>02680     <span class="comment">// --------------------------------</span>
<a name="l02681"></a>02681     
<a name="l02682"></a>02682     int64_t lActualDifference;
<a name="l02683"></a>02683     
<a name="l02684"></a>02684     <span class="keywordflow">if</span> (bNewInboxWasBigger)
<a name="l02685"></a>02685         lActualDifference = lAbsoluteDifference;
<a name="l02686"></a>02686     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bNewInboxWasSmaller)
<a name="l02687"></a>02687         lActualDifference = lNegativeDifference;
<a name="l02688"></a>02688     <span class="keywordflow">else</span>
<a name="l02689"></a>02689         lActualDifference = 0;
<a name="l02690"></a>02690 
<a name="l02691"></a>02691     <span class="comment">// --------------------------------</span>
<a name="l02692"></a>02692 
<a name="l02693"></a>02693     <span class="comment">/*</span>
<a name="l02694"></a>02694 <span class="comment">     Example for logic:</span>
<a name="l02695"></a>02695 <span class="comment">     </span>
<a name="l02696"></a>02696 <span class="comment">     Old Inbox on Receipt:</span>
<a name="l02697"></a>02697 <span class="comment">     10</span>
<a name="l02698"></a>02698 <span class="comment">     15</span>
<a name="l02699"></a>02699 <span class="comment">     40</span>
<a name="l02700"></a>02700 <span class="comment">     lReceiptBalanceChange: 65</span>
<a name="l02701"></a>02701 <span class="comment">     Old Balance (in addition to these inbox items): 1000 (total 1065)</span>
<a name="l02702"></a>02702 <span class="comment">     </span>
<a name="l02703"></a>02703 <span class="comment">     New Inbox scenario A:</span>
<a name="l02704"></a>02704 <span class="comment">     10</span>
<a name="l02705"></a>02705 <span class="comment">     15</span>
<a name="l02706"></a>02706 <span class="comment">     40</span>
<a name="l02707"></a>02707 <span class="comment">     20     (lInboxSupposedDifference==(20))      20</span>
<a name="l02708"></a>02708 <span class="comment">     lInboxBalanceChange: 85</span>
<a name="l02709"></a>02709 <span class="comment">     </span>
<a name="l02710"></a>02710 <span class="comment">     New Inbox scenario B:</span>
<a name="l02711"></a>02711 <span class="comment">     10</span>
<a name="l02712"></a>02712 <span class="comment">     15</span>
<a name="l02713"></a>02713 <span class="comment">     40</span>
<a name="l02714"></a>02714 <span class="comment">     -20    (lInboxSupposedDifference==(-20))    -20</span>
<a name="l02715"></a>02715 <span class="comment">     lInboxBalanceChange: 45</span>
<a name="l02716"></a>02716 <span class="comment">     </span>
<a name="l02717"></a>02717 <span class="comment">     </span>
<a name="l02718"></a>02718 <span class="comment">     Inbox A: lAbsoluteDifference=abs(85-65)==abs( 20)==20</span>
<a name="l02719"></a>02719 <span class="comment">     Inbox B: lAbsoluteDifference=abs(45-65)==abs(-20)==20</span>
<a name="l02720"></a>02720 <span class="comment">     </span>
<a name="l02721"></a>02721 <span class="comment">     Inbox A: lNegativeDifference == -20</span>
<a name="l02722"></a>02722 <span class="comment">     Inbox B: lNegativeDifference == -20</span>
<a name="l02723"></a>02723 <span class="comment">         </span>
<a name="l02724"></a>02724 <span class="comment">     Inbox A:   bNewInboxWasBigger == TRUE, </span>
<a name="l02725"></a>02725 <span class="comment">                bNewInboxWasSmaller == FALSE</span>
<a name="l02726"></a>02726 <span class="comment"></span>
<a name="l02727"></a>02727 <span class="comment">     Inbox B:   bNewInboxWasBigger == FALSE,    </span>
<a name="l02728"></a>02728 <span class="comment">                bNewInboxWasSmaller == TRUE</span>
<a name="l02729"></a>02729 <span class="comment">     </span>
<a name="l02730"></a>02730 <span class="comment">     // --------------------------</span>
<a name="l02731"></a>02731 <span class="comment">     </span>
<a name="l02732"></a>02732 <span class="comment">     if (</span>
<a name="l02733"></a>02733 <span class="comment">     (bNewInboxWasBigger    &amp;&amp; (lAbsoluteDifference != lInboxSupposedDifference))   ||  // lInboxSupposedDifference should be positive here.</span>
<a name="l02734"></a>02734 <span class="comment">     (bNewInboxWasSmaller   &amp;&amp; (lNegativeDifference != lInboxSupposedDifference))       // lInboxSupposedDifference should be negative here.</span>
<a name="l02735"></a>02735 <span class="comment">     )</span>
<a name="l02736"></a>02736 <span class="comment"></span>
<a name="l02737"></a>02737 <span class="comment">     Inbox A:</span>
<a name="l02738"></a>02738 <span class="comment">     if (</span>
<a name="l02739"></a>02739 <span class="comment">     (TRUE  &amp;&amp; (20  != 20)) ||  // lInboxSupposedDifference should be positive here. ***</span>
<a name="l02740"></a>02740 <span class="comment">     (FALSE &amp;&amp; (-20 != 20))     // lInboxSupposedDifference should be negative here.</span>
<a name="l02741"></a>02741 <span class="comment">     )</span>
<a name="l02742"></a>02742 <span class="comment"></span>
<a name="l02743"></a>02743 <span class="comment">     Inbox B:</span>
<a name="l02744"></a>02744 <span class="comment">     if (</span>
<a name="l02745"></a>02745 <span class="comment">     (FALSE &amp;&amp; (20  != -20))    ||  // lInboxSupposedDifference should be positive here.</span>
<a name="l02746"></a>02746 <span class="comment">     (TRUE  &amp;&amp; (-20 != -20))        // lInboxSupposedDifference should be negative here. ***</span>
<a name="l02747"></a>02747 <span class="comment">     )</span>
<a name="l02748"></a>02748 <span class="comment">     </span>
<a name="l02749"></a>02749 <span class="comment">     ---------------</span>
<a name="l02750"></a>02750 <span class="comment">     if (</span>
<a name="l02751"></a>02751 <span class="comment">     (lActualDifference != lInboxSupposedDifference)</span>
<a name="l02752"></a>02752 <span class="comment">     )</span>
<a name="l02753"></a>02753 <span class="comment">     </span>
<a name="l02754"></a>02754 <span class="comment">     Inbox A (bigger): (lActualDifference is lAbsoluteDifference)</span>
<a name="l02755"></a>02755 <span class="comment">     if ( 20    != 20)</span>
<a name="l02756"></a>02756 <span class="comment"></span>
<a name="l02757"></a>02757 <span class="comment">     Inbox B (smaller): (lActualDifference is lNegativeDifference)</span>
<a name="l02758"></a>02758 <span class="comment">     if (-20    != -20)</span>
<a name="l02759"></a>02759 <span class="comment"></span>
<a name="l02760"></a>02760 <span class="comment">     */</span>
<a name="l02761"></a>02761     
<a name="l02762"></a>02762     <span class="comment">// If the actual difference between the two totals is not equal to the supposed difference from adding up just the new receipts,</span>
<a name="l02763"></a>02763     <span class="comment">// (Which is probably impossible anyway) then return false.</span>
<a name="l02764"></a>02764     <span class="keywordflow">if</span> (lActualDifference   !=  lInboxSupposedDifference)
<a name="l02765"></a>02765     {
<a name="l02766"></a>02766         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: lActualDifference (%lld) is not equal to lInboxSupposedDifference (%lld)\n&quot;</span>
<a name="l02767"></a>02767                       <span class="stringliteral">&quot;FYI, Inbox balance on old receipt: %lld  Inbox balance on current inbox: %lld\n&quot;</span>,
<a name="l02768"></a>02768                       __FUNCTION__, lActualDifference, lInboxSupposedDifference,
<a name="l02769"></a>02769                       lReceiptBalanceChange, lInboxBalanceChange);
<a name="l02770"></a>02770         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02771"></a>02771     }
<a name="l02772"></a>02772     
<a name="l02773"></a>02773     <span class="comment">// ---------------------------------------------</span>
<a name="l02774"></a>02774     <span class="comment">// if, according to the two inboxes, they are different (in terms of how they would impact balance),</span>
<a name="l02775"></a>02775     <span class="comment">// then therefore, they must have impacted my balance. THEREFORE, my old balance MUST be equivalent to</span>
<a name="l02776"></a>02776     <span class="comment">// the current (apparently new) balance, PLUS OR MINUS THE DIFFERENCE, ACCORDING TO THE DIFFERENCE BETWEEN THE INBOXES.</span>
<a name="l02777"></a>02777     <span class="comment">// If the actual difference (according to inbox receipts) + actual account balance (according to newest copy of account)</span>
<a name="l02778"></a>02778     <span class="comment">// is not equal to the last signed balance agreement, then return false.</span>
<a name="l02779"></a>02779     <span class="comment">//</span>
<a name="l02780"></a>02780     <span class="comment">/*</span>
<a name="l02781"></a>02781 <span class="comment">     if (</span>
<a name="l02782"></a>02782 <span class="comment">     (bNewInboxWasBigger    &amp;&amp; (pBalanceItem-&gt;GetAmount()   != (THE_ACCOUNT.GetBalance() + lNegativeDifference)))   ||</span>
<a name="l02783"></a>02783 <span class="comment">     (bNewInboxWasSmaller   &amp;&amp; (pBalanceItem-&gt;GetAmount()   != (THE_ACCOUNT.GetBalance() + lAbsoluteDifference)))</span>
<a name="l02784"></a>02784 <span class="comment">     )</span>
<a name="l02785"></a>02785 <span class="comment"></span>
<a name="l02786"></a>02786 <span class="comment">     Inbox A (bigger):</span>
<a name="l02787"></a>02787 <span class="comment">     if (</span>
<a name="l02788"></a>02788 <span class="comment">     (TRUE  &amp;&amp; (1000    != (1020 + -20)))   ||</span>
<a name="l02789"></a>02789 <span class="comment">     (FALSE &amp;&amp; (1000    != (1020 +  20)))</span>
<a name="l02790"></a>02790 <span class="comment">     )</span>
<a name="l02791"></a>02791 <span class="comment">     ---</span>
<a name="l02792"></a>02792 <span class="comment">     Inbox B (smaller):</span>
<a name="l02793"></a>02793 <span class="comment">     if (</span>
<a name="l02794"></a>02794 <span class="comment">     (FALSE &amp;&amp; (1000    != (980 + -20)))    ||</span>
<a name="l02795"></a>02795 <span class="comment">     (TRUE  &amp;&amp; (1000    != (980 +  20)))</span>
<a name="l02796"></a>02796 <span class="comment">     )</span>
<a name="l02797"></a>02797 <span class="comment">     ---------------------------------------------------------------------</span>
<a name="l02798"></a>02798 <span class="comment">     </span>
<a name="l02799"></a>02799 <span class="comment">     if (pBalanceItem-&gt;GetAmount() != (THE_ACCOUNT.GetBalance() + (lActualDifference*(-1))))</span>
<a name="l02800"></a>02800 <span class="comment">     </span>
<a name="l02801"></a>02801 <span class="comment">     Inbox A (bigger):</span>
<a name="l02802"></a>02802 <span class="comment">     if (1000 != (1020 + -20))</span>
<a name="l02803"></a>02803 <span class="comment"></span>
<a name="l02804"></a>02804 <span class="comment">     Inbox B (smaller):</span>
<a name="l02805"></a>02805 <span class="comment">     if (1000 != (980 + 20))</span>
<a name="l02806"></a>02806 <span class="comment">     */</span>
<a name="l02807"></a>02807     
<a name="l02808"></a>02808     <span class="keywordflow">if</span> (pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>() != (THE_ACCOUNT.<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() + (lActualDifference*(-1))))
<a name="l02809"></a>02809     {
<a name="l02810"></a>02810         <span class="comment">// Let&#39;s say ActualDifference == 10-3 (prev balance minus current balance) == 7.</span>
<a name="l02811"></a>02811         <span class="comment">// If that&#39;s the case, then 7 + THE_ACCT.Balance should equal 10 again from the last balance statement!</span>
<a name="l02812"></a>02812 
<a name="l02813"></a>02813         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: lActualDifference in receipts (%lld) &quot;</span>
<a name="l02814"></a>02814                       <span class="stringliteral">&quot;plus current acct balance (%lld) is NOT equal to last signed balance (%lld)\n&quot;</span>,
<a name="l02815"></a>02815                       __FUNCTION__, lActualDifference, THE_ACCOUNT.<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>(), pBalanceItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>());
<a name="l02816"></a>02816         <span class="keywordflow">return</span> <span class="keyword">false</span>;       
<a name="l02817"></a>02817     }   
<a name="l02818"></a>02818     
<a name="l02819"></a>02819     <span class="comment">// At this point: all good!</span>
<a name="l02820"></a>02820     <span class="comment">// </span>
<a name="l02821"></a>02821     
<a name="l02822"></a>02822     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02823"></a>02823 }
<a name="l02824"></a>02824 
<a name="l02825"></a>02825 
<a name="l02826"></a>02826 <span class="comment">//static</span>
<a name="l02827"></a><a class="code" href="class_o_t_transaction.html#a73b0080083ff18496554155dcdd5c197">02827</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(<span class="keyword">const</span> int64_t        lLedgerType,
<a name="l02828"></a>02828                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  &amp; strUserOrAcctID,
<a name="l02829"></a>02829                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  &amp; strServerID,
<a name="l02830"></a>02830                                             <span class="keyword">const</span> int64_t       &amp; lTransactionNum,
<a name="l02831"></a>02831                                             <span class="keyword">const</span> <span class="keywordtype">char</span> * szCaller,
<a name="l02832"></a>02832                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder1name,
<a name="l02833"></a>02833                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder2name,
<a name="l02834"></a>02834                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder3name,
<a name="l02835"></a>02835                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFilename)
<a name="l02836"></a>02836 {
<a name="l02837"></a>02837     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != szCaller);
<a name="l02838"></a>02838     <span class="comment">// --------------------------------------------------------</span>
<a name="l02839"></a>02839     <span class="keyword">const</span> <span class="keywordtype">char</span> * pszFolder = NULL;  <span class="comment">// &quot;nymbox&quot; (or &quot;inbox&quot; or &quot;outbox&quot;)</span>
<a name="l02840"></a>02840     <span class="keywordflow">switch</span> (lLedgerType) 
<a name="l02841"></a>02841     {
<a name="l02842"></a>02842         <span class="keywordflow">case</span> 0: pszFolder = <a class="code" href="class_o_t_folders.html#ada1729c82d6ebbfa53b16d511d2aded4">OTFolders::Nymbox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();          <span class="keywordflow">break</span>;
<a name="l02843"></a>02843         <span class="keywordflow">case</span> 1: pszFolder = <a class="code" href="class_o_t_folders.html#a6f314709ced53a8c542eb5ef53126b39">OTFolders::Inbox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();           <span class="keywordflow">break</span>;
<a name="l02844"></a>02844         <span class="keywordflow">case</span> 2: pszFolder = <a class="code" href="class_o_t_folders.html#af4ad3cfbb3030044148f03fd8020c41a">OTFolders::Outbox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();          <span class="keywordflow">break</span>;
<a name="l02845"></a>02845 <span class="comment">//      case 3: (message ledger.)</span>
<a name="l02846"></a>02846         <span class="keywordflow">case</span> 4: pszFolder = <a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();    <span class="keywordflow">break</span>;
<a name="l02847"></a>02847         <span class="keywordflow">case</span> 5: pszFolder = <a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();       <span class="keywordflow">break</span>;
<a name="l02848"></a>02848         <span class="keywordflow">case</span> 6: pszFolder = <a class="code" href="class_o_t_folders.html#a1dfba6274248dcc7cb910770635720f6">OTFolders::ExpiredBox</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();      <span class="keywordflow">break</span>;
<a name="l02849"></a>02849         <span class="keywordflow">default</span>:
<a name="l02850"></a>02850             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s %s: Error: unknown box type: %lld. &quot;</span>
<a name="l02851"></a>02851                           <span class="stringliteral">&quot;(This should never happen.)\n&quot;</span>, __FUNCTION__, szCaller, lLedgerType);
<a name="l02852"></a>02852             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02853"></a>02853     }
<a name="l02854"></a>02854     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02855"></a>02855     strFolder1name.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(pszFolder);                          <span class="comment">// &quot;nymbox&quot; (or &quot;inbox&quot; or &quot;outbox&quot;)</span>
<a name="l02856"></a>02856     strFolder2name.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(strServerID);                        <span class="comment">// &quot;SERVER_ID&quot;</span>
<a name="l02857"></a>02857     strFolder3name.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.r&quot;</span>, strUserOrAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());   <span class="comment">// &quot;USER_ID.r&quot;</span>
<a name="l02858"></a>02858     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02859"></a>02859     strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld.rct&quot;</span>, lTransactionNum);            <span class="comment">// &quot;TRANSACTION_ID.rct&quot;</span>
<a name="l02860"></a>02860     <span class="comment">// todo hardcoding of file extension. Need to standardize extensions.</span>
<a name="l02861"></a>02861     
<a name="l02862"></a>02862     <span class="comment">// Finished product:            &quot;nymbox/SERVER_ID/USER_ID.r/TRANSACTION_ID.rct&quot;</span>
<a name="l02863"></a>02863     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02864"></a>02864     <span class="keywordflow">return</span> <span class="keyword">true</span>;    
<a name="l02865"></a>02865 }
<a name="l02866"></a>02866 
<a name="l02867"></a>02867 
<a name="l02868"></a>02868 <span class="comment">// Just used locally here to prevent some code duplication.</span>
<a name="l02869"></a>02869 <span class="comment">//</span>
<a name="l02870"></a>02870 <span class="comment">//static</span>
<a name="l02871"></a><a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">02871</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(<span class="keyword">const</span> int64_t lLedgerType,
<a name="l02872"></a>02872                                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction,
<a name="l02873"></a>02873                                             <span class="keyword">const</span> <span class="keywordtype">char</span> * szCaller,
<a name="l02874"></a>02874                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder1name,
<a name="l02875"></a>02875                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder2name, 
<a name="l02876"></a>02876                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder3name, 
<a name="l02877"></a>02877                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFilename)
<a name="l02878"></a>02878 {
<a name="l02879"></a>02879     <a class="code" href="class_o_t_string.html">OTString</a> strUserOrAcctID;
<a name="l02880"></a>02880     theTransaction.<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strUserOrAcctID);
<a name="l02881"></a>02881     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02882"></a>02882     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theTransaction.<a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>());
<a name="l02883"></a>02883     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02884"></a>02884     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(lLedgerType, strUserOrAcctID, strServerID,
<a name="l02885"></a>02885                                                   theTransaction.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), szCaller,
<a name="l02886"></a>02886                                                   strFolder1name, strFolder2name, strFolder3name,
<a name="l02887"></a>02887                                                   strFilename);
<a name="l02888"></a>02888 }
<a name="l02889"></a>02889 
<a name="l02890"></a>02890 
<a name="l02891"></a>02891 <span class="comment">// Just used locally here to prevent some code duplication.</span>
<a name="l02892"></a>02892 <span class="comment">//</span>
<a name="l02893"></a>02893 <span class="comment">//static</span>
<a name="l02894"></a><a class="code" href="class_o_t_transaction.html#a26ed98e266bb7462e2d5fc8609f3d60d">02894</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(<a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theLedger,
<a name="l02895"></a>02895                                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction,
<a name="l02896"></a>02896                                             <span class="keyword">const</span> <span class="keywordtype">char</span> * szCaller,
<a name="l02897"></a>02897                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder1name,
<a name="l02898"></a>02898                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder2name, 
<a name="l02899"></a>02899                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFolder3name, 
<a name="l02900"></a>02900                                             <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFilename)
<a name="l02901"></a>02901 {
<a name="l02902"></a>02902     int64_t lLedgerType = 0;
<a name="l02903"></a>02903     <span class="comment">// --------------------------------------------------------</span>
<a name="l02904"></a>02904     <span class="keywordflow">switch</span> (theLedger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>()) 
<a name="l02905"></a>02905     {
<a name="l02906"></a>02906         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>:          lLedgerType = 0;    <span class="keywordflow">break</span>;
<a name="l02907"></a>02907         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>:           lLedgerType = 1;    <span class="keywordflow">break</span>;
<a name="l02908"></a>02908         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>:          lLedgerType = 2;    <span class="keywordflow">break</span>;
<a name="l02909"></a>02909 <span class="comment">//      case OTLedger::message:         lLedgerType = 3;    break;</span>
<a name="l02910"></a>02910         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>:    lLedgerType = 4;    <span class="keywordflow">break</span>;
<a name="l02911"></a>02911         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>:       lLedgerType = 5;    <span class="keywordflow">break</span>;
<a name="l02912"></a>02912         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>:      lLedgerType = 6;    <span class="keywordflow">break</span>;
<a name="l02913"></a>02913         <span class="keywordflow">default</span>:
<a name="l02914"></a>02914             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s %s: Error: unknown box type. &quot;</span>
<a name="l02915"></a>02915                           <span class="stringliteral">&quot;(This should never happen.)\n&quot;</span>, __FUNCTION__, szCaller);
<a name="l02916"></a>02916             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02917"></a>02917     }
<a name="l02918"></a>02918     <span class="comment">// --------------------------------------------------------</span>
<a name="l02919"></a>02919     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(lLedgerType, theTransaction, szCaller,
<a name="l02920"></a>02920                                                   strFolder1name, strFolder2name, strFolder3name,
<a name="l02921"></a>02921                                                   strFilename);
<a name="l02922"></a>02922 }
<a name="l02923"></a>02923 
<a name="l02924"></a>02924 
<a name="l02925"></a>02925 <span class="comment">// This doesn&#39;t actually delete the box receipt, per se.</span>
<a name="l02926"></a>02926 <span class="comment">// Instead, it adds the string &quot;MARKED_FOR_DELETION&quot; to the bottom</span>
<a name="l02927"></a>02927 <span class="comment">// of the file, so the sysadmin can delete later, at his leisure.</span>
<a name="l02928"></a>02928 <span class="comment">//</span>
<a name="l02929"></a><a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">02929</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">OTTransaction::DeleteBoxReceipt</a>(<a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theLedger)
<a name="l02930"></a>02930 {
<a name="l02931"></a>02931     <a class="code" href="class_o_t_string.html">OTString</a> strFolder1name, strFolder2name, strFolder3name, strFilename;
<a name="l02932"></a>02932     
<a name="l02933"></a>02933     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(theLedger, *<span class="keyword">this</span>, 
<a name="l02934"></a>02934                                                         <span class="stringliteral">&quot;OTTransaction::DeleteBoxReceipt&quot;</span>,
<a name="l02935"></a>02935                                                         strFolder1name, strFolder2name, strFolder3name,
<a name="l02936"></a>02936                                                         strFilename))
<a name="l02937"></a>02937         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// This already logs -- no need to log twice, here.</span>
<a name="l02938"></a>02938     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l02939"></a>02939     <span class="comment">// See if the box receipt exists before trying to save over it...</span>
<a name="l02940"></a>02940     <span class="comment">//</span>
<a name="l02941"></a>02941     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02942"></a>02942                               strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02943"></a>02943     {
<a name="l02944"></a>02944         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Box receipt already doesn&#39;t exist, thus no need to delete: &quot;</span>
<a name="l02945"></a>02945                        <span class="stringliteral">&quot;At location: %s%s%s%s%s%s%s\n&quot;</span>, __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02946"></a>02946                        <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l02947"></a>02947                        strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02948"></a>02948                        <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02949"></a>02949         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02950"></a>02950     }
<a name="l02951"></a>02951     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02952"></a>02952 
<a name="l02953"></a>02953     <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
<a name="l02954"></a>02954     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp;
<a name="l02955"></a>02955     
<a name="l02956"></a>02956     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02957"></a>02957     {
<a name="l02958"></a>02958         ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(<a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>);
<a name="l02959"></a>02959     
<a name="l02960"></a>02960         <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strFinal, <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02961"></a>02961         {
<a name="l02962"></a>02962             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error deleting (writing over) box receipt (failed writing armored string):\n%s%s%s%s%s%s%s\n&quot;</span>, 
<a name="l02963"></a>02963                           __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02964"></a>02964                           <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l02965"></a>02965                           strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02966"></a>02966             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02967"></a>02967         }
<a name="l02968"></a>02968     }
<a name="l02969"></a>02969     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02970"></a>02970 
<a name="l02971"></a>02971     <span class="comment">// NOTE: I do the armored string FIRST, THEN add the &quot;marked for deletion&quot; </span>
<a name="l02972"></a>02972     <span class="comment">// part as I save it. (This way, it&#39;s still searchable with grep.)</span>
<a name="l02973"></a>02973     
<a name="l02974"></a>02974     <span class="comment">//</span>
<a name="l02975"></a>02975     <span class="comment">// Try to save the deleted box receipt to local storage.</span>
<a name="l02976"></a>02976     <span class="comment">//</span>
<a name="l02977"></a>02977     <a class="code" href="class_o_t_string.html">OTString</a> strOutput;
<a name="l02978"></a>02978     
<a name="l02979"></a>02979     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02980"></a>02980         strOutput.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s\n\n%s\n&quot;</span>, strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <span class="stringliteral">&quot;MARKED_FOR_DELETION&quot;</span>); <span class="comment">// todo hardcoded.</span>
<a name="l02981"></a>02981     <span class="keywordflow">else</span> 
<a name="l02982"></a>02982         strOutput.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s\n\n%s\n&quot;</span>, 
<a name="l02983"></a>02983                          <span class="stringliteral">&quot;(Transaction was already empty -- strange.)&quot;</span>, 
<a name="l02984"></a>02984                          <span class="stringliteral">&quot;MARKED_FOR_DELETION&quot;</span>); <span class="comment">// todo hardcoded.</span>
<a name="l02985"></a>02985     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02986"></a>02986     
<a name="l02987"></a>02987     <span class="keywordtype">bool</span> bDeleted = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l02988"></a>02988                                            strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02989"></a>02989                                            strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02990"></a>02990     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bDeleted)
<a name="l02991"></a>02991         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error deleting (writing over) file: &quot;</span>
<a name="l02992"></a>02992                       <span class="stringliteral">&quot;%s%s%s%s%s%s%s\nContents:\n\n%s\n\n&quot;</span>, 
<a name="l02993"></a>02993                       __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l02994"></a>02994                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02995"></a>02995                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l02996"></a>02996                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02997"></a>02997                       <a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02998"></a>02998     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02999"></a>02999     <span class="keywordflow">return</span> bDeleted;    
<a name="l03000"></a>03000 }
<a name="l03001"></a>03001 
<a name="l03002"></a>03002 
<a name="l03003"></a><a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">03003</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">OTTransaction::SaveBoxReceipt</a>(<span class="keyword">const</span> int64_t lLedgerType)
<a name="l03004"></a>03004 {
<a name="l03005"></a>03005     <span class="comment">// ---------------------------------</span>
<a name="l03006"></a>03006     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l03007"></a>03007     {
<a name="l03008"></a>03008         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to save box receipt %lld: &quot;</span>
<a name="l03009"></a>03009                        <span class="stringliteral">&quot;This transaction is the abbreviated version (box receipt is supposed to &quot;</span>
<a name="l03010"></a>03010                        <span class="stringliteral">&quot;consist of the full version, so we can&#39;t save THIS as the box receipt.)\n&quot;</span>,
<a name="l03011"></a>03011                        __FUNCTION__, <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03012"></a>03012         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03013"></a>03013     }
<a name="l03014"></a>03014     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l03015"></a>03015     <a class="code" href="class_o_t_string.html">OTString</a> strFolder1name, strFolder2name, strFolder3name, strFilename;
<a name="l03016"></a>03016     
<a name="l03017"></a>03017     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(lLedgerType, *<span class="keyword">this</span>, 
<a name="l03018"></a>03018                                                         <span class="stringliteral">&quot;OTTransaction::SaveBoxReceipt&quot;</span>,
<a name="l03019"></a>03019                                                         strFolder1name, strFolder2name, strFolder3name,
<a name="l03020"></a>03020                                                         strFilename))
<a name="l03021"></a>03021         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// This already logs -- no need to log twice, here.</span>
<a name="l03022"></a>03022     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l03023"></a>03023     <span class="comment">// See if the box receipt exists before trying to save over it...</span>
<a name="l03024"></a>03024     <span class="comment">//</span>
<a name="l03025"></a>03025     <span class="keywordflow">if</span> (<a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l03026"></a>03026     {
<a name="l03027"></a>03027         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Warning -- Box receipt already exists! (Overwriting)&quot;</span>
<a name="l03028"></a>03028                        <span class="stringliteral">&quot;At location: %s%s%s%s%s%s%s\n&quot;</span>, __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03029"></a>03029                        strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03030"></a>03030                        strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03031"></a>03031 <span class="comment">//      return false;</span>
<a name="l03032"></a>03032     }
<a name="l03033"></a>03033     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03034"></a>03034     <span class="comment">// Try to save the box receipt to local storage.</span>
<a name="l03035"></a>03035     <span class="comment">//</span>
<a name="l03036"></a>03036     <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
<a name="l03037"></a>03037     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(<a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>);
<a name="l03038"></a>03038     
<a name="l03039"></a>03039     <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strFinal, <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l03040"></a>03040     {
<a name="l03041"></a>03041         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving box receipt (failed writing armored string):\n%s%s%s%s%s%s%s\n&quot;</span>, 
<a name="l03042"></a>03042                       __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03043"></a>03043                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03044"></a>03044                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03045"></a>03045         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03046"></a>03046     }
<a name="l03047"></a>03047     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03048"></a>03048     
<a name="l03049"></a>03049     <span class="keywordtype">bool</span> bSaved = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03050"></a>03050                                          strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03051"></a>03051                                          strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); 
<a name="l03052"></a>03052     
<a name="l03053"></a>03053     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSaved)
<a name="l03054"></a>03054         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error writing file: %s%s%s%s%s%s%s\nContents:\n\n%s\n\n&quot;</span>, 
<a name="l03055"></a>03055                       __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03056"></a>03056                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l03057"></a>03057                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_contract.html#a90c53743214bc0f0025ad63c3ace7bf2">m_strRawFile</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03058"></a>03058     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03059"></a>03059     <span class="keywordflow">return</span> bSaved;  
<a name="l03060"></a>03060 }
<a name="l03061"></a>03061 
<a name="l03062"></a>03062 
<a name="l03063"></a>03063 <span class="comment">// Caller IS responsible to delete.</span>
<a name="l03064"></a>03064 <span class="comment">//static</span>
<a name="l03065"></a><a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">03065</a> <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * <a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">OTTransaction::LoadBoxReceipt</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theAbbrev, <a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theLedger)
<a name="l03066"></a>03066 {   
<a name="l03067"></a>03067     <span class="keyword">const</span> int64_t lLedgerType = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span> (theLedger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>());
<a name="l03068"></a>03068     
<a name="l03069"></a>03069     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">OTTransaction::LoadBoxReceipt</a>(theAbbrev, lLedgerType);
<a name="l03070"></a>03070 }
<a name="l03071"></a>03071 
<a name="l03072"></a>03072 
<a name="l03073"></a>03073 <span class="comment">// Caller IS responsible to delete.</span>
<a name="l03074"></a>03074 <span class="comment">//static</span>
<a name="l03075"></a><a class="code" href="class_o_t_transaction.html#a6e8558a4ea21189062fcc224dd6fe6a9">03075</a> <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * <a class="code" href="class_o_t_transaction.html#ae97bc794fe820f4f2e864c29c42df8eb">OTTransaction::LoadBoxReceipt</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theAbbrev, <span class="keyword">const</span> int64_t lLedgerType)
<a name="l03076"></a>03076 {
<a name="l03077"></a>03077     <span class="comment">// See if the appropriate file exists, and load it up from</span>
<a name="l03078"></a>03078     <span class="comment">// local storage, into a string.</span>
<a name="l03079"></a>03079     <span class="comment">// Then, try to load the transaction from that string and see if successful.</span>
<a name="l03080"></a>03080     <span class="comment">// If it verifies, then return it. Otherwise return NULL.</span>
<a name="l03081"></a>03081     <span class="comment">// --------------------------------------------------------</span>
<a name="l03082"></a>03082     <span class="comment">// Can only load abbreviated transactions (so they&#39;ll become their full form.)</span>
<a name="l03083"></a>03083     <span class="comment">//</span>
<a name="l03084"></a>03084     <span class="keywordflow">if</span> (<span class="keyword">false</span> == theAbbrev.<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l03085"></a>03085     {
<a name="l03086"></a>03086         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to load box receipt %lld: &quot;</span>
<a name="l03087"></a>03087                        <span class="stringliteral">&quot;(Because argument &#39;theAbbrev&#39; wasn&#39;t abbreviated.)\n&quot;</span>, 
<a name="l03088"></a>03088                        __FUNCTION__, theAbbrev.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03089"></a>03089         <span class="keywordflow">return</span> NULL;
<a name="l03090"></a>03090     }
<a name="l03091"></a>03091     <span class="comment">// ****************************************************************</span>
<a name="l03092"></a>03092     <span class="comment">// Next, see if the appropriate file exists, and load it up from</span>
<a name="l03093"></a>03093     <span class="comment">// local storage, into a string.</span>
<a name="l03094"></a>03094     
<a name="l03095"></a>03095     <a class="code" href="class_o_t_string.html">OTString</a> strFolder1name, strFolder2name, strFolder3name, strFilename;
<a name="l03096"></a>03096     
<a name="l03097"></a>03097     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(lLedgerType,
<a name="l03098"></a>03098                                                         theAbbrev,
<a name="l03099"></a>03099                                                         __FUNCTION__, <span class="comment">// &quot;OTTransaction::LoadBoxReceipt&quot;,</span>
<a name="l03100"></a>03100                                                         strFolder1name,
<a name="l03101"></a>03101                                                         strFolder2name, 
<a name="l03102"></a>03102                                                         strFolder3name, 
<a name="l03103"></a>03103                                                         strFilename))
<a name="l03104"></a>03104         <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs -- no need to log twice, here.</span>
<a name="l03105"></a>03105     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l03106"></a>03106     <span class="comment">// See if the box receipt exists before trying to load it...</span>
<a name="l03107"></a>03107     <span class="comment">//</span>
<a name="l03108"></a>03108     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l03109"></a>03109     {
<a name="l03110"></a>03110         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Box receipt does not exist: %s%s%s%s%s%s%s\n&quot;</span>,
<a name="l03111"></a>03111                        __FUNCTION__, 
<a name="l03112"></a>03112                        strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03113"></a>03113                        strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03114"></a>03114                        strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03115"></a>03115         <span class="keywordflow">return</span> NULL;
<a name="l03116"></a>03116     }
<a name="l03117"></a>03117     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03118"></a>03118     <span class="comment">// Try to load the box receipt from local storage.</span>
<a name="l03119"></a>03119     <span class="comment">//</span>
<a name="l03120"></a>03120     std::string strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <span class="comment">// &lt;=== LOADING FROM DATA STORE.</span>
<a name="l03121"></a>03121                                                        strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03122"></a>03122                                                        strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03123"></a>03123                                                        strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())); 
<a name="l03124"></a>03124     <span class="keywordflow">if</span> (strFileContents.length() &lt; 2)
<a name="l03125"></a>03125     {
<a name="l03126"></a>03126         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error reading file: %s%s%s%s%s%s%s\n&quot;</span>, 
<a name="l03127"></a>03127                       __FUNCTION__,
<a name="l03128"></a>03128                       strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03129"></a>03129                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03130"></a>03130                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03131"></a>03131                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03132"></a>03132         <span class="keywordflow">return</span> NULL;
<a name="l03133"></a>03133     }
<a name="l03134"></a>03134     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03135"></a>03135     <a class="code" href="class_o_t_string.html">OTString</a> strRawFile(strFileContents.c_str());
<a name="l03136"></a>03136     
<a name="l03137"></a>03137     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strRawFile.Exists())
<a name="l03138"></a>03138     {
<a name="l03139"></a>03139         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error reading file (resulting output &quot;</span>
<a name="l03140"></a>03140                       <span class="stringliteral">&quot;string is empty): %s%s%s%s%s%s%s\n&quot;</span>,
<a name="l03141"></a>03141                       __FUNCTION__,
<a name="l03142"></a>03142                       strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03143"></a>03143                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03144"></a>03144                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03145"></a>03145                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03146"></a>03146         <span class="keywordflow">return</span> NULL;
<a name="l03147"></a>03147     }
<a name="l03148"></a>03148     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03149"></a>03149     <span class="comment">// Finally, try to load the transaction from that string and see if successful.</span>
<a name="l03150"></a>03150     <span class="comment">//</span>
<a name="l03151"></a>03151     <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strRawFile);
<a name="l03152"></a>03152     
<a name="l03153"></a>03153     <span class="keywordflow">if</span> (NULL == pTransType)
<a name="l03154"></a>03154     {
<a name="l03155"></a>03155         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error instantiating transaction &quot;</span>
<a name="l03156"></a>03156                       <span class="stringliteral">&quot;type based on strRawFile: %s%s%s%s%s%s%s\n&quot;</span>,
<a name="l03157"></a>03157                       __FUNCTION__,
<a name="l03158"></a>03158                       strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03159"></a>03159                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03160"></a>03160                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03161"></a>03161                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03162"></a>03162         <span class="keywordflow">return</span> NULL;
<a name="l03163"></a>03163     }
<a name="l03164"></a>03164     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03165"></a>03165     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxReceipt = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);
<a name="l03166"></a>03166     
<a name="l03167"></a>03167     <span class="keywordflow">if</span> (NULL == pBoxReceipt)
<a name="l03168"></a>03168     {
<a name="l03169"></a>03169         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error dynamic_cast from transaction &quot;</span>
<a name="l03170"></a>03170                       <span class="stringliteral">&quot;type to transaction, based on strRawFile: %s%s%s%s%s%s%s\n&quot;</span>,
<a name="l03171"></a>03171                       __FUNCTION__,
<a name="l03172"></a>03172                       strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03173"></a>03173                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03174"></a>03174                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03175"></a>03175                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03176"></a>03176         <span class="keyword">delete</span> pTransType; pTransType = NULL; <span class="comment">// cleanup!</span>
<a name="l03177"></a>03177         <span class="keywordflow">return</span> NULL;
<a name="l03178"></a>03178     }
<a name="l03179"></a>03179     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03180"></a>03180     <span class="comment">// BELOW THIS POINT, pBoxReceipt exists, and is an OTTransaction pointer, and is loaded,</span>
<a name="l03181"></a>03181     <span class="comment">// and basically is ready to be compared to theAbbrev, which is its abbreviated version.</span>
<a name="l03182"></a>03182     <span class="comment">// It MUST either be returned or deleted.</span>
<a name="l03183"></a>03183     <span class="comment">// ****************************************************************</span>
<a name="l03184"></a>03184     
<a name="l03185"></a>03185     <span class="keywordtype">bool</span> bSuccess = theAbbrev.<a class="code" href="class_o_t_transaction.html#a51fc66087f5a0acdfc4a1054298b23b7">VerifyBoxReceipt</a>(*pBoxReceipt);
<a name="l03186"></a>03186     
<a name="l03187"></a>03187     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccess)
<a name="l03188"></a>03188     {
<a name="l03189"></a>03189         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed verifying Box Receipt:\n%s%s%s%s%s%s%s\n&quot;</span>, 
<a name="l03190"></a>03190                       __FUNCTION__,
<a name="l03191"></a>03191                       strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03192"></a>03192                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03193"></a>03193                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03194"></a>03194                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03195"></a>03195         <span class="comment">// -----------------</span>
<a name="l03196"></a>03196         <span class="keyword">delete</span> pBoxReceipt; pBoxReceipt = NULL;
<a name="l03197"></a>03197         <span class="keywordflow">return</span> NULL;
<a name="l03198"></a>03198     }
<a name="l03199"></a>03199     <span class="keywordflow">else</span> 
<a name="l03200"></a>03200         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Successfully loaded Box Receipt in:\n%s%s%s%s%s%s%s\n&quot;</span>, 
<a name="l03201"></a>03201                        __FUNCTION__,
<a name="l03202"></a>03202                        strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03203"></a>03203                        strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03204"></a>03204                        strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03205"></a>03205                        strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03206"></a>03206     <span class="comment">// -------------------------------------------------</span>
<a name="l03207"></a>03207     <span class="comment">// Todo: security analysis. By this point we&#39;ve verified the hash of the transaction against the stored</span>
<a name="l03208"></a>03208     <span class="comment">// hash inside the abbreviated version. (VerifyBoxReceipt) We&#39;ve also verified a few other values like transaction</span>
<a name="l03209"></a>03209     <span class="comment">// number, and the &quot;in ref to&quot; display number. We&#39;re then assuming based on those, that the adjustment and display</span>
<a name="l03210"></a>03210     <span class="comment">// amount are correct. (The hash is actually a zero knowledge proof of this already.) This is good for speedier</span>
<a name="l03211"></a>03211     <span class="comment">// optimization but may be worth revisiting in case any security holes.</span>
<a name="l03212"></a>03212     <span class="comment">// UPDATE: We&#39;ll save this for optimization needs in the future.</span>
<a name="l03213"></a>03213     <span class="comment">//  pBoxReceipt-&gt;SetAbbrevAdjustment(       theAbbrev.GetAbbrevAdjustment() );    </span>
<a name="l03214"></a>03214     <span class="comment">//  pBoxReceipt-&gt;SetAbbrevDisplayAmount(    theAbbrev.GetAbbrevDisplayAmount() );</span>
<a name="l03215"></a>03215     <span class="comment">// -------------------------------------------------</span>
<a name="l03216"></a>03216     
<a name="l03217"></a>03217     <span class="keywordflow">return</span> pBoxReceipt;
<a name="l03218"></a>03218 }
<a name="l03219"></a>03219 
<a name="l03220"></a>03220 
<a name="l03221"></a>03221 <span class="comment">// This function assumes that theLedger is the owner of this transaction.</span>
<a name="l03222"></a>03222 <span class="comment">// We pass the ledger in so we can determine the proper directory we&#39;re </span>
<a name="l03223"></a>03223 <span class="comment">// reading from.</span>
<a name="l03224"></a><a class="code" href="class_o_t_transaction.html#ad755606f8f828547f3ddbd78fe370b30">03224</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">OTTransaction::SaveBoxReceipt</a>(<a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theLedger)
<a name="l03225"></a>03225 {
<a name="l03226"></a>03226     int64_t lLedgerType = 0;
<a name="l03227"></a>03227     
<a name="l03228"></a>03228     <span class="keywordflow">switch</span> (theLedger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>()) 
<a name="l03229"></a>03229     {
<a name="l03230"></a>03230         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>:          lLedgerType = 0;    <span class="keywordflow">break</span>;
<a name="l03231"></a>03231         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>:           lLedgerType = 1;    <span class="keywordflow">break</span>;
<a name="l03232"></a>03232         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>:          lLedgerType = 2;    <span class="keywordflow">break</span>;
<a name="l03233"></a>03233 <span class="comment">//      case OTLedger::message:         lLedgerType = 3;    break;</span>
<a name="l03234"></a>03234         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>:    lLedgerType = 4;    <span class="keywordflow">break</span>;
<a name="l03235"></a>03235         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>:       lLedgerType = 5;    <span class="keywordflow">break</span>;
<a name="l03236"></a>03236         <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>:      lLedgerType = 6;    <span class="keywordflow">break</span>;
<a name="l03237"></a>03237         <span class="keywordflow">default</span>:
<a name="l03238"></a>03238             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::SaveBoxReceipt: Error: unknown box type. &quot;</span>
<a name="l03239"></a>03239                          <span class="stringliteral">&quot;(This should never happen.)\n&quot;</span>);
<a name="l03240"></a>03240             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03241"></a>03241     }
<a name="l03242"></a>03242     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(lLedgerType);
<a name="l03243"></a>03243 }
<a name="l03244"></a>03244 
<a name="l03245"></a>03245 
<a name="l03246"></a>03246 <span class="comment">//static</span>
<a name="l03247"></a><a class="code" href="class_o_t_transaction.html#acf756f8e3b1d1b9f1e9d2bcb48cbe927">03247</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#acf756f8e3b1d1b9f1e9d2bcb48cbe927">OTTransaction::VerifyBoxReceiptExists</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l03248"></a>03248                                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,    <span class="comment">// Unused here for now, but still convention.</span>
<a name="l03249"></a>03249                                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID, <span class="comment">// If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l03250"></a>03250                                            <span class="keyword">const</span> int32_t            nBoxType,   <span class="comment">// 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l03251"></a>03251                                            <span class="keyword">const</span> int64_t          &amp; lTransactionNum)
<a name="l03252"></a>03252 {
<a name="l03253"></a>03253     <span class="keyword">const</span> int64_t lLedgerType = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span> (nBoxType);
<a name="l03254"></a>03254     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03255"></a>03255     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strUserOrAcctID(0 == lLedgerType ? USER_ID : ACCOUNT_ID); <span class="comment">// (For Nymbox aka type 0, the UserID will be here.)</span>
<a name="l03256"></a>03256     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l03257"></a>03257     <a class="code" href="class_o_t_string.html">OTString</a> strFolder1name, strFolder2name, strFolder3name, strFilename;
<a name="l03258"></a>03258     
<a name="l03259"></a>03259     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction.html#a186d091553baa52c0d1e252b05432e4d">OTTransaction::SetupBoxReceiptFilename</a>(lLedgerType, <span class="comment">// nBoxType is lLedgerType</span>
<a name="l03260"></a>03260                                                         strUserOrAcctID,
<a name="l03261"></a>03261                                                         strServerID,
<a name="l03262"></a>03262                                                         lTransactionNum,
<a name="l03263"></a>03263                                                         <span class="stringliteral">&quot;OTTransaction::VerifyBoxReceiptExists&quot;</span>,
<a name="l03264"></a>03264                                                         strFolder1name, strFolder2name, strFolder3name,
<a name="l03265"></a>03265                                                         strFilename))
<a name="l03266"></a>03266         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// This already logs -- no need to log twice, here.</span>
<a name="l03267"></a>03267     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l03268"></a>03268     <span class="comment">// See if the box receipt exists before trying to save over it...</span>
<a name="l03269"></a>03269     <span class="comment">//</span>
<a name="l03270"></a>03270     <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03271"></a>03271                                       strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03272"></a>03272                                       strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03273"></a>03273                                       strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03274"></a>03274     
<a name="l03275"></a>03275     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTTransaction::%s: %s: %s%s%s%s%s%s%s\n&quot;</span>, bExists ? <span class="stringliteral">&quot;(Already have this one)&quot;</span> : <span class="stringliteral">&quot;(Need to download this one)&quot;</span>,
<a name="l03276"></a>03276                    __FUNCTION__, strFolder1name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l03277"></a>03277                    strFolder2name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03278"></a>03278                    strFolder3name.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), 
<a name="l03279"></a>03279                    strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03280"></a>03280     
<a name="l03281"></a>03281     <span class="keywordflow">return</span> bExists;
<a name="l03282"></a>03282 }
<a name="l03283"></a>03283 
<a name="l03284"></a>03284 
<a name="l03285"></a><a class="code" href="class_o_t_transaction.html#a51fc66087f5a0acdfc4a1054298b23b7">03285</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a51fc66087f5a0acdfc4a1054298b23b7">OTTransaction::VerifyBoxReceipt</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theFullVersion)
<a name="l03286"></a>03286 {
<a name="l03287"></a>03287     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_transaction.html#a1298e2f51b0a9471bc6b1aa8905b70f9">m_bIsAbbreviated</a> || theFullVersion.<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l03288"></a>03288     {
<a name="l03289"></a>03289         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failure: This transaction &quot;</span>
<a name="l03290"></a>03290                       <span class="stringliteral">&quot;isn&#39;t abbreviated (val: %s), or the purported full version erroneously is (val: %s). &quot;</span>
<a name="l03291"></a>03291                       <span class="stringliteral">&quot;Either way, you can&#39;t use it in this way, for trans num: %lld\n&quot;</span>,
<a name="l03292"></a>03292                       __FUNCTION__, <a class="code" href="class_o_t_transaction.html#a1298e2f51b0a9471bc6b1aa8905b70f9">m_bIsAbbreviated</a> ? <span class="stringliteral">&quot;IS&quot;</span> : <span class="stringliteral">&quot;IS NOT&quot;</span>,
<a name="l03293"></a>03293                       theFullVersion.<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>() ? <span class="stringliteral">&quot;IS&quot;</span> : <span class="stringliteral">&quot;IS NOT&quot;</span>,
<a name="l03294"></a>03294                       <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03295"></a>03295         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03296"></a>03296     }
<a name="l03297"></a>03297     <span class="comment">// ---------------------</span>
<a name="l03298"></a>03298     <span class="comment">// VERIFY THE HASH</span>
<a name="l03299"></a>03299     <span class="comment">//</span>
<a name="l03300"></a>03300     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   idFullVersion;   <span class="comment">// Generate a message digest of that string.</span>
<a name="l03301"></a>03301     theFullVersion.<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idFullVersion);
<a name="l03302"></a>03302     
<a name="l03303"></a>03303     <span class="comment">// Abbreviated version (*this) stores a hash of the original full version.</span>
<a name="l03304"></a>03304     <span class="comment">// Sooo... let&#39;s hash the purported &quot;full version&quot; that was passed in, and</span>
<a name="l03305"></a>03305     <span class="comment">// compare it to the stored one.</span>
<a name="l03306"></a>03306     <span class="comment">//</span>
<a name="l03307"></a>03307     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a> != idFullVersion) 
<a name="l03308"></a>03308     {
<a name="l03309"></a>03309         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failure: The purported &#39;full version&#39; of the transaction, &quot;</span>
<a name="l03310"></a>03310                       <span class="stringliteral">&quot;passed in for verification fails to match the stored hash value for trans num: %lld\n&quot;</span>,
<a name="l03311"></a>03311                       __FUNCTION__, <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03312"></a>03312         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03313"></a>03313     }
<a name="l03314"></a>03314     <span class="comment">// ---------------------</span>
<a name="l03315"></a>03315     <span class="comment">// BY THIS POINT, we already know it&#39;s a definite match.</span>
<a name="l03316"></a>03316     <span class="comment">// But we check a few more things, just to be safe.</span>
<a name="l03317"></a>03317     <span class="comment">// Such as the TRANSACTION NUMBER...</span>
<a name="l03318"></a>03318     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>() != theFullVersion.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()) 
<a name="l03319"></a>03319     {
<a name="l03320"></a>03320         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failure: The purported &#39;full version&#39; of the transaction &quot;</span>
<a name="l03321"></a>03321                       <span class="stringliteral">&quot;passed in (number %lld) fails to match the actual transaction number: %lld\n&quot;</span>,
<a name="l03322"></a>03322                       __FUNCTION__, theFullVersion.<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03323"></a>03323         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03324"></a>03324     }
<a name="l03325"></a>03325     <span class="comment">// ---------------------</span>
<a name="l03326"></a>03326     <span class="comment">// THE &quot;IN REFERENCE TO&quot; NUMBER (DISPLAY VERSION)</span>
<a name="l03327"></a>03327     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#a5d52aa9eeff78830b9ba53585e36a2ad">GetAbbrevInRefDisplay</a>() != theFullVersion.<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>())
<a name="l03328"></a>03328     {
<a name="l03329"></a>03329         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failure: The purported &#39;full version&#39; of the transaction &quot;</span>
<a name="l03330"></a>03330                       <span class="stringliteral">&quot;passed, GetReferenceNumForDisplay() (%lld) fails to match the GetAbbrevInRefDisplay (%lld) on this.\n&quot;</span>,
<a name="l03331"></a>03331                       __FUNCTION__, theFullVersion.<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#a5d52aa9eeff78830b9ba53585e36a2ad">GetAbbrevInRefDisplay</a>());
<a name="l03332"></a>03332         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03333"></a>03333     }
<a name="l03334"></a>03334     <span class="comment">// ---------------------</span>
<a name="l03335"></a>03335     
<a name="l03336"></a>03336     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03337"></a>03337 }
<a name="l03338"></a>03338 
<a name="l03339"></a>03339 
<a name="l03340"></a>03340 <span class="comment">// When the items are first loaded up, VerifyContractID() is called on them.</span>
<a name="l03341"></a>03341 <span class="comment">// Therefore, the serverID and account ID have already been verified.</span>
<a name="l03342"></a>03342 <span class="comment">// Now I want to go deeper, before actually processing a transaction, and </span>
<a name="l03343"></a>03343 <span class="comment">// make sure that the items on it also have the right owner, as well as that</span>
<a name="l03344"></a>03344 <span class="comment">// owner&#39;s signature, and a matching transaction number to boot.</span>
<a name="l03345"></a>03345 <span class="comment">//</span>
<a name="l03346"></a><a class="code" href="class_o_t_transaction.html#a196bf845f57deaf4e04493e462fd6d97">03346</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a196bf845f57deaf4e04493e462fd6d97">OTTransaction::VerifyItems</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym)
<a name="l03347"></a>03347 {
<a name="l03348"></a>03348     <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to deposit.</span>
<a name="l03349"></a>03349     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = NULL;
<a name="l03350"></a>03350     
<a name="l03351"></a>03351     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID(theNym);
<a name="l03352"></a>03352     
<a name="l03353"></a>03353     <span class="keywordflow">if</span> (NYM_ID != <a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>())
<a name="l03354"></a>03354     {
<a name="l03355"></a>03355         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong owner passed to OTTransaction::VerifyItems\n&quot;</span>);
<a name="l03356"></a>03356         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03357"></a>03357     }
<a name="l03358"></a>03358 
<a name="l03359"></a>03359     <span class="comment">// I&#39;m not checking signature on transaction itself since that is already</span>
<a name="l03360"></a>03360     <span class="comment">// checked before this function is called. But I AM calling Verify Owner,</span>
<a name="l03361"></a>03361     <span class="comment">// so that when Verify Owner is called in the loop below, it proves the items</span>
<a name="l03362"></a>03362     <span class="comment">// and the transaction both have the same owner: Nym.</span>
<a name="l03363"></a>03363     
<a name="l03364"></a>03364     <span class="comment">// if pointer not null, and it&#39;s a withdrawal, and it&#39;s an acknowledgement (not a rejection or error)</span>
<a name="l03365"></a>03365     <span class="comment">//</span>
<a name="l03366"></a>03366     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
<a name="l03367"></a>03367     {
<a name="l03368"></a>03368         pItem = *it;
<a name="l03369"></a>03369         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03370"></a>03370         
<a name="l03371"></a>03371         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>() != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>())
<a name="l03372"></a>03372             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03373"></a>03373         
<a name="l03374"></a>03374         <span class="keywordflow">if</span> (NYM_ID != pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>())
<a name="l03375"></a>03375             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03376"></a>03376         
<a name="l03377"></a>03377         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(theNym)) <span class="comment">// NO need to call VerifyAccount since VerifyContractID is ALREADY called and now here&#39;s VerifySignature().</span>
<a name="l03378"></a>03378             <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l03379"></a>03379     }   
<a name="l03380"></a>03380     
<a name="l03381"></a>03381     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03382"></a>03382 }
<a name="l03383"></a>03383 
<a name="l03384"></a>03384 
<a name="l03385"></a>03385 <span class="comment">/*</span>
<a name="l03386"></a>03386 <span class="comment">bool                m_bIsAbbreviated;   </span>
<a name="l03387"></a>03387 <span class="comment">int64_t             m_lAbbrevAmount;</span>
<a name="l03388"></a>03388 <span class="comment">int64_t             m_lDisplayAmount;</span>
<a name="l03389"></a>03389 <span class="comment">OTIdentifier        m_Hash;         // todo: make this const and force it to be set during construction.</span>
<a name="l03390"></a>03390 <span class="comment">time64_t                m_DATE_SIGNED;  // The date, in seconds, when the instrument was last signed.   </span>
<a name="l03391"></a>03391 <span class="comment">transactionType     m_Type;         // blank, pending, processInbox, transfer, deposit, withdrawal, trade, etc.</span>
<a name="l03392"></a>03392 <span class="comment">*/</span>
<a name="l03393"></a>03393 
<a name="l03394"></a>03394 <span class="comment">// private and hopefully not needed</span>
<a name="l03395"></a>03395 <span class="comment">//</span>
<a name="l03396"></a><a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">03396</a> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction::OTTransaction</a>() : <a class="code" href="class_o_t_transaction_type.html">ot_super</a>(),
<a name="l03397"></a>03397     m_pParent(NULL),
<a name="l03398"></a>03398     m_bIsAbbreviated(false), m_lAbbrevAmount(0), m_lDisplayAmount(0), m_lInRefDisplay(0),
<a name="l03399"></a>03399     m_DATE_SIGNED(<a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>), m_Type(<a class="code" href="class_o_t_transaction.html">OTTransaction</a>::error_state),
<a name="l03400"></a>03400     m_lClosingTransactionNo(0), m_lRequestNumber(0), 
<a name="l03401"></a>03401     m_bReplyTransSuccess(false),
<a name="l03402"></a>03402     m_bCancelled(false)
<a name="l03403"></a>03403 {
<a name="l03404"></a>03404     <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">InitTransaction</a>();
<a name="l03405"></a>03405 }
<a name="l03406"></a>03406 
<a name="l03407"></a>03407 
<a name="l03408"></a>03408 <span class="comment">// Let&#39;s say you never knew their UserID, you just loaded the inbox based on AccountID.</span>
<a name="l03409"></a>03409 <span class="comment">// Now you want to add a transaction to that inbox. Just pass the inbox into the</span>
<a name="l03410"></a>03410 <span class="comment">// transaction constructor (below) and it will get the rest of the info it needs off of</span>
<a name="l03411"></a>03411 <span class="comment">// the inbox itself (which you presumably just read from a file or socket.)</span>
<a name="l03412"></a>03412 <span class="comment">//</span>
<a name="l03413"></a><a class="code" href="class_o_t_transaction.html#ad003537b610664b2a1bb6ccf9191f9a1">03413</a> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction::OTTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theOwner)
<a name="l03414"></a>03414 : <a class="code" href="class_o_t_transaction_type.html">ot_super</a>(theOwner.GetUserID(), theOwner.GetPurportedAccountID(), theOwner.GetPurportedServerID()),
<a name="l03415"></a>03415 <span class="comment">// --------</span>
<a name="l03416"></a>03416     m_pParent(&amp;theOwner),
<a name="l03417"></a>03417     m_bIsAbbreviated(false), m_lAbbrevAmount(0), m_lDisplayAmount(0), m_lInRefDisplay(0),
<a name="l03418"></a>03418     m_DATE_SIGNED(<a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>), m_Type(<a class="code" href="class_o_t_transaction.html">OTTransaction</a>::error_state),
<a name="l03419"></a>03419     m_lClosingTransactionNo(0), m_lRequestNumber(0), 
<a name="l03420"></a>03420     m_bReplyTransSuccess(false),
<a name="l03421"></a>03421     m_bCancelled(false)
<a name="l03422"></a>03422 {
<a name="l03423"></a>03423     <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">InitTransaction</a>();
<a name="l03424"></a>03424 
<a name="l03425"></a>03425 }
<a name="l03426"></a>03426 
<a name="l03427"></a>03427 
<a name="l03428"></a>03428 <span class="comment">// By calling this function, I&#39;m saying &quot;I know the real account ID and Server ID, and here</span>
<a name="l03429"></a>03429 <span class="comment">// they are, and feel free to compare them with whatever YOU load up, which we&#39;ll leave</span>
<a name="l03430"></a>03430 <span class="comment">// blank for now unless you generate a transaction, or load one up, </span>
<a name="l03431"></a>03431 
<a name="l03432"></a>03432 <span class="comment">// ==&gt; or maybe I might need to add a constructor where another transaction or a ledger is passed in.</span>
<a name="l03433"></a>03433 <span class="comment">//      Then it can grab whatever it needs from those. I&#39;m doing something similar in OTItem</span>
<a name="l03434"></a><a class="code" href="class_o_t_transaction.html#ae41b05f6008dade937e8a355a4a86feb">03434</a> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction::OTTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theUserID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAccountID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID)
<a name="l03435"></a>03435 : <a class="code" href="class_o_t_transaction_type.html">ot_super</a>(theUserID, theAccountID, theServerID),
<a name="l03436"></a>03436 <span class="comment">// --------------------------------------------</span>
<a name="l03437"></a>03437     m_pParent(NULL),
<a name="l03438"></a>03438     m_bIsAbbreviated(false), m_lAbbrevAmount(0), m_lDisplayAmount(0), m_lInRefDisplay(0),
<a name="l03439"></a>03439     m_DATE_SIGNED(<a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>), m_Type(<a class="code" href="class_o_t_transaction.html">OTTransaction</a>::error_state),
<a name="l03440"></a>03440     m_lClosingTransactionNo(0), m_lRequestNumber(0), 
<a name="l03441"></a>03441     m_bReplyTransSuccess(false),
<a name="l03442"></a>03442     m_bCancelled(false)
<a name="l03443"></a>03443 {
<a name="l03444"></a>03444     <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">InitTransaction</a>();
<a name="l03445"></a>03445     
<a name="l03446"></a>03446 <span class="comment">//  m_AcctID    = theID;        // these must be loaded or generated. NOT set in constructor, for security reasons.</span>
<a name="l03447"></a>03447 <span class="comment">//  m_ServerID  = theServerID;  // There are only here in ghostly form as a WARNING to you!</span>
<a name="l03448"></a>03448 }
<a name="l03449"></a>03449 
<a name="l03450"></a>03450 
<a name="l03451"></a><a class="code" href="class_o_t_transaction.html#a722238fe05144806bcf8ec09976a229c">03451</a> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction::OTTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theUserID,
<a name="l03452"></a>03452                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAccountID,
<a name="l03453"></a>03453                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID,
<a name="l03454"></a>03454                              int64_t lTransactionNum)
<a name="l03455"></a>03455 : <a class="code" href="class_o_t_transaction_type.html">ot_super</a>(theUserID, theAccountID, theServerID, lTransactionNum),
<a name="l03456"></a>03456 <span class="comment">// --------------------------------------------</span>
<a name="l03457"></a>03457     m_pParent(NULL),
<a name="l03458"></a>03458     m_bIsAbbreviated(false), m_lAbbrevAmount(0), m_lDisplayAmount(0), m_lInRefDisplay(0),
<a name="l03459"></a>03459     m_DATE_SIGNED(<a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>), m_Type(<a class="code" href="class_o_t_transaction.html">OTTransaction</a>::error_state), m_lClosingTransactionNo(0), m_lRequestNumber(0),
<a name="l03460"></a>03460     m_bReplyTransSuccess(false),
<a name="l03461"></a>03461     m_bCancelled(false)
<a name="l03462"></a>03462 {
<a name="l03463"></a>03463     <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">InitTransaction</a>();
<a name="l03464"></a>03464     
<a name="l03465"></a>03465 <span class="comment">//  m_lTransactionNum = lTransactionNum;    // This is set in OTTransactionType&#39;s constructor, as are m_ID and m_ServerID</span>
<a name="l03466"></a>03466 <span class="comment">//  m_AcctID    = theID;                    // these must be loaded or generated. NOT set in constructor, for security reasons.</span>
<a name="l03467"></a>03467 <span class="comment">//  m_ServerID  = theServerID;              // There are only here in ghostly form as a WARNING to you!</span>
<a name="l03468"></a>03468 }
<a name="l03469"></a>03469 
<a name="l03470"></a>03470 
<a name="l03471"></a>03471 <span class="comment">// all common OTTransaction stuff goes here.</span>
<a name="l03472"></a>03472 <span class="comment">// (I don&#39;t like constructor loops, prefer to use a separate function they all call.)</span>
<a name="l03473"></a><a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">03473</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">OTTransaction::InitTransaction</a>()
<a name="l03474"></a>03474 {
<a name="l03475"></a>03475     <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a>       = <span class="stringliteral">&quot;TRANSACTION&quot;</span>; <span class="comment">// CONTRACT, MESSAGE, TRANSACTION, LEDGER, TRANSACTION ITEM </span>
<a name="l03476"></a>03476     <a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>           = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>; <span class="comment">// Make sure to set this to the current time whenever contract is signed.</span>
<a name="l03477"></a>03477     <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>                  = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>;
<a name="l03478"></a>03478     <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a> = 0;
<a name="l03479"></a>03479     <a class="code" href="class_o_t_transaction.html#a6fc95646e555b9c2ffb1404c6475ef56">m_lRequestNumber</a>        = 0;
<a name="l03480"></a>03480     <a class="code" href="class_o_t_transaction.html#a1631d08ab9b9759c5743fa0bfe9f7bdf">m_bReplyTransSuccess</a>    = <span class="keyword">false</span>;
<a name="l03481"></a>03481 }
<a name="l03482"></a>03482 
<a name="l03483"></a>03483 
<a name="l03484"></a>03484 <span class="comment">// This CONSTRUCTOR is used for instantiating &quot;abbreviated&quot; transactions,</span>
<a name="l03485"></a>03485 <span class="comment">// each of which separately load their full contents from a separate datafile</span>
<a name="l03486"></a>03486 <span class="comment">// not during loading but during the subsequent verification process.</span>
<a name="l03487"></a>03487 <span class="comment">// See: bool OTTransaction::VerifyItems(OTPseudonym &amp; theNym)</span>
<a name="l03488"></a>03488 <span class="comment">//</span>
<a name="l03489"></a><a class="code" href="class_o_t_transaction.html#a58c686431f3ff2bb448640a809160f2b">03489</a> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction::OTTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theUserID, 
<a name="l03490"></a>03490                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAccountID,
<a name="l03491"></a>03491                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID,
<a name="l03492"></a>03492                              <span class="keyword">const</span> int64_t          &amp; lNumberOfOrigin,
<a name="l03493"></a>03493                              <span class="keyword">const</span> int64_t          &amp; lTransactionNum,
<a name="l03494"></a>03494                              <span class="keyword">const</span> int64_t          &amp; lInRefTo,
<a name="l03495"></a>03495                              <span class="keyword">const</span> int64_t          &amp; lInRefDisplay, 
<a name="l03496"></a>03496                              <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     the_DATE_SIGNED, 
<a name="l03497"></a>03497                              <span class="keyword">const</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">transactionType</a> theType,
<a name="l03498"></a>03498                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strHash,
<a name="l03499"></a>03499                              <span class="keyword">const</span> int64_t          &amp; lAdjustment,
<a name="l03500"></a>03500                              <span class="keyword">const</span> int64_t          &amp; lDisplayValue,
<a name="l03501"></a>03501                              <span class="keyword">const</span> int64_t          &amp; lClosingNum,
<a name="l03502"></a>03502                              <span class="keyword">const</span> int64_t         &amp; lRequestNum,
<a name="l03503"></a>03503                              <span class="keyword">const</span> <span class="keywordtype">bool</span>           bReplyTransSuccess,
<a name="l03504"></a>03504                              <a class="code" href="class_o_t_num_list.html">OTNumList</a>          * pNumList<span class="comment">/*=NULL*/</span>)
<a name="l03505"></a>03505 : <a class="code" href="class_o_t_transaction_type.html">ot_super</a>(theUserID, theAccountID, theServerID, lTransactionNum), 
<a name="l03506"></a>03506 <span class="comment">//--------------------------------------------------------------------------</span>
<a name="l03507"></a>03507     m_pParent(NULL),
<a name="l03508"></a>03508     m_bIsAbbreviated(true), m_lAbbrevAmount(lAdjustment), m_lDisplayAmount(lDisplayValue), 
<a name="l03509"></a>03509     m_lInRefDisplay(lInRefDisplay), m_Hash(strHash),
<a name="l03510"></a>03510     m_DATE_SIGNED(the_DATE_SIGNED), m_Type(theType), m_lClosingTransactionNo(lClosingNum),
<a name="l03511"></a>03511     m_lRequestNumber(lRequestNum),
<a name="l03512"></a>03512     m_bReplyTransSuccess(bReplyTransSuccess),
<a name="l03513"></a>03513     m_bCancelled(false)
<a name="l03514"></a>03514 {
<a name="l03515"></a>03515     <a class="code" href="class_o_t_transaction.html#af41d3b8e4611e5a9e4d7f729a61a6478">InitTransaction</a>();
<a name="l03516"></a>03516     
<a name="l03517"></a>03517     <span class="comment">// This gets zeroed out in InitTransaction() above. But since we set it in this</span>
<a name="l03518"></a>03518     <span class="comment">// constructor, I&#39;m setting it back again.</span>
<a name="l03519"></a>03519     <span class="comment">// Then why call it? I don&#39;t know, convention? For the sake of future subclasses?</span>
<a name="l03520"></a>03520     <span class="comment">//</span>
<a name="l03521"></a>03521     <a class="code" href="class_o_t_transaction.html#a1298e2f51b0a9471bc6b1aa8905b70f9">m_bIsAbbreviated</a>            = <span class="keyword">true</span>;
<a name="l03522"></a>03522     <a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>               = the_DATE_SIGNED; 
<a name="l03523"></a>03523     <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>                      = theType; <span class="comment">// This one is same story as date signed. Setting it back.</span>
<a name="l03524"></a>03524     <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a>     = lClosingNum;
<a name="l03525"></a>03525     <a class="code" href="class_o_t_transaction.html#ae1f24fb2a4460c4b695e7628fc78890e">m_lAbbrevAmount</a>             = lAdjustment;
<a name="l03526"></a>03526     <a class="code" href="class_o_t_transaction.html#a0fd4b204101be3362541aa18ecdfbcfe">m_lDisplayAmount</a>            = lDisplayValue;
<a name="l03527"></a>03527     <a class="code" href="class_o_t_transaction.html#a73e1013374088a3a36fb83007a80c4bf">m_lInRefDisplay</a>             = lInRefDisplay;
<a name="l03528"></a>03528 
<a name="l03529"></a>03529     <a class="code" href="class_o_t_transaction.html#a6fc95646e555b9c2ffb1404c6475ef56">m_lRequestNumber</a>            = lRequestNum;          <span class="comment">// for replyNotice</span>
<a name="l03530"></a>03530     <a class="code" href="class_o_t_transaction.html#a1631d08ab9b9759c5743fa0bfe9f7bdf">m_bReplyTransSuccess</a>        = bReplyTransSuccess;   <span class="comment">// for replyNotice</span>
<a name="l03531"></a>03531     
<a name="l03532"></a>03532     <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strHash);
<a name="l03533"></a>03533     <a class="code" href="class_o_t_transaction_type.html#a9635c291325b18d1d219a6286d0f8a72">m_lTransactionNum</a>           = lTransactionNum;  <span class="comment">// This is set in OTTransactionType&#39;s constructor, as are m_ID and m_ServerID</span>
<a name="l03534"></a>03534 
<a name="l03535"></a>03535     <a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lInRefTo);
<a name="l03536"></a>03536     <a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(lNumberOfOrigin);
<a name="l03537"></a>03537     
<a name="l03538"></a>03538     <span class="comment">// NOTE: For THIS CONSTRUCTOR ONLY, we DO set the purported AcctID and purported ServerID.</span>
<a name="l03539"></a>03539     <span class="comment">// (AFTER the constructor has executed, in OTLedger::ProcessXMLNode();</span>
<a name="l03540"></a>03540     <span class="comment">//</span>
<a name="l03541"></a>03541     <span class="comment">// WHY? Normally you set the &quot;real&quot; IDs at construction, and then set the &quot;purported&quot; IDs</span>
<a name="l03542"></a>03542     <span class="comment">// when loading from string. But this constructor (only this one) is actually used when </span>
<a name="l03543"></a>03543     <span class="comment">// loading abbreviated receipts as you load their inbox/outbox/nymbox.</span>
<a name="l03544"></a>03544     <span class="comment">// Abbreviated receipts are not like real transactions, which have serverID, AcctID, userID,</span>
<a name="l03545"></a>03545     <span class="comment">// and signature attached, and the whole thing is base64-encoded and then added to the ledger</span>
<a name="l03546"></a>03546     <span class="comment">// as part of a list of contained objects. Rather, with abbreviated receipts, there are a series</span>
<a name="l03547"></a>03547     <span class="comment">// of XML records loaded up as PART OF the ledger itself. None of these individual XML records</span>
<a name="l03548"></a>03548     <span class="comment">// has its own signature, or its own record of the main IDs -- those are assumed to be on the parent</span>
<a name="l03549"></a>03549     <span class="comment">// ledger.</span>
<a name="l03550"></a>03550     <span class="comment">// That&#39;s the whole point: abbreviated records don&#39;t store redundant info, and don&#39;t each have their</span>
<a name="l03551"></a>03551     <span class="comment">// own signature, because we want them to be as small as possible inside their parent ledger.</span>
<a name="l03552"></a>03552     <span class="comment">// Therefore I will pass in the parent ledger&#39;s &quot;real&quot; IDs at construction, and immediately thereafter</span>
<a name="l03553"></a>03553     <span class="comment">// set the parent ledger&#39;s &quot;purported&quot; IDs onto the abbreviated transaction. That way, VerifyContractID()</span>
<a name="l03554"></a>03554     <span class="comment">// will still work and do its job properly with these abbreviated records.</span>
<a name="l03555"></a>03555     
<a name="l03556"></a>03556     <span class="comment">// Note: I&#39;m going to go ahead and set it in here for now. This is a special constructor (abbreviated receipt constructor)</span>
<a name="l03557"></a>03557     <span class="comment">// todo: come back to this during security sweep.</span>
<a name="l03558"></a>03558     <span class="comment">//</span>
<a name="l03559"></a>03559     <a class="code" href="class_o_t_transaction_type.html#ab9c7df06d15e6dbeb53b3b3d87c13c83">SetRealAccountID</a>(theAccountID);
<a name="l03560"></a>03560     <a class="code" href="class_o_t_transaction_type.html#a80e0cd6a62cb0749526db848a3551bfe">SetPurportedAccountID</a>(theAccountID);
<a name="l03561"></a>03561     
<a name="l03562"></a>03562     <a class="code" href="class_o_t_transaction_type.html#a95c29dde80e19aa9b24c4e92f29a766e">SetRealServerID</a>(theServerID);
<a name="l03563"></a>03563     <a class="code" href="class_o_t_transaction_type.html#aae055609a4aa9b78567621209bc3fea1">SetPurportedServerID</a>(theServerID);
<a name="l03564"></a>03564     
<a name="l03565"></a>03565     <a class="code" href="class_o_t_transaction_type.html#a7bf07ca057376707a33b7a44447a4334">SetUserID</a>(theUserID);
<a name="l03566"></a>03566     <span class="comment">// ---------------------</span>
<a name="l03567"></a>03567     
<a name="l03568"></a>03568     <span class="keywordflow">if</span> (NULL != pNumList)
<a name="l03569"></a>03569         <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a> = *pNumList;
<a name="l03570"></a>03570 }
<a name="l03571"></a>03571 
<a name="l03572"></a>03572 
<a name="l03573"></a>03573 <span class="comment">//bool GenerateTransaction(const OTIdentifier &amp; theAccountID, const OTIdentifier &amp; theServerID, int64_t lTransactionNum);</span>
<a name="l03574"></a>03574 <span class="comment">//</span>
<a name="l03575"></a>03575 <span class="comment">//static</span>
<a name="l03576"></a>03576 <span class="comment">//OTTransaction * GenerateTransaction(const OTIdentifier &amp; theUserID, const OTIdentifier &amp; theAccountID, </span>
<a name="l03577"></a>03577 <span class="comment">//                                  const OTIdentifier &amp; theServerID, transactionType theType, </span>
<a name="l03578"></a>03578 <span class="comment">//                                  int64_t lTransactionNum=0);</span>
<a name="l03579"></a>03579 <span class="comment">//static</span>
<a name="l03580"></a>03580 <span class="comment">//OTTransaction * GenerateTransaction(const OTLedger &amp; theOwner, transactionType theType, int64_t lTransactionNum=0);</span>
<a name="l03581"></a>03581 
<a name="l03582"></a>03582 
<a name="l03583"></a>03583 <span class="comment">//static</span>
<a name="l03584"></a><a class="code" href="class_o_t_transaction.html#a640621b2732e9f97dc94be142f0c648b">03584</a> <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theOwner, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">transactionType</a> theType, int64_t lTransactionNum<span class="comment">/*=0*/</span>)
<a name="l03585"></a>03585 {
<a name="l03586"></a>03586     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">GenerateTransaction</a>(theOwner.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theOwner.<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>(), 
<a name="l03587"></a>03587                                                        theOwner.<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), theType, lTransactionNum);  
<a name="l03588"></a>03588     <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l03589"></a>03589         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aceb0b4c83da5f50512bf6045fef6583b">SetParent</a>(theOwner);
<a name="l03590"></a>03590     
<a name="l03591"></a>03591     <span class="keywordflow">return</span> pTransaction;
<a name="l03592"></a>03592 }
<a name="l03593"></a>03593 
<a name="l03594"></a>03594 
<a name="l03595"></a>03595 <span class="comment">//static</span>
<a name="l03596"></a><a class="code" href="class_o_t_transaction.html#a7674b6e41e6cf8c9cc26c35e15fc21d8">03596</a> <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theUserID, 
<a name="l03597"></a>03597                                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAccountID, 
<a name="l03598"></a>03598                                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">transactionType</a> theType,
<a name="l03599"></a>03599                                                    int64_t lTransactionNum<span class="comment">/*=0*/</span>)
<a name="l03600"></a>03600 {
<a name="l03601"></a>03601     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <span class="keyword">new</span> <a class="code" href="class_o_t_transaction.html#a0c71e0fea951a8d757e69ec369c5add0">OTTransaction</a>(theUserID, theAccountID, theServerID, lTransactionNum);
<a name="l03602"></a>03602     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
<a name="l03603"></a>03603     
<a name="l03604"></a>03604     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a> = theType;
<a name="l03605"></a>03605     
<a name="l03606"></a>03606     <span class="comment">// Since we&#39;re actually generating this transaction, then we can go ahead</span>
<a name="l03607"></a>03607     <span class="comment">// and set the purported account and server IDs (we have already set the</span>
<a name="l03608"></a>03608     <span class="comment">// real ones in the constructor). Now both sets are fill with matching data.</span>
<a name="l03609"></a>03609     <span class="comment">// No need to security check the IDs since we are creating this transaction</span>
<a name="l03610"></a>03610     <span class="comment">// versus loading and inspecting it.</span>
<a name="l03611"></a>03611     pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a80e0cd6a62cb0749526db848a3551bfe">SetPurportedAccountID</a>(theAccountID);
<a name="l03612"></a>03612     pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aae055609a4aa9b78567621209bc3fea1">SetPurportedServerID</a>(theServerID);
<a name="l03613"></a>03613     
<a name="l03614"></a>03614     <span class="keywordflow">return</span> pTransaction;
<a name="l03615"></a>03615 }
<a name="l03616"></a>03616 
<a name="l03617"></a>03617 
<a name="l03618"></a>03618 <span class="comment">// the constructors set the real IDs (account and server) but they do not set the</span>
<a name="l03619"></a>03619 <span class="comment">// IDs that are internal to this object, m_AcctID and m_AcctServerID. These, it is assumed,</span>
<a name="l03620"></a>03620 <span class="comment">// will match the real IDs, but they must be checked when they are loaded.</span>
<a name="l03621"></a>03621 <span class="comment">// If you wish to create a transaction object, but SET the internal members (you KNOW </span>
<a name="l03622"></a>03622 <span class="comment">// they are correct or you want to generate them here) then use this function or make one like it.</span>
<a name="l03623"></a>03623 <span class="comment">//</span>
<a name="l03624"></a><a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">03624</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAccountID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID, int64_t lTransactionNum)
<a name="l03625"></a>03625 {
<a name="l03626"></a>03626     <span class="comment">// Presumably the constructor was just called, so m_ID and m_ServerID are already set properly.</span>
<a name="l03627"></a>03627     <span class="comment">// I might make a class factory in order to enforce this. Sounds like an appropriate situation.</span>
<a name="l03628"></a>03628     <span class="comment">//m_ID</span>
<a name="l03629"></a>03629     <span class="comment">//m_ServerID</span>
<a name="l03630"></a>03630     
<a name="l03631"></a>03631     <a class="code" href="class_o_t_transaction_type.html#a80e0cd6a62cb0749526db848a3551bfe">SetPurportedAccountID</a>(theAccountID);
<a name="l03632"></a>03632     <a class="code" href="class_o_t_transaction_type.html#aae055609a4aa9b78567621209bc3fea1">SetPurportedServerID</a>(theServerID);
<a name="l03633"></a>03633     
<a name="l03634"></a>03634     <a class="code" href="class_o_t_transaction_type.html#ae040aebddfa217a4fe5e349804f241e3">SetTransactionNum</a>(lTransactionNum);
<a name="l03635"></a>03635     
<a name="l03636"></a>03636     <span class="comment">// Make sure these match with the ones that were passed into the constructor.</span>
<a name="l03637"></a>03637     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>();
<a name="l03638"></a>03638 }
<a name="l03639"></a>03639 
<a name="l03640"></a>03640 
<a name="l03641"></a><a class="code" href="class_o_t_transaction.html#a23e270a9dfc3b85d48d64582814232e5">03641</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a23e270a9dfc3b85d48d64582814232e5">OTTransaction::SaveContractWallet</a>(std::ofstream &amp; ofs)
<a name="l03642"></a>03642 {
<a name="l03643"></a>03643     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03644"></a>03644 }
<a name="l03645"></a>03645 
<a name="l03646"></a>03646 
<a name="l03647"></a><a class="code" href="class_o_t_transaction.html#a428b050396c72e438cd39349f6ea8948">03647</a> <a class="code" href="class_o_t_transaction.html#a428b050396c72e438cd39349f6ea8948">OTTransaction::~OTTransaction</a>()
<a name="l03648"></a>03648 {
<a name="l03649"></a>03649     <a class="code" href="class_o_t_transaction.html#a6548cbe73252c7554db6f6ceddebc5ae">Release_Transaction</a>();
<a name="l03650"></a>03650 }
<a name="l03651"></a>03651 
<a name="l03652"></a>03652 
<a name="l03653"></a><a class="code" href="class_o_t_transaction.html#af729ee60ed39ff6f918873aedfc7a0af">03653</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#af729ee60ed39ff6f918873aedfc7a0af">OTTransaction::ReleaseItems</a>()
<a name="l03654"></a>03654 {
<a name="l03655"></a>03655     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = NULL;
<a name="l03656"></a>03656     
<a name="l03657"></a>03657     <span class="keywordflow">while</span> (!<a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>.empty())
<a name="l03658"></a>03658     {
<a name="l03659"></a>03659         pItem = <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>.front();
<a name="l03660"></a>03660         <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>.pop_front();
<a name="l03661"></a>03661         <span class="keyword">delete</span> pItem;
<a name="l03662"></a>03662         pItem = NULL;
<a name="l03663"></a>03663     }
<a name="l03664"></a>03664 }
<a name="l03665"></a>03665 
<a name="l03666"></a>03666 
<a name="l03667"></a><a class="code" href="class_o_t_transaction.html#a4f9c8be70e01dfcd7bedbac7d6af887b">03667</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a4f9c8be70e01dfcd7bedbac7d6af887b">OTTransaction::Release</a>()
<a name="l03668"></a>03668 {
<a name="l03669"></a>03669     <a class="code" href="class_o_t_transaction.html#a6548cbe73252c7554db6f6ceddebc5ae">Release_Transaction</a>();
<a name="l03670"></a>03670     <span class="comment">// --------------------</span>
<a name="l03671"></a>03671     <a class="code" href="class_o_t_transaction_type.html#aeec55f5abb43646745a532bf10aece24">ot_super::Release</a>();
<a name="l03672"></a>03672 }
<a name="l03673"></a>03673 
<a name="l03674"></a>03674 
<a name="l03675"></a><a class="code" href="class_o_t_transaction.html#a6548cbe73252c7554db6f6ceddebc5ae">03675</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a6548cbe73252c7554db6f6ceddebc5ae">OTTransaction::Release_Transaction</a>()
<a name="l03676"></a>03676 {
<a name="l03677"></a>03677     <span class="comment">// (Any other dynamically allocated memory is freed here.)</span>
<a name="l03678"></a>03678     
<a name="l03679"></a>03679     <a class="code" href="class_o_t_transaction.html#af729ee60ed39ff6f918873aedfc7a0af">ReleaseItems</a>();
<a name="l03680"></a>03680 }
<a name="l03681"></a>03681 
<a name="l03682"></a>03682 
<a name="l03683"></a>03683 <span class="comment">// You have to allocate the item on the heap and then pass it in as a reference. </span>
<a name="l03684"></a>03684 <span class="comment">// OTTransaction will take care of it from there and will delete it in destructor.</span>
<a name="l03685"></a><a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">03685</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">OTTransaction::AddItem</a>(<a class="code" href="class_o_t_item.html">OTItem</a> &amp; theItem) 
<a name="l03686"></a>03686 { 
<a name="l03687"></a>03687     <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>.push_back(&amp;theItem);  
<a name="l03688"></a>03688 } 
<a name="l03689"></a>03689 
<a name="l03690"></a>03690 
<a name="l03691"></a>03691 <span class="comment">// While processing a transaction, you may wish to query it for items of a certain type.</span>
<a name="l03692"></a><a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">03692</a> <a class="code" href="class_o_t_item.html">OTItem</a> * <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">OTTransaction::GetItem</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theType) 
<a name="l03693"></a>03693 {
<a name="l03694"></a>03694     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l03695"></a>03695     {
<a name="l03696"></a>03696         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l03697"></a>03697         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03698"></a>03698         
<a name="l03699"></a>03699         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() == theType)
<a name="l03700"></a>03700             <span class="keywordflow">return</span> pItem;
<a name="l03701"></a>03701     }
<a name="l03702"></a>03702     
<a name="l03703"></a>03703     <span class="keywordflow">return</span> NULL;
<a name="l03704"></a>03704 }
<a name="l03705"></a>03705 
<a name="l03706"></a>03706 
<a name="l03707"></a>03707 <span class="comment">// While processing a transaction, you may wish to query it for items in</span>
<a name="l03708"></a>03708 <span class="comment">// reference to a particular transaction number.</span>
<a name="l03709"></a>03709 <span class="comment">//</span>
<a name="l03710"></a><a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">03710</a> <a class="code" href="class_o_t_item.html">OTItem</a> * <a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">OTTransaction::GetItemInRefTo</a>(<span class="keyword">const</span> int64_t lReference) 
<a name="l03711"></a>03711 {
<a name="l03712"></a>03712     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#a95246c5281488bbde41f3be2cc096a5f">GetItemCountInRefTo</a>(lReference) &gt; 1)
<a name="l03713"></a>03713     {
<a name="l03714"></a>03714         <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;CAN&#39;T USE GetItemInRefTo! (There are multiple items in reference to the same number...) SWITCH to using NumberOfOrigin?&quot;</span>);
<a name="l03715"></a>03715     }
<a name="l03716"></a>03716     <span class="comment">// -----------------------------------</span>
<a name="l03717"></a>03717     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l03718"></a>03718     {
<a name="l03719"></a>03719         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l03720"></a>03720         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03721"></a>03721         
<a name="l03722"></a>03722         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() == lReference)
<a name="l03723"></a>03723             <span class="keywordflow">return</span> pItem;
<a name="l03724"></a>03724     }
<a name="l03725"></a>03725     
<a name="l03726"></a>03726     <span class="keywordflow">return</span> NULL;
<a name="l03727"></a>03727 }
<a name="l03728"></a>03728 
<a name="l03729"></a>03729 
<a name="l03730"></a>03730 <span class="comment">// Count the number of items that are IN REFERENCE TO some transaction#.</span>
<a name="l03731"></a>03731 <span class="comment">//</span>
<a name="l03732"></a>03732 <span class="comment">// Might want to change this so that it only counts ACCEPTED receipts.</span>
<a name="l03733"></a>03733 <span class="comment">//</span>
<a name="l03734"></a><a class="code" href="class_o_t_transaction.html#a95246c5281488bbde41f3be2cc096a5f">03734</a> int32_t <a class="code" href="class_o_t_transaction.html#a95246c5281488bbde41f3be2cc096a5f">OTTransaction::GetItemCountInRefTo</a>(<span class="keyword">const</span> int64_t lReference)
<a name="l03735"></a>03735 {
<a name="l03736"></a>03736     int32_t nCount = 0;
<a name="l03737"></a>03737     
<a name="l03738"></a>03738     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l03739"></a>03739     {
<a name="l03740"></a>03740         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l03741"></a>03741         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03742"></a>03742         
<a name="l03743"></a>03743         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() == lReference)
<a name="l03744"></a>03744             nCount++;
<a name="l03745"></a>03745     }
<a name="l03746"></a>03746     
<a name="l03747"></a>03747     <span class="keywordflow">return</span> nCount;  
<a name="l03748"></a>03748 }
<a name="l03749"></a>03749 
<a name="l03750"></a>03750 
<a name="l03751"></a>03751 <span class="comment">/*</span>
<a name="l03752"></a>03752 <span class="comment"> a processNymbox transaction has a list of items--each one accepting a nymbox</span>
<a name="l03753"></a>03753 <span class="comment"> receipt (ottransaction) so as to remove it from the nymbox. It also has a </span>
<a name="l03754"></a>03754 <span class="comment"> transaction statement item, which must verify in order for the others to run.</span>
<a name="l03755"></a>03755 <span class="comment"> </span>
<a name="l03756"></a>03756 <span class="comment"> Here are the types of items:</span>
<a name="l03757"></a>03757 <span class="comment">case OTItem::acceptFinalReceipt:</span>
<a name="l03758"></a>03758 <span class="comment"> theReplyItemType = OTItem::atAcceptFinalReceipt;</span>
<a name="l03759"></a>03759 <span class="comment"> break;</span>
<a name="l03760"></a>03760 <span class="comment">case OTItem::acceptTransaction:</span>
<a name="l03761"></a>03761 <span class="comment"> theReplyItemType = OTItem::atAcceptTransaction;</span>
<a name="l03762"></a>03762 <span class="comment"> break;</span>
<a name="l03763"></a>03763 <span class="comment">case OTItem::acceptMessage:</span>
<a name="l03764"></a>03764 <span class="comment"> theReplyItemType = OTItem::atAcceptMessage;</span>
<a name="l03765"></a>03765 <span class="comment"> break;</span>
<a name="l03766"></a>03766 <span class="comment">case OTItem::acceptNotice:</span>
<a name="l03767"></a>03767 <span class="comment"> theReplyItemType = OTItem::atAcceptNotice;</span>
<a name="l03768"></a>03768 <span class="comment"> break;</span>
<a name="l03769"></a>03769 <span class="comment"></span>
<a name="l03770"></a>03770 <span class="comment"> */</span>
<a name="l03771"></a>03771 
<a name="l03772"></a>03772 <span class="comment">//  OTTransaction::GetSuccess()</span>
<a name="l03773"></a>03773 <span class="comment">//</span>
<a name="l03774"></a>03774 <span class="comment">// Tries to determine, based on items within, whether it was a success or fail.</span>
<a name="l03775"></a>03775 <span class="comment">//</span>
<a name="l03776"></a>03776 <span class="comment">// DONE:</span>
<a name="l03777"></a>03777 <span class="comment">//</span>
<a name="l03778"></a>03778 <span class="comment">// What about a processNymbox message? ALL of its items must be successful, </span>
<a name="l03779"></a>03779 <span class="comment">// for any of them to be (for the transaction statement to make any sense....)</span>
<a name="l03780"></a>03780 <span class="comment">//</span>
<a name="l03781"></a>03781 <span class="comment">// What I NEED to do , in case of atProcessNymbox and maybe others, is loop</span>
<a name="l03782"></a>03782 <span class="comment">// through them ALL and check them ALL for success.</span>
<a name="l03783"></a>03783 <span class="comment">//</span>
<a name="l03784"></a>03784 <span class="comment">// What it does now is, if it sees an item of a certain type, then it IMMEDIATELY</span>
<a name="l03785"></a>03785 <span class="comment">// returns success or fail based on its status. Imagine this problem: My transaction</span>
<a name="l03786"></a>03786 <span class="comment">// failed (say, due to empty account) but the balance statement itself had succeeded</span>
<a name="l03787"></a>03787 <span class="comment">// before it got to that point. The below loop as it exists now will see that the</span>
<a name="l03788"></a>03788 <span class="comment">// atBalanceStatement was successful, and IMMEDAITELY RETURNS TRUE! (Even if the</span>
<a name="l03789"></a>03789 <span class="comment">// item for the transaction itself had failed.)</span>
<a name="l03790"></a>03790 <span class="comment">//</span>
<a name="l03791"></a>03791 <span class="comment">// In the case of processNymbox it&#39;s worse, since the ENTIRE TRANSACTION must fail, if</span>
<a name="l03792"></a>03792 <span class="comment">// ANY of its items do. You have to loop them ALL and make sure they are ALL success.</span>
<a name="l03793"></a>03793 <span class="comment">// (regardless of their type.) You can only do this if you know *this is a processNymbox</span>
<a name="l03794"></a>03794 <span class="comment">// transaction, yet we can clearly see, that the below code is simply looping the items</span>
<a name="l03795"></a>03795 <span class="comment">// REGARDLESS of what type of transaction *this actually is.</span>
<a name="l03796"></a>03796 <span class="comment">//</span>
<a name="l03797"></a>03797 <span class="comment">// Note: (Below is now fixed.)</span>
<a name="l03798"></a>03798 <span class="comment">// What if, as above, the processNymbox failed, but has a successful transaction statement</span>
<a name="l03799"></a>03799 <span class="comment">// as one of its items? The below loop would return true!</span>
<a name="l03800"></a>03800 <span class="comment">// </span>
<a name="l03801"></a>03801 <span class="comment">// This is actually a pretty good argument for using polymorphism for the various transaction</span>
<a name="l03802"></a>03802 <span class="comment">// and item types, so these sorts of SWITCH STATEMENTS aren&#39;t necessary all over the transaction</span>
<a name="l03803"></a>03803 <span class="comment">// and ledger code. Although IMO a default implementation should still cover most cases.</span>
<a name="l03804"></a>03804 <span class="comment">//</span>
<a name="l03805"></a>03805 <span class="comment">//</span>
<a name="l03806"></a>03806 <span class="comment">// Tries to determine, based on items within, whether it was a success or fail.</span>
<a name="l03807"></a>03807 <span class="comment">//</span>
<a name="l03808"></a><a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">03808</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">OTTransaction::GetSuccess</a>()
<a name="l03809"></a>03809 {
<a name="l03810"></a>03810     <span class="keywordtype">bool</span> bFoundAnActionItem = <span class="keyword">false</span>, bFoundABalanceAgreement = <span class="keyword">false</span>;
<a name="l03811"></a>03811 
<a name="l03812"></a>03812     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>  == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || 
<a name="l03813"></a>03813         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">OTTransaction::atProcessNymbox</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
<a name="l03814"></a>03814     {        
<a name="l03815"></a>03815         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l03816"></a>03816         {
<a name="l03817"></a>03817             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l03818"></a>03818             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03819"></a>03819             
<a name="l03820"></a>03820             <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l03821"></a>03821             {
<a name="l03822"></a>03822 
<a name="l03823"></a>03823                     
<a name="l03824"></a>03824                     <span class="comment">// BALANCE AGREEMENT  /  TRANSACTION STATEMENT</span>
<a name="l03825"></a>03825                     
<a name="l03826"></a>03826                     <span class="comment">// Even if one of these is a success, it is only the balance agreement for</span>
<a name="l03827"></a>03827                     <span class="comment">// the transaction itself, which must also be a success. For example, if there</span>
<a name="l03828"></a>03828                     <span class="comment">// is a transaction for a cash withdrawal, then it will contain 2 items: one item</span>
<a name="l03829"></a>03829                     <span class="comment">// is the withdrawal itself, and the other item is the balance agreement for that</span>
<a name="l03830"></a>03830                     <span class="comment">// withdrawal. Therefore, even if the balanace agreement item is successful, the</span>
<a name="l03831"></a>03831                     <span class="comment">// withdrawal item itself must ALSO be successful, for the transaction AS A WHOLE</span>
<a name="l03832"></a>03832                     <span class="comment">// to be &quot;successful.&quot;</span>
<a name="l03833"></a>03833                     <span class="comment">// However, if this balance agreement failed, then the rest of the transaction has</span>
<a name="l03834"></a>03834                     <span class="comment">// definitely failed as well.</span>
<a name="l03835"></a>03835                     <span class="comment">// Therefore, here we either return false, or CONTINUE and let the decision be made</span>
<a name="l03836"></a>03836                     <span class="comment">// from the other items in this transaction otherwise.</span>
<a name="l03837"></a>03837                     <span class="comment">//</span>
<a name="l03838"></a>03838                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>:     <span class="comment">// processInbox and notarizeTransactions. server&#39;s reply to a balance statement. One of these items appears inside any transaction reply.</span>
<a name="l03839"></a>03839                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>: <span class="comment">// processNymbox and also for starting/stopping any cron items. (notarizeTransactions: payment plan, market offer, smart contract, trigger clause, cancel cron item, etc.) The server&#39;s reply to a transaction statement. Like a balance statement, except no asset acct is involved.</span>
<a name="l03840"></a>03840                     <span class="comment">//</span>
<a name="l03841"></a>03841                 <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03842"></a>03842                                         
<a name="l03843"></a>03843                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03844"></a>03844                     {
<a name="l03845"></a>03845                         bFoundABalanceAgreement = <span class="keyword">true</span>;
<a name="l03846"></a>03846                     }
<a name="l03847"></a>03847                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03848"></a>03848                     {
<a name="l03849"></a>03849                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03850"></a>03850                     }
<a name="l03851"></a>03851                     <span class="comment">// else continue...</span>
<a name="l03852"></a>03852                     <span class="comment">//</span>
<a name="l03853"></a>03853                     <span class="keywordflow">continue</span>;
<a name="l03854"></a>03854                     
<a name="l03855"></a>03855                 <span class="comment">// **************************************************************************</span>
<a name="l03856"></a>03856                     
<a name="l03857"></a>03857                     <span class="comment">// PROCESS NYMBOX</span>
<a name="l03858"></a>03858                     
<a name="l03859"></a>03859                     <span class="comment">// These are only a success if ALL of them (all of the items </span>
<a name="l03860"></a>03860                     <span class="comment">// in this processNymbox transaction) are a success.</span>
<a name="l03861"></a>03861                     
<a name="l03862"></a>03862                     <span class="comment">// NOTE: these cases only matter if *this is an atProcessNymbox, and in THAT case, it requires ALL items</span>
<a name="l03863"></a>03863                     <span class="comment">// to verify, not just the first one of a specific type.</span>
<a name="l03864"></a>03864                     <span class="comment">//</span>
<a name="l03865"></a>03865                     <span class="comment">// </span>
<a name="l03866"></a>03866                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>:   <span class="comment">// processNymbox. server&#39;s reply to the Nym&#39;s attempt to accept (sign for) transaction</span>
<a name="l03867"></a>03867                     <span class="comment">// numbers that are sitting in his nymbox (since he requested more numbers....)</span>
<a name="l03868"></a>03868                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:       <span class="comment">// processNymbox. server&#39;s reply to nym&#39;s accepting a message (from another nym) that&#39;s in his nymbox.</span>
<a name="l03869"></a>03869                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:        <span class="comment">// processNymbox. server&#39;s reply to nym&#39;s accepting a notice from the server, such as a successNotice (success signing out new transaction numbers) or a replyNotice, or an instrumentNotice.</span>
<a name="l03870"></a>03870                     <span class="comment">// For example, some server replies are dropped into your Nymbox, to make sure you receive them. Then you accept them, to remove from your Nymbox.</span>
<a name="l03871"></a>03871                 <span class="comment">// ------------------------------------------------------------------------                </span>
<a name="l03872"></a>03872                     
<a name="l03873"></a>03873                     <span class="comment">// PROCESS NYMBOX *and* PROCESS INBOX</span>
<a name="l03874"></a>03874                     
<a name="l03875"></a>03875                     <span class="comment">// These are only a success if ALL of them (all of the items </span>
<a name="l03876"></a>03876                     <span class="comment">// in this processInbox or processNymbox transaction) are a success.</span>
<a name="l03877"></a>03877                     
<a name="l03878"></a>03878                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:  <span class="comment">// Part of a processInbox or processNymbox transaction reply from the server.</span>
<a name="l03879"></a>03879                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9b353f70c54facca58998d250badcf27">OTItem::atDisputeFinalReceipt</a>:  <span class="comment">// Would be in processNymbox AND processInbox. Can these be disputed? Think through the process. Todo.</span>
<a name="l03880"></a>03880                     
<a name="l03881"></a>03881                 <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03882"></a>03882                     
<a name="l03883"></a>03883                     <span class="comment">// PROCESS INBOX</span>
<a name="l03884"></a>03884                     
<a name="l03885"></a>03885                     <span class="comment">// These are only a success if ALL of them (all of the items </span>
<a name="l03886"></a>03886                     <span class="comment">// in this processInbox transaction) are a success.</span>
<a name="l03887"></a>03887                     
<a name="l03888"></a>03888                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>:        <span class="comment">// processInbox. server&#39;s reply to nym&#39;s request to accept an incoming pending transfer that&#39;s sitting in his asset acct&#39;s inbox.</span>
<a name="l03889"></a>03889                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a84f21da0049c428f2e74c573dfaff067">OTItem::atRejectPending</a>:        <span class="comment">// processInbox. Same thing, except rejecting that pending transfer instead of accepting it.</span>
<a name="l03890"></a>03890                     
<a name="l03891"></a>03891                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:    <span class="comment">// processInbox. Accepting a payment receipt or market receipt. (Smart contracts also drop payment receipts, currently.)</span>
<a name="l03892"></a>03892                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a15fb11d5243db9056a4c340bc49cea43">OTItem::atDisputeCronReceipt</a>:   <span class="comment">// processInbox. Dispute. (Todo.)</span>
<a name="l03893"></a>03893                     
<a name="l03894"></a>03894                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>:    <span class="comment">// processInbox. Accepting a transferReceipt, or chequeReceipt, etc.</span>
<a name="l03895"></a>03895                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acd9426f6754691aebb202e9c14cdc681">OTItem::atDisputeItemReceipt</a>:   <span class="comment">// processInbox. Dispute. (Todo.)              </span>
<a name="l03896"></a>03896                     
<a name="l03897"></a>03897                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:  <span class="comment">// processInbox. Basket Receipt, from a basket currency exchange (in or out.)</span>
<a name="l03898"></a>03898                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9fc8674f161335439c48b2e9db277b9b">OTItem::atDisputeBasketReceipt</a>: <span class="comment">// processInbox. dispute basket receipt.</span>
<a name="l03899"></a>03899                     
<a name="l03900"></a>03900                 <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03901"></a>03901                     
<a name="l03902"></a>03902                     <span class="comment">// If we found at least one of these, and nothing fails by the end of the loop,</span>
<a name="l03903"></a>03903                     <span class="comment">// then for processNymbox and processInbox, it&#39;s a success. (If balance agreement also...)</span>
<a name="l03904"></a>03904                     
<a name="l03905"></a>03905                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03906"></a>03906                     {
<a name="l03907"></a>03907                         bFoundAnActionItem = <span class="keyword">true</span>;
<a name="l03908"></a>03908                     }
<a name="l03909"></a>03909                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03910"></a>03910                     {
<a name="l03911"></a>03911                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03912"></a>03912                     }
<a name="l03913"></a>03913                     <span class="comment">// else continue...</span>
<a name="l03914"></a>03914                     <span class="comment">//</span>
<a name="l03915"></a>03915                     <span class="keywordflow">continue</span>;
<a name="l03916"></a>03916                                         
<a name="l03917"></a>03917                 <span class="comment">// **************************************************************************</span>
<a name="l03918"></a>03918                     
<a name="l03919"></a>03919                 <span class="keywordflow">default</span>:
<a name="l03920"></a>03920                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong transaction type passed to OTTransaction::GetSuccess() &quot;</span>
<a name="l03921"></a>03921                                  <span class="stringliteral">&quot;for processNymbox or processInbox transaction.\n&quot;</span>);
<a name="l03922"></a>03922                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03923"></a>03923             }<span class="comment">// switch</span>
<a name="l03924"></a>03924         } <span class="comment">// FOR_EACH</span>
<a name="l03925"></a>03925         
<a name="l03926"></a>03926         <span class="keywordflow">return</span> (bFoundABalanceAgreement &amp;&amp; bFoundAnActionItem);
<a name="l03927"></a>03927         
<a name="l03928"></a>03928     } <span class="comment">// if processNymbox or processInbox.</span>
<a name="l03929"></a>03929     
<a name="l03930"></a>03930     
<a name="l03931"></a>03931     
<a name="l03932"></a>03932     <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l03933"></a>03933     
<a name="l03934"></a>03934     <span class="comment">// Okay, it&#39;s not a processNymbox or processInbox.</span>
<a name="l03935"></a>03935     <span class="comment">//</span>
<a name="l03936"></a>03936     <span class="comment">// Maybe it&#39;s one of these other transaction types...</span>
<a name="l03937"></a>03937     
<a name="l03938"></a>03938     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l03939"></a>03939     {
<a name="l03940"></a>03940         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l03941"></a>03941         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l03942"></a>03942         
<a name="l03943"></a>03943         <span class="keywordflow">switch</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l03944"></a>03944         {                   
<a name="l03945"></a>03945 <span class="comment">//          case OTItem::atServerfee:            // Fees currently aren&#39;t coded. Todo.</span>
<a name="l03946"></a>03946 <span class="comment">//          case OTItem::atIssuerfee:            // Same as above. Todo.</span>
<a name="l03947"></a>03947                 
<a name="l03948"></a>03948             <span class="comment">// **************************************************************************</span>
<a name="l03949"></a>03949                 
<a name="l03950"></a>03950             <span class="comment">// BALANCE AGREEMENT  /  TRANSACTION STATEMENT</span>
<a name="l03951"></a>03951                 
<a name="l03952"></a>03952                 <span class="comment">// Even if one of these is a success, it is only the balance agreement for</span>
<a name="l03953"></a>03953                 <span class="comment">// the transaction itself, which must also be a success. For example, if there</span>
<a name="l03954"></a>03954                 <span class="comment">// is a transaction for a cash withdrawal, then it will contain 2 items: one item</span>
<a name="l03955"></a>03955                 <span class="comment">// is the withdrawal itself, and the other item is the balance agreement for that</span>
<a name="l03956"></a>03956                 <span class="comment">// withdrawal. Therefore, even if the balanace agreement item is successful, the</span>
<a name="l03957"></a>03957                 <span class="comment">// withdrawal item itself must ALSO be successful, for the transaction AS A WHOLE</span>
<a name="l03958"></a>03958                 <span class="comment">// to be &quot;successful.&quot;</span>
<a name="l03959"></a>03959                 <span class="comment">// However, if this balance agreement failed, then the rest of the transaction has</span>
<a name="l03960"></a>03960                 <span class="comment">// definitely failed as well.</span>
<a name="l03961"></a>03961                 <span class="comment">// Therefore, here we either return false, or CONTINUE and let the decision be made</span>
<a name="l03962"></a>03962                 <span class="comment">// from the other items in this transaction otherwise.</span>
<a name="l03963"></a>03963                 <span class="comment">//</span>
<a name="l03964"></a>03964             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>:     <span class="comment">// processInbox and notarizeTransactions. server&#39;s reply to a balance statement. One of these items appears inside any transaction reply.</span>
<a name="l03965"></a>03965             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>: <span class="comment">// processNymbox and also for starting/stopping any cron items. (notarizeTransactions: payment plan, market offer, smart contract, trigger clause, cancel cron item, etc.) The server&#39;s reply to a transaction statement. Like a balance statement, except no asset acct is involved.</span>
<a name="l03966"></a>03966                 <span class="comment">//</span>
<a name="l03967"></a>03967                                 
<a name="l03968"></a>03968                 <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03969"></a>03969                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03970"></a>03970                 {
<a name="l03971"></a>03971                     bFoundABalanceAgreement = <span class="keyword">true</span>;
<a name="l03972"></a>03972                 }
<a name="l03973"></a>03973                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03974"></a>03974                 {
<a name="l03975"></a>03975                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03976"></a>03976                 }
<a name="l03977"></a>03977                 <span class="comment">// else continue...</span>
<a name="l03978"></a>03978                 <span class="comment">//</span>
<a name="l03979"></a>03979                 <span class="keywordflow">continue</span>;
<a name="l03980"></a>03980                 
<a name="l03981"></a>03981             <span class="comment">// **************************************************************************</span>
<a name="l03982"></a>03982                 <span class="comment">/*</span>
<a name="l03983"></a>03983 <span class="comment">                 atProcessNymbox,   // process nymbox reply          // comes from server</span>
<a name="l03984"></a>03984 <span class="comment">                 atProcessInbox,    // process inbox reply           // comes from server</span>
<a name="l03985"></a>03985 <span class="comment">                 </span>
<a name="l03986"></a>03986 <span class="comment">                 // Note: the above two transaction types are handled in the switch block above this one.</span>
<a name="l03987"></a>03987 <span class="comment">                 // Whereas the below transaction types are handled right here in this switch block.</span>
<a name="l03988"></a>03988 <span class="comment">                 </span>
<a name="l03989"></a>03989 <span class="comment">                 atTransfer,        // reply from the server regarding a transfer request</span>
<a name="l03990"></a>03990 <span class="comment">                 atDeposit,         // reply from the server regarding a deposit request</span>
<a name="l03991"></a>03991 <span class="comment">                 atWithdrawal,      // reply from the server regarding a withdrawal request</span>
<a name="l03992"></a>03992 <span class="comment">                 atMarketOffer,     // reply from the server regarding a market offer</span>
<a name="l03993"></a>03993 <span class="comment">                 atPaymentPlan,     // reply from the server regarding a payment plan</span>
<a name="l03994"></a>03994 <span class="comment">                 atSmartContract,   // reply from the server regarding a smart contract</span>
<a name="l03995"></a>03995 <span class="comment">                 atCancelCronItem,  // reply from the server regarding said cancellation.</span>
<a name="l03996"></a>03996 <span class="comment">                 atExchangeBasket,  // reply from the server regarding said exchange.</span>
<a name="l03997"></a>03997 <span class="comment">                 */</span>
<a name="l03998"></a>03998 
<a name="l03999"></a>03999             <span class="comment">// NOTARIZE TRANSACTION</span>
<a name="l04000"></a>04000                 <span class="comment">// If any of these are a success, then the transaction as a whole is a success also.</span>
<a name="l04001"></a>04001                 
<a name="l04002"></a>04002             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac310111eca8eb295fb5dafddd884fc82">OTItem::atTransfer</a>:             <span class="comment">// notarizeTransactions. server&#39;s reply to nym&#39;s request to initiate a transfer</span>
<a name="l04003"></a>04003 
<a name="l04004"></a>04004             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>:           <span class="comment">// notarizeTransaction. server&#39;s reply to withdrawal (cash) request.</span>
<a name="l04005"></a>04005             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a>:              <span class="comment">// notarizeTransaction. server&#39;s reply to deposit (cash) request.</span>
<a name="l04006"></a>04006             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>:      <span class="comment">// notarizeTransaction. server&#39;s reply to &quot;withdraw voucher&quot; request.</span>
<a name="l04007"></a>04007             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a>:        <span class="comment">// notarizeTransaction. server&#39;s reply to &quot;deposit cheque&quot; request.</span>
<a name="l04008"></a>04008             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a>:          <span class="comment">// notarizeTransaction. server&#39;s reply to &quot;pay dividend&quot; request.</span>
<a name="l04009"></a>04009             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a229f0c7ace7a51840d7632910a0b92a6">OTItem::atMarketOffer</a>:          <span class="comment">// notarizeTransaction. server&#39;s reply to request to place a market offer.</span>
<a name="l04010"></a>04010             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afbc3c7556a790e7a7b6be464f8ea058b">OTItem::atPaymentPlan</a>:          <span class="comment">// notarizeTransaction. server&#39;s reply to request to activate a payment plan.</span>
<a name="l04011"></a>04011             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1fe91e4cadee24de6acb9de56a55e4eb">OTItem::atSmartContract</a>:        <span class="comment">// notarizeTransaction. server&#39;s reply to request to activate a smart contract.</span>
<a name="l04012"></a>04012                 
<a name="l04013"></a>04013             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ab3ded9d37de3a75d4b39735bb9aff341">OTItem::atCancelCronItem</a>:       <span class="comment">// notarizeTransaction. server&#39;s reply to request to cancel a [ market offer | payment plan | smart contract ]</span>
<a name="l04014"></a>04014             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0b62f8efea6ed9bdefbc48ce2e97a8b6">OTItem::atExchangeBasket</a>:       <span class="comment">// notarizeTransaction. server&#39;s reply to request to exchange in or out of a basket currency.</span>
<a name="l04015"></a>04015 
<a name="l04016"></a>04016             <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l04017"></a>04017                 
<a name="l04018"></a>04018             <span class="comment">// RECEIPTS</span>
<a name="l04019"></a>04019                 
<a name="l04020"></a>04020                 <span class="comment">// 1. ACTUAL RECEIPTS (item attached to similar transaction), and also </span>
<a name="l04021"></a>04021                 <span class="comment">// 2. INBOX REPORT ITEMS (sub-item to ANOTHER item, which is used on Balance Agreements and Transaction Statements.)</span>
<a name="l04022"></a>04022                 <span class="comment">//</span>
<a name="l04023"></a>04023                 <span class="comment">// In case of (1), GetSuccess() is relevant. </span>
<a name="l04024"></a>04024                 <span class="comment">// But in case of (2) GetSuccess() is NOT relevant. FYI.</span>
<a name="l04025"></a>04025                 <span class="comment">//</span>
<a name="l04026"></a>04026                 <span class="comment">// Anyway, if a marketReceipt item is attached to a marketReceipt transaction, then we</span>
<a name="l04027"></a>04027                 <span class="comment">// can return success or failure right away, since such status is set on the item, not</span>
<a name="l04028"></a>04028                 <span class="comment">// the transaction, and since there are no other items that matter if this IS a success.</span>
<a name="l04029"></a>04029                 
<a name="l04030"></a>04030 <span class="comment">//          case OTItem::chequeReceipt:   // not needed in OTItem. Meaning, actual OTTransaction cheque receipts do NOT need a chequeReceipt Item attached....</span>
<a name="l04031"></a>04031             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6924070960c3d7889da9beaaa8484010">OTItem::chequeReceipt</a>:   <span class="comment">// ...but it&#39;s here anyway as a type, for dual use reasons (balance agreement sub-items. Like for an inbox report.)</span>
<a name="l04032"></a>04032             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a7d253a3cc42a3ac9f0c1a8e0e047610b">OTItem::voucherReceipt</a>:
<a name="l04033"></a>04033             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>:   <span class="comment">// Used for actual market receipts, as well as for balance agreement sub-items.</span>
<a name="l04034"></a>04034             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>:  <span class="comment">// Used for actual payment receipts, as well as for balance agreement sub-items.</span>
<a name="l04035"></a>04035             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6ccb74fdd8d6de9bdd3d4b20db8850be">OTItem::transferReceipt</a>: <span class="comment">// Used for actual transfer receipts, as well as for balance agreement sub-items. (Hmm does balance agreement need this?)</span>
<a name="l04036"></a>04036             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afb82e1e580788a5f6fa8450d81a74f0b">OTItem::finalReceipt</a>:    <span class="comment">// Used for actual final receipt (I think) as well as for balance agreement sub item (I think.)</span>
<a name="l04037"></a>04037             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>:   <span class="comment">// Used for basket receipt (I think) as well as for balance agreement sub-item (I think.)</span>
<a name="l04038"></a>04038                 
<a name="l04039"></a>04039             <span class="comment">// **************************************************************************</span>
<a name="l04040"></a>04040                 
<a name="l04041"></a>04041                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l04042"></a>04042                 {
<a name="l04043"></a>04043                     bFoundAnActionItem = <span class="keyword">true</span>;
<a name="l04044"></a>04044                 }
<a name="l04045"></a>04045                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l04046"></a>04046                 {
<a name="l04047"></a>04047                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04048"></a>04048                 }
<a name="l04049"></a>04049                 
<a name="l04050"></a>04050                 <span class="keywordflow">break</span>;
<a name="l04051"></a>04051                 
<a name="l04052"></a>04052             <span class="comment">// **************************************************************************</span>
<a name="l04053"></a>04053                 
<a name="l04054"></a>04054             <span class="keywordflow">default</span>:
<a name="l04055"></a>04055                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong transaction type passed to OTTransaction::GetSuccess()\n&quot;</span>);
<a name="l04056"></a>04056                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04057"></a>04057         }
<a name="l04058"></a>04058     }
<a name="l04059"></a>04059     
<a name="l04060"></a>04060     <span class="keywordflow">return</span> (bFoundABalanceAgreement &amp;&amp; bFoundAnActionItem);
<a name="l04061"></a>04061 }
<a name="l04062"></a>04062 
<a name="l04063"></a>04063 
<a name="l04064"></a>04064 <span class="comment">// Todo: eliminate this function since there is already a list of strings at the top</span>
<a name="l04065"></a>04065 <span class="comment">// of this file, and a list of enums at the top of the header file.</span>
<a name="l04066"></a>04066 <span class="comment">//</span>
<a name="l04067"></a>04067 <span class="comment">// static</span>
<a name="l04068"></a><a class="code" href="class_o_t_transaction.html#a806b1bd373a5777b5a41d5141e9e914d">04068</a> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a> <a class="code" href="class_o_t_transaction.html#a806b1bd373a5777b5a41d5141e9e914d">OTTransaction::GetTypeFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strType)
<a name="l04069"></a>04069 {
<a name="l04070"></a>04070     <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a> theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>;
<a name="l04071"></a>04071     
<a name="l04072"></a>04072     <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;blank&quot;</span>))
<a name="l04073"></a>04073         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>;
<a name="l04074"></a>04074 
<a name="l04075"></a>04075     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;message&quot;</span>))
<a name="l04076"></a>04076         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>;
<a name="l04077"></a>04077     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;notice&quot;</span>))
<a name="l04078"></a>04078         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>;
<a name="l04079"></a>04079     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;replyNotice&quot;</span>))
<a name="l04080"></a>04080         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>;
<a name="l04081"></a>04081     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;successNotice&quot;</span>))
<a name="l04082"></a>04082         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>;
<a name="l04083"></a>04083     <span class="comment">// --------------------------------------------------------------</span>
<a name="l04084"></a>04084     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;pending&quot;</span>))
<a name="l04085"></a>04085         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>;
<a name="l04086"></a>04086     <span class="comment">// --------------------------------------------------------------</span>
<a name="l04087"></a>04087     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;transferReceipt&quot;</span>))
<a name="l04088"></a>04088         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>;
<a name="l04089"></a>04089     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;voucherReceipt&quot;</span>))
<a name="l04090"></a>04090         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>;
<a name="l04091"></a>04091     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;chequeReceipt&quot;</span>))
<a name="l04092"></a>04092         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>;
<a name="l04093"></a>04093     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;marketReceipt&quot;</span>))
<a name="l04094"></a>04094         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>;
<a name="l04095"></a>04095     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;paymentReceipt&quot;</span>))
<a name="l04096"></a>04096         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>;
<a name="l04097"></a>04097     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;finalReceipt&quot;</span>))
<a name="l04098"></a>04098         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>;
<a name="l04099"></a>04099     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;basketReceipt&quot;</span>))
<a name="l04100"></a>04100         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>;
<a name="l04101"></a>04101     <span class="comment">// --------------------------------------------------------------</span>
<a name="l04102"></a>04102     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;instrumentNotice&quot;</span>))
<a name="l04103"></a>04103         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>;
<a name="l04104"></a>04104     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;instrumentRejection&quot;</span>))
<a name="l04105"></a>04105         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>;
<a name="l04106"></a>04106     <span class="comment">// --------------------------------------------------------------</span>
<a name="l04107"></a>04107     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;processNymbox&quot;</span>))
<a name="l04108"></a>04108         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac0914e62639aebd987882e21bdff890d">OTTransaction::processNymbox</a>;
<a name="l04109"></a>04109     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atProcessNymbox&quot;</span>))
<a name="l04110"></a>04110         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">OTTransaction::atProcessNymbox</a>;
<a name="l04111"></a>04111     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;processInbox&quot;</span>))
<a name="l04112"></a>04112         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>;
<a name="l04113"></a>04113     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atProcessInbox&quot;</span>))
<a name="l04114"></a>04114         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>;
<a name="l04115"></a>04115     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;transfer&quot;</span>))
<a name="l04116"></a>04116         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>;
<a name="l04117"></a>04117     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atTransfer&quot;</span>))
<a name="l04118"></a>04118         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>;
<a name="l04119"></a>04119     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deposit&quot;</span>))
<a name="l04120"></a>04120         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>;
<a name="l04121"></a>04121     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atDeposit&quot;</span>))
<a name="l04122"></a>04122         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>;
<a name="l04123"></a>04123     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;withdrawal&quot;</span>))
<a name="l04124"></a>04124         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>;
<a name="l04125"></a>04125     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atWithdrawal&quot;</span>))
<a name="l04126"></a>04126         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>;
<a name="l04127"></a>04127     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;marketOffer&quot;</span>))
<a name="l04128"></a>04128         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>;
<a name="l04129"></a>04129     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atMarketOffer&quot;</span>))
<a name="l04130"></a>04130         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>;
<a name="l04131"></a>04131     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;paymentPlan&quot;</span>))
<a name="l04132"></a>04132         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>;
<a name="l04133"></a>04133     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atPaymentPlan&quot;</span>))
<a name="l04134"></a>04134         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>;
<a name="l04135"></a>04135     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;smartContract&quot;</span>))
<a name="l04136"></a>04136         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>;
<a name="l04137"></a>04137     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atSmartContract&quot;</span>))
<a name="l04138"></a>04138         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>;
<a name="l04139"></a>04139     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;cancelCronItem&quot;</span>))
<a name="l04140"></a>04140         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>;
<a name="l04141"></a>04141     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atCancelCronItem&quot;</span>))
<a name="l04142"></a>04142         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>;
<a name="l04143"></a>04143     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;exchangeBasket&quot;</span>))
<a name="l04144"></a>04144         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>;
<a name="l04145"></a>04145     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atExchangeBasket&quot;</span>))
<a name="l04146"></a>04146         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>;
<a name="l04147"></a>04147     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;payDividend&quot;</span>))
<a name="l04148"></a>04148         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>;
<a name="l04149"></a>04149     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;atPayDividend&quot;</span>))
<a name="l04150"></a>04150         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>;
<a name="l04151"></a>04151     <span class="comment">// --------------------------------------------------------------   </span>
<a name="l04152"></a>04152     <span class="keywordflow">else</span>
<a name="l04153"></a>04153         theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>;
<a name="l04154"></a>04154     <span class="comment">// --------------------------------------------------------------</span>
<a name="l04155"></a>04155     
<a name="l04156"></a>04156     <span class="keywordflow">return</span> theType;
<a name="l04157"></a>04157 }
<a name="l04158"></a>04158 
<a name="l04159"></a>04159 
<a name="l04160"></a>04160 <span class="comment">// Returns 1 if success, -1 if error.</span>
<a name="l04161"></a>04161 <span class="comment">//static</span>
<a name="l04162"></a><a class="code" href="class_o_t_transaction.html#aa0726f273b313b03bad0390ed2b8bb19">04162</a> int32_t <a class="code" href="class_o_t_transaction.html#aa0726f273b313b03bad0390ed2b8bb19">OTTransaction::LoadAbbreviatedRecord</a>(<a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>*&amp; xml,
<a name="l04163"></a>04163                                          int64_t    &amp; lNumberOfOrigin,
<a name="l04164"></a>04164                                          int64_t    &amp; lTransactionNum,
<a name="l04165"></a>04165                                          int64_t    &amp; lInRefTo,
<a name="l04166"></a>04166                                          int64_t    &amp; lInRefDisplay,
<a name="l04167"></a>04167                                          <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>   &amp; the_DATE_SIGNED,
<a name="l04168"></a>04168                                          <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a> &amp; theType,
<a name="l04169"></a>04169                                          <a class="code" href="class_o_t_string.html">OTString</a> &amp; strHash,
<a name="l04170"></a>04170                                          int64_t    &amp; lAdjustment,
<a name="l04171"></a>04171                                          int64_t    &amp; lDisplayValue,
<a name="l04172"></a>04172                                          int64_t    &amp; lClosingNum,
<a name="l04173"></a>04173                                          int64_t   &amp; lRequestNum,
<a name="l04174"></a>04174                                          <span class="keywordtype">bool</span>   &amp; bReplyTransSuccess,
<a name="l04175"></a>04175                                          <a class="code" href="class_o_t_num_list.html">OTNumList</a> * pNumList<span class="comment">/*=NULL*/</span>)
<a name="l04176"></a>04176 {
<a name="l04177"></a>04177     <span class="comment">// -------------------------------------</span>
<a name="l04178"></a>04178     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strOrigin        = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numberOfOrigin&quot;</span>);
<a name="l04179"></a>04179     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransNum      = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;transactionNum&quot;</span>);
<a name="l04180"></a>04180     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInRefTo       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;inReferenceTo&quot;</span>);
<a name="l04181"></a>04181     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInRefDisplay  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;inRefDisplay&quot;</span>);
<a name="l04182"></a>04182     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;dateSigned&quot;</span>);
<a name="l04183"></a>04183     <span class="comment">// -------------------------------------</span>
<a name="l04184"></a>04184     <span class="keywordflow">if</span> (!strTransNum.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strInRefTo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strInRefDisplay.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strDateSigned.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04185"></a>04185     {
<a name="l04186"></a>04186         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failure: missing strTransNum (%s) or strInRefTo (%s) &quot;</span>
<a name="l04187"></a>04187                        <span class="stringliteral">&quot;or strInRefDisplay (%s) or strDateSigned(%s) while loading abbreviated receipt. \n&quot;</span>,
<a name="l04188"></a>04188                        strTransNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strInRefTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strInRefDisplay.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04189"></a>04189         <span class="keywordflow">return</span> (-1);            
<a name="l04190"></a>04190     }
<a name="l04191"></a>04191     lTransactionNum     = atol(strTransNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04192"></a>04192     lInRefTo            = atol(strInRefTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04193"></a>04193     lInRefDisplay       = atol(strInRefDisplay.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04194"></a>04194     
<a name="l04195"></a>04195     <span class="keywordflow">if</span> (strOrigin.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04196"></a>04196         lNumberOfOrigin = atol(strOrigin.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04197"></a>04197     <span class="comment">// -------------------------------------</span>
<a name="l04198"></a>04198     <span class="comment">// DATE SIGNED</span>
<a name="l04199"></a>04199     the_DATE_SIGNED = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// (We already verified it Exists() just above.)</span>
<a name="l04200"></a>04200     <span class="comment">// -------------------------------------</span>
<a name="l04201"></a>04201     <span class="comment">// Transaction TYPE for the abbreviated record...</span>
<a name="l04202"></a>04202     theType                 = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>; <span class="comment">// default</span>
<a name="l04203"></a>04203     <span class="keyword">const</span>
<a name="l04204"></a>04204     <a class="code" href="class_o_t_string.html">OTString</a> strAbbrevType  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;type&quot;</span>); <span class="comment">// the type of inbox receipt, or outbox receipt, or nymbox receipt. (Transaction type.)</span>
<a name="l04205"></a>04205     <span class="keywordflow">if</span> (strAbbrevType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04206"></a>04206     {
<a name="l04207"></a>04207         theType = <a class="code" href="class_o_t_transaction.html#a806b1bd373a5777b5a41d5141e9e914d">OTTransaction::GetTypeFromString</a>(strAbbrevType);
<a name="l04208"></a>04208 
<a name="l04209"></a>04209         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a> == theType)
<a name="l04210"></a>04210         {
<a name="l04211"></a>04211             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failure: OTTransaction::error_state was the found type (based on &quot;</span>
<a name="l04212"></a>04212                           <span class="stringliteral">&quot;string %s), when loading abbreviated receipt for trans num: %lld (In Reference To: %lld) \n&quot;</span>,
<a name="l04213"></a>04213                           strAbbrevType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), lTransactionNum, lInRefTo);
<a name="l04214"></a>04214             <span class="keywordflow">return</span> (-1);
<a name="l04215"></a>04215         }
<a name="l04216"></a>04216     }
<a name="l04217"></a>04217     <span class="keywordflow">else</span> 
<a name="l04218"></a>04218     {
<a name="l04219"></a>04219         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failure: unknown transaction type (%s) when &quot;</span>
<a name="l04220"></a>04220                        <span class="stringliteral">&quot;loading abbreviated receipt for trans num: %lld (In Reference To: %lld) \n&quot;</span>,
<a name="l04221"></a>04221                        strAbbrevType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), lTransactionNum, lInRefTo);
<a name="l04222"></a>04222         <span class="keywordflow">return</span> (-1);
<a name="l04223"></a>04223     }
<a name="l04224"></a>04224     <span class="comment">// -------------------------------------</span>
<a name="l04225"></a>04225     <span class="comment">// RECEIPT HASH</span>
<a name="l04226"></a>04226     <span class="comment">//</span>
<a name="l04227"></a>04227     strHash = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;receiptHash&quot;</span>);
<a name="l04228"></a>04228     <span class="keywordflow">if</span> (!strHash.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04229"></a>04229     {
<a name="l04230"></a>04230         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failure: Expected receiptHash while loading &quot;</span>
<a name="l04231"></a>04231                        <span class="stringliteral">&quot;abbreviated receipt for trans num: %lld (In Reference To: %lld)\n&quot;</span>, lTransactionNum,
<a name="l04232"></a>04232                        lInRefTo);
<a name="l04233"></a>04233         <span class="keywordflow">return</span> (-1);            
<a name="l04234"></a>04234     }
<a name="l04235"></a>04235     <span class="comment">// -------------------------------------</span>
<a name="l04236"></a>04236     lAdjustment     = 0;
<a name="l04237"></a>04237     lDisplayValue   = 0;
<a name="l04238"></a>04238     lClosingNum     = 0;
<a name="l04239"></a>04239     <span class="comment">// -------------------------------------</span>
<a name="l04240"></a>04240     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAbbrevAdjustment      = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;adjustment&quot;</span>);
<a name="l04241"></a>04241     <span class="keywordflow">if</span> (strAbbrevAdjustment.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04242"></a>04242         lAdjustment                         = atol(strAbbrevAdjustment.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04243"></a>04243     <span class="comment">// -------------------------------------    </span>
<a name="l04244"></a>04244     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAbbrevDisplayValue    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;displayValue&quot;</span>);
<a name="l04245"></a>04245     <span class="keywordflow">if</span> (strAbbrevDisplayValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04246"></a>04246         lDisplayValue                       = atol(strAbbrevDisplayValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04247"></a>04247     <span class="comment">// -------------------------------------------------------------------------</span>
<a name="l04248"></a>04248     
<a name="l04249"></a>04249     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a> == theType)
<a name="l04250"></a>04250     {
<a name="l04251"></a>04251         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRequestNum = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;requestNumber&quot;</span>);
<a name="l04252"></a>04252         
<a name="l04253"></a>04253         <span class="keywordflow">if</span> (!strRequestNum.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04254"></a>04254         {
<a name="l04255"></a>04255             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failed loading abbreviated receipt: &quot;</span>
<a name="l04256"></a>04256                            <span class="stringliteral">&quot;expected requestNumber on replyNotice trans num: %lld (In Reference To: %lld)\n&quot;</span>,
<a name="l04257"></a>04257                            lTransactionNum, lInRefTo);
<a name="l04258"></a>04258             <span class="keywordflow">return</span> (-1);
<a name="l04259"></a>04259         }
<a name="l04260"></a>04260         lRequestNum = atol(strRequestNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04261"></a>04261         <span class="comment">// ----------------------------------------</span>
<a name="l04262"></a>04262         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransSuccess = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;transSuccess&quot;</span>);
<a name="l04263"></a>04263 
<a name="l04264"></a>04264         bReplyTransSuccess  = strTransSuccess.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>);
<a name="l04265"></a>04265     } <span class="comment">// if replyNotice (expecting request Number)</span>
<a name="l04266"></a>04266     <span class="comment">// -------------------------------------</span>
<a name="l04267"></a>04267 
<a name="l04268"></a>04268     <span class="comment">// If the transaction is a certain type, then it will also have a CLOSING number. </span>
<a name="l04269"></a>04269     <span class="comment">// (Grab that too.)</span>
<a name="l04270"></a>04270     <span class="comment">//</span>
<a name="l04271"></a>04271     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>    == theType) || 
<a name="l04272"></a>04272         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>   == theType))
<a name="l04273"></a>04273     {
<a name="l04274"></a>04274         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAbbrevClosingNum = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;closingNum&quot;</span>);
<a name="l04275"></a>04275         
<a name="l04276"></a>04276         <span class="keywordflow">if</span> (!strAbbrevClosingNum.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04277"></a>04277         {
<a name="l04278"></a>04278             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::LoadAbbreviatedRecord: Failed loading abbreviated receipt: &quot;</span>
<a name="l04279"></a>04279                            <span class="stringliteral">&quot;expected closingNum on trans num: %lld (In Reference To: %lld)\n&quot;</span>,
<a name="l04280"></a>04280                            lTransactionNum, lInRefTo);
<a name="l04281"></a>04281             <span class="keywordflow">return</span> (-1);
<a name="l04282"></a>04282         }
<a name="l04283"></a>04283         lClosingNum = atol(strAbbrevClosingNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04284"></a>04284     } <span class="comment">// if finalReceipt or basketReceipt (expecting closing num)</span>
<a name="l04285"></a>04285     <span class="comment">// -------------------------------------</span>
<a name="l04286"></a>04286     <span class="comment">// These types carry their own internal list of numbers.</span>
<a name="l04287"></a>04287     <span class="comment">//</span>
<a name="l04288"></a>04288     <span class="keywordflow">if</span> ((NULL != pNumList) &amp;&amp;
<a name="l04289"></a>04289         ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>           == theType) || 
<a name="l04290"></a>04290          (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>   == theType))
<a name="l04291"></a>04291         )
<a name="l04292"></a>04292     {
<a name="l04293"></a>04293         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNumbers = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;totalListOfNumbers&quot;</span>);
<a name="l04294"></a>04294         pNumList-&gt;<a class="code" href="class_o_t_num_list.html#ab90b486b8dc6ac66a34724c6da4f7ec5">Release</a>();
<a name="l04295"></a>04295         
<a name="l04296"></a>04296         <span class="keywordflow">if</span> (strNumbers.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04297"></a>04297             pNumList-&gt;Add(strNumbers);
<a name="l04298"></a>04298     } <span class="comment">// if blank or successNotice (expecting totalListOfNumbers.. no more multiple blanks in the same ledger! They all go in a single transaction.)</span>
<a name="l04299"></a>04299     <span class="comment">// -------------------------------------</span>
<a name="l04300"></a>04300     
<a name="l04301"></a>04301     <span class="keywordflow">return</span> 1;
<a name="l04302"></a>04302 }
<a name="l04303"></a>04303 
<a name="l04304"></a>04304 
<a name="l04305"></a>04305 <span class="comment">/*</span>
<a name="l04306"></a>04306 <span class="comment"> bool               m_bIsAbbreviated;   </span>
<a name="l04307"></a>04307 <span class="comment"> int64_t                m_lAbbrevAmount; // adjustment. </span>
<a name="l04308"></a>04308 <span class="comment"> int64_t                m_lDisplayAmount; // a $50 receipt, is +50 adjustment in the outbox, and -50 adjustment in the inbox, but 50 in the display.</span>
<a name="l04309"></a>04309 <span class="comment"> int64_t                m_lInRefDisplay;  // The &quot;In Ref For Display&quot; value</span>
<a name="l04310"></a>04310 <span class="comment"> OTIdentifier       m_Hash;         // todo: make this const and force it to be set during construction.</span>
<a name="l04311"></a>04311 <span class="comment"> time64_t               m_DATE_SIGNED;  // The date, in seconds, when the instrument was last signed.   </span>
<a name="l04312"></a>04312 <span class="comment"> transactionType    m_Type;         // blank, pending, processInbox, transfer, deposit, withdrawal, trade, payDividend, etc.</span>
<a name="l04313"></a>04313 <span class="comment"> int64_t                m_lClosingTransactionNo;    // used by finalReceipt</span>
<a name="l04314"></a>04314 <span class="comment"> */</span>
<a name="l04315"></a>04315 
<a name="l04316"></a>04316 <span class="comment">// return -1 if error, 0 if nothing, and 1 if the node was processed.</span>
<a name="l04317"></a><a class="code" href="class_o_t_transaction.html#a18d4d5da09f16aac3ccb97984ec021b1">04317</a> int32_t <a class="code" href="class_o_t_transaction.html#a18d4d5da09f16aac3ccb97984ec021b1">OTTransaction::ProcessXMLNode</a>(<a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>*&amp; xml)
<a name="l04318"></a>04318 {   
<a name="l04319"></a>04319     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNodeName = xml-&gt;getNodeName();
<a name="l04320"></a>04320     
<a name="l04321"></a>04321     <a class="code" href="class_o_t_num_list.html">OTNumList</a> * pNumList = NULL;
<a name="l04322"></a>04322     <span class="keywordflow">if</span> (strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;nymboxRecord&quot;</span>))
<a name="l04323"></a>04323     {
<a name="l04324"></a>04324         pNumList = &amp;<a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>;
<a name="l04325"></a>04325     }
<a name="l04326"></a>04326     <span class="comment">// -----------------------------------------</span>
<a name="l04327"></a>04327     
<a name="l04328"></a>04328     <span class="keywordflow">if</span> (strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;nymboxRecord&quot;</span>)         ||
<a name="l04329"></a>04329         strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;inboxRecord&quot;</span>)          ||
<a name="l04330"></a>04330         strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;outboxRecord&quot;</span>)         ||
<a name="l04331"></a>04331         strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;paymentInboxRecord&quot;</span>)   ||
<a name="l04332"></a>04332         strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;recordBoxRecord&quot;</span>)      ||
<a name="l04333"></a>04333         strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;expiredBoxRecord&quot;</span>))
<a name="l04334"></a>04334     {
<a name="l04335"></a>04335         int64_t lNumberOfOrigin = 0;
<a name="l04336"></a>04336         int64_t lTransactionNum = 0;
<a name="l04337"></a>04337         int64_t lInRefTo            = 0;
<a name="l04338"></a>04338         int64_t lInRefDisplay       = 0;
<a name="l04339"></a>04339         <span class="comment">// -------------------------------------</span>
<a name="l04340"></a>04340         <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> the_DATE_SIGNED    = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l04341"></a>04341         <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8">OTTransaction::transactionType</a> theType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTTransaction::error_state</a>; <span class="comment">// default</span>
<a name="l04342"></a>04342         <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l04343"></a>04343         <span class="comment">// -------------------------------------</span>
<a name="l04344"></a>04344         int64_t lAdjustment     = 0;
<a name="l04345"></a>04345         int64_t lDisplayValue       = 0;
<a name="l04346"></a>04346         int64_t lClosingNum     = 0;
<a name="l04347"></a>04347         int64_t lRequestNumber     = 0;
<a name="l04348"></a>04348         <span class="keywordtype">bool</span> bReplyTransSuccess = <span class="keyword">false</span>;
<a name="l04349"></a>04349         <span class="comment">// -------------------------------------</span>
<a name="l04350"></a>04350         int32_t nAbbrevRetVal =
<a name="l04351"></a>04351             <a class="code" href="class_o_t_transaction.html#aa0726f273b313b03bad0390ed2b8bb19">OTTransaction::LoadAbbreviatedRecord</a>(xml,
<a name="l04352"></a>04352                                                  lNumberOfOrigin,
<a name="l04353"></a>04353                                                  lTransactionNum,
<a name="l04354"></a>04354                                                  lInRefTo,
<a name="l04355"></a>04355                                                  lInRefDisplay,
<a name="l04356"></a>04356                                                  the_DATE_SIGNED,
<a name="l04357"></a>04357                                                  theType,
<a name="l04358"></a>04358                                                  strHash,
<a name="l04359"></a>04359                                                  lAdjustment,
<a name="l04360"></a>04360                                                  lDisplayValue,
<a name="l04361"></a>04361                                                  lClosingNum,
<a name="l04362"></a>04362                                                  lRequestNumber,
<a name="l04363"></a>04363                                                  bReplyTransSuccess,
<a name="l04364"></a>04364                                                  pNumList); <span class="comment">// for &quot;OTTransaction::blank&quot; and &quot;OTTransaction::successNotice&quot; (Otherwise NULL.)</span>
<a name="l04365"></a>04365         <span class="comment">// -------------------------------------</span>
<a name="l04366"></a>04366         <span class="keywordflow">if</span> ((-1) == nAbbrevRetVal)
<a name="l04367"></a>04367             <span class="keywordflow">return</span> (-1); <span class="comment">// The function already logs appropriately.</span>
<a name="l04368"></a>04368         <span class="comment">// -------------------------------------</span>
<a name="l04369"></a>04369         <a class="code" href="class_o_t_transaction.html#a1298e2f51b0a9471bc6b1aa8905b70f9">m_bIsAbbreviated</a>    = <span class="keyword">true</span>; <span class="comment">// &lt;======================</span>
<a name="l04370"></a>04370 
<a name="l04371"></a>04371         <a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(lNumberOfOrigin);
<a name="l04372"></a>04372         <a class="code" href="class_o_t_transaction_type.html#ae040aebddfa217a4fe5e349804f241e3">SetTransactionNum</a>(lTransactionNum);
<a name="l04373"></a>04373         <a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lInRefTo);
<a name="l04374"></a>04374         <a class="code" href="class_o_t_transaction.html#af3c025bbdeb70a053c6149a32d8b9940">SetClosingNum</a>(lClosingNum);
<a name="l04375"></a>04375         <a class="code" href="class_o_t_transaction.html#a8db20f109eab5bf715673bfcf3b3bb4f">SetRequestNum</a>(lRequestNumber);
<a name="l04376"></a>04376         
<a name="l04377"></a>04377         <a class="code" href="class_o_t_transaction.html#a3099413a51aa3ec99b783a4e89144150">SetReplyTransSuccess</a>(bReplyTransSuccess);
<a name="l04378"></a>04378         
<a name="l04379"></a>04379         <a class="code" href="class_o_t_transaction.html#a73e1013374088a3a36fb83007a80c4bf">m_lInRefDisplay</a>     = lInRefDisplay;
<a name="l04380"></a>04380         <a class="code" href="class_o_t_transaction.html#ae1f24fb2a4460c4b695e7628fc78890e">m_lAbbrevAmount</a>     = lAdjustment;
<a name="l04381"></a>04381         <a class="code" href="class_o_t_transaction.html#a0fd4b204101be3362541aa18ecdfbcfe">m_lDisplayAmount</a>    = lDisplayValue;
<a name="l04382"></a>04382         <a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>       = the_DATE_SIGNED;
<a name="l04383"></a>04383         <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>              = theType;
<a name="l04384"></a>04384         
<a name="l04385"></a>04385         <span class="keywordflow">if</span> (strHash.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04386"></a>04386             <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strHash);
<a name="l04387"></a>04387         <span class="keywordflow">else</span>
<a name="l04388"></a>04388             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::ProcessXMLNode: Missing receiptHash on abbreviated record.\n&quot;</span>);
<a name="l04389"></a>04389         
<a name="l04390"></a>04390         <span class="keywordflow">return</span> 1;
<a name="l04391"></a>04391     }
<a name="l04392"></a>04392     
<a name="l04393"></a>04393     <span class="comment">// ******************************************************</span>
<a name="l04394"></a>04394     <span class="comment">// THIS PART is probably what you&#39;re looking for.</span>
<a name="l04395"></a>04395     <span class="comment">//</span>
<a name="l04396"></a>04396     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strNodeName.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;transaction&quot;</span>)) <span class="comment">// Todo:  notice how this &quot;else if&quot; uses OTString::Compare, where most other ProcessXMLNode functions in OT use !strcmp()? (That&#39;s right: Buffer overflow. Need to fix elsewhere as it is fixed here.)</span>
<a name="l04397"></a>04397     {   
<a name="l04398"></a>04398         <span class="comment">// -------------------------------------</span>
<a name="l04399"></a>04399         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strType = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;type&quot;</span>);
<a name="l04400"></a>04400         
<a name="l04401"></a>04401         <span class="keywordflow">if</span> (strType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04402"></a>04402             <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a> = <a class="code" href="class_o_t_transaction.html#a806b1bd373a5777b5a41d5141e9e914d">OTTransaction::GetTypeFromString</a>(strType);
<a name="l04403"></a>04403         <span class="keywordflow">else</span> 
<a name="l04404"></a>04404         {
<a name="l04405"></a>04405             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::ProcessXMLNode: Failure: unknown transaction type: %s \n&quot;</span>,
<a name="l04406"></a>04406                            strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04407"></a>04407             <span class="keywordflow">return</span> (-1);
<a name="l04408"></a>04408         }
<a name="l04409"></a>04409         <span class="comment">// -------------------------------------</span>
<a name="l04410"></a>04410         <a class="code" href="class_o_t_string.html">OTString</a> strCancelled   = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;cancelled&quot;</span>);
<a name="l04411"></a>04411         <span class="keywordflow">if</span> (strCancelled.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; strCancelled.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>))
<a name="l04412"></a>04412             <a class="code" href="class_o_t_transaction.html#ae02e3420135cba3514b4131d6427641d">m_bCancelled</a> = <span class="keyword">true</span>;
<a name="l04413"></a>04413         <span class="keywordflow">else</span>
<a name="l04414"></a>04414             <a class="code" href="class_o_t_transaction.html#ae02e3420135cba3514b4131d6427641d">m_bCancelled</a> = <span class="keyword">false</span>;
<a name="l04415"></a>04415         <span class="comment">// -------------------------------------</span>
<a name="l04416"></a>04416         <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;dateSigned&quot;</span>);
<a name="l04417"></a>04417         <span class="keyword">const</span> int64_t lDateSigned   = strDateSigned.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atol(strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l04418"></a>04418         <a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>           = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(lDateSigned); <span class="comment">// Todo casting ?</span>
<a name="l04419"></a>04419         <span class="comment">// -------------------------------------</span>
<a name="l04420"></a>04420         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;accountID&quot;</span>); 
<a name="l04421"></a>04421         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverID&quot;</span>);
<a name="l04422"></a>04422         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;userID&quot;</span>);
<a name="l04423"></a>04423         <span class="comment">// -------------------------------------</span>
<a name="l04424"></a>04424         <span class="keywordflow">if</span> (!strAcctID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strServerID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strUserID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04425"></a>04425         {
<a name="l04426"></a>04426             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::ProcessXMLNode: Failure: missing strAcctID (%s) or strServerID (%s) or strUserID (%s). \n&quot;</span>,
<a name="l04427"></a>04427                            strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04428"></a>04428             <span class="keywordflow">return</span> (-1);            
<a name="l04429"></a>04429         }
<a name="l04430"></a>04430         <span class="comment">// -------------------------------------        </span>
<a name="l04431"></a>04431         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strOrigin    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numberOfOrigin&quot;</span>);
<a name="l04432"></a>04432         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransNum  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;transactionNum&quot;</span>);
<a name="l04433"></a>04433         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInRefTo   = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;inReferenceTo&quot;</span>);
<a name="l04434"></a>04434         <span class="comment">// -------------------------------------</span>
<a name="l04435"></a>04435         <span class="keywordflow">if</span> (!strTransNum.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strInRefTo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04436"></a>04436         {
<a name="l04437"></a>04437             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTTransaction::ProcessXMLNode: Failure: missing strTransNum (%s) or strInRefTo (%s). \n&quot;</span>,
<a name="l04438"></a>04438                            strTransNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strInRefTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04439"></a>04439             <span class="keywordflow">return</span> (-1);            
<a name="l04440"></a>04440         }
<a name="l04441"></a>04441         <span class="comment">// -------------------------------------    </span>
<a name="l04442"></a>04442         
<a name="l04443"></a>04443         <span class="comment">// a replyNotice (a copy of the server&#39;s reply to one of my messages)</span>
<a name="l04444"></a>04444         <span class="comment">// is often dropped into my Nymbox, to make sure I see it. Usually these</span>
<a name="l04445"></a>04445         <span class="comment">// have a REQUEST NUMBER on them, so I can quickly tell WHICH MESSAGE</span>
<a name="l04446"></a>04446         <span class="comment">// it is in reply to.</span>
<a name="l04447"></a>04447         <span class="comment">//</span>
<a name="l04448"></a>04448         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>)
<a name="l04449"></a>04449         {
<a name="l04450"></a>04450             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRequestNum = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;requestNumber&quot;</span>);
<a name="l04451"></a>04451 
<a name="l04452"></a>04452             <span class="keywordflow">if</span> (strRequestNum.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04453"></a>04453                 <a class="code" href="class_o_t_transaction.html#a6fc95646e555b9c2ffb1404c6475ef56">m_lRequestNumber</a> = atol(strRequestNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04454"></a>04454             
<a name="l04455"></a>04455             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransSuccess = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;transSuccess&quot;</span>);
<a name="l04456"></a>04456 
<a name="l04457"></a>04457             <a class="code" href="class_o_t_transaction.html#a1631d08ab9b9759c5743fa0bfe9f7bdf">m_bReplyTransSuccess</a>    = strTransSuccess.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>);
<a name="l04458"></a>04458         }
<a name="l04459"></a>04459         
<a name="l04460"></a>04460         <span class="comment">// -------------------------------------    </span>
<a name="l04461"></a>04461 
<a name="l04462"></a>04462         <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>           == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || 
<a name="l04463"></a>04463             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>   == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>))
<a name="l04464"></a>04464         {
<a name="l04465"></a>04465             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTotalList     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;totalListOfNumbers&quot;</span>);
<a name="l04466"></a>04466             <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.<a class="code" href="class_o_t_num_list.html#ab90b486b8dc6ac66a34724c6da4f7ec5">Release</a>();
<a name="l04467"></a>04467             
<a name="l04468"></a>04468             <span class="keywordflow">if</span> (strTotalList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04469"></a>04469                 <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.Add(strTotalList); <span class="comment">// (Comma-separated list of numbers now becomes std::set&lt;int64_t&gt;.)</span>
<a name="l04470"></a>04470         }
<a name="l04471"></a>04471    
<a name="l04472"></a>04472         <span class="comment">// -------------------------------------    </span>
<a name="l04473"></a>04473         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strAcctID), SERVER_ID(strServerID), USER_ID(strUserID);
<a name="l04474"></a>04474         <span class="comment">// -------------------------------------        </span>
<a name="l04475"></a>04475         <a class="code" href="class_o_t_transaction_type.html#a80e0cd6a62cb0749526db848a3551bfe">SetPurportedAccountID</a>(ACCOUNT_ID);  <span class="comment">// GetPurportedAccountID() const { return m_AcctID; }</span>
<a name="l04476"></a>04476         <a class="code" href="class_o_t_transaction_type.html#aae055609a4aa9b78567621209bc3fea1">SetPurportedServerID</a>(SERVER_ID);    <span class="comment">// GetPurportedServerID() const { return m_AcctServerID; }</span>
<a name="l04477"></a>04477         <a class="code" href="class_o_t_transaction_type.html#a7bf07ca057376707a33b7a44447a4334">SetUserID</a>(USER_ID);
<a name="l04478"></a>04478         <span class="comment">// -------------------------------------------</span>
<a name="l04479"></a>04479         <span class="comment">//  m_bLoadSecurely defaults to true.</span>
<a name="l04480"></a>04480         <span class="comment">// Normally the RealAccountID and RealServerID are set from above, before</span>
<a name="l04481"></a>04481         <span class="comment">// loading. That way, I can compare them to whatever is actually loaded.</span>
<a name="l04482"></a>04482         <span class="comment">// (So people don&#39;t swap files on us!!)</span>
<a name="l04483"></a>04483         <span class="comment">// But if the coder SPECIALLY sets  m_bLoadSecurely to FALSE, that means he</span>
<a name="l04484"></a>04484         <span class="comment">// honestly doesn&#39;t know those IDs, and he is loading the file, and he wants it</span>
<a name="l04485"></a>04485         <span class="comment">// to load up properly AS IF THE IDs IN THE FILE WERE CORRECT. He only does this</span>
<a name="l04486"></a>04486         <span class="comment">// because it&#39;s the only way to get the file loaded without knowing those IDs in</span>
<a name="l04487"></a>04487         <span class="comment">// advance, and because he takes care, when doing this, to check them after the fact</span>
<a name="l04488"></a>04488         <span class="comment">// and see if they are, indeed, the ones he was expecting.</span>
<a name="l04489"></a>04489         <span class="comment">//</span>
<a name="l04490"></a>04490         <span class="comment">// This mechanism was ONLY FINALLY ADDED to get the class factory working properly.</span>
<a name="l04491"></a>04491         <span class="comment">// And even in this case, it is still INTERNALLY CONSISTENT. (The sub-items will still</span>
<a name="l04492"></a>04492         <span class="comment">// be expected to be correct with their parent items.)</span>
<a name="l04493"></a>04493         <span class="comment">//</span>
<a name="l04494"></a>04494         <span class="keywordflow">if</span> (<span class="keyword">false</span> ==  <a class="code" href="class_o_t_transaction_type.html#a05be1cf5d51725a4b427d5ac9714234b">m_bLoadSecurely</a>)
<a name="l04495"></a>04495         {
<a name="l04496"></a>04496             <a class="code" href="class_o_t_transaction_type.html#ab9c7df06d15e6dbeb53b3b3d87c13c83">SetRealAccountID</a>(ACCOUNT_ID);
<a name="l04497"></a>04497             <a class="code" href="class_o_t_transaction_type.html#a95c29dde80e19aa9b24c4e92f29a766e">SetRealServerID</a>(SERVER_ID);
<a name="l04498"></a>04498         }
<a name="l04499"></a>04499         <span class="comment">// -------------------------------------------</span>
<a name="l04500"></a>04500 
<a name="l04501"></a>04501         <span class="keywordflow">if</span> (strOrigin.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04502"></a>04502             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(atol(strOrigin.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l04503"></a>04503             
<a name="l04504"></a>04504         this-&gt;<a class="code" href="class_o_t_transaction_type.html#ae040aebddfa217a4fe5e349804f241e3">SetTransactionNum</a>(atol(strTransNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l04505"></a>04505         this-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(atol(strInRefTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l04506"></a>04506         
<a name="l04507"></a>04507         <span class="comment">// -------------------------------------        </span>
<a name="l04508"></a>04508         <span class="comment">/*  From UpdateContents() (there is writing, above is reading):</span>
<a name="l04509"></a>04509 <span class="comment">         </span>
<a name="l04510"></a>04510 <span class="comment">            OTString    strAcctID(GetPurportedAccountID()), </span>
<a name="l04511"></a>04511 <span class="comment">                        strServerID(GetPurportedServerID()),</span>
<a name="l04512"></a>04512 <span class="comment">                        strUserID(GetUserID());</span>
<a name="l04513"></a>04513 <span class="comment"></span>
<a name="l04514"></a>04514 <span class="comment">            m_xmlUnsigned.Concatenate(&quot;&lt;transaction type=\&quot;%s\&quot;\n&quot;</span>
<a name="l04515"></a>04515 <span class="comment">                              &quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04516"></a>04516 <span class="comment">                              &quot; accountID=\&quot;%s\&quot;\n&quot;</span>
<a name="l04517"></a>04517 <span class="comment">                              &quot; userID=\&quot;%s\&quot;\n&quot;</span>
<a name="l04518"></a>04518 <span class="comment">                              &quot; serverID=\&quot;%s\&quot;\n&quot;</span>
<a name="l04519"></a>04519 <span class="comment">                              &quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04520"></a>04520 <span class="comment">                              &quot; inReferenceTo=\&quot;%lld\&quot; &gt;\n\n&quot;, </span>
<a name="l04521"></a>04521 <span class="comment">                              strType.Get(), lDateSigned, </span>
<a name="l04522"></a>04522 <span class="comment">                              strAcctID.Get(),      // GetPurportedAccountID() const { return m_AcctID; }</span>
<a name="l04523"></a>04523 <span class="comment">                              strUserID.Get(), </span>
<a name="l04524"></a>04524 <span class="comment">                              strServerID.Get(),    // GetPurportedServerID() const { return m_AcctServerID; }</span>
<a name="l04525"></a>04525 <span class="comment">                              GetTransactionNum(),</span>
<a name="l04526"></a>04526 <span class="comment">                              GetReferenceToNum());</span>
<a name="l04527"></a>04527 <span class="comment"></span>
<a name="l04528"></a>04528 <span class="comment">         From OTTransactionType.h:</span>
<a name="l04529"></a>04529 <span class="comment">            const OTIdentifier &amp; GetUserID() const { return m_AcctUserID; } </span>
<a name="l04530"></a>04530 <span class="comment">            const OTIdentifier &amp; GetRealAccountID() const { return m_ID; }</span>
<a name="l04531"></a>04531 <span class="comment">            const OTIdentifier &amp; GetRealServerID() const { return m_ServerID; }</span>
<a name="l04532"></a>04532 <span class="comment">            const OTIdentifier &amp; GetPurportedAccountID() const { return m_AcctID; }</span>
<a name="l04533"></a>04533 <span class="comment">            const OTIdentifier &amp; GetPurportedServerID() const { return m_AcctServerID; }</span>
<a name="l04534"></a>04534 <span class="comment"></span>
<a name="l04535"></a>04535 <span class="comment">         */</span>
<a name="l04536"></a>04536         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;Loaded transaction %lld, in reference to: %lld type: %s\n&quot;</span>,
<a name="l04537"></a>04537 <span class="comment">//              &quot;accountID:\n%s\n serverID:\n%s\n----------\n&quot;, </span>
<a name="l04538"></a>04538                 <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l04539"></a>04539                 <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()
<a name="l04540"></a>04540 <span class="comment">//              strAcctID.Get(), strServerID.Get()</span>
<a name="l04541"></a>04541                 );
<a name="l04542"></a>04542         
<a name="l04543"></a>04543         <span class="keywordflow">return</span> 1;
<a name="l04544"></a>04544     }   
<a name="l04545"></a>04545     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;closingTransactionNumber&quot;</span>, xml-&gt;getNodeName())) 
<a name="l04546"></a>04546     {       
<a name="l04547"></a>04547         <a class="code" href="class_o_t_string.html">OTString</a> strClosingNumber = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;value&quot;</span>);
<a name="l04548"></a>04548         
<a name="l04549"></a>04549         <span class="keywordflow">if</span> (strClosingNumber.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
<a name="l04550"></a>04550             ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>)))
<a name="l04551"></a>04551         {
<a name="l04552"></a>04552             <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a> = atol(strClosingNumber.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04553"></a>04553         }
<a name="l04554"></a>04554         <span class="keywordflow">else</span>
<a name="l04555"></a>04555         {
<a name="l04556"></a>04556             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error in OTTransaction::ProcessXMLNode: closingTransactionNumber field without value, or in wrong transaction type.\n&quot;</span>);
<a name="l04557"></a>04557             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l04558"></a>04558         }
<a name="l04559"></a>04559         
<a name="l04560"></a>04560         <span class="keywordflow">return</span> 1;
<a name="l04561"></a>04561     }
<a name="l04562"></a>04562     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;cancelRequest&quot;</span>, xml-&gt;getNodeName())) 
<a name="l04563"></a>04563     {       
<a name="l04564"></a>04564         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, <a class="code" href="class_o_t_transaction.html#a115f7417f09e3e815212d770e7b60a1b">m_ascCancellationRequest</a>))
<a name="l04565"></a>04565         {
<a name="l04566"></a>04566             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error in OTTransaction::ProcessXMLNode: cancelRequest field without value.\n&quot;</span>);
<a name="l04567"></a>04567             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l04568"></a>04568         }
<a name="l04569"></a>04569         
<a name="l04570"></a>04570         <span class="keywordflow">return</span> 1;
<a name="l04571"></a>04571     }
<a name="l04572"></a>04572     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;inReferenceTo&quot;</span>, xml-&gt;getNodeName())) 
<a name="l04573"></a>04573     {       
<a name="l04574"></a>04574         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, <a class="code" href="class_o_t_transaction_type.html#a314901e59fc89a31f3cea2d956dac8b8">m_ascInReferenceTo</a>))
<a name="l04575"></a>04575         {
<a name="l04576"></a>04576             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error in OTTransaction::ProcessXMLNode: inReferenceTo field without value.\n&quot;</span>);
<a name="l04577"></a>04577             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l04578"></a>04578         }
<a name="l04579"></a>04579         
<a name="l04580"></a>04580         <span class="keywordflow">return</span> 1;
<a name="l04581"></a>04581     }
<a name="l04582"></a>04582     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;item&quot;</span>, xml-&gt;getNodeName())) 
<a name="l04583"></a>04583     {       
<a name="l04584"></a>04584         <a class="code" href="class_o_t_string.html">OTString</a> strData;
<a name="l04585"></a>04585 
<a name="l04586"></a>04586         <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, strData) || !strData.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04587"></a>04587         {
<a name="l04588"></a>04588             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error in OTTransaction::ProcessXMLNode: transaction item field without value.\n&quot;</span>);
<a name="l04589"></a>04589             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l04590"></a>04590         }
<a name="l04591"></a>04591         <span class="keywordflow">else</span> 
<a name="l04592"></a>04592         {
<a name="l04593"></a>04593             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <span class="keyword">new</span> <a class="code" href="class_o_t_item.html">OTItem</a>(<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), *<span class="keyword">this</span>);
<a name="l04594"></a>04594             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);           
<a name="l04595"></a>04595             <span class="comment">// -----------------------------------------------------</span>
<a name="l04596"></a>04596             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_transaction_type.html#a05be1cf5d51725a4b427d5ac9714234b">m_bLoadSecurely</a>)
<a name="l04597"></a>04597                 pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a0734d617542cad4697f7852a15ef7b3c">SetLoadInsecure</a>();
<a name="l04598"></a>04598             <span class="comment">// -----------------------------------------------------</span>
<a name="l04599"></a>04599             <span class="comment">// If we&#39;re able to successfully base64-decode the string and load it up as</span>
<a name="l04600"></a>04600             <span class="comment">// a transaction, then add it to the ledger&#39;s list of transactions</span>
<a name="l04601"></a>04601             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pItem-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strData))
<a name="l04602"></a>04602             {
<a name="l04603"></a>04603                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR: OTTransaction failed loading item from string: \n\n%s\n\n&quot;</span>,
<a name="l04604"></a>04604                               strData.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strData.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;&quot;</span>);
<a name="l04605"></a>04605                 <span class="keyword">delete</span> pItem; pItem = NULL;
<a name="l04606"></a>04606                 <span class="keywordflow">return</span> (-1);
<a name="l04607"></a>04607             }
<a name="l04608"></a>04608             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>())
<a name="l04609"></a>04609             {
<a name="l04610"></a>04610                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR: Failed verifying transaction Item in OTTransaction::ProcessXMLNode: \n\n%s\n\n&quot;</span>,
<a name="l04611"></a>04611                              strData.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04612"></a>04612                 <span class="keyword">delete</span> pItem; pItem = NULL;
<a name="l04613"></a>04613                 <span class="keywordflow">return</span> (-1);
<a name="l04614"></a>04614             }           
<a name="l04615"></a>04615             <span class="keywordflow">else</span> 
<a name="l04616"></a>04616             {
<a name="l04617"></a>04617                 <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>.push_back(pItem);
<a name="l04618"></a>04618 <span class="comment">//              OTLog::Output(5, &quot;Loaded transaction Item and adding to m_listItems in OTTransaction\n&quot;);</span>
<a name="l04619"></a>04619             }
<a name="l04620"></a>04620         }
<a name="l04621"></a>04621 
<a name="l04622"></a>04622         <span class="keywordflow">return</span> 1;
<a name="l04623"></a>04623     }
<a name="l04624"></a>04624         
<a name="l04625"></a>04625     <span class="keywordflow">return</span> 0;
<a name="l04626"></a>04626 }
<a name="l04627"></a>04627 
<a name="l04628"></a>04628 
<a name="l04629"></a>04629 <span class="comment">// For &quot;OTTransaction::blank&quot; and &quot;OTTransaction::successNotice&quot;</span>
<a name="l04630"></a>04630 <span class="comment">// which periodically have more numbers added to them.</span>
<a name="l04631"></a>04631 <span class="comment">//</span>
<a name="l04632"></a><a class="code" href="class_o_t_transaction.html#a492f3f835f309bd2e76e5d7cc4dc10a1">04632</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a492f3f835f309bd2e76e5d7cc4dc10a1">OTTransaction::AddNumbersToTransaction</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theAddition)
<a name="l04633"></a>04633 {
<a name="l04634"></a>04634     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.Add(theAddition);
<a name="l04635"></a>04635 }
<a name="l04636"></a>04636 
<a name="l04637"></a>04637 
<a name="l04638"></a>04638 <span class="comment">// This is called automatically by SignContract to make sure what&#39;s being signed is the most up-to-date</span>
<a name="l04639"></a>04639 <span class="comment">// Before transmission or serialization, this is where the ledger saves its contents </span>
<a name="l04640"></a>04640 <span class="comment">// So let&#39;s make sure this transaction has the right contents.</span>
<a name="l04641"></a>04641 <span class="comment">//</span>
<a name="l04642"></a><a class="code" href="class_o_t_transaction.html#a903a5b5d56e7f2856a51e2cdee6d511d">04642</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a903a5b5d56e7f2856a51e2cdee6d511d">OTTransaction::UpdateContents</a>() 
<a name="l04643"></a>04643 {
<a name="l04644"></a>04644     <a class="code" href="class_o_t_string.html">OTString</a> strCancelled;
<a name="l04645"></a>04645     
<a name="l04646"></a>04646     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#ae02e3420135cba3514b4131d6427641d">m_bCancelled</a>)
<a name="l04647"></a>04647     {
<a name="l04648"></a>04648         strCancelled.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; cancelled=\&quot;%s\&quot;\n&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>);
<a name="l04649"></a>04649     }
<a name="l04650"></a>04650     <span class="comment">// ----------------------------------------</span>
<a name="l04651"></a>04651     <a class="code" href="class_o_t_string.html">OTString</a> strListOfBlanks;   <span class="comment">// IF this transaction is &quot;blank&quot; or &quot;successNotice&quot; this will serialize the list of transaction numbers for it. (They now support multiple numbers.)</span>
<a name="l04652"></a>04652     <a class="code" href="class_o_t_string.html">OTString</a> strRequestNum;     <span class="comment">// Used by replyNotice only.</span>
<a name="l04653"></a>04653     <span class="comment">// ----------------------------------------</span>
<a name="l04654"></a>04654     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l04655"></a>04655     {
<a name="l04656"></a>04656         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>:
<a name="l04657"></a>04657             strRequestNum.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; requestNumber=\&quot;%lld\&quot;\n transSuccess=\&quot;%s\&quot;\n&quot;</span>,
<a name="l04658"></a>04658                                  <a class="code" href="class_o_t_transaction.html#a6fc95646e555b9c2ffb1404c6475ef56">m_lRequestNumber</a>, <a class="code" href="class_o_t_transaction.html#a1631d08ab9b9759c5743fa0bfe9f7bdf">m_bReplyTransSuccess</a> ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
<a name="l04659"></a>04659             <span class="keywordflow">break</span>;
<a name="l04660"></a>04660             
<a name="l04661"></a>04661         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>:          <span class="comment">// freshly issued transaction number, not accepted by the user (yet).</span>
<a name="l04662"></a>04662         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>:  <span class="comment">// A transaction # has successfully been signed out.</span>
<a name="l04663"></a>04663         {
<a name="l04664"></a>04664             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>() &gt; 0) <span class="comment">// This is always 0, except for blanks and successNotices.</span>
<a name="l04665"></a>04665             {
<a name="l04666"></a>04666                 <a class="code" href="class_o_t_string.html">OTString</a> strNumbers;
<a name="l04667"></a>04667                 <span class="keywordflow">if</span> (<span class="keyword">true</span> == <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(strNumbers)) 
<a name="l04668"></a>04668                     strListOfBlanks.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; totalListOfNumbers=\&quot;%s\&quot;\n&quot;</span>, strNumbers.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04669"></a>04669                 <span class="keywordflow">else</span> <span class="comment">// (False just means m_Numlist was empty.)</span>
<a name="l04670"></a>04670                     strListOfBlanks.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<span class="stringliteral">&quot;&quot;</span>);                    
<a name="l04671"></a>04671             }
<a name="l04672"></a>04672         }
<a name="l04673"></a>04673         <span class="keywordflow">default</span>:
<a name="l04674"></a>04674             <span class="keywordflow">break</span>;
<a name="l04675"></a>04675     }
<a name="l04676"></a>04676     <span class="comment">// -----------------------------------------------------</span>
<a name="l04677"></a>04677     <span class="keyword">const</span> <span class="keywordtype">char</span> * pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// TYPE</span>
<a name="l04678"></a>04678     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strType((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>), 
<a name="l04679"></a>04679                     strAcctID(<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>()), 
<a name="l04680"></a>04680                     strServerID(<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>()),
<a name="l04681"></a>04681                     strUserID(<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>()); 
<a name="l04682"></a>04682     <span class="comment">// -----------------------------------------------------</span>
<a name="l04683"></a>04683     <a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a> = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// We store the timestamp of when this transaction was signed.</span>
<a name="l04684"></a>04684     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l04685"></a>04685     <span class="comment">// -----------------------------------------------------    </span>
<a name="l04686"></a>04686     <span class="comment">// I release this because I&#39;m about to repopulate it.</span>
<a name="l04687"></a>04687     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l04688"></a>04688     
<a name="l04689"></a>04689     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;transaction type=\&quot;%s\&quot;\n%s&quot;</span>
<a name="l04690"></a>04690                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04691"></a>04691                               <span class="stringliteral">&quot; accountID=\&quot;%s\&quot;\n&quot;</span>
<a name="l04692"></a>04692                               <span class="stringliteral">&quot; userID=\&quot;%s\&quot;\n&quot;</span>
<a name="l04693"></a>04693                               <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;\n%s&quot;</span>
<a name="l04694"></a>04694                               <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04695"></a>04695                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n%s&quot;</span>
<a name="l04696"></a>04696                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; &gt;\n\n&quot;</span>, 
<a name="l04697"></a>04697                               strType.Get(), strCancelled.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l04698"></a>04698                               lDateSigned,
<a name="l04699"></a>04699                               strAcctID.Get(), 
<a name="l04700"></a>04700                               strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l04701"></a>04701                               strServerID.Get(), strRequestNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l04702"></a>04702                               <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l04703"></a>04703                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), strListOfBlanks.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l04704"></a>04704                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04705"></a>04705     <span class="comment">// -----------------------------------------------------    </span>
<a name="l04706"></a>04706     <span class="comment">//  OTLog::vError(&quot;IN REFERENCE TO, LENGTH: %d\n&quot;, m_ascInReferenceTo.GetLength());</span>
<a name="l04707"></a>04707     
<a name="l04708"></a>04708     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l04709"></a>04709     {
<a name="l04710"></a>04710         <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t_transaction.html#abb869752baf350d380c0afa81d84d1de">m_pParent</a>) {
<a name="l04711"></a>04711         <span class="comment">// ----------------------------------</span>
<a name="l04712"></a>04712         <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#abb869752baf350d380c0afa81d84d1de">m_pParent</a>-&gt;<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>())
<a name="l04713"></a>04713         {
<a name="l04714"></a>04714             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>:          this-&gt;<a class="code" href="class_o_t_transaction.html#add17ff12beaf8f0ba84b73b6b564f5b0">SaveAbbreviatedNymboxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);   <span class="keywordflow">break</span>;
<a name="l04715"></a>04715             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>:           this-&gt;<a class="code" href="class_o_t_transaction.html#ab15380c235814aeb89779fb5f42401d4">SaveAbbreviatedInboxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);    <span class="keywordflow">break</span>;
<a name="l04716"></a>04716             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>:          this-&gt;<a class="code" href="class_o_t_transaction.html#a0ea6c7483a961acfdef55cd992e4065d">SaveAbbreviatedOutboxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);   <span class="keywordflow">break</span>;
<a name="l04717"></a>04717             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>:    this-&gt;<a class="code" href="class_o_t_transaction.html#ac30eb05906f92766b5ce895854e682a3">SaveAbbrevPaymentInboxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);  <span class="keywordflow">break</span>;
<a name="l04718"></a>04718             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>:       this-&gt;<a class="code" href="class_o_t_transaction.html#a08424e75b8906896335609d7ca45c729">SaveAbbrevRecordBoxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);     <span class="keywordflow">break</span>;
<a name="l04719"></a>04719             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>:      this-&gt;<a class="code" href="class_o_t_transaction.html#af73fe383da8254ef5cd2c8a27de79a29">SaveAbbrevExpiredBoxRecord</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);    <span class="keywordflow">break</span>;
<a name="l04720"></a>04720                 <span class="comment">/* --- BREAK --- */</span>
<a name="l04721"></a>04721             <span class="keywordflow">case</span> <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>:
<a name="l04722"></a>04722                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unexpected message ledger type in &#39;abbreviated&#39; block. (Error.) \n&quot;</span>,
<a name="l04723"></a>04723                               __FUNCTION__);
<a name="l04724"></a>04724                 <span class="keywordflow">break</span>;
<a name="l04725"></a>04725             <span class="keywordflow">default</span>:
<a name="l04726"></a>04726                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unexpected ledger type in &#39;abbreviated&#39; block. (Error.) \n&quot;</span>,
<a name="l04727"></a>04727                               __FUNCTION__);
<a name="l04728"></a>04728                 <span class="keywordflow">break</span>;
<a name="l04729"></a>04729         } <span class="comment">/*switch*/</span>            }   <span class="comment">// if (NULL != m_pParent)</span>
<a name="l04730"></a>04730         <span class="keywordflow">else</span> <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Error: Unable to save abbreviated receipt here, since m_pParent is NULL.\n&quot;</span>,
<a name="l04731"></a>04731                            __FUNCTION__);
<a name="l04732"></a>04732         <span class="comment">// ----------------------------------</span>
<a name="l04733"></a>04733     }   <span class="comment">// if (IsAbbreviated())</span>
<a name="l04734"></a>04734     <span class="comment">// -------------------------------------</span>
<a name="l04735"></a>04735     <span class="keywordflow">else</span> <span class="comment">// not abbreviated (full details.)</span>
<a name="l04736"></a>04736     {
<a name="l04737"></a>04737         <span class="comment">// -----------------------------------------------------    </span>
<a name="l04738"></a>04738         <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>  == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) ||
<a name="l04739"></a>04739             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>))
<a name="l04740"></a>04740         {
<a name="l04741"></a>04741             <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;closingTransactionNumber value=\&quot;%lld\&quot;/&gt;\n\n&quot;</span>,
<a name="l04742"></a>04742                                       <a class="code" href="class_o_t_transaction.html#a3a2b17e72ec599dece6eb13208bde37c">m_lClosingTransactionNo</a>);        
<a name="l04743"></a>04743         }
<a name="l04744"></a>04744         <span class="comment">// -----------------------------------------------------    </span>
<a name="l04745"></a>04745 
<a name="l04746"></a>04746         <span class="comment">// a transaction contains a list of items, but it is also in reference to some item, from someone else</span>
<a name="l04747"></a>04747         <span class="comment">// We include a full copy of that item here.</span>
<a name="l04748"></a>04748         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction_type.html#a314901e59fc89a31f3cea2d956dac8b8">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
<a name="l04749"></a>04749             <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;inReferenceTo&gt;\n%s&lt;/inReferenceTo&gt;\n\n&quot;</span>, <a class="code" href="class_o_t_transaction_type.html#a314901e59fc89a31f3cea2d956dac8b8">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04750"></a>04750         <span class="comment">// -----------------------------------------------------    </span>
<a name="l04751"></a>04751         
<a name="l04752"></a>04752         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#a115f7417f09e3e815212d770e7b60a1b">m_ascCancellationRequest</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
<a name="l04753"></a>04753             <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;cancelRequest&gt;\n%s&lt;/cancelRequest&gt;\n\n&quot;</span>, <a class="code" href="class_o_t_transaction.html#a115f7417f09e3e815212d770e7b60a1b">m_ascCancellationRequest</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04754"></a>04754         
<a name="l04755"></a>04755         <span class="comment">// -----------------------------------------------------    </span>
<a name="l04756"></a>04756         <span class="comment">// loop through the items that make up this transaction and print them out here, base64-encoded, of course.</span>
<a name="l04757"></a>04757         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, <a class="code" href="class_o_t_transaction.html#a0a69941e6ccf8c6f399e06fbe2901c86">m_listItems</a>)
<a name="l04758"></a>04758         {
<a name="l04759"></a>04759             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l04760"></a>04760             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l04761"></a>04761             
<a name="l04762"></a>04762             <a class="code" href="class_o_t_string.html">OTString</a> strItem;
<a name="l04763"></a>04763             pItem-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strItem);
<a name="l04764"></a>04764             
<a name="l04765"></a>04765             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascItem;
<a name="l04766"></a>04766             ascItem.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strItem, <span class="keyword">true</span>); <span class="comment">// linebreaks = true</span>
<a name="l04767"></a>04767             
<a name="l04768"></a>04768             <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;item&gt;\n%s&lt;/item&gt;\n\n&quot;</span>, ascItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04769"></a>04769         }   
<a name="l04770"></a>04770         <span class="comment">// -----------------------------------------------------    </span>
<a name="l04771"></a>04771     } <span class="comment">// not abbreviated (full details.)</span>
<a name="l04772"></a>04772     
<a name="l04773"></a>04773     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;/transaction&gt;\n&quot;</span>);                  
<a name="l04774"></a>04774 }
<a name="l04775"></a>04775 
<a name="l04776"></a>04776 
<a name="l04777"></a>04777 <span class="comment">/*</span>
<a name="l04778"></a>04778 <span class="comment"> Question note to self:  Which of the above transaction types can be found inside:</span>
<a name="l04779"></a>04779 <span class="comment"> paymentInbox ledger, paymentOutbox ledger, and recordBox ledger?</span>
<a name="l04780"></a>04780 <span class="comment"></span>
<a name="l04781"></a>04781 <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l04782"></a>04782 <span class="comment"> void SaveAbbrevPaymentInboxRecord(OTString &amp; strOutput);   </span>
<a name="l04783"></a>04783 <span class="comment"> void SaveAbbrevPaymentOutboxRecord(OTString &amp; strOutput);</span>
<a name="l04784"></a>04784 <span class="comment"> void SaveAbbrevRecordBoxRecord(OTString &amp; strOutput);  </span>
<a name="l04785"></a>04785 <span class="comment"> </span>
<a name="l04786"></a>04786 <span class="comment"> </span>
<a name="l04787"></a>04787 <span class="comment"> --- paymentInbox ledger:</span>
<a name="l04788"></a>04788 <span class="comment"> </span>
<a name="l04789"></a>04789 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox. (When done, they go to recordBox to await deletion.)</span>
<a name="l04790"></a>04790 <span class="comment">    &quot;instrumentRejection&quot;,  // When someone rejects your invoice from his paymentInbox, you get one of these in YOUR paymentInbox.</span>
<a name="l04791"></a>04791 <span class="comment"></span>
<a name="l04792"></a>04792 <span class="comment"> </span>
<a name="l04793"></a>04793 <span class="comment"> --- paymentOutbox ledger:</span>
<a name="l04794"></a>04794 <span class="comment"> </span>
<a name="l04795"></a>04795 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox. (When done, they go to recordBox to await deletion.)</span>
<a name="l04796"></a>04796 <span class="comment"> </span>
<a name="l04797"></a>04797 <span class="comment"> </span>
<a name="l04798"></a>04798 <span class="comment"> --- recordBox ledger:</span>
<a name="l04799"></a>04799 <span class="comment"> </span>
<a name="l04800"></a>04800 <span class="comment"> // These all come from the asset account inbox (where they are transferred from before they end up in the record box.)</span>
<a name="l04801"></a>04801 <span class="comment">    &quot;pending&quot;,          // Pending transfer, in the inbox/outbox. (This can end up in your recordBox if you cancel your pending outgoing transfer.)</span>
<a name="l04802"></a>04802 <span class="comment">    &quot;transferReceipt&quot;,  // the server drops this into your inbox, when someone accepts your transfer.</span>
<a name="l04803"></a>04803 <span class="comment">    &quot;chequeReceipt&quot;,    // the server drops this into your inbox, when someone cashes your cheque.</span>
<a name="l04804"></a>04804 <span class="comment">    &quot;voucherReceipt&quot;,   // the server drops this into your inbox, when someone cashes your voucher.</span>
<a name="l04805"></a>04805 <span class="comment">    &quot;marketReceipt&quot;,    // server drops this into inbox periodically, if you have an offer on the market.</span>
<a name="l04806"></a>04806 <span class="comment">    &quot;paymentReceipt&quot;,   // the server drops this into people&#39;s inboxes, periodically, if they have payment plans.</span>
<a name="l04807"></a>04807 <span class="comment">    &quot;finalReceipt&quot;,     // the server drops this into your inbox(es), when a CronItem expires or is canceled.</span>
<a name="l04808"></a>04808 <span class="comment">    &quot;basketReceipt&quot;,    // the server drops this into your inboxes, when a basket exchange is processed.</span>
<a name="l04809"></a>04809 <span class="comment"></span>
<a name="l04810"></a>04810 <span class="comment"> // Record box may also store things that came from a Nymbox, and then had to go somewhere client-side for storage,</span>
<a name="l04811"></a>04811 <span class="comment"> // until user decides to delete them. For example:</span>
<a name="l04812"></a>04812 <span class="comment">    &quot;notice&quot;,           // in nymbox, notice from the server. Probably contains an updated smart contract.</span>
<a name="l04813"></a>04813 <span class="comment"> </span>
<a name="l04814"></a>04814 <span class="comment">// Whereas for a recordBox storing paymentInbox/paymentOutbox receipts, once they are completed, they go here to die.</span>
<a name="l04815"></a>04815 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox. (When done, they go to recordBox to await deletion.)</span>
<a name="l04816"></a>04816 <span class="comment">    &quot;instrumentRejection&quot;,  // When someone rejects your invoice from his paymentInbox, you get one of these in YOUR paymentInbox.</span>
<a name="l04817"></a>04817 <span class="comment"> </span>
<a name="l04818"></a>04818 <span class="comment"> */</span>
<a name="l04819"></a>04819 
<a name="l04820"></a>04820 <span class="comment">/*</span>
<a name="l04821"></a>04821 <span class="comment">  --- paymentInbox ledger:</span>
<a name="l04822"></a>04822 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox. (When done, they go to recordBox to await deletion.)</span>
<a name="l04823"></a>04823 <span class="comment">    &quot;instrumentRejection&quot;,  // When someone rejects your invoice from his paymentInbox, you get one of these in YOUR paymentInbox.</span>
<a name="l04824"></a>04824 <span class="comment"> */</span>
<a name="l04825"></a><a class="code" href="class_o_t_transaction.html#ac30eb05906f92766b5ce895854e682a3">04825</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#ac30eb05906f92766b5ce895854e682a3">OTTransaction::SaveAbbrevPaymentInboxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l04826"></a>04826 {
<a name="l04827"></a>04827     int64_t lDisplayValue = 0;
<a name="l04828"></a>04828     <span class="comment">// ----------------------------------------------</span>
<a name="l04829"></a>04829     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l04830"></a>04830     {
<a name="l04831"></a>04831         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l04832"></a>04832             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>()) 
<a name="l04833"></a>04833                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l04834"></a>04834             <span class="keywordflow">else</span>
<a name="l04835"></a>04835                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l04836"></a>04836             <span class="keywordflow">break</span>;
<a name="l04837"></a>04837         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>:
<a name="l04838"></a>04838             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l04839"></a>04839                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l04840"></a>04840             <span class="keywordflow">break</span>;
<a name="l04841"></a>04841         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for payment inbox reports</span>
<a name="l04842"></a>04842             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unexpected %s transaction &quot;</span>
<a name="l04843"></a>04843                            <span class="stringliteral">&quot;in payment inbox while making abbreviated payment inbox record.\n&quot;</span>,
<a name="l04844"></a>04844                           __FUNCTION__, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l04845"></a>04845             
<a name="l04846"></a>04846             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT: OTTransaction::SaveAbbrevPaymentInboxRecord: Unexpected transaction type.&quot;</span>);
<a name="l04847"></a>04847             
<a name="l04848"></a>04848             <span class="keywordflow">return</span>;
<a name="l04849"></a>04849     }
<a name="l04850"></a>04850 
<a name="l04851"></a>04851     <span class="comment">// ----------------------------------------------</span>
<a name="l04852"></a>04852     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l04853"></a>04853     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l04854"></a>04854     
<a name="l04855"></a>04855     <span class="comment">// TYPE</span>
<a name="l04856"></a>04856     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l04857"></a>04857     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l04858"></a>04858     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l04859"></a>04859     <span class="comment">// ----------------------------------------------</span>
<a name="l04860"></a>04860     <span class="comment">// DATE SIGNED</span>
<a name="l04861"></a>04861     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l04862"></a>04862     <span class="comment">// ----------------------------------------------</span>
<a name="l04863"></a>04863     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l04864"></a>04864     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l04865"></a>04865     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l04866"></a>04866     <span class="comment">//</span>
<a name="l04867"></a>04867     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l04868"></a>04868     
<a name="l04869"></a>04869     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l04870"></a>04870     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l04871"></a>04871         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l04872"></a>04872     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l04873"></a>04873     <span class="keywordflow">else</span>
<a name="l04874"></a>04874     {
<a name="l04875"></a>04875         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l04876"></a>04876         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the payment inbox, for example.)</span>
<a name="l04877"></a>04877         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l04878"></a>04878     }
<a name="l04879"></a>04879     <span class="comment">// ----------------------------------------------</span>
<a name="l04880"></a>04880     <span class="comment">/* </span>
<a name="l04881"></a>04881 <span class="comment">     NOTES...</span>
<a name="l04882"></a>04882 <span class="comment">     </span>
<a name="l04883"></a>04883 <span class="comment">     transactionType        m_Type;             // blank, pending, processInbox, transfer, deposit, withdrawal, payDividend, trade, etc.</span>
<a name="l04884"></a>04884 <span class="comment">     time64_t                   m_DATE_SIGNED;      // The date, in seconds, when the instrument was last signed.</span>
<a name="l04885"></a>04885 <span class="comment">     OTIdentifier           m_Hash;             // Created while saving abbreviated record, loaded back with it, then verified against actual hash when loading actual box receipt.</span>
<a name="l04886"></a>04886 <span class="comment">     int64_t                    m_lAbbrevAmount;    // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l04887"></a>04887 <span class="comment">     int64_t                    m_lDisplayAmount;   // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l04888"></a>04888 <span class="comment">     int64_t                    m_lTransactionNum;  // The server issues this and it must be sent with transaction request.</span>
<a name="l04889"></a>04889 <span class="comment">     int64_t                    m_lClosingTransactionNo; // used by finalReceipt</span>
<a name="l04890"></a>04890 <span class="comment">     int64_t                    m_lInReferenceToTransaction; </span>
<a name="l04891"></a>04891 <span class="comment">     int64_t                    m_lInRefDisplay</span>
<a name="l04892"></a>04892 <span class="comment">     */</span>
<a name="l04893"></a>04893     <span class="comment">/*  This is set upon loading in abbreviated form, and then cleared again </span>
<a name="l04894"></a>04894 <span class="comment">        when the actual box receipt is loaded:</span>
<a name="l04895"></a>04895 <span class="comment">     bool               m_bIsAbbreviated;   // this is set upon loading (Not stored at all.)</span>
<a name="l04896"></a>04896 <span class="comment">     */</span>
<a name="l04897"></a>04897     
<a name="l04898"></a>04898         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;paymentInboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l04899"></a>04899                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04900"></a>04900                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l04901"></a>04901                               <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04902"></a>04902                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04903"></a>04903                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l04904"></a>04904                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l04905"></a>04905                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l04906"></a>04906                               lDateSigned, 
<a name="l04907"></a>04907                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l04908"></a>04908                               lDisplayValue,
<a name="l04909"></a>04909                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l04910"></a>04910                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l04911"></a>04911                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04912"></a>04912 }
<a name="l04913"></a>04913 
<a name="l04914"></a>04914 
<a name="l04915"></a><a class="code" href="class_o_t_transaction.html#af73fe383da8254ef5cd2c8a27de79a29">04915</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#af73fe383da8254ef5cd2c8a27de79a29">OTTransaction::SaveAbbrevExpiredBoxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l04916"></a>04916 {
<a name="l04917"></a>04917     int64_t lDisplayValue = 0;
<a name="l04918"></a>04918     <span class="comment">// ----------------------------------------------</span>
<a name="l04919"></a>04919     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l04920"></a>04920     {
<a name="l04921"></a>04921         <span class="comment">// ******************************************</span>
<a name="l04922"></a>04922         <span class="comment">// PAYMENT INBOX / PAYMENT OUTBOX</span>
<a name="l04923"></a>04923         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l04924"></a>04924             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l04925"></a>04925                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l04926"></a>04926             <span class="keywordflow">else</span>
<a name="l04927"></a>04927                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l04928"></a>04928             <span class="keywordflow">break</span>;
<a name="l04929"></a>04929         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>:
<a name="l04930"></a>04930             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l04931"></a>04931                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l04932"></a>04932             <span class="keywordflow">else</span>
<a name="l04933"></a>04933                 lDisplayValue   = 0;
<a name="l04934"></a>04934             <span class="keywordflow">break</span>;              
<a name="l04935"></a>04935         <span class="comment">// ******************************************</span>
<a name="l04936"></a>04936         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>:         <span class="comment">// A notice from the server. Used in Nymbox. Probably contains an updated smart contract.</span>
<a name="l04937"></a>04937             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())            <span class="comment">// not the actual value of 0.</span>
<a name="l04938"></a>04938                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l04939"></a>04939             <span class="keywordflow">else</span>
<a name="l04940"></a>04940                 lDisplayValue   = 0;
<a name="l04941"></a>04941             <span class="keywordflow">break</span>;
<a name="l04942"></a>04942         <span class="comment">// ******************************************</span>
<a name="l04943"></a>04943         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for inbox reports</span>
<a name="l04944"></a>04944         {
<a name="l04945"></a>04945             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unexpected %s transaction &quot;</span>
<a name="l04946"></a>04946                            <span class="stringliteral">&quot;in expired box while making abbreviated expired-box record.\n&quot;</span>,
<a name="l04947"></a>04947                           __FUNCTION__, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l04948"></a>04948             
<a name="l04949"></a>04949             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT: OTTransaction::SaveAbbrevExpiredBoxRecord: Unexpected transaction type.&quot;</span>);
<a name="l04950"></a>04950 
<a name="l04951"></a>04951         }
<a name="l04952"></a>04952             <span class="keywordflow">return</span>;
<a name="l04953"></a>04953     }
<a name="l04954"></a>04954     <span class="comment">// ----------------------------------------------</span>
<a name="l04955"></a>04955     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l04956"></a>04956     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l04957"></a>04957     
<a name="l04958"></a>04958     <span class="comment">// TYPE</span>
<a name="l04959"></a>04959     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l04960"></a>04960     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l04961"></a>04961     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l04962"></a>04962     <span class="comment">// ----------------------------------------------</span>
<a name="l04963"></a>04963     <span class="comment">// DATE SIGNED</span>
<a name="l04964"></a>04964     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l04965"></a>04965     <span class="comment">// ----------------------------------------------</span>
<a name="l04966"></a>04966     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l04967"></a>04967     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l04968"></a>04968     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l04969"></a>04969     <span class="comment">//</span>
<a name="l04970"></a>04970     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l04971"></a>04971     
<a name="l04972"></a>04972     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l04973"></a>04973     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l04974"></a>04974         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l04975"></a>04975     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l04976"></a>04976     <span class="keywordflow">else</span>
<a name="l04977"></a>04977     {
<a name="l04978"></a>04978         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l04979"></a>04979         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the expired box, for example.)</span>
<a name="l04980"></a>04980         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l04981"></a>04981     }
<a name="l04982"></a>04982     <span class="comment">// ----------------------------------------------</span>
<a name="l04983"></a>04983     <span class="comment">/*</span>
<a name="l04984"></a>04984 <span class="comment">     NOTES...</span>
<a name="l04985"></a>04985 <span class="comment">     </span>
<a name="l04986"></a>04986 <span class="comment">     transactionType        m_Type;             // instrumentNotice</span>
<a name="l04987"></a>04987 <span class="comment">     time64_t                   m_DATE_SIGNED;      // The date, in seconds, when the instrument was last signed.</span>
<a name="l04988"></a>04988 <span class="comment">     OTIdentifier           m_Hash;             // Created while saving abbreviated record, loaded back with it, then verified against actual hash when loading actual box receipt.</span>
<a name="l04989"></a>04989 <span class="comment">     int64_t                    m_lAbbrevAmount;    // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l04990"></a>04990 <span class="comment">     int64_t                    m_lDisplayAmount;   // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l04991"></a>04991 <span class="comment">     int64_t                    m_lTransactionNum;  // The server issues this and it must be sent with transaction request.</span>
<a name="l04992"></a>04992 <span class="comment">     int64_t                    m_lInReferenceToTransaction; </span>
<a name="l04993"></a>04993 <span class="comment">     int64_t                    m_lInRefDisplay</span>
<a name="l04994"></a>04994 <span class="comment">     */</span>
<a name="l04995"></a>04995     <span class="comment">/*  This is set upon loading in abbreviated form, and then cleared again </span>
<a name="l04996"></a>04996 <span class="comment">        when the actual box receipt is loaded:</span>
<a name="l04997"></a>04997 <span class="comment">     bool               m_bIsAbbreviated;   // this is set upon loading (Not stored at all.)</span>
<a name="l04998"></a>04998 <span class="comment">     */</span>
<a name="l04999"></a>04999     
<a name="l05000"></a>05000     strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;expiredBoxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05001"></a>05001                           <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05002"></a>05002                           <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05003"></a>05003                           <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05004"></a>05004                           <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05005"></a>05005                           <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05006"></a>05006                           <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05007"></a>05007                           strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05008"></a>05008                           lDateSigned, 
<a name="l05009"></a>05009                           strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05010"></a>05010                           lDisplayValue,
<a name="l05011"></a>05011                           <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05012"></a>05012                           <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05013"></a>05013                           <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05014"></a>05014 }
<a name="l05015"></a>05015 
<a name="l05016"></a>05016 
<a name="l05017"></a>05017 <span class="comment">//case OTLedger::paymentInbox:  this-&gt;SaveAbbrevPaymentInboxRecord(m_xmlUnsigned);  break;</span>
<a name="l05018"></a>05018 <span class="comment">//case OTLedger::paymentOutbox: this-&gt;SaveAbbrevPaymentOutboxRecord(m_xmlUnsigned); break;</span>
<a name="l05019"></a>05019 <span class="comment">//case OTLedger::recordBox:     this-&gt;SaveAbbrevRecordBoxRecord(m_xmlUnsigned);     break;</span>
<a name="l05020"></a>05020 
<a name="l05021"></a>05021 <span class="comment">/*</span>
<a name="l05022"></a>05022 <span class="comment"> --- paymentOutbox ledger:</span>
<a name="l05023"></a>05023 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox.</span>
<a name="l05024"></a>05024 <span class="comment">    (When done, they go to recordBox or expiredBox to await deletion.)</span>
<a name="l05025"></a>05025 <span class="comment"> */</span>
<a name="l05026"></a>05026 <span class="comment">//void OTTransaction::SaveAbbrevPaymentOutboxRecord(OTString &amp; strOutput)</span>
<a name="l05027"></a>05027 <span class="comment">//{</span>
<a name="l05028"></a>05028 <span class="comment">//  int64_t lDisplayValue = 0;</span>
<a name="l05029"></a>05029 <span class="comment">//  </span>
<a name="l05030"></a>05030 <span class="comment">//  if (IsAbbreviated())</span>
<a name="l05031"></a>05031 <span class="comment">//  {</span>
<a name="l05032"></a>05032 <span class="comment">//      lDisplayValue   = GetAbbrevDisplayAmount();</span>
<a name="l05033"></a>05033 <span class="comment">//  }</span>
<a name="l05034"></a>05034 <span class="comment">//  else</span>
<a name="l05035"></a>05035 <span class="comment">//  {</span>
<a name="l05036"></a>05036 <span class="comment">//      switch (m_Type) </span>
<a name="l05037"></a>05037 <span class="comment">//      {</span>
<a name="l05038"></a>05038 <span class="comment">//          case OTTransaction::instrumentNotice:</span>
<a name="l05039"></a>05039 <span class="comment">//              lDisplayValue   = GetReceiptAmount();</span>
<a name="l05041"></a>05041 <span class="comment"></span><span class="comment">//              break;</span>
<a name="l05042"></a>05042 <span class="comment">//          default: // All other types are irrelevant for payment outbox reports.</span>
<a name="l05043"></a>05043 <span class="comment">//              OTLog::vError(&quot;OTTransaction::SaveAbbrevPaymentOutboxRecord: Unexpected %s transaction &quot;</span>
<a name="l05044"></a>05044 <span class="comment">//                            &quot;in payment outbox while making abbreviated payment outbox record.\n&quot;,</span>
<a name="l05045"></a>05045 <span class="comment">//                            GetTypeString());</span>
<a name="l05046"></a>05046 <span class="comment">//              return;</span>
<a name="l05047"></a>05047 <span class="comment">//      }</span>
<a name="l05048"></a>05048 <span class="comment">//  }</span>
<a name="l05049"></a>05049 <span class="comment">//  // ----------------------------------------------</span>
<a name="l05050"></a>05050 <span class="comment">//  // By this point, we know only the right types of receipts are being saved, and </span>
<a name="l05051"></a>05051 <span class="comment">//  // the adjustment and display value are both set correctly.</span>
<a name="l05052"></a>05052 <span class="comment">//  </span>
<a name="l05053"></a>05053 <span class="comment">//  // TYPE</span>
<a name="l05054"></a>05054 <span class="comment">//  OTString        strType;    // &lt;===========</span>
<a name="l05055"></a>05055 <span class="comment">//  const char *    pTypeStr = GetTypeString();</span>
<a name="l05056"></a>05056 <span class="comment">//  strType.Set((NULL != pTypeStr) ? pTypeStr : &quot;error_state&quot;);</span>
<a name="l05057"></a>05057 <span class="comment">//  // ----------------------------------------------</span>
<a name="l05058"></a>05058 <span class="comment">//  // DATE SIGNED</span>
<a name="l05059"></a>05059 <span class="comment">//  const int64_t lDateSigned = m_DATE_SIGNED;</span>
<a name="l05060"></a>05060 <span class="comment">//  // ----------------------------------------------</span>
<a name="l05061"></a>05061 <span class="comment">//  // HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l05062"></a>05062 <span class="comment">//  //</span>
<a name="l05063"></a>05063 <span class="comment">//  OTString strHash;</span>
<a name="l05064"></a>05064 <span class="comment">//  </span>
<a name="l05065"></a>05065 <span class="comment">//  // If this is already an abbreviated record, then save the existing hash.</span>
<a name="l05066"></a>05066 <span class="comment">//  if (IsAbbreviated())</span>
<a name="l05067"></a>05067 <span class="comment">//      m_Hash.GetString(strHash);</span>
<a name="l05068"></a>05068 <span class="comment">//  // Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l05069"></a>05069 <span class="comment">//  else</span>
<a name="l05070"></a>05070 <span class="comment">//  {</span>
<a name="l05071"></a>05071 <span class="comment">//      OTIdentifier    idReceiptHash;              // a hash of the actual transaction is stored with its</span>
<a name="l05072"></a>05072 <span class="comment">//      this-&gt;CalculateContractID(idReceiptHash);   // abbreviated short-form record (in the payment outbox, for example.)</span>
<a name="l05073"></a>05073 <span class="comment">//      idReceiptHash.GetString(strHash);</span>
<a name="l05074"></a>05074 <span class="comment">//  }</span>
<a name="l05075"></a>05075 <span class="comment">//  // ----------------------------------------------</span>
<a name="l05076"></a>05076 <span class="comment">//  strOutput.Concatenate(&quot;&lt;paymentOutboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05077"></a>05077 <span class="comment">//                        &quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05078"></a>05078 <span class="comment">//                        &quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05079"></a>05079 <span class="comment">//                        &quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05080"></a>05080 <span class="comment">//                        &quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05081"></a>05081 <span class="comment">//                        &quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05082"></a>05082 <span class="comment">//                        &quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;,</span>
<a name="l05083"></a>05083 <span class="comment">//                        strType.Get(), </span>
<a name="l05084"></a>05084 <span class="comment">//                        lDateSigned, </span>
<a name="l05085"></a>05085 <span class="comment">//                        strHash.Get(),                          </span>
<a name="l05086"></a>05086 <span class="comment">//                        lDisplayValue,</span>
<a name="l05087"></a>05087 <span class="comment">//                        GetTransactionNum(),</span>
<a name="l05088"></a>05088 <span class="comment">//                        GetReferenceNumForDisplay(),</span>
<a name="l05089"></a>05089 <span class="comment">//                        GetReferenceToNum());</span>
<a name="l05090"></a>05090 <span class="comment">//}</span>
<a name="l05091"></a>05091 
<a name="l05092"></a>05092 <span class="comment">/*</span>
<a name="l05093"></a>05093 <span class="comment"> --- recordBox ledger:</span>
<a name="l05094"></a>05094 <span class="comment"> </span>
<a name="l05095"></a>05095 <span class="comment"> // These all come from the ASSET ACCT INBOX (where they are transferred from before they end up in the record box.)</span>
<a name="l05096"></a>05096 <span class="comment">    &quot;pending&quot;,          // Pending transfer, in the inbox/outbox. (This can end up in your recordBox if you cancel your pending outgoing transfer.)</span>
<a name="l05097"></a>05097 <span class="comment">    &quot;transferReceipt&quot;,  // the server drops this into your inbox, when someone accepts your transfer.</span>
<a name="l05098"></a>05098 <span class="comment">    &quot;chequeReceipt&quot;,    // the server drops this into your inbox, when someone cashes your cheque.</span>
<a name="l05099"></a>05099 <span class="comment">    &quot;voucherReceipt&quot;,   // the server drops this into your inbox, when someone cashes your voucher.</span>
<a name="l05100"></a>05100 <span class="comment">    &quot;marketReceipt&quot;,    // server drops this into inbox periodically, if you have an offer on the market.</span>
<a name="l05101"></a>05101 <span class="comment">    &quot;paymentReceipt&quot;,   // the server drops this into people&#39;s inboxes, periodically, if they have payment plans.</span>
<a name="l05102"></a>05102 <span class="comment">    &quot;finalReceipt&quot;,     // the server drops this into your inbox(es), when a CronItem expires or is canceled.</span>
<a name="l05103"></a>05103 <span class="comment">    &quot;basketReceipt&quot;,    // the server drops this into your inboxes, when a basket exchange is processed.</span>
<a name="l05104"></a>05104 <span class="comment"></span>
<a name="l05105"></a>05105 <span class="comment"> // Record box may also store things that came from a NYMBOX, and then had to go somewhere client-side for storage,</span>
<a name="l05106"></a>05106 <span class="comment"> // until user decides to delete them. For example:</span>
<a name="l05107"></a>05107 <span class="comment">    &quot;notice&quot;,           // in nymbox, notice from the server. Probably contains an updated smart contract.</span>
<a name="l05108"></a>05108 <span class="comment"> </span>
<a name="l05109"></a>05109 <span class="comment">// Whereas for a recordBox storing PAYMENT-INBOX and PAYMENT-OUTBOX receipts, once they are completed, they go here to die.</span>
<a name="l05110"></a>05110 <span class="comment">    &quot;instrumentNotice&quot;,     // Receive these in paymentInbox, and send in paymentOutbox. (When done, they go to recordBox to await deletion.)</span>
<a name="l05111"></a>05111 <span class="comment">    &quot;instrumentRejection&quot;,  // When someone rejects your invoice from his paymentInbox, you get one of these in YOUR paymentInbox.</span>
<a name="l05112"></a>05112 <span class="comment"> </span>
<a name="l05113"></a>05113 <span class="comment"> </span>
<a name="l05114"></a>05114 <span class="comment"> NOTE: The expiredBox is identical to recordBox (for things that came from payments inbox or outpayments box.)</span>
<a name="l05115"></a>05115 <span class="comment"> Except it&#39;s used for expired payments, instead of completed / canceled payments.</span>
<a name="l05116"></a>05116 <span class="comment"> */</span>
<a name="l05117"></a><a class="code" href="class_o_t_transaction.html#a08424e75b8906896335609d7ca45c729">05117</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a08424e75b8906896335609d7ca45c729">OTTransaction::SaveAbbrevRecordBoxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l05118"></a>05118 {
<a name="l05119"></a>05119     <span class="comment">// Have some kind of check in here, whether the AcctID and UserID match.</span>
<a name="l05120"></a>05120     <span class="comment">// Some recordBoxes DO, and some DON&#39;T (the different kinds store different</span>
<a name="l05121"></a>05121     <span class="comment">// kinds of receipts. See above comment.)</span>
<a name="l05122"></a>05122     
<a name="l05123"></a>05123     int64_t lAdjustment = 0, lDisplayValue = 0;
<a name="l05124"></a>05124     <span class="comment">// ----------------------------------------------</span>
<a name="l05125"></a>05125     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05126"></a>05126     {
<a name="l05127"></a>05127             <span class="comment">// ******************************************</span>
<a name="l05128"></a>05128             <span class="comment">// ASSET ACCOUNT INBOX</span>
<a name="l05129"></a>05129             <span class="comment">// -- In inbox, pending hasn&#39;t been accepted yet. In outbox, it&#39;s already gone. Either</span>
<a name="l05130"></a>05130             <span class="comment">// way, it will have a 0 adjustment amount, even though perhaps 500 clams display amount. Here I use the 500</span>
<a name="l05131"></a>05131             <span class="comment">// for display, but in SaveAbbrevToOutbox, I multiply it by -1 so it appears as -500 (leaving my account.)</span>
<a name="l05132"></a>05132             <span class="comment">// -- In my inbox, the transferReceipt is notice of money that is already gone. It thus has adjustment value of 0.</span>
<a name="l05133"></a>05133             <span class="comment">// But the DISPLAY amount is the amount I originally sent. (Already multiplied by -1 by GetReceiptAmount())</span>
<a name="l05134"></a>05134             <span class="comment">//</span>
<a name="l05135"></a>05135         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:            <span class="comment">// (The pending amount is stored on the transfer item in my list of transaction items.)</span>
<a name="l05136"></a>05136         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:    <span class="comment">// The transferReceipt and voucherReceipt amounts are the display value (according to</span>
<a name="l05137"></a>05137         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:     <span class="comment">// GetReceiptAmount()), and not the actual value of 0.</span>
<a name="l05138"></a>05138             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05139"></a>05139             {
<a name="l05140"></a>05140                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05141"></a>05141                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05142"></a>05142             }
<a name="l05143"></a>05143             <span class="keywordflow">else</span>
<a name="l05144"></a>05144             {
<a name="l05145"></a>05145                 lAdjustment     = 0;
<a name="l05146"></a>05146                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>(); 
<a name="l05147"></a>05147             }
<a name="l05148"></a>05148             <span class="keywordflow">break</span>;
<a name="l05149"></a>05149             <span class="comment">// If chequeReceipt for 100 clams hit my inbox, then my balance is -100 from where it was. (Same</span>
<a name="l05150"></a>05150             <span class="comment">// value should be displayed.) Luckily, GetReceiptAmount() already multiplies by (-1) for chequeReceipt.</span>
<a name="l05151"></a>05151             <span class="comment">// For these (marketReceipt, paymentReceipt, basketReceipt), the actual adjustment is positive OR negative</span>
<a name="l05152"></a>05152             <span class="comment">// already, and the display value should match.</span>
<a name="l05153"></a>05153         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:      <span class="comment">// the amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l05154"></a>05154         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>:      <span class="comment">// amount is stored on marketReceipt item.  | </span>
<a name="l05155"></a>05155         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:     <span class="comment">// amount is stored on paymentReceipt item. | and the display value should match.</span>
<a name="l05156"></a>05156         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:      <span class="comment">// amount is stored on basketReceipt item.  | </span>
<a name="l05157"></a>05157             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05158"></a>05158             {
<a name="l05159"></a>05159                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05160"></a>05160                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05161"></a>05161             }
<a name="l05162"></a>05162             <span class="keywordflow">else</span>
<a name="l05163"></a>05163             {
<a name="l05164"></a>05164                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();   
<a name="l05165"></a>05165                 lDisplayValue   = lAdjustment;          
<a name="l05166"></a>05166             }
<a name="l05167"></a>05167             <span class="keywordflow">break</span>;
<a name="l05168"></a>05168         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:       <span class="comment">// amount is 0 according to GetReceiptAmount()</span>
<a name="l05169"></a>05169             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05170"></a>05170             {
<a name="l05171"></a>05171                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05172"></a>05172                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05173"></a>05173             }
<a name="l05174"></a>05174             <span class="keywordflow">else</span>
<a name="l05175"></a>05175             {
<a name="l05176"></a>05176                 lAdjustment     = 0;
<a name="l05177"></a>05177                 lDisplayValue   = 0;
<a name="l05178"></a>05178             }
<a name="l05179"></a>05179             <span class="keywordflow">break</span>;
<a name="l05180"></a>05180         <span class="comment">// ******************************************</span>
<a name="l05181"></a>05181         <span class="comment">// NYMBOX</span>
<a name="l05182"></a>05182         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>:         <span class="comment">// A notice from the server. Used in Nymbox. Probably contains an updated smart contract.</span>
<a name="l05183"></a>05183             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())            <span class="comment">// not the actual value of 0.</span>
<a name="l05184"></a>05184             {
<a name="l05185"></a>05185                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05186"></a>05186                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05187"></a>05187             }
<a name="l05188"></a>05188             <span class="keywordflow">else</span>
<a name="l05189"></a>05189             {
<a name="l05190"></a>05190                 lAdjustment     = 0;
<a name="l05191"></a>05191                 lDisplayValue   = 0;
<a name="l05192"></a>05192             }
<a name="l05193"></a>05193             <span class="keywordflow">break</span>;              
<a name="l05194"></a>05194         <span class="comment">// ******************************************</span>
<a name="l05195"></a>05195         <span class="comment">// PAYMENT INBOX / PAYMENT OUTBOX</span>
<a name="l05196"></a>05196         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l05197"></a>05197             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05198"></a>05198             {
<a name="l05199"></a>05199                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05200"></a>05200                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05201"></a>05201             }
<a name="l05202"></a>05202             <span class="keywordflow">else</span>
<a name="l05203"></a>05203             {
<a name="l05204"></a>05204                 lAdjustment     = 0;
<a name="l05205"></a>05205                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l05206"></a>05206             }
<a name="l05207"></a>05207             <span class="keywordflow">break</span>;
<a name="l05208"></a>05208         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>:
<a name="l05209"></a>05209             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05210"></a>05210             {
<a name="l05211"></a>05211                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05212"></a>05212                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05213"></a>05213             }
<a name="l05214"></a>05214             <span class="keywordflow">else</span>
<a name="l05215"></a>05215             {
<a name="l05216"></a>05216                 lAdjustment     = 0;
<a name="l05217"></a>05217                 lDisplayValue   = 0; 
<a name="l05218"></a>05218             }
<a name="l05219"></a>05219             <span class="keywordflow">break</span>;              
<a name="l05220"></a>05220         <span class="comment">// ******************************************</span>
<a name="l05221"></a>05221         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for inbox reports</span>
<a name="l05222"></a>05222         {
<a name="l05223"></a>05223             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::SaveAbbrevRecordBoxRecord: Unexpected %s transaction &quot;</span>
<a name="l05224"></a>05224                            <span class="stringliteral">&quot;in record box while making abbreviated record-box record.\n&quot;</span>, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l05225"></a>05225         }
<a name="l05226"></a>05226             <span class="keywordflow">return</span>;
<a name="l05227"></a>05227     }   <span class="comment">// why not transfer receipt? Because the amount was already removed from your account when you transferred it,</span>
<a name="l05228"></a>05228 
<a name="l05229"></a>05229     <span class="comment">// ----------------------------------------------</span>
<a name="l05230"></a>05230     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l05231"></a>05231     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l05232"></a>05232     
<a name="l05233"></a>05233     <span class="comment">// TYPE</span>
<a name="l05234"></a>05234     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l05235"></a>05235     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l05236"></a>05236     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l05237"></a>05237     <span class="comment">// ----------------------------------------------</span>
<a name="l05238"></a>05238     <span class="comment">// DATE SIGNED</span>
<a name="l05239"></a>05239     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l05240"></a>05240     <span class="comment">// ----------------------------------------------</span>
<a name="l05241"></a>05241     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l05242"></a>05242     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l05243"></a>05243     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l05244"></a>05244     <span class="comment">//</span>
<a name="l05245"></a>05245     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l05246"></a>05246     
<a name="l05247"></a>05247     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l05248"></a>05248     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05249"></a>05249         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05250"></a>05250     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l05251"></a>05251     <span class="keywordflow">else</span>
<a name="l05252"></a>05252     {
<a name="l05253"></a>05253         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l05254"></a>05254         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the record box, for example.)</span>
<a name="l05255"></a>05255         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05256"></a>05256     }
<a name="l05257"></a>05257     <span class="comment">// ----------------------------------------------</span>
<a name="l05258"></a>05258     <span class="comment">/* </span>
<a name="l05259"></a>05259 <span class="comment">     NOTES...</span>
<a name="l05260"></a>05260 <span class="comment">     </span>
<a name="l05261"></a>05261 <span class="comment">     transactionType        m_Type;             // pending, processInbox, transfer, deposit, withdrawal, payDividend, trade, etc.</span>
<a name="l05262"></a>05262 <span class="comment">     time64_t                   m_DATE_SIGNED;      // The date, in seconds, when the instrument was last signed.</span>
<a name="l05263"></a>05263 <span class="comment">     OTIdentifier           m_Hash;             // Created while saving abbreviated record, loaded back with it, then verified against actual hash when loading actual box receipt.</span>
<a name="l05264"></a>05264 <span class="comment">     int64_t                    m_lAbbrevAmount;    // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l05265"></a>05265 <span class="comment">     int64_t                    m_lDisplayAmount;   // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l05266"></a>05266 <span class="comment">     int64_t                    m_lTransactionNum;  // The server issues this and it must be sent with transaction request.</span>
<a name="l05267"></a>05267 <span class="comment">     int64_t                    m_lClosingTransactionNo; // used by finalReceipt</span>
<a name="l05268"></a>05268 <span class="comment">     int64_t                    m_lInReferenceToTransaction; </span>
<a name="l05269"></a>05269 <span class="comment">     int64_t                    m_lInRefDisplay</span>
<a name="l05270"></a>05270 <span class="comment">     */</span>
<a name="l05271"></a>05271     <span class="comment">/*  This is set upon loading in abbreviated form, and then cleared again </span>
<a name="l05272"></a>05272 <span class="comment">        when the actual box receipt is loaded:</span>
<a name="l05273"></a>05273 <span class="comment">     bool               m_bIsAbbreviated;   // this is set upon loading (Not stored at all.)</span>
<a name="l05274"></a>05274 <span class="comment">     */</span>
<a name="l05275"></a>05275     
<a name="l05276"></a>05276     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || 
<a name="l05277"></a>05277         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>))
<a name="l05278"></a>05278         <span class="comment">// ---------------------------</span>
<a name="l05279"></a>05279         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;recordBoxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05280"></a>05280                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05281"></a>05281                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05282"></a>05282                               <span class="stringliteral">&quot; adjustment=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05283"></a>05283                               <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05284"></a>05284                               <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05285"></a>05285                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05286"></a>05286                               <span class="stringliteral">&quot; closingNum=\&quot;%lld\&quot;\n&quot;</span>  <span class="comment">// &lt;==========</span>
<a name="l05287"></a>05287                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05288"></a>05288                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05289"></a>05289                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05290"></a>05290                               lDateSigned, 
<a name="l05291"></a>05291                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05292"></a>05292                               lAdjustment,
<a name="l05293"></a>05293                               lDisplayValue,
<a name="l05294"></a>05294                               <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l05295"></a>05295                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05296"></a>05296                               <a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(),          <span class="comment">// &lt;==========</span>
<a name="l05297"></a>05297                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05298"></a>05298                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05299"></a>05299     <span class="keywordflow">else</span>
<a name="l05300"></a>05300         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;recordBoxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05301"></a>05301                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05302"></a>05302                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05303"></a>05303                               <span class="stringliteral">&quot; adjustment=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05304"></a>05304                               <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05305"></a>05305                               <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05306"></a>05306                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05307"></a>05307                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05308"></a>05308                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05309"></a>05309                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05310"></a>05310                               lDateSigned, 
<a name="l05311"></a>05311                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05312"></a>05312                               lAdjustment,
<a name="l05313"></a>05313                               lDisplayValue,
<a name="l05314"></a>05314                               <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l05315"></a>05315                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05316"></a>05316                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05317"></a>05317                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05318"></a>05318 }
<a name="l05319"></a>05319 
<a name="l05320"></a>05320 
<a name="l05321"></a>05321 <span class="comment">// All of the actual receipts cannot fit inside the inbox file,</span>
<a name="l05322"></a>05322 <span class="comment">// which can get huge, and bog down network ability to transmit.</span>
<a name="l05323"></a>05323 <span class="comment">// Instead, we save receipts in abbreviated form in the inbox,</span>
<a name="l05324"></a>05324 <span class="comment">// then let the users download those receipts individually. That</span>
<a name="l05325"></a>05325 <span class="comment">// way, each message cannot be too large to download, such as</span>
<a name="l05326"></a>05326 <span class="comment">// a giant inbox can be with 400000 receipts inside of it.</span>
<a name="l05327"></a>05327 <span class="comment">//</span>
<a name="l05328"></a><a class="code" href="class_o_t_transaction.html#add17ff12beaf8f0ba84b73b6b564f5b0">05328</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#add17ff12beaf8f0ba84b73b6b564f5b0">OTTransaction::SaveAbbreviatedNymboxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l05329"></a>05329 {
<a name="l05330"></a>05330     int64_t lDisplayValue = 0;
<a name="l05331"></a>05331     <span class="comment">// ----------------------------------------------    </span>
<a name="l05332"></a>05332     <a class="code" href="class_o_t_string.html">OTString</a> strDisplayValue;   <span class="comment">// IF this transaction is passing through on its way to the paymentInbox, it will have a displayValue.</span>
<a name="l05333"></a>05333     <a class="code" href="class_o_t_string.html">OTString</a> strListOfBlanks;   <span class="comment">// IF this transaction is &quot;blank&quot; or &quot;successNotice&quot; this will serialize the list of transaction numbers for it. (They now support multiple numbers.)</span>
<a name="l05334"></a>05334     <a class="code" href="class_o_t_string.html">OTString</a> strRequestNum;     <span class="comment">// ONLY replyNotice transactions carry a request Num.</span>
<a name="l05335"></a>05335     
<a name="l05336"></a>05336     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05337"></a>05337     {
<a name="l05338"></a>05338         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>:          <span class="comment">// freshly issued transaction number, not accepted by the user (yet).</span>
<a name="l05339"></a>05339         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>:  <span class="comment">// A transaction # has successfully been signed out.</span>
<a name="l05340"></a>05340         {
<a name="l05341"></a>05341             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>() &gt; 0) <span class="comment">// This is always 0, except for blanks and successNotices.</span>
<a name="l05342"></a>05342             {
<a name="l05343"></a>05343                 <a class="code" href="class_o_t_string.html">OTString</a> strNumbers;
<a name="l05344"></a>05344                 <span class="keywordflow">if</span> (<span class="keyword">true</span> == <a class="code" href="class_o_t_transaction_type.html#a6113532c4f9a2f1d8ca274e3975b6043">m_Numlist</a>.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(strNumbers)) 
<a name="l05345"></a>05345                     strListOfBlanks.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; totalListOfNumbers=\&quot;%s\&quot;\n&quot;</span>, strNumbers.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05346"></a>05346                 <span class="keywordflow">else</span> <span class="comment">// (False just means it was empty.)</span>
<a name="l05347"></a>05347                     strListOfBlanks.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<span class="stringliteral">&quot;&quot;</span>);                    
<a name="l05348"></a>05348             }
<a name="l05349"></a>05349         }
<a name="l05350"></a>05350             <span class="comment">/* ! CONTINUES FALLING THROUGH HERE!!... */</span>
<a name="l05351"></a>05351             
<a name="l05352"></a>05352         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>:    <span class="comment">// A copy of a server reply to a previous request you sent. (To make SURE you get the reply.)</span>
<a name="l05353"></a>05353             strRequestNum.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; requestNumber=\&quot;%lld\&quot;\n transSuccess=\&quot;%s\&quot;\n&quot;</span>,
<a name="l05354"></a>05354                                  <a class="code" href="class_o_t_transaction.html#a6fc95646e555b9c2ffb1404c6475ef56">m_lRequestNumber</a>, <a class="code" href="class_o_t_transaction.html#a1631d08ab9b9759c5743fa0bfe9f7bdf">m_bReplyTransSuccess</a> ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
<a name="l05355"></a>05355             <span class="keywordflow">break</span>;
<a name="l05356"></a>05356             
<a name="l05357"></a>05357         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a>:        <span class="comment">// A message from one user to another, also in the nymbox.</span>
<a name="l05358"></a>05358         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>:         <span class="comment">// A notice from the server. Used in Nymbox. Probably contains an updated smart contract.</span>
<a name="l05359"></a>05359         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:   <span class="comment">// Any finalReceipt in an inbox will also drop a copy into the Nymbox.</span>
<a name="l05360"></a>05360             <span class="keywordflow">break</span>;                          
<a name="l05361"></a>05361             <span class="comment">// ------------</span>
<a name="l05362"></a>05362             <span class="comment">// paymentInbox items are transported through the Nymbox.</span>
<a name="l05363"></a>05363             <span class="comment">// Therefore, this switch statement from SaveAbbrevPaymentInbox</span>
<a name="l05364"></a>05364             <span class="comment">// is also found here, to handle those receipts as they pass through.</span>
<a name="l05365"></a>05365         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:       <span class="comment">// A financial instrument sent from/to another nym.</span>
<a name="l05366"></a>05366             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05367"></a>05367                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05368"></a>05368             <span class="keywordflow">else</span>
<a name="l05369"></a>05369                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();            
<a name="l05370"></a>05370             strDisplayValue.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>, lDisplayValue);
<a name="l05371"></a>05371             <span class="keywordflow">break</span>;                          <span class="comment">// (These last two are just passing through, on their way to the paymentInbox.)</span>
<a name="l05372"></a>05372         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>:    <span class="comment">// A rejection notice from the intended recipient of an instrumentNotice.</span>
<a name="l05373"></a>05373                 lDisplayValue   = 0;                
<a name="l05374"></a>05374             <span class="keywordflow">break</span>;                          
<a name="l05375"></a>05375             <span class="comment">// ------------</span>
<a name="l05376"></a>05376         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for nymbox reports.</span>
<a name="l05377"></a>05377             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected %s transaction in nymbox while making abbreviated nymbox record.\n&quot;</span>,
<a name="l05378"></a>05378                           __FUNCTION__, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l05379"></a>05379             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT: OTTransaction::SaveAbbreviatedNymboxRecord: Unexpected transaction in this Nymbox.&quot;</span>);
<a name="l05380"></a>05380             
<a name="l05381"></a>05381             <span class="keywordflow">return</span>;
<a name="l05382"></a>05382     }
<a name="l05383"></a>05383     <span class="comment">// ----------------------------------------------</span>
<a name="l05384"></a>05384     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l05385"></a>05385     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l05386"></a>05386     
<a name="l05387"></a>05387     <span class="comment">// TYPE</span>
<a name="l05388"></a>05388     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l05389"></a>05389     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l05390"></a>05390     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l05391"></a>05391     <span class="comment">// ----------------------------------------------</span>
<a name="l05392"></a>05392     <span class="comment">// DATE SIGNED</span>
<a name="l05393"></a>05393     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l05394"></a>05394     <span class="comment">// ----------------------------------------------</span>
<a name="l05395"></a>05395     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l05396"></a>05396     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l05397"></a>05397     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l05398"></a>05398     <span class="comment">//</span>
<a name="l05399"></a>05399     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l05400"></a>05400     
<a name="l05401"></a>05401     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l05402"></a>05402     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05403"></a>05403         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05404"></a>05404     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l05405"></a>05405     <span class="keywordflow">else</span>
<a name="l05406"></a>05406     {
<a name="l05407"></a>05407         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l05408"></a>05408         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the inbox, for example.)</span>
<a name="l05409"></a>05409         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05410"></a>05410     }
<a name="l05411"></a>05411     <span class="comment">// ----------------------------------------------</span>
<a name="l05412"></a>05412     
<a name="l05413"></a>05413     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || 
<a name="l05414"></a>05414         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>)) <span class="comment">// I actually don&#39;t think you can put a basket receipt notice in a nymbox, the way you can with a final receipt notice. Probably can remove this line.</span>
<a name="l05415"></a>05415         <span class="comment">// ---------------------------</span>
<a name="l05416"></a>05416         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;nymboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05417"></a>05417                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05418"></a>05418                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05419"></a>05419                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05420"></a>05420                               <span class="stringliteral">&quot; closingNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05421"></a>05421                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05422"></a>05422                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05423"></a>05423                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05424"></a>05424                               lDateSigned, 
<a name="l05425"></a>05425                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),              
<a name="l05426"></a>05426                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05427"></a>05427                               <a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(),
<a name="l05428"></a>05428                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05429"></a>05429                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05430"></a>05430     <span class="comment">// -----------------------------</span>
<a name="l05431"></a>05431     <span class="keywordflow">else</span>
<a name="l05432"></a>05432         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;nymboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05433"></a>05433                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n%s&quot;</span>
<a name="l05434"></a>05434                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n%s&quot;</span>     <span class="comment">// SOMETIMES this is added here by the final %s: &quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05435"></a>05435                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n%s&quot;</span> <span class="comment">// SOMETIMES this is added here by the final %s: &quot; totalListOfNumbers=\&quot;%s\&quot;\n&quot;</span>
<a name="l05436"></a>05436                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05437"></a>05437                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05438"></a>05438                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05439"></a>05439                               lDateSigned,          strRequestNum.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l05440"></a>05440                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),        strDisplayValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    
<a name="l05441"></a>05441                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),  strListOfBlanks.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l05442"></a>05442                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05443"></a>05443                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05444"></a>05444 }
<a name="l05445"></a>05445 
<a name="l05446"></a>05446 
<a name="l05447"></a><a class="code" href="class_o_t_transaction.html#a0ea6c7483a961acfdef55cd992e4065d">05447</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a0ea6c7483a961acfdef55cd992e4065d">OTTransaction::SaveAbbreviatedOutboxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l05448"></a>05448 {
<a name="l05449"></a>05449     int64_t lAdjustment = 0, lDisplayValue = 0;
<a name="l05450"></a>05450 
<a name="l05451"></a>05451     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05452"></a>05452     {
<a name="l05453"></a>05453         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:
<a name="l05454"></a>05454             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05455"></a>05455             {
<a name="l05456"></a>05456                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05457"></a>05457                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05458"></a>05458             }
<a name="l05459"></a>05459             <span class="keywordflow">else</span>
<a name="l05460"></a>05460             {
<a name="l05461"></a>05461                 lAdjustment     = 0;            <span class="comment">// In the inbox, a pending hasn&#39;t been accepted yet. </span>
<a name="l05462"></a>05462                 lDisplayValue   =               <span class="comment">//  In the outbox, it&#39;s already gone.</span>
<a name="l05463"></a>05463                     (<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()*(-1));  <span class="comment">// Either way, it will have a 0 adjustment amount, even though perhaps 500 clams display amount.</span>
<a name="l05464"></a>05464             }
<a name="l05465"></a>05465             <span class="keywordflow">break</span>;                          <span class="comment">// In this case, since it&#39;s the outbox, then it&#39;s a MINUS (-500) Display amount (since I&#39;m sending, not receiving it.)</span>
<a name="l05466"></a>05466         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for outbox reports.</span>
<a name="l05467"></a>05467             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::SaveAbbreviatedOutboxRecord: Unexpected %s transaction &quot;</span>
<a name="l05468"></a>05468                           <span class="stringliteral">&quot;in outbox while making abbreviated outbox record.\n&quot;</span>, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l05469"></a>05469             
<a name="l05470"></a>05470             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT: OTTransaction::SaveAbbreviatedOutboxRecord: unexpected transaction type.&quot;</span>);
<a name="l05471"></a>05471             
<a name="l05472"></a>05472             <span class="keywordflow">return</span>;
<a name="l05473"></a>05473     }
<a name="l05474"></a>05474     <span class="comment">// ----------------------------------------------</span>
<a name="l05475"></a>05475     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l05476"></a>05476     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l05477"></a>05477     
<a name="l05478"></a>05478     <span class="comment">// TYPE</span>
<a name="l05479"></a>05479     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l05480"></a>05480     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l05481"></a>05481     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l05482"></a>05482     <span class="comment">// ----------------------------------------------</span>
<a name="l05483"></a>05483     <span class="comment">// DATE SIGNED</span>
<a name="l05484"></a>05484     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l05485"></a>05485     <span class="comment">// ----------------------------------------------</span>
<a name="l05486"></a>05486     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l05487"></a>05487     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l05488"></a>05488     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l05489"></a>05489     <span class="comment">//</span>
<a name="l05490"></a>05490     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l05491"></a>05491     
<a name="l05492"></a>05492     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l05493"></a>05493     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05494"></a>05494         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05495"></a>05495     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l05496"></a>05496     <span class="keywordflow">else</span>
<a name="l05497"></a>05497     {
<a name="l05498"></a>05498         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l05499"></a>05499         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the inbox, for example.)</span>
<a name="l05500"></a>05500         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05501"></a>05501     }
<a name="l05502"></a>05502     <span class="comment">// ----------------------------------------------</span>
<a name="l05503"></a>05503     strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;outboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05504"></a>05504                           <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05505"></a>05505                           <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05506"></a>05506                           <span class="stringliteral">&quot; adjustment=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05507"></a>05507                           <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05508"></a>05508                           <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05509"></a>05509                           <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05510"></a>05510                           <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05511"></a>05511                           <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05512"></a>05512                           strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05513"></a>05513                           lDateSigned, 
<a name="l05514"></a>05514                           strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05515"></a>05515                           lAdjustment,
<a name="l05516"></a>05516                           lDisplayValue,
<a name="l05517"></a>05517                           <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l05518"></a>05518                           <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05519"></a>05519                           <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05520"></a>05520                           <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05521"></a>05521 }
<a name="l05522"></a>05522 
<a name="l05523"></a>05523 
<a name="l05524"></a><a class="code" href="class_o_t_transaction.html#ab15380c235814aeb89779fb5f42401d4">05524</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#ab15380c235814aeb89779fb5f42401d4">OTTransaction::SaveAbbreviatedInboxRecord</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l05525"></a>05525 {
<a name="l05526"></a>05526     <span class="comment">// This is the actual amount that your account is changed BY this receipt.</span>
<a name="l05527"></a>05527     <span class="comment">// Versus the useful amount the user will want to see (lDisplayValue.) For example, if you perform</span>
<a name="l05528"></a>05528     <span class="comment">// a transfer of 500 clams, then the money leaves your account at that time, and you receive a transaction receipt</span>
<a name="l05529"></a>05529     <span class="comment">// to that effect. LATER ON, when the recipient ACCEPTS the transfer, a &quot;transferReceipt&quot; will pop into your inbox,</span>
<a name="l05530"></a>05530     <span class="comment">// which you must accept in order to close out the transaction number. But this transferReceipt &quot;adjusts&quot; your account</span>
<a name="l05531"></a>05531     <span class="comment">// by ZERO, since the amount has ALREADY left your account before the transferReceipt arrived. In that example, the</span>
<a name="l05532"></a>05532     <span class="comment">// lAdjustment would be 0, while the lDisplayValue would be 500. The first value is the actual impact on your balance</span>
<a name="l05533"></a>05533     <span class="comment">// from that specific receipt, whereas the second value is the one that the user probably wants to see.</span>
<a name="l05534"></a>05534     
<a name="l05535"></a>05535     <span class="comment">// NOTE: A similar logic envelops the GetReferenceNumForDisplay() field, which, instead of returning the ACTUAL</span>
<a name="l05536"></a>05536     <span class="comment">// ref# that OT needs to use, it will return the one that the user probably wants to see.   </span>
<a name="l05537"></a>05537     <span class="comment">//</span>
<a name="l05538"></a>05538     int64_t lAdjustment = 0, lDisplayValue = 0;
<a name="l05539"></a>05539     <span class="comment">// ----------------------------------------------</span>
<a name="l05540"></a>05540     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05541"></a>05541     {
<a name="l05542"></a>05542             <span class="comment">// -- In inbox, pending hasn&#39;t been accepted yet. In outbox, it&#39;s already gone. Either</span>
<a name="l05543"></a>05543             <span class="comment">// way, it will have a 0 adjustment amount, even though perhaps 500 clams display amount. Here I use the 500</span>
<a name="l05544"></a>05544             <span class="comment">// for display, but in SaveAbbrevToOutbox, I multiply it by -1 so it appears as -500 (leaving my account.)</span>
<a name="l05545"></a>05545             <span class="comment">// -- In my inbox, the transferReceipt is notice of money that is already gone. It thus has adjustment value of 0.</span>
<a name="l05546"></a>05546             <span class="comment">// But the DISPLAY amount is the amount I originally sent. (Already multiplied by -1 by GetReceiptAmount())</span>
<a name="l05547"></a>05547             <span class="comment">//</span>
<a name="l05548"></a>05548         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:            <span class="comment">// (The pending amount is stored on the transfer item in my list of transaction items.)</span>
<a name="l05549"></a>05549         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:    <span class="comment">// The transferReceipt and voucherReceipt amounts are the display value (according to</span>
<a name="l05550"></a>05550         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:     <span class="comment">// GetReceiptAmount()), and not the actual value of 0.</span>
<a name="l05551"></a>05551             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05552"></a>05552             {
<a name="l05553"></a>05553                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05554"></a>05554                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05555"></a>05555             }
<a name="l05556"></a>05556             <span class="keywordflow">else</span>
<a name="l05557"></a>05557             {
<a name="l05558"></a>05558                 lAdjustment     = 0;                
<a name="l05559"></a>05559                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l05560"></a>05560             }
<a name="l05561"></a>05561             <span class="keywordflow">break</span>;
<a name="l05562"></a>05562             <span class="comment">// If chequeReceipt for 100 clams hit my inbox, then my balance is -100 from where it was. (Same</span>
<a name="l05563"></a>05563             <span class="comment">// value should be displayed.) Luckily, GetReceiptAmount() already multiplies by (-1) for chequeReceipt.</span>
<a name="l05564"></a>05564             <span class="comment">// For these (marketReceipt, paymentReceipt, basketReceipt), the actual adjustment is positive OR negative</span>
<a name="l05565"></a>05565             <span class="comment">// already, and the display value should match.</span>
<a name="l05566"></a>05566         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:      <span class="comment">// the amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l05567"></a>05567         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>:      <span class="comment">// amount is stored on marketReceipt item.  | </span>
<a name="l05568"></a>05568         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:     <span class="comment">// amount is stored on paymentReceipt item. | and the display value should match.</span>
<a name="l05569"></a>05569         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:      <span class="comment">// amount is stored on basketReceipt item.  | </span>
<a name="l05570"></a>05570             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05571"></a>05571             {
<a name="l05572"></a>05572                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05573"></a>05573                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05574"></a>05574             }
<a name="l05575"></a>05575             <span class="keywordflow">else</span>
<a name="l05576"></a>05576             {
<a name="l05577"></a>05577                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();   
<a name="l05578"></a>05578                 lDisplayValue   = lAdjustment;          
<a name="l05579"></a>05579             }
<a name="l05580"></a>05580             <span class="keywordflow">break</span>;
<a name="l05581"></a>05581         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:       <span class="comment">// amount is 0 according to GetReceiptAmount()</span>
<a name="l05582"></a>05582             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())                <span class="comment">// not the actual value of 0.</span>
<a name="l05583"></a>05583             {
<a name="l05584"></a>05584                 lAdjustment     = <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05585"></a>05585                 lDisplayValue   = <a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l05586"></a>05586             }
<a name="l05587"></a>05587             <span class="keywordflow">else</span>
<a name="l05588"></a>05588             {
<a name="l05589"></a>05589                 lAdjustment     = 0;
<a name="l05590"></a>05590                 lDisplayValue   = 0;
<a name="l05591"></a>05591             }                
<a name="l05592"></a>05592             <span class="keywordflow">break</span>;
<a name="l05593"></a>05593         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for inbox reports</span>
<a name="l05594"></a>05594         {
<a name="l05595"></a>05595             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unexpected %s transaction &quot;</span>
<a name="l05596"></a>05596                            <span class="stringliteral">&quot;in inbox while making abbreviated inbox record.\n&quot;</span>,
<a name="l05597"></a>05597                           __FUNCTION__, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l05598"></a>05598             
<a name="l05599"></a>05599             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT: OTTransaction::SaveAbbreviatedInboxRecord: unexpected transaction type.&quot;</span>);
<a name="l05600"></a>05600             
<a name="l05601"></a>05601         }
<a name="l05602"></a>05602             <span class="keywordflow">return</span>;
<a name="l05603"></a>05603     }   <span class="comment">// why not transfer receipt? Because the amount was already removed from your account when you transferred it,</span>
<a name="l05604"></a>05604 
<a name="l05605"></a>05605     <span class="comment">// ----------------------------------------------</span>
<a name="l05606"></a>05606     <span class="comment">// By this point, we know only the right types of receipts are being saved, and </span>
<a name="l05607"></a>05607     <span class="comment">// the adjustment and display value are both set correctly.</span>
<a name="l05608"></a>05608     
<a name="l05609"></a>05609     <span class="comment">// TYPE</span>
<a name="l05610"></a>05610     <a class="code" href="class_o_t_string.html">OTString</a>        strType;    <span class="comment">// &lt;===========</span>
<a name="l05611"></a>05611     <span class="keyword">const</span> <span class="keywordtype">char</span> *    pTypeStr = <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>();
<a name="l05612"></a>05612     strType.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>((NULL != pTypeStr) ? pTypeStr : <span class="stringliteral">&quot;error_state&quot;</span>);
<a name="l05613"></a>05613     <span class="comment">// ----------------------------------------------</span>
<a name="l05614"></a>05614     <span class="comment">// DATE SIGNED</span>
<a name="l05615"></a>05615     <span class="keyword">const</span> int64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="class_o_t_transaction.html#a88cd59fd4658e157f04e6b5b9a1868e0">m_DATE_SIGNED</a>);
<a name="l05616"></a>05616     <span class="comment">// ----------------------------------------------</span>
<a name="l05617"></a>05617     <span class="comment">// HASH OF THE COMPLETE &quot;BOX RECEIPT&quot;</span>
<a name="l05618"></a>05618     <span class="comment">// Save abbreviated is only used for receipts in boxes such as inbox, outbox, and nymbox.</span>
<a name="l05619"></a>05619     <span class="comment">// (Thus the moniker &quot;Box Receipt&quot;, as contrasted with cron receipts or normal transaction receipts with balance agreements.)</span>
<a name="l05620"></a>05620     <span class="comment">//</span>
<a name="l05621"></a>05621     <a class="code" href="class_o_t_string.html">OTString</a> strHash;
<a name="l05622"></a>05622     
<a name="l05623"></a>05623     <span class="comment">// If this is already an abbreviated record, then save the existing hash.</span>
<a name="l05624"></a>05624     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05625"></a>05625         <a class="code" href="class_o_t_transaction.html#aecaea3ab1909c7102800ac991771b84d">m_Hash</a>.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05626"></a>05626     <span class="comment">// Otherwise if it&#39;s a full record, then calculate the hash and save it.</span>
<a name="l05627"></a>05627     <span class="keywordflow">else</span>
<a name="l05628"></a>05628     {
<a name="l05629"></a>05629         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    idReceiptHash;              <span class="comment">// a hash of the actual transaction is stored with its</span>
<a name="l05630"></a>05630         this-&gt;<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(idReceiptHash);   <span class="comment">// abbreviated short-form record (in the inbox, for example.)</span>
<a name="l05631"></a>05631         idReceiptHash.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strHash);
<a name="l05632"></a>05632     }
<a name="l05633"></a>05633     <span class="comment">// ----------------------------------------------</span>
<a name="l05634"></a>05634     <span class="comment">/* </span>
<a name="l05635"></a>05635 <span class="comment">     NOTES...</span>
<a name="l05636"></a>05636 <span class="comment">     </span>
<a name="l05637"></a>05637 <span class="comment">     transactionType        m_Type;             // blank, pending, processInbox, transfer, deposit, withdrawal, payDividend, trade, etc.</span>
<a name="l05638"></a>05638 <span class="comment">     time64_t                   m_DATE_SIGNED;      // The date, in seconds, when the instrument was last signed.</span>
<a name="l05639"></a>05639 <span class="comment">     OTIdentifier           m_Hash;             // Created while saving abbreviated record, loaded back with it, then verified against actual hash when loading actual box receipt.</span>
<a name="l05640"></a>05640 <span class="comment">     int64_t                    m_lAbbrevAmount;    // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l05641"></a>05641 <span class="comment">     int64_t                    m_lDisplayAmount;   // Saved abbreviated from actual calculation, and set upon loading in abbrev mode.</span>
<a name="l05642"></a>05642 <span class="comment">     int64_t                    m_lTransactionNum;  // The server issues this and it must be sent with transaction request.</span>
<a name="l05643"></a>05643 <span class="comment">     int64_t                    m_lClosingTransactionNo; // used by finalReceipt</span>
<a name="l05644"></a>05644 <span class="comment">     int64_t                    m_lInReferenceToTransaction; </span>
<a name="l05645"></a>05645 <span class="comment">     int64_t                    m_lInRefDisplay</span>
<a name="l05646"></a>05646 <span class="comment">     */</span>
<a name="l05647"></a>05647     <span class="comment">/*  This is set upon loading in abbreviated form, and then cleared again </span>
<a name="l05648"></a>05648 <span class="comment">        when the actual box receipt is loaded:</span>
<a name="l05649"></a>05649 <span class="comment">     bool               m_bIsAbbreviated;   // this is set upon loading (Not stored at all.)</span>
<a name="l05650"></a>05650 <span class="comment">     */</span>
<a name="l05651"></a>05651     
<a name="l05652"></a>05652     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || 
<a name="l05653"></a>05653         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>))
<a name="l05654"></a>05654         <span class="comment">// ---------------------------</span>
<a name="l05655"></a>05655         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;inboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05656"></a>05656                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05657"></a>05657                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05658"></a>05658                               <span class="stringliteral">&quot; adjustment=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05659"></a>05659                               <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05660"></a>05660                               <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05661"></a>05661                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05662"></a>05662                               <span class="stringliteral">&quot; closingNum=\&quot;%lld\&quot;\n&quot;</span>  <span class="comment">// &lt;==========</span>
<a name="l05663"></a>05663                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05664"></a>05664                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05665"></a>05665                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05666"></a>05666                               lDateSigned, 
<a name="l05667"></a>05667                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05668"></a>05668                               lAdjustment,
<a name="l05669"></a>05669                               lDisplayValue,
<a name="l05670"></a>05670                               <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l05671"></a>05671                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05672"></a>05672                               <a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(),          <span class="comment">// &lt;==========</span>
<a name="l05673"></a>05673                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05674"></a>05674                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05675"></a>05675     <span class="keywordflow">else</span>
<a name="l05676"></a>05676         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;inboxRecord type=\&quot;%s\&quot;\n&quot;</span>
<a name="l05677"></a>05677                               <span class="stringliteral">&quot; dateSigned=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05678"></a>05678                               <span class="stringliteral">&quot; receiptHash=\&quot;%s\&quot;\n&quot;</span>
<a name="l05679"></a>05679                               <span class="stringliteral">&quot; adjustment=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05680"></a>05680                               <span class="stringliteral">&quot; displayValue=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05681"></a>05681                               <span class="stringliteral">&quot; numberOfOrigin=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05682"></a>05682                               <span class="stringliteral">&quot; transactionNum=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05683"></a>05683                               <span class="stringliteral">&quot; inRefDisplay=\&quot;%lld\&quot;\n&quot;</span>
<a name="l05684"></a>05684                               <span class="stringliteral">&quot; inReferenceTo=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l05685"></a>05685                               strType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05686"></a>05686                               lDateSigned, 
<a name="l05687"></a>05687                               strHash.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),                          
<a name="l05688"></a>05688                               lAdjustment,
<a name="l05689"></a>05689                               lDisplayValue,
<a name="l05690"></a>05690                               <a class="code" href="class_o_t_transaction_type.html#a0ae107e35e5532f2bd0e2df6989ff0a9">GetRawNumberOfOrigin</a>(),
<a name="l05691"></a>05691                               <a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l05692"></a>05692                               <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>(),
<a name="l05693"></a>05693                               <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05694"></a>05694 }
<a name="l05695"></a>05695 
<a name="l05696"></a>05696 
<a name="l05697"></a>05697 <span class="comment">// The ONE case where an Item has SUB-ITEMS is in the case of Balance Agreement.</span>
<a name="l05698"></a>05698 <span class="comment">// For example, you might have a Withdrawal Transaction (request) that contains</span>
<a name="l05699"></a>05699 <span class="comment">// 2 items: the withdrawal item itself, and the balance agreement item for that</span>
<a name="l05700"></a>05700 <span class="comment">// withdrawal.  The balance agreement item contains a LIST OF SUB ITEMS, each of</span>
<a name="l05701"></a>05701 <span class="comment">// which represents a chequeReceipt, marketReceipt, or paymentReceipt from my </span>
<a name="l05702"></a>05702 <span class="comment">// inbox. The Balance Agreement item needs to be able to report on the inbox</span>
<a name="l05703"></a>05703 <span class="comment">// status, so I give it a list of sub-items.</span>
<a name="l05704"></a>05704 <span class="comment">//</span>
<a name="l05705"></a><a class="code" href="class_o_t_transaction.html#a4a89382fb0a9a3500c19fe9107df3122">05705</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a4a89382fb0a9a3500c19fe9107df3122">OTTransaction::ProduceInboxReportItem</a>(<a class="code" href="class_o_t_item.html">OTItem</a> &amp; theBalanceItem) 
<a name="l05706"></a>05706 {   
<a name="l05707"></a>05707     <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTItem::error_state</a>;
<a name="l05708"></a>05708     
<a name="l05709"></a>05709     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;Producing statement report item for inbox item type: %s.\n&quot;</span>,
<a name="l05710"></a>05710                    <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>()); <span class="comment">// temp remove.</span>
<a name="l05711"></a>05711     
<a name="l05712"></a>05712     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05713"></a>05713     {   <span class="comment">// These are the types that have an amount (somehow)</span>
<a name="l05714"></a>05714         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:         <span class="comment">// the amount is stored on the transfer item in my list.</span>
<a name="l05715"></a>05715             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>;
<a name="l05716"></a>05716             <span class="keywordflow">break</span>;
<a name="l05717"></a>05717         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:   <span class="comment">// the amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l05718"></a>05718             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTItem::chequeReceipt</a>;
<a name="l05719"></a>05719             <span class="keywordflow">break</span>;
<a name="l05720"></a>05720         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:   <span class="comment">// the amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l05721"></a>05721             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTItem::voucherReceipt</a>;
<a name="l05722"></a>05722             <span class="keywordflow">break</span>;
<a name="l05723"></a>05723         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>:   <span class="comment">// the amount is stored on marketReceipt item</span>
<a name="l05724"></a>05724             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTItem::marketReceipt</a>;
<a name="l05725"></a>05725             <span class="keywordflow">break</span>;
<a name="l05726"></a>05726         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:  <span class="comment">// amount is stored on paymentReceipt item</span>
<a name="l05727"></a>05727             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTItem::paymentReceipt</a>;           
<a name="l05728"></a>05728             <span class="keywordflow">break</span>;
<a name="l05729"></a>05729         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: <span class="comment">// amount is 0 according to GetReceiptAmount()</span>
<a name="l05730"></a>05730             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTItem::transferReceipt</a>;          
<a name="l05731"></a>05731             <span class="keywordflow">break</span>;
<a name="l05732"></a>05732         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:  <span class="comment">// amount is stored on basketReceipt item.</span>
<a name="l05733"></a>05733             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTItem::basketReceipt</a>;            
<a name="l05734"></a>05734             <span class="keywordflow">break</span>;
<a name="l05735"></a>05735         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:   <span class="comment">// amount is 0 according to GetReceiptAmount()</span>
<a name="l05736"></a>05736             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTItem::finalReceipt</a>;         
<a name="l05737"></a>05737             <span class="keywordflow">break</span>;
<a name="l05738"></a>05738         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for inbox reports</span>
<a name="l05739"></a>05739         {
<a name="l05740"></a>05740             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;OTTransaction::ProduceInboxReportItem: Ignoring %s transaction &quot;</span>
<a name="l05741"></a>05741                            <span class="stringliteral">&quot;in inbox while making balance statement.\n&quot;</span>, <a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l05742"></a>05742         }
<a name="l05743"></a>05743             <span class="keywordflow">return</span>;
<a name="l05744"></a>05744     }   <span class="comment">// why not transfer receipt? Because the amount was already removed from your account when you transferred it,</span>
<a name="l05745"></a>05745         <span class="comment">// and you already signed a balance agreement at that time. Thus, nothing in your inbox is necessary to prove</span>
<a name="l05746"></a>05746         <span class="comment">// the change in balance -- you already signed off on it. UPDATE: that&#39;s okay since the below GetReceiptAmount()</span>
<a name="l05747"></a>05747         <span class="comment">// will return 0 for a transfer receipt anyway.</span>
<a name="l05748"></a>05748     
<a name="l05749"></a>05749     <span class="comment">// ---------------------------------------------------</span>
<a name="l05750"></a>05750     <span class="comment">// In the case of a cron receipt which is in the inbox, but is being accepted</span>
<a name="l05751"></a>05751     <span class="comment">// by a notarizeProcessInbox, (if theOwner is a processInbox transaction) then </span>
<a name="l05752"></a>05752     <span class="comment">// we don&#39;t want to report that item. Why not? Because if the processInbox is a</span>
<a name="l05753"></a>05753     <span class="comment">// success, the item would be presumed removed. (That&#39;s what the process aims to do,</span>
<a name="l05754"></a>05754     <span class="comment">// after all: accept and remove the market receipt.) Therefore, I don&#39;t want to add</span>
<a name="l05755"></a>05755     <span class="comment">// it to the report, since the server will then think it&#39;s supposed to be there, when</span>
<a name="l05756"></a>05756     <span class="comment">// in fact it&#39;s supposed to be gone. I&#39;m supposed to be showing a picture of what would</span>
<a name="l05757"></a>05757     <span class="comment">// be left in the event of a success. And if I successfully processed the receipt out of my</span>
<a name="l05758"></a>05758     <span class="comment">// inbox, then I would expect not to see it there anymore, so since that is what I would</span>
<a name="l05759"></a>05759     <span class="comment">// expect in that case, that is the picture I need to construct now.</span>
<a name="l05760"></a>05760     <span class="comment">//</span>
<a name="l05761"></a>05761     <span class="comment">// Thus, here we loop through theOwner (IF he&#39;s a process inbox transaction) and we see</span>
<a name="l05762"></a>05762     <span class="comment">// if he&#39;s actually trying to process a receipt off the inbox FOR ME (THIS transaction.) If he is, then</span>
<a name="l05763"></a>05763     <span class="comment">// we don&#39;t need to add this transaction to the report.</span>
<a name="l05764"></a>05764     <span class="comment">//</span>
<a name="l05765"></a>05765     <span class="comment">/*</span>
<a name="l05766"></a>05766 <span class="comment">    if (OTTransaction::processInbox == theOwner.GetType()) // &lt;==== IF it&#39;s a process inbox !!!</span>
<a name="l05767"></a>05767 <span class="comment">    {</span>
<a name="l05768"></a>05768 <span class="comment">        FOR_EACH(listOfItems, theOwner.GetItemList())</span>
<a name="l05769"></a>05769 <span class="comment">        {</span>
<a name="l05770"></a>05770 <span class="comment">            OTItem * pItem = *it;</span>
<a name="l05771"></a>05771 <span class="comment">            OT_ASSERT_MSG(NULL != pItem, &quot;Pointer should not have been NULL.&quot;);</span>
<a name="l05772"></a>05772 <span class="comment">            </span>
<a name="l05773"></a>05773 <span class="comment">            // In this place, it means that someone is trying to PROCESS his INBOX. He is looping through that inbox,</span>
<a name="l05774"></a>05774 <span class="comment">            // creating an INBOX REPORT, so he can attach it to the balance agreement for his PROCESS INBOX TRANSACTION.</span>
<a name="l05775"></a>05775 <span class="comment">            //</span>
<a name="l05776"></a>05776 <span class="comment">            // Well... What if, as part of processing his inbox, he is trying to remove some receipts?</span>
<a name="l05777"></a>05777 <span class="comment">            // If he tries to remove a marketReceipt, then we&#39;d expect, in the event of success, that</span>
<a name="l05778"></a>05778 <span class="comment">            // said marketReceipt would disappear from his inbox. </span>
<a name="l05779"></a>05779 <span class="comment">            //</span>
<a name="l05780"></a>05780 <span class="comment">            // The purpose of the balance agreement is to have both sides SIGN and AGREE what the picture looks</span>
<a name="l05781"></a>05781 <span class="comment">            // like, after and assuming the transaction is a success. If I SUCCESSFULLY remove </span>
<a name="l05782"></a>05782 <span class="comment">            </span>
<a name="l05783"></a>05783 <span class="comment">            if ((pItem-&gt;GetType() == OTItem::acceptCronReceipt) &amp;&amp; // &lt;==== IF AND IF, cron receipt, transaction number matches</span>
<a name="l05784"></a>05784 <span class="comment">                (pItem-&gt;GetReferenceToNum() == GetTransactionNum()))   // that means I&#39;m DEFINITELY accepting it aka REMOVING it, right?</span>
<a name="l05785"></a>05785 <span class="comment">            {</span>
<a name="l05786"></a>05786 <span class="comment">                return; // We don&#39;t add THIS transaction to the balance agreement item then, since</span>
<a name="l05787"></a>05787 <span class="comment">                        // the balance agreement is actually part of a transaction that is REMOVING</span>
<a name="l05788"></a>05788 <span class="comment">                        // THIS TRANSACTION from my inbox, and therefore I don&#39;t WANT it showing in</span>
<a name="l05789"></a>05789 <span class="comment">                        // the balance agreement. (Wouldn&#39;t expect it to be there, in the event of success.</span>
<a name="l05790"></a>05790 <span class="comment">                        // The whole idea is to sign a picture of how things would look IN THE EVENT OF SUCCESS.)</span>
<a name="l05791"></a>05791 <span class="comment">            }</span>
<a name="l05792"></a>05792 <span class="comment">            </span>
<a name="l05793"></a>05793 <span class="comment">            // Why is there not a similar if statement here for acceptItemReceipt, the way there is</span>
<a name="l05794"></a>05794 <span class="comment">            // for acceptCronReceipt? If it turns out to be an issue, this might just be where I&#39;d put it.</span>
<a name="l05795"></a>05795 <span class="comment">            </span>
<a name="l05796"></a>05796 <span class="comment">            // AHHH:  I bet this is done in the code that CALLS this function... I BET the relevant items</span>
<a name="l05797"></a>05797 <span class="comment">            // are ALREADY removed from the Inbox, BEFORE THIS FUNCTION IS EVEN CALLED... And THAT&#39;s why I don&#39;t</span>
<a name="l05798"></a>05798 <span class="comment">            // see the other things here that I would expect to see.</span>
<a name="l05799"></a>05799 <span class="comment">            //</span>
<a name="l05800"></a>05800 <span class="comment">            // Therefore, the above fix really needs to be MOVED to THAT LOCATION.</span>
<a name="l05801"></a>05801 <span class="comment">            // </span>
<a name="l05802"></a>05802 <span class="comment">            // FINAL NOTE: THAT IS CORRECT. (Done.) This function is meant to be called with the inbox SET UP PRIOR,</span>
<a name="l05803"></a>05803 <span class="comment">            // and for that Inbox to be passed in resembling the way it would in the event of success. This </span>
<a name="l05804"></a>05804 <span class="comment">            // function is NOT responsible for knowing about which kinds of transactions might need which numbers</span>
<a name="l05805"></a>05805 <span class="comment">            // removed. This function is too &quot;Dumb&quot; for that, at its level. It must assume the CALLER sets that up</span>
<a name="l05806"></a>05806 <span class="comment">            // in advance. Different callers set the inbox up in different ways, depending on what they are trying</span>
<a name="l05807"></a>05807 <span class="comment">            // to verify. (An &quot;accept basket receipt&quot; message would assume THAT basket receipt would be removed from Inbox,</span>
<a name="l05808"></a>05808 <span class="comment">            // whereas an &quot;accept market receipt&quot; message would assume that THAT market receipt would be removed. Etc.)</span>
<a name="l05809"></a>05809 <span class="comment">        }</span>
<a name="l05810"></a>05810 <span class="comment">    }</span>
<a name="l05811"></a>05811 <span class="comment">    */</span>
<a name="l05812"></a>05812     
<a name="l05813"></a>05813     <span class="comment">// -----------------------------------------------------------</span>
<a name="l05814"></a>05814     
<a name="l05815"></a>05815     <span class="comment">// the item will represent THIS TRANSACTION, and will be added to theBalanceItem.</span>
<a name="l05816"></a>05816     
<a name="l05817"></a>05817     <a class="code" href="class_o_t_item.html">OTItem</a> * pReportItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*<span class="keyword">this</span>, theItemType);
<a name="l05818"></a>05818     
<a name="l05819"></a>05819     <span class="keywordflow">if</span> (NULL != pReportItem) <span class="comment">// above line will assert if mem allocation fails.</span>
<a name="l05820"></a>05820     {       
<a name="l05821"></a>05821         int64_t lAmount = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l05822"></a>05822         pReportItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lAmount);
<a name="l05823"></a>05823         
<a name="l05824"></a>05824         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ae040aebddfa217a4fe5e349804f241e3">SetTransactionNum</a>(<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// Just making sure these both get set.</span>
<a name="l05825"></a>05825         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// Especially this one.</span>
<a name="l05826"></a>05826         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l05827"></a>05827         
<a name="l05828"></a>05828         <span class="comment">// The &quot;closing transaction number&quot; is only used on finalReceipts and basketReceipts.</span>
<a name="l05829"></a>05829         <span class="comment">// FYI, Any cron receipts need to see if there is a corresponding final receipt before checking</span>
<a name="l05830"></a>05830         <span class="comment">// their transaction number for validity (since it changes that number)... and also, if the final</span>
<a name="l05831"></a>05831         <span class="comment">// receipt itself is present, then ALL of the cron receipts that it corresponds to must be closed!</span>
<a name="l05832"></a>05832         <span class="comment">//</span>
<a name="l05833"></a>05833         <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) || (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a> == <a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>))
<a name="l05834"></a>05834             pReportItem-&gt;<a class="code" href="class_o_t_item.html#ac32063404467c6754fd61727293d6b63">SetClosingNum</a>(<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
<a name="l05835"></a>05835             
<a name="l05836"></a>05836         theBalanceItem.<a class="code" href="class_o_t_item.html#aeb2726026df1021187b12ba760a91c2f">AddItem</a>(*pReportItem); <span class="comment">// Now theBalanceItem will handle cleaning it up.</span>
<a name="l05837"></a>05837         
<a name="l05838"></a>05838         <span class="comment">// No need to sign/save pReportItem, since it is just used for in-memory storage, and is</span>
<a name="l05839"></a>05839         <span class="comment">// otherwise saved as part of its owner&#39;s data, as part of its owner. (As long as theBalanceItem</span>
<a name="l05840"></a>05840         <span class="comment">// is signed and saved, which the caller does, then we&#39;re fine.)</span>
<a name="l05841"></a>05841     }
<a name="l05842"></a>05842 }
<a name="l05843"></a>05843 
<a name="l05844"></a>05844 
<a name="l05845"></a>05845 <span class="comment">// No longer using outbox hash :(</span>
<a name="l05846"></a>05846 <span class="comment">// Since I would have to add the pending items to the outbox and calculate</span>
<a name="l05847"></a>05847 <span class="comment">// it myself, and there&#39;s no way every single byte would be the same as the server</span>
<a name="l05848"></a>05848 <span class="comment">// (Well with this implementation there is, actually, but what one of the items</span>
<a name="l05849"></a>05849 <span class="comment">// in the outbox is SIGNED by me on one side, and by the server on the other? the</span>
<a name="l05850"></a>05850 <span class="comment">// hashes won&#39;t match!)  Therefore I&#39;m sending a real outbox report, the same as</span>
<a name="l05851"></a>05851 <span class="comment">// I do for the inbox. In fact, it&#39;s the same report! Just more items being added.</span>
<a name="l05852"></a>05852 <span class="comment">//</span>
<a name="l05853"></a><a class="code" href="class_o_t_transaction.html#a1820ab7e64e5cd46baf19f21ce2f0bf0">05853</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#a1820ab7e64e5cd46baf19f21ce2f0bf0">OTTransaction::ProduceOutboxReportItem</a>(<a class="code" href="class_o_t_item.html">OTItem</a> &amp; theBalanceItem) 
<a name="l05854"></a>05854 {   
<a name="l05855"></a>05855     <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a417077fa11eb89c00074c64eb4e13c91">OTItem::error_state</a>;
<a name="l05856"></a>05856     
<a name="l05857"></a>05857     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#a11a0ffdda3eec332af5637526560ee6d">m_Type</a>) 
<a name="l05858"></a>05858     {
<a name="l05859"></a>05859         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:
<a name="l05860"></a>05860             theItemType = <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>;
<a name="l05861"></a>05861             <span class="keywordflow">break</span>;
<a name="l05862"></a>05862         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant for outbox reports.</span>
<a name="l05863"></a>05863             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProduceOutboxReportItem: Error, wrong item type. Returning.\n&quot;</span>);
<a name="l05864"></a>05864             <span class="keywordflow">return</span>;
<a name="l05865"></a>05865     }
<a name="l05866"></a>05866     
<a name="l05867"></a>05867     <span class="comment">// the item will represent THIS TRANSACTION, and will be added to theBalanceItem.</span>
<a name="l05868"></a>05868     
<a name="l05869"></a>05869     <a class="code" href="class_o_t_item.html">OTItem</a> * pReportItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*<span class="keyword">this</span>, theItemType);
<a name="l05870"></a>05870     
<a name="l05871"></a>05871     <span class="keywordflow">if</span> (NULL != pReportItem) <span class="comment">// above line will assert if mem allocation fails.</span>
<a name="l05872"></a>05872     {
<a name="l05873"></a>05873         <span class="comment">// I get away with &quot;carte blanche&quot; multiplying it by -1 here, because I&#39;ve</span>
<a name="l05874"></a>05874         <span class="comment">// already verified that this is ONLY an OTTransaction::transfer before even</span>
<a name="l05875"></a>05875         <span class="comment">// getting this far. There is no other transaction type that I even have to </span>
<a name="l05876"></a>05876         <span class="comment">// worry about.</span>
<a name="l05877"></a>05877         <span class="keyword">const</span> int64_t lAmount = <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()*(-1); <span class="comment">// in outbox, a transfer is leaving my account. Balance gets smaller.</span>
<a name="l05878"></a>05878         pReportItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lAmount);
<a name="l05879"></a>05879         
<a name="l05880"></a>05880         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ae040aebddfa217a4fe5e349804f241e3">SetTransactionNum</a>(<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// Just making sure these both get set.</span>
<a name="l05881"></a>05881         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// Especially this one.</span>
<a name="l05882"></a>05882         pReportItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l05883"></a>05883 
<a name="l05884"></a>05884         theBalanceItem.<a class="code" href="class_o_t_item.html#aeb2726026df1021187b12ba760a91c2f">AddItem</a>(*pReportItem); <span class="comment">// Now theBalanceItem will handle cleaning it up.</span>
<a name="l05885"></a>05885         
<a name="l05886"></a>05886         
<a name="l05887"></a>05887         <span class="comment">// debugging remove this</span>
<a name="l05888"></a>05888 <span class="comment">//      OTLog::vError(&quot;PRODUCING OUTBOX REPORT ITEM: lAmount: %lld  Trans# %lld  Ref# %lld \n&quot;, lAmount,</span>
<a name="l05889"></a>05889 <span class="comment">//                    pReportItem-&gt;GetTransactionNum(), pReportItem-&gt;GetReferenceToNum());</span>
<a name="l05890"></a>05890         
<a name="l05891"></a>05891         <span class="comment">// No need to sign/save pReportItem, since it is just used for in-memory storage, and is</span>
<a name="l05892"></a>05892         <span class="comment">// otherwise saved as part of its owner&#39;s data, as part of its owner. (As long as theBalanceItem</span>
<a name="l05893"></a>05893         <span class="comment">// is signed and saved, which the caller does, then we&#39;re fine.)</span>
<a name="l05894"></a>05894     }
<a name="l05895"></a>05895 }
<a name="l05896"></a>05896 
<a name="l05897"></a>05897 
<a name="l05898"></a>05898 <span class="comment">// A Transaction normally doesn&#39;t have an amount. (Only a transaction item does.)</span>
<a name="l05899"></a>05899 <span class="comment">// But this function will look up the item, when appropriate, and find out the amount.</span>
<a name="l05900"></a>05900 <span class="comment">//</span>
<a name="l05901"></a>05901 <span class="comment">// That way we can record it during a balance agreement.</span>
<a name="l05902"></a>05902 <span class="comment">// NOTE: Not ALL transaction types with an amount are listed here,</span>
<a name="l05903"></a>05903 <span class="comment">// just the ones necessary for balance agreement.</span>
<a name="l05904"></a>05904 <span class="comment">//</span>
<a name="l05905"></a><a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">05905</a> int64_t <a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">OTTransaction::GetReceiptAmount</a>()
<a name="l05906"></a>05906 {
<a name="l05907"></a>05907     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l05908"></a>05908         <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#a26f3f7cf81e9b5fdd2c66646713a4e95">GetAbbrevAdjustment</a>();
<a name="l05909"></a>05909     <span class="comment">// ---------------------------</span>
<a name="l05910"></a>05910     int64_t lAdjustment = 0;
<a name="l05911"></a>05911         
<a name="l05912"></a>05912     <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL;
<a name="l05913"></a>05913     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel;
<a name="l05914"></a>05914 
<a name="l05915"></a>05915     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l05916"></a>05916     {   <span class="comment">// These are the types that have an amount (somehow)</span>
<a name="l05917"></a>05917         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>: <span class="comment">// amount is stored on ** marketReceipt item **, on MY LIST of items.</span>
<a name="l05918"></a>05918             pOriginalItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>); <span class="comment">// (The Reference string contains an OTCronItem with the Original Trade.)</span>
<a name="l05919"></a>05919             <span class="keywordflow">break</span>;                                          <span class="comment">// The &quot;reference to&quot; ID is </span>
<a name="l05920"></a>05920         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>: <span class="comment">// amount is stored on ** paymentReceipt ** item, on MY LIST of items.</span>
<a name="l05921"></a>05921             pOriginalItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l05922"></a>05922             <span class="keywordflow">break</span>;
<a name="l05923"></a>05923         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:  <span class="comment">// amount is stored on ** basketReceipt ** item, on MY LIST of items.</span>
<a name="l05924"></a>05924             pOriginalItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aeffa6527cfbdeaa83144e89b4cc3779f">OTItem::basketReceipt</a>);
<a name="l05925"></a>05925             <span class="keywordflow">break</span>;
<a name="l05926"></a>05926         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on the ** transfer item **, here as reference string.</span>
<a name="l05927"></a>05927         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>: <span class="comment">// amount is stored on *cheque* (attached to ** depositCheque ITEM **, which is here as reference string.)</span>
<a name="l05928"></a>05928         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on *voucher* (attached to ** depositCheque ITEM **, which is here as reference string.)</span>
<a name="l05929"></a>05929         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:    <span class="comment">// amount is stored on ** acceptPending ITEM **, (here as reference string.)</span>
<a name="l05930"></a>05930         {
<a name="l05931"></a>05931             <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l05932"></a>05932             <a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l05933"></a>05933 
<a name="l05934"></a>05934             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05935"></a>05935             
<a name="l05936"></a>05936             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l05937"></a>05937                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l05938"></a>05938             
<a name="l05939"></a>05939             <span class="keywordflow">break</span>;
<a name="l05940"></a>05940         }   
<a name="l05941"></a>05941             
<a name="l05942"></a>05942         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l05943"></a>05943             <span class="keywordflow">return</span> 0;
<a name="l05944"></a>05944     }
<a name="l05945"></a>05945     <span class="comment">// -------------------------------------------------</span>
<a name="l05946"></a>05946     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l05947"></a>05947     {
<a name="l05948"></a>05948         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to find original item. Should never happen.\n&quot;</span>,
<a name="l05949"></a>05949                       __FUNCTION__);
<a name="l05950"></a>05950         <span class="keywordflow">return</span> 0; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l05951"></a>05951     }
<a name="l05952"></a>05952     <span class="comment">// -------------------------------------------------    </span>
<a name="l05953"></a>05953     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l05954"></a>05954     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l05955"></a>05955 
<a name="l05956"></a>05956     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l05957"></a>05957     {   <span class="comment">// These are the types that have an amount (somehow)</span>
<a name="l05958"></a>05958         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>: <span class="comment">// amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l05959"></a>05959         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l05960"></a>05960         {
<a name="l05961"></a>05961             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l05962"></a>05962             {
<a name="l05963"></a>05963                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s. (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l05964"></a>05964                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l05965"></a>05965                 <span class="keywordflow">return</span> 0;
<a name="l05966"></a>05966             }
<a name="l05967"></a>05967             
<a name="l05968"></a>05968             <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l05969"></a>05969             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strAttachment);
<a name="l05970"></a>05970             <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAttachment);
<a name="l05971"></a>05971             
<a name="l05972"></a>05972             <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l05973"></a>05973             {
<a name="l05974"></a>05974                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);
<a name="l05975"></a>05975                 
<a name="l05976"></a>05976                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque from string in OTTransaction::%s:\n%s\n&quot;</span>,
<a name="l05977"></a>05977                               __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05978"></a>05978             }
<a name="l05979"></a>05979             <span class="keywordflow">else</span> 
<a name="l05980"></a>05980             {
<a name="l05981"></a>05981                 lAdjustment = (theCheque.<a class="code" href="class_o_t_cheque.html#a84e570d654f20e69f64f0037b96b7c7e">GetAmount</a>()*(-1)); <span class="comment">// a cheque reduces my balance, unless it&#39;s negative.</span>
<a name="l05982"></a>05982             }                                               <span class="comment">// So if I wrote a 100 clam cheque, that  means -100 hit my account when I got the</span>
<a name="l05983"></a>05983                                                             <span class="comment">// chequeReceipt, and writing a -100c cheque means 100 went in when I got the chequeReceipt.</span>
<a name="l05984"></a>05984         }
<a name="l05985"></a>05985             <span class="keywordflow">break</span>;
<a name="l05986"></a>05986             
<a name="l05987"></a>05987             <span class="comment">// NOTE: a voucherReceipt (above) doesn&#39;t actually change your balance,</span>
<a name="l05988"></a>05988             <span class="comment">// and neither does a transferReceipt. (below) But they both have a</span>
<a name="l05989"></a>05989             <span class="comment">// &quot;receipt amount&quot; for display purposes.</span>
<a name="l05990"></a>05990             
<a name="l05991"></a>05991         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: <span class="comment">// amount is stored on acceptPending item. (Server refuses acceptPendings with wrong amount on them.)</span>
<a name="l05992"></a>05992             
<a name="l05993"></a>05993             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>)
<a name="l05994"></a>05994             {
<a name="l05995"></a>05995                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to transferReceipt\n&quot;</span>);
<a name="l05996"></a>05996             }
<a name="l05997"></a>05997             <span class="keywordflow">else</span>
<a name="l05998"></a>05998             {   <span class="comment">// If I transfer 100 clams to someone, then my account is smaller by 100 clams. -100 has hit my account.</span>
<a name="l05999"></a>05999                 <span class="comment">// So the pending will show as -100 in my outbox, not 100, because that is the adjustment actually made to my account.</span>
<a name="l06000"></a>06000                 <span class="comment">// This positive/negative aspect of pending transactions is not stored in the data itself, since it switches based</span>
<a name="l06001"></a>06001                 <span class="comment">// on whether the pending appears in the inbox or the outbox. It&#39;s based on context. Whereas the transferReceipt</span>
<a name="l06002"></a>06002                 <span class="comment">// is IN REFERENCE TO that same transaction--it appears in my inbox when the recipient accepts the pending transfer</span>
<a name="l06003"></a>06003                 <span class="comment">// I sent him.) Therefore the transferReceipt is &quot;worth&quot; -100 (just as the pending in my outbox was &quot;worth&quot; -100), even</span>
<a name="l06004"></a>06004                 <span class="comment">// though its actual value is 0.</span>
<a name="l06005"></a>06005                 <span class="comment">// (Since the transferReceipt itself doesn&#39;t change my balance, but merely is a notice that such has happened.) You could</span>
<a name="l06006"></a>06006                 <span class="comment">// say, for example in the SaveAbbreviatedToInbox() function, that the transferReceipt has an &quot;actual value&quot; of 0 and a</span>
<a name="l06007"></a>06007                 <span class="comment">// &quot;display value&quot; of -100 clams, when it is in reference to an original transfer of 100 clams.</span>
<a name="l06008"></a>06008                 <span class="comment">// This function is clearly returning the display value, since the actual value (of 0) is useless, since balance</span>
<a name="l06009"></a>06009                 <span class="comment">// agreements already discount transferReceipts as having any impact on the balance.</span>
<a name="l06010"></a>06010                 <span class="comment">//</span>
<a name="l06011"></a>06011                 lAdjustment = (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()*(-1)); <span class="comment">// &lt;====================</span>
<a name="l06012"></a>06012             }
<a name="l06013"></a>06013             <span class="keywordflow">break</span>;
<a name="l06014"></a>06014         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on transfer item</span>
<a name="l06015"></a>06015             
<a name="l06016"></a>06016             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)
<a name="l06017"></a>06017             {
<a name="l06018"></a>06018                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to pending transfer\n&quot;</span>);
<a name="l06019"></a>06019             }
<a name="l06020"></a>06020             <span class="keywordflow">else</span>
<a name="l06021"></a>06021             {
<a name="l06022"></a>06022                 <span class="comment">// Pending transfer adds to my account if this is inbox, and removes if outbox. </span>
<a name="l06023"></a>06023                 <span class="comment">// I&#39;ll let the caller multiply by (-1) or not. His choice.</span>
<a name="l06024"></a>06024                 <span class="comment">// Note: Indeed, if you look in ProduceOutboxReportItem(), it is multiplying by (-1).</span>
<a name="l06025"></a>06025                 lAdjustment = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();   
<a name="l06026"></a>06026             }
<a name="l06027"></a>06027             <span class="keywordflow">break</span>;
<a name="l06028"></a>06028         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>: <span class="comment">// amount is stored on marketReceipt item</span>
<a name="l06029"></a>06029             
<a name="l06030"></a>06030             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTItem::marketReceipt</a>)
<a name="l06031"></a>06031             {
<a name="l06032"></a>06032                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to marketReceipt\n&quot;</span>);
<a name="l06033"></a>06033             }
<a name="l06034"></a>06034             <span class="keywordflow">else</span>
<a name="l06035"></a>06035             {
<a name="l06036"></a>06036                 lAdjustment = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();   <span class="comment">// THIS WILL ALSO USE THE POSITIVE / NEGATIVE THING. (Already.)</span>
<a name="l06037"></a>06037             }
<a name="l06038"></a>06038             <span class="keywordflow">break</span>;
<a name="l06039"></a>06039         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>: <span class="comment">// amount is stored on paymentReceipt item</span>
<a name="l06040"></a>06040             
<a name="l06041"></a>06041             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTItem::paymentReceipt</a>)
<a name="l06042"></a>06042             {
<a name="l06043"></a>06043                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to paymentReceipt\n&quot;</span>);
<a name="l06044"></a>06044             }
<a name="l06045"></a>06045             <span class="keywordflow">else</span>
<a name="l06046"></a>06046             {
<a name="l06047"></a>06047                 lAdjustment = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();   <span class="comment">// THIS WILL ALSO USE THE POSITIVE / NEGATIVE THING. (Already.)</span>
<a name="l06048"></a>06048             }
<a name="l06049"></a>06049             <span class="keywordflow">break</span>;
<a name="l06050"></a>06050         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:  <span class="comment">// amount is stored on basketReceipt item</span>
<a name="l06051"></a>06051             
<a name="l06052"></a>06052             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTItem::basketReceipt</a>)
<a name="l06053"></a>06053             {
<a name="l06054"></a>06054                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to basketReceipt\n&quot;</span>);
<a name="l06055"></a>06055             }
<a name="l06056"></a>06056             <span class="keywordflow">else</span>
<a name="l06057"></a>06057             {
<a name="l06058"></a>06058                 lAdjustment = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();   <span class="comment">// THIS WILL ALSO USE THE POSITIVE / NEGATIVE THING. (Already.)</span>
<a name="l06059"></a>06059             }
<a name="l06060"></a>06060             
<a name="l06061"></a>06061             <span class="keywordflow">break</span>;
<a name="l06062"></a>06062         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l06063"></a>06063             <span class="keywordflow">return</span> 0;
<a name="l06064"></a>06064     }
<a name="l06065"></a>06065 
<a name="l06066"></a>06066     <span class="keywordflow">return</span> lAdjustment;
<a name="l06067"></a>06067 }
<a name="l06068"></a>06068 
<a name="l06069"></a>06069 
<a name="l06070"></a>06070 <span class="comment">// Need to know the transaction number of the ORIGINAL transaction? Call this.</span>
<a name="l06071"></a>06071 <span class="comment">// virtual</span>
<a name="l06072"></a><a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">06072</a> int64_t <a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">OTTransaction::GetNumberOfOrigin</a>()
<a name="l06073"></a>06073 {
<a name="l06074"></a>06074     <span class="comment">// --------------------------------</span>
<a name="l06075"></a>06075     <span class="keywordflow">if</span> (0 == <a class="code" href="class_o_t_transaction_type.html#a472b8131dde4747044a1784dd2935091">m_lNumberOfOrigin</a>)
<a name="l06076"></a>06076     {
<a name="l06077"></a>06077         <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l06078"></a>06078         {
<a name="l06079"></a>06079             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">transferReceipt</a>:       <span class="comment">// the server drops this into your inbox, when someone accepts your transfer.</span>
<a name="l06080"></a>06080             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">deposit</a>:               <span class="comment">// this transaction is a deposit (cash or cheque)</span>
<a name="l06081"></a>06081             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">atDeposit</a>:             <span class="comment">// reply from the server regarding a deposit request</span>
<a name="l06082"></a>06082             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">instrumentNotice</a>:      <span class="comment">// Receive these in paymentInbox (by way of Nymbox), and send in Outpayments.</span>
<a name="l06083"></a>06083             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">instrumentRejection</a>:   <span class="comment">// When someone rejects your invoice, you get one of these in YOUR paymentInbox.</span>
<a name="l06084"></a>06084                 <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l06085"></a>06085                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: In this case, you can&#39;t calculate the origin number, you must set it explicitly.\n&quot;</span>,
<a name="l06086"></a>06086                               __FUNCTION__);
<a name="l06087"></a>06087                 this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(0);  <span class="comment">// Not applicable.</span>
<a name="l06088"></a>06088                 <span class="comment">// Comment this out later so people can&#39;t use it to crash the server:</span>
<a name="l06089"></a>06089                 <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;In this case, you can&#39;t calculate the origin number, you must set it explicitly.&quot;</span>);
<a name="l06090"></a>06090                 <span class="keywordflow">break</span>;
<a name="l06091"></a>06091             <span class="keywordflow">default</span>:
<a name="l06092"></a>06092                 <span class="keywordflow">break</span>;
<a name="l06093"></a>06093         }
<a name="l06094"></a>06094         <span class="comment">// -----------------------------</span>
<a name="l06095"></a>06095         this-&gt;<a class="code" href="class_o_t_transaction.html#ac20ace2092e06d5bf3d624b03eb6d623">CalculateNumberOfOrigin</a>();
<a name="l06096"></a>06096     }
<a name="l06097"></a>06097     <span class="comment">// -----------------------------    </span>
<a name="l06098"></a>06098     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction_type.html#a472b8131dde4747044a1784dd2935091">m_lNumberOfOrigin</a>;
<a name="l06099"></a>06099 }
<a name="l06100"></a>06100 
<a name="l06101"></a>06101 
<a name="l06102"></a>06102 <span class="comment">//virtual</span>
<a name="l06103"></a><a class="code" href="class_o_t_transaction.html#ac20ace2092e06d5bf3d624b03eb6d623">06103</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_transaction.html#ac20ace2092e06d5bf3d624b03eb6d623">OTTransaction::CalculateNumberOfOrigin</a>()
<a name="l06104"></a>06104 {
<a name="l06105"></a>06105     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(!<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>());
<a name="l06106"></a>06106     <span class="comment">// ----------------------------    </span>
<a name="l06107"></a>06107     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l06108"></a>06108     {
<a name="l06109"></a>06109         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">blank</a>:           <span class="comment">// freshly issued transaction number, not used yet</span>
<a name="l06110"></a>06110         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">message</a>:         <span class="comment">// A message from one user to another, also in the nymbox.</span>
<a name="l06111"></a>06111         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">notice</a>:          <span class="comment">// A notice from the server. Used in Nymbox.</span>
<a name="l06112"></a>06112         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">replyNotice</a>:     <span class="comment">// A copy of a server reply to a previous request you sent. (To make SURE you get the reply.)</span>
<a name="l06113"></a>06113         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">successNotice</a>:   <span class="comment">// A transaction # has successfully been signed out.</span>
<a name="l06114"></a>06114         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac0914e62639aebd987882e21bdff890d">processNymbox</a>:   <span class="comment">// process nymbox transaction    // comes from client</span>
<a name="l06115"></a>06115         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">atProcessNymbox</a>: <span class="comment">// process nymbox reply          // comes from server</span>
<a name="l06116"></a>06116             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(0);  <span class="comment">// Not applicable.</span>
<a name="l06117"></a>06117             <span class="keywordflow">break</span>;
<a name="l06118"></a>06118         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06119"></a>06119         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">pending</a>:         <span class="comment">// Server puts this in your outbox (when sending) and recipient&#39;s inbox.</span>
<a name="l06120"></a>06120         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">marketReceipt</a>:   <span class="comment">// server periodically drops this into your inbox if an offer is live.</span>
<a name="l06121"></a>06121         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">paymentReceipt</a>:  <span class="comment">// the server drops this into people&#39;s inboxes, every time a payment processes.</span>
<a name="l06122"></a>06122         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">finalReceipt</a>:    <span class="comment">// the server drops this into your in/nym box(es), when a CronItem expires or is canceled.</span>
<a name="l06123"></a>06123         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">basketReceipt</a>:   <span class="comment">// the server drops this into your inboxes, when a basket exchange is processed.</span>
<a name="l06124"></a>06124             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(this-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// pending is in reference to the original transfer.</span>
<a name="l06125"></a>06125             <span class="keywordflow">break</span>;
<a name="l06126"></a>06126         <span class="comment">// --------------------------------------------------------------------------------------            </span>
<a name="l06127"></a>06127         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">transferReceipt</a>:       <span class="comment">// the server drops this into your inbox, when someone accepts your transfer.</span>
<a name="l06128"></a>06128         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">deposit</a>:               <span class="comment">// this transaction is a deposit (cash or cheque)</span>
<a name="l06129"></a>06129         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">atDeposit</a>:             <span class="comment">// reply from the server regarding a deposit request</span>
<a name="l06130"></a>06130         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">instrumentNotice</a>:      <span class="comment">// Receive these in paymentInbox (by way of Nymbox), and send in Outpayments.</span>
<a name="l06131"></a>06131         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">instrumentRejection</a>:   <span class="comment">// When someone rejects your invoice, you get one of these in YOUR paymentInbox.</span>
<a name="l06132"></a>06132             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: In this case, you can&#39;t calculate the origin number, you must set it explicitly.\n&quot;</span>,
<a name="l06133"></a>06133                           __FUNCTION__);
<a name="l06134"></a>06134             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(0);  <span class="comment">// Not applicable.</span>
<a name="l06135"></a>06135             <span class="comment">// Comment this out later so people can&#39;t use it to crash the server:</span>
<a name="l06136"></a>06136             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;In this case, you can&#39;t calculate the origin number, you must set it explicitly.&quot;</span>);
<a name="l06137"></a>06137             <span class="keywordflow">break</span>;
<a name="l06138"></a>06138         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06139"></a>06139         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">chequeReceipt</a>:   <span class="comment">// the server drops this into your inbox, when someone deposits your cheque.</span>
<a name="l06140"></a>06140         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">voucherReceipt</a>:  <span class="comment">// the server drops this into your inbox, when someone deposits your voucher.</span>
<a name="l06141"></a>06141         {
<a name="l06142"></a>06142             <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l06143"></a>06143             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l06144"></a>06144             
<a name="l06145"></a>06145             <span class="comment">// &quot;In reference to&quot; is the depositor&#39;s trans#, which I use here to load the depositor&#39;s</span>
<a name="l06146"></a>06146             <span class="comment">// depositCheque item, which I use to get the cheque, which contains the number of origin</span>
<a name="l06147"></a>06147             <span class="comment">// as its transaction number.</span>
<a name="l06148"></a>06148             <span class="comment">//</span>
<a name="l06149"></a>06149             <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference,
<a name="l06150"></a>06150                                                                   this-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(),
<a name="l06151"></a>06151                                                                   this-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l06152"></a>06152             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOriginalItem);
<a name="l06153"></a>06153             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);
<a name="l06154"></a>06154             <span class="comment">// ------------------------------------------------</span>
<a name="l06155"></a>06155             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> != pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l06156"></a>06156             {
<a name="l06157"></a>06157                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: Wrong item type attached to %s &quot;</span>
<a name="l06158"></a>06158                               <span class="stringliteral">&quot;(expected OTItem::depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l06159"></a>06159                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">chequeReceipt</a> == this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l06160"></a>06160                 this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(0);
<a name="l06161"></a>06161                 <span class="keywordflow">return</span>;
<a name="l06162"></a>06162             }
<a name="l06163"></a>06163             <span class="comment">// ------------------------------------------------</span>
<a name="l06164"></a>06164             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
<a name="l06165"></a>06165         }
<a name="l06166"></a>06166             <span class="keywordflow">break</span>;
<a name="l06167"></a>06167         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06168"></a>06168         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">processInbox</a>:      <span class="comment">// process inbox transaction    // comes from client</span>
<a name="l06169"></a>06169         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">atProcessInbox</a>:    <span class="comment">// process inbox reply          // comes from server</span>
<a name="l06170"></a>06170         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06171"></a>06171         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">transfer</a>:          <span class="comment">// or &quot;spend&quot;. This transaction is a request to transfer from one account to another</span>
<a name="l06172"></a>06172         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">atTransfer</a>:        <span class="comment">// reply from the server regarding a transfer request</span>
<a name="l06173"></a>06173         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06174"></a>06174         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">withdrawal</a>:        <span class="comment">// this transaction is a withdrawal (cash or voucher)</span>
<a name="l06175"></a>06175         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">atWithdrawal</a>:      <span class="comment">// reply from the server regarding a withdrawal request</span>
<a name="l06176"></a>06176         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06177"></a>06177         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">marketOffer</a>:       <span class="comment">// this transaction is a market offer</span>
<a name="l06178"></a>06178         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">atMarketOffer</a>:     <span class="comment">// reply from the server regarding a market offer</span>
<a name="l06179"></a>06179         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06180"></a>06180         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">paymentPlan</a>:       <span class="comment">// this transaction is a payment plan</span>
<a name="l06181"></a>06181         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">atPaymentPlan</a>:     <span class="comment">// reply from the server regarding a payment plan</span>
<a name="l06182"></a>06182         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06183"></a>06183         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">smartContract</a>:     <span class="comment">// this transaction is a smart contract</span>
<a name="l06184"></a>06184         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">atSmartContract</a>:   <span class="comment">// reply from the server regarding a smart contract</span>
<a name="l06185"></a>06185         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06186"></a>06186         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">cancelCronItem</a>:    <span class="comment">// this transaction is intended to cancel a market offer or payment plan.</span>
<a name="l06187"></a>06187         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">atCancelCronItem</a>:  <span class="comment">// reply from the server regarding said cancellation.</span>
<a name="l06188"></a>06188         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06189"></a>06189         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">exchangeBasket</a>:    <span class="comment">// this transaction is an exchange in/out of a basket currency.</span>
<a name="l06190"></a>06190         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">atExchangeBasket</a>:  <span class="comment">// reply from the server regarding said exchange.</span>
<a name="l06191"></a>06191         <span class="comment">// --------------------------------------------------------------------------------------</span>
<a name="l06192"></a>06192         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">payDividend</a>:       <span class="comment">// this transaction is dividend payment (to all shareholders...)</span>
<a name="l06193"></a>06193         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">atPayDividend</a>:     <span class="comment">// reply from the server regarding said dividend payment.</span>
<a name="l06194"></a>06194         <span class="comment">// --------------------------------------------------------------------------------------            </span>
<a name="l06195"></a>06195         <span class="keywordflow">default</span>:
<a name="l06196"></a>06196             this-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l06197"></a>06197             <span class="keywordflow">break</span>;
<a name="l06198"></a>06198     } <span class="comment">// switch</span>
<a name="l06199"></a>06199 }
<a name="l06200"></a>06200 
<a name="l06201"></a>06201 
<a name="l06224"></a><a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">06224</a> int64_t <a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">OTTransaction::GetReferenceNumForDisplay</a>()
<a name="l06225"></a>06225 {
<a name="l06226"></a>06226    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l06227"></a>06227       <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#a5d52aa9eeff78830b9ba53585e36a2ad">GetAbbrevInRefDisplay</a>();
<a name="l06228"></a>06228    <span class="comment">// ----------------------------</span>
<a name="l06229"></a>06229    int64_t lReferenceNum = 0;
<a name="l06230"></a>06230    
<a name="l06231"></a>06231     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel;
<a name="l06232"></a>06232         
<a name="l06233"></a>06233     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06234"></a>06234     {
<a name="l06235"></a>06235             <span class="comment">// &quot;in ref to #&quot; is stored on me: GetReferenceToNum()</span>
<a name="l06236"></a>06236         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: 
<a name="l06237"></a>06237         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>:
<a name="l06238"></a>06238         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>:
<a name="l06239"></a>06239         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>:
<a name="l06240"></a>06240         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>:
<a name="l06241"></a>06241         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l06242"></a>06242         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>:
<a name="l06243"></a>06243         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>:
<a name="l06244"></a>06244         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l06245"></a>06245         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a>:
<a name="l06246"></a>06246             lReferenceNum = <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>();
<a name="l06247"></a>06247             <span class="keywordflow">break</span>;
<a name="l06248"></a>06248             
<a name="l06249"></a>06249             <span class="comment">// A transferReceipt ACTUALLY references the acceptPending (recipient&#39;s trans#) that accepted it.</span>
<a name="l06250"></a>06250             <span class="comment">// But I don&#39;t care about the recipient&#39;s transaction #s! This function is for DISPLAY. I am the sender,</span>
<a name="l06251"></a>06251             <span class="comment">// and I want to see a reference to my original transfer that I sent.  This receipt, as far as I care, </span>
<a name="l06252"></a>06252             <span class="comment">// is for THAT TRANSFER.</span>
<a name="l06253"></a>06253         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:
<a name="l06254"></a>06254         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l06255"></a>06255         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l06256"></a>06256             lReferenceNum = this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>();
<a name="l06257"></a>06257             <span class="keywordflow">break</span>;
<a name="l06258"></a>06258             
<a name="l06259"></a>06259         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l06260"></a>06260             <span class="keywordflow">return</span> 0;
<a name="l06261"></a>06261     }
<a name="l06262"></a>06262     <span class="comment">// -------------------------------------------------    </span>
<a name="l06263"></a>06263     <span class="keywordflow">return</span> lReferenceNum;
<a name="l06264"></a>06264 }
<a name="l06265"></a>06265 
<a name="l06266"></a>06266 
<a name="l06267"></a>06267 <span class="comment">// Decoding and understanding the various subtleties of the marketReceipt transaction!!!</span>
<a name="l06268"></a>06268 <span class="comment">//</span>
<a name="l06269"></a>06269 <span class="comment">// For a marketReceipt transaction, the transaction itself carries a NEW TRANSACTION ID for EACH RECEIPT.</span>
<a name="l06270"></a>06270 <span class="comment">// I might have many trades process against a single offer. Each time, the marketReceipt will be a fresh one,</span>
<a name="l06271"></a>06271 <span class="comment">// with its own fresh transaction number that&#39;s owned by the server.</span>
<a name="l06272"></a>06272 <span class="comment">//</span>
<a name="l06273"></a>06273 <span class="comment">// The marketReceipt&#39;s &quot;reference to&quot; is for the original Trade, placed by the trader, owned by the trader.</span>
<a name="l06274"></a>06274 <span class="comment">//</span>
<a name="l06275"></a>06275 <span class="comment">// 1.       pTrans1-&gt;SetReferenceToNum(theTrade.GetTransactionNum());</span>
<a name="l06276"></a>06276 <span class="comment">// 2.       pTrans1-&gt;SetReferenceString(strOrigTrade);</span>
<a name="l06277"></a>06277 <span class="comment">//</span>
<a name="l06278"></a>06278 <span class="comment">// In 2, the Reference String contains the ORIGINAL TRADE, signed by the TRADER. </span>
<a name="l06279"></a>06279 <span class="comment">//</span>
<a name="l06280"></a>06280 <span class="comment">// The marketReceipt transaction is SIGNED by the SERVER, AS IS the marketReceipt Item on its list.</span>
<a name="l06281"></a>06281 <span class="comment">// but the original trade was signed by the TRADER. The marketReceipt is in REFERENCE to that</span>
<a name="l06282"></a>06282 <span class="comment">// original trade, and so references its number and contains its complete string as the reference.</span>
<a name="l06283"></a>06283 <span class="comment">//</span>
<a name="l06284"></a>06284 <span class="comment">// The Item is a marketReceipt item, which is on the &quot;my list of items&quot; for the marketReceipt transaction. </span>
<a name="l06285"></a>06285 <span class="comment">// It is signed by the server, and it bears a transaction number that&#39;s owned by the server.</span>
<a name="l06286"></a>06286 <span class="comment">// The ITEM also contains the AMOUNT for the CURRENT RECEIPT.  If THIS trade deducted 50 clams from your</span>
<a name="l06287"></a>06287 <span class="comment">// account, then THIS ITEM will have an AMOUNT of -50 on THIS RECEIPT!</span>
<a name="l06288"></a>06288 
<a name="l06289"></a>06289 <span class="comment">// The item has two attachments... The NOTE, which contains the updated (server-signed) TRADE, and</span>
<a name="l06290"></a>06290 <span class="comment">// the ATTACHMENT, which contains the updated (server-signed) OFFER. Both should have the same transaction</span>
<a name="l06291"></a>06291 <span class="comment">// number as pTrans-&gt;ReferenceTo().</span>
<a name="l06292"></a>06292 <span class="comment">//</span>
<a name="l06293"></a>06293 <span class="comment">// 3.       pItem1-&gt;SetNote(strTrade);</span>
<a name="l06294"></a>06294 <span class="comment">// 4.       pItem1-&gt;SetAttachment(strOffer);</span>
<a name="l06295"></a>06295 <span class="comment">//</span>
<a name="l06296"></a>06296 
<a name="l06297"></a>06297 <span class="comment">/*</span>
<a name="l06298"></a>06298 <span class="comment"> </span>
<a name="l06299"></a>06299 <span class="comment"> HOW does this work? (for sendUserInstrument.)</span>
<a name="l06300"></a>06300 <span class="comment"> </span>
<a name="l06301"></a>06301 <span class="comment"> First, the original sender attaches his instrument to an OTPayment object, like this:</span>
<a name="l06302"></a>06302 <span class="comment"> </span>
<a name="l06303"></a>06303 <span class="comment"> void foo(const OTCheque &amp; theCheque)</span>
<a name="l06304"></a>06304 <span class="comment"> {</span>
<a name="l06305"></a>06305 <span class="comment">    const OTString strCheque(theCheque);</span>
<a name="l06306"></a>06306 <span class="comment">    OTPayment thePayment(strCheque);</span>
<a name="l06307"></a>06307 <span class="comment">    const OTString strPayment(thePayment);  // &lt;==== BAD! nonexistent.</span>
<a name="l06308"></a>06308 <span class="comment"> }</span>
<a name="l06309"></a>06309 <span class="comment"> </span>
<a name="l06310"></a>06310 <span class="comment"> Then he creates this &quot;sendUserInstrument&quot; message:</span>
<a name="l06311"></a>06311 <span class="comment"> </span>
<a name="l06312"></a>06312 <span class="comment">    theMessage.m_strCommand         = &quot;sendUserInstrument&quot;;</span>
<a name="l06313"></a>06313 <span class="comment">    theMessage.m_strNymID           = strNymID;</span>
<a name="l06314"></a>06314 <span class="comment">    theMessage.m_strNymID2          = strNymID2;</span>
<a name="l06315"></a>06315 <span class="comment">    theMessage.m_strServerID        = strServerID;</span>
<a name="l06316"></a>06316 <span class="comment">        (theEnvelope.Seal(thePubkey, strPayment) &amp;&amp;</span>
<a name="l06317"></a>06317 <span class="comment">        theEnvelope.GetAsciiArmoredData(</span>
<a name="l06318"></a>06318 <span class="comment">    theMessage.m_ascPayload));</span>
<a name="l06319"></a>06319 <span class="comment"> </span>
<a name="l06320"></a>06320 <span class="comment">==&gt; The instrument itself is added to an OTPayment object (a wrapper that can handle multiple instrumen types.)</span>
<a name="l06321"></a>06321 <span class="comment">    Then the OTPayment is encrypted to the recipient&#39;s public key and attached as the payload. </span>
<a name="l06322"></a>06322 <span class="comment">    (The Cheque, Payment Plan, Smart Contract, etc. is added to an OTPayment, which is then encrypted and added</span>
<a name="l06323"></a>06323 <span class="comment">    as the message payload.)</span>
<a name="l06324"></a>06324 <span class="comment"> </span>
<a name="l06325"></a>06325 <span class="comment">    A similar version of this message, &quot;outpaymentsMessage&quot;, is also saved to the sender&#39;s &quot;outPayments&quot; box:</span>
<a name="l06326"></a>06326 <span class="comment">    pMessage-&gt;m_strCommand      = &quot;outpaymentsMessage&quot;;</span>
<a name="l06327"></a>06327 <span class="comment">    pMessage-&gt;m_strNymID        = strNymID;</span>
<a name="l06328"></a>06328 <span class="comment">    pMessage-&gt;m_strNymID2       = strNymID2;</span>
<a name="l06329"></a>06329 <span class="comment">    pMessage-&gt;m_strServerID     = strServerID;          </span>
<a name="l06330"></a>06330 <span class="comment">    pMessage-&gt;m_strRequestNum.Format(&quot;%lld&quot;, lRequestNumber);</span>
<a name="l06331"></a>06331 <span class="comment"> </span>
<a name="l06332"></a>06332 <span class="comment"> // NOTICE: this time it&#39;s NOT encrypted:</span>
<a name="l06333"></a>06333 <span class="comment"> </span>
<a name="l06334"></a>06334 <span class="comment">    pMessage-&gt;m_ascPayload.SetString(strPayment);</span>
<a name="l06335"></a>06335 <span class="comment"> </span>
<a name="l06336"></a>06336 <span class="comment"> // You still have a choice to encrypt your local storage, but the &quot;outPayments&quot; box, which is</span>
<a name="l06337"></a>06337 <span class="comment"> // client-side-only, is not encrypted by default.</span>
<a name="l06338"></a>06338 <span class="comment"> </span>
<a name="l06339"></a>06339 <span class="comment"> // ----------------------------------------</span>
<a name="l06340"></a>06340 <span class="comment"> </span>
<a name="l06341"></a>06341 <span class="comment">    When the SERVER receives the &quot;sendUserInstrument&quot; message, it adds a new instrumentNotice transaction</span>
<a name="l06342"></a>06342 <span class="comment">    to the recipient&#39;s nymbox, in order to inform him, like this:</span>
<a name="l06343"></a>06343 <span class="comment"> </span>
<a name="l06344"></a>06344 <span class="comment">    OTTransaction * pTransaction = OTTransaction::GenerateTransaction(theLedger, OTTransaction::instrumentNotice, lTransNum);</span>
<a name="l06345"></a>06345 <span class="comment">    </span>
<a name="l06346"></a>06346 <span class="comment">    if (NULL != pTransaction) // The above has an OT_ASSERT within, but I just like to check my pointers.</span>
<a name="l06347"></a>06347 <span class="comment">    {           </span>
<a name="l06348"></a>06348 <span class="comment">        pTransaction-&gt;  SetReferenceToNum(lTransNum);       // &lt;====== Recipient RECEIVES entire incoming message as string here, which includes the sender user ID,</span>
<a name="l06349"></a>06349 <span class="comment">        pTransaction-&gt;  SetReferenceString(strInMessage);   // and has an OTEnvelope in the payload. Message is signed by sender, and envelope is encrypted to recipient.</span>
<a name="l06350"></a>06350 <span class="comment">        </span>
<a name="l06351"></a>06351 <span class="comment">        pTransaction-&gt;  SignContract(m_nymServer);</span>
<a name="l06352"></a>06352 <span class="comment">        pTransaction-&gt;  SaveContract();</span>
<a name="l06353"></a>06353 <span class="comment">        </span>
<a name="l06354"></a>06354 <span class="comment">        theLedger.AddTransaction(*pTransaction); // Add the message transaction to the nymbox.</span>
<a name="l06355"></a>06355 <span class="comment">        </span>
<a name="l06356"></a>06356 <span class="comment">        theLedger.ReleaseSignatures();</span>
<a name="l06357"></a>06357 <span class="comment">        theLedger.SignContract(m_nymServer);</span>
<a name="l06358"></a>06358 <span class="comment">        theLedger.SaveContract();</span>
<a name="l06359"></a>06359 <span class="comment">        theLedger.SaveNymbox(); // We don&#39;t grab the Nymbox hash here, since nothing important changed (just a message was sent.)</span>
<a name="l06360"></a>06360 <span class="comment">        </span>
<a name="l06361"></a>06361 <span class="comment">        // Any inbox/nymbox/outbox ledger will only itself contain</span>
<a name="l06362"></a>06362 <span class="comment">        // abbreviated versions of the receipts, including their hashes.</span>
<a name="l06363"></a>06363 <span class="comment">        // </span>
<a name="l06364"></a>06364 <span class="comment">        // The rest is stored separately, in the box receipt, which is created</span>
<a name="l06365"></a>06365 <span class="comment">        // whenever a receipt is added to a box, and deleted after a receipt</span>
<a name="l06366"></a>06366 <span class="comment">        // is removed from a box.</span>
<a name="l06367"></a>06367 <span class="comment">        //</span>
<a name="l06368"></a>06368 <span class="comment">        pTransaction-&gt;SaveBoxReceipt(theLedger);</span>
<a name="l06369"></a>06369 <span class="comment">        </span>
<a name="l06370"></a>06370 <span class="comment">        msgOut.m_bSuccess = true;</span>
<a name="l06371"></a>06371 <span class="comment">    }</span>
<a name="l06372"></a>06372 <span class="comment"> // ---------------------</span>
<a name="l06373"></a>06373 <span class="comment"> </span>
<a name="l06374"></a>06374 <span class="comment">// NOTICE that the original message (from the sender) is attached to the new transaction </span>
<a name="l06375"></a>06375 <span class="comment">// as a &quot;reference string&quot; and the reference number points to itself. (Since a message has</span>
<a name="l06376"></a>06376 <span class="comment">// no transaction number that it could refer to.)</span>
<a name="l06377"></a>06377 <span class="comment"> </span>
<a name="l06378"></a>06378 <span class="comment"> Therefore, if I am looping through my Nymbox, iterating through transactions, and one of them</span>
<a name="l06379"></a>06379 <span class="comment"> is an instrumentNotice, then I should expect a GetReferenceString() to load up an OTMessage of</span>
<a name="l06380"></a>06380 <span class="comment"> type &quot;sendUserInstrument&quot;, and I should expect the PAYLOAD of that message to contain an encrypted</span>
<a name="l06381"></a>06381 <span class="comment"> OTEnvelope, decrypted by Msg.m_strNymID2&#39;s key, which contains the OTPayment, from which is derived</span>
<a name="l06382"></a>06382 <span class="comment"> the INSTRUMENT.</span>
<a name="l06383"></a>06383 <span class="comment"> </span>
<a name="l06384"></a>06384 <span class="comment"> The INSTRUMENT can be of these types:</span>
<a name="l06385"></a>06385 <span class="comment">    - CHEQUE, INVOICE, VOUCHER (these are all forms of cheque)</span>
<a name="l06386"></a>06386 <span class="comment">    - PAYMENT PLAN, SMART CONTRACT (these are cron items)</span>
<a name="l06387"></a>06387 <span class="comment">    - PURSE (containing cash)</span>
<a name="l06388"></a>06388 <span class="comment"> </span>
<a name="l06389"></a>06389 <span class="comment"> It&#39;s almost better to deal with those types using OTPayment, since it provides a consistent interface</span>
<a name="l06390"></a>06390 <span class="comment"> for all of them. Then only deal with the lower-level objects when you have to :P</span>
<a name="l06391"></a>06391 <span class="comment"> </span>
<a name="l06392"></a>06392 <span class="comment"> </span>
<a name="l06393"></a>06393 <span class="comment"> */</span>
<a name="l06394"></a><a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7">06394</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">OTTransaction::GetSenderUserIDForDisplay</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theReturnID)
<a name="l06395"></a>06395 {
<a name="l06396"></a>06396     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l06397"></a>06397         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06398"></a>06398     
<a name="l06399"></a>06399     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l06400"></a>06400     
<a name="l06401"></a>06401     <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a>        theItemAngel;
<a name="l06402"></a>06402     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a>    theCronItemAngel;
<a name="l06403"></a>06403     
<a name="l06404"></a>06404     <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l06405"></a>06405     <a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l06406"></a>06406 
<a name="l06407"></a>06407     <span class="keywordflow">if</span> (strReference.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l06408"></a>06408         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06409"></a>06409         
<a name="l06410"></a>06410     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06411"></a>06411     {
<a name="l06412"></a>06412 <span class="comment">//      case OTTransaction::marketReceipt: </span>
<a name="l06413"></a>06413         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>: <span class="comment">// for paymentPlans AND smartcontracts. (If the smart contract does a payment, it leaves a paymentReceipt...)</span>
<a name="l06414"></a>06414         {
<a name="l06415"></a>06415             <a class="code" href="class_o_t_string.html">OTString</a> strUpdatedCronItem;
<a name="l06416"></a>06416             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l06417"></a>06417             
<a name="l06418"></a>06418             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l06419"></a>06419                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strUpdatedCronItem);
<a name="l06420"></a>06420             <span class="keywordflow">else</span>
<a name="l06421"></a>06421                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failed trying to get paymentReceipt item from paymentReceipt transaction.\n&quot;</span>,
<a name="l06422"></a>06422                               __FUNCTION__);
<a name="l06423"></a>06423                         
<a name="l06424"></a>06424             pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strUpdatedCronItem);
<a name="l06425"></a>06425             theCronItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pCronItem);
<a name="l06426"></a>06426 
<a name="l06427"></a>06427             <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmart = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06428"></a>06428             
<a name="l06429"></a>06429             <span class="keywordflow">if</span> (NULL != pSmart) <span class="comment">// if it&#39;s a smart contract...</span>
<a name="l06430"></a>06430             {
<a name="l06431"></a>06431                 <span class="keywordflow">if</span> (!pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#aeb06c37756e2188d2f05eb3a2102a14a">GetLastSenderUserID</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06432"></a>06432                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06433"></a>06433                 
<a name="l06434"></a>06434                 theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#aeb06c37756e2188d2f05eb3a2102a14a">GetLastSenderUserID</a>());
<a name="l06435"></a>06435                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06436"></a>06436             }
<a name="l06437"></a>06437             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// else if it is any other kind of cron item...</span>
<a name="l06438"></a>06438             {
<a name="l06439"></a>06439                 theReturnID = pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>();
<a name="l06440"></a>06440                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06441"></a>06441             }
<a name="l06442"></a>06442             <span class="keywordflow">else</span>
<a name="l06443"></a>06443             {
<a name="l06444"></a>06444                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to load Cron Item. Should never happen. Receipt: %lld  Origin: %lld\n&quot;</span>,
<a name="l06445"></a>06445                               __FUNCTION__, this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l06446"></a>06446                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06447"></a>06447             }
<a name="l06448"></a>06448             <span class="keywordflow">break</span>;
<a name="l06449"></a>06449         }
<a name="l06450"></a>06450         <span class="comment">// --------------------------------------------------</span>
<a name="l06451"></a>06451         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l06452"></a>06452         {
<a name="l06453"></a>06453             <span class="comment">/*</span>
<a name="l06454"></a>06454 <span class="comment">             Therefore, if I am looping through my Nymbox, iterating through transactions, and one of them</span>
<a name="l06455"></a>06455 <span class="comment">             is an *** instrumentNotice *** then I should expect this-&gt;GetReferenceString(strOutput) to:</span>
<a name="l06456"></a>06456 <span class="comment">             </span>
<a name="l06457"></a>06457 <span class="comment">             1. load up from string as an OTMessage of type &quot;sendUserInstrument&quot;,</span>
<a name="l06458"></a>06458 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06459"></a>06459 <span class="comment">             2. and I should expect the PAYLOAD of that message to contain an encrypted OTEnvelope,</span>
<a name="l06460"></a>06460 <span class="comment">             3. which can be decrypted by Msg.m_strNymID2&#39;s private key,</span>
<a name="l06461"></a>06461 <span class="comment">             4. And the resulting plaintext can be loaded into memory as an OTPayment object,</span>
<a name="l06462"></a>06462 <span class="comment">             5. ...which contains an instrument of ambiguous type.</span>
<a name="l06463"></a>06463 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06464"></a>06464 <span class="comment">             FYI:</span>
<a name="l06465"></a>06465 <span class="comment">             OTPayment provides a consistent interface, and consolidation of handling, for </span>
<a name="l06466"></a>06466 <span class="comment">             the several financial instruments that appear on the PAYMENTS page, in the PaymentsInbox.</span>
<a name="l06467"></a>06467 <span class="comment">             For example: </span>
<a name="l06468"></a>06468 <span class="comment">             [ Cheques, Invoices, Vouchers ], </span>
<a name="l06469"></a>06469 <span class="comment">             Payment Plans, Smart Contracts, ...and Purses.</span>
<a name="l06470"></a>06470 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06471"></a>06471 <span class="comment">             (In this block we don&#39;t need to go any farther than step 1 above.)</span>
<a name="l06472"></a>06472 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06473"></a>06473 <span class="comment">             */</span>
<a name="l06474"></a>06474 <span class="comment">//          OTString strReference;              // (Already done above.)</span>
<a name="l06475"></a>06475 <span class="comment">//          GetReferenceString(strReference);   // (Already done above.)</span>
<a name="l06476"></a>06476             
<a name="l06477"></a>06477             <a class="code" href="class_o_t_message.html">OTMessage</a> theSentMsg;
<a name="l06478"></a>06478             
<a name="l06479"></a>06479             <span class="keywordflow">if</span> (strReference.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theSentMsg.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strReference))
<a name="l06480"></a>06480             {
<a name="l06481"></a>06481                 <span class="comment">// All we need is this message itself. We aren&#39;t going to decrypt</span>
<a name="l06482"></a>06482                 <span class="comment">// the payload, we&#39;re just going to grab the sender/receiver data</span>
<a name="l06483"></a>06483                 <span class="comment">// from the msg.</span>
<a name="l06484"></a>06484                 <span class="comment">//</span>
<a name="l06485"></a>06485                 <span class="comment">// We can&#39;t decrypt the payload (the OTPayment object) but we still have sender / recipient.</span>
<a name="l06486"></a>06486                 <span class="comment">// todo security need to consider security implications of that and maybe improve it a bit.</span>
<a name="l06487"></a>06487                 <span class="comment">// (But I do NOT want to get into the messaging business.)</span>
<a name="l06488"></a>06488                 <span class="comment">//</span>
<a name="l06489"></a>06489 <span class="comment">//              theSentMsg.m_strCommand     = &quot;sendUserInstrument&quot;;</span>
<a name="l06490"></a>06490 <span class="comment">//              theSentMsg.m_strNymID       = strNymID;     //   ===&gt; sender &lt;===</span>
<a name="l06491"></a>06491 <span class="comment">//              theSentMsg.m_strNymID2      = strNymID2;    // ===&gt; recipient &lt;===</span>
<a name="l06492"></a>06492 
<a name="l06493"></a>06493                 <span class="keywordflow">if</span> (theSentMsg.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06494"></a>06494                 {
<a name="l06495"></a>06495                     theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theSentMsg.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>);
<a name="l06496"></a>06496                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06497"></a>06497                 }                
<a name="l06498"></a>06498             }            
<a name="l06499"></a>06499             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06500"></a>06500         }   
<a name="l06501"></a>06501         <span class="comment">// --------------------------------------------------</span>
<a name="l06502"></a>06502         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>:
<a name="l06503"></a>06503         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l06504"></a>06504         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l06505"></a>06505         {
<a name="l06506"></a>06506             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l06507"></a>06507             
<a name="l06508"></a>06508             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l06509"></a>06509                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l06510"></a>06510             
<a name="l06511"></a>06511             <span class="keywordflow">break</span>;
<a name="l06512"></a>06512         }   
<a name="l06513"></a>06513         <span class="comment">// --------------------------------------------------</span>
<a name="l06514"></a>06514         <span class="keywordflow">default</span>: <span class="comment">// All other types are irrelevant here.</span>
<a name="l06515"></a>06515             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06516"></a>06516     }
<a name="l06517"></a>06517     <span class="comment">// --------------------------------------------------   </span>
<a name="l06518"></a>06518     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l06519"></a>06519     {
<a name="l06520"></a>06520         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTTransaction::GetSenderUserIDForDisplay: original item not found. Should never happen.\n&quot;</span>);
<a name="l06521"></a>06521         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l06522"></a>06522     }
<a name="l06523"></a>06523     <span class="comment">// -------------------------------------------------</span>
<a name="l06524"></a>06524     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l06525"></a>06525     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l06526"></a>06526         
<a name="l06527"></a>06527     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06528"></a>06528     {   <span class="comment">// These are the types that have an amount (somehow)</span>
<a name="l06529"></a>06529         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:  <span class="comment">// amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l06530"></a>06530         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l06531"></a>06531         {
<a name="l06532"></a>06532             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l06533"></a>06533             {
<a name="l06534"></a>06534                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l06535"></a>06535                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l06536"></a>06536                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06537"></a>06537             }
<a name="l06538"></a>06538             
<a name="l06539"></a>06539             <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l06540"></a>06540             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strAttachment);
<a name="l06541"></a>06541             <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAttachment);
<a name="l06542"></a>06542             
<a name="l06543"></a>06543             <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l06544"></a>06544             {
<a name="l06545"></a>06545                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);
<a name="l06546"></a>06546                 
<a name="l06547"></a>06547                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque or voucher from string in OTTransaction::%s:\n%s\n&quot;</span>,
<a name="l06548"></a>06548                               __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06549"></a>06549             }
<a name="l06550"></a>06550             <span class="keywordflow">else</span> 
<a name="l06551"></a>06551             {
<a name="l06552"></a>06552                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l06553"></a>06553                     theReturnID = theCheque.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>();
<a name="l06554"></a>06554                 <span class="keywordflow">else</span>
<a name="l06555"></a>06555                     theReturnID = theCheque.<a class="code" href="class_o_t_cheque.html#ac58c338fc0a151ed12eaa9e86a9c1329">GetRemitterUserID</a>();
<a name="l06556"></a>06556                 
<a name="l06557"></a>06557                 bSuccess = <span class="keyword">true</span>;
<a name="l06558"></a>06558             }
<a name="l06559"></a>06559         }
<a name="l06560"></a>06560             <span class="keywordflow">break</span>;
<a name="l06561"></a>06561             
<a name="l06562"></a>06562         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on transfer item</span>
<a name="l06563"></a>06563             
<a name="l06564"></a>06564             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)
<a name="l06565"></a>06565             {
<a name="l06566"></a>06566                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to pending transfer\n&quot;</span>);
<a name="l06567"></a>06567             }
<a name="l06568"></a>06568             <span class="keywordflow">else</span>
<a name="l06569"></a>06569             {
<a name="l06570"></a>06570                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();   
<a name="l06571"></a>06571                 bSuccess = <span class="keyword">true</span>;
<a name="l06572"></a>06572             }
<a name="l06573"></a>06573             <span class="keywordflow">break</span>;
<a name="l06574"></a>06574         <span class="keywordflow">default</span>: <span class="comment">// All other types have no sender user ID -- return false.</span>
<a name="l06575"></a>06575             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06576"></a>06576     }
<a name="l06577"></a>06577     
<a name="l06578"></a>06578     <span class="keywordflow">return</span> bSuccess;
<a name="l06579"></a>06579 }
<a name="l06580"></a>06580 
<a name="l06581"></a>06581 
<a name="l06582"></a><a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">06582</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">OTTransaction::GetRecipientUserIDForDisplay</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theReturnID)
<a name="l06583"></a>06583 {
<a name="l06584"></a>06584     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l06585"></a>06585         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06586"></a>06586     
<a name="l06587"></a>06587     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l06588"></a>06588     
<a name="l06589"></a>06589     <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel;
<a name="l06590"></a>06590     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel;
<a name="l06591"></a>06591     
<a name="l06592"></a>06592     <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l06593"></a>06593     <a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l06594"></a>06594     
<a name="l06595"></a>06595     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06596"></a>06596     {   
<a name="l06597"></a>06597 <span class="comment">//      case OTTransaction::marketReceipt: </span>
<a name="l06598"></a>06598         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>: <span class="comment">// Used for paymentPlans AND for smart contracts...</span>
<a name="l06599"></a>06599         {
<a name="l06600"></a>06600             <a class="code" href="class_o_t_string.html">OTString</a> strUpdatedCronItem;
<a name="l06601"></a>06601             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l06602"></a>06602             
<a name="l06603"></a>06603             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l06604"></a>06604                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strUpdatedCronItem);
<a name="l06605"></a>06605             <span class="keywordflow">else</span>
<a name="l06606"></a>06606                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failed trying to get paymentReceipt item from paymentReceipt transaction.\n&quot;</span>,
<a name="l06607"></a>06607                               __FUNCTION__);
<a name="l06608"></a>06608 
<a name="l06609"></a>06609             pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strUpdatedCronItem);
<a name="l06610"></a>06610             theCronItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pCronItem);
<a name="l06611"></a>06611             
<a name="l06612"></a>06612             <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmart = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06613"></a>06613             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> * pPlan = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06614"></a>06614             
<a name="l06615"></a>06615             <span class="keywordflow">if</span> (NULL != pSmart) <span class="comment">// if it&#39;s a smart contract...</span>
<a name="l06616"></a>06616             {
<a name="l06617"></a>06617                 <span class="keywordflow">if</span> (!pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#a5e4cc7155d92196c3031a725fd199230">GetLastRecipientUserID</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06618"></a>06618                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06619"></a>06619                 
<a name="l06620"></a>06620                 theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#a5e4cc7155d92196c3031a725fd199230">GetLastRecipientUserID</a>());
<a name="l06621"></a>06621                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06622"></a>06622             }
<a name="l06623"></a>06623             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pPlan) <span class="comment">// else if it is any other kind of cron item...</span>
<a name="l06624"></a>06624             {
<a name="l06625"></a>06625                 theReturnID = pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>();
<a name="l06626"></a>06626                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06627"></a>06627             }
<a name="l06628"></a>06628             <span class="keywordflow">else</span>
<a name="l06629"></a>06629             {
<a name="l06630"></a>06630                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to load Cron Item. Should never happen. Receipt: %lld  Origin: %lld\n&quot;</span>,
<a name="l06631"></a>06631                               __FUNCTION__, this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l06632"></a>06632                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06633"></a>06633             }
<a name="l06634"></a>06634         }
<a name="l06635"></a>06635             <span class="keywordflow">break</span>; <span class="comment">// this break never actually happens. Above always returns, if triggered.</span>
<a name="l06636"></a>06636             <span class="comment">// --------------------------------------------------</span>
<a name="l06637"></a>06637         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>:
<a name="l06638"></a>06638         {
<a name="l06639"></a>06639             <span class="comment">/*</span>
<a name="l06640"></a>06640 <span class="comment">             Therefore, if I am looping through my Nymbox, iterating through transactions, and one of them</span>
<a name="l06641"></a>06641 <span class="comment">             is an *** instrumentNotice *** then I should expect this-&gt;GetReferenceString(strOutput) to:</span>
<a name="l06642"></a>06642 <span class="comment">             </span>
<a name="l06643"></a>06643 <span class="comment">             1. load up from string as an OTMessage of type &quot;sendUserInstrument&quot;,</span>
<a name="l06644"></a>06644 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06645"></a>06645 <span class="comment">             2. and I should expect the PAYLOAD of that message to contain an encrypted OTEnvelope,</span>
<a name="l06646"></a>06646 <span class="comment">             3. which can be decrypted by Msg.m_strNymID2&#39;s private key,</span>
<a name="l06647"></a>06647 <span class="comment">             4. And the resulting plaintext can be loaded into memory as an OTPayment object,</span>
<a name="l06648"></a>06648 <span class="comment">             5. ...which contains an instrument of ambiguous type.</span>
<a name="l06649"></a>06649 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06650"></a>06650 <span class="comment">             FYI:</span>
<a name="l06651"></a>06651 <span class="comment">             OTPayment provides a consistent interface, and consolidation of handling, for </span>
<a name="l06652"></a>06652 <span class="comment">             the several financial instruments that appear on the PAYMENTS page, in the PaymentsInbox.</span>
<a name="l06653"></a>06653 <span class="comment">             For example: </span>
<a name="l06654"></a>06654 <span class="comment">                [ Cheques, Invoices, Vouchers ], </span>
<a name="l06655"></a>06655 <span class="comment">                Payment Plans, Smart Contracts, ...and Purses.</span>
<a name="l06656"></a>06656 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06657"></a>06657 <span class="comment">             (In this block we don&#39;t need to go any farther than step 1 above.)</span>
<a name="l06658"></a>06658 <span class="comment">             -------------------------------------------------------------------</span>
<a name="l06659"></a>06659 <span class="comment">             */</span>
<a name="l06660"></a>06660 <span class="comment">//          OTString strReference;              // (Already done above.)</span>
<a name="l06661"></a>06661 <span class="comment">//          GetReferenceString(strReference);   // (Already done above.)</span>
<a name="l06662"></a>06662             
<a name="l06663"></a>06663             <a class="code" href="class_o_t_message.html">OTMessage</a> theSentMsg;
<a name="l06664"></a>06664             
<a name="l06665"></a>06665             <span class="keywordflow">if</span> (strReference.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theSentMsg.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strReference))
<a name="l06666"></a>06666             {
<a name="l06667"></a>06667                 <span class="comment">// All we need is this message itself. We aren&#39;t going to decrypt</span>
<a name="l06668"></a>06668                 <span class="comment">// the payload, we&#39;re just going to grab the sender/receiver data</span>
<a name="l06669"></a>06669                 <span class="comment">// from the msg.</span>
<a name="l06670"></a>06670                 <span class="comment">//</span>
<a name="l06671"></a>06671                 <span class="comment">// We can&#39;t decrypt the payload (the OTPayment object) but we still have sender / recipient.</span>
<a name="l06672"></a>06672                 <span class="comment">// todo security need to consider security implications of that and maybe improve it a bit.</span>
<a name="l06673"></a>06673                 <span class="comment">// (But I do NOT want to get into the messaging business.)</span>
<a name="l06674"></a>06674                 <span class="comment">//</span>
<a name="l06675"></a>06675 <span class="comment">//              theSentMsg.m_strCommand     = &quot;sendUserInstrument&quot;;</span>
<a name="l06676"></a>06676 <span class="comment">//              theSentMsg.m_strNymID       = strNymID;     //   ===&gt; sender &lt;===</span>
<a name="l06677"></a>06677 <span class="comment">//              theSentMsg.m_strNymID2      = strNymID2;    // ===&gt; recipient &lt;===</span>
<a name="l06678"></a>06678                 
<a name="l06679"></a>06679                 <span class="keywordflow">if</span> (theSentMsg.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06680"></a>06680                 {
<a name="l06681"></a>06681                     theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theSentMsg.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>);
<a name="l06682"></a>06682                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06683"></a>06683                 }                
<a name="l06684"></a>06684             }            
<a name="l06685"></a>06685             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06686"></a>06686         } <span class="comment">// case OTTransaction::instrumentNotice:</span>
<a name="l06687"></a>06687             <span class="keywordflow">break</span>;
<a name="l06688"></a>06688         <span class="comment">// --------------------------------------------------</span>
<a name="l06689"></a>06689         <span class="comment">//</span>
<a name="l06690"></a>06690         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: 
<a name="l06691"></a>06691         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l06692"></a>06692         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l06693"></a>06693         {
<a name="l06694"></a>06694             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l06695"></a>06695             
<a name="l06696"></a>06696             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l06697"></a>06697                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l06698"></a>06698             
<a name="l06699"></a>06699             <span class="keywordflow">break</span>;
<a name="l06700"></a>06700         }
<a name="l06701"></a>06701         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return false.</span>
<a name="l06702"></a>06702             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06703"></a>06703     }
<a name="l06704"></a>06704     
<a name="l06705"></a>06705     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l06706"></a>06706         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l06707"></a>06707     
<a name="l06708"></a>06708     <span class="comment">// -------------------------------------------------</span>
<a name="l06709"></a>06709     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l06710"></a>06710     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l06711"></a>06711 
<a name="l06712"></a>06712     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06713"></a>06713     {   
<a name="l06714"></a>06714         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:
<a name="l06715"></a>06715         {
<a name="l06716"></a>06716             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>)
<a name="l06717"></a>06717             {
<a name="l06718"></a>06718                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to transferReceipt\n&quot;</span>);
<a name="l06719"></a>06719                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06720"></a>06720             }
<a name="l06721"></a>06721             <span class="keywordflow">else</span> 
<a name="l06722"></a>06722             {
<a name="l06723"></a>06723                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();  <span class="comment">// Even though a transfer has no recipient user (just a recipient acct) I still get the User ID when he accepts it!</span>
<a name="l06724"></a>06724                 bSuccess = <span class="keyword">true</span>;
<a name="l06725"></a>06725             }
<a name="l06726"></a>06726         }
<a name="l06727"></a>06727             <span class="keywordflow">break</span>;
<a name="l06728"></a>06728             
<a name="l06729"></a>06729         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:  <span class="comment">// amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l06730"></a>06730         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l06731"></a>06731         {
<a name="l06732"></a>06732             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l06733"></a>06733             {
<a name="l06734"></a>06734                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l06735"></a>06735                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l06736"></a>06736                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06737"></a>06737             }
<a name="l06738"></a>06738             
<a name="l06739"></a>06739             <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l06740"></a>06740             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strAttachment);
<a name="l06741"></a>06741             <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAttachment);
<a name="l06742"></a>06742             
<a name="l06743"></a>06743             <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l06744"></a>06744             {
<a name="l06745"></a>06745                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);
<a name="l06746"></a>06746                 
<a name="l06747"></a>06747                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque or voucher from string in OTTransaction::%s:\n%s\n&quot;</span>,
<a name="l06748"></a>06748                               __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06749"></a>06749             }
<a name="l06750"></a>06750             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.<a class="code" href="class_o_t_cheque.html#abcc7ebe7be1754456681a25a012040ee">HasRecipient</a>())
<a name="l06751"></a>06751             {
<a name="l06752"></a>06752                 theReturnID = theCheque.<a class="code" href="class_o_t_cheque.html#a2628b445784aa1f6cdea370acca92077">GetRecipientUserID</a>();
<a name="l06753"></a>06753                 bSuccess    = <span class="keyword">true</span>;
<a name="l06754"></a>06754             }
<a name="l06755"></a>06755             <span class="keywordflow">else</span>
<a name="l06756"></a>06756             {
<a name="l06757"></a>06757                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();  <span class="comment">// Even though the cheque has no recipient, I still get the User ID when he deposits it!</span>
<a name="l06758"></a>06758                 bSuccess    = <span class="keyword">true</span>;
<a name="l06759"></a>06759             }
<a name="l06760"></a>06760         }
<a name="l06761"></a>06761             <span class="keywordflow">break</span>;
<a name="l06762"></a>06762             
<a name="l06763"></a>06763         <span class="keywordflow">default</span>: <span class="comment">// All other types have no recipient user ID -- return false.</span>
<a name="l06764"></a>06764             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06765"></a>06765     }
<a name="l06766"></a>06766     
<a name="l06767"></a>06767     <span class="keywordflow">return</span> bSuccess;
<a name="l06768"></a>06768 }
<a name="l06769"></a>06769 
<a name="l06770"></a>06770 
<a name="l06771"></a><a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">06771</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">OTTransaction::GetSenderAcctIDForDisplay</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theReturnID)
<a name="l06772"></a>06772 {
<a name="l06773"></a>06773     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l06774"></a>06774         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06775"></a>06775     
<a name="l06776"></a>06776     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l06777"></a>06777         
<a name="l06778"></a>06778     <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel;
<a name="l06779"></a>06779     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel;
<a name="l06780"></a>06780     
<a name="l06781"></a>06781     <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l06782"></a>06782     <a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l06783"></a>06783     
<a name="l06784"></a>06784     <span class="keywordflow">if</span> (strReference.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l06785"></a>06785         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06786"></a>06786     
<a name="l06787"></a>06787     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l06788"></a>06788     {
<a name="l06789"></a>06789 <span class="comment">//      case OTTransaction::marketReceipt:</span>
<a name="l06790"></a>06790         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l06791"></a>06791         {
<a name="l06792"></a>06792             <a class="code" href="class_o_t_string.html">OTString</a> strUpdatedCronItem;
<a name="l06793"></a>06793             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l06794"></a>06794             
<a name="l06795"></a>06795             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l06796"></a>06796                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strUpdatedCronItem);
<a name="l06797"></a>06797             <span class="keywordflow">else</span>
<a name="l06798"></a>06798                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failed trying to get paymentReceipt item from paymentReceipt transaction.\n&quot;</span>,
<a name="l06799"></a>06799                               __FUNCTION__);
<a name="l06800"></a>06800 
<a name="l06801"></a>06801             pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strUpdatedCronItem);
<a name="l06802"></a>06802             theCronItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pCronItem);
<a name="l06803"></a>06803             
<a name="l06804"></a>06804             <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmart = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06805"></a>06805             
<a name="l06806"></a>06806             <span class="keywordflow">if</span> (NULL != pSmart) <span class="comment">// if it&#39;s a smart contract...</span>
<a name="l06807"></a>06807             {
<a name="l06808"></a>06808                 <span class="keywordflow">if</span> (!pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#af1cf6cb6b4d53612f587f5cf5fa70c2d">GetLastSenderAcctID</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06809"></a>06809                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06810"></a>06810                 
<a name="l06811"></a>06811                 theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#af1cf6cb6b4d53612f587f5cf5fa70c2d">GetLastSenderAcctID</a>());
<a name="l06812"></a>06812                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06813"></a>06813             }
<a name="l06814"></a>06814             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// else if it is any other kind of cron item...</span>
<a name="l06815"></a>06815             {
<a name="l06816"></a>06816                 theReturnID = pCronItem-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();
<a name="l06817"></a>06817                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06818"></a>06818             }
<a name="l06819"></a>06819             <span class="keywordflow">else</span>
<a name="l06820"></a>06820             {
<a name="l06821"></a>06821                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to load Cron Item. Should never happen. Receipt: %lld  Origin: %lld\n&quot;</span>,
<a name="l06822"></a>06822                               __FUNCTION__, this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l06823"></a>06823                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06824"></a>06824             }
<a name="l06825"></a>06825         }
<a name="l06826"></a>06826             <span class="keywordflow">break</span>;
<a name="l06827"></a>06827         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on the transfer item, on my list of items.</span>
<a name="l06828"></a>06828         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>: <span class="comment">// amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l06829"></a>06829         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l06830"></a>06830         {
<a name="l06831"></a>06831             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l06832"></a>06832             
<a name="l06833"></a>06833             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l06834"></a>06834                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l06835"></a>06835             
<a name="l06836"></a>06836             <span class="keywordflow">break</span>;
<a name="l06837"></a>06837         }
<a name="l06838"></a>06838         <span class="keywordflow">default</span>: <span class="comment">// All other types have no sender acct ID -- return false.</span>
<a name="l06839"></a>06839             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06840"></a>06840     }
<a name="l06841"></a>06841         
<a name="l06842"></a>06842     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l06843"></a>06843     {
<a name="l06844"></a>06844         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: couldn&#39;t load original item, should never happen. \n&quot;</span>,
<a name="l06845"></a>06845                       __FUNCTION__);
<a name="l06846"></a>06846         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l06847"></a>06847     }
<a name="l06848"></a>06848     <span class="comment">// -------------------------------------------------</span>
<a name="l06849"></a>06849     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l06850"></a>06850     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l06851"></a>06851         
<a name="l06852"></a>06852     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06853"></a>06853     {   <span class="comment">// These are the types that have an amount (somehow)</span>
<a name="l06854"></a>06854         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:  <span class="comment">// amount is stored on cheque (attached to depositCheque item, attached.)</span>
<a name="l06855"></a>06855         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>: <span class="comment">// amount is stored on voucher (attached to depositCheque item, attached.)</span>
<a name="l06856"></a>06856         {
<a name="l06857"></a>06857             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l06858"></a>06858             {
<a name="l06859"></a>06859                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l06860"></a>06860                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l06861"></a>06861                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06862"></a>06862             }
<a name="l06863"></a>06863 
<a name="l06864"></a>06864             <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l06865"></a>06865             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strAttachment);
<a name="l06866"></a>06866             <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAttachment);
<a name="l06867"></a>06867             
<a name="l06868"></a>06868             <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l06869"></a>06869             {
<a name="l06870"></a>06870                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);
<a name="l06871"></a>06871                 
<a name="l06872"></a>06872                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque from string in OTTransaction::%s:\n%s\n&quot;</span>,
<a name="l06873"></a>06873                               __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06874"></a>06874             }
<a name="l06875"></a>06875             <span class="keywordflow">else</span> 
<a name="l06876"></a>06876             {
<a name="l06877"></a>06877                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l06878"></a>06878                     theReturnID = theCheque.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();
<a name="l06879"></a>06879                 <span class="keywordflow">else</span>
<a name="l06880"></a>06880                     theReturnID = theCheque.<a class="code" href="class_o_t_cheque.html#a749bbaa8f7d864a16b95eaf9a8d5b684">GetRemitterAcctID</a>();
<a name="l06881"></a>06881 
<a name="l06882"></a>06882                 bSuccess = <span class="keyword">true</span>;
<a name="l06883"></a>06883             }
<a name="l06884"></a>06884         }
<a name="l06885"></a>06885             <span class="keywordflow">break</span>;
<a name="l06886"></a>06886             
<a name="l06887"></a>06887         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on transfer item</span>
<a name="l06888"></a>06888             
<a name="l06889"></a>06889             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)
<a name="l06890"></a>06890             {
<a name="l06891"></a>06891                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to pending transfer\n&quot;</span>);
<a name="l06892"></a>06892             }
<a name="l06893"></a>06893             <span class="keywordflow">else</span>
<a name="l06894"></a>06894             {
<a name="l06895"></a>06895                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>();   
<a name="l06896"></a>06896                 bSuccess = <span class="keyword">true</span>;
<a name="l06897"></a>06897             }
<a name="l06898"></a>06898             <span class="keywordflow">break</span>;
<a name="l06899"></a>06899 
<a name="l06900"></a>06900         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l06901"></a>06901             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06902"></a>06902     }
<a name="l06903"></a>06903     
<a name="l06904"></a>06904     <span class="keywordflow">return</span> bSuccess;
<a name="l06905"></a>06905 }
<a name="l06906"></a>06906 
<a name="l06907"></a>06907 
<a name="l06908"></a><a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">06908</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">OTTransaction::GetRecipientAcctIDForDisplay</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theReturnID)
<a name="l06909"></a>06909 {
<a name="l06910"></a>06910     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l06911"></a>06911         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06912"></a>06912     
<a name="l06913"></a>06913     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l06914"></a>06914     
<a name="l06915"></a>06915     <a class="code" href="class_o_t_item.html">OTItem</a>     * pOriginalItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a>     theItemAngel;
<a name="l06916"></a>06916     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem     = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel;
<a name="l06917"></a>06917     
<a name="l06918"></a>06918     <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l06919"></a>06919     this-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l06920"></a>06920     
<a name="l06921"></a>06921     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06922"></a>06922     {   
<a name="l06923"></a>06923 <span class="comment">//      case OTTransaction::marketReceipt: </span>
<a name="l06924"></a>06924         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l06925"></a>06925         {
<a name="l06926"></a>06926             <a class="code" href="class_o_t_string.html">OTString</a> strUpdatedCronItem;
<a name="l06927"></a>06927             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l06928"></a>06928             
<a name="l06929"></a>06929             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l06930"></a>06930                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strUpdatedCronItem);
<a name="l06931"></a>06931             <span class="keywordflow">else</span>
<a name="l06932"></a>06932                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failed trying to get paymentReceipt item from paymentReceipt transaction.\n&quot;</span>,
<a name="l06933"></a>06933                               __FUNCTION__);
<a name="l06934"></a>06934 
<a name="l06935"></a>06935             pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strUpdatedCronItem);
<a name="l06936"></a>06936             theCronItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pCronItem);
<a name="l06937"></a>06937             
<a name="l06938"></a>06938             <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmart = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06939"></a>06939             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   * pPlan  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l06940"></a>06940             
<a name="l06941"></a>06941             <span class="keywordflow">if</span> (NULL != pSmart) <span class="comment">// if it&#39;s a smart contract...</span>
<a name="l06942"></a>06942             {
<a name="l06943"></a>06943                 <span class="keywordflow">if</span> (!pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#a3493a6e50d526fd228d71eb3d571fda1">GetLastRecipientAcctID</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06944"></a>06944                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06945"></a>06945                 
<a name="l06946"></a>06946                 theReturnID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(pSmart-&gt;<a class="code" href="class_o_t_smart_contract.html#a3493a6e50d526fd228d71eb3d571fda1">GetLastRecipientAcctID</a>());
<a name="l06947"></a>06947                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06948"></a>06948             }
<a name="l06949"></a>06949             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pPlan) <span class="comment">// else if it&#39;s a payment plan.</span>
<a name="l06950"></a>06950             {
<a name="l06951"></a>06951                 theReturnID = pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a66300d99a12d32b6825e7e11dfca8614">GetRecipientAcctID</a>();
<a name="l06952"></a>06952                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06953"></a>06953             }
<a name="l06954"></a>06954             <span class="keywordflow">else</span> <span class="comment">// else if it is any other kind of cron item...</span>
<a name="l06955"></a>06955             {
<a name="l06956"></a>06956                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to load Cron Item. Should never happen. Receipt: %lld  Origin: %lld\n&quot;</span>,
<a name="l06957"></a>06957                               __FUNCTION__, this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l06958"></a>06958                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06959"></a>06959             }
<a name="l06960"></a>06960         }
<a name="l06961"></a>06961             <span class="keywordflow">break</span>; <span class="comment">// this break never actually happens. Above always returns, if triggered.</span>
<a name="l06962"></a>06962         <span class="comment">// ------------------------------------------</span>
<a name="l06963"></a>06963         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: 
<a name="l06964"></a>06964         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: 
<a name="l06965"></a>06965         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l06966"></a>06966         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l06967"></a>06967         {
<a name="l06968"></a>06968             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l06969"></a>06969             
<a name="l06970"></a>06970             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l06971"></a>06971                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l06972"></a>06972             
<a name="l06973"></a>06973             <span class="keywordflow">break</span>;
<a name="l06974"></a>06974         }
<a name="l06975"></a>06975         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l06976"></a>06976             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06977"></a>06977     }
<a name="l06978"></a>06978     <span class="comment">// -------------------------------------------------        </span>
<a name="l06979"></a>06979     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l06980"></a>06980         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l06981"></a>06981     <span class="comment">// -------------------------------------------------</span>
<a name="l06982"></a>06982     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l06983"></a>06983     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l06984"></a>06984         
<a name="l06985"></a>06985     <span class="keywordflow">switch</span> (<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l06986"></a>06986     {
<a name="l06987"></a>06987         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:
<a name="l06988"></a>06988         {
<a name="l06989"></a>06989             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>)
<a name="l06990"></a>06990             {
<a name="l06991"></a>06991                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to transferReceipt\n&quot;</span>);
<a name="l06992"></a>06992                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06993"></a>06993             }
<a name="l06994"></a>06994             <span class="keywordflow">else</span> 
<a name="l06995"></a>06995             {
<a name="l06996"></a>06996                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>();  
<a name="l06997"></a>06997                 bSuccess = <span class="keyword">true</span>;
<a name="l06998"></a>06998             }
<a name="l06999"></a>06999         }
<a name="l07000"></a>07000             <span class="keywordflow">break</span>;
<a name="l07001"></a>07001             
<a name="l07002"></a>07002         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l07003"></a>07003         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l07004"></a>07004         {
<a name="l07005"></a>07005             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l07006"></a>07006             {
<a name="l07007"></a>07007                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l07008"></a>07008                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == <a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l07009"></a>07009                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07010"></a>07010             }
<a name="l07011"></a>07011             <span class="keywordflow">else</span> 
<a name="l07012"></a>07012             {
<a name="l07013"></a>07013                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa51ed7e1bb8d701f3ed0641d6b1cde9a">GetPurportedAccountID</a>(); <span class="comment">// Here&#39;s the depositor&#39;s account ID (even though the cheque was made out to a user, not an account, it still eventually had to be DEPOSITED into an account... right?)</span>
<a name="l07014"></a>07014                 bSuccess = <span class="keyword">true</span>;
<a name="l07015"></a>07015             }
<a name="l07016"></a>07016         }
<a name="l07017"></a>07017             <span class="keywordflow">break</span>;
<a name="l07018"></a>07018             
<a name="l07019"></a>07019         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: <span class="comment">// amount is stored on transfer item</span>
<a name="l07020"></a>07020             
<a name="l07021"></a>07021             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)
<a name="l07022"></a>07022             {
<a name="l07023"></a>07023                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong item type attached to pending transfer\n&quot;</span>);
<a name="l07024"></a>07024             }
<a name="l07025"></a>07025             <span class="keywordflow">else</span>
<a name="l07026"></a>07026             {
<a name="l07027"></a>07027                 theReturnID = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#af9112e8a87e6cb1c785df0e0be59c99b">GetDestinationAcctID</a>();    
<a name="l07028"></a>07028                 bSuccess = <span class="keyword">true</span>;
<a name="l07029"></a>07029             }
<a name="l07030"></a>07030             <span class="keywordflow">break</span>;
<a name="l07031"></a>07031 
<a name="l07032"></a>07032         <span class="keywordflow">default</span>: <span class="comment">// All other types have no amount -- return 0.</span>
<a name="l07033"></a>07033             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07034"></a>07034     }
<a name="l07035"></a>07035     
<a name="l07036"></a>07036     <span class="keywordflow">return</span> bSuccess;
<a name="l07037"></a>07037 }
<a name="l07038"></a>07038 
<a name="l07039"></a>07039 
<a name="l07040"></a><a class="code" href="class_o_t_transaction.html#abc54a3c74c5235cfe1debe4a2f97c2cd">07040</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_transaction.html#abc54a3c74c5235cfe1debe4a2f97c2cd">OTTransaction::GetMemo</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strMemo)
<a name="l07041"></a>07041 {
<a name="l07042"></a>07042     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l07043"></a>07043         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07044"></a>07044     
<a name="l07045"></a>07045     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l07046"></a>07046     
<a name="l07047"></a>07047     <a class="code" href="class_o_t_item.html">OTItem</a>     * pOriginalItem = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a>     theItemAngel;
<a name="l07048"></a>07048     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem     = NULL; <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel;
<a name="l07049"></a>07049     
<a name="l07050"></a>07050     <a class="code" href="class_o_t_string.html">OTString</a> strReference;
<a name="l07051"></a>07051     this-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strReference);
<a name="l07052"></a>07052     
<a name="l07053"></a>07053     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l07054"></a>07054     {   
<a name="l07055"></a>07055 <span class="comment">//      case OTTransaction::marketReceipt: </span>
<a name="l07056"></a>07056         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>:
<a name="l07057"></a>07057         {
<a name="l07058"></a>07058             <a class="code" href="class_o_t_string.html">OTString</a> strUpdatedCronItem;
<a name="l07059"></a>07059             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = this-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1abcb18b39d8a5da830bdc9b52a825d47b">OTItem::paymentReceipt</a>);
<a name="l07060"></a>07060             
<a name="l07061"></a>07061             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l07062"></a>07062                 pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strUpdatedCronItem);
<a name="l07063"></a>07063             <span class="keywordflow">else</span>
<a name="l07064"></a>07064                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Failed trying to get paymentReceipt item from paymentReceipt transaction.\n&quot;</span>,
<a name="l07065"></a>07065                               __FUNCTION__);
<a name="l07066"></a>07066 
<a name="l07067"></a>07067             pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strUpdatedCronItem);
<a name="l07068"></a>07068             theCronItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pCronItem);
<a name="l07069"></a>07069             
<a name="l07070"></a>07070             <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmart = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l07071"></a>07071             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   * pPlan  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> *<span class="keyword">&gt;</span>(pCronItem);
<a name="l07072"></a>07072             
<a name="l07073"></a>07073             <span class="keywordflow">if</span> (NULL != pSmart) <span class="comment">// if it&#39;s a smart contract...</span>
<a name="l07074"></a>07074             {
<a name="l07075"></a>07075                 <span class="comment">// NOTE: smart contracts currently do not have a &quot;memo&quot; field.</span>
<a name="l07076"></a>07076                 
<a name="l07077"></a>07077                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07078"></a>07078             }
<a name="l07079"></a>07079             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pPlan) <span class="comment">// else if it is a payment plan.</span>
<a name="l07080"></a>07080             {
<a name="l07081"></a>07081                 <span class="keywordflow">if</span> (pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a242e72e1d0344a0ca85892468ded3dea">GetConsideration</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l07082"></a>07082                     strMemo.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a242e72e1d0344a0ca85892468ded3dea">GetConsideration</a>());
<a name="l07083"></a>07083 
<a name="l07084"></a>07084                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07085"></a>07085             }
<a name="l07086"></a>07086             <span class="keywordflow">else</span> <span class="comment">// else if it&#39;s any other kind of cron item.</span>
<a name="l07087"></a>07087             {
<a name="l07088"></a>07088                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTTransaction::%s: Unable to load Cron Item. Should never happen. Receipt: %lld  Origin: %lld\n&quot;</span>,
<a name="l07089"></a>07089                               __FUNCTION__, this-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), this-&gt;<a class="code" href="class_o_t_transaction.html#ad39211b22193f35493b07e2eea92d3f5">GetNumberOfOrigin</a>());
<a name="l07090"></a>07090                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07091"></a>07091             }
<a name="l07092"></a>07092         }
<a name="l07093"></a>07093             <span class="keywordflow">break</span>; <span class="comment">// this break never actually happens. Above always returns, if triggered.</span>
<a name="l07094"></a>07094         <span class="comment">// ------------------------------------------</span>
<a name="l07095"></a>07095         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: 
<a name="l07096"></a>07096         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>: 
<a name="l07097"></a>07097         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l07098"></a>07098         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l07099"></a>07099         {
<a name="l07100"></a>07100             pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strReference, <a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), <a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l07101"></a>07101             
<a name="l07102"></a>07102             <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l07103"></a>07103                 theItemAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOriginalItem);
<a name="l07104"></a>07104             
<a name="l07105"></a>07105             <span class="keywordflow">break</span>;
<a name="l07106"></a>07106         }
<a name="l07107"></a>07107         <span class="keywordflow">default</span>: 
<a name="l07108"></a>07108             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07109"></a>07109     }
<a name="l07110"></a>07110     <span class="comment">// -------------------------------------------------        </span>
<a name="l07111"></a>07111     <span class="keywordflow">if</span> (NULL == pOriginalItem)
<a name="l07112"></a>07112         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Should never happen, since we always expect one based on the transaction type.</span>
<a name="l07113"></a>07113     <span class="comment">// -------------------------------------------------</span>
<a name="l07114"></a>07114     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l07115"></a>07115     <a class="code" href="class_o_t_string.html">OTString</a> strAttachment;
<a name="l07116"></a>07116         
<a name="l07117"></a>07117     <span class="keywordflow">switch</span> (this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l07118"></a>07118     {
<a name="l07119"></a>07119         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>:
<a name="l07120"></a>07120         {
<a name="l07121"></a>07121             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>)
<a name="l07122"></a>07122             {
<a name="l07123"></a>07123                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to transferReceipt\n&quot;</span>, __FUNCTION__);
<a name="l07124"></a>07124                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07125"></a>07125             }
<a name="l07126"></a>07126             <span class="keywordflow">else</span> 
<a name="l07127"></a>07127             {
<a name="l07128"></a>07128                 pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strMemo);
<a name="l07129"></a>07129                 bSuccess = strMemo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
<a name="l07130"></a>07130             }
<a name="l07131"></a>07131         }
<a name="l07132"></a>07132             <span class="keywordflow">break</span>;
<a name="l07133"></a>07133             
<a name="l07134"></a>07134         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>:
<a name="l07135"></a>07135         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>:
<a name="l07136"></a>07136         {
<a name="l07137"></a>07137             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>)
<a name="l07138"></a>07138             {
<a name="l07139"></a>07139                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to %s (expected depositCheque)\n&quot;</span>, __FUNCTION__,
<a name="l07140"></a>07140                               (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a> == this-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;chequeReceipt&quot;</span> : <span class="stringliteral">&quot;voucherReceipt&quot;</span>);
<a name="l07141"></a>07141                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07142"></a>07142             }
<a name="l07143"></a>07143             <span class="keywordflow">else</span> 
<a name="l07144"></a>07144             {
<a name="l07145"></a>07145                 <a class="code" href="class_o_t_cheque.html">OTCheque</a>   theCheque;
<a name="l07146"></a>07146                 <a class="code" href="class_o_t_string.html">OTString</a>   strCheque;
<a name="l07147"></a>07147                 pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);
<a name="l07148"></a>07148                 <span class="comment">// -------------------------------------</span>
<a name="l07149"></a>07149                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp;
<a name="l07150"></a>07150                               theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
<a name="l07151"></a>07151                 {
<a name="l07152"></a>07152                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading cheque or voucher from string:\n%s\n&quot;</span>,
<a name="l07153"></a>07153                                   __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07154"></a>07154                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07155"></a>07155                 }
<a name="l07156"></a>07156                 <span class="comment">// ---------------------------------</span>
<a name="l07157"></a>07157                 <span class="comment">// Success loading the cheque.</span>
<a name="l07158"></a>07158                 <span class="comment">//</span>
<a name="l07159"></a>07159                 strMemo  = theCheque.<a class="code" href="class_o_t_cheque.html#a4990938b437cc95ab48ade4a80584023">GetMemo</a>();
<a name="l07160"></a>07160                 bSuccess = strMemo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
<a name="l07161"></a>07161             }
<a name="l07162"></a>07162         }
<a name="l07163"></a>07163             <span class="keywordflow">break</span>;
<a name="l07164"></a>07164             
<a name="l07165"></a>07165         <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>: 
<a name="l07166"></a>07166             
<a name="l07167"></a>07167             <span class="keywordflow">if</span> (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTItem::transfer</a>)
<a name="l07168"></a>07168             {
<a name="l07169"></a>07169                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong item type attached to pending transfer\n&quot;</span>, __FUNCTION__);
<a name="l07170"></a>07170             }
<a name="l07171"></a>07171             <span class="keywordflow">else</span>
<a name="l07172"></a>07172             {
<a name="l07173"></a>07173                 pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strMemo);
<a name="l07174"></a>07174                 bSuccess = strMemo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
<a name="l07175"></a>07175             }
<a name="l07176"></a>07176             <span class="keywordflow">break</span>;
<a name="l07177"></a>07177 
<a name="l07178"></a>07178         <span class="keywordflow">default</span>: 
<a name="l07179"></a>07179             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07180"></a>07180     }
<a name="l07181"></a>07181     
<a name="l07182"></a>07182     <span class="keywordflow">return</span> bSuccess;
<a name="l07183"></a>07183 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_transaction_8cpp.html">OTTransaction.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:04 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
