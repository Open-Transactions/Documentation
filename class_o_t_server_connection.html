<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: OTServerConnection Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_t_server_connection.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">OTServerConnection Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="OTServerConnection" -->
<p><code>#include &lt;<a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>&gt;</code></p>

<p><a href="class_o_t_server_connection-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a87841d3df1a7dbc5d129c3b97bdb0037">OTServerConnection</a> (<a class="el" href="class_o_t_wallet.html">OTWallet</a> &amp;theWallet, <a class="el" href="class_o_t_client.html">OTClient</a> &amp;theClient)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a7854e320ce9e1ce1c017aa37e154b0b5">~OTServerConnection</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a> (<a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;theID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_wallet.html">OTWallet</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#aa05fbf6b7b44512b4372022686d9aa07">IsFocused</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a7415f258bbfe6295f87a366b1c93dde0">SetFocus</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServerContract, <a class="el" href="struct_transport_callback.html">TransportCallback</a> *pCallback)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a3ffc7dae5e742e234cea0d63a6624b67">Connect</a> (<a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;theNym, <a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;theServerContract, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strCA_FILE, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strKEY_FILE, <a class="el" href="class_o_t_string.html">OTString</a> &amp;strKEY_PASSWORD)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a61901c8c0744a4746b019cfb56973ed6">OnServerResponseToGetRequestNumber</a> (int64_t lNewRequestNumber)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a> (char *buf, int32_t *pnExpectReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#ad08187c2586c656ce1c0b88a0391aa7d">ProcessMessageOut</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#aec033a0cae7e314846b73dbcedca6709">ProcessInBuffer</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theServerReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a52dba7fdfbb99cba2ec4c52634dfd3b1">ProcessReply</a> (<a class="el" href="unionu__header.html">u_header</a> &amp;theCMD, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theServerReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#a15f3d293ebf594eda909a09ab6368f42">ProcessType1Cmd</a> (<a class="el" href="unionu__header.html">u_header</a> &amp;theCMD, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theServerReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_server_connection.html#ad530f99cb1febbfcabbf73c40a984936">SignAndSend</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00182">182</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a87841d3df1a7dbc5d129c3b97bdb0037"></a><!-- doxytag: member="OTServerConnection::OTServerConnection" ref="a87841d3df1a7dbc5d129c3b97bdb0037" args="(OTWallet &amp;theWallet, OTClient &amp;theClient)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_server_connection.html#a87841d3df1a7dbc5d129c3b97bdb0037">OTServerConnection::OTServerConnection</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_wallet.html">OTWallet</a> &amp;&#160;</td>
          <td class="paramname"><em>theWallet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_client.html">OTClient</a> &amp;&#160;</td>
          <td class="paramname"><em>theClient</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00361">361</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">//m_pSocket         = NULL;</span>
    m_pCallback         = NULL;
    m_bFocused          = <span class="keyword">false</span>;
    m_pNym              = NULL;
    m_pServerContract   = NULL;
    m_pWallet           = &amp;theWallet;
    m_pClient           = &amp;theClient;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7854e320ce9e1ce1c017aa37e154b0b5"></a><!-- doxytag: member="OTServerConnection::~OTServerConnection" ref="a7854e320ce9e1ce1c017aa37e154b0b5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">EXPORT <a class="el" href="class_o_t_server_connection.html#a7854e320ce9e1ce1c017aa37e154b0b5">OTServerConnection::~OTServerConnection</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00203">203</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a3ffc7dae5e742e234cea0d63a6624b67"></a><!-- doxytag: member="OTServerConnection::Connect" ref="a3ffc7dae5e742e234cea0d63a6624b67" args="(OTPseudonym &amp;theNym, OTServerContract &amp;theServerContract, OTString &amp;strCA_FILE, OTString &amp;strKEY_FILE, OTString &amp;strKEY_PASSWORD)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">EXPORT bool <a class="el" href="class_o_t_server_connection.html#a3ffc7dae5e742e234cea0d63a6624b67">OTServerConnection::Connect</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerContract</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strCA_FILE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strKEY_FILE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strKEY_PASSWORD</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00218">218</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                               {<span class="keywordflow">return</span> <span class="keyword">false</span>;}
</pre></div>
</div>
</div>
<a class="anchor" id="a739b2ec134858347a8446d5c7bacbf98"></a><!-- doxytag: member="OTServerConnection::GetNym" ref="a739b2ec134858347a8446d5c7bacbf98" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a>* <a class="el" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">OTServerConnection::GetNym</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00207">207</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_pNym; }
</pre></div>
</div>
</div>
<a class="anchor" id="aa943d4506c254d30304d681b432971d9"></a><!-- doxytag: member="OTServerConnection::GetServerContract" ref="aa943d4506c254d30304d681b432971d9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a>* <a class="el" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">OTServerConnection::GetServerContract</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00208">208</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_pServerContract; }
</pre></div>
</div>
</div>
<a class="anchor" id="a71bbdb149a8b79ecea4a0909c6251849"></a><!-- doxytag: member="OTServerConnection::GetServerID" ref="a71bbdb149a8b79ecea4a0909c6251849" args="(OTIdentifier &amp;theID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">OTServerConnection::GetServerID</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>theID</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00332">332</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (m_pServerContract)
    {
        m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theID);
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa73d98b774148e33eab575613281edf3"></a><!-- doxytag: member="OTServerConnection::GetWallet" ref="aa73d98b774148e33eab575613281edf3" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_wallet.html">OTWallet</a>* <a class="el" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">OTServerConnection::GetWallet</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00209">209</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_pWallet; }
</pre></div>
</div>
</div>
<a class="anchor" id="aa05fbf6b7b44512b4372022686d9aa07"></a><!-- doxytag: member="OTServerConnection::IsFocused" ref="aa05fbf6b7b44512b4372022686d9aa07" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#aa05fbf6b7b44512b4372022686d9aa07">OTServerConnection::IsFocused</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00212">212</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_bFocused; }                          <span class="comment">// for request/response mode    -- RPC / HTTP</span>
</pre></div>
</div>
</div>
<a class="anchor" id="a61901c8c0744a4746b019cfb56973ed6"></a><!-- doxytag: member="OTServerConnection::OnServerResponseToGetRequestNumber" ref="a61901c8c0744a4746b019cfb56973ed6" args="(int64_t lNewRequestNumber)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server_connection.html#a61901c8c0744a4746b019cfb56973ed6">OTServerConnection::OnServerResponseToGetRequestNumber</a> </td>
          <td>(</td>
          <td class="paramtype">int64_t&#160;</td>
          <td class="paramname"><em>lNewRequestNumber</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00314">314</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (m_pNym &amp;&amp; m_pServerContract)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,  <span class="stringliteral">&quot;Received new request number from the server: %lld. Updating Nym records...\n&quot;</span>,
                lNewRequestNumber);

        <a class="code" href="class_o_t_string.html">OTString</a> strServerID;
        m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strServerID);
        m_pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a853bfd2bc9909356bda7698423053076">OnUpdateRequestNum</a>(*m_pNym, strServerID, lNewRequestNumber);
    }
    <span class="keywordflow">else</span> {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Expected m_pNym or m_pServerContract to be not null in &quot;</span>
                <span class="stringliteral">&quot;OTServerConnection::OnServerResponseToGetRequestNumber.\n&quot;</span>);
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="aec033a0cae7e314846b73dbcedca6709"></a><!-- doxytag: member="OTServerConnection::ProcessInBuffer" ref="aec033a0cae7e314846b73dbcedca6709" args="(OTMessage &amp;theServerReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">EXPORT bool <a class="el" href="class_o_t_server_connection.html#aec033a0cae7e314846b73dbcedca6709">OTServerConnection::ProcessInBuffer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerReply</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8hpp_source.html#l00226">226</a> of file <a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{<span class="keywordflow">return</span> <span class="keyword">false</span>;}
</pre></div>
</div>
</div>
<a class="anchor" id="ad352f309c26e38946374a7bc136ef3d2"></a><!-- doxytag: member="OTServerConnection::ProcessMessageOut" ref="ad352f309c26e38946374a7bc136ef3d2" args="(char *buf, int32_t *pnExpectReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">OTServerConnection::ProcessMessageOut</a> </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t *&#160;</td>
          <td class="paramname"><em>pnExpectReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00801">801</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{

    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != buf);

    <span class="keywordtype">bool</span> bSendCommand = <span class="keyword">false</span>;
    <span class="keywordtype">bool</span> bSendPayload = <span class="keyword">false</span>;

    <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;

    <span class="keywordtype">bool</span> bHandledIt = <span class="keyword">false</span>;

    <a class="code" href="unionu__header.html">u_header</a> theCMD;


<span class="comment">//  OT_ASSERT(IsConnected() || IsFocused());</span>


    <span class="comment">// clear the header</span>
    memset((<span class="keywordtype">void</span> *)theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, 0, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>);


    <span class="comment">// Simple rule here: In each of the below if statements,</span>
    <span class="comment">// YOU MUST set up the header bytes HERE!</span>
    <span class="comment">// OR you must set the boolean bSendCommand TO TRUE!!</span>
    <span class="comment">// It must be one or the other in each block.</span>
    <span class="comment">// If you set to true, code at the bottom will calculate header</span>
    <span class="comment">// for you. If you fail to do this, the header is now uncalculated either way.</span>
    <span class="comment">// Don&#39;t send uncalculated headers to the server unless doing it on purpose for TESTING.</span>

    <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;1&#39;</span>)
    {
        bHandledIt = <span class="keyword">true</span>;

        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a> = <a class="code" href="_o_t_server_connection_8hpp.html#afd0b82ab8c23317807df0f0d0b4f1a65">CMD_TYPE_1</a>;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a> = <a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a>;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> = 0;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#add5682159892cdcbf169ebdd261533b3">checksum</a> = <a class="code" href="_o_t_data_check_8hpp.html#a222155f64406d9a071c2f27349b0f8dc">CalcChecksum</a>(theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>-1);

        int32_t nChecksum = theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#add5682159892cdcbf169ebdd261533b3">checksum</a>;

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(User has instructed to send a size %d, TYPE 1 COMMAND to the server...)\n CHECKSUM: %d\n&quot;</span>,
                <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>, nChecksum);
        bSendCommand = <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;2&#39;</span>)
    {
        bHandledIt = <span class="keyword">true</span>;

        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a> = 12;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a> = 3;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> = 98;
        theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#add5682159892cdcbf169ebdd261533b3">checksum</a> = <a class="code" href="_o_t_data_check_8hpp.html#a222155f64406d9a071c2f27349b0f8dc">CalcChecksum</a>(theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>-1);

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(User has instructed to send a size %d, **malformed command** to the server...)\n&quot;</span>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>+3);
        bSendCommand = <span class="keyword">true</span>;
    }
    <span class="comment">// Empty OTMessage including signed XML, but no other commands</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;3&#39;</span>)
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(User has instructed to create a signed XML message and send it to the server...)\n&quot;</span>);
        bHandledIt = <span class="keyword">true</span>;

        <span class="comment">// Normally you&#39;d update the member variables here, before signing it.</span>
        <span class="comment">// But this is just an empty OTMessage.</span>

        <span class="comment">// When a message is signed, it updates its m_xmlUnsigned contents to the values in the members variables</span>
        m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a54362d788dc7c322796f37be9256428f">SignContractWithFirstNymOnList</a>(theMessage);

        <span class="comment">// SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
        <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
        theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

        bSendCommand = <span class="keyword">true</span>;
        bSendPayload = <span class="keyword">true</span>;
    }


    <span class="comment">// Above are various test messages.</span>

    <span class="comment">// ------------------------------------------------------------------------------</span>

    <span class="comment">// ------------------------------------------------------------------------------</span>

    <span class="comment">// This section for commands that involve building full XML messages,</span>
    <span class="comment">// that is, most of the real implementation of the transaction protocol.</span>

    <span class="comment">// If we can match the user&#39;s request to a client command,</span>
    <span class="comment">// AND theClient object is able to process that request into</span>
    <span class="comment">// a payload, THEN we create the header and send it all down the pipe.</span>

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bHandledIt &amp;&amp; m_pNym &amp;&amp; m_pServerContract)
    {
        <span class="comment">// check server ID command</span>
        <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;c&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(User has instructed to send a checkServerID command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">OTClient::checkServerID</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing checkServerID command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// register new user account</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;r&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a createUserAccount command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">OTClient::createUserAccount</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing createUserAccount command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// ALL MESSAGES BELOW THIS POINT SHOULD ATTACH A REQUEST NUMBER IF THEY EXPECT THE SERVER TO PROCESS THEM.</span>
        <span class="comment">// (Handled inside ProcessUserCommand)</span>

        <span class="comment">// checkUser</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;u&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a checkUser command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871">OTClient::checkUser</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL)) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing checkUser command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// register new asset account</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;a&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a createAccount command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13">OTClient::createAccount</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL)) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing createAccount command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// issue a new asset type</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;issue\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send an issueAssetType command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee">OTClient::issueAssetType</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing issueAssetType command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// issue a new basket asset type</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;basket\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send an issueBasket command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3">OTClient::issueBasket</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing issueBasket command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// exchange in/out of a basket currency</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;exchange\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send an exchangeBasket command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374">OTClient::exchangeBasket</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing exchangeBasket command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// make an offer and put it onto a market.</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;offer\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a marketOffer command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e">OTClient::marketOffer</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing marketOffer command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// set asset contract&#39;s name</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;setassetname\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to set an Asset Contract&#39;s client-side name...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f">OTClient::setAssetName</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL)) <span class="comment">// NULL pAccount on this command.</span>
            {
                <span class="comment">//              bSendCommand = true; // No message sent.</span>
                <span class="comment">//              bSendPayload = true;</span>
            }
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// set server contract&#39;s name</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;setservername\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to set a Server Contract&#39;s client-side name...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2">OTClient::setServerName</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                <span class="comment">//              bSendCommand = true; // No message sent.</span>
                <span class="comment">//              bSendPayload = true;</span>
            }
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// set nym name</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;setnymname\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to set a Nym&#39;s client-side name...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5">OTClient::setNymName</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                <span class="comment">//              bSendCommand = true; // No message sent.</span>
                <span class="comment">//              bSendPayload = true;</span>
            }
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// set account name</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;setaccountname\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User wants to set an Asset Account&#39;s client-side name...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9">OTClient::setAccountName</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                <span class="comment">//              bSendCommand = true; // No message sent.</span>
                <span class="comment">//              bSendPayload = true;</span>
            }
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// sendUserMessage</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;s&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a sendUserMessage command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b">OTClient::sendUserMessage</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing sendUserMessage command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get nymbox</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;y&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getNymbox command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a">OTClient::getNymbox</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getNymbox command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get inbox</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;i&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getInbox command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76">OTClient::getInbox</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getInbox command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get outbox</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;o&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getOutbox command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113">OTClient::getOutbox</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                                         NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getOutbox command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }


        <span class="comment">// deposit cheque</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;q&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;User has instructed to deposit a cheque...\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209">OTClient::notarizeCheque</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing deposit cheque command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// withdraw voucher</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;v&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;User has instructed to withdraw a voucher (like a cashier&#39;s cheque)...\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c">OTClient::withdrawVoucher</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing withdraw voucher command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// withdraw cash</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;w&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to withdraw cash...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654">OTClient::notarizeWithdrawal</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing withdraw command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// deposit tokens</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;d&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to deposit cash tokens...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602">OTClient::notarizeDeposit</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing deposit command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// activate payment plan</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;plan\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;User has instructed to activate a payment plan...\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75">OTClient::paymentPlan</a>, theMessage,
                                              *m_pNym, *m_pServerContract,
                                              NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing payment plan command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// deposit purse</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;p&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to deposit a purse containing cash...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506">OTClient::notarizePurse</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing deposit command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get account</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;test\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;(User has instructed to perform a test...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pNym)
            {
                <a class="code" href="class_o_t_string.html">OTString</a> strMessage(<span class="stringliteral">&quot;Well well well, this is just a little bit of plaintext.\nNotice there are NO NEWLINES at the start.\n&quot;</span>
                                    <span class="stringliteral">&quot;I&#39;m just trying to make it as long as i can, so that\nI can test the envelope and armor functionality.\n&quot;</span>);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;MESSAGE:\n------&gt;%s&lt;--------\n&quot;</span>, strMessage.Get());

                <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascMessage(strMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ASCII ARMOR:\n------&gt;%s&lt;--------\n&quot;</span>, ascMessage.Get());

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
                theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*m_pNym, strMessage);

                ascMessage.Release();

                theEnvelope.GetAsciiArmoredData(ascMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;ENCRYPTED PLAIN TEXT AND THEN ASCII ARMOR:\n------&gt;%s&lt;--------\n&quot;</span>, ascMessage.Get());

                strMessage.Release();

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> the2Envelope(ascMessage);
                the2Envelope.Open(*m_pNym, strMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;DECRYPTED PLAIN TEXT:\n------&gt;%s&lt;--------\n&quot;</span>, strMessage.Get());

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> the3Envelope;
                the3Envelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*m_pNym, strMessage.Get());

                ascMessage.Release();

                the3Envelope.GetAsciiArmoredData(ascMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;RE-ENCRYPTED PLAIN TEXT AND THEN ASCII ARMOR:\n------&gt;%s&lt;--------\n&quot;</span>, ascMessage.Get());

                strMessage.Release();

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> the4Envelope(ascMessage);
                the4Envelope.Open(*m_pNym, strMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;RE-DECRYPTED PLAIN TEXT:\n------&gt;%s&lt;--------\n&quot;</span>, strMessage.Get());

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> the5Envelope;
                the5Envelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*m_pNym, strMessage.Get());

                ascMessage.Release();

                the3Envelope.GetAsciiArmoredData(ascMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;RE-RE-ENCRYPTED PLAIN TEXT AND THEN ASCII ARMOR:\n------&gt;%s&lt;--------\n&quot;</span>, ascMessage.Get());

                strMessage.Release();

                <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> the6Envelope(ascMessage);
                the6Envelope.Open(*m_pNym, strMessage);

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;RE-RE-DECRYPTED PLAIN TEXT:\n------&gt;%s&lt;--------\n&quot;</span>, strMessage.Get());

            }

            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get account</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;get\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getAccount command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06">OTClient::getAccount</a>, theMessage,
                                            *m_pNym,  *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getAccount command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get contract</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;getcontract\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getContract command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c">OTClient::getContract</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getContract command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }


        <span class="comment">// sign contract</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;signcontract\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract a server contract, or an asset contract [s/a]: &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strContractType;
            strContractType.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);

            <span class="keywordtype">char</span> cContractType=<span class="charliteral">&#39;s&#39;</span>;
            <span class="keywordtype">bool</span> bIsAssetContract = strContractType.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cContractType);

            <span class="keywordflow">if</span> (bIsAssetContract)
            {
                <span class="keywordflow">if</span> (<span class="charliteral">&#39;S&#39;</span> == cContractType || <span class="charliteral">&#39;s&#39;</span> == cContractType)
                    bIsAssetContract = <span class="keyword">false</span>;
            }
            <span class="comment">// ----------------------------</span>
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract properly escaped already? (If escaped, all lines beginning with ----- will instead appear as - ----- ) [y\n]: &quot;</span>);
            <span class="comment">// User input.</span>
            <span class="comment">// I need a from account, Yes even in a deposit, it&#39;s still the &quot;From&quot; account.</span>
            <span class="comment">// The &quot;To&quot; account is only used for a transfer. (And perhaps for a 2-way trade.)</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strEscape;
            strEscape.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<span class="comment">//          strEscape.OTfgets(std::cin);</span>

            <span class="keywordtype">char</span> cEscape=<span class="charliteral">&#39;n&#39;</span>;
            <span class="keywordtype">bool</span> bEscaped = strEscape.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cEscape);

            <span class="keywordflow">if</span> (bEscaped)
            {
                <span class="keywordflow">if</span> (<span class="charliteral">&#39;N&#39;</span> == cEscape || <span class="charliteral">&#39;n&#39;</span> == cEscape)
                    bEscaped = <span class="keyword">false</span>;
            }

            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an unsigned asset contract; terminate with ~ on a new line:\n&gt; &quot;</span>);
            <a class="code" href="class_o_t_string.html">OTString</a> strContract;
            <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>

            <span class="keywordflow">do</span> {
                decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>

                <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
                    (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
                {
                    <span class="keywordflow">if</span> (!bEscaped &amp;&amp; decode_buffer[0] == <span class="charliteral">&#39;-&#39;</span>)
                    {
                        strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;- &quot;</span>);
                    }
                    strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
                }
                <span class="keywordflow">else</span>
                {
                    <span class="keywordflow">break</span>;
                }

            } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);

            <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> theServerContract;
            <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;

            <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = bIsAssetContract ? <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_contract.html">OTContract</a>*<span class="keyword">&gt;</span>(&amp;theAssetContract) : dynamic_cast&lt;OTContract*&gt;(&amp;theServerContract);

            pContract-&gt;<a class="code" href="class_o_t_contract.html#aefeed014e39aa6dc843d090e03769b5d">CreateContract</a>(strContract, *m_pNym);

            <span class="comment">// re-using strContract here for output this time.</span>
            strContract.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
            pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strContract);

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;.\n..\n...\n....\n.....\n......\n.......\n........\n.........\n\n&quot;</span>
                    <span class="stringliteral">&quot;NEW CONTRACT:\n\n%s\n&quot;</span>, strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// get mint</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(buf, <span class="stringliteral">&quot;getmint\n&quot;</span>))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getMint command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4">OTClient::getMint</a>, theMessage,
                                            *m_pNym,  *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getMint command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// notarize transfer</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;t&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a Transfer command (Notarize Transactions) to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec">OTClient::notarizeTransfer</a>, theMessage,
                                            *m_pNym,  *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing notarizeTransactions command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// getRequest</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;g&#39;</span>)
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getRequest command to the server...)\n&quot;</span>);

            <span class="comment">// ------------------------------------------------------------------------------</span>
            <span class="comment">// if successful setting up the command payload...</span>

            <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">OTClient::getRequest</a>, theMessage,
                                            *m_pNym, *m_pServerContract,
                                            NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
            {
                bSendCommand = <span class="keyword">true</span>;
                bSendPayload = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getRequest command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="comment">// getTransactionNum</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == <span class="charliteral">&#39;n&#39;</span>)
        {
            <span class="comment">// I just coded (here) for myself a secret option (for testing)...</span>
            <span class="comment">// Optionally instead of JUST &#39;n&#39;, I can put n &lt;number&gt;, (without brackets) and</span>
            <span class="comment">// this code will add that number to my list of issued and transaction numbers.</span>
            <span class="comment">// I already have the ability to clear the list, so now I can add numbers to it as well.</span>
            <span class="comment">// (Which adds to both lists.)</span>
            <span class="comment">// I can also remove a number from the transaction list but LEAVE it on the issued list,</span>
            <span class="comment">// for example by writing a cheque and throwing it away.</span>
            <span class="comment">//</span>
            <span class="comment">// This code is for testing and allows me to find and patch any problems without</span>
            <span class="comment">// having to re-create my data each time -- speeds up debugging.</span>
            <span class="comment">//</span>
            int64_t lTransactionNumber = ((strlen(buf) &gt; 2) ? atol(&amp;(buf[2])) : 0);

            <span class="keywordflow">if</span> (lTransactionNumber &gt; 0)
            {
                <a class="code" href="class_o_t_string.html">OTString</a> strServerID;
                m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strServerID);

                m_pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*m_pNym, strServerID, lTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>

                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Transaction number %lld added to both lists (on client side.)\n&quot;</span>,
                              lTransactionNumber);
            }

            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(User has instructed to send a getTransactionNum command to the server...)\n&quot;</span>);

                <span class="comment">// ------------------------------------------------------------------------------</span>
                <span class="comment">// if successful setting up the command payload...</span>

                <span class="keywordflow">if</span> (m_pClient-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">OTClient::getTransactionNum</a>, theMessage,
                                                *m_pNym,  *m_pServerContract,
                                                NULL) &gt; 0) <span class="comment">// NULL pAccount on this command.</span>
                {
                    bSendCommand = <span class="keyword">true</span>;
                    bSendPayload = <span class="keyword">true</span>;
                }
                <span class="keywordflow">else</span>
                    <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error processing getTransactionNum command in ProcessMessage: %c\n&quot;</span>, buf[0]);
            }

        <span class="comment">// ------------------------------------------------------------------------</span>
        }

        <span class="keywordflow">else</span>
        {
            <span class="keywordflow">if</span>( <a class="code" href="_o_t_server_connection_8cpp.html#ac7d98598fc9e0936b4f0e6b3e8ac1e0f">allow_debug</a> )
            {
                <span class="comment">//gDebugLog.Write(&quot;unknown user command in ProcessMessage in main.cpp&quot;);</span>
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
<span class="comment">//              OTLog::vError( &quot;unknown user command in ProcessMessage in main.cpp: %d\n&quot;, buf[0]);</span>
            }
            <span class="keywordflow">return</span>;
        }
    } <span class="comment">//if (false == bHandledIt &amp;&amp; m_pNym &amp;&amp; m_pServerContract)</span>

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bHandledIt)
    {
        <span class="comment">//      OTLog::Error( &quot;Your command was unrecognized or required resources that were not loaded.\n&quot;);</span>
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
    }

    <span class="keywordflow">if</span> (bSendCommand &amp;&amp; bSendPayload)
    {
        <span class="comment">// Voila -- it&#39;s sent. (If there was a payload involved.)</span>
        <a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(theMessage);
    } <span class="comment">// Otherwise... if it&#39;s a &quot;header only&quot; ...</span>

<span class="comment">//  else if (bSendCommand &amp;&amp; IsConnected()) // I only write to a socket if I&#39;m in socket mode...</span>
<span class="comment">//  {</span>
<span class="comment">//      uint32_t nHeaderSize = OT_CMD_HEADER_SIZE;</span>
<span class="comment">//</span>
<span class="comment">//      // TODO: REMOVE THIS. FOR TESTING ONLY (testing malformed headers, and headers without payloads...)</span>
<span class="comment">//      if (buf[0] == &#39;2&#39;) {</span>
<span class="comment">//          nHeaderSize += 3;</span>
<span class="comment">//      }</span>
<span class="comment">//</span>
<span class="comment">//      for (nwritten = 0;  nwritten &lt; nHeaderSize;  nwritten += err)</span>
<span class="comment">//      {</span>
<span class="comment">//          err = SFSocketWrite(m_pSocket, theCMD.buf + nwritten, nHeaderSize - nwritten);</span>
<span class="comment">//</span>
<span class="comment">//#ifdef _WIN32</span>
<span class="comment">//      if (0 == err || SOCKET_ERROR == err) //  0 is disonnect. error is error. &gt;0 is bytes written.</span>
<span class="comment">//#else</span>
<span class="comment">//      if (err &lt;= 0)</span>
<span class="comment">//#endif</span>
<span class="comment">//          break;</span>
<span class="comment">//      }</span>
<span class="comment">//</span>
<span class="comment">//      int32_t n0 = theCMD.buf[0], n1 = theCMD.buf[1], n2 = theCMD.buf[2], n3 = theCMD.buf[3], n4 = theCMD.buf[4], n5 = theCMD.buf[5], n6 = theCMD.buf[6];</span>
<span class="comment">//</span>
<span class="comment">//      OTLog::vOutput(4, &quot;Sent: %d %d %d %d %d %d %d\n&quot;, n0, n1, n2, n3, n4, n5, n6);</span>
<span class="comment">//  }</span>
    <span class="comment">// At this point, we have sent the header across the pipe.</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad08187c2586c656ce1c0b88a0391aa7d"></a><!-- doxytag: member="OTServerConnection::ProcessMessageOut" ref="ad08187c2586c656ce1c0b88a0391aa7d" args="(OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">OTServerConnection::ProcessMessageOut</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00691">691</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    int32_t  err = 0;
    uint32_t nwritten;

    <a class="code" href="unionu__header.html">u_header</a> theCMD;
    <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;


<span class="comment">//  OT_ASSERT(IsConnected() || IsFocused());</span>

    <span class="comment">// clear the header</span>
    memset((<span class="keywordtype">void</span> *)theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, 0, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>);

    <span class="comment">// Here is where we set up the Payload (so we have the size ready before the header goes out)</span>
    <span class="comment">// This is also where we have turned on the encrypted envelopes  }:-)</span>
    <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope; <span class="comment">// All comms should be encrypted in one of these envelopes.</span>

    <span class="comment">// Testing encrypted envelopes...</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = NULL;

    <span class="keywordflow">if</span> (m_pServerContract &amp;&amp;
        (NULL != (pServerNym = m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>())))
    {
        <a class="code" href="class_o_t_string.html">OTString</a> strEnvelopeContents;
        <span class="comment">// Save the ready-to-go message into a string.</span>
        theMessage.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strEnvelopeContents);

        <span class="comment">// Seal the string up into an encrypted Envelope</span>
        theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pServerNym, strEnvelopeContents);

        <span class="comment">// From here on out, theMessage is disposable. OTPayload takes over.</span>
        <span class="comment">// OTMessage doesn&#39;t care about checksums and headers.</span>
        thePayload.<a class="code" href="class_o_t_payload.html#a1a5fa31f9c665b99d9d1b96bd20944e3">SetEnvelope</a>(theEnvelope);

        <span class="comment">// Now that the payload is ready, we&#39;ll set up the header.</span>
        <a class="code" href="_o_t_server_connection_8cpp.html#a62c6857fa4abba2c187c1d0b7d5ac4e3">SetupHeader</a>(theCMD, <a class="code" href="_o_t_server_connection_8hpp.html#afd0b82ab8c23317807df0f0d0b4f1a65">CMD_TYPE_1</a>, <a class="code" href="_o_t_server_connection_8hpp.html#a6f5c18e3bfe1d71b8e89ea686ce3f287">TYPE_1_CMD_2</a>, thePayload);
    }
    <span class="comment">// else, for whatever reason, we just send an UNencrypted message... (This shouldn&#39;t happen anymore...) TODO remove.</span>
    <span class="keywordflow">else</span>
    {
        thePayload.<a class="code" href="class_o_t_payload.html#a2d099c964588c0c1d251992733ac9b5b">SetMessagePayload</a>(theMessage);

        <span class="comment">// Now that the payload is ready, we&#39;ll set up the header.</span>
        <a class="code" href="_o_t_server_connection_8cpp.html#a62c6857fa4abba2c187c1d0b7d5ac4e3">SetupHeader</a>(theCMD, <a class="code" href="_o_t_server_connection_8hpp.html#afd0b82ab8c23317807df0f0d0b4f1a65">CMD_TYPE_1</a>, <a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a>, thePayload);
    }

    <span class="comment">// ******************************************************************************</span>

    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_server_connection.html#aa05fbf6b7b44512b4372022686d9aa07">IsFocused</a>()) <span class="comment">// RPC / HTTP mode... ----------</span>
    {
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pCallback);
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pServerContract);

        <span class="comment">// Call the callback here.</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n=====&gt;BEGIN Sending %s message via ZMQ... Request number: %lld\n&quot;</span>,
                       theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                       atol(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));

        m_pCallback-&gt;operator()(*m_pServerContract, theEnvelope);

        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;&lt;=====END Finished sending %s message (and hopefully receiving a reply.)\nRequest number: %lld\n\n&quot;</span>,
                       theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                       atol(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
    }
    <span class="comment">// ******************************************************************************</span>

    <span class="keywordflow">else</span>            <span class="comment">// TCP / SSL mode... -----------</span>
    {
        <span class="keyword">const</span> uint32_t nHeaderSize = <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>;

        <span class="keywordflow">for</span> (nwritten = 0;  nwritten &lt; nHeaderSize;  nwritten += err)
        {
<span class="comment">//          err = SFSocketWrite(m_pSocket, theCMD.buf + nwritten, nHeaderSize - nwritten);</span>

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">//  0 is disonnect. error is error. &gt;0 is bytes written.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                <span class="keywordflow">break</span>;
        }

        <span class="comment">// At this point, we have sent the header across the pipe.</span>
        <span class="comment">// Next we write the payload...</span>

        uint32_t nPayloadSize = thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>();

        <span class="keywordflow">for</span> (nwritten = 0;  nwritten &lt; nPayloadSize;  nwritten += err)
        {
<span class="comment">//          err = SFSocketWrite(m_pSocket, (uint8_t *)thePayload.GetPayloadPointer() + nwritten, nPayloadSize - nwritten);</span>

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">//  0 is disonnect. error is error. &gt;0 is bytes written.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                <span class="keywordflow">break</span>;
        }
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Message sent via TCP / SSL...\n\n&quot;</span>);
    }

    <span class="comment">// At this point, we have sent the envelope to the server.</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a52dba7fdfbb99cba2ec4c52634dfd3b1"></a><!-- doxytag: member="OTServerConnection::ProcessReply" ref="a52dba7fdfbb99cba2ec4c52634dfd3b1" args="(u_header &amp;theCMD, OTMessage &amp;theServerReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#a52dba7fdfbb99cba2ec4c52634dfd3b1">OTServerConnection::ProcessReply</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionu__header.html">u_header</a> &amp;&#160;</td>
          <td class="paramname"><em>theCMD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00427">427</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

    <span class="comment">//OT_ASSERT(NULL != m_pSocket);</span>

    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;\n****************************************************************\n&quot;</span>
            <span class="stringliteral">&quot;===&gt; Processing header from server response.\nFirst 9 bytes are: %d %d %d %d %d %d %d %d %d...\n&quot;</span>,
            theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[0],theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[1],theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[2],theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[3],theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[4],theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[5], theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[6], theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[7], theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>[8]);


    <span class="keywordflow">if</span>( theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a> == <a class="code" href="_o_t_server_connection_8hpp.html#afd0b82ab8c23317807df0f0d0b4f1a65">CMD_TYPE_1</a> )
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Received a Type 1 Command...\n&quot;</span>);

        <span class="keywordflow">if</span>( <a class="code" href="_o_t_data_check_8hpp.html#a3f73adcb6c603c69f3b41833b831a412">IsChecksumValid</a>( theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a> ) )
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Checksum is valid! Processing payload.\n&quot;</span>);

            <span class="keywordflow">if</span> (<span class="keyword">true</span> == <a class="code" href="class_o_t_server_connection.html#a15f3d293ebf594eda909a09ab6368f42">ProcessType1Cmd</a>(theCMD, theServerReply ))
                bSuccess = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span> {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Invalid checksum - Type 1 Command\n&quot;</span>);
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">//gDebugLog.Write(&quot;Unknown command type&quot;);</span>
        int32_t nCMDType = theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a>;
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Unknown command type: %d\n&quot;</span>, nCMDType);
    }


    <span class="comment">// I added this for error correction. In the event that there are errors,</span>
    <span class="comment">// just clean out whatever is in the pipe and throw it away.</span>
    <span class="comment">// Should probably send an Error message back, as well.</span>
    <span class="keywordflow">if</span> (bSuccess == <span class="keyword">false</span>)
    {
        int32_t  err = 0, nread = 0;

        <span class="keywordflow">for</span> (;;)
        {
            <span class="comment">//err = SFSocketRead(m_pSocket, buffer, sizeJunkData);</span>

            <span class="keywordflow">if</span> (err &gt; 0) <span class="comment">// _WIN32</span>
                nread += err;

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">// 0 means disconnect. error means error. &gt;0 means bytes read.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                <span class="keywordflow">break</span>;
        }

        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Transmission error--therefore have flushed the pipe, discarding %d bytes.\n&quot;</span>, nread);
    }

    <span class="keywordflow">return</span> bSuccess;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a15f3d293ebf594eda909a09ab6368f42"></a><!-- doxytag: member="OTServerConnection::ProcessType1Cmd" ref="a15f3d293ebf594eda909a09ab6368f42" args="(u_header &amp;theCMD, OTMessage &amp;theServerReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#a15f3d293ebf594eda909a09ab6368f42">OTServerConnection::ProcessType1Cmd</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionu__header.html">u_header</a> &amp;&#160;</td>
          <td class="paramname"><em>theCMD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerReply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00493">493</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// At this point, the checksum has already validated.</span>
    <span class="comment">// Might as well get the PAYLOAD next.</span>
    int32_t  err = 0;
    uint32_t nread;

<span class="comment">//  OT_ASSERT(NULL != m_pSocket);</span>

    <span class="comment">// Make sure our byte-order is correct here.</span>
    theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> = ntohl(theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>); <span class="comment">// think this is causing problems... maybe not...</span>

    <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
    thePayload.<a class="code" href="class_o_t_payload.html#a8a6a8221de63686df445f0e77e73f214">SetPayloadSize</a>(static_cast&lt;uint32_t&gt;(theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>));

    <span class="keywordflow">for</span> (nread = 0;  nread &lt; theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>;  nread += err)
    {
<span class="comment">//      err = SFSocketRead(m_pSocket, (uint8_t *)thePayload.GetPayloadPointer() + nread, theCMD.fields.size - nread);</span>

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == 0) <span class="comment">// 0 means disconnect. error means error. otherwise, err contains bytes read.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <span class="keywordflow">break</span>;
    }

    <span class="comment">// ------------------------------------------------------------</span>

    <span class="keywordflow">switch</span> (theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>) {
        <span class="keywordflow">case</span> <a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a>:
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3,  <span class="stringliteral">&quot;Received TYPE 1 CMD 1, an OTMessage.\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="_o_t_server_connection_8hpp.html#a6f5c18e3bfe1d71b8e89ea686ce3f287">TYPE_1_CMD_2</a>:
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;Received TYPE 1 CMD 2, an OTEnvelope containing an OTMessage.\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <span class="keywordflow">break</span>;
    }

    <span class="comment">// ------------------------------------------------------------</span>

    <span class="keywordflow">if</span> (theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> == 0)
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(The payload was a 0 size.)\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nread &lt; theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>)
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Number of bytes read (%d) did NOT match size in header (%d).\n&quot;</span>,
                nread, theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4,  <span class="stringliteral">&quot;Loaded a payload, size: %d\n&quot;</span>, theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>);
    }
    <span class="comment">// ------------------------------------------------------------</span>


    <span class="comment">// a signed OTMessage</span>
    <span class="keywordflow">if</span> (<a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a> == theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>)
    {
        <span class="keywordflow">if</span> (thePayload.<a class="code" href="class_o_t_payload.html#aa26daa2e7d1d86b88686ecf8431535c5">GetMessagePayload</a>(theServerReply))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Successfully retrieved payload message...\n&quot;</span>);

            <span class="keywordflow">if</span> (theServerReply.<a class="code" href="class_o_t_contract.html#a89edae048b064a50a255fbfe4f7dcef5">ParseRawFile</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Successfully parsed payload message.\n&quot;</span>);

                <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym =
                    (NULL != m_pServerContract) ? m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>() : NULL;

                <span class="keywordflow">if</span> (m_pServerContract &amp;&amp; pServerNym) <span class="comment">// todo casting.</span>
                {
                    <span class="keywordflow">if</span> (theServerReply.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pServerNym)) <span class="comment">// todo casting.</span>
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;VERIFIED -- this message was signed by the Server.\n&quot;</span>);
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Signature verification failed on this message, proportedly from the Server.\n&quot;</span>);
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                    }
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No server contract loaded, or could not load public key from server contract.\n&quot;</span>);
                    <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span> {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error parsing message.\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }

        }
        <span class="keywordflow">else</span> {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error retrieving message from payload.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }

    }

    <span class="comment">// A base64-encoded envelope, encrypted, and containing a signed message.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_o_t_server_connection_8hpp.html#a6f5c18e3bfe1d71b8e89ea686ce3f287">TYPE_1_CMD_2</a> == theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>)
    {
        <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
        <span class="keywordflow">if</span> (thePayload.<a class="code" href="class_o_t_payload.html#af2c079778a1809964c6e2f138e4d6819">GetEnvelope</a>(theEnvelope))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;===&gt; Received encrypted envelope. (Server reply.) Decrypting...\n&quot;</span>);

            <a class="code" href="class_o_t_string.html">OTString</a> strEnvelopeContents;

            <span class="comment">// Decrypt the Envelope.</span>
            <span class="keywordflow">if</span> (m_pNym &amp;&amp; theEnvelope.<a class="code" href="class_o_t_envelope.html#ae2e8fafc4e508ce5d323c089b71c7e7b">Open</a>(*m_pNym, strEnvelopeContents))
            {
                <span class="comment">// All decrypted, now let&#39;s load the results into an OTMessage.</span>
                <span class="comment">// No need to call theMessage.ParseRawFile() after, since</span>
                <span class="comment">// LoadContractFromString handles it.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (theServerReply.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strEnvelopeContents))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Success decrypting the message out of the envelope and parsing it.\n&quot;</span>);

                    <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym =
                        (NULL != m_pServerContract) ? m_pServerContract-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>() : NULL;

                    <span class="keywordflow">if</span> (m_pServerContract &amp;&amp; pServerNym) <span class="comment">// todo casting.</span>
                    {
                        <span class="keywordflow">if</span> (theServerReply.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pServerNym)) <span class="comment">// todo casting.</span>
                        {
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;VERIFIED -- this message was signed by the Server.\n&quot;</span>);
<span class="comment">//                          OTLog::vOutput(0,  &quot;VERIFIED -- this message was signed by the Server:\n%s\n&quot;, strEnvelopeContents.Get());</span>
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0,  <span class="stringliteral">&quot;Signature verification failed on this message, purportedly from the Server.\n&quot;</span>);
                            <span class="keywordflow">return</span> <span class="keyword">false</span>;
                        }
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;No server contract loaded, or could not load public key from server contract.\n&quot;</span>);
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                    }

                    <span class="keywordflow">return</span> <span class="keyword">true</span>;
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading message from envelope contents.\n&quot;</span>);
                    <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to open envelope.\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error retrieving message from payload.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
    }
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error retrieving message from payload. Unknown type.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7415f258bbfe6295f87a366b1c93dde0"></a><!-- doxytag: member="OTServerConnection::SetFocus" ref="a7415f258bbfe6295f87a366b1c93dde0" args="(OTPseudonym &amp;theNym, OTServerContract &amp;theServerContract, TransportCallback *pCallback)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#a7415f258bbfe6295f87a366b1c93dde0">OTServerConnection::SetFocus</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;&#160;</td>
          <td class="paramname"><em>theNym</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_server_contract.html">OTServerContract</a> &amp;&#160;</td>
          <td class="paramname"><em>theServerContract</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_transport_callback.html">TransportCallback</a> *&#160;</td>
          <td class="paramname"><em>pCallback</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00224">224</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (NULL == pCallback) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: pCallback is NULL&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };

    <span class="comment">// We&#39;re already connected! You can&#39;t use SetFocus if you&#39;re in connection mode (TCP instead of HTTP.)</span>
    <span class="comment">//if (IsConnected())</span>
    <span class="comment">//  return false;</span>
    <span class="comment">//</span>
    <span class="comment">// This call initializes OpenSSL (only the first time it&#39;s called.)</span>
    Initialize();

    <span class="comment">// The Client keeps an internal ServerConnection at all times.</span>
    <span class="comment">// In SSL/TCP mode, you connect, and stay connected. But in RPC</span>
    <span class="comment">// mode, you must call SetFocus before each time you prepare or</span>
    <span class="comment">// process any server-related messages. Why? Since the Client normally</span>
    <span class="comment">// expects the connection to already be made, and therefore expects</span>
    <span class="comment">// to have access to the Nym and Server Contract (and server ID, etc)</span>
    <span class="comment">// available since those pointers are normally set during Connect().</span>
    <span class="comment">// Since we no longer connect in RPC mode, we must still make sure those</span>
    <span class="comment">// pointers are ready by calling SetFocus before they might end up being used.</span>
    <span class="comment">// Each time you send a new message, it might be to a different server or</span>
    <span class="comment">// from a different nym. That&#39;s fine -- just call SetFocus() before you do it.</span>
    m_pNym              = &amp;theNym;
    m_pServerContract   = &amp;theServerContract;
    m_pCallback         = pCallback; <span class="comment">// This is what we get instead of a socket, when we&#39;re in RPC mode.</span>
    m_bFocused          = <span class="keyword">true</span>;

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad530f99cb1febbfcabbf73c40a984936"></a><!-- doxytag: member="OTServerConnection::SignAndSend" ref="ad530f99cb1febbfcabbf73c40a984936" args="(OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_server_connection.html#ad530f99cb1febbfcabbf73c40a984936">OTServerConnection::SignAndSend</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_server_connection_8cpp_source.html#l00673">673</a> of file <a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (m_pNym &amp;&amp;
        m_pWallet &amp;&amp;
<span class="comment">//      (IsConnected() || IsFocused()) &amp;&amp;</span>
        theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*m_pNym) &amp;&amp;
        theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>())
    {
        <a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(theMessage);
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }

    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/otapi/<a class="el" href="_o_t_server_connection_8hpp_source.html">OTServerConnection.hpp</a></li>
<li>src/otapi/<a class="el" href="_o_t_server_connection_8cpp_source.html">OTServerConnection.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_o_t_server_connection.html">OTServerConnection</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:16 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
