<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otlib/OTCredential.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_credential_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otlib/OTCredential.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_credential_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *  OTCredential.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">// A nym contains a list of credentials</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// Each credential contains a &quot;master&quot; subkey, and a list of subkeys</span>
<a name="l00010"></a>00010 <span class="comment">// signed by that master.</span>
<a name="l00011"></a>00011 <span class="comment">//</span>
<a name="l00012"></a>00012 <span class="comment">// The same class (subkey) is used because there are master credentials</span>
<a name="l00013"></a>00013 <span class="comment">// and subkey credentials, so we&#39;re using a single &quot;subkey&quot; class to</span>
<a name="l00014"></a>00014 <span class="comment">// encapsulate each credential, both for the master credential and</span>
<a name="l00015"></a>00015 <span class="comment">// for each subkey credential.</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00017"></a>00017 <span class="comment">// Each subkey has 3 key pairs: encryption, signing, and authentication.</span>
<a name="l00018"></a>00018 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment">// Each key pair has 2 OTAsymmetricKeys (public and private.)</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/************************************************************</span>
<a name="l00022"></a>00022 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00023"></a>00023 <span class="comment"> Hash: SHA1</span>
<a name="l00024"></a>00024 <span class="comment"> </span>
<a name="l00025"></a>00025 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00028"></a>00028 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00031"></a>00031 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00032"></a>00032 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00033"></a>00033 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00034"></a>00034 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00035"></a>00035 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00036"></a>00036 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> *  EMAIL:</span>
<a name="l00041"></a>00041 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00042"></a>00042 <span class="comment"> *</span>
<a name="l00043"></a>00043 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00044"></a>00044 <span class="comment"> *</span>
<a name="l00045"></a>00045 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00046"></a>00046 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00049"></a>00049 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00050"></a>00050 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00051"></a>00051 <span class="comment"> *</span>
<a name="l00052"></a>00052 <span class="comment"> *  WEBSITE:</span>
<a name="l00053"></a>00053 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00054"></a>00054 <span class="comment"> *</span>
<a name="l00055"></a>00055 <span class="comment"> *  Components and licensing:</span>
<a name="l00056"></a>00056 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00057"></a>00057 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00058"></a>00058 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00059"></a>00059 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00060"></a>00060 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00061"></a>00061 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00064"></a>00064 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00065"></a>00065 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00066"></a>00066 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00067"></a>00067 <span class="comment"> *</span>
<a name="l00068"></a>00068 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00069"></a>00069 <span class="comment"> *</span>
<a name="l00070"></a>00070 <span class="comment"> *   LICENSE:</span>
<a name="l00071"></a>00071 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00072"></a>00072 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00073"></a>00073 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00074"></a>00074 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00075"></a>00075 <span class="comment"> *   option) any later version.</span>
<a name="l00076"></a>00076 <span class="comment"> *</span>
<a name="l00077"></a>00077 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00078"></a>00078 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00079"></a>00079 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00080"></a>00080 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00081"></a>00081 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00082"></a>00082 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00083"></a>00083 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00084"></a>00084 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00085"></a>00085 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00086"></a>00086 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00087"></a>00087 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00088"></a>00088 <span class="comment"> *</span>
<a name="l00089"></a>00089 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00090"></a>00090 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00091"></a>00091 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00092"></a>00092 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00093"></a>00093 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00094"></a>00094 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00095"></a>00095 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00096"></a>00096 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00097"></a>00097 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00098"></a>00098 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00099"></a>00099 <span class="comment"> *</span>
<a name="l00100"></a>00100 <span class="comment"> *   Lucre License:</span>
<a name="l00101"></a>00101 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00102"></a>00102 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00103"></a>00103 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00104"></a>00104 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00105"></a>00105 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00106"></a>00106 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00107"></a>00107 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00108"></a>00108 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00109"></a>00109 <span class="comment"> *   will continue to operate.</span>
<a name="l00110"></a>00110 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00111"></a>00111 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00112"></a>00112 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00113"></a>00113 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00114"></a>00114 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00115"></a>00115 <span class="comment"> *</span>
<a name="l00116"></a>00116 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00117"></a>00117 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00118"></a>00118 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00119"></a>00119 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00120"></a>00120 <span class="comment"> *</span>
<a name="l00121"></a>00121 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00122"></a>00122 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00123"></a>00123 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00124"></a>00124 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00125"></a>00125 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00126"></a>00126 <span class="comment"> *   more details.</span>
<a name="l00127"></a>00127 <span class="comment"> </span>
<a name="l00128"></a>00128 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00129"></a>00129 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00130"></a>00130 <span class="comment"> </span>
<a name="l00131"></a>00131 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00132"></a>00132 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00133"></a>00133 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00134"></a>00134 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00135"></a>00135 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00136"></a>00136 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00137"></a>00137 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00138"></a>00138 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00139"></a>00139 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00140"></a>00140 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00141"></a>00141 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00142"></a>00142 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00143"></a>00143 <span class="comment"> =uSzz</span>
<a name="l00144"></a>00144 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00145"></a>00145 <span class="comment"> **************************************************************/</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_credential_8hpp.html">OTCredential.hpp</a>&gt;</span>
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_assert_8hpp.html">OTAssert.hpp</a>&gt;</span>
<a name="l00152"></a>00152 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_signature_8hpp.html">OTSignature.hpp</a>&gt;</span>
<a name="l00153"></a>00153 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00154"></a>00154 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00155"></a>00155 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_password_8hpp.html">OTPassword.hpp</a>&gt;</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="preprocessor">#include &quot;irrxml/irrXML.hpp&quot;</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="comment">// &#39;0&#39; for cKeyType means, theSignature MUST have metadata in order for ANY keys to be returned, and it MUST match.</span>
<a name="l00162"></a>00162 <span class="comment">// Whereas if you pass &#39;A&#39;, &#39;E&#39;, or &#39;S&#39; for cKeyType, that means it can ONLY return authentication, encryption, or signing</span>
<a name="l00163"></a>00163 <span class="comment">// keys. It also means that metadata must match IF it&#39;s present, but that otherwise, if theSignature has no metadata at</span>
<a name="l00164"></a>00164 <span class="comment">// all, then it will still be a &quot;presumed match&quot; and returned as a possibility. (With the &#39;A&#39;, &#39;E&#39;, or &#39;S&#39; enforced.)</span>
<a name="l00165"></a>00165 <span class="comment">//</span>
<a name="l00166"></a><a class="code" href="class_o_t_credential.html#ade34be3c485c120489e923d31af8bc63">00166</a> int32_t <a class="code" href="class_o_t_credential.html#ade34be3c485c120489e923d31af8bc63">OTCredential::GetPublicKeysBySignature</a>(<a class="code" href="_o_t_asymmetric_key_8hpp.html#ada6127549a4970b60a8939215dd89ddb">listOfAsymmetricKeys</a> &amp; listOutput,
<a name="l00167"></a>00167                                            <span class="keyword">const</span> <a class="code" href="class_o_t_signature.html">OTSignature</a> &amp; theSignature,
<a name="l00168"></a>00168                                            <span class="keywordtype">char</span> cKeyType<span class="comment">/*=&#39;0&#39;*/</span>) <span class="keyword">const</span> <span class="comment">// &#39;S&#39; (signing key) or &#39;E&#39; (encryption key) or &#39;A&#39; (authentication key)</span>
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170     int32_t nCount = 0;
<a name="l00171"></a>00171     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l00172"></a>00172     {
<a name="l00173"></a>00173         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = (*it).second;
<a name="l00174"></a>00174         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00175"></a>00175         <span class="comment">// -------------------------</span>
<a name="l00176"></a>00176         <span class="keyword">const</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pKey = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (NULL == pKey) <span class="keywordflow">continue</span>; <span class="comment">// Skip all non-key credentials. We&#39;re looking for keys.</span>
<a name="l00178"></a>00178         <span class="comment">// -------------------------</span>
<a name="l00179"></a>00179         <span class="keyword">const</span> int32_t nTempCount = pKey-&gt;<a class="code" href="class_o_t_key_credential.html#a7046ca845b6fa346e41e239c818e4aa6">GetPublicKeysBySignature</a>(listOutput, theSignature, cKeyType);
<a name="l00180"></a>00180         nCount += nTempCount;
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182     <span class="keywordflow">return</span> nCount;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="class_o_t_credential.html#ac84a55bc3e33ba5088ddc1e60eb1bca8">00186</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#ac84a55bc3e33ba5088ddc1e60eb1bca8">OTCredential::VerifyInternally</a>()<span class="keyword"> const</span>
<a name="l00187"></a>00187 <span class="keyword"></span>{
<a name="l00188"></a>00188     <span class="comment">// --------------------------------------</span>
<a name="l00189"></a>00189     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theActualMasterCredID;
<a name="l00190"></a>00190     theActualMasterCredID.<a class="code" href="class_o_t_identifier.html#ac50b356cf5d5d04c08eaf568d07bcc46">CalculateDigest</a>(m_Masterkey.<a class="code" href="class_o_t_subcredential.html#af10db6cd37a86780acbcc0bf1e6101a5">GetPubCredential</a>());
<a name="l00191"></a>00191     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strActualMasterCredID(theActualMasterCredID);
<a name="l00192"></a>00192     <span class="comment">// --------------------------------------</span>
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (<span class="keyword">false</span> == m_strNymID.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a7d841c2d684d40d8e028c0a2eaff7b36">GetNymID</a>()))
<a name="l00194"></a>00194     {
<a name="l00195"></a>00195         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: NymID did not match its &quot;</span>
<a name="l00196"></a>00196                        <span class="stringliteral">&quot;counterpart in m_Masterkey (failed to verify): %s\n&quot;</span>,
<a name="l00197"></a>00197                        __FUNCTION__, this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get());
<a name="l00198"></a>00198         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200     <span class="comment">// --------------------------------------</span>
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (<span class="keyword">false</span> == m_strMasterCredID.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(strActualMasterCredID))
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Master Credential ID did not match its &quot;</span>
<a name="l00204"></a>00204                        <span class="stringliteral">&quot;counterpart in m_Masterkey:\nExpected Master Credential ID: %s\n &quot;</span>
<a name="l00205"></a>00205                        <span class="stringliteral">&quot;Hash of m_Masterkey contents: %s\nContents:\n%s\n&quot;</span>,
<a name="l00206"></a>00206                        __FUNCTION__, this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>().Get(), strActualMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l00207"></a>00207                        m_Masterkey.<a class="code" href="class_o_t_subcredential.html#af10db6cd37a86780acbcc0bf1e6101a5">GetPubCredential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00208"></a>00208         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <span class="comment">// --------------------------------------</span>
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (<span class="keyword">false</span> == const_cast&lt;OTMasterkey&amp;&gt;(m_Masterkey).VerifyContract())
<a name="l00212"></a>00212     {
<a name="l00213"></a>00213         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Master Credential failed to verify: %s\nNymID: %s\n&quot;</span>,
<a name="l00214"></a>00214                        __FUNCTION__, this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>().Get(), this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get());
<a name="l00215"></a>00215         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="comment">// -------------------------------------</span>
<a name="l00218"></a>00218     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220         std::string str_sub_id = (*it).first;
<a name="l00221"></a>00221         <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = (*it).second;
<a name="l00222"></a>00222         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00223"></a>00223         <span class="comment">// ----------------------</span>
<a name="l00224"></a>00224         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSub-&gt;<a class="code" href="class_o_t_subcredential.html#ab62e933c731796fd827cf63a8c718c65">VerifyContract</a>())
<a name="l00225"></a>00225         {
<a name="l00226"></a>00226             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Subcredential failed to verify: %s\nNymID: %s\n&quot;</span>, __FUNCTION__,
<a name="l00227"></a>00227                            str_sub_id.c_str(), this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00228"></a>00228             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00229"></a>00229         }
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231     <span class="comment">// -------------------------------------</span>
<a name="l00232"></a>00232     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="class_o_t_credential.html#abacd81f1c7aa266d65b0fc2153c1e6b5">00236</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#abacd81f1c7aa266d65b0fc2153c1e6b5">OTCredential::VerifyAgainstSource</a>()<span class="keyword"> const</span>
<a name="l00237"></a>00237 <span class="keyword"></span>{
<a name="l00238"></a>00238     <span class="comment">// * Any OTMasterkey must (at some point, and/or regularly) verify against its own source.</span>
<a name="l00239"></a>00239     <span class="comment">//</span>
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (<span class="keyword">false</span> == m_Masterkey.<a class="code" href="class_o_t_masterkey.html#abdb9ddd5ec008585249cf2d3a36787d0">VerifyAgainstSource</a>())
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed verifying master credential against its own source.\n&quot;</span>, __FUNCTION__);
<a name="l00243"></a>00243         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245     <span class="comment">// NOTE: This spot will have a significant delay, TODO OPTIMIZE. Performing a Freenet lookup, or DNS, etc,</span>
<a name="l00246"></a>00246     <span class="comment">// will introduce delay inside the call VerifyAgainstSource. Therefore in the int64_t term, we must have a</span>
<a name="l00247"></a>00247     <span class="comment">// separate server process which will verify identities for some specified period of time (specified in</span>
<a name="l00248"></a>00248     <span class="comment">// their credentials I suppose...) That way, when we call VerifyAgainstSource, we are verifying against</span>
<a name="l00249"></a>00249     <span class="comment">// some server-signed authorization, based on a lookup that some separate process did within the past</span>
<a name="l00250"></a>00250     <span class="comment">// X allowed time, such that the lookup is still considered valid (without having to lookup every single</span>
<a name="l00251"></a>00251     <span class="comment">// time, which is untenable.)</span>
<a name="l00252"></a>00252     <span class="comment">// -------------------------------------</span>
<a name="l00253"></a>00253     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 <span class="comment">// Contains a &quot;master&quot; subkey,</span>
<a name="l00258"></a>00258 <span class="comment">// and a list of &quot;sub&quot; subkeys signed by that master.</span>
<a name="l00259"></a>00259 <span class="comment">// Each subkey can generate its own &quot;credential&quot; contract,</span>
<a name="l00260"></a>00260 <span class="comment">// so OTCredential actually may include many &quot;credentials.&quot;</span>
<a name="l00261"></a>00261 <span class="comment">// A nym has multiple OTCredentials because there may be</span>
<a name="l00262"></a>00262 <span class="comment">// several master keys.</span>
<a name="l00263"></a>00263 <span class="comment">//</span>
<a name="l00264"></a>00264 
<a name="l00265"></a><a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">00265</a> <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; <a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">OTCredential::GetNymID</a>()<span class="keyword"> const</span>
<a name="l00266"></a>00266 <span class="keyword"></span>{
<a name="l00267"></a>00267     <span class="keywordflow">return</span> m_strNymID;
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a><a class="code" href="class_o_t_credential.html#a0f66ddcdf4587eaaa7ab1429126f6395">00271</a> <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; <a class="code" href="class_o_t_credential.html#a0f66ddcdf4587eaaa7ab1429126f6395">OTCredential::GetSourceForNymID</a>()<span class="keyword"> const</span>
<a name="l00272"></a>00272 <span class="keyword"></span>{
<a name="l00273"></a>00273     <span class="keywordflow">return</span> m_strSourceForNymID;
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 
<a name="l00280"></a>00280 <span class="keywordtype">void</span> OTCredential::SetSourceForNymID(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSourceForNymID)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <span class="comment">// --------------------------------------</span>
<a name="l00283"></a>00283     m_strSourceForNymID = strSourceForNymID;
<a name="l00284"></a>00284     <span class="comment">// --------------------------------------</span>
<a name="l00285"></a>00285     <span class="comment">//  Now re-calculate the NymID...</span>
<a name="l00286"></a>00286     <span class="comment">//</span>
<a name="l00287"></a>00287     m_strNymID.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l00288"></a>00288     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTempID;
<a name="l00289"></a>00289     <span class="keyword">const</span> <span class="keywordtype">bool</span> bCalculate = theTempID.<a class="code" href="class_o_t_identifier.html#ac50b356cf5d5d04c08eaf568d07bcc46">CalculateDigest</a>(m_strSourceForNymID);
<a name="l00290"></a>00290     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(bCalculate);
<a name="l00291"></a>00291     theTempID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(m_strNymID);
<a name="l00292"></a>00292     <span class="comment">// ------------------------------</span>
<a name="l00293"></a>00293     m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a5e8d869299c60190a3b984becc4accf2">SetNymIDandSource</a>(m_strNymID, m_strSourceForNymID); <span class="comment">// The key in here must somehow verify against its own source.</span>
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     <span class="comment">// Success! By this point, m_strSourceForNymID and m_strNymID</span>
<a name="l00296"></a>00296     <span class="comment">// are both set.</span>
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="class_o_t_credential.html#ab3e65e4abc6a9f2a04047044682329c2">00300</a> <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; <a class="code" href="class_o_t_credential.html#ab3e65e4abc6a9f2a04047044682329c2">OTCredential::GetPubCredential</a>()<span class="keyword"> const</span>
<a name="l00301"></a>00301 <span class="keyword"></span>{
<a name="l00302"></a>00302     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_subcredential.html#af10db6cd37a86780acbcc0bf1e6101a5">GetPubCredential</a>();
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="class_o_t_credential.html#a50cfd1cc44ddb922b907b33bfcaf6062">00306</a> <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; <a class="code" href="class_o_t_credential.html#a50cfd1cc44ddb922b907b33bfcaf6062">OTCredential::GetPriCredential</a>()<span class="keyword"> const</span>
<a name="l00307"></a>00307 <span class="keyword"></span>{
<a name="l00308"></a>00308     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a7929248bc898a420b3b0be7b388f00f6">GetPriCredential</a>();
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="keywordtype">bool</span> OTCredential::SetPublicContents(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; mapPublic)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a53f8693b23088f568bb52b0bc17e277e">SetPublicContents</a>(mapPublic);
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="keywordtype">bool</span> OTCredential::SetPrivateContents(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; mapPrivate)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a6ddd3ec0531da0115eae195d3e6290d5">SetPrivateContents</a>(mapPrivate);
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">//private</span>
<a name="l00325"></a>00325 OTCredential::OTCredential() :
<a name="l00326"></a>00326     m_Masterkey(*this), m_pImportPassword(NULL)
<a name="l00327"></a>00327 { }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="keywordtype">void</span> OTCredential::SetMasterCredID(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strID)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     m_strMasterCredID = strID;
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">00336</a> <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; <a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">OTCredential::GetMasterCredID</a>()<span class="keyword"> const</span>
<a name="l00337"></a>00337 <span class="keyword"></span>{
<a name="l00338"></a>00338     <span class="keywordflow">return</span> m_strMasterCredID;
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="comment">//static  (Caller is responsible to delete.)</span>
<a name="l00343"></a><a class="code" href="class_o_t_credential.html#aa715e4d86931c981c05dc23a6e99b51c">00343</a> <a class="code" href="class_o_t_credential.html">OTCredential</a> * <a class="code" href="class_o_t_credential.html#aa715e4d86931c981c05dc23a6e99b51c">OTCredential::LoadMaster</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strNymID, <span class="comment">// Caller is responsible to delete, in both CreateMaster and LoadMaster.</span>
<a name="l00344"></a>00344                                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMasterCredID,
<a name="l00345"></a>00345                                         <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     <a class="code" href="class_o_t_credential.html">OTCredential</a> * pCredential = <span class="keyword">new</span> <a class="code" href="class_o_t_credential.html">OTCredential</a>;
<a name="l00348"></a>00348     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCredential&gt;</a> theCredentialAngel(pCredential);
<a name="l00349"></a>00349     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pCredential);
<a name="l00350"></a>00350     <span class="comment">// -------------------------------------</span>
<a name="l00351"></a>00351     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Loading master credential. (static 1.)&quot;</span>);
<a name="l00352"></a>00352     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded = pCredential-&gt;<a class="code" href="class_o_t_credential.html#a1881e78cea7a23e9dfdb61baaf983182">Load_Master</a>(strNymID, strMasterCredID, (NULL == pPWData) ? &amp;thePWData : pPWData);
<a name="l00353"></a>00353     <span class="keywordflow">if</span> (!bLoaded)
<a name="l00354"></a>00354     {
<a name="l00355"></a>00355         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load master credential from local storage. 1\n&quot;</span>, __FUNCTION__);
<a name="l00356"></a>00356         <span class="keywordflow">return</span> NULL;
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <span class="comment">// --------------------------------------------------</span>
<a name="l00359"></a>00359     theCredentialAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// so pCredential doesn&#39;t get cleaned up.</span>
<a name="l00360"></a>00360     <span class="keywordflow">return</span> pCredential;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">//static  (Caller is responsible to delete.)</span>
<a name="l00365"></a><a class="code" href="class_o_t_credential.html#ade0b88fa2ad1963a0619838266a1e18d">00365</a> <a class="code" href="class_o_t_credential.html">OTCredential</a> * <a class="code" href="class_o_t_credential.html#ade0b88fa2ad1963a0619838266a1e18d">OTCredential::LoadMasterFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strInput,
<a name="l00366"></a>00366                                                   <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strNymID, <span class="comment">// Caller is responsible to delete, in both CreateMaster and LoadMaster.</span>
<a name="l00367"></a>00367                                                   <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMasterCredID,
<a name="l00368"></a>00368                                                   <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>,
<a name="l00369"></a>00369                                                   <a class="code" href="class_o_t_password.html">OTPassword</a>     * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371     <a class="code" href="class_o_t_credential.html">OTCredential</a> * pCredential = <span class="keyword">new</span> <a class="code" href="class_o_t_credential.html">OTCredential</a>;
<a name="l00372"></a>00372     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCredential&gt;</a> theCredentialAngel(pCredential);
<a name="l00373"></a>00373     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pCredential);
<a name="l00374"></a>00374     <span class="comment">// -------------------------------------</span>
<a name="l00375"></a>00375     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(NULL == pImportPassword ? <span class="stringliteral">&quot;Enter wallet master passphrase.&quot;</span> : <span class="stringliteral">&quot;Enter passphrase for exported Nym.&quot;</span>);
<a name="l00376"></a>00376     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded = pCredential-&gt;<a class="code" href="class_o_t_credential.html#acdce503f6da5d0f48174c2a067ac3d0b">Load_MasterFromString</a>(strInput, strNymID,
<a name="l00377"></a>00377                                                             strMasterCredID,
<a name="l00378"></a>00378                                                             (NULL == pPWData) ? &amp;thePWData : pPWData,
<a name="l00379"></a>00379                                                             pImportPassword);
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (!bLoaded)
<a name="l00381"></a>00381     {
<a name="l00382"></a>00382         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load master credential from string. 2\n&quot;</span>, __FUNCTION__);
<a name="l00383"></a>00383         <span class="keywordflow">return</span> NULL;
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385     <span class="comment">// --------------------------------------------------</span>
<a name="l00386"></a>00386     theCredentialAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// so pCredential doesn&#39;t get cleaned up.</span>
<a name="l00387"></a>00387     <span class="keywordflow">return</span> pCredential;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">// called by OTCredential::CreateMaster</span>
<a name="l00392"></a>00392 <span class="keywordtype">bool</span> OTCredential::SignNewMaster(<a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Signing new master credential... OTCredential::SignNewMaster&quot;</span>);
<a name="l00395"></a>00395     <span class="comment">// ------------------------------------</span>
<a name="l00396"></a>00396     m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a7efd2d30bc4d2097979a06dbd8e5a828">StoreAsPublic</a>(); <span class="comment">// So the version we create here only contains public keys, not private.</span>
<a name="l00397"></a>00397     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSignedPublic = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(m_Masterkey, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (bSignedPublic)
<a name="l00399"></a>00399     {
<a name="l00400"></a>00400         m_Masterkey.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00401"></a>00401         <span class="comment">// ***********************************************************</span>
<a name="l00402"></a>00402         <span class="comment">// THE OFFICIAL &quot;PUBLIC CREDENTIAL&quot; FOR THE MASTER KEY</span>
<a name="l00403"></a>00403         <span class="comment">// (Copied from the raw contents here into a member variable for safe-keeping.)</span>
<a name="l00404"></a>00404         <span class="comment">// Future verifiers can hash it and the output should match the master credential ID.</span>
<a name="l00405"></a>00405         <span class="comment">//</span>
<a name="l00406"></a>00406         <a class="code" href="class_o_t_string.html">OTString</a> strPublicCredential;
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (m_Masterkey.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPublicCredential))
<a name="l00409"></a>00409         {
<a name="l00410"></a>00410             m_Masterkey.<a class="code" href="class_o_t_subcredential.html#aa5f7cf7445e1c462e63830071ac1b65e">SetContents</a>(strPublicCredential); <span class="comment">// &lt;=== The &quot;master public credential&quot; string.</span>
<a name="l00411"></a>00411             <span class="comment">// ***********************************************************</span>
<a name="l00412"></a>00412             <span class="comment">// NEW MASTER CREDENTIAL ID.</span>
<a name="l00413"></a>00413             <span class="comment">//</span>
<a name="l00414"></a>00414             <span class="comment">// Only now can we calculate the master key&#39;s ID, since the ID is a hash of</span>
<a name="l00415"></a>00415             <span class="comment">// the contents.</span>
<a name="l00416"></a>00416             <span class="comment">//</span>
<a name="l00417"></a>00417             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNewID;
<a name="l00418"></a>00418             m_Masterkey.<a class="code" href="class_o_t_subcredential.html#ae7e05ab952f17d8ea98fee83475eb28c">CalculateContractID</a>(theNewID);
<a name="l00419"></a>00419             m_Masterkey.<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(theNewID); <span class="comment">// Usually this will be set based on an expected value from above, then loaded from storage, and then verified against what was actually loaded (by hashing it.)</span>
<a name="l00420"></a>00420             <span class="comment">// -------------------------------</span>
<a name="l00421"></a>00421             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strMasterCredID(theNewID);
<a name="l00422"></a>00422             this-&gt;SetMasterCredID(strMasterCredID);  <span class="comment">// &lt;=== Master Credential ID is now set.</span>
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424         <span class="keywordflow">else</span>
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed calling m_Masterkey.SaveContractRaw 1.\n&quot;</span>,
<a name="l00427"></a>00427                           __FILE__, __LINE__);
<a name="l00428"></a>00428             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <span class="comment">// **********************************************************</span>
<a name="l00431"></a>00431         <span class="comment">// THE PRIVATE KEYS</span>
<a name="l00432"></a>00432         <span class="comment">//</span>
<a name="l00433"></a>00433         <span class="comment">// Next, we sign / save it again, this time in its private form, and also</span>
<a name="l00434"></a>00434         <span class="comment">// m_Masterkey.m_strContents and m_strIDsOnly will be contained within that</span>
<a name="l00435"></a>00435         <span class="comment">// private form along with the private keys.</span>
<a name="l00436"></a>00436         <span class="comment">//</span>
<a name="l00437"></a>00437         m_Masterkey.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// This time we&#39;ll sign it in private mode.</span>
<a name="l00438"></a>00438         <span class="keyword">const</span> <span class="keywordtype">bool</span> bSignedPrivate = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(m_Masterkey, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (bSignedPrivate)
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441             m_Masterkey.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00442"></a>00442             <span class="comment">// -------------------------------</span>
<a name="l00443"></a>00443             m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a>();
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445         <span class="keywordflow">else</span>
<a name="l00446"></a>00446         {
<a name="l00447"></a>00447             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to sign the master private credential.\n&quot;</span>,
<a name="l00448"></a>00448                           __FILE__, __LINE__);
<a name="l00449"></a>00449             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452     <span class="keywordflow">else</span>
<a name="l00453"></a>00453     {
<a name="l00454"></a>00454         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to sign the master public credential.\n&quot;</span>,
<a name="l00455"></a>00455                       __FILE__, __LINE__);
<a name="l00456"></a>00456         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     <span class="comment">// ------------------------------------</span>
<a name="l00459"></a>00459     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="comment">// When exporting a Nym, you don&#39;t want his private keys encrypted to the cached key</span>
<a name="l00464"></a>00464 <span class="comment">// for the wallet, so you have to load them up, and then pause OTCachedKey, and then</span>
<a name="l00465"></a>00465 <span class="comment">// save them to string again, re-encrypting them to the export passphrase (and not to</span>
<a name="l00466"></a>00466 <span class="comment">// any &quot;master key&quot; from the wallet.) And you have to release all the signatures on</span>
<a name="l00467"></a>00467 <span class="comment">// the private credentials, since the private info is being re-encrypted, and re-sign</span>
<a name="l00468"></a>00468 <span class="comment">// them all. Joy. </span>
<a name="l00469"></a>00469 <span class="comment">//</span>
<a name="l00470"></a><a class="code" href="class_o_t_credential.html#a4aa93a303e599713598c06219ad11469">00470</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a4aa93a303e599713598c06219ad11469">OTCredential::ReEncryptPrivateCredentials</a>(<a class="code" href="class_o_t_password.html">OTPassword</a> &amp; theExportPassword, <span class="keywordtype">bool</span> bImporting)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a314c11e0c372254055c4bc14392846c9">GetPrivateMap</a>().size() &gt; 0)
<a name="l00473"></a>00473     {
<a name="l00474"></a>00474         <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(bImporting ?
<a name="l00475"></a>00475                                  <span class="stringliteral">&quot;2 Enter passphrase for the Nym being imported.&quot;</span> :
<a name="l00476"></a>00476                                  <span class="stringliteral">&quot;2 Enter new passphrase for exported Nym.&quot;</span>);
<a name="l00477"></a>00477         <span class="comment">// -------------------------------</span>
<a name="l00478"></a>00478         <span class="comment">// Re-encrypt the private keys in the masterkey. (THEN sign.)</span>
<a name="l00479"></a>00479         <span class="comment">//</span>
<a name="l00480"></a>00480         <span class="keyword">const</span> <span class="keywordtype">bool</span> bReEncryptMaster = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a1f7f29a88d15b974b8ac583a89a00ba5">ReEncryptKeys</a>(theExportPassword, bImporting);
<a name="l00481"></a>00481               <span class="keywordtype">bool</span> bSignedMaster    = <span class="keyword">false</span>;
<a name="l00482"></a>00482         
<a name="l00483"></a>00483         <span class="keywordflow">if</span> (bReEncryptMaster)
<a name="l00484"></a>00484         {
<a name="l00485"></a>00485             m_Masterkey.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// This time we&#39;ll sign it in private mode.</span>
<a name="l00486"></a>00486             bSignedMaster = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(m_Masterkey, &amp;thePWData);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488         <span class="keywordflow">else</span>
<a name="l00489"></a>00489         {
<a name="l00490"></a>00490             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to re-encrypt the private masterkey.\n&quot;</span>,
<a name="l00491"></a>00491                           __FILE__, __LINE__);
<a name="l00492"></a>00492             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494         <span class="comment">// ---------------------------</span>
<a name="l00495"></a>00495         <span class="keywordflow">if</span> (bSignedMaster)
<a name="l00496"></a>00496         {
<a name="l00497"></a>00497             m_Masterkey.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00498"></a>00498             m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a> (); <span class="comment">// todo: can probably remove this, since it was set based on public info when the key was first created.</span>
<a name="l00499"></a>00499             <span class="comment">// -------------------------------</span>
<a name="l00500"></a>00500             <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l00501"></a>00501             {
<a name="l00502"></a>00502                 <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l00503"></a>00503                       <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l00504"></a>00504                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00505"></a>00505                 <span class="comment">// ------------------------</span>
<a name="l00506"></a>00506                 <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pKey = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l00507"></a>00507                 <span class="keywordflow">if</span> (NULL == pKey) <span class="keywordflow">continue</span>;
<a name="l00508"></a>00508                 <span class="comment">// ------------------------</span>
<a name="l00509"></a>00509                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bReEncryptSubkey = pKey-&gt;<a class="code" href="class_o_t_key_credential.html#a1f7f29a88d15b974b8ac583a89a00ba5">ReEncryptKeys</a>(theExportPassword, bImporting);
<a name="l00510"></a>00510                       <span class="keywordtype">bool</span> bSignedSubkey    = <span class="keyword">false</span>;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512                 <span class="keywordflow">if</span> (bReEncryptSubkey)
<a name="l00513"></a>00513                 {
<a name="l00514"></a>00514                     pKey-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l00515"></a>00515                     bSignedSubkey = pKey-&gt;<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(*pKey, &amp;thePWData);
<a name="l00516"></a>00516                 }
<a name="l00517"></a>00517                 <span class="keywordflow">else</span>
<a name="l00518"></a>00518                 {
<a name="l00519"></a>00519                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to re-encrypt the private subkey.\n&quot;</span>,
<a name="l00520"></a>00520                                   __FILE__, __LINE__);
<a name="l00521"></a>00521                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00522"></a>00522                 }
<a name="l00523"></a>00523                 <span class="comment">// ---------------------</span>
<a name="l00524"></a>00524                 <span class="keywordflow">if</span> (bSignedSubkey)
<a name="l00525"></a>00525                 {
<a name="l00526"></a>00526                     pKey-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00527"></a>00527                     pKey-&gt;<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a> (); <span class="comment">// todo: can probably remove this, since it was set based on public info when the key was first created.</span>
<a name="l00528"></a>00528                 }
<a name="l00529"></a>00529                 <span class="keywordflow">else</span>
<a name="l00530"></a>00530                 {
<a name="l00531"></a>00531                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to re-sign the private subkey.\n&quot;</span>,
<a name="l00532"></a>00532                                   __FILE__, __LINE__);
<a name="l00533"></a>00533                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00534"></a>00534                 }
<a name="l00535"></a>00535             } <span class="comment">// FOR_EACH</span>
<a name="l00536"></a>00536             <span class="comment">// -------------------------------</span>
<a name="l00537"></a>00537             <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// &lt;=== Success.</span>
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539         <span class="keywordflow">else</span>
<a name="l00540"></a>00540             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to re-sign the master private credential.\n&quot;</span>,
<a name="l00541"></a>00541                           __FILE__, __LINE__);
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543     <span class="keywordflow">else</span>
<a name="l00544"></a>00544         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed: There is no private info on this master credential.\n&quot;</span>,
<a name="l00545"></a>00545                       __FILE__, __LINE__);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="keywordtype">bool</span> OTCredential::SignNewSubcredential(<a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> &amp; theSubCred, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theSubCredID_out, <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Signing new subcredential... OTCredential::SignNewSubcredential&quot;</span>);
<a name="l00554"></a>00554     <span class="comment">// ------------------------------------</span>
<a name="l00555"></a>00555     <span class="comment">// First, we store the subcredential itself with its basic info.</span>
<a name="l00556"></a>00556     <span class="comment">// This version is signed with the Masterkey. Then we save a copy of it</span>
<a name="l00557"></a>00557     <span class="comment">// in a member variable for safe-keeping, m_strMasterSigned. Next, we</span>
<a name="l00558"></a>00558     <span class="comment">// save a &quot;public&quot; version of the subcredential (the official version)</span>
<a name="l00559"></a>00559     <span class="comment">// which will include m_strMasterSigned inside it, and be signed by the</span>
<a name="l00560"></a>00560     <span class="comment">// subkey. This version may not need to duplicate all that data, especially</span>
<a name="l00561"></a>00561     <span class="comment">// if we end up just having to verify it twice as a result. So I might have</span>
<a name="l00562"></a>00562     <span class="comment">// the public version be sparse (other than including the master signed version,</span>
<a name="l00563"></a>00563     <span class="comment">// and being signed by the subkey.)</span>
<a name="l00564"></a>00564     <span class="comment">// Though with many subcredentials, there will ONLY be the master-signed version,</span>
<a name="l00565"></a>00565     <span class="comment">// and that WILL be the public version. Only with subkeys will that be different!</span>
<a name="l00566"></a>00566     <span class="comment">//</span>
<a name="l00567"></a>00567     <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pSubkey   = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(&amp;theSubCred);
<a name="l00568"></a>00568     <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsSubkey = (NULL != pSubkey); <span class="comment">// It&#39;s not just any subcredential -- it&#39;s a subkey!</span>
<a name="l00569"></a>00569     <span class="comment">// --------------------------------------------------------------</span>
<a name="l00570"></a>00570     <span class="comment">// If it&#39;s not a subkey, but rather, a normal subcredential with no keys, then it doesn&#39;t need to contain a &quot;master signed&quot; version,</span>
<a name="l00571"></a>00571     <span class="comment">// since the entire subcredential will already be master signed, since there&#39;s no subkey to sign in that case.</span>
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (!bIsSubkey) 
<a name="l00573"></a>00573         theSubCred.<a class="code" href="class_o_t_subcredential.html#ab3e951f8abe688301509d4cd6c8a2e1f">SetMasterSigned</a>(<a class="code" href="class_o_t_string.html">OTString</a>(<span class="stringliteral">&quot;&quot;</span>)); 
<a name="l00574"></a>00574     <span class="comment">// ------------------------</span>
<a name="l00575"></a>00575     <span class="comment">// ELSE It&#39;s a subkey...</span>
<a name="l00576"></a>00576     <span class="keywordflow">else</span> <span class="comment">// Subkeys must be self-signed, and must contain a master-signed version of themselves where the data is actually stored.</span>
<a name="l00577"></a>00577     {
<a name="l00578"></a>00578         <span class="comment">// ***********************************************************</span>
<a name="l00579"></a>00579         pSubkey-&gt;<a class="code" href="class_o_t_subcredential.html#a245c84b95a6223366cf36817b3aeaa90">StoreAsMasterSigned</a>(); <span class="comment">// So the version we create here only contains public keys, not private. (And so it won&#39;t include</span>
<a name="l00580"></a>00580                                         <span class="comment">// the &quot;master signed&quot; version in what it stores, since that&#39;s what we&#39;re creating now.)</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <span class="keyword">const</span> <span class="keywordtype">bool</span> bMasterSigned = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(*pSubkey, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00583"></a>00583         <span class="keywordflow">if</span> (!bMasterSigned)
<a name="l00584"></a>00584         {
<a name="l00585"></a>00585             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed calling m_Masterkey.SignContract(*pSubkey) after StoreAsMasterSigned.\n&quot;</span>,
<a name="l00586"></a>00586                           __FILE__, __LINE__);
<a name="l00587"></a>00587             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589         <span class="keywordflow">else</span>
<a name="l00590"></a>00590         {
<a name="l00591"></a>00591             pSubkey-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00592"></a>00592             <span class="comment">// ------------------------------------</span>
<a name="l00593"></a>00593             <span class="comment">// Make a copy of the &quot;master signed&quot; version of the public subcredential.</span>
<a name="l00594"></a>00594             <span class="comment">//</span>
<a name="l00595"></a>00595             <a class="code" href="class_o_t_string.html">OTString</a> strMasterSigned;
<a name="l00596"></a>00596             
<a name="l00597"></a>00597             <span class="keywordflow">if</span> (pSubkey-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strMasterSigned)) <span class="comment">// &lt;=== The &quot;master signed&quot; version of the &quot;public credential&quot; string. Captured here</span>
<a name="l00598"></a>00598                 pSubkey-&gt;<a class="code" href="class_o_t_subcredential.html#ab3e951f8abe688301509d4cd6c8a2e1f">SetMasterSigned</a>(strMasterSigned); <span class="comment">// so that the (subkey-signed) public version of the subcredential will contain it.</span>
<a name="l00599"></a>00599             <span class="keywordflow">else</span>
<a name="l00600"></a>00600             {
<a name="l00601"></a>00601                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed calling pSubkey-&gt;SaveContractRaw 1.\n&quot;</span>,
<a name="l00602"></a>00602                               __FILE__, __LINE__);
<a name="l00603"></a>00603                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00604"></a>00604             }
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606         <span class="comment">// --------------------------</span>
<a name="l00607"></a>00607         pSubkey-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609     <span class="comment">// ***********************************************************</span>
<a name="l00610"></a>00610     theSubCred.<a class="code" href="class_o_t_subcredential.html#a7efd2d30bc4d2097979a06dbd8e5a828">StoreAsPublic</a>(); <span class="comment">// So the version we create here only contains public keys, not private.</span>
<a name="l00611"></a>00611     
<a name="l00612"></a>00612     <span class="comment">// Here, dynamic cast theSubCred to a subkey and if successful, use it to sign itself.</span>
<a name="l00613"></a>00613     <span class="comment">// Otherwise, sign it with the master. (If it&#39;s a real subkey, then it will contain the</span>
<a name="l00614"></a>00614     <span class="comment">// master-signed version, and it will be signed with itself, its own subkey. Whereas if</span>
<a name="l00615"></a>00615     <span class="comment">// it&#39;s a subcredential that is NOT a subkey, such as a Google Authenticator or some other</span>
<a name="l00616"></a>00616     <span class="comment">// 3rd-party authentication, then it will HAVE no key to sign itself with, since its primary</span>
<a name="l00617"></a>00617     <span class="comment">// purpose in that case is to provide some OTHER authentication info INSTEAD of a key.</span>
<a name="l00618"></a>00618     <span class="comment">// So in that case, it must be signed by the master.)</span>
<a name="l00619"></a>00619     <span class="comment">//</span>
<a name="l00620"></a>00620     <span class="keywordtype">bool</span> bSignedPublic = <span class="keyword">false</span>;
<a name="l00621"></a>00621     
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (bIsSubkey) <span class="comment">// If it&#39;s a subkey, its keys are already generated by the time we got here. So use it to sign its own public version.</span>
<a name="l00623"></a>00623         bSignedPublic = pSubkey-&gt;   SignContract(theSubCred, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00624"></a>00624     <span class="keywordflow">else</span> <span class="comment">// It&#39;s not a subkey, but some other conventional subcredential. So we sign with master key, since that&#39;s all we&#39;ve got.</span>
<a name="l00625"></a>00625         bSignedPublic = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(theSubCred, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00626"></a>00626     <span class="comment">// -----------------</span>
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (!bSignedPublic)
<a name="l00628"></a>00628     {
<a name="l00629"></a>00629         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to sign the public subcredential or subkey.\n&quot;</span>,
<a name="l00630"></a>00630                       __FILE__, __LINE__);
<a name="l00631"></a>00631         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633     <span class="keywordflow">else</span>
<a name="l00634"></a>00634     {
<a name="l00635"></a>00635         theSubCred.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00636"></a>00636         <span class="comment">// ***********************************************************</span>
<a name="l00637"></a>00637         <span class="comment">// THE OFFICIAL &quot;PUBLIC CREDENTIAL STRING&quot; FOR THIS NEW SUB-CREDENTIAL</span>
<a name="l00638"></a>00638         <span class="comment">// Set it aside for safe-keeping as the official contents, hashable to form</span>
<a name="l00639"></a>00639         <span class="comment">// the ID for this sub-credential.</span>
<a name="l00640"></a>00640         <span class="comment">//</span>
<a name="l00641"></a>00641         <a class="code" href="class_o_t_string.html">OTString</a> strPublicCredential;
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (theSubCred.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPublicCredential))
<a name="l00643"></a>00643         {
<a name="l00644"></a>00644             theSubCred.<a class="code" href="class_o_t_subcredential.html#aa5f7cf7445e1c462e63830071ac1b65e">SetContents</a>(strPublicCredential); <span class="comment">// &lt;=== The &quot;public credential&quot; string aka the contents.</span>
<a name="l00645"></a>00645             <span class="comment">// ***********************************************************</span>
<a name="l00646"></a>00646             <span class="comment">// NEW SUB-CREDENTIAL ID.</span>
<a name="l00647"></a>00647             <span class="comment">//</span>
<a name="l00648"></a>00648             <span class="comment">// Only now that the contents have been set, can we calculate the ID, which</span>
<a name="l00649"></a>00649             <span class="comment">// is a hash of those contents. (Credential ID is a hash of GetPubCredential instead</span>
<a name="l00650"></a>00650             <span class="comment">// of m_strRawXML as most contracts would use, since we only want to use the PUBLIC</span>
<a name="l00651"></a>00651             <span class="comment">// info for calculating the ID, not the private info.)</span>
<a name="l00652"></a>00652             <span class="comment">//</span>
<a name="l00653"></a>00653             theSubCred.<a class="code" href="class_o_t_subcredential.html#ae7e05ab952f17d8ea98fee83475eb28c">CalculateContractID</a>(theSubCredID_out);
<a name="l00654"></a>00654             theSubCred.<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(theSubCredID_out);
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656         <span class="keywordflow">else</span>
<a name="l00657"></a>00657         {
<a name="l00658"></a>00658             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed calling theSubCred.SaveContractRaw.\n&quot;</span>,
<a name="l00659"></a>00659                           __FILE__, __LINE__);
<a name="l00660"></a>00660             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         <span class="comment">// **********************************************************</span>
<a name="l00663"></a>00663         <span class="comment">// CREATE THE PRIVATE FORM.</span>
<a name="l00664"></a>00664         <span class="comment">//</span>
<a name="l00665"></a>00665         <span class="comment">// Next, we sign / save it again, this time in its private form, and also</span>
<a name="l00666"></a>00666         <span class="comment">// theSubCred.m_strContents will be contained within that private form,</span>
<a name="l00667"></a>00667         <span class="comment">// along with the private keys.</span>
<a name="l00668"></a>00668         <span class="comment">//</span>
<a name="l00669"></a>00669         theSubCred.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// This time we&#39;ll sign it in private mode.</span>
<a name="l00670"></a>00670         <span class="keywordtype">bool</span> bSignedPrivate = <span class="keyword">false</span>;
<a name="l00671"></a>00671         
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (bIsSubkey) <span class="comment">// If it&#39;s a subkey, its keys are already generated by the time we got here. So use it to sign its own private version.</span>
<a name="l00673"></a>00673             bSignedPrivate = pSubkey-&gt;   SignContract(theSubCred, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00674"></a>00674         <span class="keywordflow">else</span> <span class="comment">// It&#39;s not a subkey, but some other conventional subcredential. So we sign the private info with the master key, since that&#39;s all we&#39;ve got.</span>
<a name="l00675"></a>00675             bSignedPrivate = m_Masterkey.<a class="code" href="class_o_t_key_credential.html#af44f4b8860f575b7b0fdd4cc8e27023a">SignContract</a>(theSubCred, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l00676"></a>00676         
<a name="l00677"></a>00677         <span class="keywordflow">if</span> (bSignedPrivate)
<a name="l00678"></a>00678             theSubCred.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00679"></a>00679         <span class="keywordflow">else</span>
<a name="l00680"></a>00680         {
<a name="l00681"></a>00681             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to sign the private subcredential.\n&quot;</span>,
<a name="l00682"></a>00682                           __FILE__, __LINE__);
<a name="l00683"></a>00683             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686     <span class="comment">// ------------------------------------</span>
<a name="l00687"></a>00687     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="keywordtype">bool</span> OTCredential::GenerateMasterkey(int32_t nBits<span class="comment">/*=1024*/</span>) <span class="comment">// CreateMaster is able to create keys from scratch (by calling this function.)</span>
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#acd27813be407fe1130b501d3b12ede85">GenerateKeys</a>(nBits);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 
<a name="l00697"></a><a class="code" href="class_o_t_credential.html#acdce503f6da5d0f48174c2a067ac3d0b">00697</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#acdce503f6da5d0f48174c2a067ac3d0b">OTCredential::Load_MasterFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strInput,
<a name="l00698"></a>00698                                          <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strNymID,
<a name="l00699"></a>00699                                          <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMasterCredID,
<a name="l00700"></a>00700                                          <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>,
<a name="l00701"></a>00701                                          <a class="code" href="class_o_t_password.html">OTPassword</a>     * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703     m_strNymID          = strNymID;
<a name="l00704"></a>00704     m_strMasterCredID   = strMasterCredID;
<a name="l00705"></a>00705     <span class="comment">// --------------------------------------</span>
<a name="l00706"></a>00706     m_Masterkey.<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(strMasterCredID);
<a name="l00707"></a>00707     <span class="comment">// --------------------------------------</span>
<a name="l00708"></a>00708     <span class="comment">// m_Masterkey and the subkeys all have a pointer to &quot;owner&quot; (who is *this)</span>
<a name="l00709"></a>00709     <span class="comment">// and so I can set pImportPassword onto a member variable, perform the load,</span>
<a name="l00710"></a>00710     <span class="comment">// and then set that member NULL again. During the call to LoadContractFromString,</span>
<a name="l00711"></a>00711     <span class="comment">// m_Masterkey can reference m_pOwner-&gt;GetImportPassword() and if it&#39;s not NULL,</span>
<a name="l00712"></a>00712     <span class="comment">// use it instead of using the wallet&#39;s cached master key. After all, if it&#39;s not</span>
<a name="l00713"></a>00713     <span class="comment">// NULL here, that&#39;s why it was passed in.</span>
<a name="l00714"></a>00714     <span class="comment">//</span>
<a name="l00715"></a>00715     <span class="comment">// --------------------------------------</span>
<a name="l00716"></a>00716     
<a name="l00717"></a>00717     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(pImportPassword); <span class="comment">// might be NULL.</span>
<a name="l00718"></a>00718     
<a name="l00719"></a>00719     <span class="comment">// --------------------------------------</span>
<a name="l00720"></a>00720     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded = m_Masterkey.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strInput);
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (!bLoaded)
<a name="l00722"></a>00722     {
<a name="l00723"></a>00723         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load master credential from string.\n&quot;</span>, __FUNCTION__);
<a name="l00724"></a>00724         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726     <span class="comment">// --------------------------------------</span>
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(NULL); <span class="comment">// It was only set during the m_Masterkey.LoadContractFromString (which references it.)</span>
<a name="l00729"></a>00729     
<a name="l00730"></a>00730     <span class="comment">// --------------------------------------</span>
<a name="l00731"></a>00731     m_strNymID          = m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a7d841c2d684d40d8e028c0a2eaff7b36">GetNymID</a>();
<a name="l00732"></a>00732     m_strSourceForNymID = m_Masterkey.<a class="code" href="class_o_t_subcredential.html#a37c37d5327855eebaa89df0dcc8686a0">GetNymIDSource</a>();
<a name="l00733"></a>00733     <span class="comment">// --------------------------------------</span>
<a name="l00734"></a>00734     this-&gt;<a class="code" href="class_o_t_credential.html#ad3c0bb991b75fbd0e06f91bab725c66c">ClearSubcredentials</a>();  <span class="comment">// The master is loaded first, and then any subcredentials. So this is probably already empty. Just looking ahead.</span>
<a name="l00735"></a>00735     <span class="comment">// --------------------------------------</span>
<a name="l00736"></a>00736     m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a>();
<a name="l00737"></a>00737     <span class="comment">// --------------------------------------------------</span>
<a name="l00738"></a>00738     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 
<a name="l00742"></a><a class="code" href="class_o_t_credential.html#a1881e78cea7a23e9dfdb61baaf983182">00742</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a1881e78cea7a23e9dfdb61baaf983182">OTCredential::Load_Master</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strNymID,
<a name="l00743"></a>00743                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMasterCredID,
<a name="l00744"></a>00744                                <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746     <span class="comment">// --------------------------------------</span>
<a name="l00747"></a>00747     std::string str_Folder = <a class="code" href="class_o_t_folders.html#a4e94eac1e796da34baf00556042202f0">OTFolders::Credential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// Try private credential first. If that fails, then public.</span>
<a name="l00748"></a>00748     <span class="comment">// --------------------------------------</span>
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00750"></a>00750     {
<a name="l00751"></a>00751         str_Folder = <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00752"></a>00752         
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00754"></a>00754         {
<a name="l00755"></a>00755             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Master Credential %s doesn&#39;t exist for Nym %s\n&quot;</span>,
<a name="l00756"></a>00756                           __FUNCTION__, strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00757"></a>00757             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00758"></a>00758         }
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760     <span class="comment">// ----------------------------------------------------</span>
<a name="l00761"></a>00761     <a class="code" href="class_o_t_string.html">OTString</a> strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(str_Folder,
<a name="l00762"></a>00762                                                     strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l00763"></a>00763                                                     strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l00764"></a>00764     <span class="keywordflow">if</span> (!strFileContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00765"></a>00765     {
<a name="l00766"></a>00766         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load master credential from local storage.\n&quot;</span>, __FUNCTION__);
<a name="l00767"></a>00767         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769     <span class="comment">// ---------------------------------------    </span>
<a name="l00770"></a>00770     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strFileContents.<a class="code" href="class_o_t_string.html#a0221820d7a19178ca0c539795b494f8d">DecodeIfArmored</a>()) <span class="comment">// bEscapedIsAllowed=true by default.</span>
<a name="l00771"></a>00771     {
<a name="l00772"></a>00772         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: File contents apparently were encoded and then failed decoding. Contents: \n%s\n&quot;</span>,
<a name="l00773"></a>00773                       __FUNCTION__, strFileContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00774"></a>00774         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776     <span class="comment">// --------------------------------------------------</span>
<a name="l00777"></a>00777     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#acdce503f6da5d0f48174c2a067ac3d0b">Load_MasterFromString</a>(strFileContents, strNymID, strMasterCredID, pPWData);
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 
<a name="l00781"></a><a class="code" href="class_o_t_credential.html#a079090cfac15cf6222665e93a06a576c">00781</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a079090cfac15cf6222665e93a06a576c">OTCredential::LoadSubkeyFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strInput, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSubID, <a class="code" href="class_o_t_password.html">OTPassword</a> * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l00782"></a>00782 {
<a name="l00783"></a>00783     <span class="comment">// Make sure it&#39;s not already there.</span>
<a name="l00784"></a>00784     <span class="comment">//</span>
<a name="l00785"></a>00785     mapOfSubcredentials::iterator it = m_mapSubcredentials.find(strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00786"></a>00786     <span class="keywordflow">if</span> (it != m_mapSubcredentials.end()) <span class="comment">// It was already there. (Reload it.)</span>
<a name="l00787"></a>00787     {
<a name="l00788"></a>00788         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Warning: Deleting and re-loading keyCredential that was already loaded.\n&quot;</span>,
<a name="l00789"></a>00789                       __FUNCTION__);
<a name="l00790"></a>00790         <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = (*it).second;
<a name="l00791"></a>00791         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00792"></a>00792         <span class="keyword">delete</span> pSub;
<a name="l00793"></a>00793         m_mapSubcredentials.erase(it);
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     <span class="comment">// -------------------------------------</span>
<a name="l00796"></a>00796     <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pSub = <span class="keyword">new</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a>(*<span class="keyword">this</span>);
<a name="l00797"></a>00797     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTSubkey&gt;</a> theSubAngel(pSub);
<a name="l00798"></a>00798     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00799"></a>00799     <span class="comment">// ----------------------</span>
<a name="l00800"></a>00800     pSub-&gt;<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(strSubID);
<a name="l00801"></a>00801     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a5e8d869299c60190a3b984becc4accf2">SetNymIDandSource</a>(this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>(), this-&gt;<a class="code" href="class_o_t_credential.html#a0f66ddcdf4587eaaa7ab1429126f6395">GetSourceForNymID</a>()); <span class="comment">// Set NymID and source string that hashes to it.</span>
<a name="l00802"></a>00802     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a910f9ae6d38fcc8683438dfc0288c5b5">SetMasterCredID</a>  (this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>());         <span class="comment">// Set master credential ID (onto this new subcredential...)</span>
<a name="l00803"></a>00803     <span class="comment">// --------------------------------------</span>
<a name="l00804"></a>00804     
<a name="l00805"></a>00805     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(pImportPassword); <span class="comment">// might be NULL.</span>
<a name="l00806"></a>00806 
<a name="l00807"></a>00807     <span class="comment">// --------------------------------------</span>
<a name="l00808"></a>00808     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSub-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strInput))
<a name="l00809"></a>00809     {
<a name="l00810"></a>00810         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load keyCredential from string.\n&quot;</span>, __FUNCTION__);
<a name="l00811"></a>00811         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00812"></a>00812     }
<a name="l00813"></a>00813     <span class="comment">// --------------------------------------</span>
<a name="l00814"></a>00814     
<a name="l00815"></a>00815     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(NULL); <span class="comment">// Only set int64_t enough for LoadContractFromString above to use it.</span>
<a name="l00816"></a>00816     
<a name="l00817"></a>00817     <span class="comment">// --------------------------------------</span>
<a name="l00818"></a>00818     pSub-&gt;<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a>();
<a name="l00819"></a>00819     <span class="comment">// -------------------------------------</span>
<a name="l00820"></a>00820     m_mapSubcredentials.insert(std::pair&lt;std::string, OTSubcredential *&gt;(strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), pSub));
<a name="l00821"></a>00821     theSubAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL);
<a name="l00822"></a>00822     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 
<a name="l00826"></a><a class="code" href="class_o_t_credential.html#ae87844e4f044e39a39170350571eee8e">00826</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#ae87844e4f044e39a39170350571eee8e">OTCredential::LoadSubkey</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSubID)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828     <span class="comment">// --------------------------------------</span>
<a name="l00829"></a>00829     std::string str_Folder = <a class="code" href="class_o_t_folders.html#a4e94eac1e796da34baf00556042202f0">OTFolders::Credential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// Try private credential first. If that fails, then public.</span>
<a name="l00830"></a>00830     <span class="comment">// --------------------------------------</span>
<a name="l00831"></a>00831     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(), strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00832"></a>00832     {
<a name="l00833"></a>00833         str_Folder = <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00834"></a>00834         
<a name="l00835"></a>00835         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(), strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00836"></a>00836         {
<a name="l00837"></a>00837             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Key Credential %s doesn&#39;t exist for Nym %s\n&quot;</span>,
<a name="l00838"></a>00838                           __FUNCTION__, strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00839"></a>00839             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842     <span class="comment">// ----------------------------------------------------    </span>
<a name="l00843"></a>00843     <a class="code" href="class_o_t_string.html">OTString</a> strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(str_Folder,
<a name="l00844"></a>00844                                                     this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(),
<a name="l00845"></a>00845                                                     strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l00846"></a>00846     
<a name="l00847"></a>00847     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strFileContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00848"></a>00848     {
<a name="l00849"></a>00849         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load keyCredential from local storage.\n&quot;</span>, __FUNCTION__);
<a name="l00850"></a>00850         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852     <span class="comment">// ---------------------------------------</span>
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strFileContents.<a class="code" href="class_o_t_string.html#a0221820d7a19178ca0c539795b494f8d">DecodeIfArmored</a>()) <span class="comment">// bEscapedIsAllowed=true by default.</span>
<a name="l00854"></a>00854     {
<a name="l00855"></a>00855         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: File contents apparently were encoded and then failed decoding. Contents: \n%s\n&quot;</span>,
<a name="l00856"></a>00856                       __FUNCTION__, strFileContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00857"></a>00857         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="comment">// --------------------------------------------------</span>
<a name="l00860"></a>00860     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a079090cfac15cf6222665e93a06a576c">LoadSubkeyFromString</a>(strFileContents, strSubID);
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 
<a name="l00864"></a><a class="code" href="class_o_t_credential.html#a6d3d9564e2ee5ebc351bcc853d7cd064">00864</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a6d3d9564e2ee5ebc351bcc853d7cd064">OTCredential::LoadSubcredentialFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strInput, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSubID, <a class="code" href="class_o_t_password.html">OTPassword</a> * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866     <span class="comment">// Make sure it&#39;s not already there.</span>
<a name="l00867"></a>00867     <span class="comment">//</span>
<a name="l00868"></a>00868     mapOfSubcredentials::iterator it = m_mapSubcredentials.find(strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00869"></a>00869     <span class="keywordflow">if</span> (it != m_mapSubcredentials.end()) <span class="comment">// It was already there. (Reload it.)</span>
<a name="l00870"></a>00870     {
<a name="l00871"></a>00871         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Warning: Deleting and re-loading subCredential that was already loaded.\n&quot;</span>, __FUNCTION__);
<a name="l00872"></a>00872         <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = (*it).second;
<a name="l00873"></a>00873         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00874"></a>00874         <span class="keyword">delete</span> pSub;
<a name="l00875"></a>00875         m_mapSubcredentials.erase(it);
<a name="l00876"></a>00876     }
<a name="l00877"></a>00877     <span class="comment">// -------------------------------------</span>
<a name="l00878"></a>00878     <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = <span class="keyword">new</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a>(*<span class="keyword">this</span>);
<a name="l00879"></a>00879     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTSubcredential&gt;</a> theSubAngel(pSub);
<a name="l00880"></a>00880     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00881"></a>00881     <span class="comment">// ----------------------</span>
<a name="l00882"></a>00882     pSub-&gt;<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(strSubID);
<a name="l00883"></a>00883     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a5e8d869299c60190a3b984becc4accf2">SetNymIDandSource</a>(this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>(), this-&gt;<a class="code" href="class_o_t_credential.html#a0f66ddcdf4587eaaa7ab1429126f6395">GetSourceForNymID</a>()); <span class="comment">// Set NymID and source string that hashes to it.</span>
<a name="l00884"></a>00884     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a910f9ae6d38fcc8683438dfc0288c5b5">SetMasterCredID</a>  (this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>());         <span class="comment">// Set master credential ID (onto this new subcredential...)</span>
<a name="l00885"></a>00885     <span class="comment">// --------------------------------------</span>
<a name="l00886"></a>00886     
<a name="l00887"></a>00887     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(pImportPassword); <span class="comment">// might be NULL.</span>
<a name="l00888"></a>00888     
<a name="l00889"></a>00889     <span class="comment">// --------------------------------------</span>
<a name="l00890"></a>00890     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSub-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strInput))
<a name="l00891"></a>00891     {
<a name="l00892"></a>00892         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load subCredential from string.\n&quot;</span>, __FUNCTION__);
<a name="l00893"></a>00893         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895     <span class="comment">// --------------------------------------</span>
<a name="l00896"></a>00896     
<a name="l00897"></a>00897     this-&gt;<a class="code" href="class_o_t_credential.html#a6307046ef1e16d486e19791d0b087dd4">SetImportPassword</a>(NULL); <span class="comment">// This is only set int64_t enough for LoadContractFromString to use it. (Then back to NULL.)</span>
<a name="l00898"></a>00898     
<a name="l00899"></a>00899     <span class="comment">// --------------------------------------</span>
<a name="l00900"></a>00900     m_mapSubcredentials.insert(std::pair&lt;std::string, OTSubcredential *&gt;(strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), pSub));
<a name="l00901"></a>00901     theSubAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL);
<a name="l00902"></a>00902     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 
<a name="l00906"></a><a class="code" href="class_o_t_credential.html#a3cb75790d2053af51f7fb617095c8e72">00906</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a3cb75790d2053af51f7fb617095c8e72">OTCredential::LoadSubcredential</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSubID)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908     <span class="comment">// --------------------------------------</span>
<a name="l00909"></a>00909     std::string str_Folder = <a class="code" href="class_o_t_folders.html#a4e94eac1e796da34baf00556042202f0">OTFolders::Credential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// Try private credential first. If that fails, then public.</span>
<a name="l00910"></a>00910     <span class="comment">// --------------------------------------</span>
<a name="l00911"></a>00911     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(), strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00912"></a>00912     {
<a name="l00913"></a>00913         str_Folder = <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00914"></a>00914         
<a name="l00915"></a>00915         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(str_Folder, this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(), strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l00916"></a>00916         {
<a name="l00917"></a>00917             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Credential %s doesn&#39;t exist for Nym %s\n&quot;</span>,
<a name="l00918"></a>00918                           __FUNCTION__, strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00919"></a>00919             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922     <span class="comment">// ----------------------------------------------------</span>
<a name="l00923"></a>00923     <a class="code" href="class_o_t_string.html">OTString</a> strFileContents(<a class="code" href="namespace_o_t_d_b.html#a921d6f538de00f4e4297c25cf679f00a">OTDB::QueryPlainString</a>(str_Folder,
<a name="l00924"></a>00924                                                     this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>().Get(),
<a name="l00925"></a>00925                                                     strSubID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l00926"></a>00926     <span class="keywordflow">if</span> (!strFileContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00927"></a>00927     {
<a name="l00928"></a>00928         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load subCredential from local storage.\n&quot;</span>, __FUNCTION__);
<a name="l00929"></a>00929         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931     <span class="comment">// ---------------------------------------</span>
<a name="l00932"></a>00932     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strFileContents.<a class="code" href="class_o_t_string.html#a0221820d7a19178ca0c539795b494f8d">DecodeIfArmored</a>()) <span class="comment">// bEscapedIsAllowed=true by default.</span>
<a name="l00933"></a>00933     {
<a name="l00934"></a>00934         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: File contents apparently were encoded and then failed decoding. Contents: \n%s\n&quot;</span>,
<a name="l00935"></a>00935                       __FUNCTION__, strFileContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00936"></a>00936         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00937"></a>00937     }
<a name="l00938"></a>00938     <span class="comment">// --------------------------------------------------</span>
<a name="l00939"></a>00939     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a6d3d9564e2ee5ebc351bcc853d7cd064">LoadSubcredentialFromString</a>(strFileContents, strSubID);
<a name="l00940"></a>00940 }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="comment">// For adding subcredentials that are specifically *subkeys*. Meaning it will</span>
<a name="l00944"></a>00944 <span class="comment">// contain 3 keypairs: signing, authentication, and encryption.</span>
<a name="l00945"></a>00945 <span class="comment">//</span>
<a name="l00946"></a><a class="code" href="class_o_t_credential.html#a15d88cd9c2d96625f7d4f296b08247b7">00946</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a15d88cd9c2d96625f7d4f296b08247b7">OTCredential::AddNewSubkey</a>(<span class="keyword">const</span> int32_t            nBits       <span class="comment">/*=1024*/</span>, <span class="comment">// Ignored unless pmapPrivate is NULL</span>
<a name="l00947"></a>00947                                 <span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> * pmapPrivate <span class="comment">/*=NULL*/</span>, <span class="comment">// Public keys are derived from the private.</span>
<a name="l00948"></a>00948                                     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData     <span class="comment">/*=NULL*/</span>, <span class="comment">// The master key will sign the subkey.</span>
<a name="l00949"></a>00949                                     <a class="code" href="class_o_t_subkey.html">OTSubkey</a>      ** ppSubkey    <span class="comment">/*=NULL*/</span>) <span class="comment">// output</span>
<a name="l00950"></a>00950 {
<a name="l00951"></a>00951     <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pSub = <span class="keyword">new</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a>(*<span class="keyword">this</span>);
<a name="l00952"></a>00952     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l00953"></a>00953     <span class="comment">// ----------------------</span>
<a name="l00954"></a>00954     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a5e8d869299c60190a3b984becc4accf2">SetNymIDandSource</a>(this-&gt;<a class="code" href="class_o_t_credential.html#aba950a82684048857d26afd48b2a555c">GetNymID</a>(), this-&gt;<a class="code" href="class_o_t_credential.html#a0f66ddcdf4587eaaa7ab1429126f6395">GetSourceForNymID</a>()); <span class="comment">// Set NymID and source string that hashes to it.</span>
<a name="l00955"></a>00955     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a910f9ae6d38fcc8683438dfc0288c5b5">SetMasterCredID</a>  (this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>());         <span class="comment">// Set master credential ID (onto this new subcredential...)</span>
<a name="l00956"></a>00956     <span class="comment">// -------------------------------------</span>
<a name="l00957"></a>00957     <span class="comment">// If a map of private certs was not passed in, we&#39;re expected to</span>
<a name="l00958"></a>00958     <span class="comment">// generate the keys ourselves.</span>
<a name="l00959"></a>00959     <span class="comment">//</span>
<a name="l00960"></a>00960     <span class="keywordtype">bool</span> bContentsReady = <span class="keyword">false</span>;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (NULL != pmapPrivate) <span class="comment">// Pre-generated keys were passed in for us to use,</span>
<a name="l00963"></a>00963         bContentsReady = pSub-&gt;<a class="code" href="class_o_t_key_credential.html#a6ddd3ec0531da0115eae195d3e6290d5">SetPrivateContents</a>(*pmapPrivate); <span class="comment">// so let&#39;s set them onto the sub key.</span>
<a name="l00964"></a>00964     <span class="keywordflow">else</span>
<a name="l00965"></a>00965         <span class="comment">// No keys were provided, so let&#39;s generate them ourselves...</span>
<a name="l00966"></a>00966         bContentsReady = pSub-&gt;<a class="code" href="class_o_t_key_credential.html#acd27813be407fe1130b501d3b12ede85">GenerateKeys</a>(nBits);
<a name="l00967"></a>00967     <span class="comment">// -------------------------------------</span>
<a name="l00968"></a>00968     <span class="keywordflow">if</span> (!bContentsReady)
<a name="l00969"></a>00969     {
<a name="l00970"></a>00970         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to SetPrivateContents or GenerateKeys\n&quot;</span>,
<a name="l00971"></a>00971                       __FILE__, __LINE__);
<a name="l00972"></a>00972         <span class="keyword">delete</span> pSub; pSub = NULL;
<a name="l00973"></a>00973         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975     <span class="comment">// -------------------------------------</span>
<a name="l00976"></a>00976     <span class="keywordflow">else</span> <span class="comment">// By this point we&#39;ve set up the subkey with its NymID, the source string for that NymID,</span>
<a name="l00977"></a>00977     {    <span class="comment">// my master credential ID, and the public and private certs for the subkey. Now let&#39;s</span>
<a name="l00978"></a>00978          <span class="comment">// sign it...</span>
<a name="l00979"></a>00979         <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Signing new subkey... OTCredential::AddNewSubkey&quot;</span>);
<a name="l00980"></a>00980         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theSubCredID;
<a name="l00981"></a>00981         
<a name="l00982"></a>00982         <span class="comment">// SignNewSubcredential uses m_Masterkey&#39;s actual signing key to sign &quot;pSub the contract.&quot;</span>
<a name="l00983"></a>00983         <span class="comment">//</span>
<a name="l00984"></a>00984         <span class="keywordflow">if</span> (<span class="keyword">false</span> == this-&gt;SignNewSubcredential(*pSub, theSubCredID, NULL == pPWData ? &amp;thePWData : pPWData))
<a name="l00985"></a>00985         {
<a name="l00986"></a>00986             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to call this-&gt;SignNewSubcredential\n&quot;</span>,
<a name="l00987"></a>00987                           __FILE__, __LINE__);
<a name="l00988"></a>00988             <span class="keyword">delete</span> pSub; pSub = NULL;
<a name="l00989"></a>00989             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00990"></a>00990         }
<a name="l00991"></a>00991         <span class="comment">// ---------------------------------------------</span>
<a name="l00992"></a>00992         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSubCredID(theSubCredID); <span class="comment">// SignNewSubcredential also generates the ID.</span>
<a name="l00993"></a>00993         <span class="comment">// --------------------------------------</span>
<a name="l00994"></a>00994         pSub-&gt;<a class="code" href="class_o_t_key_credential.html#a0fc4da073af06c53280f58ed38291890">SetMetadata</a>();
<a name="l00995"></a>00995         <span class="comment">// -------------------------------------</span>
<a name="l00996"></a>00996         <span class="comment">// ADD IT TO THE MAP</span>
<a name="l00997"></a>00997         <span class="comment">// Only after pSub is signed and saved can we then calculate its ID and use that ID</span>
<a name="l00998"></a>00998         <span class="comment">// as the key in m_mapSubcredentials (with pSub being the value.)</span>
<a name="l00999"></a>00999         <span class="comment">//</span>
<a name="l01000"></a>01000         m_mapSubcredentials.insert(std::pair&lt;std::string, OTSubcredential *&gt;(strSubCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), pSub));
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         <span class="keywordflow">if</span> (NULL != ppSubkey) <span class="comment">// output</span>
<a name="l01003"></a>01003         {
<a name="l01004"></a>01004             *ppSubkey = pSub;
<a name="l01005"></a>01005         }
<a name="l01006"></a>01006         
<a name="l01007"></a>01007         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01008"></a>01008     }
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 <span class="comment">// For adding non-key credentials, such as for 3rd-party authentication.</span>
<a name="l01013"></a>01013 <span class="comment">//</span>
<a name="l01014"></a><a class="code" href="class_o_t_credential.html#a7960b622a6ef62566ef355491d4c95dd">01014</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_credential.html#a7960b622a6ef62566ef355491d4c95dd">OTCredential::AddNewSubcredential</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; mapPrivate,
<a name="l01015"></a>01015                                        <span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; mapPublic,
<a name="l01016"></a>01016                                        <a class="code" href="class_o_t_password_data.html">OTPasswordData</a>  *  pPWData<span class="comment">/*=NULL*/</span>, <span class="comment">// The master key will sign the subcredential.</span>
<a name="l01017"></a>01017                                        <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> ** ppSubcred<span class="comment">/*=NULL*/</span>) <span class="comment">// output</span>
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019     <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = <span class="keyword">new</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a>(*<span class="keyword">this</span>);
<a name="l01020"></a>01020     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01021"></a>01021     <span class="comment">// ----------------------</span>
<a name="l01022"></a>01022     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a5e8d869299c60190a3b984becc4accf2">SetNymIDandSource</a>(m_strNymID, m_strSourceForNymID); <span class="comment">// Set NymID and source string that hashes to it.</span>
<a name="l01023"></a>01023     pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a910f9ae6d38fcc8683438dfc0288c5b5">SetMasterCredID</a>  (this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>());         <span class="comment">// Set master credential ID (onto this new subcredential...)</span>
<a name="l01024"></a>01024     <span class="comment">// -------------------------------------</span>
<a name="l01025"></a>01025     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a0f5e48ea0cb04055746b9f8793359d6c">SetPublicContents</a>(mapPublic))
<a name="l01026"></a>01026     {
<a name="l01027"></a>01027         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed while calling pSub-&gt;SetPublicContents.\n&quot;</span>,
<a name="l01028"></a>01028                       __FILE__, __LINE__);
<a name="l01029"></a>01029         <span class="keyword">delete</span> pSub; pSub = NULL;
<a name="l01030"></a>01030         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032     <span class="comment">// -------------------------------------</span>
<a name="l01033"></a>01033     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a0a93c4d8931e043cc470ccbd153710a5">SetPrivateContents</a>(mapPrivate))
<a name="l01034"></a>01034     {
<a name="l01035"></a>01035         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed while trying to pSub-&gt;SetPrivateContents.\n&quot;</span>,
<a name="l01036"></a>01036                       __FILE__, __LINE__);
<a name="l01037"></a>01037         <span class="keyword">delete</span> pSub; pSub = NULL;
<a name="l01038"></a>01038         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     <span class="comment">// -------------------------------------</span>
<a name="l01041"></a>01041     <span class="keywordflow">else</span> <span class="comment">// By this point we&#39;ve set up the subcredential with its NymID, the source string for that NymID,</span>
<a name="l01042"></a>01042     {    <span class="comment">// my master credential ID, and the public and private contents for the subcredential. Let&#39;s sign</span>
<a name="l01043"></a>01043          <span class="comment">// it...</span>
<a name="l01044"></a>01044         <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Signing new subcredential... OTCredential::AddNewSubcredential&quot;</span>);
<a name="l01045"></a>01045         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theSubCredID;
<a name="l01046"></a>01046         
<a name="l01047"></a>01047         <span class="comment">// SignNewSubcredential uses m_Masterkey&#39;s actual signing key to sign &quot;pSub the contract.&quot;</span>
<a name="l01048"></a>01048         <span class="comment">//</span>
<a name="l01049"></a>01049         <span class="keywordflow">if</span> (<span class="keyword">false</span> == this-&gt;SignNewSubcredential(*pSub, theSubCredID, NULL == pPWData ? &amp;thePWData : pPWData))
<a name="l01050"></a>01050         {
<a name="l01051"></a>01051             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to call this-&gt;SignNewSubcredential\n&quot;</span>,
<a name="l01052"></a>01052                           __FILE__, __LINE__);
<a name="l01053"></a>01053             <span class="keyword">delete</span> pSub; pSub = NULL;
<a name="l01054"></a>01054             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01055"></a>01055         }
<a name="l01056"></a>01056         <span class="comment">// ---------------------------------------------</span>
<a name="l01057"></a>01057         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSubCredID(theSubCredID);
<a name="l01058"></a>01058         <span class="comment">// -------------------------------</span>
<a name="l01059"></a>01059         <span class="comment">// ADD IT TO THE MAP</span>
<a name="l01060"></a>01060         <span class="comment">// Only after pSub is signed and saved can we then calculate its ID and use that ID</span>
<a name="l01061"></a>01061         <span class="comment">// as the key in m_mapSubcredentials (with pSub being the value.)</span>
<a name="l01062"></a>01062         <span class="comment">//</span>
<a name="l01063"></a>01063         m_mapSubcredentials.insert(std::pair&lt;std::string, OTSubcredential *&gt;(strSubCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), pSub));
<a name="l01064"></a>01064         <span class="keywordflow">if</span> (NULL != ppSubcred) <span class="comment">// output</span>
<a name="l01065"></a>01065             *ppSubcred = pSub;
<a name="l01066"></a>01066         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01067"></a>01067     }
<a name="l01068"></a>01068 }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 <span class="comment">// After calling this, you still need to save it to disk (or not.) This function alone</span>
<a name="l01072"></a>01072 <span class="comment">// doesn&#39;t save anything to disk.</span>
<a name="l01073"></a>01073 <span class="comment">//</span>
<a name="l01074"></a>01074 <span class="comment">//static</span>
<a name="l01075"></a><a class="code" href="class_o_t_credential.html#a88ecf1e2caef5a269041ddaebb1c44b3">01075</a> <a class="code" href="class_o_t_credential.html">OTCredential</a> * <a class="code" href="class_o_t_credential.html#a88ecf1e2caef5a269041ddaebb1c44b3">OTCredential::CreateMaster</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strSourceForNymID,
<a name="l01076"></a>01076                                           <span class="keyword">const</span> int32_t            nBits<span class="comment">/*=1024*/</span>,       <span class="comment">// Ignored unless pmapPrivate is NULL.</span>
<a name="l01077"></a>01077                                           <span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> * pmapPrivate<span class="comment">/*=NULL*/</span>, <span class="comment">// If NULL, then the keys are generated in here.</span>
<a name="l01078"></a>01078                                           <span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> * pmapPublic <span class="comment">/*=NULL*/</span>, <span class="comment">// In the case of key credentials, public is optional since it can already be derived from private. But not all credentials are keys...</span>
<a name="l01079"></a>01079                                           <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l01080"></a>01080 {
<a name="l01081"></a>01081     <a class="code" href="class_o_t_credential.html">OTCredential</a> * pCredential = <span class="keyword">new</span> <a class="code" href="class_o_t_credential.html">OTCredential</a>;
<a name="l01082"></a>01082     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pCredential);
<a name="l01083"></a>01083     <span class="comment">// -------------------------------------</span>
<a name="l01084"></a>01084     pCredential-&gt;SetSourceForNymID(strSourceForNymID); <span class="comment">// This also recalculates and sets  ** m_strNymID **</span>
<a name="l01085"></a>01085     <span class="comment">// -------------------------------------</span>
<a name="l01086"></a>01086     <span class="comment">// OTKeyCredential::SetPrivateContents will already set the public keys, which is why this argument is optional. But not all credentials are keys, so we must still retain the ability to explicitly set the public info. Even so, in the case of keys, private is below, so it will overwrite this.</span>
<a name="l01087"></a>01087     
<a name="l01088"></a>01088     <span class="keywordflow">if</span> ((NULL != pmapPublic) &amp;&amp;
<a name="l01089"></a>01089         (NULL != pmapPrivate)) <span class="comment">// You cannot pass public info in here unless you also pass private info.</span>
<a name="l01090"></a>01090     {
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pCredential-&gt;SetPublicContents(*pmapPublic))
<a name="l01092"></a>01092         {
<a name="l01093"></a>01093             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to call pCredential-&gt;SetPublicContents\n&quot;</span>,
<a name="l01094"></a>01094                           __FILE__, __LINE__);
<a name="l01095"></a>01095             <span class="keyword">delete</span> pCredential;
<a name="l01096"></a>01096             pCredential = NULL;
<a name="l01097"></a>01097             <span class="keywordflow">return</span> NULL;
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100     <span class="comment">// -------------------------------------</span>
<a name="l01101"></a>01101     <span class="comment">// Private info must be passed in to create a credential. This saves a copy of the map, and for keys also loads the map all up into the OTKeypair objects (in the case of OTKeyCredentials anyway -- not all credentials are keys.)</span>
<a name="l01102"></a>01102     <span class="comment">//</span>
<a name="l01103"></a>01103     <span class="keywordtype">bool</span> bContentsReady = <span class="keyword">false</span>;
<a name="l01104"></a>01104     
<a name="l01105"></a>01105     <span class="keywordflow">if</span> (NULL != pmapPrivate) <span class="comment">// Pre-generated keys were passed in for us to use.</span>
<a name="l01106"></a>01106         bContentsReady = pCredential-&gt;SetPrivateContents(*pmapPrivate); <span class="comment">// So let&#39;s set them onto the master key.</span>
<a name="l01107"></a>01107     <span class="keywordflow">else</span>
<a name="l01108"></a>01108         <span class="comment">// No keys were provided, so let&#39;s generate them ourselves...</span>
<a name="l01109"></a>01109         bContentsReady = pCredential-&gt;GenerateMasterkey(nBits);
<a name="l01110"></a>01110     <span class="comment">// -------------------------------------</span>
<a name="l01111"></a>01111     <span class="keywordflow">if</span> (!bContentsReady)
<a name="l01112"></a>01112     {
<a name="l01113"></a>01113         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to SetPrivateContents or GenerateMasterkey\n&quot;</span>,
<a name="l01114"></a>01114                       __FILE__, __LINE__);
<a name="l01115"></a>01115         <span class="keyword">delete</span> pCredential;
<a name="l01116"></a>01116         pCredential = NULL;
<a name="l01117"></a>01117         <span class="keywordflow">return</span> NULL;
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119     <span class="keywordflow">else</span>
<a name="l01120"></a>01120     {
<a name="l01121"></a>01121         <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Signing new master credential... OTCredential::CreateMaster&quot;</span>);
<a name="l01122"></a>01122         
<a name="l01123"></a>01123         <span class="comment">// Using m_Masterkey&#39;s actual signing key to sign &quot;m_Masterkey the contract.&quot;</span>
<a name="l01124"></a>01124         <span class="comment">//</span>
<a name="l01125"></a>01125         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pCredential-&gt;SignNewMaster(NULL == pPWData ? &amp;thePWData : pPWData))
<a name="l01126"></a>01126         {
<a name="l01127"></a>01127             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;In %s, line %d: Failed trying to call pCredential-&gt;SignNewMaster\n&quot;</span>,
<a name="l01128"></a>01128                           __FILE__, __LINE__);
<a name="l01129"></a>01129             <span class="keyword">delete</span> pCredential;
<a name="l01130"></a>01130             pCredential = NULL;
<a name="l01131"></a>01131             <span class="keywordflow">return</span> NULL;
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134     
<a name="l01135"></a>01135     <span class="comment">// By this point, we have instantiated a new OTCredential, set the source string, hashed that</span>
<a name="l01136"></a>01136     <span class="comment">// source string to get the NymID for this credential, and set the public and private info for</span>
<a name="l01137"></a>01137     <span class="comment">// this credential (each a map of strings.) Since pCredential-&gt;m_Masterkey is derived from</span>
<a name="l01138"></a>01138     <span class="comment">// OTKeyCredential, it also loaded up the 3 keypairs (authentication, encryption, and signing.)</span>
<a name="l01139"></a>01139     <span class="comment">// Then we signed that master key with itself, with its signing key. (It&#39;s also an OTContract,</span>
<a name="l01140"></a>01140     <span class="comment">// so it can be signed.) This also calculated the new master credential ID, and called</span>
<a name="l01141"></a>01141     <span class="comment">// pCredential-&gt;SetMasterCredID. That is, the OTCredential&#39;s &quot;master credential ID&quot; is formed</span>
<a name="l01142"></a>01142     <span class="comment">// as a hash of the signed contract that is its OTMasterkey.</span>
<a name="l01143"></a>01143     <span class="comment">// BUT!!! We don&#39;t want to use a hash of the private key information, since others cannot verify</span>
<a name="l01144"></a>01144     <span class="comment">// the hash without seeing our private key. We want OTMasterkey to create an &#39;official&#39; signed</span>
<a name="l01145"></a>01145     <span class="comment">// public version of itself, minus private keys, which is what can be sent to servers and to</span>
<a name="l01146"></a>01146     <span class="comment">// other users, and which can be hashed to form the master credential ID (and verified later.)</span>
<a name="l01147"></a>01147     <span class="comment">// ...Which is exactly what it does. Inside pCredential-&gt;SignNewMaster, a public version is created</span>
<a name="l01148"></a>01148     <span class="comment">// and signed, and set onto that masterkey as m_strContents. It&#39;s then re-signed as the private</span>
<a name="l01149"></a>01149     <span class="comment">// version, which contains m_strContents in encoded form, along with the private keys.</span>
<a name="l01150"></a>01150     <span class="comment">//</span>
<a name="l01151"></a>01151     <span class="keywordflow">return</span> pCredential;
<a name="l01152"></a>01152 }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 
<a name="l01155"></a><a class="code" href="class_o_t_credential.html#a03f9d76360128e0985ce9ab8fc3e9fc4">01155</a> <span class="keywordtype">size_t</span> <a class="code" href="class_o_t_credential.html#a03f9d76360128e0985ce9ab8fc3e9fc4">OTCredential::GetSubcredentialCount</a>()<span class="keyword"> const</span>
<a name="l01156"></a>01156 <span class="keyword"></span>{
<a name="l01157"></a>01157     <span class="keywordflow">return</span> m_mapSubcredentials.size();
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 
<a name="l01161"></a><a class="code" href="class_o_t_credential.html#a194a0401b7e78a94f298897138004e3e">01161</a> <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * <a class="code" href="class_o_t_credential.html#a194a0401b7e78a94f298897138004e3e">OTCredential::GetSubcredential</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strSubID, <span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01162"></a>01162 <span class="keyword"></span>{
<a name="l01163"></a>01163     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165         <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01166"></a>01166         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01167"></a>01167         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01168"></a>01168         <span class="comment">// ------------------------</span>
<a name="l01169"></a>01169         <span class="comment">// See if pSub, with ID str_cred_id, is on plistRevokedIDs...</span>
<a name="l01170"></a>01170         <span class="comment">//</span>
<a name="l01171"></a>01171         <span class="keywordflow">if</span> (NULL != plistRevokedIDs)
<a name="l01172"></a>01172         {
<a name="l01173"></a>01173             listOfStrings::const_iterator iter = std::find(plistRevokedIDs-&gt;begin(), plistRevokedIDs-&gt;end(), str_cred_id);
<a name="l01174"></a>01174             <span class="keywordflow">if</span> (iter != plistRevokedIDs-&gt;end()) <span class="comment">// It was on the revoked list.</span>
<a name="l01175"></a>01175                 <span class="keywordflow">continue</span>; <span class="comment">// Skip this revoked credential.</span>
<a name="l01176"></a>01176         }
<a name="l01177"></a>01177         <span class="comment">// At this point we know it&#39;s not on the revoked list, if one was passed in.</span>
<a name="l01178"></a>01178         <span class="comment">// --------------------------------------------------</span>
<a name="l01179"></a>01179         <span class="keywordflow">if</span> (strSubID.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(str_cred_id.c_str()))
<a name="l01180"></a>01180             <span class="keywordflow">return</span> pSub;
<a name="l01181"></a>01181     }
<a name="l01182"></a>01182     <span class="keywordflow">return</span> NULL;
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185 
<a name="l01186"></a><a class="code" href="class_o_t_credential.html#a994302077b2c1b26cb530f2916dba7af">01186</a> <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * <a class="code" href="class_o_t_credential.html#a994302077b2c1b26cb530f2916dba7af">OTCredential::GetSubcredentialByIndex</a>(int32_t nIndex)<span class="keyword"> const</span>
<a name="l01187"></a>01187 <span class="keyword"></span>{
<a name="l01188"></a>01188     <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= static_cast&lt;int64_t&gt;(m_mapSubcredentials.size())))
<a name="l01189"></a>01189     {
<a name="l01190"></a>01190         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Index out of bounds: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192     <span class="keywordflow">else</span>
<a name="l01193"></a>01193     {
<a name="l01194"></a>01194         int32_t nLoopIndex = -1;
<a name="l01195"></a>01195         
<a name="l01196"></a>01196         <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01197"></a>01197         {
<a name="l01198"></a>01198             <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01199"></a>01199             <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01200"></a>01200             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01201"></a>01201             <span class="comment">// ------------------------</span>
<a name="l01202"></a>01202             ++nLoopIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01203"></a>01203             <span class="comment">// ------------------------</span>
<a name="l01204"></a>01204             <span class="keywordflow">if</span> (nIndex == nLoopIndex)
<a name="l01205"></a>01205                 <span class="keywordflow">return</span> pSub;
<a name="l01206"></a>01206         }
<a name="l01207"></a>01207     }
<a name="l01208"></a>01208     <span class="comment">// -------------------------</span>
<a name="l01209"></a>01209     <span class="keywordflow">return</span> NULL;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a><a class="code" href="class_o_t_credential.html#a9767fa303af5c9a9e9a742d9f72ef834">01213</a> <span class="keyword">const</span> std::string <a class="code" href="class_o_t_credential.html#a9767fa303af5c9a9e9a742d9f72ef834">OTCredential::GetSubcredentialIDByIndex</a>(<span class="keywordtype">size_t</span> nIndex)<span class="keyword"> const</span>
<a name="l01214"></a>01214 <span class="keyword"></span>{
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (nIndex &gt;= m_mapSubcredentials.size())
<a name="l01216"></a>01216     {
<a name="l01217"></a>01217         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Index out of bounds: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01218"></a>01218     }
<a name="l01219"></a>01219     <span class="keywordflow">else</span>
<a name="l01220"></a>01220     {
<a name="l01221"></a>01221         int32_t nLoopIndex = -1;
<a name="l01222"></a>01222         
<a name="l01223"></a>01223         <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01224"></a>01224         {
<a name="l01225"></a>01225             <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01226"></a>01226             <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01227"></a>01227             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01228"></a>01228             <span class="comment">// ------------------------</span>
<a name="l01229"></a>01229             ++nLoopIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01230"></a>01230             <span class="comment">// ------------------------</span>
<a name="l01231"></a>01231             <span class="keywordflow">if</span> (static_cast&lt;int64_t&gt;(nIndex) == nLoopIndex)
<a name="l01232"></a>01232                 <span class="keywordflow">return</span> str_cred_id;
<a name="l01233"></a>01233         }
<a name="l01234"></a>01234     }
<a name="l01235"></a>01235     <span class="comment">// -------------------------</span>
<a name="l01236"></a>01236     <span class="keywordflow">return</span> NULL;
<a name="l01237"></a>01237 }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 
<a name="l01240"></a><a class="code" href="class_o_t_credential.html#a7de471713c67f17cf6da6d7bbfbf803a">01240</a> <span class="keyword">const</span> <a class="code" href="class_o_t_keypair.html">OTKeypair</a> &amp; <a class="code" href="class_o_t_credential.html#a7de471713c67f17cf6da6d7bbfbf803a">OTCredential::GetAuthKeypair</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01241"></a>01241 <span class="keyword"></span>{
<a name="l01242"></a>01242     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01243"></a>01243     {
<a name="l01244"></a>01244         <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01245"></a>01245         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01246"></a>01246         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01247"></a>01247         <span class="comment">// ------------------------</span>
<a name="l01248"></a>01248         <span class="keyword">const</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pKey = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l01249"></a>01249         <span class="keywordflow">if</span> (NULL == pKey) <span class="keywordflow">continue</span>;
<a name="l01250"></a>01250         <span class="comment">// ------------------------</span>
<a name="l01251"></a>01251         <span class="comment">// See if pKey, with ID str_cred_id, is on plistRevokedIDs...</span>
<a name="l01252"></a>01252         <span class="comment">//</span>
<a name="l01253"></a>01253         <span class="keywordflow">if</span> (NULL != plistRevokedIDs)
<a name="l01254"></a>01254         {
<a name="l01255"></a>01255             listOfStrings::const_iterator iter = std::find(plistRevokedIDs-&gt;begin(), plistRevokedIDs-&gt;end(), str_cred_id);
<a name="l01256"></a>01256             <span class="keywordflow">if</span> (iter != plistRevokedIDs-&gt;end()) <span class="comment">// It was on the revoked list.</span>
<a name="l01257"></a>01257                 <span class="keywordflow">continue</span>; <span class="comment">// Skip this revoked key.</span>
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259         <span class="comment">// At this point we know it&#39;s a key credential, and we know it&#39;s not on</span>
<a name="l01260"></a>01260         <span class="comment">// the revoked list. Therefore, let&#39;s return the key! (Any other future</span>
<a name="l01261"></a>01261         <span class="comment">// smart criteria might go here before taking this final step...)</span>
<a name="l01262"></a>01262         <span class="comment">//</span>
<a name="l01263"></a>01263         <span class="keywordflow">return</span> pKey-&gt;<a class="code" href="class_o_t_key_credential.html#a01002807ce374cc8b974b9c2be5b2fad">m_AuthentKey</a>;
<a name="l01264"></a>01264     }
<a name="l01265"></a>01265     
<a name="l01266"></a>01266     <span class="comment">// Didn&#39;t find any subcredentials we can use? For now, we&#39;ll return the master key instead.</span>
<a name="l01267"></a>01267     <span class="comment">// This is purely for backwards compatibility reasons and eventually should be removed. That is,</span>
<a name="l01268"></a>01268     <span class="comment">// masters should only be able to verify subkeys, and only subkeys should be able to do actions.</span>
<a name="l01269"></a>01269     <span class="comment">// Capiche?</span>
<a name="l01270"></a>01270     <span class="comment">//</span>
<a name="l01271"></a>01271     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a01002807ce374cc8b974b9c2be5b2fad">m_AuthentKey</a>;
<a name="l01272"></a>01272 }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274 
<a name="l01275"></a><a class="code" href="class_o_t_credential.html#a4b0f3557a99246ba4ddded3a38ab0b1f">01275</a> <span class="keyword">const</span> <a class="code" href="class_o_t_keypair.html">OTKeypair</a> &amp; <a class="code" href="class_o_t_credential.html#a4b0f3557a99246ba4ddded3a38ab0b1f">OTCredential::GetEncrKeypair</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01276"></a>01276 <span class="keyword"></span>{
<a name="l01277"></a>01277     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01278"></a>01278     {
<a name="l01279"></a>01279         <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01280"></a>01280         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01281"></a>01281         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01282"></a>01282         <span class="comment">// ------------------------</span>
<a name="l01283"></a>01283         <span class="keyword">const</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pKey = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l01284"></a>01284         <span class="keywordflow">if</span> (NULL == pKey) <span class="keywordflow">continue</span>;
<a name="l01285"></a>01285         <span class="comment">// ------------------------</span>
<a name="l01286"></a>01286         <span class="comment">// See if pKey, with ID str_cred_id, is on plistRevokedIDs...</span>
<a name="l01287"></a>01287         <span class="comment">//</span>
<a name="l01288"></a>01288         <span class="keywordflow">if</span> (NULL != plistRevokedIDs)
<a name="l01289"></a>01289         {
<a name="l01290"></a>01290             listOfStrings::const_iterator iter = std::find(plistRevokedIDs-&gt;begin(), plistRevokedIDs-&gt;end(), str_cred_id);
<a name="l01291"></a>01291             <span class="keywordflow">if</span> (iter != plistRevokedIDs-&gt;end()) <span class="comment">// It was on the revoked list.</span>
<a name="l01292"></a>01292                 <span class="keywordflow">continue</span>; <span class="comment">// Skip this revoked key.</span>
<a name="l01293"></a>01293         }
<a name="l01294"></a>01294         <span class="comment">// At this point we know it&#39;s a key credential, and we know it&#39;s not on</span>
<a name="l01295"></a>01295         <span class="comment">// the revoked list. Therefore, let&#39;s return the key! (Any other future</span>
<a name="l01296"></a>01296         <span class="comment">// smart criteria might go here before taking this final step...)</span>
<a name="l01297"></a>01297         <span class="comment">//</span>
<a name="l01298"></a>01298         <span class="keywordflow">return</span> pKey-&gt;<a class="code" href="class_o_t_key_credential.html#ac84c9320e8f1cd4add630626c5f44a04">m_EncryptKey</a>;
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300     
<a name="l01301"></a>01301     <span class="comment">// Didn&#39;t find any subcredentials we can use? For now, we&#39;ll return the master key instead.</span>
<a name="l01302"></a>01302     <span class="comment">// This is purely for backwards compatibility reasons and eventually should be removed. That is,</span>
<a name="l01303"></a>01303     <span class="comment">// masters should only be able to verify subkeys, and only subkeys should be able to do actions.</span>
<a name="l01304"></a>01304     <span class="comment">// Capiche?</span>
<a name="l01305"></a>01305     <span class="comment">//</span>
<a name="l01306"></a>01306     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#ac84c9320e8f1cd4add630626c5f44a04">m_EncryptKey</a>;
<a name="l01307"></a>01307 }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309 
<a name="l01310"></a><a class="code" href="class_o_t_credential.html#a016ad221a7fd8ecc7bc130f3e0b576a3">01310</a> <span class="keyword">const</span> <a class="code" href="class_o_t_keypair.html">OTKeypair</a> &amp; <a class="code" href="class_o_t_credential.html#a016ad221a7fd8ecc7bc130f3e0b576a3">OTCredential::GetSignKeypair</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01311"></a>01311 <span class="keyword"></span>{
<a name="l01312"></a>01312     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01313"></a>01313     {
<a name="l01314"></a>01314         <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01315"></a>01315         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01316"></a>01316         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01317"></a>01317         <span class="comment">// ------------------------</span>
<a name="l01318"></a>01318         <span class="keyword">const</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pKey = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l01319"></a>01319         <span class="keywordflow">if</span> (NULL == pKey) <span class="keywordflow">continue</span>;
<a name="l01320"></a>01320         <span class="comment">// ------------------------</span>
<a name="l01321"></a>01321         <span class="comment">// See if pKey, with ID str_cred_id, is on plistRevokedIDs...</span>
<a name="l01322"></a>01322         <span class="comment">//</span>
<a name="l01323"></a>01323         <span class="keywordflow">if</span> (NULL != plistRevokedIDs)
<a name="l01324"></a>01324         {
<a name="l01325"></a>01325             listOfStrings::const_iterator iter = std::find(plistRevokedIDs-&gt;begin(), plistRevokedIDs-&gt;end(), str_cred_id);
<a name="l01326"></a>01326             <span class="keywordflow">if</span> (iter != plistRevokedIDs-&gt;end()) <span class="comment">// It was on the revoked list.</span>
<a name="l01327"></a>01327                 <span class="keywordflow">continue</span>; <span class="comment">// Skip this revoked key.</span>
<a name="l01328"></a>01328         }
<a name="l01329"></a>01329         <span class="comment">// At this point we know it&#39;s a key credential, and we know it&#39;s not on</span>
<a name="l01330"></a>01330         <span class="comment">// the revoked list. Therefore, let&#39;s return the key! (Any other future</span>
<a name="l01331"></a>01331         <span class="comment">// smart criteria might go here before taking this final step...)</span>
<a name="l01332"></a>01332         <span class="comment">//</span>
<a name="l01333"></a>01333         <span class="keywordflow">return</span> pKey-&gt;<a class="code" href="class_o_t_key_credential.html#a3c92bcfa894923996931488cb960e6ad">m_SigningKey</a>;
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335     
<a name="l01336"></a>01336     <span class="comment">// Didn&#39;t find any subcredentials we can use? For now, we&#39;ll return the master key instead.</span>
<a name="l01337"></a>01337     <span class="comment">// This is purely for backwards compatibility reasons and eventually should be removed. That is,</span>
<a name="l01338"></a>01338     <span class="comment">// masters should only be able to verify subkeys, and only subkeys should be able to do actions.</span>
<a name="l01339"></a>01339     <span class="comment">// Capiche?</span>
<a name="l01340"></a>01340     <span class="comment">//</span>
<a name="l01341"></a>01341     <span class="keywordflow">return</span> m_Masterkey.<a class="code" href="class_o_t_key_credential.html#a3c92bcfa894923996931488cb960e6ad">m_SigningKey</a>;
<a name="l01342"></a>01342 }
<a name="l01343"></a>01343 
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 <span class="comment">// NOTE: Until we figure out the rule by which we decide WHICH authentication key is the right auth key,</span>
<a name="l01346"></a>01346 <span class="comment">// or WHICH signing key is the right signing key, we&#39;ll just go with the first one we find.</span>
<a name="l01347"></a>01347 <span class="comment">// We&#39;ll also weed out any that appear on plistRevokedIDs, if it&#39;s passed in. (Optional.)</span>
<a name="l01348"></a>01348 
<a name="l01349"></a><a class="code" href="class_o_t_credential.html#aaf58f8fa8471ec0d45330c7bdd1ee732">01349</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#aaf58f8fa8471ec0d45330c7bdd1ee732">OTCredential::GetPublicAuthKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01350"></a>01350 <span class="keyword"></span>{
<a name="l01351"></a>01351     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a7de471713c67f17cf6da6d7bbfbf803a">GetAuthKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#a67aebd0a39826bbc429bb2676fde9fcd">GetPublicKey</a>();
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 
<a name="l01355"></a><a class="code" href="class_o_t_credential.html#a52ae29ffb6801d439fe0aec5497f7f13">01355</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#a52ae29ffb6801d439fe0aec5497f7f13">OTCredential::GetPublicEncrKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01356"></a>01356 <span class="keyword"></span>{
<a name="l01357"></a>01357     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a4b0f3557a99246ba4ddded3a38ab0b1f">GetEncrKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#a67aebd0a39826bbc429bb2676fde9fcd">GetPublicKey</a>();
<a name="l01358"></a>01358 }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="class_o_t_credential.html#ab48f10080c9aebc115d545692b97e6ae">01361</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#ab48f10080c9aebc115d545692b97e6ae">OTCredential::GetPublicSignKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01362"></a>01362 <span class="keyword"></span>{
<a name="l01363"></a>01363     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a016ad221a7fd8ecc7bc130f3e0b576a3">GetSignKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#a67aebd0a39826bbc429bb2676fde9fcd">GetPublicKey</a>();
<a name="l01364"></a>01364 }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366 
<a name="l01367"></a><a class="code" href="class_o_t_credential.html#a9e945359c5f333cf0a4915c2c3258453">01367</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#a9e945359c5f333cf0a4915c2c3258453">OTCredential::GetPrivateAuthKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01368"></a>01368 <span class="keyword"></span>{
<a name="l01369"></a>01369     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a7de471713c67f17cf6da6d7bbfbf803a">GetAuthKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#af81de69986e6aa2404fce47311871902">GetPrivateKey</a>();
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 
<a name="l01373"></a><a class="code" href="class_o_t_credential.html#af9740dc82f94561f391eecd8d9029e93">01373</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#af9740dc82f94561f391eecd8d9029e93">OTCredential::GetPrivateEncrKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01374"></a>01374 <span class="keyword"></span>{
<a name="l01375"></a>01375     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a4b0f3557a99246ba4ddded3a38ab0b1f">GetEncrKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#af81de69986e6aa2404fce47311871902">GetPrivateKey</a>();
<a name="l01376"></a>01376 }
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 
<a name="l01379"></a><a class="code" href="class_o_t_credential.html#a87cd1e7f63d71ed30567755816dd7fe9">01379</a> <span class="keyword">const</span> <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp; <a class="code" href="class_o_t_credential.html#a87cd1e7f63d71ed30567755816dd7fe9">OTCredential::GetPrivateSignKey</a>(<span class="keyword">const</span> <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> * plistRevokedIDs<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l01380"></a>01380 <span class="keyword"></span>{
<a name="l01381"></a>01381     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t_credential.html#a016ad221a7fd8ecc7bc130f3e0b576a3">GetSignKeypair</a>(plistRevokedIDs).<a class="code" href="class_o_t_keypair.html#af81de69986e6aa2404fce47311871902">GetPrivateKey</a>();
<a name="l01382"></a>01382 }
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 
<a name="l01385"></a><a class="code" href="class_o_t_credential.html#a6c515bf2df82057c6d1583c3c491aace">01385</a> <a class="code" href="class_o_t_credential.html#a6c515bf2df82057c6d1583c3c491aace">OTCredential::~OTCredential</a>()
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387     this-&gt;<a class="code" href="class_o_t_credential.html#ad3c0bb991b75fbd0e06f91bab725c66c">ClearSubcredentials</a>();
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 
<a name="l01391"></a><a class="code" href="class_o_t_credential.html#ad3c0bb991b75fbd0e06f91bab725c66c">01391</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_credential.html#ad3c0bb991b75fbd0e06f91bab725c66c">OTCredential::ClearSubcredentials</a>()
<a name="l01392"></a>01392 {
<a name="l01393"></a>01393     <span class="comment">// ---------------------------</span>
<a name="l01394"></a>01394     <span class="keywordflow">while</span> (!m_mapSubcredentials.empty())
<a name="l01395"></a>01395     {
<a name="l01396"></a>01396         <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub = m_mapSubcredentials.begin()-&gt;second;
<a name="l01397"></a>01397         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01398"></a>01398         <span class="comment">// -----------</span>
<a name="l01399"></a>01399         <span class="keyword">delete</span> pSub;
<a name="l01400"></a>01400         pSub = NULL;
<a name="l01401"></a>01401         <span class="comment">// -----------</span>
<a name="l01402"></a>01402         m_mapSubcredentials.erase(m_mapSubcredentials.begin());
<a name="l01403"></a>01403     } <span class="comment">// while</span>
<a name="l01404"></a>01404     <span class="comment">// --------------------------- </span>
<a name="l01405"></a>01405 }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 <span class="comment">// listRevokedIDs should contain a list of std::strings for IDs of already-revoked subcredentials.</span>
<a name="l01409"></a>01409 <span class="comment">// That way, SerializeIDs will know whether to mark them as valid while serializing them.</span>
<a name="l01410"></a>01410 <span class="comment">// bShowRevoked allows us to include/exclude the revoked credentials from the output (filter for valid-only.)</span>
<a name="l01411"></a>01411 <span class="comment">// bValid=true means we are saving OTPseudonym::m_mapCredentials. Whereas bValid=false means we&#39;re saving m_mapRevoked.</span>
<a name="l01412"></a>01412 <span class="comment">// pmapPubInfo is optional output, the public info for all the credentials will be placed inside, if a pointer is provided.</span>
<a name="l01413"></a>01413 <span class="comment">//</span>
<a name="l01414"></a><a class="code" href="class_o_t_credential.html#aee02a93fec9ee67aaef7af32709bbcd0">01414</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_credential.html#aee02a93fec9ee67aaef7af32709bbcd0">OTCredential::SerializeIDs</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput, <a class="code" href="_o_t_string_8hpp.html#a82b49c0dbe4e0c6fa6fb33eef957c89d">listOfStrings</a> &amp; listRevokedIDs,
<a name="l01415"></a>01415                                 <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> * pmapPubInfo<span class="comment">/*=NULL*/</span>,
<a name="l01416"></a>01416                                 <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> * pmapPriInfo<span class="comment">/*=NULL*/</span>,
<a name="l01417"></a>01417                                 <span class="keywordtype">bool</span> bShowRevoked<span class="comment">/*=false*/</span>, <span class="keywordtype">bool</span> bValid<span class="comment">/*=true*/</span>)<span class="keyword"> const</span>
<a name="l01418"></a>01418 <span class="keyword"></span>{
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (bValid || bShowRevoked)
<a name="l01420"></a>01420     {
<a name="l01421"></a>01421         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;masterCredential\n&quot;</span>
<a name="l01422"></a>01422                               <span class="stringliteral">&quot; ID=\&quot;%s\&quot;\n&quot;</span>
<a name="l01423"></a>01423                               <span class="stringliteral">&quot; valid=\&quot;%s\&quot;&quot;</span>
<a name="l01424"></a>01424                               <span class="stringliteral">&quot;/&gt;\n\n&quot;</span>,
<a name="l01425"></a>01425                               this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>().Get(),
<a name="l01426"></a>01426                               bValid ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
<a name="l01427"></a>01427         <span class="comment">// ------------------------------------------------</span>
<a name="l01428"></a>01428         <span class="keywordflow">if</span> (NULL != pmapPubInfo) <span class="comment">// optional out-param.</span>
<a name="l01429"></a>01429             pmapPubInfo-&gt;insert(std::pair&lt;std::string, std::string&gt;(this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>().Get(), this-&gt;<a class="code" href="class_o_t_credential.html#ab3e65e4abc6a9f2a04047044682329c2">GetPubCredential</a>().Get()));
<a name="l01430"></a>01430         <span class="comment">// ------------------------------------------------</span>
<a name="l01431"></a>01431         <span class="keywordflow">if</span> (NULL != pmapPriInfo) <span class="comment">// optional out-param.</span>
<a name="l01432"></a>01432             pmapPriInfo-&gt;insert(std::pair&lt;std::string, std::string&gt;(this-&gt;<a class="code" href="class_o_t_credential.html#a1e99eeeb4d701f2ea9b56a1201a57680">GetMasterCredID</a>().Get(), this-&gt;<a class="code" href="class_o_t_credential.html#a50cfd1cc44ddb922b907b33bfcaf6062">GetPriCredential</a>().Get()));
<a name="l01433"></a>01433         <span class="comment">// ------------------------------------------------</span>
<a name="l01434"></a>01434     }
<a name="l01435"></a>01435     <span class="comment">// -------------------------------------</span>
<a name="l01436"></a>01436     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_masterkey_8hpp.html#a54f329968b2bb6ec246c697a93f80159">mapOfSubcredentials</a>, m_mapSubcredentials)
<a name="l01437"></a>01437     {
<a name="l01438"></a>01438         <span class="keyword">const</span> std::string str_cred_id = (*it).first;
<a name="l01439"></a>01439         <span class="keyword">const</span> <a class="code" href="class_o_t_subcredential.html">OTSubcredential</a> * pSub  = (*it).second;
<a name="l01440"></a>01440         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSub);
<a name="l01441"></a>01441         <span class="comment">// -----------------------------</span>
<a name="l01442"></a>01442         <span class="comment">// See if the current subcredential is on the Nym&#39;s list of &quot;revoked&quot; subcredential IDs.</span>
<a name="l01443"></a>01443         <span class="comment">// If so, we&#39;ll skip serializing it here.</span>
<a name="l01444"></a>01444         <span class="comment">//</span>
<a name="l01445"></a>01445         listOfStrings::iterator iter = std::find(listRevokedIDs.begin(), listRevokedIDs.end(), str_cred_id);
<a name="l01446"></a>01446         
<a name="l01447"></a>01447         <span class="comment">// Was it on the &#39;revoked&#39; list?</span>
<a name="l01448"></a>01448         <span class="comment">// If not, then the subcredential isn&#39;t revoked, so it&#39;s still valid.</span>
<a name="l01449"></a>01449         <span class="comment">//</span>
<a name="l01450"></a>01450         <span class="keyword">const</span> <span class="keywordtype">bool</span> bSubcredValid = bValid ? (iter == listRevokedIDs.end()) : <span class="keyword">false</span>;
<a name="l01451"></a>01451         <span class="comment">// -----------------------------</span>
<a name="l01452"></a>01452         <span class="keywordflow">if</span> (bSubcredValid || bShowRevoked)
<a name="l01453"></a>01453         {
<a name="l01454"></a>01454             <span class="keyword">const</span> <a class="code" href="class_o_t_subkey.html">OTSubkey</a> * pSubkey = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_o_t_subkey.html">OTSubkey</a> *<span class="keyword">&gt;</span>(pSub);
<a name="l01455"></a>01455             
<a name="l01456"></a>01456             <span class="keywordflow">if</span> (NULL != pSubkey)
<a name="l01457"></a>01457                 strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;keyCredential\n&quot;</span>
<a name="l01458"></a>01458                                       <span class="stringliteral">&quot; ID=\&quot;%s\&quot;\n&quot;</span>
<a name="l01459"></a>01459                                       <span class="stringliteral">&quot; masterID=\&quot;%s\&quot;\n&quot;</span>
<a name="l01460"></a>01460                                       <span class="stringliteral">&quot; valid=\&quot;%s\&quot;&quot;</span>
<a name="l01461"></a>01461                                       <span class="stringliteral">&quot;/&gt;\n\n&quot;</span>,
<a name="l01462"></a>01462                                       str_cred_id.c_str(),
<a name="l01463"></a>01463                                       pSubkey-&gt;<a class="code" href="class_o_t_subcredential.html#a2a2f3e4e8cd23b764e54e96631b979ab">GetMasterCredID</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l01464"></a>01464                                       bSubcredValid ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
<a name="l01465"></a>01465             <span class="keywordflow">else</span>
<a name="l01466"></a>01466                 strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;subCredential\n&quot;</span>
<a name="l01467"></a>01467                                       <span class="stringliteral">&quot; ID=\&quot;%s\&quot;\n&quot;</span>
<a name="l01468"></a>01468                                       <span class="stringliteral">&quot; masterID=\&quot;%s\&quot;\n&quot;</span>
<a name="l01469"></a>01469                                       <span class="stringliteral">&quot; valid=\&quot;%s\&quot;&quot;</span>
<a name="l01470"></a>01470                                       <span class="stringliteral">&quot;/&gt;\n\n&quot;</span>,
<a name="l01471"></a>01471                                       str_cred_id.c_str(),
<a name="l01472"></a>01472                                       pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a2a2f3e4e8cd23b764e54e96631b979ab">GetMasterCredID</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l01473"></a>01473                                       bSubcredValid ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);
<a name="l01474"></a>01474             <span class="comment">// ------------------------------------------------</span>
<a name="l01475"></a>01475             <span class="keywordflow">if</span> (NULL != pmapPubInfo) <span class="comment">// optional out-param.</span>
<a name="l01476"></a>01476                 pmapPubInfo-&gt;insert(std::pair&lt;std::string, std::string&gt;(str_cred_id.c_str(), pSub-&gt;<a class="code" href="class_o_t_subcredential.html#af10db6cd37a86780acbcc0bf1e6101a5">GetPubCredential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l01477"></a>01477             <span class="comment">// ------------------------------------------------</span>
<a name="l01478"></a>01478             <span class="keywordflow">if</span> (NULL != pmapPriInfo) <span class="comment">// optional out-param.</span>
<a name="l01479"></a>01479                 pmapPriInfo-&gt;insert(std::pair&lt;std::string, std::string&gt;(str_cred_id.c_str(), pSub-&gt;<a class="code" href="class_o_t_subcredential.html#a7929248bc898a420b3b0be7b388f00f6">GetPriCredential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()));
<a name="l01480"></a>01480             <span class="comment">// ------------------------------------------------</span>
<a name="l01481"></a>01481         } <span class="comment">// if (bSubcredValid)</span>
<a name="l01482"></a>01482     } <span class="comment">// FOR_EACH_CONST</span>
<a name="l01483"></a>01483     <span class="comment">// -------------------------------------</span>
<a name="l01484"></a>01484 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_credential_8cpp.html">OTCredential.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:03 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
