<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: OTClientConnection Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_t_client_connection.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">OTClientConnection Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="OTClientConnection" -->
<p><code>#include &lt;<a class="el" href="_o_t_client_connection_8hpp_source.html">OTClientConnection.hpp</a>&gt;</code></p>

<p><a href="class_o_t_client_connection-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a04a9352c33daa2ad6f37c8167e1e74cb">ProcessBuffer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#ae6ae82382ac35a7cae8b5879cd04e8f1">ReadBytesIntoBuffer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a3c964e7241646ff845a55cf2e0e6b163">ProcessMessage</a> (<a class="el" href="unionu__header.html">u_header</a> &amp;theCMD)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a0d6036dabdfb454427a71db7a5d938ea">ProcessType1Cmd</a> (<a class="el" href="unionu__header.html">u_header</a> &amp;theCMD, <a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#abf5a4e050c066cabc8f0b4e53bde2115">ProcessReply</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theReply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a03d4dce45aa7486723e9534724553cf3">OTClientConnection</a> (<a class="el" href="class_o_t_server.html">OTServer</a> &amp;theServer)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#aee4497f494f95c92c89059d8a45ae2c7">~OTClientConnection</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a9653fa0740cd018803d2a005f709ba10">AddToInputList</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_message.html">OTMessage</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a4de216e66d6435318072def25179c46a">GetNextInputMessage</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a79a5a030528dc9fa8a4255482b055990">AddToOutputList</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMessage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_message.html">OTMessage</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#af7c1034a18a64c28edfb0ec20935f980">GetNextOutputMessage</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">SetPublicKey</a> (const <a class="el" href="class_o_t_string.html">OTString</a> &amp;strPublicKey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a5bfc463c915914b988e168a343fffec1">SetPublicKey</a> (const <a class="el" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp;thePublicKey)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_client_connection.html#a06d36fee8a1bad883c343ea688696efc">SealMessageForRecipient</a> (<a class="el" href="class_o_t_message.html">OTMessage</a> &amp;theMsg, <a class="el" href="class_o_t_envelope.html">OTEnvelope</a> &amp;theEnvelope)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_o_t_client_connection_8hpp_source.html#l00181">181</a> of file <a class="el" href="_o_t_client_connection_8hpp_source.html">OTClientConnection.hpp</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a03d4dce45aa7486723e9534724553cf3"></a><!-- doxytag: member="OTClientConnection::OTClientConnection" ref="a03d4dce45aa7486723e9534724553cf3" args="(OTServer &amp;theServer)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_client_connection.html#a03d4dce45aa7486723e9534724553cf3">OTClientConnection::OTClientConnection</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_server.html">OTServer</a> &amp;&#160;</td>
          <td class="paramname"><em>theServer</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00690">690</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">: m_pServer(&amp;theServer), m_pPublicKey(<a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>())
{
    m_bHaveHeader   = <span class="keyword">false</span>;
    m_bFocused      = <span class="keyword">true</span>; <span class="comment">// rpc over http mode</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="aee4497f494f95c92c89059d8a45ae2c7"></a><!-- doxytag: member="OTClientConnection::~OTClientConnection" ref="aee4497f494f95c92c89059d8a45ae2c7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_client_connection.html#aee4497f494f95c92c89059d8a45ae2c7">OTClientConnection::~OTClientConnection</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00697">697</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (NULL != m_pPublicKey)
    {
        <span class="keyword">delete</span> m_pPublicKey;
        m_pPublicKey = NULL;
    }
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a9653fa0740cd018803d2a005f709ba10"></a><!-- doxytag: member="OTClientConnection::AddToInputList" ref="a9653fa0740cd018803d2a005f709ba10" args="(OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a9653fa0740cd018803d2a005f709ba10">OTClientConnection::AddToInputList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00665">665</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    m_listIn.<a class="code" href="class_o_t_message_buffer.html#ab7ed0d229c3d12cdf3c7d29e9a8b9192">Push</a>(theMessage);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a79a5a030528dc9fa8a4255482b055990"></a><!-- doxytag: member="OTClientConnection::AddToOutputList" ref="a79a5a030528dc9fa8a4255482b055990" args="(OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a79a5a030528dc9fa8a4255482b055990">OTClientConnection::AddToOutputList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00676">676</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    m_listOut.<a class="code" href="class_o_t_message_buffer.html#ab7ed0d229c3d12cdf3c7d29e9a8b9192">Push</a>(theMessage);

}
</pre></div>
</div>
</div>
<a class="anchor" id="a4de216e66d6435318072def25179c46a"></a><!-- doxytag: member="OTClientConnection::GetNextInputMessage" ref="a4de216e66d6435318072def25179c46a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_message.html">OTMessage</a> * <a class="el" href="class_o_t_client_connection.html#a4de216e66d6435318072def25179c46a">OTClientConnection::GetNextInputMessage</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00670">670</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;OTClientConnection::GetNextInputMessage: ASSERT: Should not be calling this...&quot;</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="af7c1034a18a64c28edfb0ec20935f980"></a><!-- doxytag: member="OTClientConnection::GetNextOutputMessage" ref="af7c1034a18a64c28edfb0ec20935f980" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_message.html">OTMessage</a> * <a class="el" href="class_o_t_client_connection.html#af7c1034a18a64c28edfb0ec20935f980">OTClientConnection::GetNextOutputMessage</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00683">683</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;OTClientConnection::GetNextOutputMessage: ASSERT: Should not be calling this...&quot;</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a04a9352c33daa2ad6f37c8167e1e74cb"></a><!-- doxytag: member="OTClientConnection::ProcessBuffer" ref="a04a9352c33daa2ad6f37c8167e1e74cb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a04a9352c33daa2ad6f37c8167e1e74cb">OTClientConnection::ProcessBuffer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00241">241</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!m_bHaveHeader)
    {
        int32_t  err = 0, nread = 0;
        <span class="keyword">union </span><a class="code" href="unionu__header.html">u_header</a> theCMD;

        <span class="comment">// clear the header object.</span>
        memset((<span class="keywordtype">void</span> *)theCMD.buf, 0, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>);

        <span class="comment">// Read the header</span>
        <span class="keywordflow">for</span> (nread = 0;  nread &lt; <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>;  nread += err)
        {
<span class="comment">//          err = SFSocketRead(m_pSocket,</span>
<span class="comment">//                             theCMD.buf + nread, OT_CMD_HEADER_SIZE - nread);</span>

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">// 0 is a disconnect. error is error. otherwise err contains bytes read.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            {
                <span class="keywordflow">break</span>;
            }
            <span class="keywordflow">else</span> {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Reading input from socket...\n&quot;</span>);
            }
        }

        <span class="keywordflow">if</span> (nread == OT_CMD_HEADER_SIZE)
        {
            uint32_t lOldSize   = theCMD.fields.size;
            uint32_t lSize      = ntohl(lOldSize); <span class="comment">// think this might be causing some problems... maybe not.</span>
            theCMD.fields.size  = lSize; <span class="comment">// fix the byte order.</span>

            m_CMD           = theCMD;   <span class="comment">// grab a copy of the header</span>
            m_bHaveHeader   = <span class="keyword">true</span>;     <span class="comment">// We need to remember that we are now in &quot;header mode&quot;</span>

            int32_t nChecksum   = theCMD.fields.checksum;

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;\n************************************************************\n===&gt; Reading header from client message.\n&quot;</span>
                    <span class="stringliteral">&quot;First 9 bytes are: %d %d %d %d %d %d %d %d %d.\nSize is: %d...\n&quot;</span>,
                    theCMD.buf[0],theCMD.buf[1],theCMD.buf[2],theCMD.buf[3],theCMD.buf[4],
                    theCMD.buf[5], theCMD.buf[6], theCMD.buf[7], theCMD.buf[8], lSize);

            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;\nCMD HEADER:   CMD TYPE: %d -- CMD NUM: %d\n&quot;</span>
                    <span class="stringliteral">&quot;PAYLOAD SIZE: %d -- CHECKSUM: %d\n&quot;</span>, theCMD.fields.type_id,
                    theCMD.fields.command_id, lSize, nChecksum);

            <a class="code" href="class_o_t_client_connection.html#ae6ae82382ac35a7cae8b5879cd04e8f1">ReadBytesIntoBuffer</a>();

            <span class="comment">// When the server knows for SURE it is receiving a message,</span>
            <span class="comment">// then wait for 1 second to make sure we have the entire payload</span>
            <span class="comment">// at once.</span>
            <span class="comment">// TODO: rewrite socket code so that if a complete command has not yet</span>
            <span class="comment">// come in, to buffer the data and wait until next time around the loop.</span>
            <span class="comment">// Because right now, if you have a partial command, it reads it as an error</span>
            <span class="comment">// and returns, discarding what had already been read. Obviously that will</span>
            <span class="comment">// not work for a real server.</span>
            <span class="comment">// In the meantime, this sleep allows me to do testing by insuring that,</span>
            <span class="comment">// with a second&#39;s wait, the server will have time to read the entire message.</span>
    <span class="comment">//      sleep(1);</span>

    <span class="comment">//      ProcessMessage(theCMD);</span>
        }
    }
    <span class="keywordflow">else</span> {
        <span class="comment">// If we&#39;ve finally read enough into our buffer to process the entire mesage, then process it.</span>
        <span class="keywordflow">if</span> (m_Buffer.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>() &gt;= m_CMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>)
        {
            <a class="code" href="class_o_t_client_connection.html#a3c964e7241646ff845a55cf2e0e6b163">ProcessMessage</a>(m_CMD);
            m_bHaveHeader = <span class="keyword">false</span>;
        } <span class="comment">// otherwise if we haven&#39;t read enough, just read a bit more and wait until next time.</span>
        <span class="keywordflow">else</span>
            <a class="code" href="class_o_t_client_connection.html#ae6ae82382ac35a7cae8b5879cd04e8f1">ReadBytesIntoBuffer</a>();
    }

}
</pre></div>
</div>
</div>
<a class="anchor" id="a3c964e7241646ff845a55cf2e0e6b163"></a><!-- doxytag: member="OTClientConnection::ProcessMessage" ref="a3c964e7241646ff845a55cf2e0e6b163" args="(u_header &amp;theCMD)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a3c964e7241646ff845a55cf2e0e6b163">OTClientConnection::ProcessMessage</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionu__header.html">u_header</a> &amp;&#160;</td>
          <td class="paramname"><em>theCMD</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00371">371</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;

    <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg = NULL;

    <span class="keywordflow">if</span> ( theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a> == <a class="code" href="_o_t_server_connection_8hpp.html#afd0b82ab8c23317807df0f0d0b4f1a65">CMD_TYPE_1</a> )
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Received a Type 1 Command...\n&quot;</span>);

        <span class="keywordflow">if</span>( <a class="code" href="_o_t_data_check_8hpp.html#a3f73adcb6c603c69f3b41833b831a412">IsChecksumValid</a>( theCMD.<a class="code" href="unionu__header.html#ac53aebe696286ddee96a16c2b8a50e26">buf</a>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a> ) )
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Checksum is valid! Processing payload.\n&quot;</span>);

            pMsg = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;

            <span class="keywordflow">if</span> (<a class="code" href="class_o_t_client_connection.html#a0d6036dabdfb454427a71db7a5d938ea">ProcessType1Cmd</a>(theCMD, *pMsg ))
            {
                <a class="code" href="class_o_t_client_connection.html#a9653fa0740cd018803d2a005f709ba10">AddToInputList</a>(*pMsg);
                bSuccess = <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span> {
                <span class="keyword">delete</span> pMsg;
                pMsg = NULL;
            }
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">//gDebugLog.Write(&quot;Invalid checksum - Type 1 Command&quot;);</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Invalid checksum - Type 1 Command, header size: %d\n&quot;</span>, <a class="code" href="_o_t_server_connection_8hpp.html#afaeb50bea942aef8c7952cdab7fcd91d">OT_CMD_HEADER_SIZE</a>);
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">//gDebugLog.Write(&quot;Unknown command type&quot;);</span>
        int32_t nCommandType = theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ad10e9b5d3ffc986b504b3712efe0fd69">type_id</a>;
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Unknown command type: %d\n&quot;</span>, nCommandType);
    }


    <span class="comment">// I added this for error correction. In the event that there are errors,</span>
    <span class="comment">// just clean out whatever is in the pipe and throw it away.</span>
    <span class="comment">// Should probably send an Error message back, as well.</span>
    <span class="keywordflow">if</span> (bSuccess == <span class="keyword">false</span>)
    {
        int32_t  err = 0, nread = 0;

        <span class="keywordflow">for</span>(;;)
        {
<span class="comment">//          err = SFSocketRead(m_pSocket, buffer, sizeJunkData);</span>

            <span class="keywordflow">if</span> (err &gt; 0)
                nread += err;

<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">// 0 means disconnect. error means error. &gt;0 means bytes read.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                <span class="keywordflow">break</span>;
        }

        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Transmission error--%d bytes flushed.\n&quot;</span>, nread);

        <span class="comment">// we are buffering data from the pipe now, so if we flush the pipe, we</span>
        <span class="comment">// should flush the buffer too.</span>
        m_Buffer.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// TODO still need to process the commands and send the replies somewhere...</span>
        <span class="comment">//if (bSuccess = theServer.ProcessUserCommand(theMessage, theReply))</span>
        <span class="comment">//{</span>
    <span class="comment">//      OTLog::vOutput(4, &quot;Successfully processed user command: %s\n&quot;, theMessage.m_strCommand.Get());</span>
<span class="comment">//          ProcessReply(ssl, theReply);</span>
<span class="comment">//      }</span>
<span class="comment">//      else</span>
<span class="comment">//      {</span>
<span class="comment">//          OTLog::vError(&quot;Unable to process user command in XML, or missing payload, in ProcessMessage.\n&quot;);</span>
<span class="comment">//      }</span>
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="abf5a4e050c066cabc8f0b4e53bde2115"></a><!-- doxytag: member="OTClientConnection::ProcessReply" ref="abf5a4e050c066cabc8f0b4e53bde2115" args="(OTMessage &amp;theReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#abf5a4e050c066cabc8f0b4e53bde2115">OTClientConnection::ProcessReply</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theReply</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a0d6036dabdfb454427a71db7a5d938ea"></a><!-- doxytag: member="OTClientConnection::ProcessType1Cmd" ref="a0d6036dabdfb454427a71db7a5d938ea" args="(u_header &amp;theCMD, OTMessage &amp;theMessage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client_connection.html#a0d6036dabdfb454427a71db7a5d938ea">OTClientConnection::ProcessType1Cmd</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionu__header.html">u_header</a> &amp;&#160;</td>
          <td class="paramname"><em>theCMD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMessage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00460">460</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// At this point, the checksum has already validated.</span>
    <span class="comment">// Might as well get the PAYLOAD next.</span>
<span class="comment">//  int32_t  err;</span>
    uint32_t nread, lSize = theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>;

    <span class="comment">// Make sure our byte-order is correct here.</span>
<span class="comment">//  theCMD.fields.size = ntohl(theCMD.fields.size); // I was doing this twice!! This is already done when the header is first read.</span>

    <span class="comment">// setup the buffer we are reading into</span>
    <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
    nread = thePayload.<a class="code" href="class_o_t_payload.html#a6acf2a994ed13798718519547e9431fd">ReadBytesFrom</a>(m_Buffer, lSize);

    <span class="comment">/*</span>
<span class="comment">    // actually read the payload from the socket into the buffer.</span>
<span class="comment">    for (nread = 0;  nread &lt; theCMD.fields.size;  nread += err)</span>
<span class="comment">    {</span>
<span class="comment">        err = SFSocketRead(m_pSocket,</span>
<span class="comment">                           (uint8_t *)thePayload.GetPayloadPointer() + nread,</span>
<span class="comment">                           theCMD.fields.size - nread);</span>
<span class="comment"></span>
<span class="comment">        // if we don&#39;t read anything more, stop reading and move on</span>
<span class="comment">        if (err &lt;= 0)</span>
<span class="comment">            break;</span>
<span class="comment">    }</span>
<span class="comment">    */</span>
    <span class="comment">// TODO fix the buffering so that if a complete command has not yet been received, it saves the other</span>
    <span class="comment">// bytes instead of discarding them.  For now I&#39;ll just sleep for a second to make sure the entire command</span>
    <span class="comment">// was received.</span>
<span class="comment">//  sleep(1);</span>

    <span class="comment">// ------------------------------------------------------------</span>

    <span class="comment">// Try to interpret the command number.</span>
    <span class="comment">// Right now we support signed messages and encrypted envelopes containing</span>
    <span class="comment">// signed messages.</span>
    <span class="keywordflow">switch</span> (theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>) {
        <span class="keywordflow">case</span> <a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a>:
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Received Type 1 CMD 1:\nThere is a signed OTMessage in the payload.\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="_o_t_server_connection_8hpp.html#a6f5c18e3bfe1d71b8e89ea686ce3f287">TYPE_1_CMD_2</a>:
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Received Type 1 CMD 2:\n&quot;</span>
                    <span class="stringliteral">&quot;There is an encrypted OTEnvelope (containing signed OTMessage) in the payload.\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Received unexpected command number %d in OTClientConnection::ProcessType1Cmd\n&quot;</span>,
                    theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>);
            <span class="keywordflow">break</span>;
    }

    <span class="comment">// ------------------------------------------------------------</span>
    <span class="comment">// Hm, that&#39;s weird. It was a 0 size payload message. DoS?</span>
    <span class="keywordflow">if</span> (theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> == 0)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;(The payload was a 0 size.)\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="comment">// Uh-oh, somehow the number of bytes read was less than what we expected...</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nread &lt; theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>)
    {
        <span class="comment">// TODO: Verify that the amount read matched the amount expected</span>
        <span class="comment">// if not, we have a problem that needs to be handled.</span>

        <span class="comment">// Long term solution is to buffer the data as a comes in and just</span>
        <span class="comment">// add it to the buffer.</span>

        <span class="comment">// Then if we don&#39;t have the complete message yet, we just come around next</span>
        <span class="comment">// time some data is read, and we add that to the buffer, THEN we check to see</span>
        <span class="comment">// if there are enough bytes yet read to match the amount expected according to</span>
        <span class="comment">// the header.</span>
        <span class="comment">//</span>
        <span class="comment">// Until I can do that, I&#39;m not yet TRULY asynchronous. TODO: lookup a good buffer class.</span>

        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Number of bytes read did NOT match size in header.\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;Loaded a payload, size: %d\n&quot;</span>, theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a>);

    <span class="comment">// ------------------------------------------------------------</span>

    <span class="comment">// Okay so now we&#39;ve received the expected size from the socket. Let&#39;s transfer it</span>
    <span class="comment">// into an object type that we can manipulate here in code. (Message or Envelope.)</span>

    <span class="comment">// a signed OTMessage</span>
    <span class="keywordflow">if</span> (<a class="code" href="_o_t_server_connection_8hpp.html#a3dca62061d4afff50c04c799ef138bb5">TYPE_1_CMD_1</a> == theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>)
    {
        <span class="keywordflow">if</span> (thePayload.<a class="code" href="class_o_t_payload.html#aa26daa2e7d1d86b88686ecf8431535c5">GetMessagePayload</a>(theMessage))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Successfully retrieved payload message...\n&quot;</span>);

            <span class="keywordflow">if</span> (theMessage.<a class="code" href="class_o_t_contract.html#a89edae048b064a50a255fbfe4f7dcef5">ParseRawFile</a>())
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Successfully parsed payload message.\n&quot;</span>);

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span> {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error parsing message.\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }

        }
        <span class="keywordflow">else</span> {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error retrieving message from payload.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }

    }

    <span class="comment">// A base64-encoded envelope, encrypted, and containing a signed message.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_o_t_server_connection_8hpp.html#a6f5c18e3bfe1d71b8e89ea686ce3f287">TYPE_1_CMD_2</a> == theCMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#ac2f7bc78d1449e64ddde966b91cdfabc">command_id</a>)
    {
        <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
        <span class="keywordflow">if</span> (thePayload.<a class="code" href="class_o_t_payload.html#af2c079778a1809964c6e2f138e4d6819">GetEnvelope</a>(theEnvelope))
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Successfully retrieved envelope from payload...\n&quot;</span>);

            <a class="code" href="class_o_t_string.html">OTString</a> strEnvelopeContents;

            <span class="comment">// Decrypt the Envelope.</span>
            <span class="keywordflow">if</span> (m_pServer &amp;&amp; theEnvelope.<a class="code" href="class_o_t_envelope.html#ae2e8fafc4e508ce5d323c089b71c7e7b">Open</a>(m_pServer-&gt;<a class="code" href="class_o_t_server.html#aaaf31d2353a6821b09453e0e60feee30">GetServerNym</a>(), strEnvelopeContents))
            {
                <span class="comment">// All decrypted, now let&#39;s load the results into an OTMessage.</span>
                <span class="comment">// No need to call theMessage.ParseRawFile() after, since</span>
                <span class="comment">// LoadContractFromString handles it.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (strEnvelopeContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strEnvelopeContents))
                {
                    <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Success loading message out of the envelope contents and parsing it.\n&quot;</span>);
                    <span class="keywordflow">return</span> <span class="keyword">true</span>;
                }
                <span class="keywordflow">else</span>
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading message from envelope contents.\n&quot;</span>);
                    <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to open envelope.\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error retrieving message from payload.\n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
    }

    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae6ae82382ac35a7cae8b5879cd04e8f1"></a><!-- doxytag: member="OTClientConnection::ReadBytesIntoBuffer" ref="ae6ae82382ac35a7cae8b5879cd04e8f1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#ae6ae82382ac35a7cae8b5879cd04e8f1">OTClientConnection::ReadBytesIntoBuffer</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00323">323</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// At this point, the checksum has already validated.</span>
    <span class="comment">// Might as well get the PAYLOAD next.</span>
    int32_t         err = 0;
    uint32_t    nread = 0;

    <span class="keyword">const</span> uint32_t  nBufferSize = 8192; <span class="comment">// todo no hardcoding.</span>
    uint8_t       szBuffer[8300]; <span class="comment">// I made this a little bigger just for safety reasons.</span>

    memset(szBuffer, 0, 8299);  <span class="comment">// just in case.</span>

    <span class="comment">//ultimately we want to read until m_Buffer.GetSize equals m_CMD.fields.size</span>
    <span class="comment">// In this function we&#39;ll read up to that or 8192, whichever is smaller.</span>
    uint32_t    lNumberOfBytesRemaining = m_CMD.<a class="code" href="unionu__header.html#a4ed78ffe0637dc4f4619a60da7d645b2">fields</a>.<a class="code" href="unionu__header.html#a0dcff3a34696e81e8d2cfa69b93995e2">size</a> - m_Buffer.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>();
    uint32_t    nNumberOfBytesToRead    = ((lNumberOfBytesRemaining &gt; nBufferSize) ? nBufferSize : lNumberOfBytesRemaining);

    <span class="comment">// actually read the payload from the socket into the buffer.</span>
    <span class="keywordflow">for</span> (nread = 0;  nread &lt; nNumberOfBytesToRead;  nread += err)
    {
<span class="comment">//      err = SFSocketRead(m_pSocket,</span>
<span class="comment">//                         szBuffer + nread,</span>
<span class="comment">//                         nNumberOfBytesToRead - nread);</span>

        <span class="comment">// if we don&#39;t read anything more, stop reading and move on</span>
<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (0 == err || SOCKET_ERROR == err) <span class="comment">// 0 means disconnect. error means error. &gt;0 means bytes read.</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (err &lt;= 0)
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <span class="keywordflow">break</span>;
    }

    <span class="comment">// If we read anything, up to 4K, we add it to the m_Buffer.</span>
    <span class="comment">// This continues happening until m_Buffer.GetSize() == m_CMD.fields.size</span>
    <span class="comment">// and then other code reads the message from the buffer and processes it.</span>
    <span class="keywordflow">if</span> (nread)
    {
        <a class="code" href="class_o_t_data.html">OTData</a> toAddData(szBuffer, nread);
        m_Buffer += toAddData;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a06d36fee8a1bad883c343ea688696efc"></a><!-- doxytag: member="OTClientConnection::SealMessageForRecipient" ref="a06d36fee8a1bad883c343ea688696efc" args="(OTMessage &amp;theMsg, OTEnvelope &amp;theEnvelope)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_client_connection.html#a06d36fee8a1bad883c343ea688696efc">OTClientConnection::SealMessageForRecipient</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_message.html">OTMessage</a> &amp;&#160;</td>
          <td class="paramname"><em>theMsg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_envelope.html">OTEnvelope</a> &amp;&#160;</td>
          <td class="paramname"><em>theEnvelope</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00646">646</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pPublicKey);

    <span class="keywordflow">if</span> (!(m_pPublicKey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#af46fb386cc409488a67df46bcd8b8571">IsEmpty</a>()) &amp;&amp; m_pPublicKey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#a22a32d97edbacc280fcd45a76bd9cd60">IsPublic</a>())
    {
        <span class="comment">// Save the ready-to-go message into a string.</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strEnvelopeContents(theMsg);

        <span class="comment">// Seal the string up into an encrypted Envelope.</span>
        <span class="keywordflow">if</span> (strEnvelopeContents.Exists())
            <span class="keywordflow">return</span> theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*m_pPublicKey, strEnvelopeContents);
    }
    <span class="keywordflow">else</span>
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClientConnection::SealMessageForRecipient: &quot;</span>
                     <span class="stringliteral">&quot;Unable to seal message, possibly a missing public key. \n&quot;</span>);
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a96fb51c13c8df5b778085027866d4366"></a><!-- doxytag: member="OTClientConnection::SetPublicKey" ref="a96fb51c13c8df5b778085027866d4366" args="(const OTString &amp;strPublicKey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">OTClientConnection::SetPublicKey</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_string.html">OTString</a> &amp;&#160;</td>
          <td class="paramname"><em>strPublicKey</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00620">620</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pPublicKey);

    <span class="comment">// SetPublicKey takes the ascii-encoded text, including bookends, and processes</span>
    <span class="comment">// it into the OTAssymeticKey object. If successful, the OTAssymetricKey is now</span>
    <span class="comment">// fully functional for encrypting and verifying.</span>
    m_pPublicKey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(strPublicKey, <span class="keyword">true</span><span class="comment">/*bEscaped*/</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5bfc463c915914b988e168a343fffec1"></a><!-- doxytag: member="OTClientConnection::SetPublicKey" ref="a5bfc463c915914b988e168a343fffec1" args="(const OTAsymmetricKey &amp;thePublicKey)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_client_connection.html#a96fb51c13c8df5b778085027866d4366">OTClientConnection::SetPublicKey</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> &amp;&#160;</td>
          <td class="paramname"><em>thePublicKey</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_client_connection_8cpp_source.html#l00630">630</a> of file <a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pPublicKey);

    <a class="code" href="class_o_t_string.html">OTString</a> strNymsPublicKey;

    thePublicKey. GetPublicKey(strNymsPublicKey, <span class="keyword">true</span>);
    m_pPublicKey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(strNymsPublicKey, <span class="keyword">true</span><span class="comment">/*bEscaped*/</span>);
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/ots/<a class="el" href="_o_t_client_connection_8hpp_source.html">OTClientConnection.hpp</a></li>
<li>src/ots/<a class="el" href="_o_t_client_connection_8cpp_source.html">OTClientConnection.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_o_t_client_connection.html">OTClientConnection</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:11 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
