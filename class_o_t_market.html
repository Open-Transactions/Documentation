<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: OTMarket Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_t_market.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">OTMarket Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="OTMarket" --><!-- doxytag: inherits="OTContract" -->
<p><code>#include &lt;<a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for OTMarket:</div>
<div class="dyncontent">
 <div class="center">
  <img src="class_o_t_market.png" usemap="#OTMarket_map" alt=""/>
  <map id="OTMarket_map" name="OTMarket_map">
<area href="class_o_t_contract.html" alt="OTContract" shape="rect" coords="0,0,77,24"/>
</map>
 </div></div>

<p><a href="class_o_t_market-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">ValidateOfferForMarket</a> (<a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;theOffer, <a class="el" href="class_o_t_string.html">OTString</a> *pReason=NULL)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_offer.html">OTOffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a61f96f7d546012fd290307d519214088">GetOffer</a> (const int64_t &amp;lTransactionNum)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">AddOffer</a> (<a class="el" href="class_o_t_trade.html">OTTrade</a> *pTrade, <a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;theOffer, bool bSaveFile=true, <a class="el" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket=<a class="el" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a8c35cf47acba612a33c8aad9a96a0945">RemoveOffer</a> (const int64_t &amp;lTransactionNum)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a4b6f10cedaa3a30fa5d7efc8912c71e2">GetOfferList</a> (<a class="el" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp;ascOutput, int64_t lDepth, int32_t &amp;nOfferCount)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a7375c51d4be96bf9d7e6a92f0dc7f18f">GetRecentTradeList</a> (<a class="el" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp;ascOutput, int32_t &amp;nTradeCount)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a5b14418890823e00d07549c513292cd1">GetNym_OfferList</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;NYM_ID, <a class="el" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> &amp;theOutputList, int32_t &amp;nNymOfferCount)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">ProcessTrade</a> (<a class="el" href="class_o_t_trade.html">OTTrade</a> &amp;theTrade, <a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;theOffer, <a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;theOtherOffer)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a0814323a286be01f0b69b2b24b8030f3">ProcessTrade</a> (<a class="el" href="class_o_t_trade.html">OTTrade</a> &amp;theTrade, <a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;theOffer)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">GetHighestBidPrice</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">GetLowestAskPrice</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">mapOfOffers::size_type&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#ae5f15aabe47f37edad46b11c78a5440a">GetBidCount</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">mapOfOffers::size_type&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#af38989995c44f5083df1acc5ab1c3557">GetAskCount</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#aeb7ac47e2db2268fcf1beb57df188494">SetAssetID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;ASSET_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a325c2c8586b616a5176042c039fe1d78">SetCurrencyID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;CURRENCY_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a1eb641ab3d871856e13060433eedaee7">SetServerID</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a> () const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const int64_t &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">SetScale</a> (const int64_t &amp;lScale)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const int64_t &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a4d5f6b5c240b331bc6d2984d5dce4150">GetLastSalePrice</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#affa60f256431d3edec9ba1a5067df405">SetLastSalePrice</a> (const int64_t &amp;lLastSalePrice)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const std::string &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a489ad89157e72903d0d977ace2b25849">GetLastSaleDate</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a2dd9eab76501e15105aca7a8f1ed7acd">GetTotalAvailableAssets</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#acabac79f968b3db2ef9fe05f57f73277">OTMarket</a> (const char *szFilename)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a45d1559b24c78a58b28f05f7626ef126">OTMarket</a> (const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;SERVER_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;ASSET_TYPE_ID, const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;CURRENCY_TYPE_ID, const int64_t &amp;lScale)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#ac1fca3bb237c7c710039fa09156ae3c9">~OTMarket</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">GetIdentifier</a> (<a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;theIdentifier)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#afc579c8a9d0eb969ce4cd302701c7c9d">SetCronPointer</a> (<a class="el" href="class_o_t_cron.html">OTCron</a> &amp;theCron)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_o_t_cron.html">OTCron</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a814b2f38a7ffa5593acbf13698ffef24">LoadMarket</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a052638ef7aebad8f0eaaa148d7e1546f">Release</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">Release_Market</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a3085a94412fee20ffd116dbfdddf2ecc">ProcessXMLNode</a> (<a class="el" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a> *&amp;xml)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#a51c01eeeb4dfd00d941efae50af53384">UpdateContents</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_t_market.html#adf9018b289268d0439d92f4176094392">SaveContractWallet</a> (std::ofstream &amp;ofs)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00159">159</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a03cb3636e127bfd6353ad472b44ea37c"></a><!-- doxytag: member="OTMarket::OTMarket" ref="a03cb3636e127bfd6353ad472b44ea37c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02379">2379</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                   : <a class="code" href="class_o_t_contract.html#aafd1cfb541fe8f7ae09398e46c25ce52">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
{
    m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
    <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="acabac79f968b3db2ef9fe05f57f73277"></a><!-- doxytag: member="OTMarket::OTMarket" ref="acabac79f968b3db2ef9fe05f57f73277" args="(const char *szFilename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>szFilename</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02367">2367</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                          : <a class="code" href="class_o_t_contract.html#aafd1cfb541fe8f7ae09398e46c25ce52">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != szFilename);
    
    m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
    <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
    
    <a class="code" href="class_o_t_contract.html#ab7ab1f1fe7ff7e52f2c126404a8f4f92">m_strFilename</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(szFilename);
    <a class="code" href="class_o_t_contract.html#ab1e11693a38a1673037b1f29c9d84010">m_strFoldername</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get());
}
</pre></div>
</div>
</div>
<a class="anchor" id="a45d1559b24c78a58b28f05f7626ef126"></a><!-- doxytag: member="OTMarket::OTMarket" ref="a45d1559b24c78a58b28f05f7626ef126" args="(const OTIdentifier &amp;SERVER_ID, const OTIdentifier &amp;ASSET_TYPE_ID, const OTIdentifier &amp;CURRENCY_TYPE_ID, const int64_t &amp;lScale)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_market.html#a03cb3636e127bfd6353ad472b44ea37c">OTMarket::OTMarket</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>ASSET_TYPE_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>CURRENCY_TYPE_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lScale</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02386">2386</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                  : 
    <a class="code" href="class_o_t_contract.html#aafd1cfb541fe8f7ae09398e46c25ce52">OTContract</a>(), m_pCron(NULL), m_pTradeList(NULL), m_lScale(1), m_lLastSalePrice(0)
{
    m_pCron = NULL; <span class="comment">// just for convenience, not responsible to delete.</span>
    <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();
    
    m_ASSET_TYPE_ID     = ASSET_TYPE_ID;    
    m_CURRENCY_TYPE_ID  = CURRENCY_TYPE_ID; 
    
    m_SERVER_ID         = SERVER_ID;
    
    <a class="code" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">SetScale</a>(lScale);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac1fca3bb237c7c710039fa09156ae3c9"></a><!-- doxytag: member="OTMarket::~OTMarket" ref="ac1fca3bb237c7c710039fa09156ae3c9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_market.html#ac1fca3bb237c7c710039fa09156ae3c9">OTMarket::~OTMarket</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02402">2402</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">Release_Market</a>();
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a4b79224a7214740015fcc7b1f90fa7e6"></a><!-- doxytag: member="OTMarket::AddOffer" ref="a4b79224a7214740015fcc7b1f90fa7e6" args="(OTTrade *pTrade, OTOffer &amp;theOffer, bool bSaveFile=true, time64_t tDateAddedToMarket=OT_TIME_ZERO)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">OTMarket::AddOffer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_trade.html">OTTrade</a> *&#160;</td>
          <td class="paramname"><em>pTrade</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;&#160;</td>
          <td class="paramname"><em>theOffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>bSaveFile</em> = <code>true</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>&#160;</td>
          <td class="paramname"><em>tDateAddedToMarket</em> = <code><a class="el" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a></code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00740">740</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> int64_t   lTransactionNum = theOffer.<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>(),
                lPriceLimit     = theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
        
    <span class="comment">// Make sure the offer is even appropriate for this market...</span>
    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">ValidateOfferForMarket</a>(theOffer))
    {
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed attempt to add invalid offer to market.\n&quot;</span>);
        
        <span class="keywordflow">if</span> (NULL != pTrade)
            pTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// I store duplicate lists of offer pointers. Two multimaps ordered by price,</span>
        <span class="comment">// (for buyers and sellers) and one map ordered by transaction number.</span>
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <span class="comment">// See if there&#39;s something else already there with the same transaction number.</span>
        <span class="comment">//</span>
        mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
        
        <span class="comment">// If it&#39;s not already on the list, then add it...</span>
        <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
        {
            m_mapOffers[lTransactionNum] = &amp;theOffer;
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as an offer to the market...\n&quot;</span>);
        }
        <span class="comment">// Otherwise, if it was already there, log an error.</span>
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to add Offer to Market with pre-existing transaction number: %lld\n&quot;</span>,
                          lTransactionNum);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <span class="comment">// Okay so we successfully added it to one list (indexed by Transaction Num) and we </span>
        <span class="comment">// know it validated as an offer, AND we know it wasn&#39;t already on the market.</span>
        <span class="comment">//</span>
        <span class="comment">// So next, let&#39;s add it to the lists that are indexed by price:</span>
                
        <span class="comment">// Determine if it&#39;s a buy or sell, and add it to the right list.</span>
        <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>())
        {
            <span class="comment">// No bother checking if the offer is already on this list,</span>
            <span class="comment">// since the code above basically already verifies that for us.</span>
            
            m_mapBids.insert (m_mapBids.lower_bound(lPriceLimit), <span class="comment">// highest bidders go first, so I am last in line at lower bound.</span>
                              std::pair&lt;int64_t, OTOffer *&gt;(lPriceLimit, &amp;theOffer) );
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as a bid to the market.\n&quot;</span>);
        }
        <span class="keywordflow">else</span>            
        {
            m_mapAsks.insert (m_mapAsks.upper_bound(lPriceLimit), <span class="comment">// lowest price sells first, so I am last in line at upper bound.</span>
                              std::pair&lt;int64_t, OTOffer *&gt;(lPriceLimit, &amp;theOffer) );
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer added as an ask to the market.\n&quot;</span>);
        }
        <span class="comment">// ------------------------------------------------------------------------------</span>
        <span class="keywordflow">if</span> (bSaveFile)
        {
            <span class="comment">// Set this to the current date/time, since the offer is</span>
            <span class="comment">// being added for the first time.</span>
            <span class="comment">//</span>
            theOffer.<a class="code" href="class_o_t_offer.html#a46b667663f5a75693ac8d1d5fc445279">SetDateAddedToMarket</a>(<a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>());
            
            <span class="keywordflow">return</span> <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>();  <span class="comment">// &lt;====== SAVE since an offer was added to the Market.</span>
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// Set this to the date passed in, since this offer was</span>
            <span class="comment">// added to the market in the past, and we are preserving that date.</span>
            <span class="comment">//</span>
            theOffer.<a class="code" href="class_o_t_offer.html#a46b667663f5a75693ac8d1d5fc445279">SetDateAddedToMarket</a>(tDateAddedToMarket);

            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
    }
    <span class="comment">// ---------------------</span>
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af38989995c44f5083df1acc5ab1c3557"></a><!-- doxytag: member="OTMarket::GetAskCount" ref="af38989995c44f5083df1acc5ab1c3557" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">mapOfOffers::size_type <a class="el" href="class_o_t_market.html#af38989995c44f5083df1acc5ab1c3557">OTMarket::GetAskCount</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00223">223</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_mapAsks.size(); }
</pre></div>
</div>
</div>
<a class="anchor" id="a0a4e04126fb83f13b1477fccc169c0e9"></a><!-- doxytag: member="OTMarket::GetAssetID" ref="a0a4e04126fb83f13b1477fccc169c0e9" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a>&amp; <a class="el" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">OTMarket::GetAssetID</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00229">229</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_ASSET_TYPE_ID; }
</pre></div>
</div>
</div>
<a class="anchor" id="ae5f15aabe47f37edad46b11c78a5440a"></a><!-- doxytag: member="OTMarket::GetBidCount" ref="ae5f15aabe47f37edad46b11c78a5440a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">mapOfOffers::size_type <a class="el" href="class_o_t_market.html#ae5f15aabe47f37edad46b11c78a5440a">OTMarket::GetBidCount</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00222">222</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_mapBids.size(); }
</pre></div>
</div>
</div>
<a class="anchor" id="a474e0a63bbc87a1cc667584d3645c0cf"></a><!-- doxytag: member="OTMarket::GetCron" ref="a474e0a63bbc87a1cc667584d3645c0cf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_cron.html">OTCron</a>* <a class="el" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">OTMarket::GetCron</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00259">259</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_pCron; }
</pre></div>
</div>
</div>
<a class="anchor" id="aeeac45c32cade4a24d29e7a829304956"></a><!-- doxytag: member="OTMarket::GetCurrencyID" ref="aeeac45c32cade4a24d29e7a829304956" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a>&amp; <a class="el" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">OTMarket::GetCurrencyID</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00230">230</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_CURRENCY_TYPE_ID; }
</pre></div>
</div>
</div>
<a class="anchor" id="af56483f0c0166de3859bdc706c071531"></a><!-- doxytag: member="OTMarket::GetHighestBidPrice" ref="af56483f0c0166de3859bdc706c071531" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int64_t <a class="el" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">OTMarket::GetHighestBidPrice</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00932">932</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    int64_t lPrice = 0;
    
    mapOfOffers::reverse_iterator rr = m_mapBids.rbegin();
    
    <span class="keywordflow">if</span> (rr != m_mapBids.rend())
    {       
        lPrice = (*rr).first;
    }
    
    <span class="keywordflow">return</span> lPrice;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a49db3f80ecfae55769f94e19a5c157b5"></a><!-- doxytag: member="OTMarket::GetIdentifier" ref="a49db3f80ecfae55769f94e19a5c157b5" args="(OTIdentifier &amp;theIdentifier)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">OTMarket::GetIdentifier</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>theIdentifier</em></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">OTContract</a>.</p>

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00914">914</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{   
    <a class="code" href="class_o_t_string.html">OTString</a>    strTemp, strAsset(<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()), strCurrency(<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>());
    
    int64_t     lScale = <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>();
    
    <span class="comment">// In this way we generate a unique ID that will always be consistent</span>
    <span class="comment">// for the same asset ID, currency ID, and market scale.</span>
    strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;ASSET TYPE:\n%s\nCURRENCY TYPE:\n%s\nMARKET SCALE:\n%lld\n&quot;</span>,
                   strAsset.Get(), strCurrency.Get(), lScale);
    
    <a class="code" href="class_o_t_contract.html#ac975866d3511c41d935d2ec44c24c4cb">m_ID</a>.<a class="code" href="class_o_t_identifier.html#ac50b356cf5d5d04c08eaf568d07bcc46">CalculateDigest</a>(strTemp);
    
    <a class="code" href="class_o_t_market.html#a49db3f80ecfae55769f94e19a5c157b5">OTContract::GetIdentifier</a>(theIdentifier);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a489ad89157e72903d0d977ace2b25849"></a><!-- doxytag: member="OTMarket::GetLastSaleDate" ref="a489ad89157e72903d0d977ace2b25849" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const std::string&amp; <a class="el" href="class_o_t_market.html#a489ad89157e72903d0d977ace2b25849">OTMarket::GetLastSaleDate</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00243">243</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_strLastSaleDate; }
</pre></div>
</div>
</div>
<a class="anchor" id="a4d5f6b5c240b331bc6d2984d5dce4150"></a><!-- doxytag: member="OTMarket::GetLastSalePrice" ref="a4d5f6b5c240b331bc6d2984d5dce4150" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const int64_t&amp; <a class="el" href="class_o_t_market.html#a4d5f6b5c240b331bc6d2984d5dce4150">OTMarket::GetLastSalePrice</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00238">238</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">        { <span class="keywordflow">if</span> (m_lLastSalePrice &lt; 1) m_lLastSalePrice = 1; <span class="keywordflow">return</span> m_lLastSalePrice; }
</pre></div>
</div>
</div>
<a class="anchor" id="a5580893d6510e601ca3ea48164485764"></a><!-- doxytag: member="OTMarket::GetLowestAskPrice" ref="a5580893d6510e601ca3ea48164485764" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int64_t <a class="el" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">OTMarket::GetLowestAskPrice</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00948">948</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    int64_t lPrice = 0;
    
    mapOfOffers::iterator ii = m_mapAsks.begin();
    
    <span class="keywordflow">if</span> (ii != m_mapAsks.end())
    {       
        lPrice = (*ii).first;
        
        <span class="comment">// Market orders have a 0 price, so we need to skip any if they are here.</span>
        <span class="comment">//</span>
        <span class="comment">// Note that we don&#39;t have to do this with the highest bid price (above</span>
        <span class="comment">// function) but in the case of asks, a &quot;0 price&quot; will undercut the other</span>
        <span class="comment">// actual prices, so we need to skip any that have a 0 price.</span>
        <span class="comment">//</span>
        <span class="keywordflow">while</span> (0 == lPrice)
        {
            ++ii;
            <span class="comment">// -------</span>
            <span class="keywordflow">if</span> (ii == m_mapAsks.end())
                <span class="keywordflow">break</span>;
            <span class="comment">// -------</span>
            lPrice = (*ii).first;
        }
    }
    
    <span class="keywordflow">return</span> lPrice;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5b14418890823e00d07549c513292cd1"></a><!-- doxytag: member="OTMarket::GetNym_OfferList" ref="a5b14418890823e00d07549c513292cd1" args="(const OTIdentifier &amp;NYM_ID, OTDB::OfferListNym &amp;theOutputList, int32_t &amp;nNymOfferCount)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a5b14418890823e00d07549c513292cd1">OTMarket::GetNym_OfferList</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>NYM_ID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> &amp;&#160;</td>
          <td class="paramname"><em>theOutputList</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t &amp;&#160;</td>
          <td class="paramname"><em>nNymOfferCount</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00317">317</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    nNymOfferCount = 0; <span class="comment">// Outputs the count of offers for NYM_ID (on this market.)</span>
    <span class="comment">// ---------------------------------------</span>
    <span class="comment">// Loop through the offers, up to some maximum depth, and then add each</span>
    <span class="comment">// as a data member to an offer list, then pack it into ascOutput. </span>
    <span class="comment">//</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#a1116207ea005957ee57510fbfd39758f">mapOfOffersTrnsNum</a>, m_mapOffers)
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);

        <a class="code" href="class_o_t_trade.html">OTTrade</a> * pTrade = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>();

        <span class="comment">// We only return offers for a specific Nym ID, since this is private info only for that Nym.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span> ((NULL == pTrade) || (pTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() != NYM_ID))
            <span class="keywordflow">continue</span>;
        
        <span class="comment">// Below this point, I KNOW pTrade and pOffer are both good pointers.</span>
        <span class="comment">// with no need to cleanup. I also know they are for the right Nym.</span>
        <span class="comment">// --------------------------------------------</span>

        <a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html">OTDB::OfferDataNym</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html">OTDB::OfferDataNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a5700f3141bdafc532997996ea4bf6db8">OTDB::STORED_OBJ_OFFER_DATA_NYM</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferDataNym&gt;</a> theDataAngel(*pOfferData);
        <span class="comment">// --------------------------------------------</span>
        <span class="keyword">const</span> int64_t &amp; lTransactionNum         = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
        <span class="keyword">const</span> int64_t &amp; lPriceLimit             = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
        <span class="keyword">const</span> int64_t &amp; lTotalAssets                = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afae5495e18a4b41e5d2a8470094e4753">GetTotalAssetsOnOffer</a>();
        <span class="keyword">const</span> int64_t &amp; lFinishedSoFar              = pOffer-&gt;<a class="code" href="class_o_t_offer.html#ab3b709080aa7c81dcd268fd78eaef262">GetFinishedSoFar</a>();
        <span class="keyword">const</span> int64_t &amp; lMinimumIncrement           = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
        <span class="keyword">const</span> int64_t &amp; lScale                      = pOffer-&gt;<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>();

        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom                   = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a08eb5f25566832e1a67b3e33c0dcc13f">GetValidFrom</a>();
        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidTo                 = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#ab83a62f51692c946ff394408026b0c18">GetValidTo</a>();
    
        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket         = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();

        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID        = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>();        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetID         = pOffer-&gt;<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>();         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(theAssetID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetAcctID     = pTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetAcctID(theAssetAcctID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theCurrencyID      = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>();      <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyID(theCurrencyID);
        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theCurrencyAcctID  = pTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>();  <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyAcctID(theCurrencyAcctID);
        
        <span class="keyword">const</span> <span class="keywordtype">bool</span> bSelling                     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>();
        <span class="comment">// -------------------------------------------------------</span>
        <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#ac9a572c0c92699dd2a70f04d0aad933e">IsStopOrder</a>())
        {           
            <span class="keywordflow">if</span> (pTrade-&gt;<a class="code" href="class_o_t_trade.html#a532bed3d9d02a34878fb24b0ea615d1b">IsGreaterThan</a>())
                pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a> = <span class="stringliteral">&quot;&gt;&quot;</span>;
            <span class="keywordflow">else</span> if (pTrade-&gt;<a class="code" href="class_o_t_trade.html#ab302e2eb41c65f91118bcd208b78ed4a">IsLessThan</a>())
                pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a> = <span class="stringliteral">&quot;&lt;&quot;</span>;
            <span class="comment">// -------------------------------</span>
            if (!pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a>.compare(<span class="stringliteral">&quot;&gt;&quot;</span>) || !pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80f286f49bce7b5cf030373996c86fa5">stop_sign</a>.compare(<span class="stringliteral">&quot;&lt;&quot;</span>))
            {
                <span class="keyword">const</span> int64_t &amp; lStopPrice  = pTrade-&gt;<a class="code" href="class_o_t_trade.html#a2234ed0a72b48fa0749cbe89e69d5a54">GetStopPrice</a>();
                pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a888f474f564554f6a0d03cabd1f0ef3c">stop_price</a>  = to_string&lt;int64_t&gt;(lStopPrice);
            }
        }
        <span class="comment">// ------------------------------------------------------</span>
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ab5b4cb920bf2211cae056c41aee47871">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a83d4f7597ad118a3232ebccce42b8735">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ab24b32937fd9ae98994e83bf7730bb70">total_assets</a>        = to_string&lt;int64_t&gt;(lTotalAssets);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#acab7e0110c9737d49440fe5d62b16978">finished_so_far</a>     = to_string&lt;int64_t&gt;(lFinishedSoFar);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a5e3c257180f603de8b8b569550c5cc9c">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a3c3e3ed3c40bb91ae5d172c93873c35c">scale</a>               = to_string&lt;int64_t&gt;(lScale);
        
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a80a04471908aef8021f63772e2fbad21">valid_from</a>          = to_string&lt;time64_t&gt;(tValidFrom);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a3ab5cc1ff3567b40d5b4ccbf00003eb0">valid_to</a>            = to_string&lt;time64_t&gt;(tValidTo);

        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#aa25174f9820a0c6b5092e1a113eb1231">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);

        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ae1e0c74c7e547ed930cdf4a28ffeafe8">server_id</a>           = strServerID.Get();
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#aad0735277c4348f983f632ad29dd0acf">asset_type_id</a>       = strAssetID.Get();
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a900d1d18875b50a9d0845615b9c97597">asset_acct_id</a>       = strAssetAcctID.Get();
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a1343a8d4cd9379f17782df3d3afe2a49">currency_type_id</a>    = strCurrencyID.Get();
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#ae6a57a2226f59e4364de65f299f7c304">currency_acct_id</a>    = strCurrencyAcctID.Get();

        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_nym.html#a4864d06c6713e383f12c00bd79bd4956">selling</a>             = bSelling;
        <span class="comment">// ------------------------------------------------------</span>
        <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
        <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
        <span class="comment">//</span>
        theOutputList.AddOfferDataNym(*pOfferData); 
        nNymOfferCount++;
    }       
        
    <span class="comment">// -------------------------------------------------------------</span>
    
    <span class="keywordflow">return</span> <span class="keyword">true</span>;        
}
</pre></div>
</div>
</div>
<a class="anchor" id="a61f96f7d546012fd290307d519214088"></a><!-- doxytag: member="OTMarket::GetOffer" ref="a61f96f7d546012fd290307d519214088" args="(const int64_t &amp;lTransactionNum)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_o_t_offer.html">OTOffer</a> * <a class="el" href="class_o_t_market.html#a61f96f7d546012fd290307d519214088">OTMarket::GetOffer</a> </td>
          <td>(</td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNum</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00629">629</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// See if there&#39;s something there with that transaction number.</span>
    mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
    
    <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
    {
        <span class="comment">// nothing found.</span>
        <span class="keywordflow">return</span> NULL;
    }
    <span class="comment">// Found it!</span>
    <span class="keywordflow">else</span> 
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*ii).second;
        
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pOffer));
        
        <span class="keywordflow">if</span> (pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>() == lTransactionNum)
            <span class="keywordflow">return</span> pOffer;
        <span class="keywordflow">else</span> 
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Expected Offer with transaction number %lld, but found %lld inside. Bad data?\n&quot;</span>,
                          lTransactionNum, pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>());
    }
    
    <span class="keywordflow">return</span> NULL;    
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4b6f10cedaa3a30fa5d7efc8912c71e2"></a><!-- doxytag: member="OTMarket::GetOfferList" ref="a4b6f10cedaa3a30fa5d7efc8912c71e2" args="(OTASCIIArmor &amp;ascOutput, int64_t lDepth, int32_t &amp;nOfferCount)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a4b6f10cedaa3a30fa5d7efc8912c71e2">OTMarket::GetOfferList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp;&#160;</td>
          <td class="paramname"><em>ascOutput</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int64_t&#160;</td>
          <td class="paramname"><em>lDepth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t &amp;&#160;</td>
          <td class="paramname"><em>nOfferCount</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00484">484</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    nOfferCount = 0;  <span class="comment">// Outputs the actual count of offers being returned.</span>
    <span class="comment">// ----------------------------</span>
    <span class="keywordflow">if</span> (0 == lDepth)
        lDepth = <a class="code" href="_o_t_market_8hpp.html#ad3557119e36c729a56ea7448245c116a">MAX_MARKET_QUERY_DEPTH</a>;

    <span class="comment">// Loop through the offers, up to some maximum depth, and then add each</span>
    <span class="comment">// as a data member to an offer list, then pack it into ascOutput. </span>
    
    <a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> * pOfferList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2b54a22ce17683d3970981ec94203ad1">OTDB::STORED_OBJ_OFFER_LIST_MARKET</a>));
    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListMarket&gt;</a> theListAngel(*pOfferList);
    <span class="comment">// -----------------------------------------------------------</span>
<span class="comment">//  mapOfOffers         m_mapBids;      // The buyers, ordered by price limit</span>
<span class="comment">//  mapOfOffers         m_mapAsks;      // The sellers, ordered by price limit</span>

    <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer    = NULL;
    int32_t nTempDepth      = 0;
    
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapBids)
    {
        <span class="keywordflow">if</span> (nTempDepth++ &gt; lDepth)
            <span class="keywordflow">break</span>;
        <span class="comment">// --------------------------------------------</span>
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        <span class="comment">// --------------------------------------------</span>
        <span class="keyword">const</span> int64_t &amp; lPriceLimit     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();

        <span class="keywordflow">if</span> (0 == lPriceLimit) <span class="comment">// Skipping any market orders.</span>
            <span class="keywordflow">continue</span>;
        <span class="comment">// --------------------------------------------</span>
        <span class="comment">// OfferDataMarket</span>
        <a class="code" href="class_o_t_d_b_1_1_bid_data.html">OTDB::BidData</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_bid_data.html">OTDB::BidData</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82aa8c9eb3eaaf80d1bcde91443e43b9b2f">OTDB::STORED_OBJ_BID_DATA</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::BidData&gt;</a> theDataAngel(*pOfferData);
        <span class="comment">// --------------------------------------------</span>
        <span class="keyword">const</span> int64_t &amp; lTransactionNum = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
        <span class="keyword">const</span> int64_t    lAvailableAssets   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
        <span class="keyword">const</span> int64_t &amp; lMinimumIncrement   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();
        
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a9204334216c536dbb899f1f99c121f9b">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a599d2dfd56c4232bbbb30d16987efb57">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a23ce62a0f8c04482ce8b9018bb9126aa">available_assets</a>    = to_string&lt;int64_t&gt;(lAvailableAssets);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a62f4d67cf5675bd6f9ff6d602c199650">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a83cf18fff32be53bb5ac0b8e1b6b6f43">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);
        <span class="comment">// ------------------------------------------------------</span>
        <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
        <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
        <span class="comment">//</span>
        pOfferList-&gt;AddBidData(*pOfferData);
        nOfferCount++;
    }       
    
    pOffer      = NULL;
    nTempDepth  = 0;
    
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
    {
        <span class="keywordflow">if</span> (nTempDepth++ &gt; lDepth)
            <span class="keywordflow">break</span>;
        <span class="comment">// --------------------------------------------</span>
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        
        <span class="comment">// OfferDataMarket</span>
        <a class="code" href="class_o_t_d_b_1_1_ask_data.html">OTDB::AskData</a> * pOfferData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_ask_data.html">OTDB::AskData</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a95aef78f2a6a6e62d4a44b3301588538">OTDB::STORED_OBJ_ASK_DATA</a>));
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::AskData&gt;</a> theDataAngel(*pOfferData);
        <span class="comment">// --------------------------------------------</span>
        <span class="keyword">const</span> int64_t &amp; lTransactionNum = pOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
        <span class="keyword">const</span> int64_t &amp; lPriceLimit     = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
        <span class="keyword">const</span> int64_t    lAvailableAssets   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
        <span class="keyword">const</span> int64_t &amp; lMinimumIncrement   = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>();
        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tDateAddedToMarket = pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>();

        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a9204334216c536dbb899f1f99c121f9b">transaction_id</a>      = to_string&lt;int64_t&gt;(lTransactionNum);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a599d2dfd56c4232bbbb30d16987efb57">price_per_scale</a>     = to_string&lt;int64_t&gt;(lPriceLimit);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a23ce62a0f8c04482ce8b9018bb9126aa">available_assets</a>    = to_string&lt;int64_t&gt;(lAvailableAssets);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a62f4d67cf5675bd6f9ff6d602c199650">minimum_increment</a>   = to_string&lt;int64_t&gt;(lMinimumIncrement);
        pOfferData-&gt;<a class="code" href="class_o_t_d_b_1_1_offer_data_market.html#a83cf18fff32be53bb5ac0b8e1b6b6f43">date</a>                = to_string&lt;time64_t&gt;(tDateAddedToMarket);
        <span class="comment">// ------------------------------------------------------</span>
        <span class="comment">// *pOfferData is CLONED at this time (I&#39;m still responsible to delete.)</span>
        <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
        <span class="comment">//</span>
        pOfferList-&gt;AddAskData(*pOfferData);
        nOfferCount++;
    }
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="comment">// Now pack the list into strOutput...</span>
    
    <span class="keywordflow">if</span> (nOfferCount == 0)
        <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but there were zero offers found.</span>
    
    <span class="keywordflow">if</span> (nOfferCount &gt; 0)
    {
        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
        
        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
        <span class="comment">// -----------------------------</span>
        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*pOfferList); <span class="comment">// Now we PACK our market&#39;s offer list.</span>
        
        <span class="keywordflow">if</span> (NULL == pBuffer)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pOfferList in OTCron::GetOfferList. \n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
        <span class="comment">// --------------------------------------------------------</span>
        <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
        
        <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
        <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
        
        <span class="keywordflow">if</span> (NULL != pUint)
        {
            <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
            
            <span class="comment">// This function will base64 ENCODE theData,</span>
            <span class="comment">// and then Set() that as the string contents.</span>
            ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
            
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span> 
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error while getting buffer data in OTMarket::GetOfferList.\n&quot;</span>);
    }
    
    <span class="keywordflow">else</span>
        <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;invalid: nOfferCount is &lt; 0 in OTMarket::GetOfferList.\n&quot;</span>);
        
    <span class="keywordflow">return</span> <span class="keyword">false</span>;   
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7375c51d4be96bf9d7e6a92f0dc7f18f"></a><!-- doxytag: member="OTMarket::GetRecentTradeList" ref="a7375c51d4be96bf9d7e6a92f0dc7f18f" args="(OTASCIIArmor &amp;ascOutput, int32_t &amp;nTradeCount)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a7375c51d4be96bf9d7e6a92f0dc7f18f">OTMarket::GetRecentTradeList</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp;&#160;</td>
          <td class="paramname"><em>ascOutput</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t &amp;&#160;</td>
          <td class="paramname"><em>nTradeCount</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00410">410</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    nTradeCount = 0;    <span class="comment">// Output the count of trades in the list being returned. (If success..)</span>
    
    <span class="comment">// -------------------------</span>
    
    <span class="keywordflow">if</span> (NULL == m_pTradeList)
    {
<span class="comment">//      OTLog::Error(&quot;OTMarket::GetRecentTradeList: m_pTradeList is NULL. \n&quot;);</span>
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
        <span class="comment">// Returning true, since it&#39;s normal for this to be NULL when the list is empty.</span>
    }
    
    <span class="comment">// ------------------------------------------</span>
    
    <span class="comment">// The market already keeps a list of recent trades (informational only)</span>
    <span class="comment">//</span>
    
    <span class="keyword">const</span> <span class="keywordtype">size_t</span> sizeList = m_pTradeList-&gt;GetTradeDataMarketCount();
    nTradeCount = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span> (sizeList);
    
    <span class="keywordflow">if</span> (nTradeCount == 0)
        <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but there are 0 trade datas to return. (empty list.)</span>
    
    <span class="comment">// So now, let&#39;s pack the list into strOutput...</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nTradeCount &gt; 0)
    {
        <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
        
        <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
        
        <span class="comment">// -----------------------------</span>
        
        <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*m_pTradeList); <span class="comment">// Now we PACK our market&#39;s recent trades list.</span>
        
        <span class="keywordflow">if</span> (NULL == pBuffer)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pTradeList in OTCron::GetRecentTradeList. \n&quot;</span>);
            <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        
        <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
        
        <span class="comment">// -------------------------------------------------------- </span>
        
        <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
        
        <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
        <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
        
        <span class="keywordflow">if</span> ((NULL != pUint) || (theSize &lt; 2))
        {
            <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
            
            <span class="comment">// This function will base64 ENCODE theData,</span>
            <span class="comment">// and then Set() that as the string contents.</span>
            ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
            
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span> 
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error while getting buffer data in OTMarket::GetRecentTradeList.\n&quot;</span>);
    }
    
    <span class="keywordflow">else</span>
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error: nTradeCount with negative value in OTMarket::GetRecentTradeList: %d.\n&quot;</span>, nTradeCount);
 
    <span class="keywordflow">return</span> <span class="keyword">false</span>;   
}
</pre></div>
</div>
</div>
<a class="anchor" id="aebe1f377a1c3a56d8dc0bb90168eea67"></a><!-- doxytag: member="OTMarket::GetScale" ref="aebe1f377a1c3a56d8dc0bb90168eea67" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const int64_t&amp; <a class="el" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">OTMarket::GetScale</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00233">233</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">        { <span class="keywordflow">if</span> (m_lScale &lt; 1) m_lScale = 1; <span class="keywordflow">return</span> m_lScale; }
</pre></div>
</div>
</div>
<a class="anchor" id="acbe41dd985ce33b5b72957b99a984444"></a><!-- doxytag: member="OTMarket::GetServerID" ref="acbe41dd985ce33b5b72957b99a984444" args="() const " -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a>&amp; <a class="el" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">OTMarket::GetServerID</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00231">231</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> m_SERVER_ID; }
</pre></div>
</div>
</div>
<a class="anchor" id="a2dd9eab76501e15105aca7a8f1ed7acd"></a><!-- doxytag: member="OTMarket::GetTotalAvailableAssets" ref="a2dd9eab76501e15105aca7a8f1ed7acd" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int64_t <a class="el" href="class_o_t_market.html#a2dd9eab76501e15105aca7a8f1ed7acd">OTMarket::GetTotalAvailableAssets</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00299">299</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    int64_t lTotal = 0;
    
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        
        lTotal += pOffer-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>();
    }
    
    <span class="keywordflow">return</span> lTotal;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a13beb1b8b45177445b711259c7f87759"></a><!-- doxytag: member="OTMarket::InitMarket" ref="a13beb1b8b45177445b711259c7f87759" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">OTMarket::InitMarket</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02408">2408</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a> = <span class="stringliteral">&quot;MARKET&quot;</span>;
    
    <a class="code" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">SetScale</a>(1);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a814b2f38a7ffa5593acbf13698ffef24"></a><!-- doxytag: member="OTMarket::LoadMarket" ref="a814b2f38a7ffa5593acbf13698ffef24" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a814b2f38a7ffa5593acbf13698ffef24">OTMarket::LoadMarket</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00822">822</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>());
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym());
    
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(*<span class="keyword">this</span>);
    <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);

    <span class="comment">// ------------------------------------------------------------------------</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = str_MARKET_ID.Get();
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="keywordtype">bool</span> bSuccess = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(szFoldername, szFilename);
    
    <span class="keywordflow">if</span> (bSuccess)
        bSuccess = <a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>(szFoldername, szFilename); <span class="comment">// todo ??</span>
    
    <span class="keywordflow">if</span> (bSuccess)
        bSuccess = <a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*(<a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym()));
    
    <span class="comment">// --------------------------------------------------------------------</span>
    <span class="comment">// Load the list of recent market trades (informational only.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (bSuccess)
    {
        <span class="keywordflow">if</span> (NULL != m_pTradeList)
            <span class="keyword">delete</span> m_pTradeList;

        <span class="keyword">const</span> <span class="keywordtype">char</span> * szSubFolder = <span class="stringliteral">&quot;recent&quot;</span>; <span class="comment">// todo stop hardcoding.</span>

        m_pTradeList =  <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#aaf0caee055f843a828e3bac094321886">OTDB::QueryObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>,
                                        szFoldername,   <span class="comment">// markets</span>
                                        szSubFolder,    <span class="comment">// markets/recent</span>
                                        szFilename));   <span class="comment">// markets/recent/market_ID</span>
    }

    <span class="comment">// --------------------------------------------------------------------</span>

    <span class="keywordflow">return</span> bSuccess;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6979d1c25675e7f25e3b1ae4cfc546a1"></a><!-- doxytag: member="OTMarket::ProcessTrade" ref="a6979d1c25675e7f25e3b1ae4cfc546a1" args="(OTTrade &amp;theTrade, OTOffer &amp;theOffer, OTOffer &amp;theOtherOffer)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">OTMarket::ProcessTrade</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_trade.html">OTTrade</a> &amp;&#160;</td>
          <td class="paramname"><em>theTrade</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;&#160;</td>
          <td class="paramname"><em>theOffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;&#160;</td>
          <td class="paramname"><em>theOtherOffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l01031">1031</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_trade.html">OTTrade</a> * pOtherTrade = theOtherOffer.<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>();
    <a class="code" href="class_o_t_cron.html">OTCron</a>  * pCron       = theTrade.<a class="code" href="class_o_t_cron_item.html#af734ad5d309fcc9b4a60d40d6c30f55a">GetCron</a>();
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// Make sure have pointer to both trades.</span>
    <span class="comment">//</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>   (NULL != pOtherTrade, <span class="stringliteral">&quot;Offer was on the market, but somehow got into processing without a trade pointer.\n&quot;</span>);
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>       (NULL != pCron);    <span class="comment">// Also need the Cron pointer which SHOULD ALWAYS be there.</span>
    <span class="comment">// --------------------------------------------------</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = pCron-&gt;<a class="code" href="class_o_t_cron.html#a7756d0dcc047209ca87632939dc11db3">GetServerNym</a>();
    
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pServerNym,
                  <span class="stringliteral">&quot;Somehow a Market is running even though there is no Server Nym on the Cron object authorizing the trades.&quot;</span>);
    <span class="comment">// --------------------------------------------------</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(pCron-&gt;<a class="code" href="class_o_t_cron.html#a93b52f56c0de94e53bb05a610830ba4b">GetServerID</a>());
    
    <span class="keywordflow">if</span> (pCron-&gt;<a class="code" href="class_o_t_cron.html#ae241ecf6802b59ccde653082f098e80c">GetTransactionCount</a>() &lt; 1)
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed to process trades: Out of transaction numbers!\n&quot;</span>);
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// Make sure these two separate trades don&#39;t have the same Account IDs inside</span>
    <span class="comment">// otherwise we would have to take care not to load them twice, like with the Nyms below.</span>
    <span class="comment">// (Instead I just disallow the trade entirely.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> ((theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>()     == pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>())   ||
        (theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>()     == pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()) ||
        (theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()   == pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>())   ||
        (theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()   == pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>()))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(5, <span class="stringliteral">&quot;Failed to process trades: they had account IDs in common.\n&quot;</span>);
        
        <span class="comment">// No need to remove either of the trades since they might still be valid when</span>
        <span class="comment">// matched up to others.</span>
        <span class="comment">// I put the log on the most verbose level because if this happens, it will probably</span>
        <span class="comment">// happen over and over again. (Unless the market has enough depth to process them</span>
        <span class="comment">// both out.)</span>
        
        <span class="comment">// TODO May need to choose (or add a config option) so server operators can remove the</span>
        <span class="comment">// oldest or newest trade when this happens, or both. Or it can choose to do nothing,</span>
        <span class="comment">// and let them both process out with other trades (as this does now.)</span>
        
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// No need to compare asset types, since those are already verified by the time</span>
    <span class="comment">// we get here. BUT, when the accounts are actually loaded up, THEN should compare</span>
    <span class="comment">// the asset types to make sure they were what we expected them to be.</span>
    
    <span class="comment">// -------------- Make sure have both nyms loaded and checked out. --------------------------------------------------</span>
    <span class="comment">// WARNING: 1 or both of the Nyms could be also the Server Nym. They could also be the same Nym, but NOT the Server.</span>
    <span class="comment">// In all of those different cases, I don&#39;t want to load the same file twice and overwrite it with itself, losing</span>
    <span class="comment">// half of all my changes. I have to check all three IDs carefully and set the pointers accordingly, and then operate</span>
    <span class="comment">// using the pointers from there.</span>
    
    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  FIRST_NYM_ID(theTrade.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>()),       <span class="comment">// The newest trade&#39;s Nym.</span>
                        OTHER_NYM_ID(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>()),   <span class="comment">// The Nym of the trade that was already on the market. (Could be same Nym.)</span>
                        SERVER_NYM_ID(*pServerNym);                     <span class="comment">// The Server Nym (could be one or both of the above.)</span>
    
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theNym, theOtherNym; <span class="comment">// We MIGHT use ONE, OR BOTH, of these, or none.</span>

    <span class="comment">// Find out if either Nym is actually also the server.</span>
    <span class="keywordtype">bool</span> bFirstNymIsServerNym   = ((FIRST_NYM_ID == SERVER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
    <span class="keywordtype">bool</span> bOtherNymIsServerNym   = ((OTHER_NYM_ID == SERVER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
    
    <span class="comment">// We also see, after all that is done, whether both pointers go to the same entity. We&#39;ll want to know that later.</span>
    <span class="keywordtype">bool</span> bTradersAreSameNym     = ((FIRST_NYM_ID == OTHER_NYM_ID) ? <span class="keyword">true</span> : <span class="keyword">false</span>);
    
    <span class="comment">// Initially both nym pointers are set to their own blank objects</span>
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pFirstNym = NULL;
    <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pOtherNym = NULL;
    
    <span class="comment">// Unless either of them is actually the server,</span>
    <span class="comment">// in which case the pointer is re-pointed to the server Nym.</span>
    <span class="keywordflow">if</span> (bFirstNymIsServerNym)       <span class="comment">// If the First Nym is the server, then just point to that.</span>
    {
        pFirstNym = pServerNym;
    }
    <span class="keywordflow">else</span>    <span class="comment">// Else load the First Nym from storage.</span>
    {
        theNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(FIRST_NYM_ID);  <span class="comment">// theNym is pFirstNym</span>

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>())
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(FIRST_NYM_ID);
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading First Nym public key in OTMarket::%s: %s\n&quot;</span>,
                          __FUNCTION__, strNymID.Get());
            theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
            <span class="keywordflow">return</span>;
        }
        
        <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>()                &amp;&amp; 
            theTrade.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp; 
            theOffer.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp;
            theNym.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(*pServerNym)) <span class="comment">// ServerNym here is not theNym&#39;s identity, but merely the signer on this file.</span>
        {
            pFirstNym = &amp;theNym; <span class="comment">//  &lt;=====</span>
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(FIRST_NYM_ID);
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTMarket::%s: Failure verifying trade, offer, or nym, or loading signed Nymfile: %s\n&quot;</span>,
                          __FUNCTION__, strNymID.Get());
            theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
            <span class="keywordflow">return</span>;         
        }
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (bOtherNymIsServerNym)    <span class="comment">// If the Other Nym is the server, then just point to that.</span>
    {
        pOtherNym = pServerNym;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bTradersAreSameNym) <span class="comment">// Else if the Traders are the same Nym, point to the one we already loaded.</span>
    {
        pOtherNym = pFirstNym; <span class="comment">// theNym is pFirstNym</span>
    }
    <span class="keywordflow">else</span>    <span class="comment">// Otherwise load the Other Nym from Disk and point to that.</span>
    {
        theOtherNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(OTHER_NYM_ID);

        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theOtherNym.<a class="code" href="class_o_t_pseudonym.html#aeb1c675ec72d6450e5c151d1f3eb95bf">LoadPublicKey</a>())
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(OTHER_NYM_ID);
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading Other Nym public key in OTMarket::%s: %s\n&quot;</span>,
                          __FUNCTION__, strNymID.Get());
            pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
            <span class="keywordflow">return</span>;
        }
        
        <span class="keywordflow">if</span> (theOtherNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>()               &amp;&amp; 
            pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)   &amp;&amp; 
            theOtherOffer.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)  &amp;&amp;
            theOtherNym.<a class="code" href="class_o_t_pseudonym.html#ad24db39caa89399f659f414b19903f90">LoadSignedNymfile</a>(*pServerNym))
        {
            pOtherNym = &amp;theOtherNym; <span class="comment">//  &lt;=====</span>
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_string.html">OTString</a> strNymID(OTHER_NYM_ID);
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failure loading or verifying Other Nym public key in OTMarket::%s: %s\n&quot;</span>,
                          __FUNCTION__, strNymID.Get());
            pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
            <span class="keywordflow">return</span>;         
        }
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// AT THIS POINT, I have pServerNym, pFirstNym, and pOtherNym.</span>
    <span class="comment">// ALL are loaded from disk (where necessary.) AND...</span>
    <span class="comment">// ALL are valid pointers, (even if they sometimes point to the same object,)</span>
    <span class="comment">// AND none are capable of overwriting the storage of the other (by accidentally</span>
    <span class="comment">// loading the same storage twice.)</span>
    <span class="comment">// We also have boolean variables at this point to tell us exactly which are which,</span>
    <span class="comment">// (in case some of those pointers do go to the same object.) </span>
    <span class="comment">// They are:</span>
    <span class="comment">// bFirstNymIsServerNym, bOtherNymIsServerNym, and bTradersAreSameNym.</span>
    <span class="comment">//</span>
    <span class="comment">// We also have theTrade, theOffer, pOtherTrade, and theOtherOffer, </span>
    <span class="comment">// and we know they are all good also.</span>
    <span class="comment">//</span>
    <span class="comment">// We also know that pOtherTrade/theOtherOffer are a Limit order (NOT a Market order.)</span>
    <span class="comment">// (Meaning pOtherTrade/theOtherOffer definitely has a price set.)</span>
    <span class="comment">//</span>
    <span class="comment">// We also know that theTrade/theOffer MIGHT be a Limit order OR a Market order.</span>
    <span class="comment">// (Meaning theTrade/theOffer MIGHT have a 0 price.)</span>
    <span class="comment">//</span>
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// Make sure have ALL FOUR accounts loaded and checked out.</span>
    <span class="comment">// (first nym&#39;s asset/currency, and other nym&#39;s asset/currency.)</span>

    <a class="code" href="class_o_t_account.html">OTAccount</a> * pFirstAssetAcct     = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),        SERVER_ID);
    <a class="code" href="class_o_t_account.html">OTAccount</a> * pFirstCurrencyAcct  = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),      SERVER_ID);

    <a class="code" href="class_o_t_account.html">OTAccount</a> * pOtherAssetAcct     = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),    SERVER_ID);
    <a class="code" href="class_o_t_account.html">OTAccount</a> * pOtherCurrencyAcct  = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),  SERVER_ID);
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">if</span> ((NULL == pFirstAssetAcct)       ||
        (NULL == pFirstCurrencyAcct))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying existence of one of the first trader&#39;s accounts during attempted Market trade.\n&quot;</span>);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NULL == pOtherAssetAcct)      ||
             (NULL == pOtherCurrencyAcct))
    {
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;ERROR verifying existence of one of the second trader&#39;s accounts during attempted Market trade.\n&quot;</span>);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// Are the accounts of the first trader of the right asset types?</span>
    <span class="comment">// We already know the asset types matched as far as the market, trades, and offers were concerned.</span>
    <span class="comment">// But only once the accounts themselves have been loaded can we VERIFY this to be true.</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pFirstAssetAcct   -&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()) || <span class="comment">// the trader&#39;s asset accts have same asset type as the market.</span>
             (pFirstCurrencyAcct-&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>()) <span class="comment">// the trader&#39;s currency accts have same asset type as the market.</span>
             )
    {       
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR - First Trader has accounts of wrong &quot;</span>
                      <span class="stringliteral">&quot;asset types in OTMarket::%s\n&quot;</span>, __FUNCTION__);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pOtherAssetAcct   -&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()) ||  <span class="comment">// the trader&#39;s asset accts have same asset type as the market.</span>
             (pOtherCurrencyAcct-&gt;GetAssetTypeID() != <a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>())) <span class="comment">// the trader&#39;s currency accts have same asset type as market.</span>
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR - Other Trader has accounts of wrong &quot;</span>
                      <span class="stringliteral">&quot;asset types in OTMarket::%s\n&quot;</span>, __FUNCTION__);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// Make sure all accounts are signed by the server and have the owner they are expected to have.</span>
        
    <span class="comment">// I call VerifySignature here since VerifyContractID was already called in LoadExistingAccount().</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!pFirstAssetAcct   -&gt;VerifyOwner(*pFirstNym) || !pFirstAssetAcct-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) ||
             (!pFirstCurrencyAcct-&gt;VerifyOwner(*pFirstNym) || !pFirstCurrencyAcct-&gt;VerifySignature(*pServerNym)))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR verifying ownership or signature on one of first trader&#39;s accounts in OTMarket::%s\n&quot;</span>,
                      __FUNCTION__);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!pOtherAssetAcct   -&gt;VerifyOwner(*pOtherNym) || !pOtherAssetAcct-&gt;VerifySignature(*pServerNym) ) ||
             (!pOtherCurrencyAcct-&gt;VerifyOwner(*pOtherNym) || !pOtherCurrencyAcct-&gt;VerifySignature(*pServerNym)))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR verifying ownership or signature on one of other trader&#39;s accounts in OTMarket::%s\n&quot;</span>,
                      __FUNCTION__);
        <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
        pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
        <span class="keywordflow">return</span>;
    }
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="comment">// By this point, I know I have all four accounts loaded, and I know that they have the right asset types,</span>
    <span class="comment">// and I know they have the right owners and they were all signed by the server.</span>
    <span class="comment">// I also know that their account IDs in their internal records matched the account filename for each acct.</span>
    <span class="comment">// I also have pointers to the Nyms who own these accounts, as well as the Trades and Offers associated with them.</span>
    <span class="comment">// ----------------------------------------------------------------</span>
    <span class="keywordflow">else</span>
    {           
        <span class="comment">// Okay then, everything checks out. Let&#39;s add this to the sender&#39;s outbox and the recipient&#39;s inbox. </span>
        <span class="comment">// IF they can be loaded up from file, or generated, that is. </span>
        
        <span class="comment">// Load the inbox/outbox in case they already exist</span>
        <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theFirstAssetInbox      (FIRST_NYM_ID, theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),      SERVER_ID),
                    theFirstCurrencyInbox   (FIRST_NYM_ID, theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),    SERVER_ID),
                    theOtherAssetInbox      (OTHER_NYM_ID, pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),  SERVER_ID),
                    theOtherCurrencyInbox   (OTHER_NYM_ID, pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),SERVER_ID);
        
        <span class="comment">// ALL inboxes -- no outboxes. All will receive notification of something ALREADY DONE.</span>
        <span class="keywordtype">bool</span> bSuccessLoadingFirstAsset      = theFirstAssetInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>();
        <span class="keywordtype">bool</span> bSuccessLoadingFirstCurrency   = theFirstCurrencyInbox.LoadInbox();
        <span class="keywordtype">bool</span> bSuccessLoadingOtherAsset      = theOtherAssetInbox.LoadInbox();
        <span class="keywordtype">bool</span> bSuccessLoadingOtherCurrency   = theOtherCurrencyInbox.LoadInbox();
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="comment">// ...or generate them otherwise...</span>
        
        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingFirstAsset)
            bSuccessLoadingFirstAsset       = theFirstAssetInbox.VerifyAccount(*pServerNym);
        <span class="keywordflow">else</span>
            bSuccessLoadingFirstAsset       = theFirstAssetInbox.GenerateLedger(theTrade.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),
                                                                                SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
        
        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingFirstCurrency)
            bSuccessLoadingFirstCurrency    = theFirstCurrencyInbox.VerifyAccount(*pServerNym);
        <span class="keywordflow">else</span>
            bSuccessLoadingFirstCurrency    = theFirstCurrencyInbox.GenerateLedger(theTrade.<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),
                                                                                   SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
        
        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOtherAsset)
            bSuccessLoadingOtherAsset       = theOtherAssetInbox.VerifyAccount(*pServerNym);
        <span class="keywordflow">else</span>
            bSuccessLoadingOtherAsset       = theOtherAssetInbox.GenerateLedger(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>(),
                                                                                SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
        
        <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccessLoadingOtherCurrency)
            bSuccessLoadingOtherCurrency    = theOtherCurrencyInbox.VerifyAccount(*pServerNym);
        <span class="keywordflow">else</span>
            bSuccessLoadingOtherCurrency    = theOtherCurrencyInbox.GenerateLedger(pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#a9918143d418796eab01f05037ced3965">GetCurrencyAcctID</a>(),
                                                                                   SERVER_ID, OTLedger::inbox, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
        <span class="comment">// --------------------------------------------------------------------</span>
        <span class="keywordflow">if</span> ((<span class="keyword">false</span> == bSuccessLoadingFirstAsset)    ||
            (<span class="keyword">false</span> == bSuccessLoadingFirstCurrency))
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading or generating an inbox for first trader in OTMarket::%s.\n&quot;</span>,
                          __FUNCTION__);
            <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
            theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
            <span class="keywordflow">return</span>;
        }
        <span class="comment">// ----------------------------------------------------------------</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">false</span> == bSuccessLoadingOtherAsset)   ||
                 (<span class="keyword">false</span> == bSuccessLoadingOtherCurrency))
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading or generating an inbox for other trader in OTMarket::%s.\n&quot;</span>,
                          __FUNCTION__);
            <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
            pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();  <span class="comment">// Removes from Cron. </span>
            <span class="keywordflow">return</span>;
        }
        <span class="comment">// ----------------------------------------------------------------</span>
        <span class="keywordflow">else</span>
        {
            <span class="comment">// Generate new transaction numbers for these new transactions</span>
            int64_t lNewTransactionNumber = pCron-&gt;<a class="code" href="class_o_t_cron.html#a22822e0aeced441b6404cd8a2c8e00da">GetNextTransactionNumber</a>();
            
<span class="comment">//          OT_ASSERT(lNewTransactionNumber &gt; 0); // this can be my reminder.           </span>
            <span class="keywordflow">if</span> (0 == lNewTransactionNumber)
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;WARNING: Market is unable to process because there are no more transaction numbers available.\n&quot;</span>);
                <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
                <span class="comment">// (Here I flag neither trade for removal.)</span>
                <span class="keywordflow">return</span>;             
            }
            
            <span class="comment">// Why a new transaction number here?</span>
            <span class="comment">// </span>
            <span class="comment">// Each user had to burn one of his own numbers to generate his own Trade.</span>
            <span class="comment">//</span>
            <span class="comment">// So the First Trader might have used number 345, and the Other Trader might have</span>
            <span class="comment">// used the number 912. Those numbers were used to CREATE the Trades initially, and</span>
            <span class="comment">// they can be used to lookup the original trade request from each user.</span>
            <span class="comment">//</span>
            <span class="comment">// So whenever I give a receipt to either Trader, I am sure to tell Trader A that</span>
            <span class="comment">// this is in reference to transaction 345, and I tell Trader B that this is in</span>
            <span class="comment">// reference to transaction 912.</span>
            <span class="comment">//</span>
            <span class="comment">// I also have to get a new transaction number (here) because the first two numbers</span>
            <span class="comment">// were requests signed by the users to post the trades. That was completed--those</span>
            <span class="comment">// numbers have been used now, and they could not be used again without introducing</span>
            <span class="comment">// duplication and confusion. To remove money from someone&#39;s account, which we have just</span>
            <span class="comment">// done, you need a new transaction number for that! Because you need a new number if</span>
            <span class="comment">// you&#39;re going to put some new receipt in their inbox, which is exactly what we are </span>
            <span class="comment">// doing right now.</span>
            <span class="comment">// </span>
            <span class="comment">// So let&#39;s say I generate transaction # 10023 to represent this money exchange that has</span>
            <span class="comment">// just occurred between these two traders.  To me as a user, 345 was my original request</span>
            <span class="comment">// to post the trade, 912 was the other guy&#39;s request to post his trade, and 10023 was</span>
            <span class="comment">// the server&#39;s transferring funds (based on the authorization in those trades). Put</span>
            <span class="comment">// another way, 345 has my signature, 912 has the other trader&#39;s signature, and 10023</span>
            <span class="comment">// has the server&#39;s signature.</span>

            
            <span class="comment">// Start generating the receipts (for all four inboxes.)</span>
            
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans1     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFirstAssetInbox, 
                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
            
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans2     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theFirstCurrencyInbox, 
                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
            
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans3     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theOtherAssetInbox, 
                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
            
            <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTrans4     = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theOtherCurrencyInbox, 
                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>, lNewTransactionNumber);
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// (No need to OT_ASSERT on the above transactions since it occurs in GenerateTransaction().)</span>
            
            <span class="comment">// All four inboxes will get receipts with the same (new) transaction ID.</span>
            <span class="comment">// They all have a &quot;reference to&quot; containing the original trade.</span>
            <span class="comment">// The first two will contain theTrade as the reference field,</span>
            <span class="comment">// but the second two contain pOtherTrade as the reference field.</span>
            <span class="comment">// The first two also thus reference a different original transaction number than the other two.</span>
            <span class="comment">// That&#39;s because each end of the trade was originally authorized separately by each trader, and</span>
            <span class="comment">// in each case he used his own unique transaction number to do so.</span>
            
            <span class="comment">// set up the transaction items (each transaction may have multiple items... but not in this case.)</span>
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem1     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans1, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem2     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans2, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem3     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans3, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
            <a class="code" href="class_o_t_item.html">OTItem</a> * pItem4     = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTrans4, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>);
            
            <span class="comment">// these may be unnecessary, I&#39;ll have to check CreateItemFromTransaction. I&#39;ll leave em.</span>
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem1);  <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem2);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem3);  <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem4);
            
            pItem1-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
            pItem2-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
            pItem3-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
            pItem4-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>); <span class="comment">// the default.</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Calculate the amount and remove / add it to the relevant accounts.</span>
            <span class="comment">// Make sure each Account can afford it, and roll back in case of failure.</span>
            
            <span class="keywordtype">bool</span> bMove1 = <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bMove2 = <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bMove3 = <span class="keyword">false</span>;
            <span class="keywordtype">bool</span> bMove4 = <span class="keyword">false</span>;
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// -- TheTrade will get the PriceLimit offered by theOtherOffer, and not vice-versa.</span>
            <span class="comment">//    (See explanation below this function if you need to know the reasoning.)</span>

            <span class="comment">// NOTICE: This is one of the reasons why theOtherOffer CANNOT be a Market order,</span>
            <span class="comment">// because we will be using his price limit to determine the price.</span>
            <span class="comment">// (Another reason FYI, is because Market Orders are only allowed to process once,</span>
            <span class="comment">// IN TURN.)</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Some logic described:</span>
            <span class="comment">//</span>
            <span class="comment">// Calculate the price</span>
            <span class="comment">// I know the amount available for trade is at LEAST the minimum increment on both</span>
            <span class="comment">// sides, since that was validated before this function was even called. Therefore,</span>
            <span class="comment">// let&#39;s calculate a price based on the largest of the two minimum increments.</span>
            <span class="comment">// Figure out which is largest, then divide that by the scale to get the multiplier.</span>
            <span class="comment">// Multiply THAT by the theOtherOffer&#39;s Price Limit to get the price per minimum increment.</span>
            <span class="comment">//</span>
            <span class="comment">// Since we are calculating the MINIMUM that must be processed per round, let&#39;s also</span>
            <span class="comment">// calculate the MOST that could be traded between these two offers. Then let&#39;s </span>
            <span class="comment">// mod that to the Scale and remove the remainder, then divide by the Scale and</span>
            <span class="comment">// multiply by the price (to get the MOST that would have to be paid, if the offers</span>
            <span class="comment">// fulfilled each other to the maximum possible according to their limits.)</span>
            <span class="comment">// !! It&#39;s better to process it all at once and avoid the loop entirely.</span>
            <span class="comment">// Plus, there&#39;s SUPPOSED to be enough funds in all the accounts to cover it.</span>
            <span class="comment">//</span>
            <span class="comment">// Anyway, if there aren&#39;t:</span>
            <span class="comment">//</span>
            <span class="comment">// Then LOOP (while available &gt;= minimum increment) on both sides of the trade</span>
            <span class="comment">// Inside, try to move funds across all 4 accounts. If any of them fail, roll them </span>
            <span class="comment">// back and break. (I&#39;ll check balances first to avoid this.)</span>
            <span class="comment">// As long as there&#39;s enough available in the accounts to continue exchanging the</span>
            <span class="comment">// largest minimum increment, then keep looping like this and moving the digital assets.</span>
            <span class="comment">// Each time, also, be sure to update the Offer so that less and less is available on each trade.</span>
            <span class="comment">// At some point, the Trades will run out of authorization to transfer any more from the accounts.</span>
            <span class="comment">// Perhaps one has a 10,000 bushel total limit and it has been reached. The trade is complete,</span>
            <span class="comment">// from his side of it, anyway. Then the loop will be over for sure.</span>
            
                    
            <a class="code" href="class_o_t_account.html">OTAccount</a> * pAssetAccountToDebit     = NULL;
            <a class="code" href="class_o_t_account.html">OTAccount</a> * pAssetAccountToCredit    = NULL;
            <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAccountToDebit  = NULL;
            <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAccountToCredit = NULL;
            
            <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()) <span class="comment">// I&#39;m selling, he&#39;s buying</span>
            {
                pAssetAccountToDebit     = pFirstAssetAcct;    <span class="comment">// I am selling gold. When I sell, my gold balance goes down.</span>
                pAssetAccountToCredit    = pOtherAssetAcct;    <span class="comment">// He is bidding on gold. When he buys, his gold balance goes up.</span>
                pCurrencyAccountToDebit  = pOtherCurrencyAcct; <span class="comment">// He is paying in dollars. When he pays, his dollar balance goes down.</span>
                pCurrencyAccountToCredit = pFirstCurrencyAcct; <span class="comment">// I am being paid in dollars. When I get paid, my dollar balance goes up.</span>
            }
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="keywordflow">else</span>    <span class="comment">// I&#39;m buying, he&#39;s selling</span>
            {
                pAssetAccountToDebit     = pOtherAssetAcct;    <span class="comment">// He is selling gold. When he sells, his gold balance goes down.</span>
                pAssetAccountToCredit    = pFirstAssetAcct;    <span class="comment">// I am bidding on gold. When I buy, my gold balance goes up.</span>
                pCurrencyAccountToDebit  = pFirstCurrencyAcct; <span class="comment">// I am paying in dollars. When I pay, my dollar balance goes down.</span>
                pCurrencyAccountToCredit = pOtherCurrencyAcct; <span class="comment">// He is being paid in dollars. When he gets paid, his dollar balance goes up.</span>
            }
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Calculate minimum increment to be traded each round.</span>
            int64_t lMinIncrementPerRound =
                ((theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOtherOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>()) ?
                  theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() : theOtherOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>());
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="keyword">const</span> int64_t lMultiplier = (lMinIncrementPerRound / <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());   <span class="comment">// If the Market scale is 10, and the minimum increment is 50, multiplier is 5..</span>
                                                                            <span class="comment">// The price limit is per scale. (Per 10.) So if 1oz gold is $1300, then 10oz scale</span>
                                                                            <span class="comment">// would be $13,000. So if my price limit is per SCALE, I might set my limit</span>
                                                                            <span class="comment">// to $12,000 or $13,000 (PER 10 OZ OF GOLD, which is the SCALE for this market.)</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Calc price of each round.</span>
            int64_t lPrice = ( lMultiplier * theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() );   <span class="comment">// So if my minimum increment is 50, then my multiplier is 5, which means</span>
                                                                            <span class="comment">// multiply my price by 5: $13,000 * 5 == $65,000 for 50 oz. per minimum inc.</span>

            <span class="comment">// Why am I using the OTHER Offer&#39;s price limit, and not my own?</span>
            <span class="comment">// See notes at top and bottom of this function for the answer.</span>
            <span class="comment">// ----------------------------------------------------------------------------</span>
            <span class="comment">// There&#39;s two ways to process this: in rounds (by minimum increment), for which the numbers were</span>
            <span class="comment">// just calulated above...</span>
            <span class="comment">// </span>
            <span class="comment">// ...OR based on whatever is the MOST available from BOTH parties. (Whichever is the least of the </span>
            <span class="comment">// two parties&#39; &quot;Most Available Left To Trade&quot;.) So I&#39;ll try THAT first, to avoid processing in </span>
            <span class="comment">// rounds. (Since the funds SHOULD be there...)</span>
            
            int64_t lMostAvailable = ((theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()      &gt; theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()) ?
                                    theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>() : theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>());
            <span class="comment">// ----------------------------------------------------------------</span>
            int64_t lTemp = lMostAvailable % <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(); <span class="comment">// The Scale may not evenly divide into the amount available</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            lMostAvailable -= lTemp;    <span class="comment">// We&#39;ll subtract remainder amount, so it&#39;s even to scale (which is how it&#39;s priced.)</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// We KNOW the amount available on the offer is at least as much as the minimum increment (on both sides)</span>
            <span class="comment">// because that is verified in the caller function. So we KNOW either side can process the minimum, at least</span>
            <span class="comment">// based on the authorization in the offers (not necessarily in the accounts themselves, though they are </span>
            <span class="comment">// SUPPOSED to have enough funds to cover it...)</span>
            <span class="comment">//</span>
            <span class="comment">// Next question is: can both sides process the MOST AVAILABLE? If so, do THAT, instead of processing by rounds.</span>
            
            <span class="keyword">const</span> int64_t lOverallMultiplier = lMostAvailable / <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(); <span class="comment">// Price is per scale  // This line was commented with the line below it. They go together.</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Why theOtherOffer&#39;s price limit instead of theOffer&#39;s? See notes top/bottom this function.</span>
            <span class="keyword">const</span> int64_t lMostPrice = ( lOverallMultiplier * theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() );
            <span class="comment">// TO REMOVE MULTIPLIER FROM PRICE, AT LEAST THE ABOVE LINE WOULD REMOVE MULTIPLIER.</span>
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// To avoid rounds, first I see if I can satisfy the entire order at once on either side...</span>
            <span class="keywordflow">if</span> ((pAssetAccountToDebit   -&gt;GetBalance() &gt;= lMostAvailable) &amp;&amp;
                (pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &gt;= lMostPrice)
                )
            {   <span class="comment">// There&#39;s enough the accounts to do it all at once! No need for rounds.</span>
                
                lMinIncrementPerRound   = lMostAvailable;
                lPrice                  = lMostPrice;
                
                <span class="comment">// By setting the ABOVE two values the way that I did, it means the below loop</span>
                <span class="comment">// will execute properly, BUT ONLY ITERATING ONCE. Basically this section of</span>
                <span class="comment">// code just optimizes that loop when possible by allowing it to execute</span>
                <span class="comment">// only once.</span>
            }
            <span class="comment">// ----------------------------------------------------------------------------</span>
            <span class="comment">// Otherwise, I go ahead and process it in rounds, by minimum increment...</span>
            <span class="comment">// (Since the funds ARE supposed to be there to process the whole thing, I COULD</span>
            <span class="comment">// choose to cancel the offender right now! I might put an extra fee in this loop or</span>
            <span class="comment">// just remove it. The software would still be functional, it would just enforce the</span>
            <span class="comment">// account having enough funds to cover the full offer at all times--if it wants to</span>
            <span class="comment">// trade at all.)</span>
            
            <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
            
            int64_t lOfferFinished      = 0,
                 lOtherOfferFinished = 0, <span class="comment">// We store these up and then add the totals to the offers at the end (only upon success.)</span>
                 lTotalPaidOut       = 0; <span class="comment">// However much is paid for the assets, total.</span>
            
            <span class="comment">// Continuing the example from above, each round I will trade:</span>
            <span class="comment">//      50 oz lMinIncrementPerRound, in return for $65,000 lPrice.</span>
            <span class="keywordflow">while</span> ((lMinIncrementPerRound   &lt;= (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()-lOfferFinished))          &amp;&amp;  <span class="comment">// The primary offer has at least 50 available to trade (buy OR sell)</span>
                   (lMinIncrementPerRound   &lt;= (theOtherOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()-lOtherOfferFinished))&amp;&amp;  <span class="comment">// The other offer has at least 50 available for trade also.</span>
                   (lMinIncrementPerRound   &lt;= pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>())                      &amp;&amp;  <span class="comment">// Asset Acct to be debited has at least 50 available.</span>
                   (lPrice                  &lt;= pCurrencyAccountToDebit-&gt;GetBalance()) )                     <span class="comment">// Currency Acct to be debited has at least 65000 available.</span>
            {
                <span class="comment">// Within this block, the offer is authorized on both sides, and there is enough in</span>
                <span class="comment">// each of the relevant accounts to cover the round, (for SURE.) So let&#39;s DO it.</span>
                
                bMove1 = pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lMinIncrementPerRound);            
                bMove2 = pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a893c8f197912e9270495f960804b7a5f">Debit</a>(lPrice);
                
                bMove3 = pAssetAccountToCredit-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lMinIncrementPerRound);      
                bMove4 = pCurrencyAccountToCredit-&gt;<a class="code" href="class_o_t_account.html#a9ae37832775933112ad874a9a9110c8b">Credit</a>(lPrice);      
                
                <span class="comment">// If ANY of these failed, then roll them all back and break.</span>
                <span class="keywordflow">if</span> (!bMove1 || !bMove2 || !bMove3 || !bMove4)
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Very strange! Funds were available, yet debit or credit failed while performing trade. &quot;</span>
                                 <span class="stringliteral">&quot;Attempting rollback!\n&quot;</span>);
                    <span class="comment">// We won&#39;t save the files anyway, if this failed. So the rollback is actually superfluous but somehow worthwhile.</span>
                    <a class="code" href="_o_t_market_8cpp.html#abbc90643987323e470c2d23f8de34193">rollback_four_accounts</a>(*pAssetAccountToDebit,       bMove1, lMinIncrementPerRound, 
                                           *pCurrencyAccountToDebit,    bMove2, lPrice, 
                                           *pAssetAccountToCredit,      bMove3, lMinIncrementPerRound, 
                                           *pCurrencyAccountToCredit,   bMove4, lPrice);
                
                    bSuccess = <span class="keyword">false</span>;
                    <span class="keywordflow">break</span>;
                }
                <span class="comment">// ----------------------------------------------------------------</span>
                <span class="comment">// At this point, we know all the debits and credits were successful (FOR THIS ROUND.)</span>
                <span class="comment">// Also notice that the Trades and Offers have not been changed at all--only the accounts.</span>
                bSuccess = <span class="keyword">true</span>;
                <span class="comment">// ----------------------------------------------------------------</span>
                <span class="comment">// So let&#39;s adjust the offers to reflect this also...</span>
                <span class="comment">// The while() above checks these values in GetAmountAvailable().</span>
                lOfferFinished      += lMinIncrementPerRound;
                lOtherOfferFinished += lMinIncrementPerRound;
                
                lTotalPaidOut       += lPrice;
            }
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// At this point, it has gone god-knows-how-many rounds, (or just one) and then broke out,</span>
            <span class="comment">// with bSuccess=false, OR finished properly when the while() terms were fulfilled, with bSuccess = true.</span>
            <span class="comment">//</span>
            <span class="comment">// My point? If there was a screw-up, EVEN if the rollback was successful, it STILL only rolled-back</span>
            <span class="comment">// the most RECENT round -- There still might have been 20 rounds processed before the break.</span>
            <span class="comment">// (Funds could still have been moved, even if rollback was successful.) THEREFORE, DO NOT SAVE if false.</span>
            <span class="comment">// We only save those accounts if bSuccess == true.  The Rollback is not good enough</span>
            
            <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
            {
                <span class="comment">// ALL of the four accounts involved need to get a receipt of this trade in their inboxes...</span>
                pItem1-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pFirstAssetAcct      </span>
                pItem2-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pFirstCurrencyAcct</span>
                pItem3-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pOtherAssetAcct</span>
                pItem4-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>); <span class="comment">// pOtherCurrencyAcct               </span>

                <span class="comment">// Everytime a trade processes, a receipt is put in each account&#39;s inbox.</span>
                <span class="comment">// This contains a copy of the current trade (which took money from the acct.)</span>
                <span class="comment">//</span>
                <span class="comment">// ==&gt; So I increment the trade count each time before dropping the receipt. (I also use a fresh</span>
                <span class="comment">// transaction number when I put it into the inbox.) That way, the user will never get the same</span>
                <span class="comment">// receipt for the same trade twice. It cannot take funds from his account, without a new trade</span>
                <span class="comment">// count and a new transaction number on a new receipt. Until the user accepts the receipt out</span>
                <span class="comment">// of his inbox with a new balance agreement, the existing receipts can be added up and compared</span>
                <span class="comment">// to the last balance agreement, to verify the current balance. Every receipt from a processing</span>
                <span class="comment">// trade will have the user&#39;s authorization, signature, and terms, as well as the update in balances</span>
                <span class="comment">// due to the trade, signed by the server.</span>
                
                theTrade    .<a class="code" href="class_o_t_trade.html#acc7070bba01b1e1b9dcadf1bb880083c">IncrementTradesAlreadyDone</a>();
                pOtherTrade-&gt;<a class="code" href="class_o_t_trade.html#acc7070bba01b1e1b9dcadf1bb880083c">IncrementTradesAlreadyDone</a>();
                
                theOffer     .<a class="code" href="class_o_t_offer.html#a3074fd63f4efd160d36d7a40e6b90852">IncrementFinishedSoFar</a>(lOfferFinished);      <span class="comment">// I was storing these up in the loop above.</span>
                theOtherOffer.<a class="code" href="class_o_t_offer.html#a3074fd63f4efd160d36d7a40e6b90852">IncrementFinishedSoFar</a>(lOtherOfferFinished); <span class="comment">// I was storing these up in the loop above.</span>
            
                <span class="comment">// These have updated values, so let&#39;s save them.</span>
                theTrade.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theTrade.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theTrade.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pOtherTrade-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                theOffer.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theOffer.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theOffer.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                theOtherOffer.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theOtherOffer.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theOtherOffer.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                
                <span class="comment">// -----------------------------------------------------------</span>
                
                m_lLastSalePrice = theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>(); <span class="comment">// Priced per scale.</span>
                
                <span class="comment">// -----------------------------------------------------------</span>
                <span class="comment">// Here we save this trade in a list of the most recent 50 trades.</span>
                {
                    <span class="keywordflow">if</span> (NULL == m_pTradeList)
                    {
                        m_pTradeList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>));
                    }
                    <span class="comment">// ----------------------------------------------------------------</span>
                    <a class="code" href="class_o_t_d_b_1_1_trade_data_market.html">OTDB::TradeDataMarket</a> * pTradeData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_data_market.html">OTDB::TradeDataMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82adda8d82429f1fc73e0ce76464532b05d">OTDB::STORED_OBJ_TRADE_DATA_MARKET</a>));
                    <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeDataMarket&gt;</a> theDataAngel(*pTradeData);
                    <span class="comment">// --------------------------------------------</span>
                    <span class="keyword">const</span> int64_t &amp; lTransactionNum = theOffer.<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>();
                    <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> theDate         = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>();
                    <span class="keyword">const</span> int64_t &amp; lPriceLimit     = theOtherOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>(); <span class="comment">// Priced per scale.</span>
                    <span class="keyword">const</span> int64_t &amp; lAmountSold     = lOfferFinished;
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a05f595532ff4d68296d037278eb9667c">transaction_id</a> = to_string&lt;int64_t&gt;(lTransactionNum);
                    pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a37ffb91335f3f2a17ecfa977c33a87cd">date</a>           = to_string&lt;time64_t&gt;(theDate);
                    pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#adf3ccb40b8b57663ece8864b72e50127">price</a>          = to_string&lt;int64_t&gt;(lPriceLimit);
                    pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#ac0ab38ef41c6ab1b1082902f8ab38aea">amount_sold</a>    = to_string&lt;int64_t&gt;(lAmountSold);
                    <span class="comment">// ------------------------------------------------------</span>
                    m_strLastSaleDate = pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_market.html#a37ffb91335f3f2a17ecfa977c33a87cd">date</a>;
                    <span class="comment">// ------------------------------------------------------</span>
                    <span class="comment">// *pTradeData is CLONED at this time (I&#39;m still responsible to delete.)</span>
                    <span class="comment">// That&#39;s also why I add it here, after all the above: So the data is set right BEFORE the cloning occurs.</span>
                    <span class="comment">//</span>
                    m_pTradeList-&gt;AddTradeDataMarket(*pTradeData);
                    
                    <span class="comment">// Here we erase the oldest elements so the list never exceeds 50 elements total.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">while</span> (m_pTradeList-&gt;GetTradeDataMarketCount() &gt; <a class="code" href="_o_t_market_8hpp.html#ad3557119e36c729a56ea7448245c116a">MAX_MARKET_QUERY_DEPTH</a>)
                        m_pTradeList-&gt;RemoveTradeDataMarket(0);
                }       
                <span class="comment">// -------------------------------------------------------------</span>
                <span class="comment">// Account balances have changed based on these trades that we just processed.</span>
                <span class="comment">// Make sure to save the Market since it contains those offers that have just updated.</span>
                <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>();
                
                <span class="comment">// The Trade has changed, and it is stored as a CronItem. So I save Cron as well, for</span>
                <span class="comment">// the same reason I saved the Market.</span>
                pCron-&gt;<a class="code" href="class_o_t_cron.html#a24df32b4bf36e48867e7afda0955bb72">SaveCron</a>();
            }
            
            <span class="comment">// -----------------------------------------------------------------</span>
            <span class="comment">//</span>
            <span class="comment">// EVERYTHING BELOW is just about notifying the users, by dropping the receipt in their</span>
            <span class="comment">// inboxes. </span>
            <span class="comment">//</span>
            <span class="comment">// (The Trade, Offer, Cron, and Market are ALL updated and SAVED as of this point.)</span>
            <span class="comment">//</span>
            <span class="comment">// -----------------------------------------------------------------</span>
            <span class="comment">// The TRANSACTION will be sent with &quot;In Reference To&quot; information containing the</span>
            <span class="comment">// ORIGINAL SIGNED TRADE (which includes the ORIGINAL SIGNED OFFER inside of it.)</span>
            <span class="comment">//</span>
            <span class="comment">// Whereas the TRANSACTION ITEM includes a &quot;Note&quot; containing the UPDATED TRADE, </span>
            <span class="comment">// (with the SERVER&#39;s SIGNATURE) as well as an &quot;attachment&quot; containing the UPDATED</span>
            <span class="comment">// OFFER (again, with the server&#39;s signature on it.)</span>
            
            <span class="comment">// I was doing this above, but had to move it all down here, since the Trade</span>
            <span class="comment">//  and Offer have just finally been updated to their final values...</span>
            
            <span class="comment">// Here I make sure that each trader&#39;s receipt (each inbox notice) references the</span>
            <span class="comment">// transaction number that the trader originally used to issue the trade...</span>
            <span class="comment">// This number is used to match up offers to trades, and used to track all cron items.</span>
            <span class="comment">// (All Cron items require a transaction from the user to add them to Cron in the</span>
            <span class="comment">// first place.)</span>
            <span class="comment">// </span>
            pTrans1-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
            pTrans2-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
            pTrans3-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
            pTrans4-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());

            <span class="comment">// Then, I make sure the Reference string on the Transaction contains the </span>
            <span class="comment">// ORIGINAL TRADE (with the TRADER&#39;s SIGNATURE ON IT!) For both traders.</span>
            
            <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pOrigTrade         = NULL;
            <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pOrigOtherTrade    = NULL;
            
            <span class="comment">// OTCronItem::LoadCronReceipt loads the original version with the user&#39;s signature.</span>
            <span class="comment">// (Updated versions, as processing occurs, are signed by the server.)</span>
            pOrigTrade      = <a class="code" href="class_o_t_cron_item.html#a368603ca2196ecb8817d42a24138f5d7">OTCronItem::LoadCronReceipt</a>(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
            pOrigOtherTrade = <a class="code" href="class_o_t_cron_item.html#a368603ca2196ecb8817d42a24138f5d7">OTCronItem::LoadCronReceipt</a>(pOtherTrade-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
            
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOrigTrade);
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOrigOtherTrade);
            
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pOrigTrade-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pFirstNym), 
                          <span class="stringliteral">&quot;Signature was already verified on Trade when first added to market, but now it fails.\n&quot;</span>);
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pOrigOtherTrade-&gt;VerifySignature(*pOtherNym), 
                          <span class="stringliteral">&quot;Signature was already verified on Trade when first added to market, but now it fails.\n&quot;</span>);
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// I now have String copies (PGP-signed XML files) of the original Trade requests...</span>
            <span class="comment">// Plus I know they were definitely signed by the Nyms (even though that was already</span>
            <span class="comment">// verified when they were first added to the market--and they have been signed by the</span>
            <span class="comment">// server nym ever since.)</span>
            <a class="code" href="class_o_t_string.html">OTString</a> strOrigTrade(*pOrigTrade), strOrigOtherTrade(*pOrigOtherTrade);
            
            <span class="comment">// The reference on the transaction contains OTCronItem, in this case.</span>
            <span class="comment">// The original trade for each party, versus the updated trade (which is stored</span>
            <span class="comment">// on the marketReceipt item just below here.)</span>
            <span class="comment">//</span>
            pTrans1-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigTrade);
            pTrans2-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigTrade);
            pTrans3-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigOtherTrade);
            pTrans4-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strOrigOtherTrade);
            
            <span class="comment">// Make sure to clean these up.</span>
            <span class="comment">// TODO: Run a scanner on the code for memory leaks and buffer overflows.</span>
            <span class="keyword">delete</span> pOrigTrade; pOrigTrade = NULL;
            <span class="keyword">delete</span> pOrigOtherTrade; pOrigOtherTrade = NULL;
            <span class="comment">// -----------------------------------------------------------------</span>
            <span class="comment">// Here&#39;s where the item stores the UPDATED TRADE (in its Note)</span>
            <span class="comment">// and the UPDATED OFFER (in its attachment) with the SERVER&#39;s SIGNATURE</span>
            <span class="comment">// on both.</span>
            <span class="comment">// (As a receipt for each trader, so they can see their offer updating.)</span>

            <span class="comment">// Lucky I just signed and saved these trades / offers above, or they would </span>
            <span class="comment">// still have the old data in them.</span>
            <a class="code" href="class_o_t_string.html">OTString</a>    strTrade(theTrade), strOtherTrade(*pOtherTrade), 
                        strOffer(theOffer), strOtherOffer(theOtherOffer);

            <span class="comment">// The marketReceipt ITEM&#39;s NOTE contains the UPDATED TRADE.</span>
            <span class="comment">//</span>
            pItem1-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strTrade);
            pItem2-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strTrade);
            pItem3-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strOtherTrade);
            pItem4-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strOtherTrade);
            
            <span class="comment">/*</span>
<span class="comment">             </span>
<span class="comment">             NOTE, todo: Someday, need to reverse these, so that the updated Trade is stored in </span>
<span class="comment">             the attachment, and the updated offer is stored in the note. This is much more consistent</span>
<span class="comment">             with other cron receipts, such as paymentReceipt, and finalReceipt. Unfortunately,</span>
<span class="comment">             marketReceipt is already implemented the opposite of these, but I will fix it someday just</span>
<span class="comment">             for consistency. See large notes 2/3rds of the way down in OTTrade::onFinalReceipt().</span>
<span class="comment">             </span>
<span class="comment">             Todo security: really each receipt should contain a copy of BOTH (asset+currency) so</span>
<span class="comment">             the user can calculate the sale price and compare it to the terms on the original offer.</span>
<span class="comment">             */</span>
            
            <span class="comment">// Also set the ** UPDATED OFFER ** as the ATTACHMENT on the ** item.** </span>
            <span class="comment">// (With the SERVER&#39;s signature on it!)</span>
            <span class="comment">// (As a receipt for each trader, so they can see their offer updating.)</span>
            pItem1-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOffer);
            pItem2-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOffer);
            pItem3-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOtherOffer);
            pItem4-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strOtherOffer);
            <span class="comment">// ----------------------------------------------------------------</span>
            <span class="comment">// Inbox receipts need to clearly show the AMOUNT moved...</span>
            <span class="comment">// Also need to clearly show negative or positive, since that</span>
            <span class="comment">// is otherwise not obvious just because you have a marketReceipt...</span>
            <span class="comment">// </span>
            <span class="comment">// The AMOUNT is stored on the marketReceipt ITEM, on the item list for</span>
            <span class="comment">// the marketReceipt TRANSACTION.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()) <span class="comment">// I&#39;m selling, he&#39;s buying</span>
            {
                pItem1-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOfferFinished*(-1)); <span class="comment">// first asset</span>
                pItem2-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut);       <span class="comment">// first currency</span>
                pItem3-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOtherOfferFinished); <span class="comment">// other asset</span>
                pItem4-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut*(-1));  <span class="comment">// other currency</span>
            }
            <span class="keywordflow">else</span>    <span class="comment">// I&#39;m buying, he&#39;s selling</span>
            {
                pItem1-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOfferFinished);      <span class="comment">// first asset</span>
                pItem2-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut*(-1));  <span class="comment">// first currency</span>
                pItem3-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lOtherOfferFinished*(-1)); <span class="comment">// other asset</span>
                pItem4-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalPaidOut);       <span class="comment">// other currency</span>
            }
            <span class="comment">// -----------------------------------------------------------------</span>
            <span class="keywordflow">if</span> (<span class="keyword">true</span> == bSuccess)
            {                   
                <span class="comment">// sign the item</span>
                pItem1-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pItem2-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pItem3-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pItem4-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                
                pItem1-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pItem2-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pItem3-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pItem4-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                
                <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
                pTrans1-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem1);
                pTrans2-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem2);
                pTrans3-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem3);
                pTrans4-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem4);
                
                pTrans1-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pTrans2-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pTrans3-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pTrans4-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                
                pTrans1-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pTrans2-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pTrans3-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pTrans4-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                
                <span class="comment">// Here the transactions we just created are actually added to the ledgers.</span>
                theFirstAssetInbox.         AddTransaction(*pTrans1);
                theFirstCurrencyInbox.      AddTransaction(*pTrans2);
                theOtherAssetInbox.         AddTransaction(*pTrans3);
                theOtherCurrencyInbox.      AddTransaction(*pTrans4);
                <span class="comment">// -------------------------------------------------------------------</span>
                <span class="comment">// Release any signatures that were there before (They won&#39;t</span>
                <span class="comment">// verify anymore anyway, since the content has changed.)</span>
                theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                                
                <span class="comment">// Sign all four of them.               </span>
                theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                
                <span class="comment">// Save all four of them internally</span>
                theFirstAssetInbox.     <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                theFirstCurrencyInbox.  <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                theOtherAssetInbox.     <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                theOtherCurrencyInbox.  <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                                
                <span class="comment">// TODO: Better rollback capabilities in case of failures here:</span>
                
                <span class="comment">// Save the four inboxes to storage. (File, DB, wherever it goes.)</span>
                
                pFirstAssetAcct-&gt;       SaveInbox(theFirstAssetInbox);  
                pFirstCurrencyAcct-&gt;    SaveInbox(theFirstCurrencyInbox);
                pOtherAssetAcct-&gt;       SaveInbox(theOtherAssetInbox);  
                pOtherCurrencyAcct-&gt;    SaveInbox(theOtherCurrencyInbox);
                <span class="comment">// -------------------------------------------------------------------</span>
                <span class="comment">// These correspond to the AddTransaction() calls just above.</span>
                <span class="comment">// The actual receipts are stored in separate files now.</span>
                <span class="comment">//</span>
                pTrans1-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theFirstAssetInbox);
                pTrans2-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theFirstCurrencyInbox);
                pTrans3-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theOtherAssetInbox);
                pTrans4-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theOtherCurrencyInbox);
                <span class="comment">// -------------------------------------------------------------------</span>
                <span class="comment">// Save the four accounts.</span>
                pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();    
                pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();    
                pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);  
                pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);  
                pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                pFirstAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
                pFirstCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pOtherAssetAcct-&gt;       <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
                pOtherCurrencyAcct-&gt;    <a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                pFirstAssetAcct-&gt;       SaveAccount();  
                pFirstCurrencyAcct-&gt;    SaveAccount();
                pOtherAssetAcct-&gt;       SaveAccount();  
                pOtherCurrencyAcct-&gt;    SaveAccount();
            }
            <span class="comment">// If money was short, let&#39;s see WHO was short so we can remove his trade.</span>
            <span class="comment">// Also, if money was short, inbox notices only go to the rejectees. </span>
            <span class="comment">// But if success, then notices go to all four inboxes.</span>
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Unable to perform trade in OTMarket::%s\n&quot;</span>, __FUNCTION__);

                <span class="comment">// Let&#39;s figure out which one it was and remove his trade and offer.</span>
                <span class="keywordtype">bool</span>    bFirstTraderIsBroke = <span class="keyword">false</span>,
                        bOtherTraderIsBroke = <span class="keyword">false</span>;
                <span class="comment">// ---------------------------------------------------------------------</span>

                <span class="comment">// Here&#39;s what&#39;s going on here:</span>
                <span class="comment">// &quot;Figure out if this guy was short, or if it was that guy. Send a notice</span>
                <span class="comment">// to the one who got rejected for being short on cash. </span>
                <span class="comment">//</span>
                <span class="comment">// Else NEITHER was short, so delete them both with no notice.</span>
                <span class="comment">//</span>
                <span class="comment">// (After checking both asset accounts, there&#39;s another If statement below where</span>
                <span class="comment">// I repeat this process for the currency accounts as well.) </span>
                <span class="comment">//</span>
                <span class="comment">// This whole section occurs because even though the trade and offer were valid</span>
                <span class="comment">// and good to go, at least one of the four accounts was short of funds.</span>
                <span class="comment">// </span>
                <span class="keywordflow">if</span> (pAssetAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lMinIncrementPerRound)
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a>          * pTempItem         = NULL;
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a>   * pTempTransaction  = NULL;
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a>        * pTempInbox        = NULL;

                    <span class="keywordflow">if</span> (pAssetAccountToDebit == pFirstAssetAcct)
                    {   pTempItem           = pItem1;   bFirstTraderIsBroke = <span class="keyword">true</span>; 
                        pTempTransaction    = pTrans1;  pTempInbox = &amp;theFirstAssetInbox; 
                        
                        <span class="keyword">delete</span> pItem3;  pItem3  = NULL;
                        <span class="keyword">delete</span> pTrans3; pTrans3 = NULL;
                    }
                    <span class="keywordflow">else</span> <span class="comment">// it&#39;s the other asset account</span>
                    {   pTempItem           = pItem3;   bOtherTraderIsBroke = <span class="keyword">true</span>; 
                        pTempTransaction    = pTrans3;  pTempInbox = &amp;theOtherAssetInbox; 
                        
                        <span class="keyword">delete</span> pItem1;  pItem1  = NULL;
                        <span class="keyword">delete</span> pTrans1; pTrans1 = NULL;
                    }
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>);
                    pTempItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);                   
                    pTempItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pTempItem);
                    pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                    pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTempTransaction);
                    
                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pTempInbox);
                }
                <span class="keywordflow">else</span>
                {
                    <span class="keyword">delete</span> pItem1;  pItem1  = NULL;
                    <span class="keyword">delete</span> pTrans1; pTrans1 = NULL;
                    <span class="keyword">delete</span> pItem3;  pItem3  = NULL;
                    <span class="keyword">delete</span> pTrans3; pTrans3 = NULL;
                }
                <span class="comment">// ---------------------------------------------------------------------</span>
                <span class="comment">// This section is identical to the one above, except for the currency accounts.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (pCurrencyAccountToDebit-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lPrice)
                {
                    <a class="code" href="class_o_t_item.html">OTItem</a>          * pTempItem         = NULL;
                    <a class="code" href="class_o_t_transaction.html">OTTransaction</a>   * pTempTransaction  = NULL;
                    <a class="code" href="class_o_t_ledger.html">OTLedger</a>        * pTempInbox        = NULL;

                    <span class="keywordflow">if</span> (pCurrencyAccountToDebit == pFirstCurrencyAcct)
                    {   pTempItem           = pItem2;   bFirstTraderIsBroke = <span class="keyword">true</span>; 
                        pTempTransaction    = pTrans2;  pTempInbox = &amp;theFirstCurrencyInbox; 
                        
                        <span class="keyword">delete</span> pItem4;  pItem4  = NULL;
                        <span class="keyword">delete</span> pTrans4; pTrans4 = NULL;
                    }
                    <span class="keywordflow">else</span> <span class="comment">// it&#39;s the other asset account</span>
                    {   pTempItem           = pItem4;   bOtherTraderIsBroke = <span class="keyword">true</span>; 
                        pTempTransaction    = pTrans4;  pTempInbox = &amp;theOtherCurrencyInbox; 
                        
                        <span class="keyword">delete</span> pItem2;  pItem2  = NULL;
                        <span class="keyword">delete</span> pTrans2; pTrans2 = NULL;
                    }
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempItem-&gt;<a class="code" href="class_o_t_item.html#a789aa4148a0add3092e16c4221bf5844">SetStatus</a>(<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>);
                    pTempItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);                   
                    pTempItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pTempItem);
                    pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                    pTempTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTempTransaction);

                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pServerNym);
                    pTempInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
                    pTempInbox-&gt;<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
                    <span class="comment">// ----------------------------------------------------------------</span>
                    pTempTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pTempInbox);
                }
                <span class="keywordflow">else</span> 
                {
                    <span class="keyword">delete</span> pItem2;  pItem2  = NULL;
                    <span class="keyword">delete</span> pTrans2; pTrans2 = NULL;
                    <span class="keyword">delete</span> pItem4;  pItem4  = NULL;
                    <span class="keyword">delete</span> pTrans4; pTrans4 = NULL;
                }
                <span class="comment">// ---------------------------------------------------------------------</span>
                <span class="comment">// If either trader is broke, we flag the trade for removal.</span>
                <span class="comment">// No other trades will process against it and it will be removed from market soon.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bFirstTraderIsBroke)
                    theTrade.<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
                <span class="keywordflow">if</span> (bOtherTraderIsBroke)
                    pOtherTrade-&gt;<a class="code" href="class_o_t_cron_item.html#a34c87380d2f8cd419c9a5cfec86427b4">FlagForRemoval</a>();
                <span class="comment">// ----------------------------------------------------------------</span>
            } <span class="comment">// success == false</span>
        } <span class="comment">// all four boxes were successfully loaded or generated.</span>
    } <span class="comment">// &quot;this entire function can be divided...&quot;</span>
    
    <a class="code" href="_o_t_market_8cpp.html#a21e0b8e0da6ca6ce1b205b212f7582d9">cleanup_four_accounts</a>(pFirstAssetAcct, pFirstCurrencyAcct, pOtherAssetAcct, pOtherCurrencyAcct);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0814323a286be01f0b69b2b24b8030f3"></a><!-- doxytag: member="OTMarket::ProcessTrade" ref="a0814323a286be01f0b69b2b24b8030f3" args="(OTTrade &amp;theTrade, OTOffer &amp;theOffer)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">OTMarket::ProcessTrade</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_trade.html">OTTrade</a> &amp;&#160;</td>
          <td class="paramname"><em>theTrade</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;&#160;</td>
          <td class="paramname"><em>theOffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02097">2097</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>() &lt; theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTMarket::%s: Removing offer from market. (Amount Available is less than Min Increment.)\n&quot;</span>,
                       __FUNCTION__);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// --------------------------------------------------</span>
    int64_t lRelevantPrice = 0;
    
    <span class="comment">// If I&#39;m trying to SELL something, then I care about the highest bidder.</span>
    <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>())
        lRelevantPrice = <a class="code" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">GetHighestBidPrice</a>();
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// ...But if I&#39;m trying to BUY something, then I care about the lowest ask price.</span>
    <span class="keywordflow">else</span>
        lRelevantPrice = <a class="code" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">GetLowestAskPrice</a>();
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// If there were no relevant offers (or if they were all market orders, aka: 0 == lRelevantPrice),</span>
    <span class="comment">// AND if *I* am a market order, then REMOVE me from the market. (Market orders only process once,</span>
    <span class="comment">// so if we are processing here and we haven&#39;t found any potential matches, we&#39;re REMOVED.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> ((0 == lRelevantPrice) &amp;&amp; theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>()) <span class="comment">// Market order has 0 price.</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    <span class="comment">// --------------------------------------------------</span>
    <span class="comment">// If there were no bids/asks (whichever is relevant to this trade) on the market at ALL,</span>
    <span class="comment">// then lRelevant price will be 0 at this point. In which case we&#39;re DONE.</span>
    <span class="comment">//</span>
    <span class="comment">// If I&#39;m selling, and the highest bid is less than my price limit, then we&#39;re DONE.</span>
    <span class="comment">// If I&#39;m buying, and the lowest ask price is higher than my price limit, then we&#39;re DONE.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> ((0 == lRelevantPrice) || <span class="comment">// If 0, we KNOW we&#39;re not a market order, since we would have returned already (above.)</span>
        
        <span class="comment">// We only care about price-based restrictions if we&#39;re a limit order.</span>
        <span class="comment">// (Market orders don&#39;t care about price, so they skip this condition.)</span>
        
        (   theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>() &amp;&amp;
            (
                (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>()   &amp;&amp; (lRelevantPrice &lt; theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) ||
                (theOffer.<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>()   &amp;&amp; (lRelevantPrice &gt; theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>()))
            )
        )
    )
    {
        <span class="comment">// There is nothing on the market currently within my price limits.</span>
        <span class="comment">// We&#39;re DONE. (For now.)</span>
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
    <span class="comment">// ------------------------------------------------------------------------------</span>
    <span class="comment">// If I got this far, that means there ARE bidders or sellers (whichever the current trade cares about)</span>
    <span class="comment">// in the market WITHIN THIS TRADE&#39;S PRICE LIMITS. So we&#39;re going to go up the list of what&#39;s available, and trade.</span>
    
    <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a02ce6c6b5157d083b06679989877b4f4">IsAsk</a>())   <span class="comment">// If I&#39;m selling,</span>
    {                       
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pBid = NULL; <span class="comment">// then I want to start at the highest bidder and loop DOWN until hitting my price limit.</span>
        
        <span class="comment">// rbegin puts us on the upper bound of the highest bidder (any new bidders at the same price would</span>
        <span class="comment">// be added at the lower bound, where they are last in line.) The upper bound, on the other hand, is</span>
        <span class="comment">// first in line.  So we start there, and loop backwards until there are no other bids within my price range.</span>
        <span class="keywordflow">for</span> (mapOfOffers::reverse_iterator rr = m_mapBids.rbegin(); 
             rr != m_mapBids.rend(); 
             rr++)
        {       
            pBid = (*rr).second;
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBid);
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// NOTE: Market orders only process once, and they are processed in</span>
            <span class="comment">// the order they were added to the market.</span>
            <span class="comment">//</span>
            <span class="comment">// If BOTH offers are market orders, we just skip this bid.</span>
            <span class="comment">//</span>
            <span class="comment">// But FURTHERMORE: We ONLY process a market order as theOffer, not as pBid!</span>
            <span class="comment">// Imagine if pBid is a market order and theOffer isn&#39;t -- that would mean pBid</span>
            <span class="comment">// hasn&#39;t been processed yet (since it will only process once.) So it needs to</span>
            <span class="comment">// wait its turn! It will get its one shot WHEN ITS TURN comes.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (                            pBid-&gt;<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
<span class="comment">//          if (theOffer.IsMarketOrder() &amp;&amp; pBid-&gt;IsMarketOrder())</span>
<span class="comment">//              continue;</span>
                <span class="keywordflow">break</span>;
            <span class="comment">// NOTE: Why break, instead of continue? Because since we are looping through the bids,</span>
            <span class="comment">// from the HIGHEST down to the LOWEST, and since market orders have a ZERO price, we know</span>
            <span class="comment">// for a fact that there are not any other non-zero bids. (So we might as well break.)</span>
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// I&#39;m selling.</span>
            <span class="comment">//</span>
            <span class="comment">// If the bid is larger than, or equal to, my low-side-limit,</span>
            <span class="comment">// and the amount available is at least my minimum increment, (and vice versa),</span>
            <span class="comment">// ...then let&#39;s trade!</span>
            <span class="comment">// </span>
            <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>() || <span class="comment">// If I don&#39;t care about price...</span>
                (pBid-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) <span class="comment">// Or if this bid is within my price range...</span>
            {
                <span class="comment">// Notice the above &quot;if&quot; is ONLY based on price... because the &quot;else&quot; returns!</span>
                <span class="comment">// (Once I am out of my price range, no point to continue looping.)</span>
                <span class="comment">//</span>
                <span class="comment">// ...So all the other &quot;if&quot;s have to go INSIDE the block here:</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> ((pBid-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()     &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>()) &amp;&amp;
                    (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()  &gt;= pBid-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())    &amp;&amp;
                    (NULL != pBid-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()) &amp;&amp; !pBid-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()-&gt;<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>())
                    <span class="comment">// ------------------------------------</span>
                    <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">ProcessTrade</a>(theTrade, theOffer, *pBid); <span class="comment">// &lt;========</span>
            }
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// Else, the bid is lower than I am willing to sell. (And all the remaining bids are even lower.)</span>
            <span class="comment">//</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>())
            {
                pBid = NULL;
                <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on cron for more processing (for now.)</span>
            }
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// The offer has no more trading to do--it&#39;s done.</span>
            <span class="keywordflow">if</span> (theTrade.<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>() || <span class="comment">// during processing, the trade may have gotten flagged.</span>
                (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()))
                <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove this trade from cron</span>

            pBid = NULL;
        }
    }
    <span class="comment">// I&#39;m buying</span>
    <span class="keywordflow">else</span> 
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pAsk = NULL; <span class="comment">// then I want to start at the lowest seller and loop UP until hitting my price limit.</span>
        
        <span class="comment">// Begin puts us on the lower bound of the lowest seller (any new sellers at the same price would</span>
        <span class="comment">// be added at the upper bound for that price, where they are last in line.) The lower bound, on the other hand, is</span>
        <span class="comment">// first in line.  So we start there, and loop forwards until there are no other asks within my price range.</span>
        <span class="comment">//</span>
        <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
        {       
            pAsk = (*it).second;
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAsk);
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// NOTE: Market orders only process once, and they are processed in</span>
            <span class="comment">// the order they were added to the market.</span>
            <span class="comment">//</span>
            <span class="comment">// If BOTH offers are market orders, we just skip this ask.</span>
            <span class="comment">//</span>
            <span class="comment">// But FURTHERMORE: We ONLY process a market order as theOffer, not as pAsk!</span>
            <span class="comment">// Imagine if pAsk is a market order and theOffer isn&#39;t -- that would mean pAsk</span>
            <span class="comment">// hasn&#39;t been processed yet (since it will only process once.) So it needs to</span>
            <span class="comment">// wait its turn! It will get its one shot WHEN ITS TURN comes.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (                            pAsk-&gt;<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
<span class="comment">//          if (theOffer.IsMarketOrder() &amp;&amp; pAsk-&gt;IsMarketOrder())</span>
                <span class="keywordflow">continue</span>;
            <span class="comment">// ---------------------------------------------------</span>
            <span class="comment">// I&#39;m buying.</span>
            <span class="comment">// If the ask price is less than, or equal to, my price limit,</span>
            <span class="comment">// and the amount available for purchase is at least my minimum increment, (and vice versa),</span>
            <span class="comment">// ...then let&#39;s trade!</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>() || <span class="comment">// If I don&#39;t care about price...</span>
                (pAsk-&gt;<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>() &lt;= theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>())) <span class="comment">// Or if this ask is within my price range...</span>
            {
                <span class="comment">// Notice the above &quot;if&quot; is ONLY based on price... because the &quot;else&quot; returns!</span>
                <span class="comment">// (Once I am out of my price range, no point to continue looping.)</span>
                <span class="comment">// So all the other &quot;if&quot;s have to go INSIDE the block here:</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> ((pAsk-&gt;<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()     &gt;= theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())  &amp;&amp;
                    (theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()  &gt;= pAsk-&gt;<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>())     &amp;&amp;
                    (NULL != pAsk-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()) &amp;&amp; !pAsk-&gt;<a class="code" href="class_o_t_offer.html#a7a0fff6b95d5ccbcdd8add98f3b394b9">GetTrade</a>()-&gt;<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>())
                    <span class="comment">// ------------------------------------</span>
                    <a class="code" href="class_o_t_market.html#a6979d1c25675e7f25e3b1ae4cfc546a1">ProcessTrade</a>(theTrade, theOffer, *pAsk); <span class="comment">// &lt;=======</span>
            }
            <span class="comment">// Else, the ask price is higher than I am willing to pay. (And all the remaining sellers are even HIGHER.)</span>
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a34659ad80f42b6375f8316fc493ce993">IsLimitOrder</a>())
            {
                pAsk = NULL;
                <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on the market for now.</span>
            }
            <span class="comment">// -------------------------------------------------</span>
            <span class="comment">// The offer has no more trading to do--it&#39;s done.</span>
            <span class="keywordflow">if</span> (theTrade.<a class="code" href="class_o_t_cron_item.html#a5fd32eb6600ee9740e5e99acebcaa2d8">IsFlaggedForRemoval</a>() || <span class="comment">// during processing, the trade may have gotten flagged.</span>
                (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>()))
                <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove this trade from the market.</span>
            
            pAsk = NULL;
        }       
    }
    <span class="comment">// --------------------------------------------------------</span>
    <span class="comment">// Market orders only process once.</span>
    <span class="comment">// (So tell the caller to remove it.)</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#ae5b3bab4ff4fd3b2a0632bc5a7f85ca7">IsMarketOrder</a>())
        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// remove from market.</span>
    <span class="comment">// --------------------------------------------------------</span>
    <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// stay on the market for now.</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3085a94412fee20ffd116dbfdddf2ecc"></a><!-- doxytag: member="OTMarket::ProcessXMLNode" ref="a3085a94412fee20ffd116dbfdddf2ecc" args="(irr::io::IrrXMLReader *&amp;xml)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t <a class="el" href="class_o_t_market.html#a3085a94412fee20ffd116dbfdddf2ecc">OTMarket::ProcessXMLNode</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a> *&amp;&#160;</td>
          <td class="paramname"><em>xml</em></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="class_o_t_contract.html#a48611c37c8e8e7d9125238bda2b77978">OTContract</a>.</p>

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00153">153</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    int32_t nReturnVal = 0;
    
    <span class="comment">// Here we call the parent class first.</span>
    <span class="comment">// If the node is found there, or there is some error,</span>
    <span class="comment">// then we just return either way.  But if it comes back</span>
    <span class="comment">// as &#39;0&#39;, then nothing happened, and we&#39;ll continue executing.</span>
    <span class="comment">//</span>
    <span class="comment">// -- Note you can choose not to call the parent if</span>
    <span class="comment">// you don&#39;t want to use any of those xml tags.</span>
    <span class="comment">// As I do below, in the case of OTAccount.</span>
    <span class="comment">//if (nReturnVal = OTContract::ProcessXMLNode(xml))</span>
    <span class="comment">//  return nReturnVal;</span>
    
    <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;market&quot;</span>, xml-&gt;getNodeName())) 
    {
        <a class="code" href="class_o_t_contract.html#aa0d889e0e1670b56fedca245041a5ed3">m_strVersion</a>        =       xml-&gt;getAttributeValue(<span class="stringliteral">&quot;version&quot;</span>);
        m_lScale            = atol( xml-&gt;getAttributeValue(<span class="stringliteral">&quot;marketScale&quot;</span>));
        m_lLastSalePrice    = atol( xml-&gt;getAttributeValue(<span class="stringliteral">&quot;lastSalePrice&quot;</span>));
        m_strLastSaleDate   =       xml-&gt;getAttributeValue(<span class="stringliteral">&quot;lastSaleDate&quot;</span>);
        <span class="comment">// ---------------------------------------------</span>
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverID&quot;</span>)),
                        strAssetTypeID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;assetTypeID&quot;</span>)),
                        strCurrencyTypeID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;currencyTypeID&quot;</span>));

        m_SERVER_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strServerID);
        m_ASSET_TYPE_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strAssetTypeID);
        m_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(strCurrencyTypeID);
        <span class="comment">// ---------------------------------------------</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nMarket. Scale: %lld\n&quot;</span>, 
                       m_lScale);
        
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,
                       <span class="stringliteral">&quot; assetTypeID: %s\n&quot;</span>
                       <span class="stringliteral">&quot; currencyTypeID: %s\n&quot;</span>
                       <span class="stringliteral">&quot; ServerID: %s\n&quot;</span>,
                       strAssetTypeID.Get(),  strCurrencyTypeID.Get(), 
                       strServerID.Get());
        
        nReturnVal = 1;
    }
    <span class="comment">// ---------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;offer&quot;</span>, xml-&gt;getNodeName())) 
    {
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strDateAdded(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;dateAdded&quot;</span>));
        <span class="keyword">const</span> int64_t    lDateAdded = strDateAdded.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strDateAdded.ToLong() : 0;
        <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     tDateAdded = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(lDateAdded);
        <span class="comment">// ---------------------------------------------</span>
        <a class="code" href="class_o_t_string.html">OTString</a> strData;
        
        <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, strData) || !strData.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error in OTMarket::%s: offer field without value.\n&quot;</span>,
                          __FUNCTION__);
            <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
        }
        <span class="keywordflow">else</span> 
        {
            <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = <span class="keyword">new</span> <a class="code" href="class_o_t_offer.html">OTOffer</a>(m_SERVER_ID, m_ASSET_TYPE_ID, m_CURRENCY_TYPE_ID, m_lScale);
            
            <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
            
            <span class="keywordflow">if</span> (pOffer-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strData) &amp;&amp; 
                <a class="code" href="class_o_t_market.html#a4b79224a7214740015fcc7b1f90fa7e6">AddOffer</a>(NULL, *pOffer, <span class="keyword">false</span>, tDateAdded)) <span class="comment">// bSaveMarket = false (Don&#39;t SAVE -- we&#39;re loading right now!)</span>
            {
                <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Successfully loaded offer and added to market.\n&quot;</span>);
            }
            <span class="keywordflow">else</span> 
            {
                <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error adding offer to market while loading market.\n&quot;</span>);
                <span class="keyword">delete</span> pOffer;
                pOffer = NULL;
                <span class="keywordflow">return</span> (-1);
            }
        }
        
        nReturnVal = 1;
    }
    <span class="comment">// ---------------------------------------------</span>
    <span class="keywordflow">return</span> nReturnVal;      
}
</pre></div>
</div>
</div>
<a class="anchor" id="a052638ef7aebad8f0eaaa148d7e1546f"></a><!-- doxytag: member="OTMarket::Release" ref="a052638ef7aebad8f0eaaa148d7e1546f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a052638ef7aebad8f0eaaa148d7e1546f">OTMarket::Release</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="class_o_t_contract.html#a15e423ca0d650858a23e54f8285feae1">OTContract</a>.</p>

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02448">2448</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">Release_Market</a>(); <span class="comment">// since I&#39;ve overridden the base class, I call it now...</span>
    
    <a class="code" href="class_o_t_contract.html#a15e423ca0d650858a23e54f8285feae1">ot_super::Release</a>(); <span class="comment">// since I&#39;ve overridden the base class, I call it now...</span>

    <span class="comment">// Then I call this to re-initialize everything (just out of convenience. Not always the right move.)</span>
    <a class="code" href="class_o_t_market.html#a13beb1b8b45177445b711259c7f87759">InitMarket</a>();   
}
</pre></div>
</div>
</div>
<a class="anchor" id="a18b3c808caf0c36fe7de7e01af44d32e"></a><!-- doxytag: member="OTMarket::Release_Market" ref="a18b3c808caf0c36fe7de7e01af44d32e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a18b3c808caf0c36fe7de7e01af44d32e">OTMarket::Release_Market</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02416">2416</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    m_ASSET_TYPE_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();  
    m_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();   
    
    m_SERVER_ID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();
    
    <span class="comment">// Elements of this list are cleaned up automatically.</span>
    <span class="keywordflow">if</span> (NULL != m_pTradeList)
    {
        <span class="keyword">delete</span> m_pTradeList; 
        m_pTradeList = NULL;
    }
    
    <span class="comment">// If there were any dynamically allocated objects, clean them up here.</span>
    <span class="keywordflow">while</span> (!m_mapBids.empty())
    {       
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = m_mapBids.begin()-&gt;second;
        m_mapBids.erase(m_mapBids.begin());
        <span class="keyword">delete</span> pOffer;
        pOffer = NULL;
    }
    <span class="keywordflow">while</span> (!m_mapAsks.empty())
    {       
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = m_mapAsks.begin()-&gt;second;
        m_mapAsks.erase(m_mapAsks.begin());
        <span class="keyword">delete</span> pOffer;
        pOffer = NULL;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8c35cf47acba612a33c8aad9a96a0945"></a><!-- doxytag: member="OTMarket::RemoveOffer" ref="a8c35cf47acba612a33c8aad9a96a0945" args="(const int64_t &amp;lTransactionNum)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a8c35cf47acba612a33c8aad9a96a0945">OTMarket::RemoveOffer</a> </td>
          <td>(</td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lTransactionNum</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00657">657</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span> bReturnValue = <span class="keyword">false</span>;
    
    <span class="comment">// See if there&#39;s something there with that transaction number.</span>
    mapOfOffersTrnsNum::iterator ii = m_mapOffers.find(lTransactionNum);
    
    <span class="comment">// If it&#39;s not already on the list, then there&#39;s nothing to remove.</span>
    <span class="keywordflow">if</span> ( ii == m_mapOffers.end() )
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to remove non-existent Offer from Market. Transaction #: %lld\n&quot;</span>,
                      lTransactionNum);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    <span class="comment">// Otherwise, if it WAS already there, remove it properly.</span>
    <span class="keywordflow">else</span> 
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*ii).second;
        
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        <span class="comment">// ---------------------------------------</span>
        <span class="comment">// This removes it from one list (the one indexed by transaction number.)</span>
        <span class="comment">// But it&#39;s still on one of the other lists...</span>
        m_mapOffers.erase(ii);
        
        <span class="comment">// The code operates the same whether ask or bid. Just use a pointer.</span>
        <a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a> * pMap = (pOffer-&gt;<a class="code" href="class_o_t_offer.html#a9e58f962c7d2127b41f7e060e34e5220">IsBid</a>() ? &amp;m_mapBids : &amp;m_mapAsks);
        
        <span class="comment">// Future solution here: instead of looping through all the offers and finding it,</span>
        <span class="comment">// I could just have each Offer store a copy of the iterator that&#39;s returned when</span>
        <span class="comment">// it&#39;s first inserted. Later I just erase that iterator from the right list to remove. Todo.</span>
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pSameOffer = NULL;
        
        <span class="keywordflow">for</span> (mapOfOffers::iterator iii = pMap-&gt;begin(); iii != pMap-&gt;end(); ++iii)
        {   
            pSameOffer = (*iii).second;
            
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pSameOffer, <span class="stringliteral">&quot;NULL offer pointer in OTMarket::RemoveOffer.\n&quot;</span>);
            
            <span class="comment">// found it!</span>
            <span class="keywordflow">if</span> (lTransactionNum == pSameOffer-&gt;<a class="code" href="class_o_t_offer.html#abf98bb358bc9fdefc12ea474d18b6d6c">GetTransactionNum</a>())
            {
                pMap-&gt;erase(iii);
                <span class="keywordflow">break</span>;
            }
            
            <span class="comment">// Later on, below this loop, this pointer will be NULL or not, and I will know if it was removed.</span>
            pSameOffer = NULL;
        }
        <span class="comment">// ---------------------------------------</span>
        <span class="keywordflow">if</span> (NULL == pSameOffer)
        {
            <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Removed Offer from offers list, but not found on bid/ask list.\n&quot;</span>);
        }
        <span class="keywordflow">else</span> <span class="comment">// This means it was found and removed from the second list as well.</span>
        {
            bReturnValue = <span class="keyword">true</span>; <span class="comment">// Success.</span>
        }
        <span class="comment">// ---------------------------------------</span>
        <span class="comment">// pOffer was found on the Offers list.</span>
        <span class="comment">// pSameOffer was found on the Bid or Ask list, with the same transaction ID.</span>
        <span class="comment">// They SHOULD be pointers to the SAME object.</span>
        <span class="comment">// Therefore I CANNOT delete them both.</span>
        <span class="comment">//</span>
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pOffer == pSameOffer);
        
        <span class="keyword">delete</span> pOffer;
        pOffer = NULL;
        pSameOffer = NULL;
    }
    
    <span class="keywordflow">if</span> (bReturnValue)
        <span class="keywordflow">return</span> <a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>(); <span class="comment">// &lt;====== SAVE since an offer was removed.</span>
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="adf9018b289268d0439d92f4176094392"></a><!-- doxytag: member="OTMarket::SaveContractWallet" ref="adf9018b289268d0439d92f4176094392" args="(std::ofstream &amp;ofs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#adf9018b289268d0439d92f4176094392">OTMarket::SaveContractWallet</a> </td>
          <td>(</td>
          <td class="paramtype">std::ofstream &amp;&#160;</td>
          <td class="paramname"><em>ofs</em></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Implements <a class="el" href="class_o_t_contract.html#af16a41ce18a9e3408fc5c9ee18315a30">OTContract</a>.</p>

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02459">2459</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad19e688ee73a7358fe343358ff3e5b8a"></a><!-- doxytag: member="OTMarket::SaveMarket" ref="ad19e688ee73a7358fe343358ff3e5b8a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">OTMarket::SaveMarket</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00864">864</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>());
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym());
    
    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(*<span class="keyword">this</span>);
    <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);

    <span class="comment">// ------------------------------------------------------------------------</span>
    
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = str_MARKET_ID.Get();
        
    <span class="comment">// ------------------------------------------------------------------------</span>
    
    <span class="comment">// Remember, if the market has changed, the new contents will not be written anywhere</span>
    <span class="comment">// until that market has been signed. So I have to re-sign here, or it would just save</span>
    <span class="comment">// the old version of the market from before the most recent changes.</span>
    <a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
    
    <span class="comment">// Sign it, save it internally to string, and then save that out to the file.</span>
    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*(<a class="code" href="class_o_t_market.html#a474e0a63bbc87a1cc667584d3645c0cf">GetCron</a>()-&gt;GetServerNym())) || !<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>() || !<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(szFoldername, szFilename))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving Market:\n%s%s%s\n&quot;</span>, szFoldername,
                      <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
    
    <span class="comment">// ------------------------------------------------------------------------</span>
    <span class="comment">// Save a copy of recent trades.</span>
    
    <span class="keywordflow">if</span> (NULL != m_pTradeList)
    {
        <span class="keyword">const</span> <span class="keywordtype">char</span> * szSubFolder = <span class="stringliteral">&quot;recent&quot;</span>; <span class="comment">// todo stop hardcoding.</span>
        
        <span class="comment">// If this fails, oh well. It&#39;s informational, anyway.</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a394420b02f48d3ebdfebb75d92a4d6dd">OTDB::StoreObject</a>(*m_pTradeList, 
                                       szFoldername,    <span class="comment">// markets</span>
                                       szSubFolder,     <span class="comment">// markets/recent</span>
                                       szFilename))     <span class="comment">// markets/recent/Market_ID</span>
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving recent trades for Market:\n%s%s%s%s%s\n&quot;</span>, szFoldername,
                          <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szSubFolder, <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
    }
    
    <span class="keywordflow">return</span> <span class="keyword">true</span>;    
}
</pre></div>
</div>
</div>
<a class="anchor" id="aeb7ac47e2db2268fcf1beb57df188494"></a><!-- doxytag: member="OTMarket::SetAssetID" ref="aeb7ac47e2db2268fcf1beb57df188494" args="(const OTIdentifier &amp;ASSET_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#aeb7ac47e2db2268fcf1beb57df188494">OTMarket::SetAssetID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>ASSET_ID</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00225">225</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ m_ASSET_TYPE_ID    = ASSET_ID;    }
</pre></div>
</div>
</div>
<a class="anchor" id="afc579c8a9d0eb969ce4cd302701c7c9d"></a><!-- doxytag: member="OTMarket::SetCronPointer" ref="afc579c8a9d0eb969ce4cd302701c7c9d" args="(OTCron &amp;theCron)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#afc579c8a9d0eb969ce4cd302701c7c9d">OTMarket::SetCronPointer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_cron.html">OTCron</a> &amp;&#160;</td>
          <td class="paramname"><em>theCron</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00258">258</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ m_pCron = &amp;theCron; }
</pre></div>
</div>
</div>
<a class="anchor" id="a325c2c8586b616a5176042c039fe1d78"></a><!-- doxytag: member="OTMarket::SetCurrencyID" ref="a325c2c8586b616a5176042c039fe1d78" args="(const OTIdentifier &amp;CURRENCY_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a325c2c8586b616a5176042c039fe1d78">OTMarket::SetCurrencyID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>CURRENCY_ID</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00226">226</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ m_CURRENCY_TYPE_ID = CURRENCY_ID; }
</pre></div>
</div>
</div>
<a class="anchor" id="affa60f256431d3edec9ba1a5067df405"></a><!-- doxytag: member="OTMarket::SetLastSalePrice" ref="affa60f256431d3edec9ba1a5067df405" args="(const int64_t &amp;lLastSalePrice)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#affa60f256431d3edec9ba1a5067df405">OTMarket::SetLastSalePrice</a> </td>
          <td>(</td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lLastSalePrice</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00240">240</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">        { m_lLastSalePrice = lLastSalePrice; <span class="keywordflow">if</span> (m_lLastSalePrice &lt; 1) m_lLastSalePrice = 1; }
</pre></div>
</div>
</div>
<a class="anchor" id="a2aa3115f92ad6c2d93aa476102a1528c"></a><!-- doxytag: member="OTMarket::SetScale" ref="a2aa3115f92ad6c2d93aa476102a1528c" args="(const int64_t &amp;lScale)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a2aa3115f92ad6c2d93aa476102a1528c">OTMarket::SetScale</a> </td>
          <td>(</td>
          <td class="paramtype">const int64_t &amp;&#160;</td>
          <td class="paramname"><em>lScale</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00235">235</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">        { m_lScale = lScale; <span class="keywordflow">if</span> (m_lScale &lt; 1) m_lScale = 1; }
</pre></div>
</div>
</div>
<a class="anchor" id="a1eb641ab3d871856e13060433eedaee7"></a><!-- doxytag: member="OTMarket::SetServerID" ref="a1eb641ab3d871856e13060433eedaee7" args="(const OTIdentifier &amp;SERVER_ID)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a1eb641ab3d871856e13060433eedaee7">OTMarket::SetServerID</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_o_t_identifier.html">OTIdentifier</a> &amp;&#160;</td>
          <td class="paramname"><em>SERVER_ID</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8hpp_source.html#l00227">227</a> of file <a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a>.</p>
<div class="fragment"><pre class="fragment">{ m_SERVER_ID        = SERVER_ID;   }
</pre></div>
</div>
</div>
<a class="anchor" id="a51c01eeeb4dfd00d941efae50af53384"></a><!-- doxytag: member="OTMarket::UpdateContents" ref="a51c01eeeb4dfd00d941efae50af53384" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_o_t_market.html#a51c01eeeb4dfd00d941efae50af53384">OTMarket::UpdateContents</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="class_o_t_contract.html#a78c28164555e2eb79d6b67698421638d">OTContract</a>.</p>

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l00237">237</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// I release this because I&#39;m about to repopulate it.</span>
    <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
    
    <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;?xml version=\&quot;%s\&quot;?&gt;\n\n&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>);
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  SERVER_ID(m_SERVER_ID),
                    ASSET_TYPE_ID(m_ASSET_TYPE_ID),
                    CURRENCY_TYPE_ID(m_CURRENCY_TYPE_ID);
    
    <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;market\n version=\&quot;%s\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; assetTypeID=\&quot;%s\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; currencyTypeID=\&quot;%s\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; marketScale=\&quot;%lld\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; lastSaleDate=\&quot;%s\&quot;\n&quot;</span>
                              <span class="stringliteral">&quot; lastSalePrice=\&quot;%lld\&quot;&quot;</span>
                              <span class="stringliteral">&quot; &gt;\n\n&quot;</span>, 
                              <a class="code" href="class_o_t_contract.html#aa0d889e0e1670b56fedca245041a5ed3">m_strVersion</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
                              SERVER_ID.Get(),
                              ASSET_TYPE_ID.Get(), 
                              CURRENCY_TYPE_ID.Get(),
                              m_lScale,
                              m_strLastSaleDate.c_str(),
                              m_lLastSalePrice);    
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="comment">// Save the offers for sale.</span>
    <span class="comment">//</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapAsks)
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        
        <a class="code" href="class_o_t_string.html">OTString</a> strOffer(*pOffer);     <span class="comment">// Extract the offer contract into string form.</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOffer(strOffer);<span class="comment">// Base64-encode that for storage.</span>
        
        int64_t lDateAddedToMarket = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>());
        
        <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;offer dateAdded=\&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;\&quot;&gt;\n%s&lt;/offer&gt;\n\n&quot;</span>,
                                  lDateAddedToMarket, ascOffer.Get());
    }       
    <span class="comment">// -------------------------------------------------------------</span>
    <span class="comment">// Save the bids.</span>
    <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_market_8hpp.html#ae0998c653ad50322ec76ae0f7cea7e44">mapOfOffers</a>, m_mapBids)
    {
        <a class="code" href="class_o_t_offer.html">OTOffer</a> * pOffer = (*it).second;
        <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOffer);
        
        <a class="code" href="class_o_t_string.html">OTString</a> strOffer(*pOffer);     <span class="comment">// Extract the offer contract into string form.</span>
        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascOffer(strOffer);<span class="comment">// Base64-encode that for storage.</span>
        
        int64_t lDateAddedToMarket = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(pOffer-&gt;<a class="code" href="class_o_t_offer.html#a8e007abb5ee5569d01e0e07ffa54447c">GetDateAddedToMarket</a>());
        
        <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;offer dateAdded=\&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;\&quot;&gt;\n%s&lt;/offer&gt;\n\n&quot;</span>,
                                  lDateAddedToMarket, ascOffer.Get());
    }
    <span class="comment">// -------------------------------------------------------------</span>
    <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;/market&gt;\n&quot;</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a936989bd99daa8c18dff1c28335b5958"></a><!-- doxytag: member="OTMarket::ValidateOfferForMarket" ref="a936989bd99daa8c18dff1c28335b5958" args="(OTOffer &amp;theOffer, OTString *pReason=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_o_t_market.html#a936989bd99daa8c18dff1c28335b5958">OTMarket::ValidateOfferForMarket</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_offer.html">OTOffer</a> &amp;&#160;</td>
          <td class="paramname"><em>theOffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_t_string.html">OTString</a> *&#160;</td>
          <td class="paramname"><em>pReason</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_o_t_market_8cpp_source.html#l02292">2292</a> of file <a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">bool</span>     bValidOffer = <span class="keyword">true</span>;
    <a class="code" href="class_o_t_string.html">OTString</a> strReason(<span class="stringliteral">&quot;&quot;</span>);
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a>() != theOffer.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>());
        strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Server ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>() != theOffer.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>());
        strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Asset ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>() != theOffer.<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>()), strOtherID(theOffer.<a class="code" href="class_o_t_offer.html#a3ab6eabaef2152b2f6971f01b1e51fdd">GetCurrencyID</a>());
        strReason.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Wrong Currency ID on offer. Expected %s, but found %s&quot;</span>, strID.Get(), strOtherID.Get());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>() != theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        strReason.Format(<span class="stringliteral">&quot;Wrong Market Scale on offer. Expected %lld, but found %lld&quot;</span>, <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>(), theOffer.<a class="code" href="class_o_t_offer.html#ab8ecbbe501cfa19e8c0726b815f27a9e">GetScale</a>());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="comment">// The above four items must match in order for it to even be the same MARKET.</span>
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &lt;= 0)
    {
        bValidOffer = <span class="keyword">false</span>;
        strReason.Format(<span class="stringliteral">&quot;Minimum Increment on offer is &lt;= 0: %lld&quot;</span>, theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &lt; <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        strReason.Format(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) is less than market scale (%lld).&quot;</span>,
                         theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() % <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>()) != 0)
    {
        bValidOffer = <span class="keyword">false</span>;
        strReason.Format(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) Mod market scale (%lld) is not equal to zero.&quot;</span>,
                         theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), <a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>() &gt; theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>())
    {
        bValidOffer = <span class="keyword">false</span>;
        strReason.Format(<span class="stringliteral">&quot;Minimum Increment on offer (%lld) is more than the amount of assets available for trade on that same offer (%lld).&quot;</span>,
                         theOffer.<a class="code" href="class_o_t_offer.html#a43ee636aa320ce0b9d834c618fd24588">GetMinimumIncrement</a>(), theOffer.<a class="code" href="class_o_t_offer.html#afff542523f41979765911b1ed941d319">GetAmountAvailable</a>());
    }
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="keywordflow">if</span> (bValidOffer)
        <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(4, <span class="stringliteral">&quot;Offer is valid for market.\n&quot;</span>);
    <span class="keywordflow">else</span>
    {
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Offer is invalid for this market: %s\n&quot;</span>, __FUNCTION__, strReason.Get());
        
        <span class="keywordflow">if</span> (NULL != pReason)
            *pReason = strReason;
    }
    <span class="comment">// -----------------------------------------</span>
    <span class="keywordflow">return</span> bValidOffer;
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/otlib/<a class="el" href="_o_t_market_8hpp_source.html">OTMarket.hpp</a></li>
<li>src/otlib/<a class="el" href="_o_t_market_8cpp_source.html">OTMarket.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_o_t_market.html">OTMarket</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:13 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
