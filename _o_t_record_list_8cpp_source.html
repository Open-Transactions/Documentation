<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otapi/OTRecordList.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_record_list_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otapi/OTRecordList.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_record_list_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *    </span>
<a name="l00003"></a>00003 <span class="comment"> *  OTRecordList.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *  </span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"> </span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"> </span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"> </span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_record_list_8hpp.html">OTRecordList.hpp</a>&gt;</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="preprocessor">#include &lt;<a class="code" href="_open_transactions_8hpp.html">OpenTransactions.hpp</a>&gt;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_a_p_i_8hpp.html">OTAPI.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_a_p_i___exec_8hpp.html">OTAPI_Exec.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_wallet_8hpp.html">OTWallet.hpp</a>&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_8hpp.html">OTPayment.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_account_8hpp.html">OTAccount.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_ledger_8hpp.html">OTLedger.hpp</a>&gt;</span>
<a name="l00145"></a>00145 <span class="preprocessor">#include &lt;<a class="code" href="_o_t___m_e_8hpp.html">OT_ME.hpp</a>&gt;</span>
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_message_8hpp.html">OTMessage.hpp</a>&gt;</span>
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="_o_t_record_list_8cpp.html#a9a031bc983de9083406e8553232f8d03">00152</a> <span class="preprocessor">#define MC_UI_TEXT_TO &quot;To: %s&quot;</span>
<a name="l00153"></a><a class="code" href="_o_t_record_list_8cpp.html#a0a99ba497ae227ce15c324631e524437">00153</a> <span class="preprocessor"></span><span class="preprocessor">#define MC_UI_TEXT_FROM &quot;From: %s&quot;</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>
<a name="l00155"></a>00155 <span class="comment">//#define MC_UI_TEXT_TO &quot;&lt;font color=&#39;grey&#39;&gt;To:&lt;/font&gt; %s&quot;</span>
<a name="l00156"></a>00156 <span class="comment">//#define MC_UI_TEXT_FROM &quot;&lt;font color=&#39;grey&#39;&gt;From:&lt;/font&gt; %s&quot;</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">// -------------------------------------------------------------------------------------------</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="_o_t_record_list_8cpp.html#aec3d6b1b3cfc688e0cab6d9c3566e477">00162</a> <span class="keywordtype">bool</span> <a class="code" href="_o_t_record_list_8hpp.html#a92f17a400e3e049eb266b612e7779caa">OT_API_Set_AddrBookCallback</a>(<a class="code" href="class_o_t_lookup_caller.html">OTLookupCaller</a> &amp; theCaller) <span class="comment">// OTLookupCaller must have OTNameLookup attached already.</span>
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!theCaller.<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>())
<a name="l00165"></a>00165     {
<a name="l00166"></a>00166         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR:\nOTLookupCaller::setCallback() &quot;</span>
<a name="l00167"></a>00167                       <span class="stringliteral">&quot;MUST be called first, with an OTNameLookup-extended class passed to it,\n&quot;</span>
<a name="l00168"></a>00168                       <span class="stringliteral">&quot;before then invoking this function (and passing that OTLookupCaller as a parameter &quot;</span>
<a name="l00169"></a>00169                       <span class="stringliteral">&quot;into this function.)\n&quot;</span>, __FUNCTION__);
<a name="l00170"></a>00170         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172     
<a name="l00173"></a>00173     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: FYI, calling OTRecordList::setAddrBookCaller(theCaller) now... (which is where &quot;</span>
<a name="l00174"></a>00174                    <span class="stringliteral">&quot;OT internally sets its pointer to the Java caller object, which must have been passed in as a &quot;</span>
<a name="l00175"></a>00175                    <span class="stringliteral">&quot;parameter to this function.\n&quot;</span>, __FUNCTION__);
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = <a class="code" href="class_o_t_record_list.html#aae138fffa645482e39d2d838e4124839">OTRecordList::setAddrBookCaller</a>(theCaller);
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: RESULT of call to OTRecordList::setAddrBookCaller: %s&quot;</span>, __FUNCTION__,
<a name="l00180"></a>00180                    bSuccess ? <span class="stringliteral">&quot;SUCCESS&quot;</span> : <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <span class="keywordflow">return</span> bSuccess;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">// ***************************************************</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">// OTNameLookup CLASS</span>
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="class_o_t_name_lookup.html#a9607edba9b6da2a38f93129939b585b9">00189</a> <a class="code" href="class_o_t_name_lookup.html#a9607edba9b6da2a38f93129939b585b9">OTNameLookup::~OTNameLookup</a>()
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <span class="comment">// Note: Though the Java app will instantiate NameLookup once (its own version/subclass of it)</span>
<a name="l00192"></a>00192     <span class="comment">// and pass that instance to C++ so that OTRecordList can make calls to it from inside OT, that</span>
<a name="l00193"></a>00193     <span class="comment">// doesn&#39;t mean that C++ apps like Moneychanger won&#39;t make as many instances as they want. Bottom</span>
<a name="l00194"></a>00194     <span class="comment">// line? No error message necessary here as we have with the password callback.</span>
<a name="l00195"></a>00195     <span class="comment">//</span>
<a name="l00196"></a>00196 <span class="comment">//  OTLog::vError(&quot;OTNameLookup::~OTNameLookup:  &quot;</span>
<a name="l00197"></a>00197 <span class="comment">//                  &quot;(This should only happen ONCE ONLY -- as the application is closing.)\n&quot;);</span>
<a name="l00198"></a>00198 <span class="comment">//  std::cout &lt;&lt; &quot;OTNameLookup::~OTNameLookup()&quot; &lt;&lt; std:: endl;</span>
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="comment">//virtual</span>
<a name="l00202"></a><a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">00202</a> std::string <a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">OTNameLookup::GetNymName</a>(<span class="keyword">const</span> std::string &amp; str_id,
<a name="l00203"></a>00203                                      <span class="keyword">const</span> std::string * p_server_id<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l00204"></a>00204 <span class="keyword"></span>{
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (str_id.empty())
<a name="l00206"></a>00206         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">return</span> <a class="code" href="class_o_t_a_p_i___wrap.html#acb21f65d80ac8f5a1e01ddbd61a01bb4">OTAPI_Wrap::GetNym_Name</a>(str_id);
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">//virtual</span>
<a name="l00212"></a><a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">00212</a> std::string <a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">OTNameLookup::GetAcctName</a>(<span class="keyword">const</span> std::string &amp; str_id,
<a name="l00213"></a>00213                                       <span class="keyword">const</span> std::string * p_nym_id<span class="comment">/*=NULL*/</span>,
<a name="l00214"></a>00214                                       <span class="keyword">const</span> std::string * p_server_id<span class="comment">/*=NULL*/</span>,
<a name="l00215"></a>00215                                       <span class="keyword">const</span> std::string * p_asset_id<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l00216"></a>00216 <span class="keyword"></span>{
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (str_id.empty())
<a name="l00218"></a>00218         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="keywordflow">return</span> <a class="code" href="class_o_t_a_p_i___wrap.html#a18999957d285b958c3f683d3460a0b3f">OTAPI_Wrap::GetAccountWallet_Name</a>(str_id);
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="comment">// ***************************************************</span>
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">// OTLookupCaller CLASS</span>
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="class_o_t_lookup_caller.html#a73c7a673a90cb753952ac7f7de67b696">00227</a> <a class="code" href="class_o_t_lookup_caller.html#a73c7a673a90cb753952ac7f7de67b696">OTLookupCaller::~OTLookupCaller</a>()
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTLookupCaller::~OTLookupCaller: (This should only happen as the application is closing.)\n&quot;</span>);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <a class="code" href="class_o_t_lookup_caller.html#a33f5d6e4d697c098854c1d0735018d90">delCallback</a>();
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">// ------------------------------------------------</span>
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="class_o_t_lookup_caller.html#a33f5d6e4d697c098854c1d0735018d90">00236</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_lookup_caller.html#a33f5d6e4d697c098854c1d0735018d90">OTLookupCaller::delCallback</a>()
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238 <span class="comment">//  if (NULL != _callback)  // TODO this may be a memory leak.</span>
<a name="l00239"></a>00239 <span class="comment">//      delete _callback;   // But I know we&#39;re currently crashing from deleting same object twice.</span>
<a name="l00240"></a>00240     <span class="comment">// And since the object comes from Java, who am I to delete it? Let Java clean it up.</span>
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>())
<a name="l00242"></a>00242         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::delCallback: WARNING: setting existing callback object pointer to NULL. &quot;</span>
<a name="l00243"></a>00243                       <span class="stringliteral">&quot;(This message doesn&#39;t trigger if it was already NULL.)\n&quot;</span>);
<a name="l00244"></a>00244     <span class="comment">//--------------------------------</span>
<a name="l00245"></a>00245     <a class="code" href="class_o_t_lookup_caller.html#a880da55c66b8a7b2694050b641448152">_callback</a> = NULL;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">// ------------------------------------------------</span>
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="class_o_t_lookup_caller.html#adf7958385570da779a6475b3d49c5985">00250</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_lookup_caller.html#adf7958385570da779a6475b3d49c5985">OTLookupCaller::setCallback</a>(<a class="code" href="class_o_t_name_lookup.html">OTNameLookup</a> *cb)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::setCallback: Attempting to set the OTNameLookup pointer...\n&quot;</span>);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (NULL == cb)
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::setCallback: ERROR: NULL OTNameLookup object passed in. (Returning.)\n&quot;</span>);
<a name="l00257"></a>00257         <span class="keywordflow">return</span>;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <a class="code" href="class_o_t_lookup_caller.html#a33f5d6e4d697c098854c1d0735018d90">delCallback</a>(); <span class="comment">// Sets _callback to NULL, but LOGS first, if it was already set.</span>
<a name="l00261"></a>00261     <span class="comment">// -----------------------------</span>
<a name="l00262"></a>00262     <a class="code" href="class_o_t_lookup_caller.html#a880da55c66b8a7b2694050b641448152">_callback</a> = cb;
<a name="l00263"></a>00263     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::setCallback: FYI, the OTNameLookup pointer was set.\n&quot;</span>);
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="comment">// ------------------------------------------------</span>
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">00268</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">OTLookupCaller::isCallbackSet</a>()<span class="keyword"> const</span>
<a name="l00269"></a>00269 <span class="keyword"></span>{
<a name="l00270"></a>00270     <span class="keywordflow">return</span> (NULL == <a class="code" href="class_o_t_lookup_caller.html#a880da55c66b8a7b2694050b641448152">_callback</a>) ? <span class="keyword">false</span> : <span class="keyword">true</span>;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">// ------------------------------------------------</span>
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="class_o_t_lookup_caller.html#a7d32d4bcf6170507ec41b40ee8eb9a32">00275</a> std::string <a class="code" href="class_o_t_lookup_caller.html#a7d32d4bcf6170507ec41b40ee8eb9a32">OTLookupCaller::GetNymName</a>(<span class="keyword">const</span> std::string &amp; str_id, <span class="comment">// NymID</span>
<a name="l00276"></a>00276                                        <span class="keyword">const</span> std::string * p_server_id<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l00277"></a>00277 <span class="keyword"></span>{
<a name="l00278"></a>00278     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>())
<a name="l00279"></a>00279     {
<a name="l00280"></a>00280         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::GetNymName: FYI, Executing address book callback...\n&quot;</span>);
<a name="l00281"></a>00281         <span class="keywordflow">return</span> <a class="code" href="class_o_t_lookup_caller.html#a880da55c66b8a7b2694050b641448152">_callback</a>-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_id, p_server_id);
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283     <span class="keywordflow">else</span>
<a name="l00284"></a>00284     {
<a name="l00285"></a>00285         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::GetNymName: &quot;</span>
<a name="l00286"></a>00286                       <span class="stringliteral">&quot;WARNING: Failed attempt to trigger address book callback, due to \&quot;it hasn&#39;t been set yet.\&quot;\n&quot;</span>);
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment">// ------------------------------------------------</span>
<a name="l00292"></a>00292 
<a name="l00293"></a><a class="code" href="class_o_t_lookup_caller.html#af4de7645e941c38ce8520d96221b7481">00293</a> std::string <a class="code" href="class_o_t_lookup_caller.html#af4de7645e941c38ce8520d96221b7481">OTLookupCaller::GetAcctName</a>(<span class="keyword">const</span> std::string &amp; str_id, <span class="comment">// AcctID</span>
<a name="l00294"></a>00294                                         <span class="keyword">const</span> std::string * p_nym_id<span class="comment">/*=NULL*/</span>,
<a name="l00295"></a>00295                                         <span class="keyword">const</span> std::string * p_server_id<span class="comment">/*=NULL*/</span>,
<a name="l00296"></a>00296                                         <span class="keyword">const</span> std::string * p_asset_id<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l00297"></a>00297 <span class="keyword"></span>{
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>())
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::GetAcctName: FYI, Executing address book callback...\n&quot;</span>);
<a name="l00301"></a>00301         <span class="keywordflow">return</span> <a class="code" href="class_o_t_lookup_caller.html#a880da55c66b8a7b2694050b641448152">_callback</a>-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_id, p_nym_id, p_server_id, p_asset_id);
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     <span class="keywordflow">else</span>
<a name="l00304"></a>00304     {
<a name="l00305"></a>00305         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTLookupCaller::GetAcctName: &quot;</span>
<a name="l00306"></a>00306                       <span class="stringliteral">&quot;WARNING: Failed attempt to trigger address book callback, due to \&quot;it hasn&#39;t been set yet.\&quot;\n&quot;</span>);
<a name="l00307"></a>00307     }
<a name="l00308"></a>00308     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="comment">// ------------------------------------------------</span>
<a name="l00312"></a>00312 <span class="comment">//static</span>
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="keyword">const</span> std::string  OTRecordList::s_blank(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00315"></a>00315 <span class="keyword">const</span> std::string  OTRecordList::s_message_type(<span class="stringliteral">&quot;message&quot;</span>);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 std::string  OTRecordList::s_strTextTo  (<a class="code" href="_o_t_record_list_8cpp.html#a9a031bc983de9083406e8553232f8d03">MC_UI_TEXT_TO</a>);   <span class="comment">// &quot;To: &quot;</span>
<a name="l00318"></a>00318 std::string  OTRecordList::s_strTextFrom(<a class="code" href="_o_t_record_list_8cpp.html#a0a99ba497ae227ce15c324631e524437">MC_UI_TEXT_FROM</a>); <span class="comment">// &quot;From: &quot;</span>
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <a class="code" href="class_o_t_lookup_caller.html">OTLookupCaller</a> * <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">OTRecordList::s_pCaller</a> = NULL;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="comment">// Takes ownership. UPDATE: doesn&#39;t, since he assumes the Java side</span>
<a name="l00324"></a>00324 <span class="comment">// created it and will therefore delete it when the time comes.</span>
<a name="l00325"></a>00325 <span class="comment">// I keep a pointer, but I don&#39;t delete the thing. Let Java do it.</span>
<a name="l00326"></a>00326 <span class="comment">//</span>
<a name="l00327"></a>00327 <span class="comment">//static</span>
<a name="l00328"></a><a class="code" href="class_o_t_record_list.html#aae138fffa645482e39d2d838e4124839">00328</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#aae138fffa645482e39d2d838e4124839">OTRecordList::setAddrBookCaller</a>(<a class="code" href="class_o_t_lookup_caller.html">OTLookupCaller</a> &amp; theCaller)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: Attempting to set the address book caller... \n&quot;</span>, __FUNCTION__);
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (!theCaller.<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>())
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: OTLookupCaller::setCallback() &quot;</span>
<a name="l00335"></a>00335                       <span class="stringliteral">&quot;MUST be called first, with an OTNameLookup-extended object passed to it,\n&quot;</span>
<a name="l00336"></a>00336                       <span class="stringliteral">&quot;BEFORE calling this function with that OTLookupCaller. (Returning false.)\n&quot;</span>, __FUNCTION__);
<a name="l00337"></a>00337         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339     
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a>)
<a name="l00341"></a>00341     {
<a name="l00342"></a>00342         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: WARNING: Setting the address book caller again, even though &quot;</span>
<a name="l00343"></a>00343                       <span class="stringliteral">&quot;it was apparently ALREADY set... (Meaning Java has probably erroneously called this twice, &quot;</span>
<a name="l00344"></a>00344                       <span class="stringliteral">&quot;possibly passing the same OTLookupCaller both times.)\n&quot;</span>, __FUNCTION__);
<a name="l00345"></a>00345 <span class="comment">//      delete s_pCaller; // Let Java delete it.</span>
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347     
<a name="l00348"></a>00348     <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a> = &amp;theCaller;
<a name="l00349"></a>00349     <span class="comment">// ---------------------------</span>
<a name="l00350"></a>00350     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: FYI, Successfully set the address book caller object from &quot;</span>
<a name="l00351"></a>00351                    <span class="stringliteral">&quot;Java. Returning true.\n&quot;</span>, __FUNCTION__);
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 <span class="comment">// --------------------------------------------------------</span>
<a name="l00356"></a>00356 <span class="comment">// static</span>
<a name="l00357"></a><a class="code" href="class_o_t_record_list.html#ac4c5c2f740812baa27fb65a2a6166d75">00357</a> <a class="code" href="class_o_t_lookup_caller.html">OTLookupCaller</a> * <a class="code" href="class_o_t_record_list.html#ac4c5c2f740812baa27fb65a2a6166d75">OTRecordList::getAddrBookCaller</a>()
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359     <span class="keywordflow">return</span> <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a>;
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="comment">// ***************************************************</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">// ------------------------------------------------</span>
<a name="l00368"></a>00368 <span class="comment">// SETUP:</span>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="comment">// Set the default server here.</span>
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="class_o_t_record_list.html#ae87f1e637851abb0d46e1eddb424e6da">00372</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#ae87f1e637851abb0d46e1eddb424e6da">OTRecordList::SetServerID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374     <a class="code" href="class_o_t_record_list.html#a5a1aa0a3c27dacc601263b13ba21770e">ClearServers</a>();
<a name="l00375"></a>00375     <span class="comment">// -----------------------</span>
<a name="l00376"></a>00376     <a class="code" href="class_o_t_record_list.html#a9d8963a34cc95d0665fc7824fc08846d">AddServerID</a>(str_id);
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">// Unless you have many servers, then use this.</span>
<a name="l00380"></a>00380 
<a name="l00381"></a><a class="code" href="class_o_t_record_list.html#a9d8963a34cc95d0665fc7824fc08846d">00381</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a9d8963a34cc95d0665fc7824fc08846d">OTRecordList::AddServerID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00382"></a>00382 {
<a name="l00383"></a>00383     m_servers.insert(m_servers.end(), str_id);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 <span class="comment">// Also clears m_contents</span>
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="class_o_t_record_list.html#a5a1aa0a3c27dacc601263b13ba21770e">00389</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a5a1aa0a3c27dacc601263b13ba21770e">OTRecordList::ClearServers</a>()
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">ClearContents</a>();
<a name="l00392"></a>00392     <span class="comment">// -----------------------</span>
<a name="l00393"></a>00393     m_servers.clear();
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 <span class="comment">// ------------------------------------------------</span>
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00399"></a><a class="code" href="class_o_t_record_list.html#a8940a1f349f3543499e94c7e599ef3f9">00399</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a8940a1f349f3543499e94c7e599ef3f9">OTRecordList::SetAssetID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00400"></a>00400 {
<a name="l00401"></a>00401     <a class="code" href="class_o_t_record_list.html#a6752defba9b0a83c6d9723c1ab8f76a3">ClearAssets</a>();
<a name="l00402"></a>00402     <span class="comment">// -----------------------</span>
<a name="l00403"></a>00403     <a class="code" href="class_o_t_record_list.html#a47afa29d1990ec024feac91e6032c786">AddAssetID</a>(str_id);
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="class_o_t_record_list.html#a47afa29d1990ec024feac91e6032c786">00407</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a47afa29d1990ec024feac91e6032c786">OTRecordList::AddAssetID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="comment">// -------------------------</span>
<a name="l00410"></a>00410     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l00411"></a>00411     <span class="comment">// -------------------------</span>
<a name="l00412"></a>00412     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pWallet, <span class="stringliteral">&quot;Wallet was NULL. Should never happen.&quot;</span>);
<a name="l00413"></a>00413     <span class="comment">// ------------------------------------------------</span>
<a name="l00414"></a>00414     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strAssetTypeID(str_id);
<a name="l00415"></a>00415     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetTypeID(strAssetTypeID);
<a name="l00416"></a>00416     <span class="comment">// ------------------------------------------------</span>
<a name="l00417"></a>00417     std::string str_asset_name;
<a name="l00418"></a>00418     <span class="comment">// ------------------------------------------------</span>
<a name="l00419"></a>00419     <span class="comment">// Name is dollars, fraction is cents, TLA is USD and</span>
<a name="l00420"></a>00420     <span class="comment">// Symbol is $ (for example.) Here, we&#39;re grabbing the TLA.</span>
<a name="l00421"></a>00421     <span class="comment">//</span>
<a name="l00422"></a>00422     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pAssetContract = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a4daee51036b24439e687383a6c66c6f7">GetAssetContract</a>(theAssetTypeID);
<a name="l00423"></a>00423     <span class="comment">// ------------------------------------------------</span>
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (NULL != pAssetContract)
<a name="l00425"></a>00425     {
<a name="l00426"></a>00426         str_asset_name = pAssetContract-&gt;<a class="code" href="class_o_t_asset_contract.html#a57453300ee2ae1c1237078126d993afc">GetCurrencyTLA</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();  <span class="comment">// This might be &quot;USD&quot; -- preferable that this works.</span>
<a name="l00427"></a>00427         <span class="comment">// ------------------------------------------------</span>
<a name="l00428"></a>00428         <span class="keywordflow">if</span> (str_asset_name.empty())
<a name="l00429"></a>00429             str_asset_name = pAssetContract-&gt;<a class="code" href="class_o_t_asset_contract.html#a69a507ba243e590f14354c3d903a03a6">GetCurrencySymbol</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();  <span class="comment">// This might be &quot;$&quot;.</span>
<a name="l00430"></a>00430         <span class="comment">// ------------------------------------------------</span>
<a name="l00431"></a>00431         <span class="keywordflow">if</span> (str_asset_name.empty())
<a name="l00432"></a>00432             str_asset_name = pAssetContract-&gt;<a class="code" href="class_o_t_asset_contract.html#af098ba258ee7490e32f72bc8896cf079">GetCurrencyName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();  <span class="comment">// This might be &quot;dollars&quot;.</span>
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <span class="comment">// ------------------------------------------------</span>
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (str_asset_name.empty())
<a name="l00436"></a>00436         str_asset_name = <a class="code" href="class_o_t_a_p_i___wrap.html#a5ef7d7ae416f5c4d8ca0242afd5f4216">OTAPI_Wrap::GetAssetType_Name</a>(str_id); <span class="comment">// Otherwise we try to grab the name.</span>
<a name="l00437"></a>00437     <span class="comment">// ------------------------------------------------</span>
<a name="l00438"></a>00438     <span class="comment">// (Otherwise we just leave it blank. The ID is too big to cram in here.)</span>
<a name="l00439"></a>00439     <span class="comment">// ------------------------------------------------</span>
<a name="l00440"></a>00440     m_assets.insert(std::pair&lt;std::string, std::string&gt;(str_id, str_asset_name));
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="comment">// ------------------------------------------------</span>
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="class_o_t_record_list.html#a6752defba9b0a83c6d9723c1ab8f76a3">00445</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a6752defba9b0a83c6d9723c1ab8f76a3">OTRecordList::ClearAssets</a>()
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447     <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">ClearContents</a>();
<a name="l00448"></a>00448     <span class="comment">// -----------------------</span>
<a name="l00449"></a>00449     m_assets.clear();
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="comment">// ------------------------------------------------</span>
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="class_o_t_record_list.html#a4f11a534c858d5dc8371c83e4ec5cbc5">00455</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a4f11a534c858d5dc8371c83e4ec5cbc5">OTRecordList::SetNymID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457     <a class="code" href="class_o_t_record_list.html#a8c07d4f66047848e971b631b9dd7eace">ClearNyms</a>();
<a name="l00458"></a>00458     <span class="comment">// -----------------------</span>
<a name="l00459"></a>00459     <a class="code" href="class_o_t_record_list.html#aa9b17f88ed73b797b84be5fca67877c9">AddNymID</a>(str_id);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">// ------------------------------------------------</span>
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="class_o_t_record_list.html#aa9b17f88ed73b797b84be5fca67877c9">00464</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#aa9b17f88ed73b797b84be5fca67877c9">OTRecordList::AddNymID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466     m_nyms.insert(m_nyms.end(), str_id);
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="comment">// ------------------------------------------------</span>
<a name="l00470"></a>00470 
<a name="l00471"></a><a class="code" href="class_o_t_record_list.html#a8c07d4f66047848e971b631b9dd7eace">00471</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a8c07d4f66047848e971b631b9dd7eace">OTRecordList::ClearNyms</a>()
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473     <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">ClearContents</a>();
<a name="l00474"></a>00474     <span class="comment">// -----------------------</span>
<a name="l00475"></a>00475     m_nyms.clear();
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 <span class="comment">// ------------------------------------------------</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 
<a name="l00481"></a><a class="code" href="class_o_t_record_list.html#a6d54cbd85e4bd1ef68f386c5e87a4cdd">00481</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a6d54cbd85e4bd1ef68f386c5e87a4cdd">OTRecordList::SetAccountID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483     <a class="code" href="class_o_t_record_list.html#aa76496d19fdaaad6b231c65bad6c36e4">ClearAccounts</a>();
<a name="l00484"></a>00484     <span class="comment">// -----------------------</span>
<a name="l00485"></a>00485     <a class="code" href="class_o_t_record_list.html#a3797bde231add00697f547a147839906">AddAccountID</a>(str_id);
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="comment">// ------------------------------------------------</span>
<a name="l00489"></a>00489 
<a name="l00490"></a><a class="code" href="class_o_t_record_list.html#a3797bde231add00697f547a147839906">00490</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a3797bde231add00697f547a147839906">OTRecordList::AddAccountID</a>(<span class="keyword">const</span> std::string str_id)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     m_accounts.insert(m_accounts.end(), str_id);
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="comment">// ------------------------------------------------</span>
<a name="l00496"></a>00496 
<a name="l00497"></a><a class="code" href="class_o_t_record_list.html#aa76496d19fdaaad6b231c65bad6c36e4">00497</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#aa76496d19fdaaad6b231c65bad6c36e4">OTRecordList::ClearAccounts</a>()
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">ClearContents</a>();
<a name="l00500"></a>00500     <span class="comment">// -----------------------</span>
<a name="l00501"></a>00501     m_accounts.clear();
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 <span class="comment">// ------------------------------------------------</span>
<a name="l00505"></a>00505 
<a name="l00506"></a><a class="code" href="class_o_t_record_list.html#ae44503cb9c7144730b1766db3bec518c">00506</a>  <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#ae44503cb9c7144730b1766db3bec518c">OTRecordList::AcceptChequesAutomatically</a>  (<span class="keywordtype">bool</span> bVal<span class="comment">/*=true*/</span>) { m_bAutoAcceptCheques   = bVal; }
<a name="l00507"></a><a class="code" href="class_o_t_record_list.html#a9b7f332580cd9162a04bcb1822b36e95">00507</a>  <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#a9b7f332580cd9162a04bcb1822b36e95">OTRecordList::AcceptReceiptsAutomatically</a> (<span class="keywordtype">bool</span> bVal<span class="comment">/*=true*/</span>) { m_bAutoAcceptReceipts  = bVal; }
<a name="l00508"></a><a class="code" href="class_o_t_record_list.html#aaf76a5da63b40c82398bd0017605b22a">00508</a>  <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#aaf76a5da63b40c82398bd0017605b22a">OTRecordList::AcceptTransfersAutomatically</a>(<span class="keywordtype">bool</span> bVal<span class="comment">/*=true*/</span>) { m_bAutoAcceptTransfers = bVal; }
<a name="l00509"></a><a class="code" href="class_o_t_record_list.html#ab4789815f0d8f1d70d1988e9facc1dea">00509</a>  <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#ab4789815f0d8f1d70d1988e9facc1dea">OTRecordList::AcceptCashAutomatically</a>     (<span class="keywordtype">bool</span> bVal<span class="comment">/*=true*/</span>) { m_bAutoAcceptCash      = bVal; }
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="class_o_t_record_list.html#a987df1b71687cf1a3e0127009ad26855">00511</a>  <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#a987df1b71687cf1a3e0127009ad26855">OTRecordList::DoesAcceptChequesAutomatically</a>  ()  { <span class="keywordflow">return</span> m_bAutoAcceptCheques;   }
<a name="l00512"></a><a class="code" href="class_o_t_record_list.html#aa868d4136395d77948b0cafc1c35a53f">00512</a>  <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#aa868d4136395d77948b0cafc1c35a53f">OTRecordList::DoesAcceptReceiptsAutomatically</a> ()  { <span class="keywordflow">return</span> m_bAutoAcceptReceipts;  }
<a name="l00513"></a><a class="code" href="class_o_t_record_list.html#ae61262e2226eddca0f261dfcd3f72d29">00513</a>  <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#ae61262e2226eddca0f261dfcd3f72d29">OTRecordList::DoesAcceptTransfersAutomatically</a>()  { <span class="keywordflow">return</span> m_bAutoAcceptTransfers; }
<a name="l00514"></a><a class="code" href="class_o_t_record_list.html#af6c02b51a493a1455cb0e4fe4343dcfb">00514</a>  <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#af6c02b51a493a1455cb0e4fe4343dcfb">OTRecordList::DoesAcceptCashAutomatically</a>     ()  { <span class="keywordflow">return</span> m_bAutoAcceptCash;      }
<a name="l00515"></a>00515 
<a name="l00516"></a><a class="code" href="_o_t_record_list_8cpp.html#af2ad9db06b6d52ef03efb69b43cf2103">00516</a> <span class="keyword">typedef</span> std::map&lt;int32_t, OTPayment *&gt; <a class="code" href="_o_t_record_list_8cpp.html#af2ad9db06b6d52ef03efb69b43cf2103">mapOfPayments</a>;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="class_o_t_record_list.html#a46ecadc735b29bbc4c5c9b9a0f31d121">00519</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#a46ecadc735b29bbc4c5c9b9a0f31d121">OTRecordList::PerformAutoAccept</a>()
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <span class="comment">// -------------------------</span>
<a name="l00522"></a>00522     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l00523"></a>00523     <span class="comment">// -------------------------</span>
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (NULL == pWallet)
<a name="l00525"></a>00525     {
<a name="l00526"></a>00526         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTRecordList::%s: Error: Wallet is NULL.\n&quot;</span>, __FUNCTION__);
<a name="l00527"></a>00527         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     <span class="comment">// ------------------------------------------------</span>
<a name="l00530"></a>00530     <span class="comment">// LOOP NYMS</span>
<a name="l00531"></a>00531     <span class="comment">//</span>
<a name="l00532"></a>00532     <span class="keywordtype">int</span> nNymIndex = -1;
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (m_bAutoAcceptCheques || m_bAutoAcceptCash) <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_nyms, it_nym)
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535         ++nNymIndex;
<a name="l00536"></a>00536         <span class="comment">// ------------------------------------------------</span>
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (0 == nNymIndex)
<a name="l00538"></a>00538             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;======================================\n %s: Beginning auto-accept loop through Nyms...\n&quot;</span>, __FUNCTION__);
<a name="l00539"></a>00539         <span class="comment">// ------------------------------------------------</span>
<a name="l00540"></a>00540         <span class="keyword">const</span> std::string  &amp; str_nym_id(*it_nym);
<a name="l00541"></a>00541         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theNymID  (str_nym_id);
<a name="l00542"></a>00542         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strNymID  (theNymID);
<a name="l00543"></a>00543         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(theNymID);
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">continue</span>;
<a name="l00545"></a>00545         <span class="comment">// ------------------------------------------------</span>
<a name="l00546"></a>00546         <span class="comment">// LOOP SERVERS</span>
<a name="l00547"></a>00547         <span class="comment">//</span>
<a name="l00548"></a>00548         <span class="comment">// For each nym, for each server, loop through its payments inbox</span>
<a name="l00549"></a>00549         <span class="comment">//</span>
<a name="l00550"></a>00550         <span class="keywordtype">int</span> nServerIndex = -1;
<a name="l00551"></a>00551         <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_servers, it_server)
<a name="l00552"></a>00552         {
<a name="l00553"></a>00553             ++nServerIndex;
<a name="l00554"></a>00554             <span class="comment">// --------------------------</span>
<a name="l00555"></a>00555             <span class="keyword">const</span> std::string  &amp; str_server_id(*it_server);
<a name="l00556"></a>00556             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theServerID(str_server_id);
<a name="l00557"></a>00557             <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *   pServer = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(theServerID);
<a name="l00558"></a>00558             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pServer);
<a name="l00559"></a>00559             <span class="comment">// ------------------------------------------------</span>
<a name="l00560"></a>00560             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
<a name="l00561"></a>00561             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Server %d, ID: %s\n&quot;</span>, __FUNCTION__, nServerIndex, strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00562"></a>00562             <span class="comment">// ------------------------------------------------</span>
<a name="l00563"></a>00563             <a class="code" href="_o_t_record_list_8cpp.html#af2ad9db06b6d52ef03efb69b43cf2103">mapOfPayments</a> thePaymentMap;
<a name="l00564"></a>00564             <span class="comment">// ------------------------------------------------</span>
<a name="l00565"></a>00565             <span class="comment">// OPTIMIZE FYI:</span>
<a name="l00566"></a>00566             <span class="comment">// The &quot;NoVerify&quot; version is much faster, but you will lose the ability to get the</span>
<a name="l00567"></a>00567             <span class="comment">// sender/recipient name from the receipts in the box. The code will, however, work</span>
<a name="l00568"></a>00568             <span class="comment">// either way.</span>
<a name="l00569"></a>00569             <span class="comment">//</span>
<a name="l00570"></a>00570             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a8e02cb186854f0b325c4c55da69f2e55">LoadPaymentInboxNoVerify</a>(theServerID, theNymID) :
<a name="l00571"></a>00571                                              <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a5077987cf25f441923c88cb51b3d940a">LoadPaymentInbox</a>        (theServerID, theNymID);
<a name="l00572"></a>00572             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574             int32_t  nIndex = (-1);
<a name="l00575"></a>00575             <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l00576"></a>00576             <span class="keywordflow">if</span> (NULL != pInbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pInbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l00577"></a>00577             {
<a name="l00578"></a>00578                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l00579"></a>00579                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l00580"></a>00580                 <span class="comment">// ------------------------------</span>
<a name="l00581"></a>00581                 ++nIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l00582"></a>00582                 <span class="comment">// ------------------------------------------------</span>
<a name="l00583"></a>00583                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Incoming payment: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l00584"></a>00584                 <span class="comment">// ------------------------------------------------</span>
<a name="l00585"></a>00585                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l00586"></a>00586                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l00587"></a>00587                 <span class="comment">// ------------------------------------------------</span>
<a name="l00588"></a>00588                 std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l00589"></a>00589                 std::string str_type;    <span class="comment">// Instrument type.</span>
<a name="l00590"></a>00590                 <span class="comment">// ------------------------------------------------</span>
<a name="l00591"></a>00591                 <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym,
<a name="l00592"></a>00592                                                              nIndex);     <span class="comment">// ===&gt; Returns financial instrument by index.</span>
<a name="l00593"></a>00593                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l00594"></a>00594                 <span class="comment">// ------------------------------</span>
<a name="l00595"></a>00595                 <span class="keywordflow">if</span> (NULL == pPayment) <span class="comment">// then we treat it like it&#39;s abbreviated.</span>
<a name="l00596"></a>00596                 {
<a name="l00597"></a>00597                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Payment retrieved from payments inbox was NULL. (It&#39;s abbreviated?) Skipping.\n&quot;</span>, __FUNCTION__);
<a name="l00598"></a>00598                 }
<a name="l00599"></a>00599                 <span class="comment">// ---------------------------------------------------</span>
<a name="l00600"></a>00600                 <span class="comment">// We have pPayment, the instrument accompanying the receipt in the payments inbox.</span>
<a name="l00601"></a>00601                 <span class="comment">//</span>
<a name="l00602"></a>00602                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a7f95ab568d481ecc7d38689c80caba84">IsValid</a>() &amp;&amp; pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l00603"></a>00603                 {
<a name="l00604"></a>00604                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetTypeID;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606                     <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(theAssetTypeID))
<a name="l00607"></a>00607                     {
<a name="l00608"></a>00608                         <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAssetTypeID);
<a name="l00609"></a>00609                         <span class="keyword">const</span> std::string str_inpmt_asset(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// The asset type we found on the payment (if we found anything.)</span>
<a name="l00610"></a>00610                         <span class="comment">// -----------------------------</span>
<a name="l00611"></a>00611                         map_of_strings::iterator it_asset = m_assets.find(str_inpmt_asset);
<a name="l00612"></a>00612                         <span class="comment">// -----------------------------</span>
<a name="l00613"></a>00613                         <span class="keywordflow">if</span> (it_asset != m_assets.end()) <span class="comment">// Found it on the map of asset types we care about.</span>
<a name="l00614"></a>00614                         {
<a name="l00615"></a>00615                             p_str_asset_type = &amp;(it_asset-&gt;first);   <span class="comment">// Set the asset type ID.</span>
<a name="l00616"></a>00616                             p_str_asset_name = &amp;(it_asset-&gt;second);  <span class="comment">// The CurrencyTLA. Examples: USD, BTC, etc.</span>
<a name="l00617"></a>00617                         }
<a name="l00618"></a>00618                         <span class="keywordflow">else</span>
<a name="l00619"></a>00619                         {
<a name="l00620"></a>00620                             <span class="comment">// There was definitely an asset type on the instrument, and it definitely</span>
<a name="l00621"></a>00621                             <span class="comment">// did not match any of the assets that we care about.</span>
<a name="l00622"></a>00622                             <span class="comment">// Therefore, skip.</span>
<a name="l00623"></a>00623                             <span class="comment">//</span>
<a name="l00624"></a>00624                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Skipping: Incoming payment (we don&#39;t care about asset %s)\n&quot;</span>,
<a name="l00625"></a>00625                                           __FUNCTION__, str_inpmt_asset.c_str());
<a name="l00626"></a>00626                             <span class="keywordflow">continue</span>;
<a name="l00627"></a>00627                         }
<a name="l00628"></a>00628                     }
<a name="l00629"></a>00629                     <span class="comment">// By this point, p_str_asset_type and p_str_asset_name are definitely set.</span>
<a name="l00630"></a>00630                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_type); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l00631"></a>00631                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_name); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l00632"></a>00632                     <span class="comment">// ---------------------------------------------------</span>
<a name="l00633"></a>00633                     <span class="comment">// Instrument type (cheque, voucher, etc)</span>
<a name="l00634"></a>00634                     <span class="keywordtype">int</span> nType = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>());
<a name="l00635"></a>00635 
<a name="l00636"></a>00636                     str_type = <a class="code" href="_o_t_record_8hpp.html#aad2c87d02cf1bd05c6f519117deb93d9">OTRecord_GetTypeString</a>(nType);
<a name="l00637"></a>00637                     <span class="comment">// ------------------------------</span>
<a name="l00638"></a>00638                     <span class="comment">// For now, we only accept cash, cheques and vouchers.</span>
<a name="l00639"></a>00639                     <span class="comment">//</span>
<a name="l00640"></a>00640                     <span class="keywordflow">if</span> ( (m_bAutoAcceptCheques &amp;&amp; ((0 == str_type.compare(<span class="stringliteral">&quot;cheque&quot;</span>)) || (0 == str_type.compare(<span class="stringliteral">&quot;voucher&quot;</span>)))) ||
<a name="l00641"></a>00641                          (m_bAutoAcceptCash    &amp;&amp;  (0 == str_type.compare(<span class="stringliteral">&quot;cash&quot;</span>))))
<a name="l00642"></a>00642                     {
<a name="l00643"></a>00643                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Adding to acceptance list: pending incoming %s.\n&quot;</span>,
<a name="l00644"></a>00644                                        __FUNCTION__, str_type.c_str());
<a name="l00645"></a>00645                         <span class="comment">// -------------------------</span>
<a name="l00646"></a>00646                         thePaymentMap.insert(std::pair&lt;int32_t, OTPayment *&gt;(nIndex, pPayment));
<a name="l00647"></a>00647                         thePaymentAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// Now we HAVE to cleanup, below... Otherwise pPayment will leak.</span>
<a name="l00648"></a>00648                     }
<a name="l00649"></a>00649                     <span class="keywordflow">else</span>
<a name="l00650"></a>00650                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unknown instrument type: %s\n&quot;</span>, __FUNCTION__, str_type.c_str());
<a name="l00651"></a>00651                 }
<a name="l00652"></a>00652                 <span class="keywordflow">else</span>
<a name="l00653"></a>00653                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed in pPayment-&gt;IsValid or pPayment-&gt;SetTempValues()\n&quot;</span>, __FUNCTION__);
<a name="l00654"></a>00654                 <span class="comment">// ------------------------------</span>
<a name="l00655"></a>00655             } <span class="comment">// looping through payments inbox.</span>
<a name="l00656"></a>00656             <span class="keywordflow">else</span>
<a name="l00657"></a>00657                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed loading payments inbox. (Probably just doesn&#39;t exist yet.)\n&quot;</span>, __FUNCTION__);
<a name="l00658"></a>00658             <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00659"></a>00659             <span class="comment">// Above we compiled a list of purses, cheques / vouchers to accept.</span>
<a name="l00660"></a>00660             <span class="comment">// If there are any on that list, then ACCEPT them here.</span>
<a name="l00661"></a>00661             <span class="comment">//</span>
<a name="l00662"></a>00662             <span class="keywordflow">if</span> (!thePaymentMap.empty())
<a name="l00663"></a>00663             {
<a name="l00664"></a>00664                 <span class="keywordflow">for</span> (mapOfPayments::reverse_iterator it = thePaymentMap.rbegin(); it != thePaymentMap.rend(); ++it) <span class="comment">// backwards since we are processing (removing) payments by index.</span>
<a name="l00665"></a>00665                 {
<a name="l00666"></a>00666                     <span class="keywordtype">long</span>        lIndex   = <span class="keyword">static_cast&lt;</span><span class="keywordtype">long</span><span class="keyword">&gt;</span>(it-&gt;first);
<a name="l00667"></a>00667                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = it-&gt;second;
<a name="l00668"></a>00668                     <span class="comment">// -------------------------</span>
<a name="l00669"></a>00669                     <span class="keywordflow">if</span> (NULL == pPayment)
<a name="l00670"></a>00670                     {
<a name="l00671"></a>00671                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: payment pointer was NULL! (Should never happen.) Skipping.\n&quot;</span>, __FUNCTION__);
<a name="l00672"></a>00672                         <span class="keywordflow">continue</span>;
<a name="l00673"></a>00673                     }
<a name="l00674"></a>00674                     <span class="comment">// -------------------------</span>
<a name="l00675"></a>00675                     <a class="code" href="class_o_t_string.html">OTString</a> strPayment;
<a name="l00676"></a>00676                     std::string str_payment_contents;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                     <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strPayment))
<a name="l00679"></a>00679                     {
<a name="l00680"></a>00680                         str_payment_contents = strPayment.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00681"></a>00681                     }
<a name="l00682"></a>00682                     <span class="keywordflow">else</span>
<a name="l00683"></a>00683                     {
<a name="l00684"></a>00684                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed while trying to get payment string contents. (Skipping.)\n&quot;</span>, __FUNCTION__);
<a name="l00685"></a>00685                         <span class="keywordflow">continue</span>;
<a name="l00686"></a>00686                     }
<a name="l00687"></a>00687                     <span class="comment">// ---------------------------------</span>
<a name="l00688"></a>00688                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> paymentAssetType;
<a name="l00689"></a>00689                     <span class="keywordtype">bool</span> bGotAsset = pPayment-&gt;<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(paymentAssetType);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691                     std::string str_asset_type_id;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                     <span class="keywordflow">if</span> (bGotAsset)
<a name="l00694"></a>00694                     {
<a name="l00695"></a>00695                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(paymentAssetType);
<a name="l00696"></a>00696                         str_asset_type_id = strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00697"></a>00697                     }
<a name="l00698"></a>00698                     <span class="comment">// -------------------------------------------</span>
<a name="l00699"></a>00699                     <span class="keywordflow">if</span> (str_asset_type_id.empty())
<a name="l00700"></a>00700                     {
<a name="l00701"></a>00701                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed while trying to get asset type ID from payment. (Skipping.)\n&quot;</span>, __FUNCTION__);
<a name="l00702"></a>00702                         <span class="keywordflow">continue</span>;
<a name="l00703"></a>00703                     }
<a name="l00704"></a>00704                     <span class="comment">// -------------------------------------------</span>
<a name="l00705"></a>00705                     <span class="comment">// pick an account to deposit the cheque into.</span>
<a name="l00706"></a>00706                     <span class="comment">//</span>
<a name="l00707"></a>00707                     <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_accounts, it_acct)
<a name="l00708"></a>00708                     {
<a name="l00709"></a>00709                         <span class="keyword">const</span> std::string  &amp; str_account_id(*it_acct);
<a name="l00710"></a>00710                         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theAccountID  (str_account_id);
<a name="l00711"></a>00711                         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);
<a name="l00712"></a>00712                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAccount);
<a name="l00713"></a>00713                         <span class="comment">// ------------------------------------------------</span>
<a name="l00714"></a>00714                         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAcctNymID    = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();
<a name="l00715"></a>00715                         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAcctServerID = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>();
<a name="l00716"></a>00716                         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAcctAssetID  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l00717"></a>00717                         <span class="comment">// -----------------------------------</span>
<a name="l00718"></a>00718                         <span class="keyword">const</span> std::string    str_acct_type   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a15dbf34beb7f8e38c6719120770bc852">GetTypeString</a>();
<a name="l00719"></a>00719                         <span class="comment">// -----------------------------------</span>
<a name="l00720"></a>00720 <span class="comment">//                      const OTString       strAcctNymID   (theAcctNymID);</span>
<a name="l00721"></a>00721                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strAcctServerID(theAcctServerID);
<a name="l00722"></a>00722                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strAcctAssetID (theAcctAssetID);
<a name="l00723"></a>00723                         <span class="comment">// ------------------------------------------------</span>
<a name="l00724"></a>00724                         <span class="comment">// If the current account is owned by the Nym, AND it has the same asset type ID</span>
<a name="l00725"></a>00725                         <span class="comment">// as the cheque being deposited, then let&#39;s deposit the cheque into that account.</span>
<a name="l00726"></a>00726                         <span class="comment">//</span>
<a name="l00727"></a>00727                         <span class="comment">// TODO: we should first just see if the default account matches, instead of doing</span>
<a name="l00728"></a>00728                         <span class="comment">// this loop in the first place.</span>
<a name="l00729"></a>00729                         <span class="comment">//</span>
<a name="l00730"></a>00730                         <span class="keywordflow">if</span> ((theNymID == theAcctNymID)                           &amp;&amp;
<a name="l00731"></a>00731                             (strAcctServerID.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(str_server_id    .c_str())) &amp;&amp;
<a name="l00732"></a>00732                             (strAcctAssetID .<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(str_asset_type_id.c_str())) &amp;&amp;
<a name="l00733"></a>00733                             (0 == str_acct_type.compare(<span class="stringliteral">&quot;simple&quot;</span>))) <span class="comment">// No issuer accounts allowed here. Only simple accounts.</span>
<a name="l00734"></a>00734                         {
<a name="l00735"></a>00735                             <span class="comment">// Accept it.</span>
<a name="l00736"></a>00736                             <span class="comment">//</span>
<a name="l00737"></a>00737                             <a class="code" href="class_o_t_string.html">OTString</a> strIndices;
<a name="l00738"></a>00738                             strIndices.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lIndex);
<a name="l00739"></a>00739                             <span class="keyword">const</span> std::string str_indices(strIndices.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00740"></a>00740 
<a name="l00741"></a>00741                             <a class="code" href="class_o_t___m_e.html">OT_ME</a> madeEasy;
<a name="l00742"></a>00742                             int32_t nReturn = madeEasy.<a class="code" href="class_o_t___m_e.html#a77ed23b7678320960422bae5d9405e0a">accept_from_paymentbox</a>(str_account_id, str_indices, <span class="stringliteral">&quot;ANY&quot;</span>);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744                             <span class="keywordflow">switch</span> (nReturn)
<a name="l00745"></a>00745                             {
<a name="l00746"></a>00746                                 <span class="keywordflow">case</span> 0:
<a name="l00747"></a>00747                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: This instrument was expired, so it was moved to the record box.\n&quot;</span>, __FUNCTION__);
<a name="l00748"></a>00748                                 <span class="keywordflow">case</span> 1: <span class="comment">// success</span>
<a name="l00749"></a>00749                                     <span class="keywordflow">break</span>;
<a name="l00750"></a>00750                                     <span class="comment">// ----------------------------------</span>
<a name="l00751"></a>00751                                 <span class="keywordflow">default</span>:
<a name="l00752"></a>00752                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error while trying to accept this instrument.\n&quot;</span>, __FUNCTION__);
<a name="l00753"></a>00753                                     <span class="keywordflow">break</span>;
<a name="l00754"></a>00754                             } <span class="comment">// switch</span>
<a name="l00755"></a>00755                             <span class="keywordflow">break</span>;
<a name="l00756"></a>00756                         }
<a name="l00757"></a>00757                     } <span class="comment">// loop through accounts to find one to deposit cheque into.</span>
<a name="l00758"></a>00758                 } <span class="comment">// Loop through payments to deposit.</span>
<a name="l00759"></a>00759                 <span class="comment">// ------------------------------------------</span>
<a name="l00760"></a>00760                 <span class="comment">// Empty the list and delete the payments inside.</span>
<a name="l00761"></a>00761                 <span class="comment">//</span>
<a name="l00762"></a>00762                 <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_record_list_8cpp.html#af2ad9db06b6d52ef03efb69b43cf2103">mapOfPayments</a>, thePaymentMap)
<a name="l00763"></a>00763                 {
<a name="l00764"></a>00764                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = it-&gt;second;
<a name="l00765"></a>00765                     <span class="keywordflow">if</span> (NULL != pPayment)
<a name="l00766"></a>00766                         <span class="keyword">delete</span> pPayment;
<a name="l00767"></a>00767                     pPayment = NULL;
<a name="l00768"></a>00768                 }
<a name="l00769"></a>00769                 thePaymentMap.clear();
<a name="l00770"></a>00770             } <span class="comment">// if (!thePaymentMap.empty())</span>
<a name="l00771"></a>00771             <span class="comment">// ------------------------------------------------</span>
<a name="l00772"></a>00772         } <span class="comment">// FOR_EACH_IT(list_of_strings, m_servers, it_server)</span>
<a name="l00773"></a>00773     } <span class="comment">// FOR_EACH_IT(list_of_strings, m_nyms, it_nym)</span>
<a name="l00774"></a>00774     <span class="comment">// ------------------------------------------------</span>
<a name="l00775"></a>00775     <span class="comment">// ASSET ACCOUNT -- INBOX</span>
<a name="l00776"></a>00776     <span class="comment">//</span>
<a name="l00777"></a>00777     <span class="comment">// Loop through the Accounts.</span>
<a name="l00778"></a>00778     <span class="comment">//</span>
<a name="l00779"></a>00779     <span class="comment">// ------------------------------------------------</span>
<a name="l00780"></a>00780     <span class="keywordtype">int</span> nAccountIndex = -1;
<a name="l00781"></a>00781     <span class="keywordflow">if</span> (m_bAutoAcceptReceipts || m_bAutoAcceptTransfers) <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_accounts, it_acct)
<a name="l00782"></a>00782     {
<a name="l00783"></a>00783         ++nAccountIndex; <span class="comment">// (0 on first iteration.)</span>
<a name="l00784"></a>00784         <span class="comment">// ------------------</span>
<a name="l00785"></a>00785         <span class="keywordflow">if</span> (0 == nAccountIndex)
<a name="l00786"></a>00786             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;---------------------------------\n %s: Beginning auto-accept loop through the accounts in the wallet...\n&quot;</span>,
<a name="l00787"></a>00787                            __FUNCTION__);
<a name="l00788"></a>00788         <span class="comment">// ------------------------------------------------</span>
<a name="l00789"></a>00789         <span class="comment">// For each account, loop through its inbox, outbox, and record box.</span>
<a name="l00790"></a>00790         <span class="comment">//</span>
<a name="l00791"></a>00791         <span class="keyword">const</span> std::string  &amp; str_account_id(*it_acct);
<a name="l00792"></a>00792         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theAccountID  (str_account_id);
<a name="l00793"></a>00793         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);
<a name="l00794"></a>00794         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAccount);
<a name="l00795"></a>00795         <span class="comment">// ------------------------------------------------</span>
<a name="l00796"></a>00796         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theNymID    = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();
<a name="l00797"></a>00797         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>();
<a name="l00798"></a>00798         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetID  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l00799"></a>00799         <span class="comment">// ------------------------------------------------</span>
<a name="l00800"></a>00800         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strNymID   (theNymID);
<a name="l00801"></a>00801         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strServerID(theServerID);
<a name="l00802"></a>00802         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strAssetID (theAssetID);
<a name="l00803"></a>00803         <span class="comment">// ------------------------------------------------</span>
<a name="l00804"></a>00804         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;------------\n%s: Account: %d, ID: %s\n&quot;</span>, __FUNCTION__,
<a name="l00805"></a>00805                        nAccountIndex, str_account_id.c_str());
<a name="l00806"></a>00806         <span class="comment">// ------------------------------------------------</span>
<a name="l00807"></a>00807         <span class="keyword">const</span> std::string    str_nym_id    (strNymID   .Get());
<a name="l00808"></a>00808         <span class="keyword">const</span> std::string    str_server_id (strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00809"></a>00809         <span class="keyword">const</span> std::string    str_asset_id  (strAssetID .Get());
<a name="l00810"></a>00810         <span class="comment">// ------------------------------------------------</span>
<a name="l00811"></a>00811         <span class="keyword">const</span> std::string  * pstr_nym_id     = &amp;OTRecordList::s_blank;
<a name="l00812"></a>00812         <span class="keyword">const</span> std::string  * pstr_server_id  = &amp;OTRecordList::s_blank;
<a name="l00813"></a>00813         <span class="keyword">const</span> std::string  * pstr_asset_id   = &amp;OTRecordList::s_blank;
<a name="l00814"></a>00814         <span class="keyword">const</span> std::string  * pstr_asset_name = &amp;OTRecordList::s_blank;
<a name="l00815"></a>00815         <span class="comment">// ------------------------------------------------</span>
<a name="l00816"></a>00816         <span class="comment">// NOTE: Since this account is already on my &quot;care about&quot; list for accounts,</span>
<a name="l00817"></a>00817         <span class="comment">// I wouldn&#39;t bother double-checking my &quot;care about&quot; lists for servers, nyms,</span>
<a name="l00818"></a>00818         <span class="comment">// and asset types. But I still look up the appropriate string for each, since</span>
<a name="l00819"></a>00819         <span class="comment">// I have to pass a reference to it into the constructor for OTRecord. (To a version</span>
<a name="l00820"></a>00820         <span class="comment">// that won&#39;t be deleted, since the OTRecord will reference it. And the &quot;care about&quot;</span>
<a name="l00821"></a>00821         <span class="comment">// list definitely contains a copy of the string that won&#39;t be deleted.)</span>
<a name="l00822"></a>00822         <span class="comment">//</span>
<a name="l00823"></a>00823         list_of_strings::iterator it_nym    = std::find(m_nyms   .begin(),    m_nyms.end(),    str_nym_id);
<a name="l00824"></a>00824         list_of_strings::iterator it_server = std::find(m_servers.begin(), m_servers.end(), str_server_id);
<a name="l00825"></a>00825          map_of_strings::iterator it_asset  = m_assets.find(str_asset_id);
<a name="l00826"></a>00826         <span class="comment">// ------------------------------------------------</span>
<a name="l00827"></a>00827         <span class="keywordflow">if</span> ((m_nyms.end() == it_nym) || (m_servers.end() == it_server) || (m_assets.end() == it_asset))
<a name="l00828"></a>00828         {
<a name="l00829"></a>00829             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping an account (%s) since its Nym, or Server, &quot;</span>
<a name="l00830"></a>00830                            <span class="stringliteral">&quot;or Asset Type wasn&#39;t on my list.\n&quot;</span>, __FUNCTION__,
<a name="l00831"></a>00831                            str_account_id.c_str());
<a name="l00832"></a>00832             <span class="keywordflow">continue</span>;
<a name="l00833"></a>00833         }
<a name="l00834"></a>00834         <span class="comment">// ------------------------------------------------</span>
<a name="l00835"></a>00835         <span class="comment">// These pointers are what we&#39;ll use to construct each OTRecord.</span>
<a name="l00836"></a>00836         <span class="comment">//</span>
<a name="l00837"></a>00837         pstr_nym_id     = &amp;(*it_nym);
<a name="l00838"></a>00838         pstr_server_id  = &amp;(*it_server);
<a name="l00839"></a>00839         pstr_asset_id   = &amp;(it_asset-&gt;first);
<a name="l00840"></a>00840         pstr_asset_name = &amp;(it_asset-&gt;second);
<a name="l00841"></a>00841         <span class="comment">// ------------------------------------------------</span>
<a name="l00842"></a>00842         <span class="comment">// Loop through asset account INBOX.</span>
<a name="l00843"></a>00843         <span class="comment">//</span>
<a name="l00844"></a>00844         <span class="comment">// OPTIMIZE FYI:</span>
<a name="l00845"></a>00845         <span class="comment">// NOTE: LoadInbox is much SLOWER than LoadInboxNoVerify, but it also lets you get</span>
<a name="l00846"></a>00846         <span class="comment">// the NAME off of the box receipt. So if you are willing to GIVE UP the NAME, in</span>
<a name="l00847"></a>00847         <span class="comment">// return for FASTER PERFORMANCE, then call SetFastMode() before Populating.</span>
<a name="l00848"></a>00848         <span class="comment">//</span>
<a name="l00849"></a>00849         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a11a9479b4875de4377232237d3521690">LoadInboxNoVerify</a>(theServerID, theNymID, theAccountID) :
<a name="l00850"></a>00850                                          <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a478f3f32e383e05a203807810bc94940">LoadInbox</a>        (theServerID, theNymID, theAccountID);
<a name="l00851"></a>00851         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l00852"></a>00852         <span class="comment">// ------------------------------------------------</span>
<a name="l00853"></a>00853         <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l00854"></a>00854         {
<a name="l00855"></a>00855             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping an account (%s) since its inbox failed to load (have you downloaded the latest one?)\n&quot;</span>, __FUNCTION__,
<a name="l00856"></a>00856                            str_account_id.c_str());
<a name="l00857"></a>00857             <span class="keywordflow">continue</span>;
<a name="l00858"></a>00858         }
<a name="l00859"></a>00859         <span class="comment">// ------------------------------------------------</span>
<a name="l00860"></a>00860         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strInbox(*pInbox);
<a name="l00861"></a>00861         <span class="keyword">const</span> std::string str_inbox(strInbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00862"></a>00862         <span class="comment">// ------------------------------------------------</span>
<a name="l00863"></a>00863         <span class="keywordtype">bool</span> bFoundAnyToAccept = <span class="keyword">false</span>;
<a name="l00864"></a>00864         std::string strResponseLedger;
<a name="l00865"></a>00865         <span class="comment">// ------------------------------------------------</span>
<a name="l00866"></a>00866         <span class="keywordtype">int</span> nInboxIndex = -1;
<a name="l00867"></a>00867         <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l00868"></a>00868         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pInbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l00869"></a>00869         {
<a name="l00870"></a>00870             ++nInboxIndex; <span class="comment">// (0 on first iteration.)</span>
<a name="l00871"></a>00871             <span class="comment">// ------------------------------------------------</span>
<a name="l00872"></a>00872             <span class="keywordflow">if</span> (0 == nInboxIndex)
<a name="l00873"></a>00873                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Beginning loop through asset account INBOX...\n&quot;</span>, __FUNCTION__);
<a name="l00874"></a>00874             <span class="comment">// --------------------------------</span>
<a name="l00875"></a>00875             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l00876"></a>00876             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l00877"></a>00877             <span class="comment">// ------------------------------------------------</span>
<a name="l00878"></a>00878             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Inbox index: %d\n&quot;</span>, __FUNCTION__, nInboxIndex);
<a name="l00879"></a>00879             <span class="comment">// ------------------------------------------------</span>
<a name="l00880"></a>00880             <span class="keyword">const</span> std::string str_type(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>()); <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l00881"></a>00881             <span class="comment">// ------------------------------------------------</span>
<a name="l00882"></a>00882             <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsTransfer = (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>());
<a name="l00883"></a>00883             <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsReceipt  = !bIsTransfer;
<a name="l00884"></a>00884             <span class="comment">// ------------------------------------------------</span>
<a name="l00885"></a>00885             <span class="keywordflow">if</span> ((m_bAutoAcceptReceipts  &amp;&amp;  bIsReceipt)   ||
<a name="l00886"></a>00886                 (m_bAutoAcceptTransfers &amp;&amp;  bIsTransfer))
<a name="l00887"></a>00887             {
<a name="l00888"></a>00888                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Auto-accepting: incoming %s (str_type: %s)\n&quot;</span>,
<a name="l00889"></a>00889                                __FUNCTION__, bIsTransfer ? <span class="stringliteral">&quot;pending transfer&quot;</span> : <span class="stringliteral">&quot;receipt&quot;</span>,
<a name="l00890"></a>00890                                str_type.c_str());
<a name="l00891"></a>00891                 <span class="comment">// ------------------------------------------------</span>
<a name="l00892"></a>00892                 <span class="comment">// If we haven&#39;t found any yet, then this must be the first one!</span>
<a name="l00893"></a>00893                 <span class="comment">//</span>
<a name="l00894"></a>00894                 <span class="keywordflow">if</span> (!bFoundAnyToAccept)
<a name="l00895"></a>00895                 {
<a name="l00896"></a>00896                     bFoundAnyToAccept = <span class="keyword">true</span>;
<a name="l00897"></a>00897                     <span class="comment">// ------------------------</span>
<a name="l00898"></a>00898                     <a class="code" href="class_o_t___m_e.html">OT_ME</a> madeEasy;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900                     int32_t nNumberNeeded = 20;
<a name="l00901"></a>00901                     <span class="keywordflow">if</span> (!madeEasy.<a class="code" href="class_o_t___m_e.html#a090d116996160157729cafb1c790ab94">make_sure_enough_trans_nums</a>(nNumberNeeded, <span class="comment">// I&#39;m just hardcoding: &quot;Make sure I have at least 20 transaction numbers.&quot;</span>
<a name="l00902"></a>00902                                                               str_server_id, str_nym_id))
<a name="l00903"></a>00903                     {
<a name="l00904"></a>00904                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nFailure: make_sure_enough_trans_nums: returned false. (Skipping inbox for account %s)\n&quot;</span>,
<a name="l00905"></a>00905                                        str_account_id.c_str());
<a name="l00906"></a>00906                         <span class="keywordflow">continue</span>;
<a name="l00907"></a>00907                     }
<a name="l00908"></a>00908                     <span class="comment">// ---------------------------------</span>
<a name="l00909"></a>00909                     strResponseLedger = <a class="code" href="class_o_t_a_p_i___wrap.html#a99b35d10acdd06621bc28dac46e6fe54">OTAPI_Wrap::It</a>()-&gt;<a class="code" href="class_o_t_a_p_i___exec.html#a6a592a8bd48d7e006fdfe054e79b47ce">Ledger_CreateResponse</a>(str_server_id, str_nym_id, str_account_id, str_inbox);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                     <span class="keywordflow">if</span> (strResponseLedger.empty())
<a name="l00912"></a>00912                     {
<a name="l00913"></a>00913                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nFailure: OT_API_Ledger_CreateResponse returned NULL. (Skipping inbox for account %s)\n&quot;</span>,
<a name="l00914"></a>00914                                        str_account_id.c_str());
<a name="l00915"></a>00915                         <span class="keywordflow">continue</span>;
<a name="l00916"></a>00916                     }
<a name="l00917"></a>00917                 }
<a name="l00918"></a>00918                 <span class="comment">// -------------------------</span>
<a name="l00919"></a>00919                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTrans(*pBoxTrans);
<a name="l00920"></a>00920                 <span class="keyword">const</span> std::string str_trans(strTrans.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00921"></a>00921                 std::string strNEW_ResponseLEDGER = <a class="code" href="class_o_t_a_p_i___wrap.html#a99b35d10acdd06621bc28dac46e6fe54">OTAPI_Wrap::It</a>()-&gt;<a class="code" href="class_o_t_a_p_i___exec.html#aff7a984d28b09d76103f52faebfb754c">Transaction_CreateResponse</a>(str_server_id, str_nym_id, str_account_id, strResponseLedger, str_trans, <span class="keyword">true</span>); <span class="comment">// accept = true (versus rejecting a pending transfer, for example.)</span>
<a name="l00922"></a>00922 
<a name="l00923"></a>00923                 <span class="keywordflow">if</span> (strNEW_ResponseLEDGER.empty())
<a name="l00924"></a>00924                 {
<a name="l00925"></a>00925                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nFailure: OT_API_Transaction_CreateResponse returned NULL. (Skipping inbox for account %s)\n&quot;</span>,
<a name="l00926"></a>00926                                    str_account_id.c_str());
<a name="l00927"></a>00927                     <span class="keywordflow">continue</span>;
<a name="l00928"></a>00928                 }
<a name="l00929"></a>00929                 strResponseLedger = strNEW_ResponseLEDGER;
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931         } <span class="comment">// if (NULL != pInbox) FOR_EACH(mapOfTransactions, pInbox-&gt;GetTransactionMap())</span>
<a name="l00932"></a>00932         <span class="comment">// -------------------------------------------------</span>
<a name="l00933"></a>00933         <span class="comment">// Okay now we have the response ledger all ready to go, let&#39;s process it!</span>
<a name="l00934"></a>00934         <span class="comment">//</span>
<a name="l00935"></a>00935         <span class="keywordflow">if</span> (bFoundAnyToAccept &amp;&amp; !strResponseLedger.empty())
<a name="l00936"></a>00936         {
<a name="l00937"></a>00937             std::string strFinalizedResponse = <a class="code" href="class_o_t_a_p_i___wrap.html#a99b35d10acdd06621bc28dac46e6fe54">OTAPI_Wrap::It</a>()-&gt;<a class="code" href="class_o_t_a_p_i___exec.html#ae43e5ed33e7e2281c92a35818338c953">Ledger_FinalizeResponse</a>(str_server_id, str_nym_id, str_account_id, strResponseLedger);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939             <span class="keywordflow">if</span> (strFinalizedResponse.empty())
<a name="l00940"></a>00940             {
<a name="l00941"></a>00941                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nFailure: OT_API_Ledger_FinalizeResponse returned NULL. (Skipping inbox for account %s)\n&quot;</span>,
<a name="l00942"></a>00942                                str_account_id.c_str());
<a name="l00943"></a>00943                 <span class="keywordflow">continue</span>;
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945             <span class="comment">// ***************************************************************</span>
<a name="l00946"></a>00946             <span class="comment">// Instantiate the &quot;OT Made Easy&quot; object.</span>
<a name="l00947"></a>00947             <span class="comment">//</span>
<a name="l00948"></a>00948             <a class="code" href="class_o_t___m_e.html">OT_ME</a> madeEasy;
<a name="l00949"></a>00949 
<a name="l00950"></a>00950             <span class="comment">// Server communications are handled here...</span>
<a name="l00951"></a>00951             <span class="comment">//</span>
<a name="l00952"></a>00952             std::string strResponse = madeEasy.<a class="code" href="class_o_t___m_e.html#a436a1afe30549317bc906fb939d954a5">process_inbox</a>(str_server_id, str_nym_id, str_account_id, strFinalizedResponse);
<a name="l00953"></a>00953             std::string strAttempt  = <span class="stringliteral">&quot;process_inbox&quot;</span>;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             <span class="comment">// ***************************************************************</span>
<a name="l00956"></a>00956 
<a name="l00957"></a>00957             int32_t nInterpretReply = madeEasy.<a class="code" href="class_o_t___m_e.html#ae0c48ef64a9d5927b431fc9ade43fe9d">InterpretTransactionMsgReply</a>(str_server_id, str_nym_id, str_account_id, strAttempt, strResponse);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959             <span class="keywordflow">if</span> (1 == nInterpretReply)
<a name="l00960"></a>00960             {
<a name="l00961"></a>00961                 <span class="comment">// Download all the intermediary files (account balance, inbox, outbox, etc)</span>
<a name="l00962"></a>00962                 <span class="comment">// since they have probably changed from this operation.</span>
<a name="l00963"></a>00963                 <span class="comment">//</span>
<a name="l00964"></a>00964                 <span class="keywordtype">bool</span> bRetrieved = madeEasy.<a class="code" href="class_o_t___m_e.html#a318e950bbd83807a5654b9e59e9002d8">retrieve_account</a>(str_server_id, str_nym_id, str_account_id, <span class="keyword">true</span>); <span class="comment">//bForceDownload defaults to false.</span>
<a name="l00965"></a>00965 
<a name="l00966"></a>00966                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nServer response (%s): SUCCESS processing/accepting inbox.\n&quot;</span>, strAttempt.c_str());
<a name="l00967"></a>00967                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s retrieving intermediary files for account.\n&quot;</span>, (bRetrieved ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failed&quot;</span>));
<a name="l00968"></a>00968             }
<a name="l00969"></a>00969         }
<a name="l00970"></a>00970     } <span class="comment">// FOR_EACH_IT(list_of_strings, m_accounts, it_acct)</span>
<a name="l00971"></a>00971     <span class="comment">// ------------------------------------------------</span>
<a name="l00972"></a>00972     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 
<a name="l00979"></a><a class="code" href="_o_t_record_list_8cpp.html#a62f92aa6cb982ab391b04541e685681b">00979</a> <span class="keywordtype">bool</span> <a class="code" href="_o_t_record_list_8cpp.html#a62f92aa6cb982ab391b04541e685681b">compare_records</a> (<a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> i, <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> j)
<a name="l00980"></a>00980 {
<a name="l00981"></a>00981     <span class="keywordflow">return</span> j-&gt;operator&lt;(*i);
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 
<a name="l00985"></a>00985 <span class="comment">// ***************************************************</span>
<a name="l00986"></a>00986 <span class="comment">// POPULATE:</span>
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="comment">// Populates m_contents from OT API. Calls ClearContents().</span>
<a name="l00989"></a>00989 
<a name="l00990"></a><a class="code" href="class_o_t_record_list.html#a02be54bcb6a43c42719998a412471150">00990</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#a02be54bcb6a43c42719998a412471150">OTRecordList::Populate</a>()
<a name="l00991"></a>00991 {
<a name="l00992"></a>00992     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pLookup);
<a name="l00993"></a>00993     <span class="comment">// -----------------------</span>
<a name="l00994"></a>00994     <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">ClearContents</a>();
<a name="l00995"></a>00995     <span class="comment">// -----------------------</span>
<a name="l00996"></a>00996     <span class="comment">// Loop through all the accounts.</span>
<a name="l00997"></a>00997     <span class="comment">//</span>
<a name="l00998"></a>00998     <span class="comment">// From Open-Transactions.h:</span>
<a name="l00999"></a>00999     <span class="comment">// OTAPI_Wrap::OTAPI()-&gt;GetServerCount()</span>
<a name="l01000"></a>01000     <span class="comment">//</span>
<a name="l01001"></a>01001     <span class="comment">// From OTAPI.h:</span>
<a name="l01002"></a>01002     <span class="comment">// OTAPI_Wrap::GetServerCount()  // wraps the above call.</span>
<a name="l01003"></a>01003     <span class="comment">//</span>
<a name="l01004"></a>01004     <span class="comment">// -------------------------</span>
<a name="l01005"></a>01005     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01006"></a>01006     <span class="comment">// -------------------------</span>
<a name="l01007"></a>01007     <span class="keywordflow">if</span> (NULL == pWallet)
<a name="l01008"></a>01008     {
<a name="l01009"></a>01009         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTRecordList::%s: Error: Wallet is NULL.\n&quot;</span>, __FUNCTION__);
<a name="l01010"></a>01010         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01011"></a>01011     }
<a name="l01012"></a>01012     <span class="comment">// ------------------------------------------------</span>
<a name="l01013"></a>01013     <span class="comment">// Before populating, process out any items we&#39;re supposed to accept automatically.</span>
<a name="l01014"></a>01014     <span class="comment">//</span>
<a name="l01015"></a>01015     <a class="code" href="class_o_t_record_list.html#a46ecadc735b29bbc4c5c9b9a0f31d121">PerformAutoAccept</a>();
<a name="l01016"></a>01016     <span class="comment">// ------------------------------------------------</span>
<a name="l01017"></a>01017     <span class="comment">// OUTPAYMENTS, OUTMAIL, MAIL, PAYMENTS INBOX, and RECORD BOX (2 kinds.)</span>
<a name="l01018"></a>01018     <span class="comment">// Loop through the Nyms.</span>
<a name="l01019"></a>01019     <span class="comment">//</span>
<a name="l01020"></a>01020     <span class="keywordtype">int</span> nNymIndex = -1;
<a name="l01021"></a>01021     <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_nyms, it_nym)
<a name="l01022"></a>01022     {
<a name="l01023"></a>01023         ++nNymIndex;
<a name="l01024"></a>01024         <span class="comment">// ------------------------------------------------</span>
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (0 == nNymIndex)
<a name="l01026"></a>01026             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;=============== %s: Beginning loop through Nyms...\n&quot;</span>, __FUNCTION__);
<a name="l01027"></a>01027         <span class="comment">// ------------------------------------------------</span>
<a name="l01028"></a>01028         <span class="keyword">const</span> std::string  &amp; str_nym_id(*it_nym);
<a name="l01029"></a>01029         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theNymID  (str_nym_id);
<a name="l01030"></a>01030         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strNymID  (theNymID);
<a name="l01031"></a>01031         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(theNymID);
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">continue</span>;
<a name="l01033"></a>01033         <span class="comment">// ------------------------------------------------</span>
<a name="l01034"></a>01034         <span class="comment">// For each Nym, loop through his OUTPAYMENTS box.</span>
<a name="l01035"></a>01035         <span class="comment">//</span>
<a name="l01036"></a>01036         <span class="keyword">const</span> int32_t nOutpaymentsCount  = <a class="code" href="class_o_t_a_p_i___wrap.html#a2867a2de7baa62a90e24487bc1b7f8d4">OTAPI_Wrap::GetNym_OutpaymentsCount</a>(str_nym_id);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;--------\n%s: Nym %d, nOutpaymentsCount: %d, ID: %s\n&quot;</span>,
<a name="l01039"></a>01039                        __FUNCTION__, nNymIndex, nOutpaymentsCount, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01040"></a>01040         <span class="comment">// ------------------------------------------------</span>
<a name="l01041"></a>01041         <span class="keywordflow">for</span> ( int32_t nCurrentOutpayment = 0; nCurrentOutpayment &lt; nOutpaymentsCount; ++nCurrentOutpayment)
<a name="l01042"></a>01042         {
<a name="l01043"></a>01043             <span class="comment">// ------------------------------------------------</span>
<a name="l01044"></a>01044             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Outpayment instrument: %d\n&quot;</span>, __FUNCTION__, nCurrentOutpayment);
<a name="l01045"></a>01045             <span class="comment">// ------------------------------------------------</span>
<a name="l01046"></a>01046             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strOutpayment(
<a name="l01047"></a>01047                 <a class="code" href="class_o_t_a_p_i___wrap.html#a75db1f5164e65a9ddabef0fc551a4e3d">OTAPI_Wrap::GetNym_OutpaymentsContentsByIndex</a>(str_nym_id, nCurrentOutpayment));
<a name="l01048"></a>01048             <span class="comment">// ----------------------------------</span>
<a name="l01049"></a>01049             std::string str_memo;
<a name="l01050"></a>01050             <a class="code" href="class_o_t_payment.html">OTPayment</a>   theOutPayment(strOutpayment);
<a name="l01051"></a>01051 
<a name="l01052"></a>01052             <span class="keywordflow">if</span> (!theOutPayment.<a class="code" href="class_o_t_payment.html#a7f95ab568d481ecc7d38689c80caba84">IsValid</a>() || !theOutPayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l01053"></a>01053             {
<a name="l01054"></a>01054                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Skipping: Unable to load outpayments instrument from string:\n%s\n&quot;</span>,
<a name="l01055"></a>01055                               __FUNCTION__, strOutpayment.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01056"></a>01056                 <span class="keywordflow">continue</span>;
<a name="l01057"></a>01057             }
<a name="l01058"></a>01058             <span class="comment">// ----------------------------------</span>
<a name="l01059"></a>01059             int64_t lAmount = 0;
<a name="l01060"></a>01060             std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l01061"></a>01061 
<a name="l01062"></a>01062             <span class="keywordflow">if</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#acb3588ce12579879e64d65ed69afd5f6">GetAmount</a>(lAmount))
<a name="l01063"></a>01063             {
<a name="l01064"></a>01064                 <span class="keywordflow">if</span> (((<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0affdbd56df02df31d40b649a409d3c7c0">OTPayment::CHEQUE</a>  == theOutPayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>())  ||
<a name="l01065"></a>01065                      (<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0adb525a0bf8ba34c3d69b17208631ad2e">OTPayment::PURSE</a>   == theOutPayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>())  ||
<a name="l01066"></a>01066                      (<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0af981cfb9acea695a3ac8dac8455c3fef">OTPayment::VOUCHER</a> == theOutPayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>())) &amp;&amp; (lAmount &gt; 0))
<a name="l01067"></a>01067                     lAmount *= (-1);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                 <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0ad0c94c9025bb02cabfc2ead2ed8a990b">OTPayment::INVOICE</a>  == theOutPayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>())  &amp;&amp; (lAmount &lt; 0))
<a name="l01070"></a>01070                     lAmount *= (-1);
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01073"></a>01073                 strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01074"></a>01074                 str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01075"></a>01075             }
<a name="l01076"></a>01076             <span class="comment">// ----------------------------------</span>
<a name="l01077"></a>01077             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>        theAssetTypeID;
<a name="l01078"></a>01078             <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l01079"></a>01079             <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l01080"></a>01080             std::string str_outpmt_asset; <span class="comment">// The asset type we found on the payment (if we found anything.)</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082             <span class="keywordflow">if</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(theAssetTypeID))
<a name="l01083"></a>01083             {
<a name="l01084"></a>01084                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAssetTypeID);
<a name="l01085"></a>01085                 str_outpmt_asset = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01086"></a>01086                 <span class="comment">// -----------------------------</span>
<a name="l01087"></a>01087                 map_of_strings::iterator it_asset = m_assets.find(str_outpmt_asset);
<a name="l01088"></a>01088                 <span class="comment">// -----------------------------</span>
<a name="l01089"></a>01089                 <span class="keywordflow">if</span> (it_asset != m_assets.end()) <span class="comment">// Found it on the map of asset types we care about.</span>
<a name="l01090"></a>01090                 {
<a name="l01091"></a>01091                     p_str_asset_type = &amp;(it_asset-&gt;first);   <span class="comment">// Set the asset type ID.</span>
<a name="l01092"></a>01092                     p_str_asset_name = &amp;(it_asset-&gt;second);  <span class="comment">// The CurrencyTLA. Examples: USD, BTC, etc.</span>
<a name="l01093"></a>01093                 }
<a name="l01094"></a>01094                 <span class="keywordflow">else</span>
<a name="l01095"></a>01095                 {
<a name="l01096"></a>01096                     <span class="comment">// There was definitely an asset type on the instrument, and it definitely</span>
<a name="l01097"></a>01097                     <span class="comment">// did not match any of the assets that we care about.</span>
<a name="l01098"></a>01098                     <span class="comment">// Therefore, skip.</span>
<a name="l01099"></a>01099                     <span class="comment">//</span>
<a name="l01100"></a>01100                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping outpayment (we don&#39;t care about asset type %s)\n&quot;</span>,
<a name="l01101"></a>01101                                    __FUNCTION__, str_outpmt_asset.c_str());
<a name="l01102"></a>01102                     <span class="keywordflow">continue</span>;
<a name="l01103"></a>01103                 }
<a name="l01104"></a>01104             }
<a name="l01105"></a>01105             <span class="comment">// By this point, p_str_asset_type and p_str_asset_name are definitely set.</span>
<a name="l01106"></a>01106             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_type); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01107"></a>01107             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_name); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01108"></a>01108             <span class="comment">// ----------------------------------</span>
<a name="l01109"></a>01109             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l01110"></a>01110             <span class="keyword">const</span> std::string * p_str_account = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ACCOUNT</span>
<a name="l01111"></a>01111             std::string str_outpmt_account; <span class="comment">// The accountID we found on the payment (if we found anything.)</span>
<a name="l01112"></a>01112 
<a name="l01113"></a>01113             <span class="keywordflow">if</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theAccountID)) <span class="comment">// Since Nym is ME, the Account must be MY acct.</span>
<a name="l01114"></a>01114             {                                             <span class="comment">// (In Outpayments, the SENDER&#39;s account is MY acct.)</span>
<a name="l01115"></a>01115                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAccountID);
<a name="l01116"></a>01116                 str_outpmt_account = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01117"></a>01117                 <span class="comment">// -----------------------------</span>
<a name="l01118"></a>01118                 list_of_strings::iterator it_acct = std::find(m_accounts.begin(), m_accounts.end(), str_outpmt_account);
<a name="l01119"></a>01119                 <span class="comment">// -----------------------------</span>
<a name="l01120"></a>01120                 <span class="keywordflow">if</span> (it_acct != m_accounts.end()) <span class="comment">// Found it on the list of accounts we care about.</span>
<a name="l01121"></a>01121                 {
<a name="l01122"></a>01122                     p_str_account = &amp;(*it_acct);
<a name="l01123"></a>01123                 }
<a name="l01124"></a>01124                 <span class="comment">// We don&#39;t skip vouchers since the sender account (e.g. the server&#39;s account)</span>
<a name="l01125"></a>01125                 <span class="comment">// is definitely not one of my accounts -- so the voucher would end up getting</span>
<a name="l01126"></a>01126                 <span class="comment">// skipped every single time.</span>
<a name="l01127"></a>01127                 <span class="comment">//</span>
<a name="l01128"></a>01128 <span class="comment">//              else if (OTPayment::VOUCHER != theOutPayment.GetType())</span>
<a name="l01129"></a>01129                 <span class="keywordflow">else</span>
<a name="l01130"></a>01130                 {
<a name="l01131"></a>01131                     <span class="comment">// There was definitely an account on the instrument, and it definitely</span>
<a name="l01132"></a>01132                     <span class="comment">// did not match any of the accounts that we care about.</span>
<a name="l01133"></a>01133                     <span class="comment">// Therefore, skip.</span>
<a name="l01134"></a>01134                     <span class="comment">//</span>
<a name="l01135"></a>01135                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping outpayment (we don&#39;t care about account %s)\n&quot;</span>,
<a name="l01136"></a>01136                                    __FUNCTION__, str_outpmt_account.c_str());
<a name="l01137"></a>01137                     <span class="keywordflow">continue</span>;
<a name="l01138"></a>01138                 }
<a name="l01139"></a>01139             }
<a name="l01140"></a>01140             <span class="comment">// By this point, p_str_account is definitely set.</span>
<a name="l01141"></a>01141             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_account); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the accounts we care about.</span>
<a name="l01142"></a>01142             <span class="comment">// ----------------------------------</span>
<a name="l01143"></a>01143             <span class="comment">// strOutpayment contains the actual outgoing payment instrument.</span>
<a name="l01144"></a>01144             <span class="comment">//</span>
<a name="l01145"></a>01145             <span class="keyword">const</span> std::string str_outpmt_server =
<a name="l01146"></a>01146                 <a class="code" href="class_o_t_a_p_i___wrap.html#a38c7e7d4b3fc44afeabbd5d2b366355a">OTAPI_Wrap::GetNym_OutpaymentsServerIDByIndex</a>(str_nym_id, nCurrentOutpayment);
<a name="l01147"></a>01147             <span class="comment">// ----------------------------------</span>
<a name="l01148"></a>01148             <span class="keyword">const</span> std::string str_outpmt_recipientID =
<a name="l01149"></a>01149                 <a class="code" href="class_o_t_a_p_i___wrap.html#a721451913a7bd776050c2de68530060e">OTAPI_Wrap::GetNym_OutpaymentsRecipientIDByIndex</a>(str_nym_id, nCurrentOutpayment);
<a name="l01150"></a>01150             <span class="comment">// ----------------------------------</span>
<a name="l01151"></a>01151             <span class="comment">// str_outpmt_server is the server for this outpayment.</span>
<a name="l01152"></a>01152             <span class="comment">// But is that server on our list of servers that we care about?</span>
<a name="l01153"></a>01153             <span class="comment">// Let&#39;s see if that server is on m_servers (otherwise we can skip it.)</span>
<a name="l01154"></a>01154             <span class="comment">// Also, let&#39;s do the same for asset types.</span>
<a name="l01155"></a>01155             <span class="comment">//</span>
<a name="l01156"></a>01156             list_of_strings::iterator it_server = std::find(m_servers.begin(), m_servers.end(), str_outpmt_server);
<a name="l01157"></a>01157 
<a name="l01158"></a>01158             <span class="keywordflow">if</span> (it_server != m_servers.end()) <span class="comment">// Found the serverID on the list of servers we care about.</span>
<a name="l01159"></a>01159             {
<a name="l01160"></a>01160                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01161"></a>01161                 <span class="comment">// TODO OPTIMIZE: instead of looking up the Nym&#39;s name every time, look it</span>
<a name="l01162"></a>01162                 <span class="comment">// up ONCE when first adding the NymID. Add it to a map, instead of a list,</span>
<a name="l01163"></a>01163                 <span class="comment">// and add the Nym&#39;s name as the second item in the map&#39;s pair.</span>
<a name="l01164"></a>01164                 <span class="comment">// (Just like I already did with the asset type.)</span>
<a name="l01165"></a>01165                 <span class="comment">//</span>
<a name="l01166"></a>01166                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_outpmt_recipientID, &amp;(*it_server))), strNameTemp;
<a name="l01167"></a>01167                 std::string  str_name;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l01170"></a>01170                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l01171"></a>01171                 <span class="keywordflow">else</span>
<a name="l01172"></a>01172                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_outpmt_recipientID.c_str());
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                 str_name = strNameTemp.Get();
<a name="l01175"></a>01175                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01176"></a>01176                 <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l01177"></a>01177                 <span class="keywordflow">if</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#a76ed76e62e9b57487f08a6f1296260ab">GetMemo</a>(strMemo))
<a name="l01178"></a>01178                 {
<a name="l01179"></a>01179                     str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01180"></a>01180                 }
<a name="l01181"></a>01181                 <span class="comment">// ----------------------------------</span>
<a name="l01182"></a>01182                 <span class="comment">// For the &quot;date&quot; on this record we&#39;re using the &quot;valid from&quot; date on the instrument.</span>
<a name="l01183"></a>01183                 std::string str_date = <span class="stringliteral">&quot;0&quot;</span>;
<a name="l01184"></a>01184                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l01185"></a>01185                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187                 <span class="keywordflow">if</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#af3c3ed5823d48d9cf86463987f67ddae">GetValidFrom</a>(tFrom))
<a name="l01188"></a>01188                 {
<a name="l01189"></a>01189                     <span class="keyword">const</span> uint64_t lFrom = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tFrom);
<a name="l01190"></a>01190                     <a class="code" href="class_o_t_string.html">OTString</a> strFrom;
<a name="l01191"></a>01191                     strFrom.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lFrom);
<a name="l01192"></a>01192                     str_date = strFrom.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01193"></a>01193                 }
<a name="l01194"></a>01194                 theOutPayment.<a class="code" href="class_o_t_payment.html#a11dbba988d5da835179885043b4c3979">GetValidTo</a>(tTo);
<a name="l01195"></a>01195                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01196"></a>01196                 <span class="comment">// Instrument type (cheque, voucher, etc)</span>
<a name="l01197"></a>01197                 <span class="comment">//</span>
<a name="l01198"></a>01198                 <span class="keywordtype">int</span> nType = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span> (theOutPayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>());
<a name="l01199"></a>01199 
<a name="l01200"></a>01200                 <span class="keyword">const</span> std::string &amp; str_type = <a class="code" href="_o_t_record_8hpp.html#aad2c87d02cf1bd05c6f519117deb93d9">OTRecord_GetTypeString</a>(nType);
<a name="l01201"></a>01201                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01202"></a>01202                 <span class="comment">// CREATE A OTRecord AND POPULATE IT...</span>
<a name="l01203"></a>01203                 <span class="comment">//</span>
<a name="l01204"></a>01204                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: pending outgoing instrument (str_type: %s)\n&quot;</span>,
<a name="l01205"></a>01205                                __FUNCTION__, str_type.c_str());
<a name="l01206"></a>01206 
<a name="l01207"></a>01207                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l01208"></a>01208                                                            *p_str_asset_type,
<a name="l01209"></a>01209                                                            *p_str_asset_name,
<a name="l01210"></a>01210                                                             str_nym_id,    <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l01211"></a>01211                                                            *p_str_account, <span class="comment">// This is the Nym&#39;s account according to the payment instrument, IF that account was found on our list of accounts we care about. Or it&#39;s blank if no account was found on the payment instrument.</span>
<a name="l01212"></a>01212                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l01213"></a>01213                                                            <span class="comment">// -----------------------------</span>
<a name="l01214"></a>01214                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l01215"></a>01215                                                            str_name, <span class="comment">// name of recipient (since its in outpayments box.)</span>
<a name="l01216"></a>01216                                                            str_date, <span class="comment">// the &quot;valid from&quot; date on the instrument.</span>
<a name="l01217"></a>01217                                                            str_amount,
<a name="l01218"></a>01218                                                            str_type, <span class="comment">// cheque, voucher, smart contract, etc</span>
<a name="l01219"></a>01219                                                            <span class="keyword">true</span>,   <span class="comment">//bIsPending=true since its in the outpayments box.</span>
<a name="l01220"></a>01220                                                            <span class="keyword">true</span>,   <span class="comment">//bIsOutgoing=true. Otherwise it&#39;d be in record box already.</span>
<a name="l01221"></a>01221                                                            <span class="keyword">false</span>,<span class="comment">//IsRecord</span>
<a name="l01222"></a>01222                                                            <span class="keyword">false</span>,<span class="comment">//IsReceipt</span>
<a name="l01223"></a>01223                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da6df8bc1fa86af318441b6d9b44884379">OTRecord::Instrument</a>
<a name="l01224"></a>01224                                                            ));
<a name="l01225"></a>01225                 <span class="comment">// -------------------------------------------------</span>
<a name="l01226"></a>01226                 sp_Record-&gt;SetContents(strOutpayment.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01227"></a>01227                 <span class="comment">// -------------------------------------------------</span>
<a name="l01228"></a>01228                 sp_Record-&gt;SetOtherNymID(str_outpmt_recipientID);
<a name="l01229"></a>01229                 <span class="comment">// -------------------------------------------------</span>
<a name="l01230"></a>01230                 <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l01231"></a>01231                     sp_Record-&gt;SetMemo(str_memo);
<a name="l01232"></a>01232                 <span class="comment">// -------------------------------------------------</span>
<a name="l01233"></a>01233                 sp_Record-&gt;SetDateRange(tFrom, tTo);
<a name="l01234"></a>01234                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nCurrentOutpayment));
<a name="l01235"></a>01235                 <span class="comment">// -------------------------------------------------</span>
<a name="l01236"></a>01236                 int64_t lTransNum = 0;
<a name="l01237"></a>01237                 theOutPayment.<a class="code" href="class_o_t_payment.html#a4a6c103790c2fc759136079db0e65434">GetOpeningNum</a>(lTransNum, theNymID);
<a name="l01238"></a>01238                 <span class="comment">// -------------------------------------------------</span>
<a name="l01239"></a>01239                 sp_Record-&gt;SetTransactionNum(lTransNum);
<a name="l01240"></a>01240                 m_contents.push_back(sp_Record);
<a name="l01241"></a>01241             }
<a name="l01242"></a>01242             <span class="keywordflow">else</span> <span class="comment">// the server for this outpayment is not on the list of servers we care about. Skip this outpayment.</span>
<a name="l01243"></a>01243             {
<a name="l01244"></a>01244                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping outgoing instrument (we don&#39;t care about server %s)\n&quot;</span>,
<a name="l01245"></a>01245                                __FUNCTION__, str_outpmt_server.c_str());
<a name="l01246"></a>01246                 <span class="keywordflow">continue</span>;
<a name="l01247"></a>01247             }
<a name="l01248"></a>01248         } <span class="comment">// for outpayments.</span>
<a name="l01249"></a>01249         <span class="comment">// ------------------------------------------------</span>
<a name="l01250"></a>01250         <span class="comment">// For each Nym, loop through his MAIL box.</span>
<a name="l01251"></a>01251         <span class="comment">//</span>
<a name="l01252"></a>01252         <span class="keyword">const</span> int32_t nMailCount  = <a class="code" href="class_o_t_a_p_i___wrap.html#abee93614f4a19e0461a51981d2004044">OTAPI_Wrap::GetNym_MailCount</a>(str_nym_id);
<a name="l01253"></a>01253         <span class="keywordflow">for</span> ( int32_t nCurrentMail = 0; nCurrentMail &lt; nMailCount; ++nCurrentMail)
<a name="l01254"></a>01254         {
<a name="l01255"></a>01255             <span class="comment">// ------------------------------------------------</span>
<a name="l01256"></a>01256             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Mail index: %d\n&quot;</span>, __FUNCTION__, nCurrentMail);
<a name="l01257"></a>01257             <span class="comment">// ------------------------------------------------</span>
<a name="l01258"></a>01258             <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a41d4a62c9e863fa982c7b4899bfcd3cb">GetMailByIndex</a>(static_cast&lt;int&gt;(nCurrentMail));
<a name="l01259"></a>01259             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMsg);
<a name="l01260"></a>01260             <span class="comment">// ------------------------------------------------</span>
<a name="l01261"></a>01261             <span class="keyword">const</span> std::string str_mail_server =
<a name="l01262"></a>01262                 <a class="code" href="class_o_t_a_p_i___wrap.html#a7f74f9dfbd1b856204ebc854e0c51d94">OTAPI_Wrap::GetNym_MailServerIDByIndex</a>(str_nym_id, nCurrentMail);
<a name="l01263"></a>01263             <span class="comment">// ----------------------------------</span>
<a name="l01264"></a>01264             <span class="keyword">const</span> std::string str_mail_senderID =
<a name="l01265"></a>01265                 <a class="code" href="class_o_t_a_p_i___wrap.html#a40cb3129dbf4f5af024fbc826c630a49">OTAPI_Wrap::GetNym_MailSenderIDByIndex</a>(str_nym_id, nCurrentMail);
<a name="l01266"></a>01266             <span class="comment">// ----------------------------------</span>
<a name="l01267"></a>01267             <span class="comment">// str_mail_server is the server for this mail.</span>
<a name="l01268"></a>01268             <span class="comment">// But is that server on our list of servers that we care about?</span>
<a name="l01269"></a>01269             <span class="comment">// Let&#39;s see if that server is on m_servers (otherwise we can skip it.)</span>
<a name="l01270"></a>01270             <span class="comment">//</span>
<a name="l01271"></a>01271             list_of_strings::iterator it_server = std::find(m_servers.begin(), m_servers.end(), str_mail_server);
<a name="l01272"></a>01272 
<a name="l01273"></a>01273             <span class="keywordflow">if</span> (it_server != m_servers.end()) <span class="comment">// Found the serverID on the list of servers we care about.</span>
<a name="l01274"></a>01274             {
<a name="l01275"></a>01275                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01276"></a>01276                 <span class="comment">// TODO OPTIMIZE: instead of looking up the Nym&#39;s name every time, look it</span>
<a name="l01277"></a>01277                 <span class="comment">// up ONCE when first adding the NymID. Add it to a map, instead of a list,</span>
<a name="l01278"></a>01278                 <span class="comment">// and add the Nym&#39;s name as the second item in the map&#39;s pair.</span>
<a name="l01279"></a>01279                 <span class="comment">// (Just like I already did with the asset type.)</span>
<a name="l01280"></a>01280                 <span class="comment">//</span>
<a name="l01281"></a>01281                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_mail_senderID, &amp;(*it_server))), strNameTemp;
<a name="l01282"></a>01282                 std::string  str_name;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l01285"></a>01285                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l01286"></a>01286                 <span class="keywordflow">else</span>
<a name="l01287"></a>01287                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_mail_senderID.c_str());
<a name="l01288"></a>01288 
<a name="l01289"></a>01289                 str_name = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l01290"></a>01290                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01291"></a>01291                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l01292"></a>01292                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l01293"></a>01293                 <span class="keyword">const</span> std::string * p_str_account    = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ACCOUNT</span>
<a name="l01294"></a>01294 
<a name="l01295"></a>01295                 std::string str_amount; <span class="comment">// There IS NO amount, on mail. (So we leave this empty.)</span>
<a name="l01296"></a>01296 
<a name="l01297"></a>01297                 uint64_t lDate = pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>;
<a name="l01298"></a>01298                 <a class="code" href="class_o_t_string.html">OTString</a> strDate;
<a name="l01299"></a>01299                 strDate.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDate);
<a name="l01300"></a>01300                 <span class="keyword">const</span> std::string str_date(strDate.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01301"></a>01301                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01302"></a>01302                 <span class="comment">// CREATE A OTRecord AND POPULATE IT...</span>
<a name="l01303"></a>01303                 <span class="comment">//</span>
<a name="l01304"></a>01304                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: incoming mail.\n&quot;</span>, __FUNCTION__);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l01307"></a>01307                                                            *p_str_asset_type,
<a name="l01308"></a>01308                                                            *p_str_asset_name,
<a name="l01309"></a>01309                                                            str_nym_id,     <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l01310"></a>01310                                                            *p_str_account, <span class="comment">// This is the Nym&#39;s account according to the payment instrument, IF that account was found on our list of accounts we care about. Or it&#39;s blank if no account was found on the payment instrument.</span>
<a name="l01311"></a>01311                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l01312"></a>01312                                                            <span class="comment">// -----------------------------</span>
<a name="l01313"></a>01313                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l01314"></a>01314                                                            str_name, <span class="comment">// name of sender (since its in incoming mail box.)</span>
<a name="l01315"></a>01315                                                            str_date, <span class="comment">// How do we get the date from a mail?</span>
<a name="l01316"></a>01316                                                            str_amount,
<a name="l01317"></a>01317                                                            OTRecordList::s_message_type, <span class="comment">// &quot;message&quot;</span>
<a name="l01318"></a>01318                                                            <span class="keyword">false</span>, <span class="comment">//bIsPending=false since its already received.</span>
<a name="l01319"></a>01319                                                            <span class="keyword">false</span>, <span class="comment">//bIsOutgoing=false. It&#39;s incoming mail, not outgoing mail.</span>
<a name="l01320"></a>01320                                                            <span class="keyword">false</span>, <span class="comment">//IsRecord</span>
<a name="l01321"></a>01321                                                            <span class="keyword">false</span>, <span class="comment">//IsReceipt</span>
<a name="l01322"></a>01322                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2daa1499facbc577854221564f426795a9e">OTRecord::Mail</a>
<a name="l01323"></a>01323                                                            ));
<a name="l01324"></a>01324                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strMail(<a class="code" href="class_o_t_a_p_i___wrap.html#a004c8bd1edb35081e16bda52ded7038a">OTAPI_Wrap::GetNym_MailContentsByIndex</a>(str_nym_id, nCurrentMail));
<a name="l01325"></a>01325                 sp_Record-&gt;SetContents(strMail.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01326"></a>01326                 <span class="comment">// -------------------------------------------------</span>
<a name="l01327"></a>01327                 sp_Record-&gt;SetOtherNymID(str_mail_senderID);
<a name="l01328"></a>01328                 <span class="comment">// -------------------------------------------------</span>
<a name="l01329"></a>01329                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nCurrentMail));
<a name="l01330"></a>01330                 <span class="comment">// -------------------------------------------------</span>
<a name="l01331"></a>01331                 sp_Record-&gt;SetDateRange(<a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>), <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>));
<a name="l01332"></a>01332                 <span class="comment">// -------------------------------------------------</span>
<a name="l01333"></a>01333                 m_contents.push_back(sp_Record);
<a name="l01334"></a>01334             }
<a name="l01335"></a>01335         } <span class="comment">// loop through incoming Mail.</span>
<a name="l01336"></a>01336         <span class="comment">// ------------------------------------------------</span>
<a name="l01337"></a>01337         <span class="comment">// Outmail</span>
<a name="l01338"></a>01338         <span class="comment">//</span>
<a name="l01339"></a>01339         <span class="keyword">const</span> int32_t nOutmailCount   = <a class="code" href="class_o_t_a_p_i___wrap.html#a2bf01a333520cc12fb4be0c0163a0154">OTAPI_Wrap::GetNym_OutmailCount</a>(str_nym_id);
<a name="l01340"></a>01340         <span class="keywordflow">for</span> ( int32_t nCurrentOutmail = 0; nCurrentOutmail &lt; nOutmailCount; ++nCurrentOutmail)
<a name="l01341"></a>01341         {
<a name="l01342"></a>01342             <span class="comment">// ------------------------------------------------</span>
<a name="l01343"></a>01343             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Outmail index: %d\n&quot;</span>, __FUNCTION__, nCurrentOutmail);
<a name="l01344"></a>01344             <span class="comment">// ------------------------------------------------</span>
<a name="l01345"></a>01345             <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a126bbb8a3d356a0fd2118c95dfe6cbea">GetOutmailByIndex</a>(static_cast&lt;int&gt;(nCurrentOutmail));
<a name="l01346"></a>01346             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMsg);
<a name="l01347"></a>01347             <span class="comment">// ------------------------------------------------</span>
<a name="l01348"></a>01348             <span class="keyword">const</span> std::string str_mail_server =
<a name="l01349"></a>01349                 <a class="code" href="class_o_t_a_p_i___wrap.html#ab7b4f640fcb700924578894d1d1a0d9d">OTAPI_Wrap::GetNym_OutmailServerIDByIndex</a>(str_nym_id, nCurrentOutmail);
<a name="l01350"></a>01350             <span class="comment">// ----------------------------------</span>
<a name="l01351"></a>01351             <span class="keyword">const</span> std::string str_mail_recipientID =
<a name="l01352"></a>01352                 <a class="code" href="class_o_t_a_p_i___wrap.html#a4c2cf6833cabdb3b5c389752c0ced7c0">OTAPI_Wrap::GetNym_OutmailRecipientIDByIndex</a>(str_nym_id, nCurrentOutmail);
<a name="l01353"></a>01353             <span class="comment">// ----------------------------------</span>
<a name="l01354"></a>01354             <span class="comment">// str_mail_server is the server for this mail.</span>
<a name="l01355"></a>01355             <span class="comment">// But is that server on our list of servers that we care about?</span>
<a name="l01356"></a>01356             <span class="comment">// Let&#39;s see if that server is on m_servers (otherwise we can skip it.)</span>
<a name="l01357"></a>01357             <span class="comment">//</span>
<a name="l01358"></a>01358             list_of_strings::iterator it_server = std::find(m_servers.begin(), m_servers.end(), str_mail_server);
<a name="l01359"></a>01359 
<a name="l01360"></a>01360             <span class="keywordflow">if</span> (it_server != m_servers.end()) <span class="comment">// Found the serverID on the list of servers we care about.</span>
<a name="l01361"></a>01361             {
<a name="l01362"></a>01362                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01363"></a>01363                 <span class="comment">// TODO OPTIMIZE: instead of looking up the Nym&#39;s name every time, look it</span>
<a name="l01364"></a>01364                 <span class="comment">// up ONCE when first adding the NymID. Add it to a map, instead of a list,</span>
<a name="l01365"></a>01365                 <span class="comment">// and add the Nym&#39;s name as the second item in the map&#39;s pair.</span>
<a name="l01366"></a>01366                 <span class="comment">// (Just like I already did with the asset type.)</span>
<a name="l01367"></a>01367                 <span class="comment">//</span>
<a name="l01368"></a>01368                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_mail_recipientID, &amp;(*it_server))), strNameTemp;
<a name="l01369"></a>01369                 std::string  str_name;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l01372"></a>01372                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l01373"></a>01373                 <span class="keywordflow">else</span>
<a name="l01374"></a>01374                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_mail_recipientID.c_str());
<a name="l01375"></a>01375 
<a name="l01376"></a>01376                 str_name = strNameTemp.Get();
<a name="l01377"></a>01377                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01378"></a>01378                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l01379"></a>01379                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l01380"></a>01380                 <span class="keyword">const</span> std::string * p_str_account    = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ACCOUNT</span>
<a name="l01381"></a>01381 
<a name="l01382"></a>01382                 std::string str_amount; <span class="comment">// There IS NO amount, on mail. (So we leave this empty.)</span>
<a name="l01383"></a>01383 
<a name="l01384"></a>01384                 uint64_t lDate = pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>;
<a name="l01385"></a>01385                 <a class="code" href="class_o_t_string.html">OTString</a> strDate;
<a name="l01386"></a>01386                 strDate.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDate);
<a name="l01387"></a>01387                 <span class="keyword">const</span> std::string str_date(strDate.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01388"></a>01388                 <span class="comment">// ---------------------------------------------------</span>
<a name="l01389"></a>01389                 <span class="comment">// CREATE A OTRecord AND POPULATE IT...</span>
<a name="l01390"></a>01390                 <span class="comment">//</span>
<a name="l01391"></a>01391                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: sent mail.\n&quot;</span>, __FUNCTION__);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l01394"></a>01394                                                            *p_str_asset_type,
<a name="l01395"></a>01395                                                            *p_str_asset_name,
<a name="l01396"></a>01396                                                            str_nym_id,     <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l01397"></a>01397                                                            *p_str_account, <span class="comment">// This is the Nym&#39;s account according to the payment instrument, IF that account was found on our list of accounts we care about. Or it&#39;s blank if no account was found on the payment instrument.</span>
<a name="l01398"></a>01398                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l01399"></a>01399                                                            <span class="comment">// -----------------------------</span>
<a name="l01400"></a>01400                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l01401"></a>01401                                                            str_name, <span class="comment">// name of recipient (since its in outgoing mail box.)</span>
<a name="l01402"></a>01402                                                            str_date, <span class="comment">// How do we get the date from a mail?</span>
<a name="l01403"></a>01403                                                            str_amount,
<a name="l01404"></a>01404                                                            OTRecordList::s_message_type, <span class="comment">// &quot;message&quot;</span>
<a name="l01405"></a>01405                                                            <span class="keyword">false</span>, <span class="comment">//bIsPending=false since its already sent.</span>
<a name="l01406"></a>01406                                                            <span class="keyword">true</span>,  <span class="comment">//bIsOutgoing=true. It&#39;s OUTGOING mail.</span>
<a name="l01407"></a>01407                                                            <span class="keyword">false</span>, <span class="comment">//IsRecord (it&#39;s not in the record box.)</span>
<a name="l01408"></a>01408                                                            <span class="keyword">false</span>, <span class="comment">//IsReceipt</span>
<a name="l01409"></a>01409                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2daa1499facbc577854221564f426795a9e">OTRecord::Mail</a>
<a name="l01410"></a>01410                                                            ));
<a name="l01411"></a>01411                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strOutmail(<a class="code" href="class_o_t_a_p_i___wrap.html#ac602409047d0d0a6896f1e403b280c52">OTAPI_Wrap::GetNym_OutmailContentsByIndex</a>(str_nym_id, nCurrentOutmail));
<a name="l01412"></a>01412                 sp_Record-&gt;SetContents(strOutmail.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01413"></a>01413                 <span class="comment">// -------------------------------------------------</span>
<a name="l01414"></a>01414                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nCurrentOutmail));
<a name="l01415"></a>01415                 <span class="comment">// -------------------------------------------------</span>
<a name="l01416"></a>01416                 sp_Record-&gt;SetOtherNymID(str_mail_recipientID);
<a name="l01417"></a>01417                 <span class="comment">// -------------------------------------------------</span>
<a name="l01418"></a>01418                 sp_Record-&gt;SetDateRange(<a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>), <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(pMsg-&gt;<a class="code" href="class_o_t_message.html#a3054731e37b5da75a93dedd4c77ee548">m_lTime</a>));
<a name="l01419"></a>01419                 <span class="comment">// -------------------------------------------------</span>
<a name="l01420"></a>01420                 m_contents.push_back(sp_Record);
<a name="l01421"></a>01421             }
<a name="l01422"></a>01422         } <span class="comment">// loop through outgoing Mail.</span>
<a name="l01423"></a>01423         <span class="comment">// ------------------------------------------------</span>
<a name="l01424"></a>01424         <span class="comment">// For each nym, for each server, loop through its payments inbox and record box.</span>
<a name="l01425"></a>01425         <span class="comment">//</span>
<a name="l01426"></a>01426         <span class="keywordtype">int</span> nServerIndex = -1;
<a name="l01427"></a>01427         <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_servers, it_server)
<a name="l01428"></a>01428         {
<a name="l01429"></a>01429             ++nServerIndex;
<a name="l01430"></a>01430             <span class="comment">// --------------------------</span>
<a name="l01431"></a>01431             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theServerID(*it_server);
<a name="l01432"></a>01432             <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pServer = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(theServerID);
<a name="l01433"></a>01433             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pServer);
<a name="l01434"></a>01434             <span class="comment">// ------------------------------------------------</span>
<a name="l01435"></a>01435             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
<a name="l01436"></a>01436             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Server %d, ID: %s\n&quot;</span>, __FUNCTION__, nServerIndex, strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01437"></a>01437             <span class="comment">// ------------------------------------------------</span>
<a name="l01438"></a>01438             <span class="comment">// OPTIMIZE FYI:</span>
<a name="l01439"></a>01439             <span class="comment">// The &quot;NoVerify&quot; version is much faster, but you will lose the ability to get the</span>
<a name="l01440"></a>01440             <span class="comment">// sender/recipient name from the receipts in the box. The code will, however, work</span>
<a name="l01441"></a>01441             <span class="comment">// either way.</span>
<a name="l01442"></a>01442             <span class="comment">//</span>
<a name="l01443"></a>01443             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a8e02cb186854f0b325c4c55da69f2e55">LoadPaymentInboxNoVerify</a>(theServerID, theNymID) :
<a name="l01444"></a>01444                                              <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a5077987cf25f441923c88cb51b3d940a">LoadPaymentInbox</a>        (theServerID, theNymID);
<a name="l01445"></a>01445             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l01446"></a>01446 
<a name="l01447"></a>01447             int32_t  nIndex = (-1);
<a name="l01448"></a>01448             <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l01449"></a>01449             <span class="keywordflow">if</span> (NULL != pInbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pInbox-&gt;GetTransactionMap())
<a name="l01450"></a>01450             {
<a name="l01451"></a>01451                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l01452"></a>01452                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l01453"></a>01453                 <span class="comment">// ------------------------------</span>
<a name="l01454"></a>01454                 ++nIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01455"></a>01455                 <span class="comment">// ------------------------------------------------</span>
<a name="l01456"></a>01456                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Incoming payment: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01457"></a>01457                 <span class="comment">// ------------------------------------------------</span>
<a name="l01458"></a>01458                 std::string  str_name; <span class="comment">// name of sender (since its in the payments inbox.)</span>
<a name="l01459"></a>01459                 std::string  str_sender_nym_id;
<a name="l01460"></a>01460                 std::string  str_sender_acct_id;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01463"></a>01463                 {
<a name="l01464"></a>01464                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderID;
<a name="l01465"></a>01465 
<a name="l01466"></a>01466                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l01467"></a>01467                     {
<a name="l01468"></a>01468                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderID(theSenderID);
<a name="l01469"></a>01469                         str_sender_nym_id = strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01470"></a>01470 
<a name="l01471"></a>01471                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_sender_nym_id, &amp;(*it_server))), strNameTemp;
<a name="l01472"></a>01472 
<a name="l01473"></a>01473                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l01474"></a>01474                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l01475"></a>01475                         <span class="keywordflow">else</span>
<a name="l01476"></a>01476                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_nym_id.c_str());
<a name="l01477"></a>01477 
<a name="l01478"></a>01478                         str_name = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l01479"></a>01479                     }
<a name="l01480"></a>01480 
<a name="l01481"></a>01481                     theSenderID.<a class="code" href="class_o_t_data.html#aab9a5758e85597ef1d7250bcf2cc56a6">Release</a>();
<a name="l01482"></a>01482 
<a name="l01483"></a>01483                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderID))
<a name="l01484"></a>01484                     {
<a name="l01485"></a>01485                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderID(theSenderID);
<a name="l01486"></a>01486                         str_sender_acct_id = strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01487"></a>01487                     }
<a name="l01488"></a>01488                 }
<a name="l01489"></a>01489                 <span class="comment">// ------------------------------</span>
<a name="l01490"></a>01490                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l01491"></a>01491                 <span class="comment">// ----------------------------------</span>
<a name="l01492"></a>01492                 std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l01493"></a>01493                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l01494"></a>01494 
<a name="l01495"></a>01495                 <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l01496"></a>01496                 {
<a name="l01497"></a>01497                     tValidFrom = tDateSigned;
<a name="l01498"></a>01498                     <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l01499"></a>01499                     <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l01500"></a>01500                     strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l01501"></a>01501                     str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01502"></a>01502                 }
<a name="l01503"></a>01503                 <span class="comment">// ----------------------------------</span>
<a name="l01504"></a>01504                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l01505"></a>01505                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l01506"></a>01506                 <span class="comment">// ----------------------------------</span>
<a name="l01507"></a>01507                 std::string str_amount;   <span class="comment">// &lt;========== AMOUNT</span>
<a name="l01508"></a>01508                 std::string str_type;     <span class="comment">// Instrument type.</span>
<a name="l01509"></a>01509                 std::string str_memo;
<a name="l01510"></a>01510                 <a class="code" href="class_o_t_string.html">OTString</a>    strContents; <span class="comment">// Instrument contents.</span>
<a name="l01511"></a>01511 
<a name="l01512"></a>01512                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01513"></a>01513                 {
<a name="l01514"></a>01514                     str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l01515"></a>01515                     <span class="comment">// --------------------------------------------------</span>
<a name="l01516"></a>01516                     int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l01517"></a>01517 
<a name="l01518"></a>01518                     <span class="keywordflow">if</span> (0 != lAmount)
<a name="l01519"></a>01519                     {
<a name="l01520"></a>01520                         <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01521"></a>01521                         strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01522"></a>01522                         str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01523"></a>01523                     }
<a name="l01524"></a>01524                 }
<a name="l01525"></a>01525                 <span class="keywordflow">else</span> <span class="comment">// NOT abbreviated. (Full box receipt is already loaded.)</span>
<a name="l01526"></a>01526                 {
<a name="l01527"></a>01527                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = pInbox-&gt;GetInstrument(*pNym,
<a name="l01528"></a>01528                                                                  nIndex);     <span class="comment">// ===&gt; Returns financial instrument by index.</span>
<a name="l01529"></a>01529                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l01530"></a>01530                     <span class="comment">// ------------------------------</span>
<a name="l01531"></a>01531                     <span class="keywordflow">if</span> (NULL == pPayment) <span class="comment">// then we treat it like it&#39;s abbreviated.</span>
<a name="l01532"></a>01532                     {
<a name="l01533"></a>01533                         str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l01534"></a>01534                         <span class="comment">// --------------------------------------------------</span>
<a name="l01535"></a>01535                         int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l01536"></a>01536 
<a name="l01537"></a>01537                         <span class="keywordflow">if</span> (0 == lAmount)
<a name="l01538"></a>01538                             lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l01539"></a>01539                         <span class="comment">// -----------------------------------------</span>
<a name="l01540"></a>01540                         <span class="keywordflow">if</span> (0 != lAmount)
<a name="l01541"></a>01541                         {
<a name="l01542"></a>01542                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01543"></a>01543                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01544"></a>01544                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01545"></a>01545                         }
<a name="l01546"></a>01546                     }
<a name="l01547"></a>01547                     <span class="comment">// ---------------------------------------------------</span>
<a name="l01548"></a>01548                     <span class="comment">// We have pPayment, the instrument accompanying the receipt in the payments inbox.</span>
<a name="l01549"></a>01549                     <span class="comment">//</span>
<a name="l01550"></a>01550                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l01551"></a>01551                     {
<a name="l01552"></a>01552                         <span class="comment">// ----------------------------------</span>
<a name="l01553"></a>01553                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#af3c3ed5823d48d9cf86463987f67ddae">GetValidFrom</a>(tValidFrom);
<a name="l01554"></a>01554                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a11dbba988d5da835179885043b4c3979">GetValidTo</a>  (tValidTo);
<a name="l01555"></a>01555 
<a name="l01556"></a>01556                         <span class="keywordflow">if</span> (tValidFrom &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l01557"></a>01557                         {
<a name="l01558"></a>01558                             <span class="keyword">const</span> uint64_t lFrom = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tValidFrom);
<a name="l01559"></a>01559                             <a class="code" href="class_o_t_string.html">OTString</a> strFrom;
<a name="l01560"></a>01560                             strFrom.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lFrom);
<a name="l01561"></a>01561                             str_date = strFrom.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01562"></a>01562                         }
<a name="l01563"></a>01563                         <span class="comment">// ----------------------------------</span>
<a name="l01564"></a>01564                         <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l01565"></a>01565                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a76ed76e62e9b57487f08a6f1296260ab">GetMemo</a>(strMemo))
<a name="l01566"></a>01566                         {
<a name="l01567"></a>01567                             str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01568"></a>01568                         }
<a name="l01569"></a>01569                         <span class="comment">// ----------------------------------</span>
<a name="l01570"></a>01570                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strContents);
<a name="l01571"></a>01571                         <span class="comment">// -----------------------------</span>
<a name="l01572"></a>01572                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetTypeID, theSenderAcctID;
<a name="l01573"></a>01573 
<a name="l01574"></a>01574                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(theAssetTypeID))
<a name="l01575"></a>01575                         {
<a name="l01576"></a>01576                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAssetTypeID);
<a name="l01577"></a>01577                             <span class="keyword">const</span> std::string str_inpmt_asset(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// The asset type we found on the payment (if we found anything.)</span>
<a name="l01578"></a>01578                             <span class="comment">// -----------------------------</span>
<a name="l01579"></a>01579                             map_of_strings::iterator it_asset = m_assets.find(str_inpmt_asset);
<a name="l01580"></a>01580                             <span class="comment">// -----------------------------</span>
<a name="l01581"></a>01581                             <span class="keywordflow">if</span> (it_asset != m_assets.end()) <span class="comment">// Found it on the map of asset types we care about.</span>
<a name="l01582"></a>01582                             {
<a name="l01583"></a>01583                                 p_str_asset_type = &amp;(it_asset-&gt;first);   <span class="comment">// Set the asset type ID.</span>
<a name="l01584"></a>01584                                 p_str_asset_name = &amp;(it_asset-&gt;second);  <span class="comment">// The CurrencyTLA. Examples: USD, BTC, etc.</span>
<a name="l01585"></a>01585                             }
<a name="l01586"></a>01586                             <span class="keywordflow">else</span>
<a name="l01587"></a>01587                             {
<a name="l01588"></a>01588                                 <span class="comment">// There was definitely an asset type on the instrument, and it definitely</span>
<a name="l01589"></a>01589                                 <span class="comment">// did not match any of the assets that we care about.</span>
<a name="l01590"></a>01590                                 <span class="comment">// Therefore, skip.</span>
<a name="l01591"></a>01591                                 <span class="comment">//</span>
<a name="l01592"></a>01592                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Skipping: Incoming payment (we don&#39;t care about asset %s)\n&quot;</span>,
<a name="l01593"></a>01593                                               __FUNCTION__, str_inpmt_asset.c_str());
<a name="l01594"></a>01594                                 <span class="keywordflow">continue</span>;
<a name="l01595"></a>01595                             }
<a name="l01596"></a>01596                         }
<a name="l01597"></a>01597                         <span class="comment">// --------------------------------------------------</span>
<a name="l01598"></a>01598                         <span class="keywordflow">if</span> (str_sender_acct_id.empty() &amp;&amp; pPayment-&gt;<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theSenderAcctID))
<a name="l01599"></a>01599                         {
<a name="l01600"></a>01600                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theSenderAcctID);
<a name="l01601"></a>01601                             str_sender_acct_id = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01602"></a>01602                         }
<a name="l01603"></a>01603                         <span class="comment">// --------------------------------------------------</span>
<a name="l01604"></a>01604                         <span class="comment">// By this point, p_str_asset_type and p_str_asset_name are definitely set.</span>
<a name="l01605"></a>01605                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_type); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01606"></a>01606                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_name); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01607"></a>01607                         <span class="comment">// ---------------------------------------------------</span>
<a name="l01608"></a>01608                         <span class="comment">// Instrument type (cheque, voucher, etc)</span>
<a name="l01609"></a>01609                         <span class="keywordtype">int</span> nType = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>());
<a name="l01610"></a>01610 
<a name="l01611"></a>01611                         str_type = <a class="code" href="_o_t_record_8hpp.html#aad2c87d02cf1bd05c6f519117deb93d9">OTRecord_GetTypeString</a>(nType);
<a name="l01612"></a>01612                         <span class="comment">// ---------------------------------------------------</span>
<a name="l01613"></a>01613                         int64_t lAmount = 0;
<a name="l01614"></a>01614 
<a name="l01615"></a>01615                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#acb3588ce12579879e64d65ed69afd5f6">GetAmount</a>(lAmount))
<a name="l01616"></a>01616                         {
<a name="l01617"></a>01617                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01618"></a>01618                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01619"></a>01619                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01620"></a>01620                         }
<a name="l01621"></a>01621                     }
<a name="l01622"></a>01622                 }
<a name="l01623"></a>01623                 <span class="comment">// ------------------------------</span>
<a name="l01624"></a>01624                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: pending incoming payment (str_type: %s)\n&quot;</span>,
<a name="l01625"></a>01625                                __FUNCTION__, str_type.c_str());
<a name="l01626"></a>01626 
<a name="l01627"></a>01627                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l01628"></a>01628                                                            *p_str_asset_type,
<a name="l01629"></a>01629                                                            *p_str_asset_name,
<a name="l01630"></a>01630                                                            str_nym_id,     <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l01631"></a>01631                                                            OTRecordList::s_blank, <span class="comment">// This is the Nym&#39;s account for this box. (Blank for payments inbox.)</span>
<a name="l01632"></a>01632                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l01633"></a>01633                                                            <span class="comment">// -----------------------------</span>
<a name="l01634"></a>01634                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l01635"></a>01635                                                            str_name, <span class="comment">// name of sender (since its in the inbox.)</span>
<a name="l01636"></a>01636                                                            str_date, <span class="comment">// the &quot;valid from&quot; date on the instrument.</span>
<a name="l01637"></a>01637                                                            str_amount,
<a name="l01638"></a>01638                                                            str_type, <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l01639"></a>01639                                                            <span class="keyword">true</span>,     <span class="comment">// I believe all incoming &quot;payment inbox&quot; items are pending. (Cheques waiting to be cashed, smart contracts waiting to be signed, etc.)</span>
<a name="l01640"></a>01640                                                            <span class="keyword">false</span>,    <span class="comment">// bIsOutgoing=false. (Since this is the payment INbox, nothing is outgoing...)</span>
<a name="l01641"></a>01641                                                            <span class="keyword">false</span>, <span class="comment">//bIsRecord</span>
<a name="l01642"></a>01642                                                            <span class="keyword">false</span>, <span class="comment">//bIsReceipt</span>
<a name="l01643"></a>01643                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da6df8bc1fa86af318441b6d9b44884379">OTRecord::Instrument</a>));
<a name="l01644"></a>01644                 <span class="comment">// -------------------------------------------------</span>
<a name="l01645"></a>01645                 <span class="keywordflow">if</span> (strContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01646"></a>01646                     sp_Record-&gt;SetContents(strContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01647"></a>01647                 <span class="comment">// -------------------------------------------------</span>
<a name="l01648"></a>01648                 sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l01649"></a>01649                 <span class="comment">// -------------------------------------------------</span>
<a name="l01650"></a>01650                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nIndex));
<a name="l01651"></a>01651                 <span class="comment">// -------------------------------------------------</span>
<a name="l01652"></a>01652                 <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l01653"></a>01653                     sp_Record-&gt;SetMemo(str_memo);
<a name="l01654"></a>01654                 <span class="comment">// -------------------------------------------------</span>
<a name="l01655"></a>01655                 <span class="keywordflow">if</span> (!str_sender_nym_id.empty())
<a name="l01656"></a>01656                     sp_Record-&gt;SetOtherNymID(str_sender_nym_id);
<a name="l01657"></a>01657                 <span class="comment">// -------------------------------------------------</span>
<a name="l01658"></a>01658                 <span class="keywordflow">if</span> (!str_sender_acct_id.empty())
<a name="l01659"></a>01659                     sp_Record-&gt;SetOtherAccountID(str_sender_acct_id);
<a name="l01660"></a>01660                 <span class="comment">// -------------------------------------------------</span>
<a name="l01661"></a>01661                 sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l01662"></a>01662                 sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l01663"></a>01663 
<a name="l01664"></a>01664                 m_contents.push_back(sp_Record);
<a name="l01665"></a>01665                 <span class="comment">// ------------------------------</span>
<a name="l01666"></a>01666 
<a name="l01667"></a>01667             } <span class="comment">// looping through inbox.</span>
<a name="l01668"></a>01668             <span class="keywordflow">else</span>
<a name="l01669"></a>01669                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed loading payments inbox. (Probably just doesn&#39;t exist yet.)\n&quot;</span>, __FUNCTION__);
<a name="l01670"></a>01670             <span class="comment">// ------------------------------------------------</span>
<a name="l01671"></a>01671             nIndex = (-1);
<a name="l01672"></a>01672 
<a name="l01673"></a>01673             <span class="comment">// Also loop through its record box. For this record box, pass the USER_ID twice,</span>
<a name="l01674"></a>01674             <span class="comment">// since it&#39;s the recordbox for the Nym.</span>
<a name="l01675"></a>01675             <span class="comment">// OPTIMIZE FYI: m_bRunFast impacts run speed here.</span>
<a name="l01676"></a>01676             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pRecordbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a8c288f48dcdc98a6ae02c03e6452c438">LoadRecordBoxNoVerify</a>(theServerID, theNymID, theNymID) : <span class="comment">// twice.</span>
<a name="l01677"></a>01677                                                  <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">LoadRecordBox</a>        (theServerID, theNymID, theNymID);
<a name="l01678"></a>01678             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRecordBoxAngel(pRecordbox);
<a name="l01679"></a>01679 
<a name="l01680"></a>01680             <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l01681"></a>01681             <span class="keywordflow">if</span> (NULL != pRecordbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pRecordbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l01682"></a>01682             {
<a name="l01683"></a>01683                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l01684"></a>01684                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l01685"></a>01685                 <span class="comment">// ------------------------------</span>
<a name="l01686"></a>01686                 <span class="keywordtype">bool</span> bOutgoing = <span class="keyword">false</span>;
<a name="l01687"></a>01687                 <span class="comment">// ----------------------------------</span>
<a name="l01688"></a>01688                 ++nIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01689"></a>01689                 <span class="comment">// ------------------------------------------------</span>
<a name="l01690"></a>01690                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Payment RECORD index: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01691"></a>01691                 <span class="comment">// ------------------------------------------------</span>
<a name="l01692"></a>01692                 std::string  str_name; <span class="comment">// name of sender OR recipient (depending on whether it was originally incoming or outgoing.)</span>
<a name="l01693"></a>01693                 std::string  str_other_nym_id;
<a name="l01694"></a>01694                 std::string  str_other_acct_id;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01697"></a>01697                 {
<a name="l01698"></a>01698                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderID,    theSenderAcctID;
<a name="l01699"></a>01699                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theRecipientID, theRecipientAcctID;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l01702"></a>01702                     {
<a name="l01703"></a>01703                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderID  (theSenderID);
<a name="l01704"></a>01704                         <span class="keyword">const</span> std::string str_sender_id(strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01705"></a>01705 
<a name="l01706"></a>01706                         <span class="comment">// Usually, Nym is the RECIPIENT. Sometimes he&#39;s the sender.</span>
<a name="l01707"></a>01707                         <span class="comment">// Either way, we want the OTHER ID (the other Nym) for display.</span>
<a name="l01708"></a>01708                         <span class="comment">// So here, if Nym&#39;s CLEARLY the sender, then we want the RECIPIENT.</span>
<a name="l01709"></a>01709                         <span class="comment">// Whereas if Nym were the recipient, then we&#39;d want the SENDER. (For display.)</span>
<a name="l01710"></a>01710                         <span class="comment">//</span>
<a name="l01711"></a>01711                         <span class="keywordflow">if</span> (0 == str_nym_id.compare(str_sender_id)) <span class="comment">// str_nym_id IS str_sender_id. (Therefore we want recipient.)</span>
<a name="l01712"></a>01712                         {
<a name="l01713"></a>01713                             bOutgoing = <span class="keyword">true</span>; <span class="comment">// if Nym is the sender, then it must have been outgoing.</span>
<a name="l01714"></a>01714 
<a name="l01715"></a>01715                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l01716"></a>01716                             {
<a name="l01717"></a>01717                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l01718"></a>01718                                 <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01719"></a>01719 
<a name="l01720"></a>01720                                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722                                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l01723"></a>01723                                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l01724"></a>01724                                 <span class="keywordflow">else</span>
<a name="l01725"></a>01725                                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l01726"></a>01726 
<a name="l01727"></a>01727                                 str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l01728"></a>01728                                 str_other_nym_id = str_recipient_id;
<a name="l01729"></a>01729                                 <span class="comment">// -------------------------------------------</span>
<a name="l01730"></a>01730                                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l01731"></a>01731                                 {
<a name="l01732"></a>01732                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l01733"></a>01733                                     str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01734"></a>01734                                 }
<a name="l01735"></a>01735                             }
<a name="l01736"></a>01736                         }
<a name="l01737"></a>01737                         <span class="keywordflow">else</span> <span class="comment">// str_nym_id IS NOT str_sender_id. (Therefore we want sender.)</span>
<a name="l01738"></a>01738                         {    <span class="comment">// In this case, some OTHER Nym is the sender, so it must have been incoming. (And bOutgoing is already false.)</span>
<a name="l01739"></a>01739 
<a name="l01740"></a>01740                             <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_sender_id, &amp;(*it_server))), strNameTemp;
<a name="l01741"></a>01741 
<a name="l01742"></a>01742                             <span class="keywordflow">if</span> (strName.Exists())
<a name="l01743"></a>01743                                 strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l01744"></a>01744                             <span class="keywordflow">else</span>
<a name="l01745"></a>01745                                 strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_id.c_str());
<a name="l01746"></a>01746 
<a name="l01747"></a>01747                             str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l01748"></a>01748                             str_other_nym_id = str_sender_id;
<a name="l01749"></a>01749                             <span class="comment">// -------------------------------------------</span>
<a name="l01750"></a>01750                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderAcctID))
<a name="l01751"></a>01751                             {
<a name="l01752"></a>01752                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderAcctID(theSenderAcctID);
<a name="l01753"></a>01753                                 str_other_acct_id = strSenderAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01754"></a>01754                             }
<a name="l01755"></a>01755                         }
<a name="l01756"></a>01756                     }
<a name="l01757"></a>01757                     <span class="comment">// In this block below, we already KNOW GetSenderUserIDForDisplay is EMPTY.</span>
<a name="l01758"></a>01758                     <span class="comment">// (So it&#39;s &quot;recipient or bust.&quot;)</span>
<a name="l01759"></a>01759                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l01760"></a>01760                     {
<a name="l01761"></a>01761                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l01762"></a>01762                         <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01763"></a>01763 
<a name="l01764"></a>01764                         <span class="keywordflow">if</span> (0 != str_nym_id.compare(str_recipient_id)) <span class="comment">// str_nym_id is NOT str_recipient_id. (Therefore we want str_recipient_id.)</span>
<a name="l01765"></a>01765                         {
<a name="l01766"></a>01766                             <span class="comment">// If Nym is not the recipient, then he must be the sender.</span>
<a name="l01767"></a>01767                             <span class="comment">// (Therefore it must be outgoing.)</span>
<a name="l01768"></a>01768                             bOutgoing = <span class="keyword">true</span>;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770                             <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772                             <span class="keywordflow">if</span> (strName.Exists())
<a name="l01773"></a>01773                                 strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l01774"></a>01774                             <span class="keywordflow">else</span>
<a name="l01775"></a>01775                                 strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l01776"></a>01776 
<a name="l01777"></a>01777                             str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l01778"></a>01778                             str_other_nym_id = str_recipient_id;
<a name="l01779"></a>01779                             <span class="comment">// -------------------------------------------</span>
<a name="l01780"></a>01780                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l01781"></a>01781                             {
<a name="l01782"></a>01782                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l01783"></a>01783                                 str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01784"></a>01784                             }
<a name="l01785"></a>01785                         }
<a name="l01786"></a>01786                     }
<a name="l01787"></a>01787                 } <span class="comment">// if not abbreviated.</span>
<a name="l01788"></a>01788                 <span class="comment">// ------------------------------</span>
<a name="l01789"></a>01789                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l01790"></a>01790                 <span class="comment">// ------------------------------</span>
<a name="l01791"></a>01791                 std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l01792"></a>01792                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l01793"></a>01793 
<a name="l01794"></a>01794                 <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l01795"></a>01795                 {
<a name="l01796"></a>01796                     tValidFrom = tDateSigned;
<a name="l01797"></a>01797                     <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l01798"></a>01798                     <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l01799"></a>01799                     strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l01800"></a>01800                     str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01801"></a>01801                 }
<a name="l01802"></a>01802                 <span class="comment">// ----------------------------------</span>
<a name="l01803"></a>01803                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l01804"></a>01804                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l01805"></a>01805                 <span class="keyword">const</span> std::string * p_str_account    = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ACCOUNT</span>
<a name="l01806"></a>01806                 <span class="comment">// ----------------------------------</span>
<a name="l01807"></a>01807                 std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l01808"></a>01808                 std::string str_type;    <span class="comment">// Instrument type.</span>
<a name="l01809"></a>01809                 std::string str_memo;    <span class="comment">// Instrument memo (if applicable.)</span>
<a name="l01810"></a>01810                 <a class="code" href="class_o_t_string.html">OTString</a>    strContents; <span class="comment">// Instrument contents.</span>
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l01813"></a>01813                 {
<a name="l01814"></a>01814                     str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l01815"></a>01815                     <span class="comment">// --------------------------------------------------</span>
<a name="l01816"></a>01816                     int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l01817"></a>01817 
<a name="l01818"></a>01818                     <span class="keywordflow">if</span> (0 != lAmount)
<a name="l01819"></a>01819                     {
<a name="l01820"></a>01820                         <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01821"></a>01821                         strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01822"></a>01822                         str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01823"></a>01823                     }
<a name="l01824"></a>01824                 }
<a name="l01825"></a>01825                 <span class="keywordflow">else</span> <span class="comment">// NOT abbreviated. (Full box receipt is already loaded.)</span>
<a name="l01826"></a>01826                 {
<a name="l01827"></a>01827                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = pRecordbox-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym,
<a name="l01828"></a>01828                                                                      nIndex);     <span class="comment">// ===&gt; Returns financial instrument by index.</span>
<a name="l01829"></a>01829                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l01830"></a>01830                     <span class="comment">// ------------------------------</span>
<a name="l01831"></a>01831                     <span class="keywordflow">if</span> (NULL == pPayment) <span class="comment">// then we treat it like it&#39;s abbreviated.</span>
<a name="l01832"></a>01832                     {
<a name="l01833"></a>01833                         str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l01834"></a>01834                         <span class="comment">// --------------------------------------------------</span>
<a name="l01835"></a>01835                         int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l01836"></a>01836 
<a name="l01837"></a>01837                         <span class="keywordflow">if</span> (0 != lAmount)
<a name="l01838"></a>01838                         {
<a name="l01839"></a>01839                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01840"></a>01840                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01841"></a>01841                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01842"></a>01842                         }
<a name="l01843"></a>01843                     }
<a name="l01844"></a>01844                     <span class="comment">// ---------------------------------------------------</span>
<a name="l01845"></a>01845                     <span class="comment">// We have pPayment, the instrument accompanying the receipt in the payments recordbox.</span>
<a name="l01846"></a>01846                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l01847"></a>01847                     {
<a name="l01848"></a>01848                         <span class="comment">// ----------------------------------</span>
<a name="l01849"></a>01849                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#af3c3ed5823d48d9cf86463987f67ddae">GetValidFrom</a>(tValidFrom);
<a name="l01850"></a>01850                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a11dbba988d5da835179885043b4c3979">GetValidTo</a>  (tValidTo);
<a name="l01851"></a>01851 
<a name="l01852"></a>01852                         <span class="keywordflow">if</span> (tValidFrom &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l01853"></a>01853                         {
<a name="l01854"></a>01854                             <span class="keyword">const</span> uint64_t lFrom = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tValidFrom);
<a name="l01855"></a>01855                             <a class="code" href="class_o_t_string.html">OTString</a> strFrom;
<a name="l01856"></a>01856                             strFrom.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lFrom);
<a name="l01857"></a>01857                             str_date = strFrom.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01858"></a>01858                         }
<a name="l01859"></a>01859                         <span class="comment">// ----------------------------------</span>
<a name="l01860"></a>01860                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strContents);
<a name="l01861"></a>01861                         <span class="comment">// ------------------------------------</span>
<a name="l01862"></a>01862                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                         <span class="keywordflow">if</span> (bOutgoing) <span class="comment">// Nym is sender.</span>
<a name="l01865"></a>01865                         {
<a name="l01866"></a>01866                             <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theAccountID)) <span class="comment">// Since Nym is ME, the Account must be MY acct.</span>
<a name="l01867"></a>01867                             {                                            <span class="comment">// (If this record was originally OUTgoing, then the SENDER&#39;s account is MY acct.)</span>
<a name="l01868"></a>01868                                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAccountID);
<a name="l01869"></a>01869                                 std::string str_outpmt_account = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// The accountID we found on the payment (only applies to outgoing payments.)</span>
<a name="l01870"></a>01870                                 <span class="comment">// -----------------------------</span>
<a name="l01871"></a>01871                                 list_of_strings::iterator it_acct = std::find(m_accounts.begin(), m_accounts.end(), str_outpmt_account);
<a name="l01872"></a>01872                                 <span class="comment">// -----------------------------</span>
<a name="l01873"></a>01873                                 <span class="keywordflow">if</span> (it_acct != m_accounts.end()) <span class="comment">// Found it on the list of accounts we care about.</span>
<a name="l01874"></a>01874                                 {
<a name="l01875"></a>01875                                     p_str_account = &amp;(*it_acct);
<a name="l01876"></a>01876                                 }
<a name="l01877"></a>01877                                 <span class="keywordflow">else</span>
<a name="l01878"></a>01878                                 {
<a name="l01879"></a>01879                                     <span class="comment">// There was definitely an account on the instrument, and it definitely</span>
<a name="l01880"></a>01880                                     <span class="comment">// did not match any of the accounts that we care about.</span>
<a name="l01881"></a>01881                                     <span class="comment">// Therefore, skip.</span>
<a name="l01882"></a>01882                                     <span class="comment">//</span>
<a name="l01883"></a>01883                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping &#39;sent payment&#39; record. (We don&#39;t care about account %s)\n&quot;</span>,
<a name="l01884"></a>01884                                                    __FUNCTION__, str_outpmt_account.c_str());
<a name="l01885"></a>01885                                     <span class="keywordflow">continue</span>;
<a name="l01886"></a>01886                                 }
<a name="l01887"></a>01887                                 <span class="comment">// -------------------------------------------</span>
<a name="l01888"></a>01888                             }
<a name="l01889"></a>01889                         }
<a name="l01890"></a>01890                         <span class="keywordflow">else</span> <span class="comment">// Nym is recipient.</span>
<a name="l01891"></a>01891                         {
<a name="l01892"></a>01892                             <span class="comment">// Why is this here? Because if Nym is recipient, let&#39;s say he received an instrumentNotice containing</span>
<a name="l01893"></a>01893                             <span class="comment">// a sendUserInstrument message containing an incoming cheque. Well... that incoming cheque (the payload</span>
<a name="l01894"></a>01894                             <span class="comment">// on sendUserInstrument message) is ENCRYPTED. Meaning the above calls to pBoxReceipt-&gt;GetSenderAcctID</span>
<a name="l01895"></a>01895                             <span class="comment">// on the instrumentNotice transaction will FAIL. One option is to pass pNym into GetSenderAcctID so it</span>
<a name="l01896"></a>01896                             <span class="comment">// can decrypt the payload and return the value. But since we already have the payload decrypted here</span>
<a name="l01897"></a>01897                             <span class="comment">// (we already have the cheque loaded up here) we can just grab the senderAcctID directly from the cheque.</span>
<a name="l01898"></a>01898                             <span class="comment">// That&#39;s why this is here -- because this is where we KNOW we have the account ID -- so we grab it.</span>
<a name="l01899"></a>01899                             <span class="comment">//</span>
<a name="l01900"></a>01900                             <span class="keywordflow">if</span> (str_other_acct_id.empty() &amp;&amp; (pPayment-&gt;<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theAccountID)))
<a name="l01901"></a>01901                             {
<a name="l01902"></a>01902                                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAccountID);
<a name="l01903"></a>01903                                 str_other_acct_id = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01904"></a>01904                             }
<a name="l01905"></a>01905                         }
<a name="l01906"></a>01906                         <span class="comment">// ------------------------------------------</span>
<a name="l01907"></a>01907                         <span class="comment">// By this point, p_str_account is definitely set.</span>
<a name="l01908"></a>01908                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_account); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the accounts we care about.</span>
<a name="l01909"></a>01909                         <span class="comment">// ---------------------------------------------------</span>
<a name="l01910"></a>01910                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetTypeID;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(theAssetTypeID))
<a name="l01913"></a>01913                         {
<a name="l01914"></a>01914                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAssetTypeID);
<a name="l01915"></a>01915                             <span class="keyword">const</span> std::string str_inpmt_asset(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// The asset type we found on the payment (if we found anything.)</span>
<a name="l01916"></a>01916                             <span class="comment">// -----------------------------</span>
<a name="l01917"></a>01917                             map_of_strings::iterator it_asset = m_assets.find(str_inpmt_asset);
<a name="l01918"></a>01918                             <span class="comment">// -----------------------------</span>
<a name="l01919"></a>01919                             <span class="keywordflow">if</span> (it_asset != m_assets.end()) <span class="comment">// Found it on the map of asset types we care about.</span>
<a name="l01920"></a>01920                             {
<a name="l01921"></a>01921                                 p_str_asset_type = &amp;(it_asset-&gt;first);   <span class="comment">// Set the asset type ID.</span>
<a name="l01922"></a>01922                                 p_str_asset_name = &amp;(it_asset-&gt;second);  <span class="comment">// The CurrencyTLA. Examples: USD, BTC, etc.</span>
<a name="l01923"></a>01923                             }
<a name="l01924"></a>01924                             <span class="keywordflow">else</span>
<a name="l01925"></a>01925                             {
<a name="l01926"></a>01926                                 <span class="comment">// There was definitely an asset type on the instrument, and it definitely</span>
<a name="l01927"></a>01927                                 <span class="comment">// did not match any of the assets that we care about.</span>
<a name="l01928"></a>01928                                 <span class="comment">// Therefore, skip.</span>
<a name="l01929"></a>01929                                 <span class="comment">//</span>
<a name="l01930"></a>01930                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Skipping: Payment record (we don&#39;t care about asset type %s)\n&quot;</span>,
<a name="l01931"></a>01931                                               __FUNCTION__, str_inpmt_asset.c_str());
<a name="l01932"></a>01932                                 <span class="keywordflow">continue</span>;
<a name="l01933"></a>01933                             }
<a name="l01934"></a>01934                         }
<a name="l01935"></a>01935                         <span class="comment">// By this point, p_str_asset_type and p_str_asset_name are definitely set.</span>
<a name="l01936"></a>01936                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_type); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01937"></a>01937                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_name); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l01938"></a>01938                         <span class="comment">// ----------------------------------</span>
<a name="l01939"></a>01939                         <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l01940"></a>01940                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a76ed76e62e9b57487f08a6f1296260ab">GetMemo</a>(strMemo))
<a name="l01941"></a>01941                         {
<a name="l01942"></a>01942                             str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01943"></a>01943                         }
<a name="l01944"></a>01944                         <span class="comment">// ----------------------------------</span>
<a name="l01945"></a>01945                         <span class="comment">// Instrument type (cheque, voucher, etc)</span>
<a name="l01946"></a>01946                         <span class="keywordtype">int</span> nType = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>());
<a name="l01947"></a>01947 
<a name="l01948"></a>01948                         str_type = <a class="code" href="_o_t_record_8hpp.html#aad2c87d02cf1bd05c6f519117deb93d9">OTRecord_GetTypeString</a>(nType);
<a name="l01949"></a>01949                         <span class="comment">// ---------------------------------------------------</span>
<a name="l01950"></a>01950                         int64_t lAmount = 0;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#acb3588ce12579879e64d65ed69afd5f6">GetAmount</a>(lAmount))
<a name="l01953"></a>01953                         {
<a name="l01954"></a>01954                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l01955"></a>01955                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l01956"></a>01956                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01957"></a>01957                         }
<a name="l01958"></a>01958                     }
<a name="l01959"></a>01959                 }
<a name="l01960"></a>01960                 <span class="comment">// ------------------------------</span>
<a name="l01961"></a>01961                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: Payment record %s (str_type: %s)\n&quot;</span>,
<a name="l01962"></a>01962                                __FUNCTION__, bOutgoing ? <span class="stringliteral">&quot;(sent)&quot;</span> : <span class="stringliteral">&quot;(received)&quot;</span>, str_type.c_str());
<a name="l01963"></a>01963 
<a name="l01964"></a>01964                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l01965"></a>01965                                                            *p_str_asset_type,
<a name="l01966"></a>01966                                                            *p_str_asset_name,
<a name="l01967"></a>01967                                                            str_nym_id,     <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l01968"></a>01968                                                            *p_str_account, <span class="comment">// This is the Nym&#39;s account for this box. (Blank for incoming, set for outgoing.)</span>
<a name="l01969"></a>01969                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l01970"></a>01970                                                            <span class="comment">// -----------------------------</span>
<a name="l01971"></a>01971                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l01972"></a>01972                                                            str_name,    <span class="comment">// name of sender or recipient (since its in the recordbox.)</span>
<a name="l01973"></a>01973                                                            str_date,    <span class="comment">// the &quot;date signed&quot; on the receipt.</span>
<a name="l01974"></a>01974                                                            str_amount,
<a name="l01975"></a>01975                                                            str_type,    <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l01976"></a>01976                                                            <span class="keyword">false</span>,       <span class="comment">// Everything in the recordbox is finished. (NOT pending.)</span>
<a name="l01977"></a>01977                                                            bOutgoing, <span class="comment">// Since it&#39;s the recordbox, it contains both incoming and outgoing receipts.</span>
<a name="l01978"></a>01978                                                            <span class="keyword">true</span>, <span class="comment">//IsRecord</span>
<a name="l01979"></a>01979                                                            <span class="keyword">false</span>,<span class="comment">//IsReceipt,</span>
<a name="l01980"></a>01980                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da6df8bc1fa86af318441b6d9b44884379">OTRecord::Instrument</a>));
<a name="l01981"></a>01981                 <span class="comment">// -------------------------------------------------</span>
<a name="l01982"></a>01982                 <span class="keywordflow">if</span> (strContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01983"></a>01983                     sp_Record-&gt;SetContents(strContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01984"></a>01984                 <span class="comment">// -------------------------------------------------</span>
<a name="l01985"></a>01985                 sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l01986"></a>01986                 <span class="comment">// -------------------------------------------------</span>
<a name="l01987"></a>01987                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nIndex));
<a name="l01988"></a>01988                 <span class="comment">// -------------------------------------------------</span>
<a name="l01989"></a>01989                 <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l01990"></a>01990                     sp_Record-&gt;SetMemo(str_memo);
<a name="l01991"></a>01991                 <span class="comment">// -------------------------------------------------</span>
<a name="l01992"></a>01992                 <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l01993"></a>01993                     sp_Record-&gt;SetOtherNymID(str_other_nym_id);
<a name="l01994"></a>01994                 <span class="comment">// -------------------------------------------------</span>
<a name="l01995"></a>01995                 <span class="keywordflow">if</span> (!str_other_acct_id.empty())
<a name="l01996"></a>01996                     sp_Record-&gt;SetOtherAccountID(str_other_acct_id);
<a name="l01997"></a>01997                 <span class="comment">// -------------------------------------------------</span>
<a name="l01998"></a>01998                 sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l01999"></a>01999                 sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02000"></a>02000 
<a name="l02001"></a>02001                 m_contents.push_back(sp_Record);
<a name="l02002"></a>02002                 <span class="comment">// ------------------------------</span>
<a name="l02003"></a>02003 
<a name="l02004"></a>02004             } <span class="comment">// Loop through Recordbox</span>
<a name="l02005"></a>02005             <span class="keywordflow">else</span>
<a name="l02006"></a>02006                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed loading payments record box. (Probably just doesn&#39;t exist yet.)\n&quot;</span>, __FUNCTION__);
<a name="l02007"></a>02007             <span class="comment">// ------------------------------------------------</span>
<a name="l02008"></a>02008 
<a name="l02009"></a>02009             <span class="comment">// ------------------------------------------------</span>
<a name="l02010"></a>02010             <span class="comment">// EXPIRED RECORDS:</span>
<a name="l02011"></a>02011             nIndex = (-1);
<a name="l02012"></a>02012 
<a name="l02013"></a>02013             <span class="comment">// Also loop through its expired record box.</span>
<a name="l02014"></a>02014             <span class="comment">// OPTIMIZE FYI: m_bRunFast impacts run speed here.</span>
<a name="l02015"></a>02015             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pExpiredbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a7b9a649113879b83befa1d7acc00b79d">LoadExpiredBoxNoVerify</a>(theServerID, theNymID) :
<a name="l02016"></a>02016                                                   <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#ae3d6ecd9fabfea445d35fd7307008856">LoadExpiredBox</a>        (theServerID, theNymID);
<a name="l02017"></a>02017             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theExpiredBoxAngel(pExpiredbox);
<a name="l02018"></a>02018 
<a name="l02019"></a>02019             <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l02020"></a>02020             <span class="keywordflow">if</span> (NULL != pExpiredbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pExpiredbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l02021"></a>02021             {
<a name="l02022"></a>02022                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l02023"></a>02023                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l02024"></a>02024                 <span class="comment">// ------------------------------</span>
<a name="l02025"></a>02025                 <span class="keywordtype">bool</span> bOutgoing = <span class="keyword">false</span>;
<a name="l02026"></a>02026                 <span class="comment">// ----------------------------------</span>
<a name="l02027"></a>02027                 ++nIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l02028"></a>02028                 <span class="comment">// ------------------------------------------------</span>
<a name="l02029"></a>02029                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Expired payment RECORD index: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l02030"></a>02030                 <span class="comment">// ------------------------------------------------</span>
<a name="l02031"></a>02031                 std::string  str_name; <span class="comment">// name of sender OR recipient (depending on whether it was originally incoming or outgoing.)</span>
<a name="l02032"></a>02032                 std::string  str_other_nym_id;
<a name="l02033"></a>02033                 std::string  str_other_acct_id;
<a name="l02034"></a>02034 
<a name="l02035"></a>02035                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l02036"></a>02036                 {
<a name="l02037"></a>02037                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderID,    theSenderAcctID;
<a name="l02038"></a>02038                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theRecipientID, theRecipientAcctID;
<a name="l02039"></a>02039 
<a name="l02040"></a>02040                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l02041"></a>02041                     {
<a name="l02042"></a>02042                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderID  (theSenderID);
<a name="l02043"></a>02043                         <span class="keyword">const</span> std::string str_sender_id(strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02044"></a>02044 
<a name="l02045"></a>02045                         <span class="comment">// Usually, Nym is the RECIPIENT. Sometimes he&#39;s the sender.</span>
<a name="l02046"></a>02046                         <span class="comment">// Either way, we want the OTHER ID (the other Nym) for display.</span>
<a name="l02047"></a>02047                         <span class="comment">// So here, if Nym&#39;s CLEARLY the sender, then we want the RECIPIENT.</span>
<a name="l02048"></a>02048                         <span class="comment">// Whereas if Nym were the recipient, then we&#39;d want the SENDER. (For display.)</span>
<a name="l02049"></a>02049                         <span class="comment">//</span>
<a name="l02050"></a>02050                         <span class="keywordflow">if</span> (0 == str_nym_id.compare(str_sender_id)) <span class="comment">// str_nym_id IS str_sender_id. (Therefore we want recipient.)</span>
<a name="l02051"></a>02051                         {
<a name="l02052"></a>02052                             bOutgoing = <span class="keyword">true</span>; <span class="comment">// if Nym is the sender, then it must have been outgoing.</span>
<a name="l02053"></a>02053 
<a name="l02054"></a>02054                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l02055"></a>02055                             {
<a name="l02056"></a>02056                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l02057"></a>02057                                 <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02058"></a>02058 
<a name="l02059"></a>02059                                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061                                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l02062"></a>02062                                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02063"></a>02063                                 <span class="keywordflow">else</span>
<a name="l02064"></a>02064                                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l02065"></a>02065 
<a name="l02066"></a>02066                                 str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02067"></a>02067                                 str_other_nym_id = str_recipient_id;
<a name="l02068"></a>02068                                 <span class="comment">// -------------------------------------------</span>
<a name="l02069"></a>02069                                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02070"></a>02070                                 {
<a name="l02071"></a>02071                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l02072"></a>02072                                     str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02073"></a>02073                                 }
<a name="l02074"></a>02074                             }
<a name="l02075"></a>02075                         }
<a name="l02076"></a>02076                         <span class="keywordflow">else</span> <span class="comment">// str_nym_id IS NOT str_sender_id. (Therefore we want sender.)</span>
<a name="l02077"></a>02077                         {    <span class="comment">// In this case, some OTHER Nym is the sender, so it must have been incoming. (And bOutgoing is already false.)</span>
<a name="l02078"></a>02078 
<a name="l02079"></a>02079                             <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_sender_id, &amp;(*it_server))), strNameTemp;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081                             <span class="keywordflow">if</span> (strName.Exists())
<a name="l02082"></a>02082                                 strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l02083"></a>02083                             <span class="keywordflow">else</span>
<a name="l02084"></a>02084                                 strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_id.c_str());
<a name="l02085"></a>02085 
<a name="l02086"></a>02086                             str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02087"></a>02087                             str_other_nym_id = str_sender_id;
<a name="l02088"></a>02088                             <span class="comment">// -------------------------------------------</span>
<a name="l02089"></a>02089                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderAcctID))
<a name="l02090"></a>02090                             {
<a name="l02091"></a>02091                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderAcctID(theSenderAcctID);
<a name="l02092"></a>02092                                 str_other_acct_id = strSenderAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02093"></a>02093                             }
<a name="l02094"></a>02094                         }
<a name="l02095"></a>02095                     }
<a name="l02096"></a>02096                     <span class="comment">// In this block below, we already KNOW GetSenderUserIDForDisplay is EMPTY.</span>
<a name="l02097"></a>02097                     <span class="comment">// (So it&#39;s &quot;recipient or bust.&quot;)</span>
<a name="l02098"></a>02098                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l02099"></a>02099                     {
<a name="l02100"></a>02100                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l02101"></a>02101                         <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02102"></a>02102 
<a name="l02103"></a>02103                         <span class="keywordflow">if</span> (0 != str_nym_id.compare(str_recipient_id)) <span class="comment">// str_nym_id is NOT str_recipient_id. (Therefore we want str_recipient_id.)</span>
<a name="l02104"></a>02104                         {
<a name="l02105"></a>02105                             <span class="comment">// If Nym is not the recipient, then he must be the sender.</span>
<a name="l02106"></a>02106                             <span class="comment">// (Therefore it must be outgoing.)</span>
<a name="l02107"></a>02107                             bOutgoing = <span class="keyword">true</span>;
<a name="l02108"></a>02108 
<a name="l02109"></a>02109                             <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l02110"></a>02110 
<a name="l02111"></a>02111                             <span class="keywordflow">if</span> (strName.Exists())
<a name="l02112"></a>02112                                 strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02113"></a>02113                             <span class="keywordflow">else</span>
<a name="l02114"></a>02114                                 strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l02115"></a>02115 
<a name="l02116"></a>02116                             str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02117"></a>02117                             str_other_nym_id = str_recipient_id;
<a name="l02118"></a>02118                             <span class="comment">// -------------------------------------------</span>
<a name="l02119"></a>02119                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02120"></a>02120                             {
<a name="l02121"></a>02121                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l02122"></a>02122                                 str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02123"></a>02123                             }
<a name="l02124"></a>02124                         }
<a name="l02125"></a>02125                     }
<a name="l02126"></a>02126                 } <span class="comment">// if not abbreviated.</span>
<a name="l02127"></a>02127                 <span class="comment">// ------------------------------</span>
<a name="l02128"></a>02128                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l02129"></a>02129                 <span class="comment">// ------------------------------</span>
<a name="l02130"></a>02130                 std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l02131"></a>02131                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                 <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l02134"></a>02134                 {
<a name="l02135"></a>02135                     tValidFrom = tDateSigned;
<a name="l02136"></a>02136                     <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l02137"></a>02137                     <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l02138"></a>02138                     strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l02139"></a>02139                     str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02140"></a>02140                 }
<a name="l02141"></a>02141                 <span class="comment">// ----------------------------------</span>
<a name="l02142"></a>02142                 <span class="keyword">const</span> std::string * p_str_asset_type = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ASSET TYPE</span>
<a name="l02143"></a>02143                 <span class="keyword">const</span> std::string * p_str_asset_name = &amp;OTRecordList::s_blank; <span class="comment">// asset type display name.</span>
<a name="l02144"></a>02144                 <span class="keyword">const</span> std::string * p_str_account    = &amp;OTRecordList::s_blank; <span class="comment">// &lt;========== ACCOUNT</span>
<a name="l02145"></a>02145                 <span class="comment">// ----------------------------------</span>
<a name="l02146"></a>02146                 std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l02147"></a>02147                 std::string str_type;    <span class="comment">// Instrument type.</span>
<a name="l02148"></a>02148                 std::string str_memo;    <span class="comment">// Instrument memo (if applicable.)</span>
<a name="l02149"></a>02149                 <a class="code" href="class_o_t_string.html">OTString</a>    strContents; <span class="comment">// Instrument contents.</span>
<a name="l02150"></a>02150 
<a name="l02151"></a>02151                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l02152"></a>02152                 {
<a name="l02153"></a>02153                     str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l02154"></a>02154                     <span class="comment">// --------------------------------------------------</span>
<a name="l02155"></a>02155                     int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l02156"></a>02156 
<a name="l02157"></a>02157                     <span class="keywordflow">if</span> (0 != lAmount)
<a name="l02158"></a>02158                     {
<a name="l02159"></a>02159                         <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l02160"></a>02160                         strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l02161"></a>02161                         str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02162"></a>02162                     }
<a name="l02163"></a>02163                 }
<a name="l02164"></a>02164                 <span class="keywordflow">else</span> <span class="comment">// NOT abbreviated. (Full box receipt is already loaded.)</span>
<a name="l02165"></a>02165                 {
<a name="l02166"></a>02166                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment = pExpiredbox-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym,
<a name="l02167"></a>02167                                                                       nIndex);     <span class="comment">// ===&gt; Returns financial instrument by index.</span>
<a name="l02168"></a>02168                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l02169"></a>02169                     <span class="comment">// ------------------------------</span>
<a name="l02170"></a>02170                     <span class="keywordflow">if</span> (NULL == pPayment) <span class="comment">// then we treat it like it&#39;s abbreviated.</span>
<a name="l02171"></a>02171                     {
<a name="l02172"></a>02172                         str_type = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>(); <span class="comment">// instrumentNotice, etc.</span>
<a name="l02173"></a>02173                         <span class="comment">// --------------------------------------------------</span>
<a name="l02174"></a>02174                         int64_t lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l02175"></a>02175 
<a name="l02176"></a>02176                         <span class="keywordflow">if</span> (0 != lAmount)
<a name="l02177"></a>02177                         {
<a name="l02178"></a>02178                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l02179"></a>02179                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l02180"></a>02180                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02181"></a>02181                         }
<a name="l02182"></a>02182                     }
<a name="l02183"></a>02183                     <span class="comment">// ---------------------------------------------------</span>
<a name="l02184"></a>02184                     <span class="comment">// We have pPayment, the instrument accompanying the receipt in the payments recordbox.</span>
<a name="l02185"></a>02185                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l02186"></a>02186                     {
<a name="l02187"></a>02187                         <span class="comment">// ----------------------------------</span>
<a name="l02188"></a>02188                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#af3c3ed5823d48d9cf86463987f67ddae">GetValidFrom</a>(tValidFrom);
<a name="l02189"></a>02189                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a11dbba988d5da835179885043b4c3979">GetValidTo</a>  (tValidTo);
<a name="l02190"></a>02190 
<a name="l02191"></a>02191                         <span class="keywordflow">if</span> (tValidFrom &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l02192"></a>02192                         {
<a name="l02193"></a>02193                             <span class="keyword">const</span> uint64_t lFrom = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tValidFrom);
<a name="l02194"></a>02194                             <a class="code" href="class_o_t_string.html">OTString</a> strFrom;
<a name="l02195"></a>02195                             strFrom.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lFrom);
<a name="l02196"></a>02196                             str_date = strFrom.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02197"></a>02197                         }
<a name="l02198"></a>02198                         <span class="comment">// ----------------------------------</span>
<a name="l02199"></a>02199                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strContents);
<a name="l02200"></a>02200                         <span class="comment">// ------------------------------------</span>
<a name="l02201"></a>02201                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l02202"></a>02202 
<a name="l02203"></a>02203                         <span class="keywordflow">if</span> (bOutgoing) <span class="comment">// Nym is sender.</span>
<a name="l02204"></a>02204                         {
<a name="l02205"></a>02205                             <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theAccountID)) <span class="comment">// Since Nym is ME, the Account must be MY acct.</span>
<a name="l02206"></a>02206                             {                                            <span class="comment">// (If this record was originally OUTgoing, then the SENDER&#39;s account is MY acct.)</span>
<a name="l02207"></a>02207                                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAccountID);
<a name="l02208"></a>02208                                 std::string str_outpmt_account = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// The accountID we found on the payment (only applies to outgoing payments.)</span>
<a name="l02209"></a>02209                                 <span class="comment">// -----------------------------</span>
<a name="l02210"></a>02210                                 list_of_strings::iterator it_acct = std::find(m_accounts.begin(), m_accounts.end(), str_outpmt_account);
<a name="l02211"></a>02211                                 <span class="comment">// -----------------------------</span>
<a name="l02212"></a>02212                                 <span class="keywordflow">if</span> (it_acct != m_accounts.end()) <span class="comment">// Found it on the list of accounts we care about.</span>
<a name="l02213"></a>02213                                 {
<a name="l02214"></a>02214                                     p_str_account = &amp;(*it_acct);
<a name="l02215"></a>02215                                 }
<a name="l02216"></a>02216                                 <span class="keywordflow">else</span>
<a name="l02217"></a>02217                                 {
<a name="l02218"></a>02218                                     <span class="comment">// There was definitely an account on the instrument, and it definitely</span>
<a name="l02219"></a>02219                                     <span class="comment">// did not match any of the accounts that we care about.</span>
<a name="l02220"></a>02220                                     <span class="comment">// Therefore, skip.</span>
<a name="l02221"></a>02221                                     <span class="comment">//</span>
<a name="l02222"></a>02222                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping &#39;sent payment&#39; expired record. (We don&#39;t care about account %s)\n&quot;</span>,
<a name="l02223"></a>02223                                                    __FUNCTION__, str_outpmt_account.c_str());
<a name="l02224"></a>02224                                     <span class="keywordflow">continue</span>;
<a name="l02225"></a>02225                                 }
<a name="l02226"></a>02226                                 <span class="comment">// -------------------------------------------</span>
<a name="l02227"></a>02227                             }
<a name="l02228"></a>02228                         }
<a name="l02229"></a>02229                         <span class="keywordflow">else</span> <span class="comment">// Nym is recipient.</span>
<a name="l02230"></a>02230                         {
<a name="l02231"></a>02231                             <span class="comment">// Why is this here? Because if Nym is recipient, let&#39;s say he received an instrumentNotice containing</span>
<a name="l02232"></a>02232                             <span class="comment">// a sendUserInstrument message containing an incoming cheque. Well... that incoming cheque (the payload</span>
<a name="l02233"></a>02233                             <span class="comment">// on sendUserInstrument message) is ENCRYPTED. Meaning the above calls to pBoxReceipt-&gt;GetSenderAcctID</span>
<a name="l02234"></a>02234                             <span class="comment">// on the instrumentNotice transaction will FAIL. One option is to pass pNym into GetSenderAcctID so it</span>
<a name="l02235"></a>02235                             <span class="comment">// can decrypt the payload and return the value. But since we already have the payload decrypted here</span>
<a name="l02236"></a>02236                             <span class="comment">// (we already have the cheque loaded up here) we can just grab the senderAcctID directly from the cheque.</span>
<a name="l02237"></a>02237                             <span class="comment">// That&#39;s why this is here -- because this is where we KNOW we have the account ID -- so we grab it.</span>
<a name="l02238"></a>02238                             <span class="comment">//</span>
<a name="l02239"></a>02239                             <span class="keywordflow">if</span> (str_other_acct_id.empty() &amp;&amp; (pPayment-&gt;<a class="code" href="class_o_t_payment.html#af197690691464b57f9d9224357444351">GetSenderAcctIDForDisplay</a>(theAccountID)))
<a name="l02240"></a>02240                             {
<a name="l02241"></a>02241                                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAccountID);
<a name="l02242"></a>02242                                 str_other_acct_id = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02243"></a>02243                             }
<a name="l02244"></a>02244                         }
<a name="l02245"></a>02245                         <span class="comment">// ------------------------------------------</span>
<a name="l02246"></a>02246                         <span class="comment">// By this point, p_str_account is definitely set.</span>
<a name="l02247"></a>02247                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_account); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the accounts we care about.</span>
<a name="l02248"></a>02248                         <span class="comment">// ---------------------------------------------------</span>
<a name="l02249"></a>02249                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAssetTypeID;
<a name="l02250"></a>02250 
<a name="l02251"></a>02251                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a37342f7cb3d3fa42afb8531f4989d552">GetAssetTypeID</a>(theAssetTypeID))
<a name="l02252"></a>02252                         {
<a name="l02253"></a>02253                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp(theAssetTypeID);
<a name="l02254"></a>02254                             <span class="keyword">const</span> std::string str_inpmt_asset(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// The asset type we found on the payment (if we found anything.)</span>
<a name="l02255"></a>02255                             <span class="comment">// -----------------------------</span>
<a name="l02256"></a>02256                             map_of_strings::iterator it_asset = m_assets.find(str_inpmt_asset);
<a name="l02257"></a>02257                             <span class="comment">// -----------------------------</span>
<a name="l02258"></a>02258                             <span class="keywordflow">if</span> (it_asset != m_assets.end()) <span class="comment">// Found it on the map of asset types we care about.</span>
<a name="l02259"></a>02259                             {
<a name="l02260"></a>02260                                 p_str_asset_type = &amp;(it_asset-&gt;first);   <span class="comment">// Set the asset type ID.</span>
<a name="l02261"></a>02261                                 p_str_asset_name = &amp;(it_asset-&gt;second);  <span class="comment">// The CurrencyTLA. Examples: USD, BTC, etc.</span>
<a name="l02262"></a>02262                             }
<a name="l02263"></a>02263                             <span class="keywordflow">else</span>
<a name="l02264"></a>02264                             {
<a name="l02265"></a>02265                                 <span class="comment">// There was definitely an asset type on the instrument, and it definitely</span>
<a name="l02266"></a>02266                                 <span class="comment">// did not match any of the assets that we care about.</span>
<a name="l02267"></a>02267                                 <span class="comment">// Therefore, skip.</span>
<a name="l02268"></a>02268                                 <span class="comment">//</span>
<a name="l02269"></a>02269                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Skipping: Expired payment record (we don&#39;t care about asset type %s)\n&quot;</span>,
<a name="l02270"></a>02270                                               __FUNCTION__, str_inpmt_asset.c_str());
<a name="l02271"></a>02271                                 <span class="keywordflow">continue</span>;
<a name="l02272"></a>02272                             }
<a name="l02273"></a>02273                         }
<a name="l02274"></a>02274                         <span class="comment">// By this point, p_str_asset_type and p_str_asset_name are definitely set.</span>
<a name="l02275"></a>02275                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_type); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l02276"></a>02276                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != p_str_asset_name); <span class="comment">// and it&#39;s either blank, or it&#39;s one of the asset types we care about.</span>
<a name="l02277"></a>02277                         <span class="comment">// ----------------------------------</span>
<a name="l02278"></a>02278                         <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l02279"></a>02279                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a76ed76e62e9b57487f08a6f1296260ab">GetMemo</a>(strMemo))
<a name="l02280"></a>02280                         {
<a name="l02281"></a>02281                             str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02282"></a>02282                         }
<a name="l02283"></a>02283                         <span class="comment">// ----------------------------------</span>
<a name="l02284"></a>02284                         <span class="comment">// Instrument type (cheque, voucher, etc)</span>
<a name="l02285"></a>02285                         <span class="keywordtype">int</span> nType = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>());
<a name="l02286"></a>02286 
<a name="l02287"></a>02287                         str_type = <a class="code" href="_o_t_record_8hpp.html#aad2c87d02cf1bd05c6f519117deb93d9">OTRecord_GetTypeString</a>(nType);
<a name="l02288"></a>02288                         <span class="comment">// ---------------------------------------------------</span>
<a name="l02289"></a>02289                         int64_t lAmount = 0;
<a name="l02290"></a>02290 
<a name="l02291"></a>02291                         <span class="keywordflow">if</span> (pPayment-&gt;<a class="code" href="class_o_t_payment.html#acb3588ce12579879e64d65ed69afd5f6">GetAmount</a>(lAmount))
<a name="l02292"></a>02292                         {
<a name="l02293"></a>02293                             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l02294"></a>02294                             strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l02295"></a>02295                             str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02296"></a>02296                         }
<a name="l02297"></a>02297                     }
<a name="l02298"></a>02298                 }
<a name="l02299"></a>02299                 <span class="comment">// ------------------------------</span>
<a name="l02300"></a>02300                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: Expired payment record %s (str_type: %s)\n&quot;</span>,
<a name="l02301"></a>02301                                __FUNCTION__, bOutgoing ? <span class="stringliteral">&quot;(sent)&quot;</span> : <span class="stringliteral">&quot;(received)&quot;</span>, str_type.c_str());
<a name="l02302"></a>02302 
<a name="l02303"></a>02303                 <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*it_server,
<a name="l02304"></a>02304                                                            *p_str_asset_type,
<a name="l02305"></a>02305                                                            *p_str_asset_name,
<a name="l02306"></a>02306                                                            str_nym_id,     <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l02307"></a>02307                                                            *p_str_account, <span class="comment">// This is the Nym&#39;s account for this box. (Blank for incoming, set for outgoing.)</span>
<a name="l02308"></a>02308                                                            <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l02309"></a>02309                                                            <span class="comment">// -----------------------------</span>
<a name="l02310"></a>02310                                                            <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l02311"></a>02311                                                            str_name,    <span class="comment">// name of sender or recipient (since its in the recordbox.)</span>
<a name="l02312"></a>02312                                                            str_date,    <span class="comment">// the &quot;date signed&quot; on the receipt.</span>
<a name="l02313"></a>02313                                                            str_amount,
<a name="l02314"></a>02314                                                            str_type,    <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l02315"></a>02315                                                            <span class="keyword">false</span>,       <span class="comment">// Everything in the recordbox is finished. (NOT pending.)</span>
<a name="l02316"></a>02316                                                            bOutgoing, <span class="comment">// Since it&#39;s the recordbox, it contains both incoming and outgoing receipts.</span>
<a name="l02317"></a>02317                                                            <span class="keyword">true</span>, <span class="comment">//IsRecord</span>
<a name="l02318"></a>02318                                                            <span class="keyword">false</span>,<span class="comment">//IsReceipt,</span>
<a name="l02319"></a>02319                                                            <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da6df8bc1fa86af318441b6d9b44884379">OTRecord::Instrument</a>));
<a name="l02320"></a>02320                 <span class="comment">// -------------------------------------------------</span>
<a name="l02321"></a>02321                 <span class="keywordflow">if</span> (strContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02322"></a>02322                     sp_Record-&gt;SetContents(strContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02323"></a>02323                 <span class="comment">// -------------------------------------------------</span>
<a name="l02324"></a>02324                 sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l02325"></a>02325                 <span class="comment">// -------------------------------------------------</span>
<a name="l02326"></a>02326                 sp_Record-&gt;SetExpired();
<a name="l02327"></a>02327                 <span class="comment">// -------------------------------------------------</span>
<a name="l02328"></a>02328                 sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nIndex));
<a name="l02329"></a>02329                 <span class="comment">// -------------------------------------------------</span>
<a name="l02330"></a>02330                 <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l02331"></a>02331                     sp_Record-&gt;SetMemo(str_memo);
<a name="l02332"></a>02332                 <span class="comment">// -------------------------------------------------</span>
<a name="l02333"></a>02333                 <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l02334"></a>02334                     sp_Record-&gt;SetOtherNymID(str_other_nym_id);
<a name="l02335"></a>02335                 <span class="comment">// -------------------------------------------------</span>
<a name="l02336"></a>02336                 <span class="keywordflow">if</span> (!str_other_acct_id.empty())
<a name="l02337"></a>02337                     sp_Record-&gt;SetOtherAccountID(str_other_acct_id);
<a name="l02338"></a>02338                 <span class="comment">// -------------------------------------------------</span>
<a name="l02339"></a>02339                 sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l02340"></a>02340                 sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02341"></a>02341 
<a name="l02342"></a>02342                 m_contents.push_back(sp_Record);
<a name="l02343"></a>02343                 <span class="comment">// ------------------------------</span>
<a name="l02344"></a>02344 
<a name="l02345"></a>02345             } <span class="comment">// Loop through ExpiredBox</span>
<a name="l02346"></a>02346             <span class="keywordflow">else</span>
<a name="l02347"></a>02347                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Failed loading expired payments box. (Probably just doesn&#39;t exist yet.)\n&quot;</span>, __FUNCTION__);
<a name="l02348"></a>02348             <span class="comment">// ------------------------------------------------</span>
<a name="l02349"></a>02349 
<a name="l02350"></a>02350         } <span class="comment">// Loop through servers for each Nym.</span>
<a name="l02351"></a>02351 
<a name="l02352"></a>02352     } <span class="comment">// Loop through Nyms.</span>
<a name="l02353"></a>02353     <span class="comment">// ------------------------------------------------</span>
<a name="l02354"></a>02354     <span class="comment">// ASSET ACCOUNT -- INBOX/OUTBOX + RECORD BOX</span>
<a name="l02355"></a>02355     <span class="comment">// Loop through the Accounts.</span>
<a name="l02356"></a>02356     <span class="comment">//</span>
<a name="l02357"></a>02357     <span class="comment">// ------------------------------------------------</span>
<a name="l02358"></a>02358     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;================ %s: Looping through the accounts in the wallet...\n&quot;</span>, __FUNCTION__);
<a name="l02359"></a>02359     <span class="comment">// ------------------------------------------------</span>
<a name="l02360"></a>02360     <span class="keywordtype">int</span> nAccountIndex = -1;
<a name="l02361"></a>02361     <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_record_list_8hpp.html#a1172b459639314113a533a64309eb319">list_of_strings</a>, m_accounts, it_acct)
<a name="l02362"></a>02362     {
<a name="l02363"></a>02363         ++nAccountIndex; <span class="comment">// (0 on first iteration.)</span>
<a name="l02364"></a>02364         <span class="comment">// ------------------</span>
<a name="l02365"></a>02365         <span class="comment">// For each account, loop through its inbox, outbox, and record box.</span>
<a name="l02366"></a>02366         <span class="comment">//</span>
<a name="l02367"></a>02367         <span class="keyword">const</span> std::string  &amp; str_account_id(*it_acct);
<a name="l02368"></a>02368         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theAccountID  (str_account_id);
<a name="l02369"></a>02369         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);
<a name="l02370"></a>02370         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAccount);
<a name="l02371"></a>02371         <span class="comment">// ------------------------------------------------</span>
<a name="l02372"></a>02372         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theNymID    = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();
<a name="l02373"></a>02373         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>();
<a name="l02374"></a>02374         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetID  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l02375"></a>02375         <span class="comment">// ------------------------------------------------</span>
<a name="l02376"></a>02376         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strNymID   (theNymID);
<a name="l02377"></a>02377         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strServerID(theServerID);
<a name="l02378"></a>02378         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       strAssetID (theAssetID);
<a name="l02379"></a>02379         <span class="comment">// ------------------------------------------------</span>
<a name="l02380"></a>02380         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;------------\n%s: Account: %d, ID: %s\n&quot;</span>, __FUNCTION__,
<a name="l02381"></a>02381                        nAccountIndex, str_account_id.c_str());
<a name="l02382"></a>02382         <span class="comment">// ------------------------------------------------</span>
<a name="l02383"></a>02383         <span class="keyword">const</span> std::string    str_nym_id   (strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02384"></a>02384         <span class="keyword">const</span> std::string    str_server_id(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02385"></a>02385         <span class="keyword">const</span> std::string    str_asset_id (strAssetID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02386"></a>02386         <span class="comment">// ------------------------------------------------</span>
<a name="l02387"></a>02387         <span class="keyword">const</span> std::string  * pstr_nym_id     = &amp;OTRecordList::s_blank;
<a name="l02388"></a>02388         <span class="keyword">const</span> std::string  * pstr_server_id  = &amp;OTRecordList::s_blank;
<a name="l02389"></a>02389         <span class="keyword">const</span> std::string  * pstr_asset_id   = &amp;OTRecordList::s_blank;
<a name="l02390"></a>02390         <span class="keyword">const</span> std::string  * pstr_asset_name = &amp;OTRecordList::s_blank;
<a name="l02391"></a>02391         <span class="comment">// ------------------------------------------------</span>
<a name="l02392"></a>02392         <span class="comment">// NOTE: Since this account is already on my &quot;care about&quot; list for accounts,</span>
<a name="l02393"></a>02393         <span class="comment">// I wouldn&#39;t bother double-checking my &quot;care about&quot; lists for servers, nyms,</span>
<a name="l02394"></a>02394         <span class="comment">// and asset types. But I still look up the appropriate string for each, since</span>
<a name="l02395"></a>02395         <span class="comment">// I have to pass a reference to it into the constructor for OTRecord. (To a version</span>
<a name="l02396"></a>02396         <span class="comment">// that won&#39;t be deleted, since the OTRecord will reference it. And the &quot;care about&quot;</span>
<a name="l02397"></a>02397         <span class="comment">// list definitely contains a copy of the string that won&#39;t be deleted.)</span>
<a name="l02398"></a>02398         <span class="comment">//</span>
<a name="l02399"></a>02399         list_of_strings::iterator it_nym    = std::find(m_nyms.begin(),    m_nyms.end(),    str_nym_id);
<a name="l02400"></a>02400         list_of_strings::iterator it_server = std::find(m_servers.begin(), m_servers.end(), str_server_id);
<a name="l02401"></a>02401          map_of_strings::iterator it_asset  = m_assets.find(str_asset_id);
<a name="l02402"></a>02402         <span class="comment">// ------------------------------------------------</span>
<a name="l02403"></a>02403         <span class="keywordflow">if</span> ((m_nyms.end() == it_nym) || (m_servers.end() == it_server) || (m_assets.end() == it_asset))
<a name="l02404"></a>02404         {
<a name="l02405"></a>02405             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Skipping an account (%s) since its Nym, or Server, &quot;</span>
<a name="l02406"></a>02406                            <span class="stringliteral">&quot;or Asset Type wasn&#39;t on my list.\n&quot;</span>, __FUNCTION__,
<a name="l02407"></a>02407                            str_account_id.c_str());
<a name="l02408"></a>02408             <span class="keywordflow">continue</span>;
<a name="l02409"></a>02409         }
<a name="l02410"></a>02410         <span class="comment">// ------------------------------------------------</span>
<a name="l02411"></a>02411         <span class="comment">// These pointers are what we&#39;ll use to construct each OTRecord.</span>
<a name="l02412"></a>02412         <span class="comment">//</span>
<a name="l02413"></a>02413         pstr_nym_id     = &amp;(*it_nym);
<a name="l02414"></a>02414         pstr_server_id  = &amp;(*it_server);
<a name="l02415"></a>02415         pstr_asset_id   = &amp;(it_asset-&gt;first);
<a name="l02416"></a>02416         pstr_asset_name = &amp;(it_asset-&gt;second);
<a name="l02417"></a>02417         <span class="comment">// ------------------------------------------------</span>
<a name="l02418"></a>02418         <span class="comment">// Loop through asset account INBOX.</span>
<a name="l02419"></a>02419         <span class="comment">//</span>
<a name="l02420"></a>02420         <span class="comment">// OPTIMIZE FYI:</span>
<a name="l02421"></a>02421         <span class="comment">// NOTE: LoadInbox is much SLOWER than LoadInboxNoVerify, but it also lets you get</span>
<a name="l02422"></a>02422         <span class="comment">// the NAME off of the box receipt. So if you are willing to GIVE UP the NAME, in</span>
<a name="l02423"></a>02423         <span class="comment">// return for FASTER PERFORMANCE, then call SetFastMode() before Populating.</span>
<a name="l02424"></a>02424         <span class="comment">//</span>
<a name="l02425"></a>02425         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a11a9479b4875de4377232237d3521690">LoadInboxNoVerify</a>(theServerID, theNymID, theAccountID) :
<a name="l02426"></a>02426                                          <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a478f3f32e383e05a203807810bc94940">LoadInbox</a>        (theServerID, theNymID, theAccountID);
<a name="l02427"></a>02427         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l02428"></a>02428 
<a name="l02429"></a>02429         <span class="comment">// ------------------------------------------------</span>
<a name="l02430"></a>02430         <span class="keywordtype">int</span> nInboxIndex = -1;
<a name="l02431"></a>02431         <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l02432"></a>02432         <span class="keywordflow">if</span> (NULL != pInbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pInbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l02433"></a>02433         {
<a name="l02434"></a>02434             ++nInboxIndex; <span class="comment">// (0 on first iteration.)</span>
<a name="l02435"></a>02435             <span class="comment">// ------------------------------------------------</span>
<a name="l02436"></a>02436             <span class="keywordflow">if</span> (0 == nInboxIndex)
<a name="l02437"></a>02437                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Beginning loop through asset account INBOX...\n&quot;</span>, __FUNCTION__);
<a name="l02438"></a>02438             <span class="comment">// --------------------------------</span>
<a name="l02439"></a>02439             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l02440"></a>02440             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l02441"></a>02441             <span class="comment">// ------------------------------------------------</span>
<a name="l02442"></a>02442             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Inbox index: %d\n&quot;</span>, __FUNCTION__, nInboxIndex);
<a name="l02443"></a>02443             <span class="comment">// ------------------------------------------------</span>
<a name="l02444"></a>02444             <span class="keywordtype">bool</span> bCanceled = <span class="keyword">false</span>;
<a name="l02445"></a>02445             <span class="comment">// ------------------------------------------------</span>
<a name="l02446"></a>02446             std::string  str_name; <span class="comment">// name of sender (since its in the inbox.)</span>
<a name="l02447"></a>02447             std::string  str_other_nym_id;
<a name="l02448"></a>02448             std::string  str_other_acct_id;
<a name="l02449"></a>02449             std::string  str_memo;
<a name="l02450"></a>02450 
<a name="l02451"></a>02451             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l02452"></a>02452             {
<a name="l02453"></a>02453                 <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#abc54a3c74c5235cfe1debe4a2f97c2cd">GetMemo</a>(strMemo))
<a name="l02456"></a>02456                     str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02457"></a>02457                 <span class="comment">// ------------------------------------------------</span>
<a name="l02458"></a>02458                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l02459"></a>02459                 {
<a name="l02460"></a>02460                     <span class="comment">// NOTE: REMOVE THE BELOW CODE. (Found a better way, above this block.)</span>
<a name="l02461"></a>02461 <span class="comment">//                    const OTString strBoxTrans(*pBoxTrans);</span>
<a name="l02462"></a>02462 <span class="comment">//</span>
<a name="l02463"></a>02463 <span class="comment">//                    if (strBoxTrans.Exists())</span>
<a name="l02464"></a>02464 <span class="comment">//                        str_memo = OTAPI_Wrap::Pending_GetNote(*pstr_server_id, *pstr_nym_id, str_account_id, strBoxTrans.Get());</span>
<a name="l02465"></a>02465                     <span class="comment">// ------------------------------</span>
<a name="l02466"></a>02466                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderID, theSenderAcctID;
<a name="l02467"></a>02467 
<a name="l02468"></a>02468                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderAcctID)) <span class="comment">// ACCOUNT name.</span>
<a name="l02469"></a>02469                     {
<a name="l02470"></a>02470                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l02471"></a>02471                         {
<a name="l02472"></a>02472                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderID(theSenderID);
<a name="l02473"></a>02473                             str_other_nym_id = strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02474"></a>02474                         }
<a name="l02475"></a>02475                         <span class="comment">// ------------------------------------</span>
<a name="l02476"></a>02476                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderAcctID(theSenderAcctID);
<a name="l02477"></a>02477                         <span class="keyword">const</span> std::string str_sender_acct_id(strSenderAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02478"></a>02478 
<a name="l02479"></a>02479                         str_other_acct_id = str_sender_acct_id;
<a name="l02480"></a>02480 
<a name="l02481"></a>02481                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_other_acct_id,
<a name="l02482"></a>02482                                                                 str_other_nym_id.empty() ? NULL :
<a name="l02483"></a>02483                                                                     &amp;str_other_nym_id, <span class="comment">// nym ID if known</span>
<a name="l02484"></a>02484                                                                 pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02485"></a>02485                                                                 pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l02486"></a>02486                                  strNameTemp;
<a name="l02487"></a>02487 
<a name="l02488"></a>02488                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02489"></a>02489                         {
<a name="l02490"></a>02490                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l02491"></a>02491                             str_name = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02492"></a>02492                         }
<a name="l02493"></a>02493                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l02494"></a>02494                         {
<a name="l02495"></a>02495                             <a class="code" href="class_o_t_string.html">OTString</a> strNymName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_other_nym_id, &amp;(*it_server))), strNymNameTemp;
<a name="l02496"></a>02496 
<a name="l02497"></a>02497                             <span class="keywordflow">if</span> (strNymName.Exists())
<a name="l02498"></a>02498                             {
<a name="l02499"></a>02499                                 strNymNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strNymName.Get());
<a name="l02500"></a>02500                                 str_name = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02501"></a>02501                             }
<a name="l02502"></a>02502                         }
<a name="l02503"></a>02503                         <span class="comment">// ---------------------------------------</span>
<a name="l02504"></a>02504                         <span class="keywordflow">if</span> (str_name.empty())
<a name="l02505"></a>02505                         {
<a name="l02506"></a>02506                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_acct_id.c_str());
<a name="l02507"></a>02507                             str_name = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02508"></a>02508                         }
<a name="l02509"></a>02509                     }
<a name="l02510"></a>02510                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID)) <span class="comment">// NYM name.</span>
<a name="l02511"></a>02511                     {
<a name="l02512"></a>02512                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderID  (theSenderID);
<a name="l02513"></a>02513                         <span class="keyword">const</span> std::string str_sender_id(strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02514"></a>02514 
<a name="l02515"></a>02515                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_sender_id, &amp;(*it_server))), strNameTemp;
<a name="l02516"></a>02516 
<a name="l02517"></a>02517                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02518"></a>02518                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l02519"></a>02519                         <span class="keywordflow">else</span>
<a name="l02520"></a>02520                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_id.c_str());
<a name="l02521"></a>02521 
<a name="l02522"></a>02522                         str_name         = strNameTemp.Get();
<a name="l02523"></a>02523                         str_other_nym_id = str_sender_id;
<a name="l02524"></a>02524                     }
<a name="l02525"></a>02525                     <span class="keywordflow">else</span>
<a name="l02526"></a>02526                     {
<a name="l02527"></a>02527                         <a class="code" href="class_o_t_string.html">OTString</a> strName(<a class="code" href="class_o_t_a_p_i___wrap.html#a18999957d285b958c3f683d3460a0b3f">OTAPI_Wrap::GetAccountWallet_Name</a>(str_account_id)), strNameTemp;
<a name="l02528"></a>02528 
<a name="l02529"></a>02529                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02530"></a>02530                             strNameTemp = strName;
<a name="l02531"></a>02531                         <span class="keywordflow">else</span>
<a name="l02532"></a>02532                             strNameTemp = str_account_id;
<a name="l02533"></a>02533 
<a name="l02534"></a>02534                         str_name = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02535"></a>02535                     }
<a name="l02536"></a>02536                 } <span class="comment">// end: (if pending)</span>
<a name="l02537"></a>02537 
<a name="l02538"></a>02538                 <span class="keywordflow">else</span> <span class="comment">// else it&#39;s a receipt.</span>
<a name="l02539"></a>02539                 {
<a name="l02540"></a>02540                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theRecipientID, theRecipientAcctID;
<a name="l02541"></a>02541 
<a name="l02542"></a>02542                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l02543"></a>02543                     {
<a name="l02544"></a>02544                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientID       (theRecipientID);
<a name="l02545"></a>02545                         <span class="keyword">const</span> std::string str_recipient_user_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02546"></a>02546 
<a name="l02547"></a>02547                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_user_id, &amp;(*it_server))), strNameTemp;
<a name="l02548"></a>02548 
<a name="l02549"></a>02549                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02550"></a>02550                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02551"></a>02551                         <span class="keywordflow">else</span>
<a name="l02552"></a>02552                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_user_id.c_str());
<a name="l02553"></a>02553 
<a name="l02554"></a>02554                         str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02555"></a>02555                         str_other_nym_id = str_recipient_user_id;
<a name="l02556"></a>02556                         <span class="comment">// ------------------------------------</span>
<a name="l02557"></a>02557                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02558"></a>02558                         {
<a name="l02559"></a>02559                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l02560"></a>02560                             str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02561"></a>02561                         }
<a name="l02562"></a>02562                     }
<a name="l02563"></a>02563                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02564"></a>02564                     {
<a name="l02565"></a>02565                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientAcctID   (theRecipientAcctID);
<a name="l02566"></a>02566                         <span class="keyword">const</span> std::string str_recipient_acct_id(strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02567"></a>02567 
<a name="l02568"></a>02568                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_recipient_acct_id,
<a name="l02569"></a>02569                                                                 NULL, <span class="comment">// nym ID if known</span>
<a name="l02570"></a>02570                                                                 pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02571"></a>02571                                                                 pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l02572"></a>02572                                 strNameTemp;
<a name="l02573"></a>02573 
<a name="l02574"></a>02574                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02575"></a>02575                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02576"></a>02576                         <span class="keywordflow">else</span>
<a name="l02577"></a>02577                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_acct_id.c_str());
<a name="l02578"></a>02578 
<a name="l02579"></a>02579                         str_name          = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02580"></a>02580                         str_other_acct_id = str_recipient_acct_id;
<a name="l02581"></a>02581                     }
<a name="l02582"></a>02582                 } <span class="comment">//end: (else it&#39;s a receipt.)</span>
<a name="l02583"></a>02583             }
<a name="l02584"></a>02584             <span class="comment">// ------------------------------</span>
<a name="l02585"></a>02585             bCanceled = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aeabba0a2b6a52c8f50a329f7d14a1ba1">IsCancelled</a>();
<a name="l02586"></a>02586             <span class="comment">// ------------------------------</span>
<a name="l02587"></a>02587             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l02588"></a>02588             <span class="comment">// ------------------------------</span>
<a name="l02589"></a>02589             std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l02590"></a>02590             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l02591"></a>02591 
<a name="l02592"></a>02592             <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l02593"></a>02593             {
<a name="l02594"></a>02594                 tValidFrom = tDateSigned;
<a name="l02595"></a>02595                 <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l02596"></a>02596                 <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l02597"></a>02597                 strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l02598"></a>02598                 str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02599"></a>02599             }
<a name="l02600"></a>02600             <span class="comment">// ------------------------------</span>
<a name="l02601"></a>02601             std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l02602"></a>02602             int64_t        lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l02603"></a>02603 
<a name="l02604"></a>02604             <span class="keywordflow">if</span> (0 == lAmount)
<a name="l02605"></a>02605                 lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l02606"></a>02606             <span class="comment">// ------------------------------------------</span>
<a name="l02607"></a>02607             <span class="keywordflow">if</span> (0 != lAmount)
<a name="l02608"></a>02608             {
<a name="l02609"></a>02609                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l02610"></a>02610                 strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l02611"></a>02611                 str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02612"></a>02612             }
<a name="l02613"></a>02613             <span class="comment">// ------------------------------</span>
<a name="l02614"></a>02614             <span class="keyword">const</span> std::string str_type(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>()); <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l02615"></a>02615             <span class="comment">// ------------------------------</span>
<a name="l02616"></a>02616             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: incoming %s (str_type: %s)\n&quot;</span>,
<a name="l02617"></a>02617                            __FUNCTION__,
<a name="l02618"></a>02618                            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;pending transfer&quot;</span> : <span class="stringliteral">&quot;receipt&quot;</span>,
<a name="l02619"></a>02619                            str_type.c_str());
<a name="l02620"></a>02620 
<a name="l02621"></a>02621             <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*pstr_server_id,
<a name="l02622"></a>02622                                                        *pstr_asset_id,
<a name="l02623"></a>02623                                                        *pstr_asset_name,
<a name="l02624"></a>02624                                                        *pstr_nym_id,   <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l02625"></a>02625                                                        str_account_id, <span class="comment">// This is the Nym&#39;s account for this box.</span>
<a name="l02626"></a>02626                                                        <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l02627"></a>02627                                                        <span class="comment">// -----------------------------</span>
<a name="l02628"></a>02628                                                        <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l02629"></a>02629                                                        str_name, <span class="comment">// name of sender (since its in the inbox.)</span>
<a name="l02630"></a>02630                                                        str_date, <span class="comment">// the &quot;valid from&quot; date on the instrument.</span>
<a name="l02631"></a>02631                                                        str_amount,
<a name="l02632"></a>02632                                                        str_type, <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l02633"></a>02633                                                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()), <span class="comment">// Sometimes true, often false.</span>
<a name="l02634"></a>02634                                                        (lAmount &lt; 0) ? <span class="keyword">true</span> : <span class="keyword">false</span>, <span class="comment">//bIsOutgoing (this is the inbox, but a transferReceipt in the inbox represents outgoing funds. Whereas a &quot;pending&quot; in the inbox represents incoming funds. For now I&#39;m just going to go based on whether the amount is negative or not, to determine incoming / outgoing. We&#39;ll see how that works.)</span>
<a name="l02635"></a>02635                                                        <span class="keyword">false</span>, <span class="comment">//IsRecord</span>
<a name="l02636"></a>02636                                                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> != pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()), <span class="comment">//IsReceipt,</span>
<a name="l02637"></a>02637                                                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ?
<a name="l02638"></a>02638                                                             <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da3a6c19392e918ba4597ae131b007c94f">OTRecord::Transfer</a> : <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da106c4db2d8feb54b5d3afee0ead49fc2">OTRecord::Receipt</a> ));
<a name="l02639"></a>02639             <span class="comment">// -------------------------------------------------</span>
<a name="l02640"></a>02640             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strContents(*pBoxTrans);
<a name="l02641"></a>02641             sp_Record-&gt;SetContents(strContents.Get());
<a name="l02642"></a>02642             <span class="comment">// -------------------------------------------------</span>
<a name="l02643"></a>02643             sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l02644"></a>02644             <span class="comment">// -------------------------------------------------</span>
<a name="l02645"></a>02645             sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nInboxIndex));
<a name="l02646"></a>02646             <span class="comment">// -------------------------------------------------</span>
<a name="l02647"></a>02647             <span class="keywordflow">if</span> (bCanceled)
<a name="l02648"></a>02648                 sp_Record-&gt;SetCanceled();
<a name="l02649"></a>02649             <span class="comment">// -------------------------------------------------</span>
<a name="l02650"></a>02650             <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l02651"></a>02651                 sp_Record-&gt;SetMemo(str_memo);
<a name="l02652"></a>02652             <span class="comment">// -------------------------------------------------</span>
<a name="l02653"></a>02653             <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l02654"></a>02654                 sp_Record-&gt;SetOtherNymID(str_other_nym_id);
<a name="l02655"></a>02655             <span class="comment">// -------------------------------------------------</span>
<a name="l02656"></a>02656             <span class="keywordflow">if</span> (!str_other_acct_id.empty())
<a name="l02657"></a>02657                 sp_Record-&gt;SetOtherAccountID(str_other_acct_id);
<a name="l02658"></a>02658             <span class="comment">// -------------------------------------------------</span>
<a name="l02659"></a>02659             sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l02660"></a>02660             sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02661"></a>02661             <span class="comment">// -------------------------------------------------</span>
<a name="l02662"></a>02662             m_contents.push_back(sp_Record);
<a name="l02663"></a>02663         }
<a name="l02664"></a>02664         <span class="comment">// ------------------------------------------------</span>
<a name="l02665"></a>02665         <span class="comment">// OPTIMIZE FYI:</span>
<a name="l02666"></a>02666         <span class="comment">// NOTE: LoadOutbox is much SLOWER than LoadOutboxNoVerify, but it also lets you get</span>
<a name="l02667"></a>02667         <span class="comment">// the NAME off of the box receipt. So if you are willing to GIVE UP the NAME, in</span>
<a name="l02668"></a>02668         <span class="comment">// return for FASTER PERFORMANCE, then call SetFastMode() before running Populate.</span>
<a name="l02669"></a>02669         <span class="comment">//</span>
<a name="l02670"></a>02670         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af4b4a5ef255263fbda9958082d393875">LoadOutboxNoVerify</a>(theServerID, theNymID, theAccountID) :
<a name="l02671"></a>02671                                           <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#aeaf758c15cb39763d3ac80e7582e5409">LoadOutbox</a>        (theServerID, theNymID, theAccountID);
<a name="l02672"></a>02672         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l02673"></a>02673 
<a name="l02674"></a>02674         <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l02675"></a>02675         <span class="keywordtype">int</span> nOutboxIndex = -1;
<a name="l02676"></a>02676         <span class="keywordflow">if</span> (NULL != pOutbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l02677"></a>02677         {
<a name="l02678"></a>02678             ++nOutboxIndex; <span class="comment">// (0 on first iteration.)</span>
<a name="l02679"></a>02679             <span class="comment">// ------------------------------------------------</span>
<a name="l02680"></a>02680             <span class="keywordflow">if</span> (0 == nOutboxIndex)
<a name="l02681"></a>02681                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Beginning loop through asset account OUTBOX...\n&quot;</span>, __FUNCTION__);
<a name="l02682"></a>02682             <span class="comment">// --------------------------------</span>
<a name="l02683"></a>02683             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l02684"></a>02684             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l02685"></a>02685             <span class="comment">// ------------------------------------------------</span>
<a name="l02686"></a>02686             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Outbox index: %d\n&quot;</span>, __FUNCTION__, nOutboxIndex);
<a name="l02687"></a>02687             <span class="comment">// ------------------------------------------------</span>
<a name="l02688"></a>02688             std::string  str_name; <span class="comment">// name of recipient (since its in the outbox.)</span>
<a name="l02689"></a>02689             std::string  str_other_nym_id;
<a name="l02690"></a>02690             std::string  str_other_acct_id;
<a name="l02691"></a>02691             std::string  str_memo;
<a name="l02692"></a>02692 
<a name="l02693"></a>02693             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l02694"></a>02694             {
<a name="l02695"></a>02695                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theRecipientID, theRecipientAcctID;
<a name="l02696"></a>02696 
<a name="l02697"></a>02697                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l02698"></a>02698                 {
<a name="l02699"></a>02699                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientID  (theRecipientID);
<a name="l02700"></a>02700                     <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02701"></a>02701 
<a name="l02702"></a>02702                     <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l02703"></a>02703 
<a name="l02704"></a>02704                     <span class="keywordflow">if</span> (strName.Exists())
<a name="l02705"></a>02705                         strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02706"></a>02706                     <span class="keywordflow">else</span>
<a name="l02707"></a>02707                         strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l02708"></a>02708 
<a name="l02709"></a>02709                     str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02710"></a>02710                     str_other_nym_id = str_recipient_id;
<a name="l02711"></a>02711                     <span class="comment">// ------------------------------------</span>
<a name="l02712"></a>02712                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02713"></a>02713                     {
<a name="l02714"></a>02714                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l02715"></a>02715                         str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02716"></a>02716                     }
<a name="l02717"></a>02717                 }
<a name="l02718"></a>02718                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02719"></a>02719                 {
<a name="l02720"></a>02720                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientAcctID(theRecipientAcctID);
<a name="l02721"></a>02721                     <span class="keyword">const</span> std::string str_recipient_acct_id(strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02722"></a>02722 
<a name="l02723"></a>02723                     <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_recipient_acct_id,
<a name="l02724"></a>02724                                                             NULL, <span class="comment">// nym ID if known</span>
<a name="l02725"></a>02725                                                             pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02726"></a>02726                                                             pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l02727"></a>02727                             strNameTemp;
<a name="l02728"></a>02728 
<a name="l02729"></a>02729                     <span class="keywordflow">if</span> (strName.Exists())
<a name="l02730"></a>02730                         strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02731"></a>02731                     <span class="keywordflow">else</span>
<a name="l02732"></a>02732                         strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_acct_id.c_str());
<a name="l02733"></a>02733 
<a name="l02734"></a>02734                     str_name          = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l02735"></a>02735                     str_other_acct_id = str_recipient_acct_id;
<a name="l02736"></a>02736                 }
<a name="l02737"></a>02737                 <span class="comment">// --------------------------</span>
<a name="l02738"></a>02738                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l02739"></a>02739                 {
<a name="l02740"></a>02740                     <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l02741"></a>02741 
<a name="l02742"></a>02742                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#abc54a3c74c5235cfe1debe4a2f97c2cd">GetMemo</a>(strMemo))
<a name="l02743"></a>02743                         str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02744"></a>02744 
<a name="l02745"></a>02745                     <span class="comment">// DELETE THE BELOW CODE (replaced by above code.)</span>
<a name="l02746"></a>02746 <span class="comment">//                    const OTString strBoxTrans(*pBoxTrans);</span>
<a name="l02747"></a>02747 <span class="comment">//</span>
<a name="l02748"></a>02748 <span class="comment">//                    if (strBoxTrans.Exists())</span>
<a name="l02749"></a>02749 <span class="comment">//                        str_memo = OTAPI_Wrap::Pending_GetNote(*pstr_server_id, *pstr_nym_id, str_account_id, strBoxTrans.Get());</span>
<a name="l02750"></a>02750                 }
<a name="l02751"></a>02751             }
<a name="l02752"></a>02752             <span class="comment">// ------------------------------</span>
<a name="l02753"></a>02753             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l02754"></a>02754             <span class="comment">// ------------------------------</span>
<a name="l02755"></a>02755             std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l02756"></a>02756             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l02757"></a>02757 
<a name="l02758"></a>02758             <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l02759"></a>02759             {
<a name="l02760"></a>02760                 tValidFrom = tDateSigned;
<a name="l02761"></a>02761                 <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l02762"></a>02762                 <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l02763"></a>02763                 strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l02764"></a>02764                 str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02765"></a>02765             }
<a name="l02766"></a>02766             <span class="comment">// ------------------------------</span>
<a name="l02767"></a>02767             std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l02768"></a>02768             int64_t        lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l02769"></a>02769 
<a name="l02770"></a>02770             <span class="keywordflow">if</span> (0 == lAmount)
<a name="l02771"></a>02771                 lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l02772"></a>02772             <span class="comment">// -------------------------------------------</span>
<a name="l02773"></a>02773             <span class="keywordflow">if</span> (lAmount &gt; 0) <span class="comment">// Outgoing transfer should display with negative amount</span>
<a name="l02774"></a>02774                 lAmount *= (-1);
<a name="l02775"></a>02775             <span class="comment">// -------------------------------------------</span>
<a name="l02776"></a>02776             <span class="keywordflow">if</span> (0 != lAmount)
<a name="l02777"></a>02777             {
<a name="l02778"></a>02778                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l02779"></a>02779                 strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l02780"></a>02780                 str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02781"></a>02781             }
<a name="l02782"></a>02782             <span class="comment">// ------------------------------</span>
<a name="l02783"></a>02783             std::string str_type(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>()); <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l02784"></a>02784             <span class="keywordflow">if</span> (0 == str_type.compare(<span class="stringliteral">&quot;pending&quot;</span>))
<a name="l02785"></a>02785                 str_type = <span class="stringliteral">&quot;transfer&quot;</span>;
<a name="l02786"></a>02786             <span class="comment">// ------------------------------</span>
<a name="l02787"></a>02787             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: %s outgoing transfer (str_type: %s).\n&quot;</span>, __FUNCTION__,
<a name="l02788"></a>02788                            (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ? <span class="stringliteral">&quot;pending&quot;</span> : <span class="stringliteral">&quot;ERROR&quot;</span>, str_type.c_str());
<a name="l02789"></a>02789 
<a name="l02790"></a>02790             <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*pstr_server_id,
<a name="l02791"></a>02791                                                        *pstr_asset_id,
<a name="l02792"></a>02792                                                        *pstr_asset_name,
<a name="l02793"></a>02793                                                        *pstr_nym_id,   <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l02794"></a>02794                                                        str_account_id, <span class="comment">// This is the Nym&#39;s account for this box.</span>
<a name="l02795"></a>02795                                                        <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l02796"></a>02796                                                        <span class="comment">// -----------------------------</span>
<a name="l02797"></a>02797                                                        <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l02798"></a>02798                                                        str_name, <span class="comment">// name of recipient (since its in the outbox.)</span>
<a name="l02799"></a>02799                                                        str_date, <span class="comment">// the &quot;valid from&quot; date on the instrument.</span>
<a name="l02800"></a>02800                                                        str_amount,
<a name="l02801"></a>02801                                                        str_type, <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l02802"></a>02802                                                        (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()), <span class="comment">// Basically always true, in this case.</span>
<a name="l02803"></a>02803                                                        <span class="keyword">true</span>,  <span class="comment">//bIsOutgoing=true. (Since this is the outbox...)</span>
<a name="l02804"></a>02804                                                        <span class="keyword">false</span>, <span class="comment">//IsRecord</span>
<a name="l02805"></a>02805                                                        <span class="keyword">false</span>, <span class="comment">//IsReceipt</span>
<a name="l02806"></a>02806                                                        <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da3a6c19392e918ba4597ae131b007c94f">OTRecord::Transfer</a>
<a name="l02807"></a>02807                                                        ));
<a name="l02808"></a>02808             <span class="comment">// -------------------------------------------------</span>
<a name="l02809"></a>02809             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strContents(*pBoxTrans);
<a name="l02810"></a>02810             sp_Record-&gt;SetContents(strContents.Get());
<a name="l02811"></a>02811             <span class="comment">// -------------------------------------------------</span>
<a name="l02812"></a>02812             sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l02813"></a>02813             <span class="comment">// -------------------------------------------------</span>
<a name="l02814"></a>02814             sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nOutboxIndex));
<a name="l02815"></a>02815             <span class="comment">// -------------------------------------------------</span>
<a name="l02816"></a>02816             <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l02817"></a>02817                 sp_Record-&gt;SetMemo(str_memo);
<a name="l02818"></a>02818             <span class="comment">// -------------------------------------------------</span>
<a name="l02819"></a>02819             <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l02820"></a>02820                 sp_Record-&gt;SetOtherNymID(str_other_nym_id);
<a name="l02821"></a>02821             <span class="comment">// -------------------------------------------------</span>
<a name="l02822"></a>02822             <span class="keywordflow">if</span> (!str_other_acct_id.empty())
<a name="l02823"></a>02823                 sp_Record-&gt;SetOtherAccountID(str_other_acct_id);
<a name="l02824"></a>02824             <span class="comment">// -------------------------------------------------</span>
<a name="l02825"></a>02825             sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l02826"></a>02826             sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02827"></a>02827             <span class="comment">// -------------------------------------------------</span>
<a name="l02828"></a>02828             m_contents.push_back(sp_Record);
<a name="l02829"></a>02829         }
<a name="l02830"></a>02830         <span class="comment">// ------------------------------------------------</span>
<a name="l02831"></a>02831         <span class="comment">// For this record box, pass a NymID AND an AcctID,</span>
<a name="l02832"></a>02832         <span class="comment">// since it&#39;s the recordbox for a specific account.</span>
<a name="l02833"></a>02833         <span class="comment">//</span>
<a name="l02834"></a>02834         <span class="comment">// OPTIMIZE FYI:</span>
<a name="l02835"></a>02835         <span class="comment">// NOTE: LoadRecordBox is much SLOWER than LoadRecordBoxNoVerify, but it also lets you get</span>
<a name="l02836"></a>02836         <span class="comment">// the NAME off of the box receipt. So if you are willing to GIVE UP the NAME, in</span>
<a name="l02837"></a>02837         <span class="comment">// return for FASTER PERFORMANCE, then call SetFastMode() before Populating.</span>
<a name="l02838"></a>02838         <span class="comment">//</span>
<a name="l02839"></a>02839         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pRecordbox = m_bRunFast ? <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a8c288f48dcdc98a6ae02c03e6452c438">LoadRecordBoxNoVerify</a>(theServerID, theNymID, theAccountID) :
<a name="l02840"></a>02840                                              <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">LoadRecordBox</a>        (theServerID, theNymID, theAccountID);
<a name="l02841"></a>02841         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRecordBoxAngel(pRecordbox);
<a name="l02842"></a>02842 
<a name="l02843"></a>02843         <span class="comment">// It loaded up, so let&#39;s loop through it.</span>
<a name="l02844"></a>02844         <span class="keywordtype">int</span> nRecordIndex = -1;
<a name="l02845"></a>02845         <span class="keywordflow">if</span> (NULL != pRecordbox) <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, pRecordbox-&gt;<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l02846"></a>02846         {
<a name="l02847"></a>02847             ++nRecordIndex;
<a name="l02848"></a>02848             <span class="comment">// -----------------------------</span>
<a name="l02849"></a>02849             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxTrans = (*it).second;
<a name="l02850"></a>02850             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBoxTrans);
<a name="l02851"></a>02851             <span class="comment">// ------------------------------------------------</span>
<a name="l02852"></a>02852             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Account RECORD index: %d\n&quot;</span>, __FUNCTION__, nRecordIndex);
<a name="l02853"></a>02853             <span class="comment">// ------------------------------------------------</span>
<a name="l02854"></a>02854             <span class="keywordtype">bool</span> bOutgoing = <span class="keyword">false</span>;
<a name="l02855"></a>02855             <span class="keywordtype">bool</span> bCanceled = <span class="keyword">false</span>;
<a name="l02856"></a>02856             <span class="comment">// ------------------------------</span>
<a name="l02857"></a>02857             std::string  str_name; <span class="comment">// name of sender OR recipient (depending on whether it was originally incoming or outgoing.)</span>
<a name="l02858"></a>02858             std::string  str_other_nym_id;
<a name="l02859"></a>02859             std::string  str_other_acct_id;
<a name="l02860"></a>02860             std::string  str_memo;
<a name="l02861"></a>02861 
<a name="l02862"></a>02862             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>())
<a name="l02863"></a>02863             {
<a name="l02864"></a>02864                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderID,    theSenderAcctID;
<a name="l02865"></a>02865                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theRecipientID, theRecipientAcctID;
<a name="l02866"></a>02866 
<a name="l02867"></a>02867                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderAcctID))
<a name="l02868"></a>02868                 {
<a name="l02869"></a>02869                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderAcctID(theSenderAcctID);
<a name="l02870"></a>02870                     <span class="keyword">const</span> std::string str_sender_acct_id(strSenderAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02871"></a>02871 
<a name="l02872"></a>02872                     <span class="comment">// Usually, Nym is the RECIPIENT. Sometimes he&#39;s the sender.</span>
<a name="l02873"></a>02873                     <span class="comment">// Either way, we want the OTHER ID (the other Nym) for display.</span>
<a name="l02874"></a>02874                     <span class="comment">// So here, if Nym&#39;s CLEARLY the sender, then we want the RECIPIENT.</span>
<a name="l02875"></a>02875                     <span class="comment">// Whereas if Nym were the recipient, then we&#39;d want the SENDER. (For display.)</span>
<a name="l02876"></a>02876                     <span class="comment">//</span>
<a name="l02877"></a>02877                     <span class="keywordflow">if</span> (0 == str_account_id.compare(str_sender_acct_id)) <span class="comment">// str_account_id IS str_sender_acct_id. (Therefore we want recipient.)</span>
<a name="l02878"></a>02878                     {
<a name="l02879"></a>02879                         bOutgoing = <span class="keyword">true</span>; <span class="comment">// if Nym is the sender, then it must have been outgoing.</span>
<a name="l02880"></a>02880 
<a name="l02881"></a>02881                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotRecipientUserIDForDisplay =
<a name="l02882"></a>02882                                 pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID);
<a name="l02883"></a>02883 
<a name="l02884"></a>02884                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02885"></a>02885                         {
<a name="l02886"></a>02886                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientAcctID(theRecipientAcctID);
<a name="l02887"></a>02887                             <span class="keyword">const</span> std::string str_recip_acct_id(strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02888"></a>02888 
<a name="l02889"></a>02889                                   <a class="code" href="class_o_t_string.html">OTString</a>    strRecipientUserID(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02890"></a>02890                                   std::string str_recip_user_id(<span class="stringliteral">&quot;&quot;</span>);
<a name="l02891"></a>02891 
<a name="l02892"></a>02892                             <span class="keywordflow">if</span> (bGotRecipientUserIDForDisplay)
<a name="l02893"></a>02893                             {
<a name="l02894"></a>02894                                 theRecipientID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientUserID);
<a name="l02895"></a>02895                                 str_recip_user_id = strRecipientUserID.Get();
<a name="l02896"></a>02896                             }
<a name="l02897"></a>02897                             <span class="comment">// ---------------------------------------</span>
<a name="l02898"></a>02898                             <span class="comment">// NOTE: We check for cancelled here so we don&#39;t accidentally</span>
<a name="l02899"></a>02899                             <span class="comment">// cause the address book to falsely believe that str_recip_user_id</span>
<a name="l02900"></a>02900                             <span class="comment">// is the owner of str_recip_acct_id. (If the cheque/invoice is cancelled,</span>
<a name="l02901"></a>02901                             <span class="comment">// the recipient account will be the sender account, which is NOT owned</span>
<a name="l02902"></a>02902                             <span class="comment">// by the recipient, obviously...)</span>
<a name="l02903"></a>02903                             <span class="comment">//</span>
<a name="l02904"></a>02904                             <span class="keywordflow">if</span> (!pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aeabba0a2b6a52c8f50a329f7d14a1ba1">IsCancelled</a>())
<a name="l02905"></a>02905                             {
<a name="l02906"></a>02906                                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_recip_acct_id,
<a name="l02907"></a>02907                                                                         <span class="comment">// NOTE: we CANNOT pass str_recip_user_id here with str_recip_acct_id</span>
<a name="l02908"></a>02908                                                                         <span class="comment">// if it&#39;s a cancelled instrument, since in that case, the SENDER ACCT</span>
<a name="l02909"></a>02909                                                                         <span class="comment">// is ALSO the RECIPIENT ACCT. So this logic is ONLY correct since we</span>
<a name="l02910"></a>02910                                                                         <span class="comment">// are inside the block of if (!pBoxTrans-&gt;IsCancelled())</span>
<a name="l02911"></a>02911                                                                         <span class="comment">// (Otherwise we&#39;d be training the address book to falsely believe that</span>
<a name="l02912"></a>02912                                                                         <span class="comment">// the recipient Nym is the owner of the sender acct.)</span>
<a name="l02913"></a>02913                                                                         bGotRecipientUserIDForDisplay ?
<a name="l02914"></a>02914                                                                            &amp;str_recip_user_id : NULL, <span class="comment">// nym ID if known</span>
<a name="l02915"></a>02915                                                                         pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02916"></a>02916                                                                         pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l02917"></a>02917                                         strNameTemp;
<a name="l02918"></a>02918 
<a name="l02919"></a>02919                                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l02920"></a>02920                                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02921"></a>02921                                 <span class="keywordflow">else</span>
<a name="l02922"></a>02922                                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recip_acct_id.c_str());
<a name="l02923"></a>02923 
<a name="l02924"></a>02924                                 str_name = strNameTemp.Get(); <span class="comment">// We don&#39;t want to see our own name on cancelled cheques.</span>
<a name="l02925"></a>02925                             }
<a name="l02926"></a>02926                             str_other_acct_id = str_recip_acct_id;
<a name="l02927"></a>02927                         }
<a name="l02928"></a>02928                         <span class="comment">// -----------------------------------------</span>
<a name="l02929"></a>02929                         <span class="keywordflow">if</span> (bGotRecipientUserIDForDisplay)
<a name="l02930"></a>02930                         {
<a name="l02931"></a>02931                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l02932"></a>02932                             <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02933"></a>02933 
<a name="l02934"></a>02934                             str_other_nym_id = str_recipient_id;
<a name="l02935"></a>02935 
<a name="l02936"></a>02936                             <span class="keywordflow">if</span> (str_name.empty())
<a name="l02937"></a>02937                             {
<a name="l02938"></a>02938                                 <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l02939"></a>02939 
<a name="l02940"></a>02940                                 <span class="keywordflow">if</span> (strName.Exists())
<a name="l02941"></a>02941                                     strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l02942"></a>02942                                 <span class="keywordflow">else</span>
<a name="l02943"></a>02943                                     strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l02944"></a>02944 
<a name="l02945"></a>02945                                 str_name = strNameTemp.Get();
<a name="l02946"></a>02946                             }
<a name="l02947"></a>02947                         }
<a name="l02948"></a>02948                     }
<a name="l02949"></a>02949                     <span class="keywordflow">else</span> <span class="comment">// str_account_id IS NOT str_sender_acct_id. (Therefore we want sender.)</span>
<a name="l02950"></a>02950                     {    <span class="comment">// In this case, some OTHER Nym is the sender, so it must have been incoming. (And bOutgoing is already false.)</span>
<a name="l02951"></a>02951 
<a name="l02952"></a>02952                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l02953"></a>02953                         {
<a name="l02954"></a>02954                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderUserID(theSenderID);
<a name="l02955"></a>02955                             str_other_nym_id = strSenderUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02956"></a>02956                         }
<a name="l02957"></a>02957                         <span class="comment">// ------------------------------------</span>
<a name="l02958"></a>02958                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_sender_acct_id,
<a name="l02959"></a>02959                                                                 str_other_nym_id.empty() ? NULL :
<a name="l02960"></a>02960                                                                     &amp;str_other_nym_id, <span class="comment">// nym ID if known</span>
<a name="l02961"></a>02961                                                                 pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02962"></a>02962                                                                 pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l02963"></a>02963                                 strNameTemp;
<a name="l02964"></a>02964 
<a name="l02965"></a>02965                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l02966"></a>02966                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l02967"></a>02967                         <span class="keywordflow">else</span>
<a name="l02968"></a>02968                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_acct_id.c_str());
<a name="l02969"></a>02969 
<a name="l02970"></a>02970                         str_name          = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02971"></a>02971                         str_other_acct_id = str_sender_acct_id;
<a name="l02972"></a>02972                     }
<a name="l02973"></a>02973                 }
<a name="l02974"></a>02974                 <span class="comment">// In this block below, we already KNOW GetSenderAcctIDForDisplay is EMPTY.</span>
<a name="l02975"></a>02975                 <span class="comment">// (So it&#39;s &quot;recipient or bust.&quot;)</span>
<a name="l02976"></a>02976                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l02977"></a>02977                 {
<a name="l02978"></a>02978                     <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l02979"></a>02979                     {
<a name="l02980"></a>02980                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l02981"></a>02981                         <span class="keyword">const</span> std::string str_recipient_user_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02982"></a>02982 
<a name="l02983"></a>02983                         str_other_nym_id = str_recipient_user_id;
<a name="l02984"></a>02984                     }
<a name="l02985"></a>02985                     <span class="comment">// --------------------------------------------------------</span>
<a name="l02986"></a>02986                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l02987"></a>02987                     <span class="keyword">const</span> std::string str_recipient_acct_id(strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02988"></a>02988 
<a name="l02989"></a>02989                     <span class="keywordflow">if</span> (0 != str_account_id.compare(str_recipient_acct_id)) <span class="comment">// str_account_id is NOT str_recipient_acct_id. (Therefore we want str_recipient_acct_id.)</span>
<a name="l02990"></a>02990                     {
<a name="l02991"></a>02991                         <span class="comment">// If Nym is not the recipient, then he must be the sender.</span>
<a name="l02992"></a>02992                         <span class="comment">// (Therefore it must be outgoing.)</span>
<a name="l02993"></a>02993                         bOutgoing = <span class="keyword">true</span>;
<a name="l02994"></a>02994 
<a name="l02995"></a>02995                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#a0b746308196119aa968169387b6c9f7c">GetAcctName</a>(str_recipient_acct_id,
<a name="l02996"></a>02996                                                                 str_other_nym_id.empty() ? NULL :
<a name="l02997"></a>02997                                                                     &amp;str_other_nym_id, <span class="comment">// nym ID if known</span>
<a name="l02998"></a>02998                                                                 pstr_server_id, <span class="comment">// server ID if known.</span>
<a name="l02999"></a>02999                                                                 pstr_asset_id)), <span class="comment">// asset ID if known.</span>
<a name="l03000"></a>03000                                 strNameTemp;
<a name="l03001"></a>03001 
<a name="l03002"></a>03002                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l03003"></a>03003                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l03004"></a>03004                         <span class="keywordflow">else</span>
<a name="l03005"></a>03005                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_acct_id.c_str());
<a name="l03006"></a>03006 
<a name="l03007"></a>03007                         str_name          = strNameTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l03008"></a>03008                         str_other_acct_id = str_recipient_acct_id;
<a name="l03009"></a>03009                     }
<a name="l03010"></a>03010                 }
<a name="l03011"></a>03011                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a1091822e3072f014a8b2f64b93917ca7" title="For display purposes. The &quot;ref #&quot; you actually display (versus the one you use internally) might chan...">GetSenderUserIDForDisplay</a>(theSenderID))
<a name="l03012"></a>03012                 {
<a name="l03013"></a>03013                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strSenderID  (theSenderID);
<a name="l03014"></a>03014                     <span class="keyword">const</span> std::string str_sender_id(strSenderID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03015"></a>03015 
<a name="l03016"></a>03016                     <span class="comment">// Usually, Nym is the RECIPIENT. Sometimes he&#39;s the sender.</span>
<a name="l03017"></a>03017                     <span class="comment">// Either way, we want the OTHER ID (the other Nym) for display.</span>
<a name="l03018"></a>03018                     <span class="comment">// So here, if Nym&#39;s CLEARLY the sender, then we want the RECIPIENT.</span>
<a name="l03019"></a>03019                     <span class="comment">// Whereas if Nym were the recipient, then we&#39;d want the SENDER. (For display.)</span>
<a name="l03020"></a>03020                     <span class="comment">//</span>
<a name="l03021"></a>03021                     <span class="keywordflow">if</span> (0 == str_nym_id.compare(str_sender_id)) <span class="comment">// str_nym_id IS str_sender_id. (Therefore we want recipient.)</span>
<a name="l03022"></a>03022                     {
<a name="l03023"></a>03023                         bOutgoing = <span class="keyword">true</span>; <span class="comment">// if Nym is the sender, then it must have been outgoing.</span>
<a name="l03024"></a>03024 
<a name="l03025"></a>03025                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l03026"></a>03026                         {
<a name="l03027"></a>03027                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l03028"></a>03028                             <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                             <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l03031"></a>03031 
<a name="l03032"></a>03032                             <span class="keywordflow">if</span> (strName.Exists())
<a name="l03033"></a>03033                                 strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l03034"></a>03034                             <span class="keywordflow">else</span>
<a name="l03035"></a>03035                                 strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l03036"></a>03036 
<a name="l03037"></a>03037                             str_name         = strNameTemp.Get();
<a name="l03038"></a>03038                             str_other_nym_id = str_recipient_id;
<a name="l03039"></a>03039                             <span class="comment">// ------------------------------------</span>
<a name="l03040"></a>03040                             <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l03041"></a>03041                             {
<a name="l03042"></a>03042                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l03043"></a>03043                                 str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03044"></a>03044                             }
<a name="l03045"></a>03045                         }
<a name="l03046"></a>03046                     }
<a name="l03047"></a>03047                     <span class="keywordflow">else</span> <span class="comment">// str_nym_id IS NOT str_sender_id. (Therefore we want sender.)</span>
<a name="l03048"></a>03048                     {    <span class="comment">// In this case, some OTHER Nym is the sender, so it must have been incoming. (And bOutgoing is already false.)</span>
<a name="l03049"></a>03049 
<a name="l03050"></a>03050                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_sender_id, &amp;(*it_server))), strNameTemp;
<a name="l03051"></a>03051 
<a name="l03052"></a>03052                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l03053"></a>03053                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), strName.Get());
<a name="l03054"></a>03054                         <span class="keywordflow">else</span>
<a name="l03055"></a>03055                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#a7a6171c700273b7fd5b1af2499653e2a">OTRecordList::textFrom</a>(), str_sender_id.c_str());
<a name="l03056"></a>03056 
<a name="l03057"></a>03057                         str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l03058"></a>03058                         str_other_nym_id = str_sender_id;
<a name="l03059"></a>03059                         <span class="comment">// ------------------------------------</span>
<a name="l03060"></a>03060                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#acf66d9f8f5d3a6e4ee0a418a41db6019">GetSenderAcctIDForDisplay</a>(theSenderAcctID))
<a name="l03061"></a>03061                         {
<a name="l03062"></a>03062                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSenderAcctID(theSenderAcctID);
<a name="l03063"></a>03063                             str_other_acct_id = strSenderAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03064"></a>03064                         }
<a name="l03065"></a>03065                     }
<a name="l03066"></a>03066                 }
<a name="l03067"></a>03067                 <span class="comment">// In this block below, we already KNOW GetSenderUserIDForDisplay is EMPTY.</span>
<a name="l03068"></a>03068                 <span class="comment">// (So it&#39;s &quot;recipient or bust.&quot;)</span>
<a name="l03069"></a>03069                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a829e1dc63a933dae6fd3761091a9a2b1">GetRecipientUserIDForDisplay</a>(theRecipientID))
<a name="l03070"></a>03070                 {
<a name="l03071"></a>03071                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientID(theRecipientID);
<a name="l03072"></a>03072                     <span class="keyword">const</span> std::string str_recipient_id(strRecipientID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03073"></a>03073 
<a name="l03074"></a>03074                     <span class="keywordflow">if</span> (0 != str_nym_id.compare(str_recipient_id)) <span class="comment">// str_nym_id is NOT str_recipient_id. (Therefore we want str_recipient_id.)</span>
<a name="l03075"></a>03075                     {
<a name="l03076"></a>03076                         <span class="comment">// If Nym is not the recipient, then he must be the sender.</span>
<a name="l03077"></a>03077                         <span class="comment">// (Therefore it must be outgoing.)</span>
<a name="l03078"></a>03078                         bOutgoing = <span class="keyword">true</span>;
<a name="l03079"></a>03079 
<a name="l03080"></a>03080                         <a class="code" href="class_o_t_string.html">OTString</a> strName(m_pLookup-&gt;<a class="code" href="class_o_t_name_lookup.html#ab9de14dd7df628b73df85ea96efa6eee">GetNymName</a>(str_recipient_id, &amp;(*it_server))), strNameTemp;
<a name="l03081"></a>03081 
<a name="l03082"></a>03082                         <span class="keywordflow">if</span> (strName.Exists())
<a name="l03083"></a>03083                             strNameTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), strName.Get());
<a name="l03084"></a>03084                         <span class="keywordflow">else</span>
<a name="l03085"></a>03085                             strNameTemp.Format(<a class="code" href="class_o_t_record_list.html#aafd6d679105ba507a06690c39372b48f">OTRecordList::textTo</a>(), str_recipient_id.c_str());
<a name="l03086"></a>03086 
<a name="l03087"></a>03087                         str_name         = strNameTemp.Get(); <span class="comment">// Todo: lookup the name in address book also.</span>
<a name="l03088"></a>03088                         str_other_nym_id = str_recipient_id;
<a name="l03089"></a>03089                         <span class="comment">// ------------------------------------</span>
<a name="l03090"></a>03090                         <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a54221d2117096fd673147492a67f6755">GetRecipientAcctIDForDisplay</a>(theRecipientAcctID))
<a name="l03091"></a>03091                         {
<a name="l03092"></a>03092                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcctID(theRecipientAcctID);
<a name="l03093"></a>03093                             str_other_acct_id = strRecipientAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03094"></a>03094                         }
<a name="l03095"></a>03095                     }
<a name="l03096"></a>03096                 }
<a name="l03097"></a>03097                 <span class="comment">// ---------------------</span>
<a name="l03098"></a>03098                 <span class="comment">// Get the Memo field for a transferReceipt and also for other receipts.</span>
<a name="l03099"></a>03099                 <span class="comment">//</span>
<a name="l03100"></a>03100                 <a class="code" href="class_o_t_string.html">OTString</a> strMemo;
<a name="l03101"></a>03101 
<a name="l03102"></a>03102                 <span class="keywordflow">if</span> (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#abc54a3c74c5235cfe1debe4a2f97c2cd">GetMemo</a>(strMemo))
<a name="l03103"></a>03103                     str_memo = strMemo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03104"></a>03104 
<a name="l03105"></a>03105             } <span class="comment">// if not abbreviated.</span>
<a name="l03106"></a>03106             <span class="comment">// ------------------------------</span>
<a name="l03107"></a>03107             bCanceled = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#aeabba0a2b6a52c8f50a329f7d14a1ba1">IsCancelled</a>();
<a name="l03108"></a>03108             <span class="comment">// ------------------------------</span>
<a name="l03109"></a>03109             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidFrom = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>, tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l03110"></a>03110             <span class="comment">// ------------------------------</span>
<a name="l03111"></a>03111             std::string str_date    = <span class="stringliteral">&quot;0&quot;</span>; <span class="comment">// the &quot;date signed&quot; on the transaction receipt.</span>
<a name="l03112"></a>03112             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateSigned = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#afb069b9f7ab72f90e9e42aed0ba3b17c">GetDateSigned</a>();
<a name="l03113"></a>03113 
<a name="l03114"></a>03114             <span class="keywordflow">if</span> (tDateSigned &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l03115"></a>03115             {
<a name="l03116"></a>03116                 tValidFrom = tDateSigned;
<a name="l03117"></a>03117                 <span class="keyword">const</span> uint64_t lDateSigned = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateSigned);
<a name="l03118"></a>03118                 <a class="code" href="class_o_t_string.html">OTString</a> strDateSigned;
<a name="l03119"></a>03119                 strDateSigned.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>, lDateSigned);
<a name="l03120"></a>03120                 str_date = strDateSigned.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03121"></a>03121             }
<a name="l03122"></a>03122             <span class="comment">// ------------------------------</span>
<a name="l03123"></a>03123             std::string str_amount;  <span class="comment">// &lt;========== AMOUNT</span>
<a name="l03124"></a>03124             int64_t        lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a9ef2e2e40960239f6cbd0d1c1ded42f4">GetAbbrevDisplayAmount</a>();
<a name="l03125"></a>03125 
<a name="l03126"></a>03126             <span class="keywordflow">if</span> (0 == lAmount)
<a name="l03127"></a>03127                 lAmount = pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>();
<a name="l03128"></a>03128             <span class="comment">// ------------------------------------------</span>
<a name="l03129"></a>03129             <span class="keyword">const</span> std::string str_type(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>()); <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l03130"></a>03130             <span class="comment">// ------------------------------</span>
<a name="l03131"></a>03131             <span class="keywordflow">if</span> (0 == str_type.compare(<span class="stringliteral">&quot;transferReceipt&quot;</span>))
<a name="l03132"></a>03132                 bOutgoing = <span class="keyword">true</span>; <span class="comment">// only the sender of a transfer will have a transferReceipt.</span>
<a name="l03133"></a>03133             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == str_type.compare(<span class="stringliteral">&quot;pending&quot;</span>))
<a name="l03134"></a>03134                 bOutgoing = <span class="keyword">false</span>; <span class="comment">// only the recipient of a transfer will have a pending in his recordbox.</span>
<a name="l03135"></a>03135             <span class="comment">// ------------------------------</span>
<a name="l03136"></a>03136             <span class="keywordflow">if</span> (0 != lAmount)
<a name="l03137"></a>03137             {
<a name="l03138"></a>03138 
<a name="l03139"></a>03139 <span class="comment">//                if (lAmount &lt; 0)</span>
<a name="l03140"></a>03140 <span class="comment">//                    bOutgoing = true;</span>
<a name="l03141"></a>03141 <span class="comment">//                else</span>
<a name="l03142"></a>03142 <span class="comment">//                    bOutgoing = false;</span>
<a name="l03143"></a>03143 
<a name="l03144"></a>03144                 <span class="comment">// A transfer receipt ALWAYS represents an outgoing transfer.</span>
<a name="l03145"></a>03145                 <span class="comment">// If the amount is over 0, we want to display it as a negative</span>
<a name="l03146"></a>03146                 <span class="comment">// since it represents money LEAVING my account.</span>
<a name="l03147"></a>03147 <span class="comment">//                if ((0 == str_type.compare(&quot;transferReceipt&quot;)) &amp;&amp; (lAmount &gt; 0))</span>
<a name="l03148"></a>03148 <span class="comment">//                    lAmount *= (-1);</span>
<a name="l03149"></a>03149 
<a name="l03150"></a>03150                 <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l03151"></a>03151                 strTemp.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot;&quot;</span>, lAmount);
<a name="l03152"></a>03152                 str_amount = strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03153"></a>03153 
<a name="l03154"></a>03154             }
<a name="l03155"></a>03155             <span class="comment">// ------------------------------</span>
<a name="l03156"></a>03156             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ADDED: %s (asset account) record (str_type: %s)\n&quot;</span>,
<a name="l03157"></a>03157                            __FUNCTION__,
<a name="l03158"></a>03158                            <span class="comment">// This line means: If it&#39;s a receipt, use a blank string. Otherwise if</span>
<a name="l03159"></a>03159                            <span class="comment">// it&#39;s a transfer, then show sent/received. (This is the record box, so</span>
<a name="l03160"></a>03160                            <span class="comment">// if it&#39;s a transfer, it&#39;s a completed one.)</span>
<a name="l03161"></a>03161                            <span class="comment">//</span>
<a name="l03162"></a>03162                            <span class="comment">// FYI, for Receipts we don&#39;t say &quot;sent transferReceipt&quot;,</span>
<a name="l03163"></a>03163                            <span class="comment">// we just say &quot;transferReceipt.&quot;</span>
<a name="l03164"></a>03164                            <span class="comment">//</span>
<a name="l03165"></a>03165                            (pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>) ? <span class="stringliteral">&quot;&quot;</span> : (bOutgoing ? <span class="stringliteral">&quot;sent&quot;</span> : <span class="stringliteral">&quot;received&quot;</span>),
<a name="l03166"></a>03166                            str_type.c_str());
<a name="l03167"></a>03167 
<a name="l03168"></a>03168             <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_Record(<span class="keyword">new</span> <a class="code" href="class_o_t_record.html">OTRecord</a>(*pstr_server_id,
<a name="l03169"></a>03169                                                        *pstr_asset_id,
<a name="l03170"></a>03170                                                        *pstr_asset_name,
<a name="l03171"></a>03171                                                        *pstr_nym_id,   <span class="comment">// This is the Nym WHOSE BOX IT IS.</span>
<a name="l03172"></a>03172                                                        str_account_id, <span class="comment">// This is the Nym&#39;s account for this box.</span>
<a name="l03173"></a>03173                                                        <span class="comment">// Everything above this line, it stores a reference to an external string.</span>
<a name="l03174"></a>03174                                                        <span class="comment">// -----------------------------</span>
<a name="l03175"></a>03175                                                        <span class="comment">// Everything below this line, it makes its own internal copy of the string.</span>
<a name="l03176"></a>03176                                                        str_name, <span class="comment">// name of sender or recipient (whichever is NOT the current Nym.)</span>
<a name="l03177"></a>03177                                                        str_date, <span class="comment">// the &quot;valid from&quot; date on the instrument.</span>
<a name="l03178"></a>03178                                                        str_amount,
<a name="l03179"></a>03179                                                        str_type, <span class="comment">// pending, chequeReceipt, etc.</span>
<a name="l03180"></a>03180                                                        <span class="keyword">false</span>,    <span class="comment">// bPending=false. If it&#39;s in the record box, then it&#39;s finished (not pending.)</span>
<a name="l03181"></a>03181                                                        bOutgoing, <span class="comment">// Record box stores both old incoming, AND old outgoing, receipts.</span>
<a name="l03182"></a>03182                                                        <span class="keyword">true</span>, <span class="comment">//IsRecord</span>
<a name="l03183"></a>03183                                                        pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>, <span class="comment">//IsReceipt</span>
<a name="l03184"></a>03184                                                        pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() == <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> ?
<a name="l03185"></a>03185                                                             <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da3a6c19392e918ba4597ae131b007c94f">OTRecord::Transfer</a> : <a class="code" href="class_o_t_record.html#a126d840d32aceeb21498b76e61b75b2da106c4db2d8feb54b5d3afee0ead49fc2">OTRecord::Receipt</a>));
<a name="l03186"></a>03186             <span class="comment">// -------------------------------------------------</span>
<a name="l03187"></a>03187             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strContents(*pBoxTrans);
<a name="l03188"></a>03188             sp_Record-&gt;SetContents(strContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03189"></a>03189             <span class="comment">// -------------------------------------------------</span>
<a name="l03190"></a>03190             <span class="keywordflow">if</span> (bCanceled)
<a name="l03191"></a>03191                 sp_Record-&gt;SetCanceled();
<a name="l03192"></a>03192             <span class="comment">// -------------------------------------------------</span>
<a name="l03193"></a>03193             sp_Record-&gt;SetDateRange(tValidFrom, tValidTo);
<a name="l03194"></a>03194             <span class="comment">// -------------------------------------------------</span>
<a name="l03195"></a>03195             sp_Record-&gt;SetBoxIndex(static_cast&lt;int&gt;(nRecordIndex));
<a name="l03196"></a>03196             <span class="comment">// -------------------------------------------------</span>
<a name="l03197"></a>03197             <span class="keywordflow">if</span> (!str_memo.empty())
<a name="l03198"></a>03198                 sp_Record-&gt;SetMemo(str_memo);
<a name="l03199"></a>03199             <span class="comment">// -------------------------------------------------</span>
<a name="l03200"></a>03200             <span class="keywordflow">if</span> (!str_other_nym_id.empty())
<a name="l03201"></a>03201                 sp_Record-&gt;SetOtherNymID(str_other_nym_id);
<a name="l03202"></a>03202             <span class="comment">// -------------------------------------------------</span>
<a name="l03203"></a>03203             <span class="keywordflow">if</span> (!str_other_acct_id.empty())
<a name="l03204"></a>03204                 sp_Record-&gt;SetOtherAccountID(str_other_acct_id);
<a name="l03205"></a>03205             <span class="comment">// -------------------------------------------------</span>
<a name="l03206"></a>03206             sp_Record-&gt;SetTransNumForDisplay(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction.html#a7a4463450cc735aea9b924011f073bb3">GetReferenceNumForDisplay</a>());
<a name="l03207"></a>03207             sp_Record-&gt;SetTransactionNum(pBoxTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03208"></a>03208             <span class="comment">// -------------------------------------------------</span>
<a name="l03209"></a>03209             m_contents.push_back(sp_Record);
<a name="l03210"></a>03210         }
<a name="l03211"></a>03211         <span class="comment">// ------------------------------------------------</span>
<a name="l03212"></a>03212 
<a name="l03213"></a>03213     } <span class="comment">// loop through the accounts.</span>
<a name="l03214"></a>03214     <span class="comment">// ------------------------------------------------</span>
<a name="l03215"></a>03215     <span class="comment">// SORT the vector.</span>
<a name="l03216"></a>03216     <span class="comment">//</span>
<a name="l03217"></a>03217     <span class="comment">// TODO OPTIMIZE: We might load everything up into a multimap, and THEN copy it</span>
<a name="l03218"></a>03218     <span class="comment">// directly over to the vector. (Since the multimap sorts automatically on insert.)</span>
<a name="l03219"></a>03219     <span class="comment">// The question is, would doing that be any faster than just sorting it here?</span>
<a name="l03220"></a>03220     <span class="comment">// (Possibly not, but I&#39;m not sure. Re-visit later.)</span>
<a name="l03221"></a>03221     <span class="comment">//</span>
<a name="l03222"></a>03222     std::sort (m_contents.begin(), m_contents.end(), <a class="code" href="_o_t_record_list_8cpp.html#a62f92aa6cb982ab391b04541e685681b">compare_records</a>); <span class="comment">// Todo optimize: any faster sorting algorithms?</span>
<a name="l03223"></a>03223     <span class="comment">// ------------------------------------------------</span>
<a name="l03224"></a>03224     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03225"></a>03225 }
<a name="l03226"></a>03226 
<a name="l03227"></a>03227 
<a name="l03228"></a>03228 <span class="comment">// ------------------------------------------------</span>
<a name="l03229"></a>03229 
<a name="l03230"></a>03230 <span class="comment">// This one expects that s_pCaller is not NULL.</span>
<a name="l03231"></a>03231 <span class="comment">//</span>
<a name="l03232"></a><a class="code" href="class_o_t_record_list.html#a85777f253ce92f0e8b43f153dabbd6b9">03232</a> <a class="code" href="class_o_t_record_list.html#a85777f253ce92f0e8b43f153dabbd6b9">OTRecordList::OTRecordList</a>() :
<a name="l03233"></a>03233     m_pLookup(NULL),
<a name="l03234"></a>03234     m_bRunFast(false),
<a name="l03235"></a>03235     m_bAutoAcceptCheques  (false),
<a name="l03236"></a>03236     m_bAutoAcceptReceipts (false),
<a name="l03237"></a>03237     m_bAutoAcceptTransfers(false),
<a name="l03238"></a>03238     m_bAutoAcceptCash     (false)
<a name="l03239"></a>03239 {
<a name="l03240"></a>03240     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( (NULL != <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a>), <span class="stringliteral">&quot;Address Book Caller was NULL! &quot;</span>
<a name="l03241"></a>03241                   <span class="stringliteral">&quot;On app startup, did you forget to call OT_API_Set_AddrBookCallback ?\n&quot;</span>);
<a name="l03242"></a>03242     <span class="comment">// -----------------------------------</span>
<a name="l03243"></a>03243     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( (<a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a>-&gt;<a class="code" href="class_o_t_lookup_caller.html#a1505287e5d5e6753fec8bf9ed8c88e62">isCallbackSet</a>()), <span class="stringliteral">&quot;Address Book Callback was NULL! &quot;</span>
<a name="l03244"></a>03244                     <span class="stringliteral">&quot;On app startup, did you forget to call OT_API_Set_AddrBookCallback ?\n&quot;</span>);
<a name="l03245"></a>03245     <span class="comment">// -----------------------------------</span>
<a name="l03246"></a>03246     m_pLookup = <a class="code" href="class_o_t_record_list.html#a111c1ea4503cbe5f1b684dbd28682a2e">s_pCaller</a>-&gt;<a class="code" href="class_o_t_lookup_caller.html#aa2a95ce502574ce73b037a96e9cca8ec">getCallback</a>();  <span class="comment">// &lt;==========</span>
<a name="l03247"></a>03247 }
<a name="l03248"></a>03248 
<a name="l03249"></a>03249 
<a name="l03250"></a><a class="code" href="class_o_t_record_list.html#ac638369486d26820e65f81185a40e7f1">03250</a> <a class="code" href="class_o_t_record_list.html#a85777f253ce92f0e8b43f153dabbd6b9">OTRecordList::OTRecordList</a>(<a class="code" href="class_o_t_name_lookup.html">OTNameLookup</a> &amp; theLookup) :
<a name="l03251"></a>03251     m_pLookup(&amp;theLookup),
<a name="l03252"></a>03252     m_bRunFast(false),
<a name="l03253"></a>03253     m_bAutoAcceptCheques  (false),
<a name="l03254"></a>03254     m_bAutoAcceptReceipts (false),
<a name="l03255"></a>03255     m_bAutoAcceptTransfers(false),
<a name="l03256"></a>03256     m_bAutoAcceptCash     (false)
<a name="l03257"></a>03257 {
<a name="l03258"></a>03258 
<a name="l03259"></a>03259 }
<a name="l03260"></a>03260 
<a name="l03261"></a>03261 
<a name="l03262"></a><a class="code" href="class_o_t_record_list.html#a589a25237b808c6e4fed422bd8a3bcbb">03262</a> <a class="code" href="class_o_t_record_list.html#a589a25237b808c6e4fed422bd8a3bcbb">OTRecordList::~OTRecordList</a>()
<a name="l03263"></a>03263 {
<a name="l03264"></a>03264 <span class="comment">//  if (NULL != m_pLookup) // NO DELETE! We assume whatever client app is using OTRecordList, will</span>
<a name="l03265"></a>03265 <span class="comment">//      delete m_pLookup;  // delete its own address book lookup class when it is good and ready.</span>
<a name="l03266"></a>03266 
<a name="l03267"></a>03267     m_pLookup = NULL;
<a name="l03268"></a>03268 }
<a name="l03269"></a>03269 
<a name="l03270"></a>03270 <span class="comment">// Clears m_contents (NOT nyms, accounts, servers, or asset types.)</span>
<a name="l03271"></a>03271 
<a name="l03272"></a><a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">03272</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_record_list.html#ad31c399d15c81732ac6172e2902a2940">OTRecordList::ClearContents</a>()
<a name="l03273"></a>03273 {
<a name="l03274"></a>03274     m_contents.clear();
<a name="l03275"></a>03275 }
<a name="l03276"></a>03276 
<a name="l03277"></a>03277 <span class="comment">// ------------------------------------------------</span>
<a name="l03278"></a>03278 <span class="comment">// RETRIEVE:</span>
<a name="l03279"></a>03279 <span class="comment">//</span>
<a name="l03280"></a>03280 
<a name="l03281"></a>03281 
<a name="l03282"></a><a class="code" href="class_o_t_record_list.html#a858ab3250d47c849687389e9b1e7b5e2">03282</a> int32_t <a class="code" href="class_o_t_record_list.html#a858ab3250d47c849687389e9b1e7b5e2">OTRecordList::size</a>()
<a name="l03283"></a>03283 {
<a name="l03284"></a>03284     <span class="keywordflow">return</span> m_contents.size();
<a name="l03285"></a>03285 }
<a name="l03286"></a>03286 
<a name="l03287"></a>03287 
<a name="l03288"></a><a class="code" href="class_o_t_record_list.html#a06d0016ff3e3ee84db4425a1b2f5a41b">03288</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_record_list.html#a06d0016ff3e3ee84db4425a1b2f5a41b">OTRecordList::RemoveRecord</a>(int32_t nIndex)
<a name="l03289"></a>03289 {
<a name="l03290"></a>03290     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((nIndex &gt;= 0) &amp;&amp; (nIndex &lt; static_cast&lt;int32_t&gt;(m_contents.size())));
<a name="l03291"></a>03291     m_contents.erase(m_contents.begin()+nIndex);
<a name="l03292"></a>03292     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03293"></a>03293 }
<a name="l03294"></a>03294 
<a name="l03295"></a><a class="code" href="class_o_t_record_list.html#a784514f43bbd7b9c20406edfb75facf1">03295</a> <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> <a class="code" href="class_o_t_record_list.html#a784514f43bbd7b9c20406edfb75facf1">OTRecordList::GetRecord</a>(int32_t nIndex)
<a name="l03296"></a>03296 {
<a name="l03297"></a>03297     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((nIndex &gt;= 0) &amp;&amp; (nIndex &lt; static_cast&lt;int32_t&gt;(m_contents.size())));
<a name="l03298"></a>03298     <a class="code" href="_o_t_record_list_8hpp.html#ada94f0a02e9bc6fd7079b70c77b3c1dc">weak_ptr_OTRecord</a>   wp_record(m_contents[nIndex]);   
<a name="l03299"></a>03299     <a class="code" href="_o_t_record_list_8hpp.html#aa189a7af488f9684cc56c81eba2a9c14">shared_ptr_OTRecord</a> sp_record(wp_record);
<a name="l03300"></a>03300     
<a name="l03301"></a>03301     <span class="keywordflow">return</span> sp_record;
<a name="l03302"></a>03302 }
<a name="l03303"></a>03303 
<a name="l03304"></a>03304 <span class="comment">// ------------------------------------------------</span>
<a name="l03305"></a>03305 
<a name="l03306"></a>03306 
<a name="l03307"></a>03307 
<a name="l03308"></a>03308 
<a name="l03309"></a>03309 
<a name="l03310"></a>03310 
<a name="l03311"></a>03311 
<a name="l03312"></a>03312 
<a name="l03313"></a>03313 
<a name="l03314"></a>03314 
<a name="l03315"></a>03315 
<a name="l03316"></a>03316 
<a name="l03317"></a>03317 
<a name="l03318"></a>03318 
<a name="l03319"></a>03319 
<a name="l03320"></a>03320 
<a name="l03321"></a>03321 
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_record_list_8cpp.html">OTRecordList.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:02 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
