<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otapi/OTClient.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_client_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otapi/OTClient.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_client_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *    </span>
<a name="l00003"></a>00003 <span class="comment"> *  OTClient.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *  </span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"> </span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"> </span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"> </span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_client_8hpp.html">OTClient.hpp</a>&gt;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_basket_8hpp.html">OTBasket.hpp</a>&gt;</span>
<a name="l00138"></a>00138 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cheque_8hpp.html">OTCheque.hpp</a>&gt;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_envelope_8hpp.html">OTEnvelope.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_ledger_8hpp.html">OTLedger.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_message_8hpp.html">OTMessage.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_mint_8hpp.html">OTMint.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_offer_8hpp.html">OTOffer.hpp</a>&gt;</span>
<a name="l00145"></a>00145 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_8hpp.html">OTPayment.hpp</a>&gt;</span>
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_plan_8hpp.html">OTPaymentPlan.hpp</a>&gt;</span>
<a name="l00148"></a>00148 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_purse_8hpp.html">OTPurse.hpp</a>&gt;</span>
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_trade_8hpp.html">OTTrade.hpp</a>&gt;</span>
<a name="l00150"></a>00150 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_wallet_8hpp.html">OTWallet.hpp</a>&gt;</span>
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_account_8hpp.html">OTAccount.hpp</a>&gt;</span>  <span class="comment">//included in OTSmartContract.hpp</span>
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">00159</a> int32_t <a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">OTClient::CalcReturnVal</a>(<span class="keyword">const</span> int64_t &amp; lRequestNumber)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     <a class="code" href="class_o_t_client.html#a056ffd57844757386743f7aac5cf1a32">m_lMostRecentRequestNumber</a> = lRequestNumber;
<a name="l00162"></a>00162     <span class="comment">// --------------------------------------------</span>
<a name="l00163"></a>00163     <span class="keywordflow">if</span> ((-1) == lRequestNumber)
<a name="l00164"></a>00164         <span class="keywordflow">return</span> (-1);
<a name="l00165"></a>00165     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == lRequestNumber)
<a name="l00166"></a>00166         <span class="keywordflow">return</span> 0;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keyword">const</span> int32_t nRequestNum = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(lRequestNumber);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (lRequestNumber == nRequestNum) <span class="comment">// In this case, it works!</span>
<a name="l00171"></a>00171         <span class="keywordflow">return</span> nRequestNum;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="keywordflow">return</span> (-2); <span class="comment">// some other call can return this-&gt;m_lMostRecentRequestNumber if needed.</span>
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">00179</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">OTClient::ProcessMessageOut</a>(<span class="keywordtype">char</span> *buf, int32_t * pnExpectReply)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181 <span class="comment">//  OTLog::vError(&quot;OTClient::ProcessMessageOut: \n\n%s\n\n&quot;,</span>
<a name="l00182"></a>00182 <span class="comment">//               buf);</span>
<a name="l00183"></a>00183 <span class="comment">//</span>
<a name="l00184"></a>00184 <span class="comment">//  const OTString strMessage(buf);</span>
<a name="l00185"></a>00185 <span class="comment">//  OTMessage tempMsg;</span>
<a name="l00186"></a>00186 <span class="comment">//  tempMsg.LoadContractFromString(strMessage);</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(buf, pnExpectReply);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="comment">//  OTLog::Error(&quot;OTClient::ProcessMessageOut: FINISHED.\n&quot;);</span>
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="class_o_t_client.html#afdce1f6ff6989facd771283605f4a3c4">00196</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">OTClient::ProcessMessageOut</a>(<a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theMessage)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strMessage(theMessage);
<a name="l00199"></a>00199 <span class="comment">//  OTLog::vError(&quot;OTClient::ProcessMessageOut: \n\n%s\n\n&quot;,</span>
<a name="l00200"></a>00200 <span class="comment">//                strMessage.Get());</span>
<a name="l00201"></a>00201 <span class="comment">//</span>
<a name="l00202"></a>00202     <span class="comment">// ----------------------------------------</span>
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="comment">// WHAT DOES THIS MEAN?</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">// I means that later, if a message with a certain request number</span>
<a name="l00207"></a>00207     <span class="comment">// fails to reply, or show its face in the replies box, then I will</span>
<a name="l00208"></a>00208     <span class="comment">// have the option to look it up in the Outbuffer, based on that</span>
<a name="l00209"></a>00209     <span class="comment">// same request number, and send a re-try, or claw back any transaction</span>
<a name="l00210"></a>00210     <span class="comment">// numbers that might be on that message.</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// Should probably add an API call for specifically doing this, agnostic</span>
<a name="l00213"></a>00213     <span class="comment">// to whatever kind of transaction it actually is. Something like, </span>
<a name="l00214"></a>00214     <span class="comment">// OT_API_Message_HarvestClosingNumbers, and OT_API_Message_HarvestAllNumbers</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="comment">// So I can save the request number when sending a message, check for it later</span>
<a name="l00217"></a>00217     <span class="comment">// in the Nymbox, and then worst case, look it up in the Outbuffer and get my</span>
<a name="l00218"></a>00218     <span class="comment">// fucking transaction numbers back again!</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>; <span class="comment">// a copy.</span>
<a name="l00221"></a>00221     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMsg);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (pMsg-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strMessage))
<a name="l00224"></a>00224         m_MessageOutbuffer.<a class="code" href="class_o_t_message_outbuffer.html#ac51b8628eaa4367261e4ac86c2309404">AddSentMessage</a>(*pMsg);
<a name="l00225"></a>00225     <span class="keywordflow">else</span>
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227         <span class="comment">// todo, log here.</span>
<a name="l00228"></a>00228         <span class="keyword">delete</span> pMsg;
<a name="l00229"></a>00229         pMsg = NULL;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231     <span class="comment">// ----------------------------------------</span>
<a name="l00232"></a>00232     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>, <span class="stringliteral">&quot;OTClient::ProcessMessageOut: ASSERT: NULL != m_pConnection\n&quot;</span>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#ad352f309c26e38946374a7bc136ef3d2">ProcessMessageOut</a>(theMessage);  <span class="comment">// &lt;===========</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="comment">//  OTLog::Error(&quot;OTClient::ProcessMessageOut: FINISHED.\n&quot;);</span>
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="class_o_t_client.html#a198acbb6ccb266904ade30a94f9ed066">00242</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#a198acbb6ccb266904ade30a94f9ed066">OTClient::ProcessInBuffer</a>(<a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theServerReply)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>, <span class="stringliteral">&quot;OTClient::ProcessInBuffer: ASSERT: NULL != m_pConnection\n&quot;</span>);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#aec033a0cae7e314846b73dbcedca6709">ProcessInBuffer</a>(theServerReply);
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 
<a name="l00253"></a>00253 <span class="comment">//</span>
<a name="l00254"></a><a class="code" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">00254</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">OTClient::AcceptEntireNymbox</a>(<a class="code" href="class_o_t_ledger.html">OTLedger</a>              &amp; theNymbox, 
<a name="l00255"></a>00255                                   <span class="comment">//                                  OTServerConnection    &amp; theConnection, </span>
<a name="l00256"></a>00256                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; theServerID,
<a name="l00257"></a>00257                                   <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>      &amp; theServerContract, 
<a name="l00258"></a>00258                                   <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>           &amp; theNym,
<a name="l00259"></a>00259                                   <a class="code" href="class_o_t_message.html">OTMessage</a>             &amp; theMessage)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (theNymbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &lt; 1) 
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <span class="comment">// If there aren&#39;t any notices in the nymbox, no point wasting a # to process an empty box.</span>
<a name="l00264"></a>00264         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(4, <span class="stringliteral">&quot;%s: Nymbox is empty.\n&quot;</span>, __FUNCTION__);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268     <span class="comment">// ------------------------------------------------------</span>
<a name="l00269"></a>00269     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNymbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(theNym)) 
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         <span class="comment">// If there aren&#39;t any notices in the nymbox, no point wasting a # to process an empty box.</span>
<a name="l00272"></a>00272         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: VerifyAccount() failed.\n&quot;</span>, __FUNCTION__);
<a name="l00273"></a>00273         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     <span class="comment">// ------------------------------------------------------</span>
<a name="l00276"></a>00276     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym  = &amp;theNym;
<a name="l00277"></a>00277 <span class="comment">//  OTPseudonym * pNym  = theConnection.GetNym();</span>
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="comment">//  OTIdentifier theServerID;</span>
<a name="l00280"></a>00280 <span class="comment">//  theConnection.GetServerID(theServerID);</span>
<a name="l00281"></a>00281 <span class="comment">//</span>
<a name="l00282"></a>00282     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNymID(*pNym);
<a name="l00283"></a>00283     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID), strNymID(theNymID);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     int64_t lHighestNum=0;
<a name="l00286"></a>00286     <span class="comment">// get the last/current highest transaction number for the serverID.</span>
<a name="l00287"></a>00287     <span class="comment">// (making sure we&#39;re not being slipped any new ones with a lower value</span>
<a name="l00288"></a>00288     <span class="comment">// than this.)</span>
<a name="l00289"></a>00289     <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotHighestNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a519cdd66f0b7eccb54e77ced3b827cb8">GetHighestNum</a>(strServerID, lHighestNum); 
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="comment">// Contrasting Inbox and Nymbox.</span>
<a name="l00292"></a>00292     <span class="comment">//</span>
<a name="l00293"></a>00293     <span class="comment">// In &quot;AcceptEntireInbox&quot;, I have to have a transaction number in order to accept the inbox.</span>
<a name="l00294"></a>00294     <span class="comment">// But I ALSO need to RECEIVE my transaction number THROUGH an inbox, so the server can get </span>
<a name="l00295"></a>00295     <span class="comment">// my signature on that number (that&#39;s the only way to hold me responsible for it, AND to</span>
<a name="l00296"></a>00296     <span class="comment">// later prove I&#39;m NOT responsible for it when it&#39;s spent, without having to worry about</span>
<a name="l00297"></a>00297     <span class="comment">// saving account history forever, via so-called &quot;destruction of account history.&quot;)</span>
<a name="l00298"></a>00298     <span class="comment">//</span>
<a name="l00299"></a>00299     <span class="comment">// So how can I receive a number, if I don&#39;t have anymore?  My solution is to receive all</span>
<a name="l00300"></a>00300     <span class="comment">// transaction numbers through the NYMBOX, which is associated with Nym instead of asset account.</span>
<a name="l00301"></a>00301     <span class="comment">// That is: you RECEIVE numbers through the Nymbox, and you SPEND numbers through the Inbox.</span>
<a name="l00302"></a>00302     <span class="comment">//</span>
<a name="l00303"></a>00303     <span class="comment">// (You can also receive messages through your nymbox.)  This way, I can require a transaction</span>
<a name="l00304"></a>00304     <span class="comment">// number for an INBOX (since asset accounts can have changing balances) but I do NOT have</span>
<a name="l00305"></a>00305     <span class="comment">// to require one for processing the NYMBOX (since users HAVE NO balances.) I can still </span>
<a name="l00306"></a>00306     <span class="comment">// get the signed receipt during this time in order to satisfy destruction of acct history.</span>
<a name="l00307"></a>00307     <span class="comment">// Perfect!</span>
<a name="l00308"></a>00308     <span class="comment">//</span>
<a name="l00309"></a>00309     <span class="comment">// Due to all this, lStoredTransactionNumber will be 0 for now.  If I have to assign a number</span>
<a name="l00310"></a>00310     <span class="comment">// to it, then I will (probably the request number) but I will NOT be using a real</span>
<a name="l00311"></a>00311     <span class="comment">// transaction number here, since this is the NYMBOX.</span>
<a name="l00312"></a>00312     <span class="comment">//</span>
<a name="l00313"></a>00313     int64_t lStoredTransactionNumber=0;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">// the message to the server will contain a ledger to be processed for a specific acct. (in this case no acct, but user ID used twice instead.)</span>
<a name="l00316"></a>00316     <a class="code" href="class_o_t_ledger.html">OTLedger</a> processLedger(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID);  
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="comment">// bGenerateFile defaults to false on GenerateLedger call, so I left out the false.</span>
<a name="l00319"></a>00319     processLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>);    <span class="comment">// Can&#39;t just use one of these. It either has to be read out of a file or</span>
<a name="l00320"></a>00320     <span class="comment">// a string, or it has to be generated. So you construct it, then you either</span>
<a name="l00321"></a>00321     <span class="comment">// call GenerateLedger or LoadInbox, then you call VerifyContractID to make sure</span>
<a name="l00322"></a>00322     <span class="comment">// it loaded securely. (No need to verify if you just generated it.)</span>
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pAcceptTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), 
<a name="l00325"></a>00325         theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theServerID, 
<a name="l00326"></a>00326         <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTTransaction::processNymbox</a>, lStoredTransactionNumber);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="comment">// This insures that the ledger will handle cleaning up the transaction, so I don&#39;t have to delete it later.</span>
<a name="l00330"></a>00330     processLedger.AddTransaction(*pAcceptTransaction);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="comment">// loop through the transactions in theNymbox, and create corresponding &quot;accept&quot; items</span>
<a name="l00333"></a>00333     <span class="comment">// for each one of the transfer requests. Each of those items will go into a single</span>
<a name="l00334"></a>00334     <span class="comment">// &quot;process nymbox&quot; transaction that I will add to the processledger and thus to the </span>
<a name="l00335"></a>00335     <span class="comment">// outgoing message.</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">// theIssuedNym     == transaction numbers being added.</span>
<a name="l00338"></a>00338     <span class="comment">// theRemovedNym    == transaction numbers being removed. (finalReceipt notices about opening numbers for cron items.)</span>
<a name="l00339"></a>00339     <span class="comment">// theTentativeNym  == transaction numbers being tentatively added. (I keep a )</span>
<a name="l00340"></a>00340     <span class="comment">//</span>
<a name="l00341"></a>00341     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theIssuedNym, theRemovedNym;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     std::set&lt;int64_t&gt; setNoticeNumbers;  <span class="comment">// Trans#s I&#39;ve successfully signed for, and have a notice of this from the server.</span>
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">// For each transaction in the nymbox, if it&#39;s in reference to a transaction request,</span>
<a name="l00346"></a>00346     <span class="comment">// then create an &quot;accept&quot; item for that blank transaction, and add it to my own, new,</span>
<a name="l00347"></a>00347     <span class="comment">// &quot;process nymbox&quot; transaction that I&#39;m sending out.</span>
<a name="l00348"></a>00348     <span class="comment">//</span>
<a name="l00349"></a>00349     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theNymbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
<a name="l00352"></a>00352         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
<a name="l00353"></a>00353         <span class="comment">// ------------------------------------------------------------     </span>
<a name="l00354"></a>00354         <span class="comment">// This is now possible (abbreviated notices in the box), since we try to avoid </span>
<a name="l00355"></a>00355         <span class="comment">// downloading replyNotices if we can help it. So we only error if it&#39;s abbreviated</span>
<a name="l00356"></a>00356         <span class="comment">// but NOT a replyNotice.</span>
<a name="l00357"></a>00357         <span class="comment">//</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aacf7e02644aace6f245b9d493e721186">IsAbbreviated</a>() &amp;&amp; (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>() != <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a>))
<a name="l00359"></a>00359         {
<a name="l00360"></a>00360             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%sx: Error: Unexpected abbreviated receipt in Nymbox, even after supposedly &quot;</span>
<a name="l00361"></a>00361                 <span class="stringliteral">&quot;loading all box receipts. (And it&#39;s not a replyNotice, either!)\n&quot;</span>, __FUNCTION__);
<a name="l00362"></a>00362 <span class="comment">//          return false;</span>
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364         <span class="comment">// -----------------------------------------------------    </span>
<a name="l00365"></a>00365         <span class="comment">//      OTString strTransaction(*pTransaction);</span>
<a name="l00366"></a>00366         <span class="comment">//      OTLog::vError(&quot;TRANSACTION CONTENTS:\n%s\n&quot;, strTransaction.Get());</span>
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <a class="code" href="class_o_t_string.html">OTString</a> strRespTo;
<a name="l00369"></a>00369         pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strRespTo);
<a name="l00370"></a>00370         <span class="comment">//      OTLog::vError(&quot;TRANSACTION \&quot;IN REFERENCE TO\&quot; CONTENTS:\n%s\n&quot;, strRespTo.Get());  </span>
<a name="l00371"></a>00371         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00372"></a>00372         <span class="comment">// MESSAGE (From Another Nym)</span>
<a name="l00373"></a>00373         <span class="comment">//</span>
<a name="l00374"></a>00374         <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9505edb62ffb5da2972221c2663af52f">OTTransaction::message</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
<a name="l00375"></a>00375         {               
<a name="l00376"></a>00376             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378             <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>
<a name="l00379"></a>00379 
<a name="l00380"></a>00380             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00381"></a>00381             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383             pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
<a name="l00384"></a>00384             <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386             <span class="comment">// sign the item</span>
<a name="l00387"></a>00387             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00388"></a>00388             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00389"></a>00389 
<a name="l00390"></a>00390             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Received an encrypted message in your Nymbox:\n%s\n&quot;</span>, __FUNCTION__,
<a name="l00391"></a>00391                 strRespTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="comment">// Todo: really shouldn&#39;t do this until we get a successful REPLY from the server.</span>
<a name="l00394"></a>00394             <span class="comment">// That&#39;s when I do a lot of other things. But this is a no-biggie thing. It will almost</span>
<a name="l00395"></a>00395             <span class="comment">// always succeed and in the odd-event that it fails, I&#39;ll end up with a duplicate message</span>
<a name="l00396"></a>00396             <span class="comment">// in my mail. So what?</span>
<a name="l00397"></a>00397             <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401             <span class="comment">// The original message that was sent to me (with an encrypted envelope in the payload,</span>
<a name="l00402"></a>00402             <span class="comment">// and with the sender&#39;s ID and recipient IDs as m_strNymID and m_strNymID2) is stored</span>
<a name="l00403"></a>00403             <span class="comment">// within strRespTo. Let&#39;s load it up into an OTMessage instance, and add it to pNym&#39;s mail.</span>
<a name="l00404"></a>00404             <span class="comment">//</span>
<a name="l00405"></a>00405             <span class="keywordflow">if</span> (pMessage-&gt;LoadContractFromString(strRespTo))
<a name="l00406"></a>00406             {
<a name="l00407"></a>00407                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#abda249e911a4ddc8db3c97e58b3423fb">AddMail</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;mail&quot;.</span>
<a name="l00408"></a>00408                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l00409"></a>00409                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l00410"></a>00410             }
<a name="l00411"></a>00411             <span class="keywordflow">else</span> 
<a name="l00412"></a>00412             {
<a name="l00413"></a>00413                 <span class="keyword">delete</span> pMessage; <span class="comment">// Don&#39;t want to leak otherwise.</span>
<a name="l00414"></a>00414                 pMessage = NULL;
<a name="l00415"></a>00415             }
<a name="l00416"></a>00416         } <span class="comment">// if message</span>
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00419"></a>00419         <span class="comment">// INSTRUMENT (From Another Nym)</span>
<a name="l00420"></a>00420         <span class="comment">//</span>
<a name="l00421"></a>00421         <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
<a name="l00422"></a>00422         {               
<a name="l00423"></a>00423             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425             <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>
<a name="l00426"></a>00426 
<a name="l00427"></a>00427             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00428"></a>00428             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430             pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
<a name="l00431"></a>00431             <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00432"></a>00432 
<a name="l00433"></a>00433             <span class="comment">// sign the item</span>
<a name="l00434"></a>00434             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00435"></a>00435             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00436"></a>00436 
<a name="l00437"></a>00437             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Received an encrypted instrument in your Nymbox:\n%s\n&quot;</span>,
<a name="l00438"></a>00438                 __FUNCTION__, strRespTo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00439"></a>00439         } <span class="comment">// if instrument</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00442"></a>00442         <span class="comment">// SERVER NOTIFICATION </span>
<a name="l00443"></a>00443         <span class="comment">//</span>
<a name="l00444"></a>00444         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) )
<a name="l00445"></a>00445         {               
<a name="l00446"></a>00446             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448             <span class="comment">// The above already has OT_ASSERT so, no need to check the pointer for NULL.</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00451"></a>00451             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453             pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my nymbox.</span>
<a name="l00454"></a>00454             <span class="comment">// FYI, we don&#39;t need to set transaction num on item, since the constructor already got it off the owner transaction.</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456             <span class="comment">// sign the item</span>
<a name="l00457"></a>00457             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00458"></a>00458             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="comment">//          OTLog::vOutput(0, &quot;%s: Received a server notification in your Nymbox:\n%s\n&quot;,</span>
<a name="l00461"></a>00461 <span class="comment">//                         __FUNCTION__, strRespTo.Get());</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463             <span class="comment">// Todo: stash these somewhere, just like messages are in the pNym-&gt;AddMail() feature.</span>
<a name="l00464"></a>00464             <span class="comment">// NOTE: Most likely we still stash these in the paymentInbox just the same as instrumentNotice (above)</span>
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         } <span class="comment">// if notice</span>
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00469"></a>00469         <span class="comment">// It&#39;s a NEW Transaction Number that I ALREADY signed for, and this notice means it was a success.</span>
<a name="l00470"></a>00470         <span class="comment">// The server puts these in the Nymbox just in case -- helps to prevent synchronization issues.</span>
<a name="l00471"></a>00471         <span class="comment">//</span>
<a name="l00472"></a>00472         <span class="comment">// This means the new number was successfully already added to me.</span>
<a name="l00473"></a>00473         <span class="comment">// Therefore I need to add it to my side also, so my balance agreements will work.</span>
<a name="l00474"></a>00474         <span class="comment">// However, ONLY if I find the number on my tentative list, where I stored when I</span>
<a name="l00475"></a>00475         <span class="comment">// first signed for the number, in order to make sure the server couldn&#39;t lie to me</span>
<a name="l00476"></a>00476         <span class="comment">// later by slipping me a successNotice for one I never really signed for.</span>
<a name="l00477"></a>00477         <span class="comment">//</span>
<a name="l00478"></a>00478         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l00479"></a>00479             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a52282952428acc861ea6c25a3839fcc9">OTTransaction::successNotice</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if successNotice (new; ALREADY just added) transaction number.</span>
<a name="l00480"></a>00480             )
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482             <span class="comment">// The numbers on this set were (1) received in a successNotice, (2) found on my Tentative list,</span>
<a name="l00483"></a>00483             <span class="comment">// and (3) Therefore have ALREADY been added as numbers in the past. Therefore I need to REMOVE</span>
<a name="l00484"></a>00484             <span class="comment">// them from my tentative list, and add them as actual transactions. I also need to update my</span>
<a name="l00485"></a>00485             <span class="comment">// &quot;most recent&quot; highest trans # to reflect these new numbers.</span>
<a name="l00486"></a>00486             <span class="comment">//</span>
<a name="l00487"></a>00487             <a class="code" href="class_o_t_num_list.html">OTNumList</a> theOutput;
<a name="l00488"></a>00488             pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(theOutput); <span class="comment">// Get the numlist from the successNotice transaction</span>
<a name="l00489"></a>00489             <span class="comment">// ----------------------------------</span>
<a name="l00490"></a>00490             std::set&lt;int64_t&gt; theNumbers;          <span class="comment">// </span>
<a name="l00491"></a>00491             theOutput.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theNumbers);       <span class="comment">// Get the actual set of numbers from the numlist object.</span>
<a name="l00492"></a>00492             <span class="comment">// --------------------------------</span>
<a name="l00493"></a>00493             <span class="comment">// Iterate through those numbers...</span>
<a name="l00494"></a>00494             <span class="comment">//</span>
<a name="l00495"></a>00495             <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theNumbers)
<a name="l00496"></a>00496             {
<a name="l00497"></a>00497                 <span class="keyword">const</span> int64_t lValue = *it;
<a name="l00498"></a>00498                 <span class="comment">// ----------------------</span>
<a name="l00499"></a>00499 
<a name="l00500"></a>00500                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac05ddbd6036b5304b7215251d1b7c9b0">VerifyTentativeNum</a>(strServerID, lValue))
<a name="l00501"></a>00501                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: OTTransaction::successNotice: This wasn&#39;t on my tentative list (%lld), I must have already processed it. &quot;</span>
<a name="l00502"></a>00502                     <span class="stringliteral">&quot;(Or there was dropped message when I did, or the server is trying to slip me an old number.\n)&quot;</span>, __FUNCTION__, lValue);
<a name="l00503"></a>00503                 <span class="keywordflow">else</span>
<a name="l00504"></a>00504                     setNoticeNumbers.insert(lValue); <span class="comment">// I only take the numbers that I had been expecting, as tentative numbers, </span>
<a name="l00505"></a>00505             }            
<a name="l00506"></a>00506             <span class="comment">// -----------------------------------------------</span>
<a name="l00507"></a>00507             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00510"></a>00510             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512             pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l00513"></a>00513             <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00514"></a>00514 
<a name="l00515"></a>00515             <span class="comment">// sign the item</span>
<a name="l00516"></a>00516             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00517"></a>00517             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         } <span class="comment">// else if successNotice</span>
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00522"></a>00522         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="comment">// if replyNotice -- notice of a server reply I should have already received when I first sent the request.</span>
<a name="l00523"></a>00523             <span class="comment">// (Some server replies are important enough that they have a copy dropped into your Nymbox to make SURE you</span>
<a name="l00524"></a>00524             <span class="comment">// receive and process them.) I&#39;ll accept the notice (clear it from my nymbox) and also I&#39;ll process the </span>
<a name="l00525"></a>00525             <span class="comment">// original server reply message inside of it, in case due to some network issue, I&#39;ve never seen it before.</span>
<a name="l00526"></a>00526             <span class="comment">//</span>
<a name="l00527"></a>00527             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l00528"></a>00528             )
<a name="l00529"></a>00529             <span class="comment">// UPDATE: Clearly if I ALREADY processed the server reply, then I don&#39;t need to process it AGAIN, right?</span>
<a name="l00530"></a>00530             <span class="comment">// This replyNotice is only here JUST IN CASE. (In case I missed the reply originally.) Well, guess what?</span>
<a name="l00531"></a>00531             <span class="comment">// Now I have a list of request numbers stored on the Nym, that tells me definitively whether or not that</span>
<a name="l00532"></a>00532             <span class="comment">// Nym has seen the reply. (Clearly if the Nym has processed the reply already, he doesn&#39;t have to do it </span>
<a name="l00533"></a>00533             <span class="comment">// AGAIN, now does he? This notice was &quot;just in case.&quot;) </span>
<a name="l00534"></a>00534             <span class="comment">//</span>
<a name="l00535"></a>00535             <span class="comment">// Therefore I will check to see if the request number for this replyNotice is in my list of &quot;replies I&#39;ve</span>
<a name="l00536"></a>00536             <span class="comment">// already seen.&quot; If it is, I can entirely skip this step, which would otherwise end up trying erroneously</span>
<a name="l00537"></a>00537             <span class="comment">// to process a server reply even though I had already processed it before.</span>
<a name="l00538"></a>00538         {   <span class="comment">// -----------------------------------------------</span>
<a name="l00539"></a>00539 
<a name="l00540"></a>00540             <span class="keyword">const</span> <span class="keywordtype">bool</span> bAlreadySeenIt = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a11fd56ffbcef5fcebbd259bdb1bd7c8e">VerifyAcknowledgedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aa90624fb50b1b0edb72c6d4bd7b01a4c">GetRequestNum</a>()); <span class="comment">// Client verifies it has already seen a server reply. </span>
<a name="l00541"></a>00541 
<a name="l00542"></a>00542             <span class="keywordflow">if</span> (bAlreadySeenIt) <span class="comment">// if we&#39;ve already seen the reply, then we&#39;re already signalling the server to remove this</span>
<a name="l00543"></a>00543                 <span class="keywordflow">continue</span>;       <span class="comment">// replyNotice on its side anyway, since the notification is clearly accomplished.</span>
<a name="l00544"></a>00544             <span class="comment">//</span>
<a name="l00545"></a>00545             <span class="keywordflow">else</span>    <span class="comment">// But if we HAVEN&#39;T already seen the server&#39;s reply, then lucky for us he dropped a copy into the Nymbox! Now we can process it!</span>
<a name="l00546"></a>00546             {
<a name="l00547"></a>00547                 <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>);
<a name="l00548"></a>00548                 <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pAcceptItem, <span class="stringliteral">&quot;OTItem * pAcceptItem = OTItem::CreateItemFromTransaction(*pAcceptTransaction, OTItem::acceptNotice); for replyNotice.&quot;</span>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                 <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00551"></a>00551                 pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553                 pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l00554"></a>00554                 <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00555"></a>00555 
<a name="l00556"></a>00556                 <span class="comment">// Load up the server&#39;s original reply message (from the server&#39;s transaction item, on the receipt from my Nymbox.)</span>
<a name="l00557"></a>00557                 <span class="comment">// The whole reason that notice was placed in the Nymbox is so we would be guaranteed to receive and process it, in</span>
<a name="l00558"></a>00558                 <span class="comment">// case the original reply was lost due to network problems. Some messages are too important to just &quot;get lost.&quot;</span>
<a name="l00559"></a>00559                 <span class="comment">// Therefore, even though we most likely ALREADY processed this server reply, we&#39;re still going to give it a shot</span>
<a name="l00560"></a>00560                 <span class="comment">// to process right here and now, just as we&#39;re also telling the server to go ahead and clear it out of the Nymbox.</span>
<a name="l00561"></a>00561                 <span class="comment">// The server&#39;s conscience is clear: he knows for SURE that I DID receive notice.</span>
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                 <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2e7b5819c105436d507ee05b176026d2">OTItem::replyNotice</a>);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                 <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
<a name="l00566"></a>00566                     <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l00567"></a>00567                 {
<a name="l00568"></a>00568                     <a class="code" href="class_o_t_string.html">OTString</a> strOriginalReply;
<a name="l00569"></a>00569                     pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strOriginalReply);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strOriginalReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00572"></a>00572                     {
<a name="l00573"></a>00573                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading original server reply message from replyNotice. (It appears to be zero length.)\n&quot;</span>,
<a name="l00574"></a>00574                             __FUNCTION__);
<a name="l00575"></a>00575                     }               
<a name="l00576"></a>00576                     <span class="keywordflow">else</span> <span class="comment">// strOriginalReply.Exists() == true.</span>
<a name="l00577"></a>00577                     {
<a name="l00578"></a>00578                         <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l00579"></a>00579                         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pMessage != NULL, <span class="stringliteral">&quot;OTClient::AcceptEntireNymbox: OTMessage * pMessage = new OTMessage;&quot;</span>);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMessage-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalReply))
<a name="l00582"></a>00582                         {
<a name="l00583"></a>00583                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading original server reply message from replyNotice:\n\n%s\n\n&quot;</span>,
<a name="l00584"></a>00584                                 __FUNCTION__, strOriginalReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00585"></a>00585                             <span class="keyword">delete</span> pMessage;
<a name="l00586"></a>00586                             pMessage = NULL;
<a name="l00587"></a>00587                         }
<a name="l00588"></a>00588                         <span class="keywordflow">else</span> <span class="comment">// Success loading the server&#39;s original reply up into an OTMessage, from a string.</span>
<a name="l00589"></a>00589                         {
<a name="l00590"></a>00590                             <span class="comment">//</span>
<a name="l00591"></a>00591                             <span class="comment">// pMessage needs to be allocated on the heap since ProcessServerReply takes ownership of it.</span>
<a name="l00592"></a>00592                             <span class="comment">// theNymbox is passed in as a pointer because it&#39;s an optional parameter, precisely meant for this</span>
<a name="l00593"></a>00593                             <span class="comment">// situation, where theNymbox happens to be already loaded and we don&#39;t want it loading it again,</span>
<a name="l00594"></a>00594                             <span class="comment">// with one copy ending up overwriting the other.</span>
<a name="l00595"></a>00595                             <span class="comment">//</span>
<a name="l00596"></a>00596                             <span class="comment">//                          const bool bProcessed =</span>
<a name="l00597"></a>00597                             <a class="code" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">ProcessServerReply</a>(*pMessage, &amp;theNymbox); <span class="comment">// ProcessServerReply sometimes has to load the Nymbox. Since we already have it loaded here, we pass it in so it won&#39;t get loaded twice.</span>
<a name="l00598"></a>00598 
<a name="l00599"></a>00599                             pMessage = NULL; <span class="comment">// We&#39;re done with it now.</span>
<a name="l00600"></a>00600 
<a name="l00601"></a>00601                             <span class="comment">// By this point, I KNOW FOR A FACT that IF there was some network problem that caused a Nym to </span>
<a name="l00602"></a>00602                             <span class="comment">// lose an important server message, that by now, the Nym HAS received and processed that server</span>
<a name="l00603"></a>00603                             <span class="comment">// reply as appropriate, using the exact same function that would have been called, had the reply</span>
<a name="l00604"></a>00604                             <span class="comment">// been properly received in the first place. It&#39;s as if it was never lost. (Vital for syncing.)</span>
<a name="l00605"></a>00605                             <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00606"></a>00606                         } <span class="comment">// if success loading original reply message from server.</span>
<a name="l00607"></a>00607                     } <span class="comment">// if strOriginalReply.Exists()</span>
<a name="l00608"></a>00608                 } <span class="comment">// if the replyNotice item is not-NULL and status is &quot;success&quot;</span>
<a name="l00609"></a>00609                 <span class="keywordflow">else</span> 
<a name="l00610"></a>00610                 {   <span class="comment">// NULL or &quot;rejected&quot;</span>
<a name="l00611"></a>00611                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: the replyNotice item was either NULL, or rejected. (Unexpectedly on either count.)\n&quot;</span>,
<a name="l00612"></a>00612                         __FUNCTION__);
<a name="l00613"></a>00613                 }
<a name="l00614"></a>00614                 <span class="comment">// -------------------------</span>
<a name="l00615"></a>00615                 <span class="comment">//</span>
<a name="l00616"></a>00616                 <span class="comment">// sign the item</span>
<a name="l00617"></a>00617                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00618"></a>00618                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00619"></a>00619             } <span class="comment">// If we haven&#39;t &quot;already seen it&quot; then we loaded it up (above) and processed the server reply.</span>
<a name="l00620"></a>00620             <span class="comment">// -----------------------------------------</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622             <span class="comment">// Todo: notice that we remove the replyNotice from the Nymbox, whether we are actually able to successfully</span>
<a name="l00623"></a>00623             <span class="comment">// load the original message or not. But what if that fails? We have now just discarded the message. In the</span>
<a name="l00624"></a>00624             <span class="comment">// future, perhaps have a place where &quot;failed messages go to die&quot; so that vital data isn&#39;t lost in the event</span>
<a name="l00625"></a>00625             <span class="comment">// of some unanticipated future bug.</span>
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         } <span class="comment">// else if replyNotice</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00630"></a>00630         <span class="comment">// It&#39;s a NEW Transaction Number (I need to sign for it.)</span>
<a name="l00631"></a>00631         <span class="comment">//</span>
<a name="l00632"></a>00632         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l00633"></a>00633             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad74c4b196dafbd9b1eacc19d825c6a3e">OTTransaction::blank</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if blank (new; just added) transaction number.</span>
<a name="l00634"></a>00634             )
<a name="l00635"></a>00635         {               
<a name="l00636"></a>00636             <span class="comment">// My new transaction agreement needs to reflect all these new transaction numbers</span>
<a name="l00637"></a>00637             <span class="comment">// that I&#39;m signing for (or at least this one in this block) so I add them to this</span>
<a name="l00638"></a>00638             <span class="comment">// temp nym, and then harvest the ones onto it from theNym, and then send those</span>
<a name="l00639"></a>00639             <span class="comment">// numbers in the new transaction agreement. (Removing them immediately after, and</span>
<a name="l00640"></a>00640             <span class="comment">// then only adding them for real if we get a server acknowledgment.)</span>
<a name="l00641"></a>00641             <span class="comment">//</span>
<a name="l00642"></a>00642             <a class="code" href="class_o_t_num_list.html">OTNumList</a> theNumlist, theBlankList;
<a name="l00643"></a>00643             pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#af2efe5ad904b711e00dadf613343bf7a">GetNumList</a>(theNumlist);
<a name="l00644"></a>00644             std::set&lt;int64_t&gt; theNumbers;
<a name="l00645"></a>00645             theNumlist.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(theNumbers);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647             <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, theNumbers)
<a name="l00648"></a>00648             {
<a name="l00649"></a>00649                 <span class="keyword">const</span> int64_t lTransactionNumber = *it;
<a name="l00650"></a>00650                 <span class="comment">// -----------------------------------------</span>
<a name="l00651"></a>00651                 <span class="comment">// Loop FOR EACH TRANSACTION NUMBER in the &quot;blank&quot; (there could be 20 of them...)</span>
<a name="l00652"></a>00652                 <span class="comment">//</span>
<a name="l00653"></a>00653                 <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lTransactionNumber)) <span class="comment">// Trans number is already issued to this nym (must be an old notice.)</span>
<a name="l00654"></a>00654                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I &quot;</span>
<a name="l00655"></a>00655                     <span class="stringliteral">&quot;ALREADY HAD...(Skipping.)\n&quot;</span>, __FUNCTION__);
<a name="l00656"></a>00656                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac05ddbd6036b5304b7215251d1b7c9b0">VerifyTentativeNum</a>(strServerID, lTransactionNumber)) <span class="comment">// Trans number is already on the tentative list (meaning it&#39;s already been accepted.)</span>
<a name="l00657"></a>00657                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I ALREADY &quot;</span>
<a name="l00658"></a>00658                     <span class="stringliteral">&quot;ACCEPTED (it&#39;s on my tentative list already; Skipping.)\n&quot;</span>, __FUNCTION__);
<a name="l00659"></a>00659                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bGotHighestNum &amp;&amp; (lTransactionNumber &lt;= lHighestNum)) <span class="comment">// Man, this is old numbers we&#39;ve already HAD before!</span>
<a name="l00660"></a>00660                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Attempted to accept a blank transaction number that I&#39;ve HAD BEFORE, &quot;</span>
<a name="l00661"></a>00661                     <span class="stringliteral">&quot;or at least, is &lt;= to ones I&#39;ve had before. (Skipping...)\n&quot;</span>, __FUNCTION__);
<a name="l00662"></a>00662                 <span class="keywordflow">else</span>
<a name="l00663"></a>00663                 {
<a name="l00664"></a>00664                     theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTransactionNumber);
<a name="l00665"></a>00665                     <span class="comment">// -------------------------------------</span>
<a name="l00666"></a>00666                     theBlankList.Add(lTransactionNumber);
<a name="l00667"></a>00667                 }
<a name="l00668"></a>00668             }<span class="comment">// for-each</span>
<a name="l00669"></a>00669             <span class="comment">// -----------------------------------------------</span>
<a name="l00670"></a>00670             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672             pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#af71be628017c874b5bd63fafa277ee0e">AddBlankNumbersToItem</a>(theBlankList);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00675"></a>00675             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677             pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l00678"></a>00678             <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00679"></a>00679 
<a name="l00680"></a>00680             <span class="comment">// sign the item</span>
<a name="l00681"></a>00681             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00682"></a>00682             pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00683"></a>00683             <span class="comment">// ------------------------------------------------------------</span>
<a name="l00684"></a>00684         } <span class="comment">// else if blank</span>
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="comment">// ------------------------------------------------------------</span>
<a name="l00687"></a>00687         <span class="comment">// It&#39;s a Final Receipt (In the Nymbox, this means an opening transaction </span>
<a name="l00688"></a>00688         <span class="comment">// number has been removed from my issued list on the server side.)</span>
<a name="l00689"></a>00689         <span class="comment">//</span>
<a name="l00690"></a>00690         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l00691"></a>00691             (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) <span class="comment">// if finalReceipt (just removed) transaction number.</span>
<a name="l00692"></a>00692             )
<a name="l00693"></a>00693         {               
<a name="l00694"></a>00694             <span class="comment">// Todo security: make sure this is only possible for finalReceipts, in case of abuse.</span>
<a name="l00695"></a>00695             <span class="comment">// Not only for finalReceipts, but for specific finalReceipt #s that I store a local list of, perhaps</span>
<a name="l00696"></a>00696             <span class="comment">// in my Nym, to track until they are closed. No other number should get through here.</span>
<a name="l00697"></a>00697             <span class="comment">// Otherwise the server could trick you into removing your issued numbers, simply by dropping </span>
<a name="l00698"></a>00698             <span class="comment">// a final receipt for the appropriate number!</span>
<a name="l00699"></a>00699             <span class="comment">// The server already keeps a list on its side to protect it from this possibility, but now it</span>
<a name="l00700"></a>00700             <span class="comment">// appears that the client-side will have to do a similar thing. Sigh.</span>
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 
<a name="l00703"></a>00703             <span class="comment">// Since the &quot;in reference to&quot; (the original &quot;opening&quot; transaction#) is supposedly</span>
<a name="l00704"></a>00704             <span class="comment">// already closed, then let&#39;s just MAKE SURE of that, since otherwise it&#39;ll screw up</span>
<a name="l00705"></a>00705             <span class="comment">// my future balance agreements. (The instant a finalReceipt appears, the &quot;in ref to&quot; # is already gone..)</span>
<a name="l00706"></a>00706             <span class="comment">//</span>
<a name="l00707"></a>00707             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l00708"></a>00708                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: **** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
<a name="l00709"></a>00709                 __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l00710"></a>00710             <span class="keywordflow">else</span>
<a name="l00711"></a>00711                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: **** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l00712"></a>00712                 __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l00713"></a>00713 
<a name="l00714"></a>00714             <span class="comment">//</span>
<a name="l00715"></a>00715             <span class="comment">// pNym won&#39;t actually save unless it actually removes that #. If the #&#39;s already NOT THERE,</span>
<a name="l00716"></a>00716             <span class="comment">// then the removal will fail, and thus it won&#39;t bother saving here.</span>
<a name="l00717"></a>00717 
<a name="l00718"></a>00718             <span class="comment">// ----------------------------------------------</span>
<a name="l00719"></a>00719             <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l00720"></a>00720             <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l00721"></a>00721             <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l00722"></a>00722             <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l00723"></a>00723             <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l00724"></a>00724             <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l00725"></a>00725             <span class="comment">// It is for the others.</span>
<a name="l00726"></a>00726             <span class="comment">//</span>
<a name="l00727"></a>00727             <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
<a name="l00728"></a>00728             <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
<a name="l00729"></a>00729             <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
<a name="l00730"></a>00730             <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
<a name="l00731"></a>00731             <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
<a name="l00732"></a>00732             <span class="comment">//</span>
<a name="l00733"></a>00733             <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l00734"></a>00734                                                pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l00735"></a>00735                                                pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l00736"></a>00736             <span class="comment">// ----------------------------------------------</span>
<a name="l00737"></a>00737             <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739             <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l00740"></a>00740             pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742             pAcceptItem-&gt;SetReferenceToNum(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l00743"></a>00743             <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l00744"></a>00744 
<a name="l00745"></a>00745             pAcceptItem-&gt;SignContract(*pNym);
<a name="l00746"></a>00746             pAcceptItem-&gt;SaveContract();
<a name="l00747"></a>00747         } <span class="comment">// else if finalReceipt (in Nymbox, this signals that an OPENING number has closed ALREADY. Thus no need to have a &quot;closing process.&quot;)</span>
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <span class="comment">// If the above processing resulted in us actually accepting certain specific items,</span>
<a name="l00752"></a>00752     <span class="comment">// then let&#39;s process the message out to the server.</span>
<a name="l00753"></a>00753     <span class="comment">//</span>
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aab7ec90e81dc8f273b8c29617e40bab6">GetItemCount</a>())
<a name="l00755"></a>00755     {
<a name="l00756"></a>00756         <span class="comment">// IF there were transactions that were approved for me, (and I have notice of them in my nymbox)</span>
<a name="l00757"></a>00757         <span class="comment">// then they will be in this set. Also, they&#39;ll only be here IF they were verified as ACTUALLY being</span>
<a name="l00758"></a>00758         <span class="comment">// on my tentative list.</span>
<a name="l00759"></a>00759         <span class="comment">// Therefore need to REMOVE from Tentative list, and add to actual issued/available lists.</span>
<a name="l00760"></a>00760         <span class="comment">//</span>
<a name="l00761"></a>00761         <span class="keywordflow">if</span> (setNoticeNumbers.size() &gt; 0)
<a name="l00762"></a>00762         {
<a name="l00763"></a>00763             <span class="comment">//</span>
<a name="l00764"></a>00764             <span class="comment">// Note: No need to update highest num here, since that should have already been done when they were</span>
<a name="l00765"></a>00765             <span class="comment">// added to my issued list in the first place. (Removed from tentative.)</span>
<a name="l00766"></a>00766             <span class="comment">//</span>
<a name="l00767"></a>00767             <span class="comment">//          int64_t lViolator = pNym-&gt;UpdateHighestNum(*pNym, strServerID, setNoticeNumbers); // bSave=false (saved below if necessary)</span>
<a name="l00768"></a>00768             <span class="comment">//          </span>
<a name="l00769"></a>00769             <span class="comment">//          if (lViolator != 0)</span>
<a name="l00770"></a>00770             <span class="comment">//              OTLog::vError(&quot;OTClient::AcceptEntireNymbox: ERROR: Tried to update highest trans # for a server, with lower numbers!\n&quot;</span>
<a name="l00771"></a>00771             <span class="comment">//                            &quot;This should NEVER HAPPEN, since these numbers are supposedly verified already before even getting this far.\n&quot;</span>
<a name="l00772"></a>00772             <span class="comment">//                            &quot;Violating number (too low): %lld, Nym ID: %s \n&quot;, lViolator, strNymID.Get());</span>
<a name="l00773"></a>00773             <span class="comment">//          else</span>
<a name="l00774"></a>00774             {
<a name="l00775"></a>00775                 <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, setNoticeNumbers)
<a name="l00776"></a>00776                 {
<a name="l00777"></a>00777                     <span class="keyword">const</span> int64_t lNoticeNum = (*it);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779                     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#af39adadda751a07bcd5388cd3528674f">RemoveTentativeNum</a>(strServerID, lNoticeNum)) <span class="comment">// doesn&#39;t save (but saved below)</span>
<a name="l00780"></a>00780                         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lNoticeNum, <span class="keyword">false</span>); <span class="comment">// bSave = false (but saved below...)</span>
<a name="l00781"></a>00781                 }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783                 <span class="comment">// The notice means it already happened in the past. I already accepted the transaction # in my past,</span>
<a name="l00784"></a>00784                 <span class="comment">// and now there is a notice of that fact sitting in my Nymbox. Until I recognize it, all my transaction</span>
<a name="l00785"></a>00785                 <span class="comment">// statements will fail. (Like the one a few lines below here...)</span>
<a name="l00786"></a>00786                 <span class="comment">//</span>
<a name="l00787"></a>00787                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym); 
<a name="l00788"></a>00788             }           
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790         <span class="comment">//*********************************************************************************</span>
<a name="l00791"></a>00791 
<a name="l00792"></a>00792         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTClient::processNymbox</a>, theMessage, 
<a name="l00793"></a>00793             *pNym, 
<a name="l00794"></a>00794             <span class="comment">//                              *(pAssetContract),</span>
<a name="l00795"></a>00795             theServerContract,
<a name="l00796"></a>00796             <span class="comment">//                             *(theConnection.GetServerContract()), </span>
<a name="l00797"></a>00797             NULL) &gt; 0) 
<a name="l00798"></a>00798         {
<a name="l00799"></a>00799             <span class="comment">// the message is all set up and ready to go out... it&#39;s even signed.</span>
<a name="l00800"></a>00800             <span class="comment">// Except the ledger we&#39;re sending, still needs to be added, and then the</span>
<a name="l00801"></a>00801             <span class="comment">// message needs to be re-signed as a result of that.</span>
<a name="l00802"></a>00802 
<a name="l00803"></a>00803             theNymbox.<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>(); <span class="comment">// Since this function accepts them ALL, the new balance agreement needs to show it as empty.</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805             <span class="comment">// -----------------------------------------</span>
<a name="l00806"></a>00806 
<a name="l00807"></a>00807             <span class="comment">// By this point, theIssuedNym contains a list of all the transaction numbers that are in my</span>
<a name="l00808"></a>00808             <span class="comment">// nymbox, and that WILL be ADDED to me once this processNymbox is processed.</span>
<a name="l00809"></a>00809             <span class="comment">// Therefore I need to ADD those items to my issued list (at least temporarily) in order to</span>
<a name="l00810"></a>00810             <span class="comment">// calculate the transaction agreement properly. So I used theIssueNym as a temp variable to store those</span>
<a name="l00811"></a>00811             <span class="comment">// numbers, so I can add them to my Nym and them remove them again after generating the statement.</span>
<a name="l00812"></a>00812             <span class="comment">//</span>
<a name="l00813"></a>00813             <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
<a name="l00814"></a>00814             {
<a name="l00815"></a>00815                 int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
<a name="l00816"></a>00816                 <span class="comment">// We know it&#39;s not already issued on the Nym, or it wouldn&#39;t have even gotten</span>
<a name="l00817"></a>00817                 <span class="comment">// set inside theIssuedNym in the first place (further up above.) That&#39;s why</span>
<a name="l00818"></a>00818                 <span class="comment">// we are confident now that we can add it, generate the transaction statement,</span>
<a name="l00819"></a>00819                 <span class="comment">// and then remove it again.</span>
<a name="l00820"></a>00820                 <span class="comment">//</span>
<a name="l00821"></a>00821                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824             <span class="comment">//*********************************************************************************</span>
<a name="l00825"></a>00825             <span class="comment">// TRANSACTION STATEMENT</span>
<a name="l00826"></a>00826             <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
<a name="l00827"></a>00827             <span class="comment">//</span>
<a name="l00828"></a>00828             <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pAcceptTransaction);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830             <span class="comment">//*********************************************************************************</span>
<a name="l00831"></a>00831 
<a name="l00832"></a>00832             <span class="comment">// Here I am removing the new numbers again, now that the statement has been generated.</span>
<a name="l00833"></a>00833             <span class="comment">// If the message is successful, then I will need to add them for real.</span>
<a name="l00834"></a>00834             <span class="comment">//</span>
<a name="l00835"></a>00835             <span class="keywordtype">bool</span> bAddedTentative=<span class="keyword">false</span>;
<a name="l00836"></a>00836             <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
<a name="l00837"></a>00837             {
<a name="l00838"></a>00838                 int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
<a name="l00839"></a>00839                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp);
<a name="l00840"></a>00840                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a154a958a9f3cfdb07167858579f74037">AddTentativeNum</a>(strServerID, lTemp); <span class="comment">// So when I see the success notice later, I&#39;ll know the server isn&#39;t lying. (Store a copy here until then.)</span>
<a name="l00841"></a>00841                 bAddedTentative = <span class="keyword">true</span>;
<a name="l00842"></a>00842             }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844             <span class="keywordflow">if</span> (bAddedTentative)
<a name="l00845"></a>00845                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l00846"></a>00846             <span class="comment">// -----------------------------------------</span>
<a name="l00847"></a>00847 
<a name="l00848"></a>00848             <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// This can&#39;t be NULL BTW, since there is an OT_ASSERT in Generate call. But I hate to use a pointer without checking it.</span>
<a name="l00849"></a>00849                 pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l00850"></a>00850             <span class="keywordflow">else</span>
<a name="l00851"></a>00851                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: This should never happen.\n&quot;</span>, __FUNCTION__);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853             <span class="comment">// ------------------------------------------------------------</span>
<a name="l00854"></a>00854 
<a name="l00855"></a>00855             <span class="comment">// Sign the accept transaction, as well as the message ledger </span>
<a name="l00856"></a>00856             <span class="comment">// that we&#39;ve just constructed containing it.</span>
<a name="l00857"></a>00857             pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l00858"></a>00858             pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l00859"></a>00859 
<a name="l00860"></a>00860             processLedger.SignContract(*pNym);
<a name="l00861"></a>00861             processLedger.SaveContract();
<a name="l00862"></a>00862 
<a name="l00863"></a>00863             <span class="comment">// Extract the ledger into string form and add it as the payload on the message.</span>
<a name="l00864"></a>00864             <a class="code" href="class_o_t_string.html">OTString</a> strLedger(processLedger);
<a name="l00865"></a>00865             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l00866"></a>00866 
<a name="l00867"></a>00867             <span class="comment">// Release any other signatures from the message, since I know it</span>
<a name="l00868"></a>00868             <span class="comment">// was signed already in the above call to ProcessUserCommand.</span>
<a name="l00869"></a>00869             theMessage.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l00870"></a>00870 
<a name="l00871"></a>00871             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873             <span class="comment">// Sign it and send it out.</span>
<a name="l00874"></a>00874             <span class="comment">//          theConnection.SignAndSend(theMessage);</span>
<a name="l00875"></a>00875             <span class="comment">// I could have called SignContract() and then theConnection.ProcessMessageOut(message) </span>
<a name="l00876"></a>00876             <span class="comment">// but I used the above function instead.</span>
<a name="l00877"></a>00877 
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879         <span class="keywordflow">else</span>
<a name="l00880"></a>00880             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error processing processNymbox command.\n&quot;</span>, __FUNCTION__);
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="comment">// Done:  Make sure that transaction numbers being TEMPORARILY REMOVED from Nym (to generate a statement</span>
<a name="l00889"></a>00889 <span class="comment">// or balance agreement) are not put BACK onto the Nym unless they REALLY WERE THERE....</span>
<a name="l00890"></a>00890 <span class="comment">//</span>
<a name="l00891"></a>00891 <span class="comment">// What might be happening is this: We remove the finalReceipt to generate the statement, but then ADD IT BACK</span>
<a name="l00892"></a>00892 <span class="comment">// again to the Nym unless/until the request was successful. This is normal behavior most of the time. BUT...</span>
<a name="l00893"></a>00893 <span class="comment">// IN THE NYMBOX, the finalReceipt is ONLY A NOTICE, to aid removal, since it was ALREADY REMOVED on the server&#39;s</span>
<a name="l00894"></a>00894 <span class="comment">// side!  There&#39;s no point adding it again -- it&#39;s GONE!   WORSE: If due to communication error, you never got</span>
<a name="l00895"></a>00895 <span class="comment">// the server&#39;s reply -- well it&#39;s still on your list on the client side, isn&#39;t it? But this time, you don&#39;t have</span>
<a name="l00896"></a>00896 <span class="comment">// any convenient notice in your Nymbox informing you that it&#39;s supposed to be gone. As far as you know, it&#39;s still</span>
<a name="l00897"></a>00897 <span class="comment">// good. It&#39;s on your list, right?  That&#39;s the whole problem. In Nymbox, it&#39;s a NOTICE of a PAST EVENT. Just REMOVE</span>
<a name="l00898"></a>00898 <span class="comment">// the issued number AS SOON AS YOU SEE THE NOTICE.  This way your transaction statement is sure to be accurate.</span>
<a name="l00899"></a>00899 <span class="comment">//</span>
<a name="l00900"></a>00900 <span class="comment">// This may not be the case for the Inbox (below) but the lesson is still important: Some numbers are removed</span>
<a name="l00901"></a>00901 <span class="comment">// IMMEDIATELY upon notice. Other numbers are removed only when the receipt has been successfully closed, otherwise</span>
<a name="l00902"></a>00902 <span class="comment">// they are added back on again. And furthermore, they are only added back on if they really were found on your</span>
<a name="l00903"></a>00903 <span class="comment">// Nym in the first place. OTHERWISE, a SECURITY WEAKNESS would occur, where the server could TRICK you into adding</span>
<a name="l00904"></a>00904 <span class="comment">// numbers to your list of responsibility, even though they hadn&#39;t been there in the first place! You&#39;d just do your</span>
<a name="l00905"></a>00905 <span class="comment">// normal process of removing the number, sending the request, then adding the number back again -- but if it hadn&#39;t</span>
<a name="l00906"></a>00906 <span class="comment">// been there in the first place, it&#39;d still be added back again!  That&#39;s why there needs to be a CLEAR DISTINCTION</span>
<a name="l00907"></a>00907 <span class="comment">// in both functions (above and below) between NEW numbers being added to your list, and numbers being removed</span>
<a name="l00908"></a>00908 <span class="comment">// from your list, and between numbers that were already on your list, numbers that were not already on your list,</span>
<a name="l00909"></a>00909 <span class="comment">// and between numbers being removed from your list, and numbers that were ALREADY REMOVED some time in the past.</span>
<a name="l00910"></a>00910 <span class="comment">//</span>
<a name="l00911"></a>00911 <span class="comment">// DONE: Verify all these places:  AcceptEntireNymbox, AcceptEntireInbox, API calls for accepting Inbox, OTClient</span>
<a name="l00912"></a>00912 <span class="comment">// code for @processInbox and @processNymbox, and server code for those also.</span>
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 
<a name="l00919"></a>00919 <span class="comment">//</span>
<a name="l00920"></a><a class="code" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">00920</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">OTClient::AcceptEntireInbox</a>(<a class="code" href="class_o_t_ledger.html">OTLedger</a>           &amp; theInbox, 
<a name="l00921"></a>00921                                  <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID,
<a name="l00922"></a>00922                                  <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>   &amp; theServerContract, 
<a name="l00923"></a>00923                                  <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>        &amp; theNym,
<a name="l00924"></a>00924                                  <a class="code" href="class_o_t_message.html">OTMessage</a>          &amp; theMessage,
<a name="l00925"></a>00925                                  <a class="code" href="class_o_t_account.html">OTAccount</a>          &amp; theAccount)
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l00928"></a>00928     <span class="comment">// ---------------------------------------------</span>
<a name="l00929"></a>00929     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym      = &amp;theNym;
<a name="l00930"></a>00930     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theAccountID(theInbox);
<a name="l00931"></a>00931     <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount  = &amp;theAccount;
<a name="l00932"></a>00932     <a class="code" href="class_o_t_ledger.html">OTLedger</a>    * pOutbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym); <span class="comment">// Need this for balance agreement (outbox hash)</span>
<a name="l00933"></a>00933     <span class="comment">// ---------------------------------------------</span>
<a name="l00934"></a>00934     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox); <span class="comment">// auto cleanup.</span>
<a name="l00935"></a>00935     <span class="comment">// ---------------------------------------------</span>
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l00937"></a>00937     {
<a name="l00938"></a>00938         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTClient::AcceptEntireInbox: Failed loading outbox!\n&quot;</span>);
<a name="l00939"></a>00939         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941     <span class="comment">// ---------------------------------------------    </span>
<a name="l00942"></a>00942     <span class="keywordflow">if</span> (theInbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &lt; 1) 
<a name="l00943"></a>00943     {
<a name="l00944"></a>00944         <span class="comment">// If there aren&#39;t any transactions in the inbox, no point wasting a # to process an empty box.</span>
<a name="l00945"></a>00945         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTClient::AcceptEntireInbox: no point wasting a transaction number in order to process an empty box\n&quot;</span>);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00948"></a>00948     }
<a name="l00949"></a>00949     <span class="comment">// ---------------------------------------------</span>
<a name="l00950"></a>00950     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theServerID);
<a name="l00951"></a>00951     int64_t lStoredTransactionNumber=0;
<a name="l00952"></a>00952     <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber); <span class="comment">// Warning: this saves the nym if successful.</span>
<a name="l00953"></a>00953     <span class="comment">// ---------------------------------------------</span>
<a name="l00954"></a>00954     <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l00955"></a>00955     {
<a name="l00956"></a>00956         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error: No transaction numbers are available. Suggest requesting the server for a new one.\n&quot;</span>);
<a name="l00957"></a>00957         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959     <span class="comment">// ---------------------------------------------</span>
<a name="l00960"></a>00960     <span class="comment">// the message to the server will contain a ledger to be processed for a specific acct.</span>
<a name="l00961"></a>00961     <a class="code" href="class_o_t_ledger.html">OTLedger</a> processLedger(theInbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), theAccountID, theServerID);    
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">// bGenerateFile defaults to false on GenerateLedger call, so I left out the false.</span>
<a name="l00964"></a>00964     processLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(theAccountID, theServerID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// Can&#39;t just use one of these. It either has to be read out of a file or</span>
<a name="l00965"></a>00965     <span class="comment">// a string, or it has to be generated. So you construct it, then you either</span>
<a name="l00966"></a>00966     <span class="comment">// call GenerateLedger or LoadInbox, then you call VerifyContractID to make sure</span>
<a name="l00967"></a>00967     <span class="comment">// it loaded securely. (No need to verify if you just generated it.)</span>
<a name="l00968"></a>00968 
<a name="l00969"></a>00969     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pAcceptTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theInbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>(), 
<a name="l00970"></a>00970         theAccountID, theServerID, <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTTransaction::processInbox</a>, lStoredTransactionNumber);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="comment">// ---------------------------------------------</span>
<a name="l00973"></a>00973     <span class="comment">// This insures that the ledger will handle cleaning up the transaction, so I don&#39;t have to delete it later.</span>
<a name="l00974"></a>00974     processLedger.AddTransaction(*pAcceptTransaction);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <span class="comment">// loop through the transactions in theInbox, and create corresponding &quot;accept&quot; items</span>
<a name="l00977"></a>00977     <span class="comment">// for each one of the transfer requests. Each of those items will go into a single</span>
<a name="l00978"></a>00978     <span class="comment">// &quot;process inbox&quot; transaction that I will add to the processledger and thus to the </span>
<a name="l00979"></a>00979     <span class="comment">// outgoing message.</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     int64_t lAdjustment = 0; <span class="comment">// If I accept any pending transactions, I must take note of any adjustment when I sign the balance agreement.</span>
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="comment">// If transaction #s that have been ISSUED to pNym are being REMOVED by this transaction,</span>
<a name="l00984"></a>00984     <span class="comment">// then we use this temporary Nym (theIssuedNym) to store the ones that are being removed,</span>
<a name="l00985"></a>00985     <span class="comment">// so that we can remove them from the Nym, calculate the balance agreement, and then add them</span>
<a name="l00986"></a>00986     <span class="comment">// back on again. (They aren&#39;t removed for real until the server &quot;success&quot; reply comes back.)</span>
<a name="l00987"></a>00987     <span class="comment">//</span>
<a name="l00988"></a>00988     <span class="comment">// WARNING: Take care not to add them BACK, unless they really were there in the first place!</span>
<a name="l00989"></a>00989     <span class="comment">// Otherwise you have just been tricked into adding numbers to pNym that weren&#39;t even there,</span>
<a name="l00990"></a>00990     <span class="comment">// versus what you thought you were doing (re-adding numbers to pNym that HAD been there, and</span>
<a name="l00991"></a>00991     <span class="comment">// had only been temporarily removed in order to perform a calculation.)</span>
<a name="l00992"></a>00992     <span class="comment">//</span>
<a name="l00993"></a>00993     <span class="comment">//</span>
<a name="l00994"></a>00994     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theIssuedNym;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="comment">// For each transaction in the inbox, if it&#39;s in reference to a transfer request,</span>
<a name="l00997"></a>00997     <span class="comment">// then create an &quot;accept&quot; item for that transfer request, and add it to my own, new,</span>
<a name="l00998"></a>00998     <span class="comment">// &quot;process inbox&quot; transaction that I&#39;m sending out.</span>
<a name="l00999"></a>00999     <span class="comment">//</span>
<a name="l01000"></a>01000     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l01001"></a>01001     {
<a name="l01002"></a>01002         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
<a name="l01003"></a>01003         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         <span class="comment">// If this transaction references the item that I&#39;m trying to accept...</span>
<a name="l01006"></a>01006         <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>() &gt; 0) <span class="comment">// if pointer not null AND it refers to some other transaction</span>
<a name="l01007"></a>01007         {
<a name="l01008"></a>01008             <a class="code" href="class_o_t_string.html">OTString</a> strRespTo;
<a name="l01009"></a>01009             pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strRespTo);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011             <span class="comment">// Sometimes strRespTo contains an OTPaymentPlan or an OTTrade. (Or an OTSmartContract.)</span>
<a name="l01012"></a>01012             <span class="comment">// The rest of the time, it contains an OTItem.</span>
<a name="l01013"></a>01013             <span class="comment">//</span>
<a name="l01014"></a>01014             <span class="comment">// The reason is because in most cases I have the original item</span>
<a name="l01015"></a>01015             <span class="comment">// right there, so I attach it. But with payment plans and trades,</span>
<a name="l01016"></a>01016             <span class="comment">// the original payment plan itself, or trade itself, is being loaded</span>
<a name="l01017"></a>01017             <span class="comment">// by Cron (as a cron receipt) for reference reasons, and thus it is</span>
<a name="l01018"></a>01018             <span class="comment">// the most appropriate object to attach in that case, and also, the</span>
<a name="l01019"></a>01019             <span class="comment">// OTItem is not available in that context, since we aren&#39;t even processing</span>
<a name="l01020"></a>01020             <span class="comment">// a message, but rather, we are in Cron, processing a trade or some</span>
<a name="l01021"></a>01021             <span class="comment">// other sort of cron item.</span>
<a name="l01022"></a>01022 
<a name="l01023"></a>01023             <span class="comment">// ************************************************************************</span>
<a name="l01024"></a>01024 
<a name="l01025"></a>01025             <span class="comment">// PAYMENT RECEIPT, MARKET RECEIPT</span>
<a name="l01026"></a>01026             <span class="comment">//</span>
<a name="l01027"></a>01027             <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aac41b416522c9ba6453c787607c6c68d">OTTransaction::paymentReceipt</a>  == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
<a name="l01028"></a>01028                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad46b36946aa172b4e69558c3c5697c63">OTTransaction::marketReceipt</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
<a name="l01029"></a>01029             {               
<a name="l01030"></a>01030                 <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                 <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l01033"></a>01033                 pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035                 <span class="comment">// Set up the &quot;accept&quot; transaction item to be sent to the server, by referencing</span>
<a name="l01036"></a>01036                 <span class="comment">// the transaction number of the receipt. Normally, when accepting a pending</span>
<a name="l01037"></a>01037                 <span class="comment">// transaction, I set the &quot;in reference to&quot; to the transaction number of the</span>
<a name="l01038"></a>01038                 <span class="comment">// original transfer that I am accepting.</span>
<a name="l01039"></a>01039                 <span class="comment">//</span>
<a name="l01040"></a>01040                 <span class="comment">// But I cannot do this with a market receipt, or a payment plan receipt,</span>
<a name="l01041"></a>01041                 <span class="comment">// since there may be MULTIPLE RECEIPTS REFERENCING THE SAME NUMBER (they will</span>
<a name="l01042"></a>01042                 <span class="comment">// all reference the original payment plan / offer.) Thus, in the case of receipts,</span>
<a name="l01043"></a>01043                 <span class="comment">// I accept by setting the &quot;in reference to&quot; to the RECEIPT&#39;s transaction number,</span>
<a name="l01044"></a>01044                 <span class="comment">// since each receipt represents a distinct transaction anyway, and I must</span>
<a name="l01045"></a>01045                 <span class="comment">// accept them individually, and that is the number that identifies them uniquely.</span>
<a name="l01046"></a>01046 
<a name="l01047"></a>01047                 pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pTransaction);
<a name="l01048"></a>01048 
<a name="l01049"></a>01049                 pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my inbox.</span>
<a name="l01050"></a>01050                 <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l01051"></a>01051 
<a name="l01052"></a>01052                 <span class="comment">// Nothing here to remove via theIssuedNym. In this case, the transaction came from the server.</span>
<a name="l01053"></a>01053                 <span class="comment">// Only my ORIGINAL request to enter the payment plan can be removed, and that only happens when the</span>
<a name="l01054"></a>01054                 <span class="comment">// finalReceipt is issued, not when a single receipt is removed. Therefore, I can only accept the</span>
<a name="l01055"></a>01055                 <span class="comment">// receipt from my inbox, but this moment here doesn&#39;t free up any of my issued transaction numbers.</span>
<a name="l01056"></a>01056                 <span class="comment">//</span>
<a name="l01057"></a>01057 <span class="comment">//              if (pNym-&gt;VerifyIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum()))</span>
<a name="l01058"></a>01058 <span class="comment">//                  theIssuedNym.AddIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum());</span>
<a name="l01059"></a>01059 <span class="comment">//              else {error}</span>
<a name="l01060"></a>01060 
<a name="l01061"></a>01061                 <span class="comment">// I don&#39;t attach the original payment plan or trade here, </span>
<a name="l01062"></a>01062                 <span class="comment">// because I already reference it by transaction num of the receipt,</span>
<a name="l01063"></a>01063                 <span class="comment">// and the server can look it up in my inbox from there.</span>
<a name="l01064"></a>01064 
<a name="l01065"></a>01065                 <span class="comment">// This just makes it convenient later.</span>
<a name="l01066"></a>01066                 pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()); <span class="comment">// The server will verify this actually matches, or reject the message.</span>
<a name="l01067"></a>01067 
<a name="l01068"></a>01068                 <span class="comment">// sign the item</span>
<a name="l01069"></a>01069                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01070"></a>01070                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01071"></a>01071             } <span class="comment">// if market receipt or payment receipt (cron receipt)</span>
<a name="l01072"></a>01072 
<a name="l01073"></a>01073             <span class="comment">// ************************************************************************</span>
<a name="l01074"></a>01074 
<a name="l01075"></a>01075             <span class="comment">// FINAL RECEIPT, BASKET RECEIPT</span>
<a name="l01076"></a>01076             <span class="comment">//</span>
<a name="l01077"></a>01077             <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
<a name="l01078"></a>01078                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a2f852a3f97691d417faa322cdbbb3377">OTTransaction::basketReceipt</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
<a name="l01079"></a>01079             {       
<a name="l01080"></a>01080                 <span class="comment">// Since the &quot;in reference to&quot; is supposedly already closed, then let&#39;s just</span>
<a name="l01081"></a>01081                 <span class="comment">// MAKE SURE of that, since otherwise it&#39;ll screw up my future balance agreements.</span>
<a name="l01082"></a>01082                 <span class="comment">// (The instant a finalReceipt appears, the &quot;in ref to&quot; is already gone. Let it go.)</span>
<a name="l01083"></a>01083                 <span class="comment">//</span>
<a name="l01084"></a>01084                 <span class="comment">//  todo security: make sure not to actually remove this number unless I double check</span>
<a name="l01085"></a>01085                 <span class="comment">// it against a client-side list of open transaction numbers for cron items (expecting</span>
<a name="l01086"></a>01086                 <span class="comment">// final receipts.) Unless the number appears on that list, don&#39;t remove it. And then,</span>
<a name="l01087"></a>01087                 <span class="comment">// remove it from the list as well. The server already has a mechanism like this.</span>
<a name="l01088"></a>01088                 <span class="comment">//</span>
<a name="l01089"></a>01089                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l01090"></a>01090                 {
<a name="l01091"></a>01091                     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l01092"></a>01092                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
<a name="l01093"></a>01093                         pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01094"></a>01094                     <span class="keywordflow">else</span>
<a name="l01095"></a>01095                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l01096"></a>01096                         pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                     <span class="comment">// ----------------------------------------------</span>
<a name="l01099"></a>01099                     <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l01100"></a>01100                     <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l01101"></a>01101                     <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l01102"></a>01102                     <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l01103"></a>01103                     <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l01104"></a>01104                     <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l01105"></a>01105                     <span class="comment">// It is for the others.</span>
<a name="l01106"></a>01106                     <span class="comment">//</span>
<a name="l01107"></a>01107                     <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
<a name="l01108"></a>01108                     <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
<a name="l01109"></a>01109                     <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
<a name="l01110"></a>01110                     <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
<a name="l01111"></a>01111                     <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
<a name="l01112"></a>01112                     <span class="comment">//</span>
<a name="l01113"></a>01113                     <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l01114"></a>01114                                                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l01115"></a>01115                                                        pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l01116"></a>01116                 }
<a name="l01117"></a>01117                 <span class="comment">// ----------------------------------------------</span>
<a name="l01118"></a>01118                 <span class="comment">//</span>
<a name="l01119"></a>01119                 <span class="comment">// pNym won&#39;t actually save unless it actually removes that #. If the #&#39;s already NOT THERE,</span>
<a name="l01120"></a>01120                 <span class="comment">// then the removal will fail, and thus it won&#39;t bother saving here.</span>
<a name="l01121"></a>01121 
<a name="l01122"></a>01122                 <span class="comment">// If I accept the finalReceipt or basketReceipt, that will remove its CLOSING NUM from my issued list.</span>
<a name="l01123"></a>01123                 <span class="comment">// (Its &quot;in reference to&quot; num is already closed by now.)</span>
<a name="l01124"></a>01124                 <span class="comment">//  </span>
<a name="l01125"></a>01125                 <span class="comment">// For security, ONLY add the number to theIssuedNym (to indicate it&#39;s being removed) if</span>
<a name="l01126"></a>01126                 <span class="comment">// it WAS actually already there on the Nym. Otherwise it&#39;ll get &quot;re-added&quot; when it wasn&#39;t</span>
<a name="l01127"></a>01127                 <span class="comment">// there in the first place!</span>
<a name="l01128"></a>01128                 <span class="comment">//</span>
<a name="l01129"></a>01129                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>()))
<a name="l01130"></a>01130                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::AcceptEntireInbox: final or basket receipt, trying to &#39;remove&#39; an issued &quot;</span>
<a name="l01131"></a>01131                     <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
<a name="l01132"></a>01132                     <span class="stringliteral">&quot;then? Maybe you need to download a fresh copy of it.)\n&quot;</span>, 
<a name="l01133"></a>01133                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
<a name="l01134"></a>01134 
<a name="l01135"></a>01135                 <span class="keywordflow">else</span> <span class="comment">// Success.</span>
<a name="l01136"></a>01136                 {
<a name="l01137"></a>01137                     theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
<a name="l01138"></a>01138 
<a name="l01139"></a>01139                     <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = 
<a name="l01140"></a>01140                         <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, 
<a name="l01141"></a>01141                         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ?
<a name="l01142"></a>01142                         <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a> : <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>);
<a name="l01143"></a>01143 
<a name="l01144"></a>01144                     <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l01145"></a>01145                     pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l01146"></a>01146 
<a name="l01147"></a>01147                     pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pTransaction);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149                     pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the receipt in my inbox.</span>
<a name="l01150"></a>01150                     <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l01151"></a>01151 
<a name="l01152"></a>01152                     <span class="comment">// This just makes it convenient later.</span>
<a name="l01153"></a>01153                     pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());
<a name="l01154"></a>01154                     <span class="comment">// The server will verify this actually matches, or reject the message.</span>
<a name="l01155"></a>01155 
<a name="l01156"></a>01156                     <span class="comment">// sign the item</span>
<a name="l01157"></a>01157                     pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01158"></a>01158                     pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();        
<a name="l01159"></a>01159                 }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161                 <span class="comment">// -----------------------------------------------</span>
<a name="l01162"></a>01162             } <span class="comment">// if finalReceipt or basketReceipt</span>
<a name="l01163"></a>01163 
<a name="l01164"></a>01164             <span class="comment">// ************************************************************************</span>
<a name="l01165"></a>01165 
<a name="l01166"></a>01166             <span class="comment">// PENDING (incoming transfer)</span>
<a name="l01167"></a>01167             <span class="comment">//</span>
<a name="l01168"></a>01168             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l01169"></a>01169                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l01170"></a>01170                 )
<a name="l01171"></a>01171             {               
<a name="l01172"></a>01172                 <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strRespTo, theServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01173"></a>01173                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theAngel(pOriginalItem);
<a name="l01174"></a>01174 
<a name="l01175"></a>01175                 <span class="comment">// This item was attached as the &quot;in reference to&quot; item. Perhaps Bob sent it to me.</span>
<a name="l01176"></a>01176                 <span class="comment">// Since that item was initiated by him, HIS would be the account ID on it, not mine.</span>
<a name="l01177"></a>01177                 <span class="comment">// So I DON&#39;T want to create it with my account ID on it.</span>
<a name="l01178"></a>01178                 <span class="keywordflow">if</span> (pOriginalItem)
<a name="l01179"></a>01179                 {
<a name="l01180"></a>01180                     <span class="keywordflow">if</span> ( (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>  == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
<a name="l01181"></a>01181                         (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a>    == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))  <span class="comment">// I&#39;m accepting a transfer that was sent to me. (A .PENDING .TRANSFER .REQUEST)</span>
<a name="l01182"></a>01182                     {
<a name="l01183"></a>01183                         <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>);
<a name="l01184"></a>01184                         <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l01185"></a>01185                         pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187                         <span class="comment">// Set up the &quot;accept&quot; transaction item to be sent to the server </span>
<a name="l01188"></a>01188                         <span class="comment">// (this item references and accepts another item by its transaction number--</span>
<a name="l01189"></a>01189                         <span class="comment">// But on the server side, it doesn&#39;t look for the inbox item with that number.</span>
<a name="l01190"></a>01190                         <span class="comment">// Rather, it looks for the inbox item that is &quot;in reference to&quot; that number. Notice</span>
<a name="l01191"></a>01191                         <span class="comment">// therefore, my own accept item is below ALSO set to be &quot;in reference to&quot; the number</span>
<a name="l01192"></a>01192                         <span class="comment">// of the original item.  The server uses this info to find the pending transaction.</span>
<a name="l01193"></a>01193 
<a name="l01194"></a>01194                         <a class="code" href="class_o_t_string.html">OTString</a> strNote;
<a name="l01195"></a>01195                         pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strNote);
<a name="l01196"></a>01196 
<a name="l01197"></a>01197                         <span class="keywordflow">if</span> (strNote.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01198"></a>01198                             pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l01199"></a>01199                         <span class="comment">// ----------------------------------------------</span>
<a name="l01200"></a>01200                         pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pOriginalItem);
<a name="l01201"></a>01201                         pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l01202"></a>01202                         <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l01203"></a>01203 
<a name="l01204"></a>01204                         <span class="comment">// This just makes it convenient later.</span>
<a name="l01205"></a>01205                         pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>()); <span class="comment">// The server will verify this actually matches, or reject the message.</span>
<a name="l01206"></a>01206 
<a name="l01207"></a>01207                         lAdjustment += (pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>()); <span class="comment">// Bob transferred me 50 clams. If my account was 100, it WILL be 150. Therefore, adjustment is +50. </span>
<a name="l01208"></a>01208 
<a name="l01209"></a>01209                         <span class="comment">// Nothing to remove in this case, since the transfer was initiated by someone else.</span>
<a name="l01210"></a>01210                         <span class="comment">//                      if (pNym-&gt;VerifyIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum()))</span>
<a name="l01211"></a>01211                         <span class="comment">//                          theIssuedNym.AddIssuedNum(strServerID, pTransaction-&gt;GetTransactionNum());</span>
<a name="l01212"></a>01212                         <span class="comment">// else { error }</span>
<a name="l01213"></a>01213 
<a name="l01214"></a>01214                         <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
<a name="l01215"></a>01215                         <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
<a name="l01216"></a>01216                         <span class="comment">// enough info to look it up again.</span>
<a name="l01217"></a>01217 
<a name="l01218"></a>01218                         <span class="comment">// sign the item</span>
<a name="l01219"></a>01219                         pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01220"></a>01220                         pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01221"></a>01221                     }
<a name="l01222"></a>01222                     <span class="keywordflow">else</span> 
<a name="l01223"></a>01223                     {
<a name="l01224"></a>01224                         <span class="keyword">const</span> int32_t nOriginalType = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
<a name="l01225"></a>01225                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>( <span class="stringliteral">&quot;Unrecognized item type (%d) while processing inbox.\n&quot;</span>
<a name="l01226"></a>01226                             <span class="stringliteral">&quot;(Only pending transfers, payment receipts, market receipts, &quot;</span>
<a name="l01227"></a>01227                             <span class="stringliteral">&quot;cheque receipts, and transfer receipts are operational inbox items at this time.)\n&quot;</span>,
<a name="l01228"></a>01228                             nOriginalType);
<a name="l01229"></a>01229                     }
<a name="l01230"></a>01230                 }
<a name="l01231"></a>01231                 <span class="keywordflow">else</span> 
<a name="l01232"></a>01232                 {
<a name="l01233"></a>01233                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading transaction item from string in OTClient::AcceptEntireInbox\n&quot;</span>);
<a name="l01234"></a>01234                 }
<a name="l01235"></a>01235             } <span class="comment">// else if pending</span>
<a name="l01236"></a>01236 
<a name="l01237"></a>01237             <span class="comment">// ************************************************************************</span>
<a name="l01238"></a>01238 
<a name="l01239"></a>01239             <span class="comment">// TRANSFER RECEIPT, CHEQUE RECEIPT</span>
<a name="l01240"></a>01240             <span class="comment">//</span>
<a name="l01241"></a>01241             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (
<a name="l01242"></a>01242                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a>    == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
<a name="l01243"></a>01243                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a>     == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
<a name="l01244"></a>01244                 (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>      == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l01245"></a>01245                 )
<a name="l01246"></a>01246             {               
<a name="l01247"></a>01247                 <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strRespTo, theServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l01248"></a>01248                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theAngel(pOriginalItem);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250                 <span class="comment">// This item was attached as the &quot;in reference to&quot; item. Perhaps Bob sent it to me.</span>
<a name="l01251"></a>01251                 <span class="comment">// Since that item was initiated by him, HIS would be the account ID on it, not mine.</span>
<a name="l01252"></a>01252                 <span class="comment">// So I DON&#39;T want to create it with my account ID on it.</span>
<a name="l01253"></a>01253                 <span class="keywordflow">if</span> (pOriginalItem)
<a name="l01254"></a>01254                 {
<a name="l01255"></a>01255                     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376a16fa1b0df4dbad1367dbd0f6dbac9572">OTItem::request</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01256"></a>01256                         &amp;&amp;
<a name="l01257"></a>01257                         <span class="comment">// In a real client, the user would pick and choose which items he wanted</span>
<a name="l01258"></a>01258                         <span class="comment">// to accept or reject. We, on the other hand, are blindly accepting all of</span>
<a name="l01259"></a>01259                         <span class="comment">// these types:</span>
<a name="l01260"></a>01260                         (
<a name="l01261"></a>01261                         (
<a name="l01262"></a>01262                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>          == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp; <span class="comment">// I&#39;m accepting a transfer receipt.</span>
<a name="l01263"></a>01263                         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab184c4314c99d16d439c96380a4e27cb">OTTransaction::transferReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l01264"></a>01264                         )  
<a name="l01265"></a>01265                         || 
<a name="l01266"></a>01266                         (
<a name="l01267"></a>01267                         (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>        == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;    <span class="comment">// I&#39;m accepting a notice that someone cashed my cheque or voucher.</span>
<a name="l01268"></a>01268                         ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9a92eac3a7ccff17583eb089a056f5af">OTTransaction::chequeReceipt</a>  == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) ||
<a name="l01269"></a>01269                         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a11b89ff8cbf5b3d7c526f4d166f653c8">OTTransaction::voucherReceipt</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
<a name="l01270"></a>01270                         )
<a name="l01271"></a>01271                         )
<a name="l01272"></a>01272                         )
<a name="l01273"></a>01273                     {                       
<a name="l01274"></a>01274                         <span class="comment">// If pOriginalItem is acceptPending, that means I&#39;m accepting the transfer receipt from the server,</span>
<a name="l01275"></a>01275                         <span class="comment">// which has the recipient&#39;s acceptance inside of it as the original item. This means the transfer that</span>
<a name="l01276"></a>01276                         <span class="comment">// *I* originally sent is now finally closed!</span>
<a name="l01277"></a>01277                         <span class="comment">// </span>
<a name="l01278"></a>01278                         <span class="comment">// If it&#39;s a depositCheque, that means I&#39;m accepting the cheque receipt from the server,</span>
<a name="l01279"></a>01279                         <span class="comment">// which has the recipient&#39;s deposit inside of it as the original item. This means that the cheque that</span>
<a name="l01280"></a>01280                         <span class="comment">// *I* originally wrote is now finally closed!</span>
<a name="l01281"></a>01281                         <span class="comment">//</span>
<a name="l01282"></a>01282                         <span class="comment">// In both cases, the &quot;original item&quot; itself is not from me, but from the recipient! Therefore,</span>
<a name="l01283"></a>01283                         <span class="comment">// the number on that item is useless to me (for removing numbers from my own list of issued numbers.)</span>
<a name="l01284"></a>01284                         <span class="comment">// Rather, I need to load that original cheque, or pending transfer, from WITHIN the original item,</span>
<a name="l01285"></a>01285                         <span class="comment">// in order to get THAT number, to remove it from my issued list. *sigh*</span>
<a name="l01286"></a>01286                         <span class="comment">//</span>
<a name="l01287"></a>01287                         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// We&#39;re accepting a chequeReceipt or voucherReceipt.</span>
<a name="l01288"></a>01288                         {
<a name="l01289"></a>01289                             <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l01290"></a>01290                             <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
<a name="l01291"></a>01291                             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);
<a name="l01292"></a>01292 
<a name="l01293"></a>01293                             <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l01294"></a>01294 
<a name="l01295"></a>01295                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp; 
<a name="l01296"></a>01296                                 theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
<a name="l01297"></a>01297                             {
<a name="l01298"></a>01298                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: ERROR loading cheque or voucher from string:\n%s\n&quot;</span>,
<a name="l01299"></a>01299                                     __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01300"></a>01300                             }
<a name="l01301"></a>01301                             <span class="keywordflow">else</span>
<a name="l01302"></a>01302                             {
<a name="l01303"></a>01303                                 <span class="comment">// IF it&#39;s actually there on pNym, then schedule it for removal.</span>
<a name="l01304"></a>01304                                 <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
<a name="l01305"></a>01305                                 <span class="comment">//</span>
<a name="l01306"></a>01306                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>()))
<a name="l01307"></a>01307                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: cheque or voucher receipt, trying to &#39;remove&#39; an issued &quot;</span>
<a name="l01308"></a>01308                                     <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
<a name="l01309"></a>01309                                     <span class="stringliteral">&quot;then? Maybe need to download a fresh copy of it.)\n&quot;</span>, __FUNCTION__,
<a name="l01310"></a>01310                                     theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01311"></a>01311                                 <span class="keywordflow">else</span>
<a name="l01312"></a>01312                                 {
<a name="l01313"></a>01313                                     theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01314"></a>01314 
<a name="l01315"></a>01315                                     <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>);
<a name="l01316"></a>01316                                     <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l01317"></a>01317                                     pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319                                     pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l01320"></a>01320 
<a name="l01321"></a>01321                                     <span class="comment">// In this case, this reference number is someone else&#39;s responsibility, not mine. (Someone ELSE deposited my cheque.) ...But I still reference it.</span>
<a name="l01322"></a>01322                                     pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l01323"></a>01323                                     <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l01324"></a>01324 
<a name="l01325"></a>01325                                     <span class="comment">// Server rejects the message if these don&#39;t match.</span>
<a name="l01326"></a>01326                                     pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());
<a name="l01327"></a>01327 
<a name="l01328"></a>01328                                     <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
<a name="l01329"></a>01329                                     <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
<a name="l01330"></a>01330                                     <span class="comment">// enough info to look it up again.</span>
<a name="l01331"></a>01331 
<a name="l01332"></a>01332                                     <span class="comment">// sign the item</span>
<a name="l01333"></a>01333                                     pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01334"></a>01334                                     pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01335"></a>01335                                 }
<a name="l01336"></a>01336                             }
<a name="l01337"></a>01337                         }
<a name="l01338"></a>01338                         <span class="comment">// ---------------------------------------------------------</span>
<a name="l01339"></a>01339 
<a name="l01340"></a>01340                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// We&#39;re accepting a transferReceipt.</span>
<a name="l01341"></a>01341                         {
<a name="l01342"></a>01342                             <span class="comment">// IF it&#39;s actually there on pNym, then schedule it for removal.</span>
<a name="l01343"></a>01343                             <span class="comment">// (Otherwise we&#39;d end up improperly re-adding it.)</span>
<a name="l01344"></a>01344                             <span class="comment">//</span>
<a name="l01345"></a>01345                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>()))
<a name="l01346"></a>01346                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: transfer receipt, trying to &#39;remove&#39; an issued &quot;</span>
<a name="l01347"></a>01347                                 <span class="stringliteral">&quot;number (%lld) that already wasn&#39;t on my issued list. (So what is this in my inbox, &quot;</span>
<a name="l01348"></a>01348                                 <span class="stringliteral">&quot;then? Maybe need to download a fresh copy of it.)\n&quot;</span>, 
<a name="l01349"></a>01349                                 __FUNCTION__, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
<a name="l01350"></a>01350                             <span class="keywordflow">else</span>
<a name="l01351"></a>01351                             {
<a name="l01352"></a>01352                                 theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>());
<a name="l01353"></a>01353 
<a name="l01354"></a>01354                                 <a class="code" href="class_o_t_item.html">OTItem</a> * pAcceptItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pAcceptTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>);
<a name="l01355"></a>01355                                 <span class="comment">// the transaction will handle cleaning up the transaction item.</span>
<a name="l01356"></a>01356                                 pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pAcceptItem);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358                                 pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a4ebf2e97c2c1895b80f0c5fee2f9a87f">SetNumberOfOrigin</a>(*pOriginalItem);
<a name="l01359"></a>01359 
<a name="l01360"></a>01360                                 <span class="comment">// In this case, this reference number is someone else&#39;s responsibility, not mine. (Someone ELSE deposited my cheque.) ...But I still reference it.</span>
<a name="l01361"></a>01361                                 pAcceptItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// This is critical. Server needs this to look up the original.</span>
<a name="l01362"></a>01362                                 <span class="comment">// Don&#39;t need to set transaction num on item since the constructor already got it off the owner transaction.</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364                                 pAcceptItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a7a01fdc95811465496f953c5a50dcef6">GetReceiptAmount</a>());
<a name="l01365"></a>01365 
<a name="l01366"></a>01366                                 <span class="comment">// I don&#39;t attach the original item here because I already reference it by transaction num,</span>
<a name="l01367"></a>01367                                 <span class="comment">// and because the server already has it and sent it to me. SO I just need to give the server</span>
<a name="l01368"></a>01368                                 <span class="comment">// enough info to look it up again.</span>
<a name="l01369"></a>01369 
<a name="l01370"></a>01370                                 <span class="comment">// sign the item</span>
<a name="l01371"></a>01371                                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01372"></a>01372                                 pAcceptItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01373"></a>01373                             }
<a name="l01374"></a>01374                         }
<a name="l01375"></a>01375                         <span class="keywordflow">else</span> 
<a name="l01376"></a>01376                         {
<a name="l01377"></a>01377                             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::AcceptEntireInbox: Error: wrong pOriginalItem type.\n&quot;</span>);
<a name="l01378"></a>01378                         }
<a name="l01379"></a>01379                     }
<a name="l01380"></a>01380                     <span class="keywordflow">else</span> 
<a name="l01381"></a>01381                     {
<a name="l01382"></a>01382                         <span class="keyword">const</span> int32_t nOriginalType = pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
<a name="l01383"></a>01383                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>( <span class="stringliteral">&quot;Unrecognized item type (%d) while processing inbox.\n&quot;</span>
<a name="l01384"></a>01384                             <span class="stringliteral">&quot;(Only pending transfers, payment receipts, market receipts, cheque &quot;</span>
<a name="l01385"></a>01385                             <span class="stringliteral">&quot;receipts, and transfer receipts are operational inbox items at this time.)\n&quot;</span>, 
<a name="l01386"></a>01386                             nOriginalType);
<a name="l01387"></a>01387                     }
<a name="l01388"></a>01388                 }
<a name="l01389"></a>01389                 <span class="keywordflow">else</span> 
<a name="l01390"></a>01390                 {
<a name="l01391"></a>01391                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading transaction item from string in OTClient::AcceptEntireInbox\n&quot;</span>);
<a name="l01392"></a>01392                 }               
<a name="l01393"></a>01393             } <span class="comment">// else if transfer receipt or cheque receipt. (item receipt)</span>
<a name="l01394"></a>01394 
<a name="l01395"></a>01395             <span class="comment">// ************************************************************************</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         } <span class="comment">// if pTransaction</span>
<a name="l01398"></a>01398 
<a name="l01399"></a>01399         <span class="comment">// This will have to go through the nymbox from now on, so I get explicit sign-off on each number.</span>
<a name="l01400"></a>01400         <span class="comment">//      if (pTransaction)     </span>
<a name="l01401"></a>01401         <span class="comment">//      {</span>
<a name="l01402"></a>01402         <span class="comment">//          HarvestTransactionNumbers(*pTransaction, *pNym);    </span>
<a name="l01403"></a>01403         <span class="comment">//      }</span>
<a name="l01404"></a>01404     } <span class="comment">// for --------------------------------------------</span>
<a name="l01405"></a>01405 
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <span class="comment">// If the above processing resulted in us actually accepting certain specific items,</span>
<a name="l01408"></a>01408     <span class="comment">// then let&#39;s process the message out to the server.</span>
<a name="l01409"></a>01409     <span class="comment">//</span>
<a name="l01410"></a>01410     <span class="keywordflow">if</span> (pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aab7ec90e81dc8f273b8c29617e40bab6">GetItemCount</a>())
<a name="l01411"></a>01411     {
<a name="l01412"></a>01412         <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l01413"></a>01413 <span class="comment">//      OTAssetContract * pAssetContract    = theConnection.GetWallet()-&gt;GetAssetContract(pAccount-&gt;GetAssetTypeID());</span>
<a name="l01414"></a>01414 
<a name="l01415"></a>01415         <span class="keywordflow">if</span> (pAccount &amp;&amp; (<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTClient::processInbox</a>, theMessage, 
<a name="l01416"></a>01416             *pNym, 
<a name="l01417"></a>01417             <span class="comment">//                                         *(pAssetContract),</span>
<a name="l01418"></a>01418             theServerContract,
<a name="l01419"></a>01419             <span class="comment">//                                         *(theConnection.GetServerContract()), </span>
<a name="l01420"></a>01420             pAccount) &gt; 0)) 
<a name="l01421"></a>01421         {
<a name="l01422"></a>01422             <span class="comment">// the message is all set up and ready to go out... it&#39;s even signed.</span>
<a name="l01423"></a>01423             <span class="comment">// Except the ledger we&#39;re sending, still needs to be added, and then the</span>
<a name="l01424"></a>01424             <span class="comment">// message needs to be re-signed as a result of that.</span>
<a name="l01425"></a>01425 
<a name="l01426"></a>01426             theInbox.<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>(); <span class="comment">// Since this function accepts them ALL, the new balance agreement needs to show it as empty.</span>
<a name="l01427"></a>01427 
<a name="l01428"></a>01428             <span class="comment">// -----------------------------------------</span>
<a name="l01429"></a>01429 
<a name="l01430"></a>01430             <span class="comment">// By this point, theIssuedNym contains a list of all the transaction numbers that are issued to me,</span>
<a name="l01431"></a>01431             <span class="comment">// but that will NOT be issued to me anymore once this processInbox is processed.</span>
<a name="l01432"></a>01432             <span class="comment">// Therefore I need to REMOVE those items from my issued list (at least temporarily) in order to</span>
<a name="l01433"></a>01433             <span class="comment">// calculate the balance agreement properly. So I used theIssueNym as a temp variable to store those</span>
<a name="l01434"></a>01434             <span class="comment">// numbers, so I can remove them from my Nym and them add them again after generating the statement.</span>
<a name="l01435"></a>01435             <span class="comment">//</span>
<a name="l01436"></a>01436             <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
<a name="l01437"></a>01437             {
<a name="l01438"></a>01438                 int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
<a name="l01439"></a>01439                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp);
<a name="l01440"></a>01440             }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442             <span class="comment">// -----------------------------------------</span>
<a name="l01443"></a>01443 
<a name="l01444"></a>01444             <span class="comment">// BALANCE AGREEMENT </span>
<a name="l01445"></a>01445             <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
<a name="l01446"></a>01446             <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = theInbox.<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lAdjustment, *pAcceptTransaction, *pNym, *pAccount, *pOutbox);
<a name="l01447"></a>01447 
<a name="l01448"></a>01448             <span class="comment">// -----------------------------------------</span>
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             <span class="comment">// Here I am adding these numbers back again, since I removed them to calculate the balance agreement.</span>
<a name="l01451"></a>01451             <span class="comment">// (They won&#39;t be removed for real until I receive the server&#39;s acknowledgment that those numbers</span>
<a name="l01452"></a>01452             <span class="comment">// really were removed. Until then I have to keep them and use them for my balance agreements.)</span>
<a name="l01453"></a>01453             <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(theServerID); i++)
<a name="l01454"></a>01454             {
<a name="l01455"></a>01455                 int64_t lTemp = theIssuedNym.<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(theServerID, i);
<a name="l01456"></a>01456                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a331a9c5ec8692d0b88a76d882586fbc1">AddIssuedNum</a>(strServerID, lTemp);
<a name="l01457"></a>01457             }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459             <span class="comment">// -----------------------------------------</span>
<a name="l01460"></a>01460 
<a name="l01461"></a>01461             <span class="keywordflow">if</span> (NULL != pBalanceItem)
<a name="l01462"></a>01462                 pAcceptTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l01463"></a>01463             <span class="keywordflow">else</span>
<a name="l01464"></a>01464                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Should never happen.\n&quot;</span>);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466             <span class="comment">// ------------------------------------------------------------</span>
<a name="l01467"></a>01467 
<a name="l01468"></a>01468             <span class="comment">// Sign the accept transaction, as well as the message ledger </span>
<a name="l01469"></a>01469             <span class="comment">// that we&#39;ve just constructed containing it.</span>
<a name="l01470"></a>01470             pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l01471"></a>01471             pAcceptTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01472"></a>01472 
<a name="l01473"></a>01473             processLedger.SignContract(*pNym);
<a name="l01474"></a>01474             processLedger.SaveContract();
<a name="l01475"></a>01475 
<a name="l01476"></a>01476             <span class="comment">// Extract the ledger into string form and add it as the payload on the message.</span>
<a name="l01477"></a>01477             <a class="code" href="class_o_t_string.html">OTString</a> strLedger(processLedger);
<a name="l01478"></a>01478             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l01479"></a>01479 
<a name="l01480"></a>01480             <span class="comment">// Release any other signatures from the message, since I know it</span>
<a name="l01481"></a>01481             <span class="comment">// was signed already in the above call to ProcessUserCommand.</span>
<a name="l01482"></a>01482             theMessage.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01483"></a>01483 
<a name="l01484"></a>01484             <span class="comment">// Sign it and send it out.</span>
<a name="l01485"></a>01485             <span class="comment">//          theConnection.SignAndSend(theMessage);</span>
<a name="l01486"></a>01486             <span class="comment">// I could have called SignContract() and then theConnection.ProcessMessageOut(message) </span>
<a name="l01487"></a>01487             <span class="comment">// but I used the above function instead.</span>
<a name="l01488"></a>01488 
<a name="l01489"></a>01489             bSuccess = <span class="keyword">true</span>; <span class="comment">// Otherwise we haven&#39;t really burned the transaction num, and need to put it back (below).</span>
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491         <span class="keywordflow">else</span>
<a name="l01492"></a>01492             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error processing processInbox command in OTClient::AcceptEntireInbox\n&quot;</span>);
<a name="l01493"></a>01493     }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l01496"></a>01496     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccess)
<a name="l01497"></a>01497         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="keywordflow">return</span> bSuccess;
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 
<a name="l01503"></a>01503 
<a name="l01504"></a>01504 
<a name="l01505"></a>01505 
<a name="l01506"></a>01506 
<a name="l01507"></a>01507 <span class="comment">// I&#39;m doing this so I can declare a local function, INSIDE this function :-)</span>
<a name="l01508"></a>01508 <span class="comment">// (To avoid duplicating code.)  Watch and learn...</span>
<a name="l01509"></a>01509 <span class="comment">//</span>
<a name="l01510"></a><a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">01510</a> <span class="keywordtype">void</span> <a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">load_str_trans_add_to_ledger</a>( <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; the_nym_id,
<a name="l01511"></a>01511                                   <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; str_trans,
<a name="l01512"></a>01512                                   <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> str_box_type,
<a name="l01513"></a>01513                                   <span class="keyword">const</span> int64_t &amp; lTransNum,
<a name="l01514"></a>01514                                   <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; the_nym,
<a name="l01515"></a>01515                                   <a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; ledger )
<a name="l01516"></a>01516 {
<a name="l01517"></a>01517     <span class="keywordflow">if</span> (NULL == ledger.<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(lTransNum)) <span class="comment">// (Only add it if it&#39;s not already there.)</span>
<a name="l01518"></a>01518     {
<a name="l01519"></a>01519         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(str_trans);
<a name="l01520"></a>01520 
<a name="l01521"></a>01521         <span class="keywordflow">if</span> (NULL == pTransType)
<a name="l01522"></a>01522             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error instantiating transaction &quot;</span>
<a name="l01523"></a>01523             <span class="stringliteral">&quot;type based on str_trans:\n%s\n&quot;</span>, __FUNCTION__, str_trans.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01524"></a>01524         <span class="keywordflow">else</span>
<a name="l01525"></a>01525         {
<a name="l01526"></a>01526             <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01527"></a>01527             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pCopy = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);
<a name="l01528"></a>01528 
<a name="l01529"></a>01529             <span class="keywordflow">if</span> (NULL == pCopy) <span class="comment">// it&#39;s a transaction type but not a transaction.</span>
<a name="l01530"></a>01530             {
<a name="l01531"></a>01531                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(the_nym_id), strAcctID(the_nym_id);
<a name="l01532"></a>01532                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: it&#39;s a transaction type but not a transaction: (for %s):\n\n%s\n\n&quot;</span>,
<a name="l01533"></a>01533                     __FUNCTION__, str_box_type.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_trans.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01534"></a>01534                 <span class="keyword">delete</span> pTransType; pTransType = NULL;
<a name="l01535"></a>01535             }
<a name="l01536"></a>01536             <span class="keywordflow">else</span> <span class="comment">// The copy transaction is now loaded from the string. Add it to the ledger...</span>
<a name="l01537"></a>01537             {
<a name="l01538"></a>01538                 <span class="keywordflow">if</span> (!ledger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pCopy))  <span class="comment">// if unable to add that transaction, once loaded, signed, and saved, to the paymentInbox or recordBox ledger...</span>
<a name="l01539"></a>01539                 {
<a name="l01540"></a>01540                     <a class="code" href="class_o_t_string.html">OTString</a> strUserID(the_nym_id), strAcctID(the_nym_id);
<a name="l01541"></a>01541                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to add the transaction to the %s &quot;</span>
<a name="l01542"></a>01542                         <span class="stringliteral">&quot;with user/acct IDs: %s / %s, and loading from string:\n\n%s\n\n&quot;</span>,
<a name="l01543"></a>01543                         __FUNCTION__, str_box_type.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_trans.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01544"></a>01544                     <span class="keyword">delete</span> pCopy; pCopy = NULL;
<a name="l01545"></a>01545                 }
<a name="l01546"></a>01546                 <span class="keywordflow">else</span> <span class="comment">// We were able to add it, so now let&#39;s save the paymentInbox (or recordBox.)</span>
<a name="l01547"></a>01547                 {
<a name="l01548"></a>01548                     ledger.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01549"></a>01549                     ledger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(the_nym);
<a name="l01550"></a>01550                     ledger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01551"></a>01551 
<a name="l01552"></a>01552                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a> == ledger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>())
<a name="l01553"></a>01553                         ledger.<a class="code" href="class_o_t_ledger.html#ab6f6af26a690d49f61ec7ffcc557a302">SavePaymentInbox</a>();
<a name="l01554"></a>01554                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a> == ledger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>())
<a name="l01555"></a>01555                         ledger.<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>();
<a name="l01556"></a>01556                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a> == ledger.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>())
<a name="l01557"></a>01557                         ledger.<a class="code" href="class_o_t_ledger.html#ace1cb1337e94d794243bbe163eb88813">SaveExpiredBox</a>();
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                     <span class="keywordflow">if</span> (!pCopy-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(ledger)) <span class="comment">// &lt;===================</span>
<a name="l01560"></a>01560                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %s Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
<a name="l01561"></a>01561                         __FUNCTION__, str_box_type.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_trans.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01562"></a>01562                 }
<a name="l01563"></a>01563             }
<a name="l01564"></a>01564         } <span class="comment">// else (pCopy not null.)</span>
<a name="l01565"></a>01565     } <span class="comment">// if this transaction wasn&#39;t already in the paymentInbox / recordBox (whichever was passed in)...</span>
<a name="l01566"></a>01566     <span class="comment">// --------------------------------------------------------------</span>
<a name="l01567"></a>01567     <span class="comment">// else it WAS already there, so do nothing. (No need to add it twice.)</span>
<a name="l01568"></a>01568     <span class="comment">// --------------------------------------------------------------</span>
<a name="l01569"></a>01569 } <span class="comment">// void load_str_trans_add_to_ledger</span>
<a name="l01570"></a>01570 <span class="comment">// --------------------------------------------------------------</span>
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 
<a name="l01574"></a>01574 
<a name="l01596"></a><a class="code" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">01596</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">OTClient::ProcessIncomingTransactions</a>(<a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection, <a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theReply)
<a name="l01597"></a>01597 {
<a name="l01598"></a>01598     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l01599"></a>01599     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
<a name="l01600"></a>01600     theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
<a name="l01601"></a>01601     <span class="comment">// --------------------------------------</span>
<a name="l01602"></a>01602     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
<a name="l01603"></a>01603     <span class="comment">// --------------------------------------</span>
<a name="l01604"></a>01604     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
<a name="l01605"></a>01605     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
<a name="l01606"></a>01606     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l01607"></a>01607     <span class="comment">// --------------------------------------</span>
<a name="l01608"></a>01608     <a class="code" href="class_o_t_string.html">OTString</a>    strServerID(SERVER_ID), 
<a name="l01609"></a>01609         strReceiptID(<span class="stringliteral">&quot;ID_NOT_SET_YET&quot;</span>); <span class="comment">// This will be user ID or acct ID depending on whether trans statement or balance statement.</span>
<a name="l01610"></a>01610     <span class="comment">// --------------------------------------</span>
<a name="l01611"></a>01611     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>()); <span class="comment">// todo fix cast.</span>
<a name="l01612"></a>01612     <span class="comment">// --------------------------------------</span>
<a name="l01613"></a>01613     <span class="comment">// The only incoming transactions that we actually care about are responses to cash</span>
<a name="l01614"></a>01614     <span class="comment">// WITHDRAWALS.  (Cause we want to get that money off of the response, not lose it.)</span>
<a name="l01615"></a>01615     <span class="comment">// So let&#39;s just check to see if it&#39;s a withdrawal...</span>
<a name="l01616"></a>01616     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID); 
<a name="l01617"></a>01617     <a class="code" href="class_o_t_string.html">OTString</a> strLedger(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619     <span class="comment">// The ledger we received from the server was generated there, so we don&#39;t</span>
<a name="l01620"></a>01620     <span class="comment">// have to call GenerateLedger. We just load it.</span>
<a name="l01621"></a>01621     <span class="keywordtype">bool</span> bSuccess = theLedger.<a class="code" href="class_o_t_ledger.html#a472314e803ddaad58d3063c78ef0c22b">LoadLedgerFromString</a>(strLedger); <span class="comment">// This is a MESSAGE ledger. </span>
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="keywordflow">if</span> (bSuccess)
<a name="l01624"></a>01624         bSuccess = theLedger.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>((<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp;)*pServerNym);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626     <span class="keywordflow">if</span> (!bSuccess)
<a name="l01627"></a>01627     {
<a name="l01628"></a>01628         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ERROR loading ledger from message payload in OTClient::ProcessIncomingTransactions.\n&quot;</span>);
<a name="l01629"></a>01629         <span class="keywordflow">return</span>;
<a name="l01630"></a>01630     }
<a name="l01631"></a>01631 
<a name="l01632"></a>01632     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Loaded ledger out of message payload.\n&quot;</span>);
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     <span class="comment">// Loop through ledger transactions,        </span>
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theLedger.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l01637"></a>01637     {   
<a name="l01638"></a>01638         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
<a name="l01639"></a>01639         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pTransaction, <span class="stringliteral">&quot;NULL transaction pointer in OTServer::UserCmdNotarizeTransactions\n&quot;</span>);
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <span class="comment">// ---------------------------------------------------------------</span>
<a name="l01642"></a>01642         <span class="comment">// See note above function. In this loop, it&#39;s possible that we&#39;ve already processed these </span>
<a name="l01643"></a>01643         <span class="comment">// transactions. Therefore we ignore the ones that are already released from our issued list.</span>
<a name="l01644"></a>01644         <span class="comment">//</span>
<a name="l01645"></a>01645         <span class="keywordflow">if</span> ( <span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()) )
<a name="l01646"></a>01646         {
<a name="l01647"></a>01647             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTClient::ProcessIncomingTransactions: Skipping processing of server reply to transaction number %lld &quot;</span>
<a name="l01648"></a>01648                 <span class="stringliteral">&quot;since the number isn&#39;t even issued to me. Usually this means that I ALREADY processed it, and we are now &quot;</span>
<a name="l01649"></a>01649                 <span class="stringliteral">&quot;processing the nymbox notice for the same transaction.\n&quot;</span>, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l01650"></a>01650             <span class="keywordflow">continue</span>;   <span class="comment">// If this trans# isn&#39;t even signed out to me anymore, then skip it. It&#39;s already closed.</span>
<a name="l01651"></a>01651         }
<a name="l01652"></a>01652         <span class="comment">// ---------------------------------------------------------------</span>
<a name="l01653"></a>01653 
<a name="l01654"></a>01654         <span class="comment">// Each transaction in the ledger is a server reply to our original transaction request.</span>
<a name="l01655"></a>01655         <span class="comment">// </span>
<a name="l01656"></a>01656         <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">VerifyAccount</a>(*pServerNym)) <span class="comment">// if not null &amp;&amp; valid transaction reply from server</span>
<a name="l01657"></a>01657         {           
<a name="l01658"></a>01658             <span class="comment">// We had to burn a transaction number to run the transaction that the server has now replied to,</span>
<a name="l01659"></a>01659             <span class="comment">// so let&#39;s remove that number from our list of responsibility. Whether it was successful or not,</span>
<a name="l01660"></a>01660             <span class="comment">// the server has removed it from our list of responsibility, so we need to remove it on our side as well.</span>
<a name="l01661"></a>01661             <span class="comment">// so that we can properly calculate our balance agreements in the future.</span>
<a name="l01662"></a>01662             <span class="comment">//</span>
<a name="l01663"></a>01663             <span class="comment">// NOTE: not for all types! See the switch statements:</span>
<a name="l01664"></a>01664 
<a name="l01665"></a>01665             <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;
<a name="l01666"></a>01666 
<a name="l01667"></a>01667             <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l01668"></a>01668             {
<a name="l01669"></a>01669                 <span class="comment">// ----------------------------------------</span>
<a name="l01670"></a>01670             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>:
<a name="l01671"></a>01671                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a>;
<a name="l01672"></a>01672                 <span class="keywordflow">break</span>;
<a name="l01673"></a>01673             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>:
<a name="l01674"></a>01674                 {
<a name="l01675"></a>01675                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItemCash    = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>);
<a name="l01676"></a>01676                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItemVoucher = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>);
<a name="l01677"></a>01677 
<a name="l01678"></a>01678                     <span class="keywordflow">if</span> (NULL != pItemCash)
<a name="l01679"></a>01679                         theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>;
<a name="l01680"></a>01680                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pItemVoucher)
<a name="l01681"></a>01681                         theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>;
<a name="l01682"></a>01682                 }
<a name="l01683"></a>01683                 <span class="keywordflow">break</span>;
<a name="l01684"></a>01684             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>:
<a name="l01685"></a>01685                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a>;
<a name="l01686"></a>01686                 <span class="keywordflow">break</span>;
<a name="l01687"></a>01687             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>:
<a name="l01688"></a>01688                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac310111eca8eb295fb5dafddd884fc82">OTItem::atTransfer</a>;
<a name="l01689"></a>01689                 <span class="keywordflow">break</span>;
<a name="l01690"></a>01690             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>:
<a name="l01691"></a>01691                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a229f0c7ace7a51840d7632910a0b92a6">OTItem::atMarketOffer</a>;
<a name="l01692"></a>01692                 <span class="keywordflow">break</span>;
<a name="l01693"></a>01693             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>:
<a name="l01694"></a>01694                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afbc3c7556a790e7a7b6be464f8ea058b">OTItem::atPaymentPlan</a>;
<a name="l01695"></a>01695                 <span class="keywordflow">break</span>;
<a name="l01696"></a>01696             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>:
<a name="l01697"></a>01697                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1fe91e4cadee24de6acb9de56a55e4eb">OTItem::atSmartContract</a>;
<a name="l01698"></a>01698                 <span class="keywordflow">break</span>;
<a name="l01699"></a>01699             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>:
<a name="l01700"></a>01700                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ab3ded9d37de3a75d4b39735bb9aff341">OTItem::atCancelCronItem</a>;
<a name="l01701"></a>01701                 <span class="keywordflow">break</span>;
<a name="l01702"></a>01702             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>:
<a name="l01703"></a>01703                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0b62f8efea6ed9bdefbc48ce2e97a8b6">OTItem::atExchangeBasket</a>;
<a name="l01704"></a>01704                 <span class="keywordflow">break</span>;
<a name="l01705"></a>01705             <span class="keywordflow">default</span>:
<a name="l01706"></a>01706             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>: <span class="comment">// not handled here...</span>
<a name="l01707"></a>01707                 <span class="keywordflow">continue</span>;
<a name="l01708"></a>01708             }
<a name="l01709"></a>01709 
<a name="l01710"></a>01710             <span class="comment">// ----------------------------------------</span>
<a name="l01711"></a>01711 
<a name="l01712"></a>01712             <span class="keywordflow">switch</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) 
<a name="l01713"></a>01713             {
<a name="l01714"></a>01714             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a759808a47e79ca6edde03d3dd03318f3">OTTransaction::atDeposit</a>:
<a name="l01715"></a>01715                 <a class="code" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">ProcessDepositResponse</a>(*pTransaction, theConnection, theReply);
<a name="l01716"></a>01716                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
<a name="l01717"></a>01717                 <span class="keywordflow">break</span>;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719                 <span class="comment">// ********************************************************************</span>
<a name="l01720"></a>01720 
<a name="l01721"></a>01721             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8abd4fe0db87268c965e14719347c91594">OTTransaction::atPayDividend</a>:
<a name="l01722"></a>01722                 <a class="code" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">ProcessPayDividendResponse</a>(*pTransaction, theConnection, theReply);
<a name="l01723"></a>01723                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
<a name="l01724"></a>01724                 <span class="keywordflow">break</span>;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726                 <span class="comment">// ********************************************************************</span>
<a name="l01727"></a>01727 
<a name="l01728"></a>01728             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a32b11ab3a1c1c2bb2f72ea79df070e61">OTTransaction::atExchangeBasket</a>:
<a name="l01729"></a>01729                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
<a name="l01730"></a>01730                 <span class="comment">// If the exchangeBasket FAILS, then I put all the transaction numbers BACK on the Nym,</span>
<a name="l01731"></a>01731                 <span class="comment">// that had been taken for the exchange (for all the basketReceipts.)</span>
<a name="l01732"></a>01732                 <span class="comment">// ---------------------------------------</span>
<a name="l01733"></a>01733                 {
<a name="l01734"></a>01734                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736                     <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
<a name="l01737"></a>01737                         <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION</span>
<a name="l01738"></a>01738                     {
<a name="l01739"></a>01739                         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
<a name="l01740"></a>01740                         pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);
<a name="l01741"></a>01741 
<a name="l01742"></a>01742                         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType = 
<a name="l01743"></a>01743                             strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745                         <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
<a name="l01746"></a>01746                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748                         <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l01749"></a>01749                         {
<a name="l01750"></a>01750                             <a class="code" href="class_o_t_string.html">OTString</a> strBasket;
<a name="l01751"></a>01751                             <a class="code" href="class_o_t_basket.html">OTBasket</a> theRequestBasket;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753                             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strBasket);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755                             <span class="keywordflow">if</span> (strBasket.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theRequestBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strBasket))
<a name="l01756"></a>01756                                 theRequestBasket.<a class="code" href="class_o_t_basket.html#a4fa7db8a28ae3adb021cd343b69fe2ff">HarvestClosingNumbers</a>(*pNym, SERVER_ID, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l01757"></a>01757                             <span class="keywordflow">else</span>
<a name="l01758"></a>01758                                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atExchangeBasket) Error loading original basket request in OTClient::ProcessIncomingTransactions\n&quot;</span>);
<a name="l01759"></a>01759                         } <span class="comment">// if success loading original item.</span>
<a name="l01760"></a>01760                         <span class="keywordflow">else</span>
<a name="l01761"></a>01761                         {
<a name="l01762"></a>01762                             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atExchangeBasket) Error loading original item from string in OTClient::ProcessIncomingTransactions\n&quot;</span>);
<a name="l01763"></a>01763                         }                        
<a name="l01764"></a>01764                     } <span class="comment">// if exchangeBasket was a failure</span>
<a name="l01765"></a>01765                 }
<a name="l01766"></a>01766                 <span class="keywordflow">break</span>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768                 <span class="comment">// ********************************************************************</span>
<a name="l01769"></a>01769 
<a name="l01770"></a>01770             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aeab27a75cf6eca60caae2cfc836af49d">OTTransaction::atCancelCronItem</a>:
<a name="l01771"></a>01771                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true  </span>
<a name="l01772"></a>01772                 <span class="comment">// Just above, we remove the issued number that was used to initiate the cancelCronItem. (Regardless of success.)</span>
<a name="l01773"></a>01773                 <span class="comment">// Below, we remove the issued number that was ON that Cron Item (IF SUCCESS.)</span>
<a name="l01774"></a>01774                 <span class="comment">// ---------------------------------------</span>
<a name="l01775"></a>01775                 {
<a name="l01776"></a>01776                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);
<a name="l01777"></a>01777 
<a name="l01778"></a>01778                     <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
<a name="l01779"></a>01779                         <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01780"></a>01780                     {   <span class="comment">// If it was a success cancelling the cron item, then the final receipt has been created, and</span>
<a name="l01781"></a>01781                         <span class="comment">// the transaction number is closed out, and only the closing number is left. If that is the case</span>
<a name="l01782"></a>01782                         <span class="comment">// then I can remove the transaction number from my issued list, presumably the server already has.</span>
<a name="l01783"></a>01783                         <span class="comment">// </span>
<a name="l01784"></a>01784                         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
<a name="l01785"></a>01785                         pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);
<a name="l01786"></a>01786 
<a name="l01787"></a>01787                         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType = 
<a name="l01788"></a>01788                             strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;
<a name="l01789"></a>01789 
<a name="l01790"></a>01790                         <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
<a name="l01791"></a>01791                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);
<a name="l01792"></a>01792 
<a name="l01793"></a>01793                         <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l01794"></a>01794                         {
<a name="l01795"></a>01795                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l01796"></a>01796                             {
<a name="l01797"></a>01797                                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;(atCancelCronItem) Error removing issued number from user nym in OTClient::ProcessIncomingTransactions\n&quot;</span>);
<a name="l01798"></a>01798                             }
<a name="l01799"></a>01799                             <span class="comment">// I don&#39;t have to call RemoveTransactionNum for the closing number (though the server does.) Why not?</span>
<a name="l01800"></a>01800                             <span class="comment">// Because I already called GetNextTransactionNum() to use it in the first place, so it&#39;s already off my</span>
<a name="l01801"></a>01801                             <span class="comment">// list of usable transaction numbers here on the client side.</span>
<a name="l01802"></a>01802                         }
<a name="l01803"></a>01803                         <span class="keywordflow">else</span>
<a name="l01804"></a>01804                         {
<a name="l01805"></a>01805                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: (atCancelCronItem) Error loading original item from string.\n&quot;</span>,
<a name="l01806"></a>01806                                 __FUNCTION__);
<a name="l01807"></a>01807                         }                        
<a name="l01808"></a>01808                     }
<a name="l01809"></a>01809                 }
<a name="l01810"></a>01810                 <span class="keywordflow">break</span>;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                 <span class="comment">// ********************************************************************</span>
<a name="l01813"></a>01813 
<a name="l01814"></a>01814             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97e769c64e9e1ea2d8e7730e7d758949">OTTransaction::atWithdrawal</a>:
<a name="l01815"></a>01815                 <a class="code" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">ProcessWithdrawalResponse</a>(*pTransaction, theConnection, theReply);
<a name="l01816"></a>01816                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
<a name="l01817"></a>01817                 <span class="keywordflow">break</span>;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819                 <span class="comment">// ********************************************************************</span>
<a name="l01820"></a>01820 
<a name="l01821"></a>01821             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ad6f91d122a4d04bbcd5f5ff703b17585">OTTransaction::atTransfer</a>:
<a name="l01822"></a>01822                 <span class="comment">// Nothing removed here since the transaction number is still in play, in this cases.</span>
<a name="l01823"></a>01823                 <span class="comment">// ACTUALLY, if this is a failure, we need to REMOVE from issued list. (It&#39;s burned.)</span>
<a name="l01824"></a>01824                 <span class="comment">// But if success, the number stays in play until a later time. (So we leave it issued.)</span>
<a name="l01825"></a>01825                 {
<a name="l01826"></a>01826                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828                     <span class="keywordflow">if</span> ((NULL != pItem) &amp;&amp;
<a name="l01829"></a>01829                         <a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01830"></a>01830                     {
<a name="l01831"></a>01831                         <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
<a name="l01832"></a>01832                         <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
<a name="l01833"></a>01833                         <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
<a name="l01834"></a>01834                         <span class="comment">//</span>
<a name="l01835"></a>01835                         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l01836"></a>01836                         {
<a name="l01837"></a>01837                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a transfer.)\n&quot;</span>,
<a name="l01838"></a>01838                                 __FUNCTION__);
<a name="l01839"></a>01839                         }
<a name="l01840"></a>01840                     }
<a name="l01841"></a>01841                 }
<a name="l01842"></a>01842                 <span class="keywordflow">break</span>;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844                 <span class="comment">// ********************************************************************</span>
<a name="l01845"></a>01845 
<a name="l01846"></a>01846             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8aefb8fac2c5b63cd7cc87e4e620be5a74">OTTransaction::atMarketOffer</a>:
<a name="l01847"></a>01847             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>:
<a name="l01848"></a>01848             <span class="keywordflow">case</span> <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a>:
<a name="l01849"></a>01849 
<a name="l01850"></a>01850                 <span class="comment">// Nothing removed here since the transaction number is still in play, in these cases.</span>
<a name="l01851"></a>01851                 <span class="comment">// ACTUALLY, if these are a failure, we need to REMOVE from issued list.</span>
<a name="l01852"></a>01852                 <span class="comment">// But if success, the number stays in play until a later time.</span>
<a name="l01853"></a>01853                 {
<a name="l01854"></a>01854                     <span class="comment">// ----------------------------------------------------</span>
<a name="l01855"></a>01855                     <span class="keyword">const</span> int64_t    lNymOpeningNumber = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l01856"></a>01856                     <a class="code" href="class_o_t_item.html">OTItem</a>      * pReplyItem        = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(theItemType);
<a name="l01857"></a>01857                     <span class="comment">// ----------------------------------------------------</span>
<a name="l01858"></a>01858                     <span class="keywordflow">if</span> (NULL != pReplyItem) 
<a name="l01859"></a>01859                     {
<a name="l01860"></a>01860                         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
<a name="l01861"></a>01861                         pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);
<a name="l01862"></a>01862 
<a name="l01863"></a>01863                         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTempTransType =
<a name="l01864"></a>01864                             strOriginalItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalItem) : NULL;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866                         <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = (NULL == pTempTransType) ? NULL : dynamic_cast&lt;OTItem*&gt;(pTempTransType);
<a name="l01867"></a>01867                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theItemAngel(pOriginalItem);
<a name="l01868"></a>01868 
<a name="l01869"></a>01869                         <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l01870"></a>01870                         {
<a name="l01871"></a>01871                             <a class="code" href="class_o_t_string.html">OTString</a> strCronItem;
<a name="l01872"></a>01872                             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCronItem);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874                             <span class="comment">// What kind of cron item is it?</span>
<a name="l01875"></a>01875                             <span class="comment">// Well (todo) we should probably double-check, but the only cron items we</span>
<a name="l01876"></a>01876                             <span class="comment">// send notices for are payment plans and smart contracts. Market offers don&#39;t</span>
<a name="l01877"></a>01877                             <span class="comment">// need notices, since anyone activating a market offer is already getting the</span>
<a name="l01878"></a>01878                             <span class="comment">// reply. (AND getting a copy of that reply, already, inside a replyNotice in</span>
<a name="l01879"></a>01879                             <span class="comment">// his Nymbox...) So he can&#39;t possibly miss the server&#39;s reply, and there aren&#39;t</span>
<a name="l01880"></a>01880                             <span class="comment">// any other parties to notify (re: successful activation), besides the Nym himself.</span>
<a name="l01881"></a>01881                             <span class="comment">//</span>
<a name="l01882"></a>01882                             <span class="comment">// Only payment plans and smart contracts could potentially have some other signer, who</span>
<a name="l01883"></a>01883                             <span class="comment">// would want to get notified, and to whom the notice is send.</span>
<a name="l01884"></a>01884                             <span class="comment">//</span>
<a name="l01885"></a>01885                             <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = (strCronItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strCronItem) : NULL);
<a name="l01886"></a>01886                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel(pCronItem);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888                             <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// the original smart contract or payment plan object.</span>
<a name="l01889"></a>01889                             {
<a name="l01890"></a>01890                                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION (This is where we remove the opening number, and harvest the closing numbers.)</span>
<a name="l01891"></a>01891                                 {
<a name="l01892"></a>01892                                     <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
<a name="l01893"></a>01893                                     <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
<a name="l01894"></a>01894                                     <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
<a name="l01895"></a>01895                                     <span class="comment">//</span>
<a name="l01896"></a>01896                                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID,
<a name="l01897"></a>01897                                         lNymOpeningNumber,
<a name="l01898"></a>01898                                         <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l01899"></a>01899                                     {
<a name="l01900"></a>01900                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a cron item.)\n&quot;</span>,
<a name="l01901"></a>01901                                             __FUNCTION__);
<a name="l01902"></a>01902                                     }
<a name="l01903"></a>01903                                     <span class="comment">// ---------------------------------------</span>
<a name="l01904"></a>01904                                     <span class="comment">// If the activation was a failure, we can add all the extra transaction numbers BACK to the</span>
<a name="l01905"></a>01905                                     <span class="comment">// Nym, that were being used as CLOSING numbers, and use them later. (They aren&#39;t burned.)</span>
<a name="l01906"></a>01906                                     <span class="comment">// They&#39;re still all signed-out, so we should harvest them so we can still use them on something.</span>
<a name="l01907"></a>01907                                     <span class="comment">// (Whereas if it had been a success, then we would have left them in their existing state, since</span>
<a name="l01908"></a>01908                                     <span class="comment">// the transaction would then be in play, and the numbers could not be used again, nor removed as</span>
<a name="l01909"></a>01909                                     <span class="comment">// issued numbers until the transaction itself had finished and its receipts had been signed-off.)</span>
<a name="l01910"></a>01910                                     <span class="comment">//</span>
<a name="l01911"></a>01911                                     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// saves.</span>
<a name="l01912"></a>01912                                 }
<a name="l01913"></a>01913                                 <span class="comment">// ------------------------------------------------------</span>
<a name="l01914"></a>01914                                 <span class="comment">// When party receives notice that smart contract has been activated,</span>
<a name="l01915"></a>01915                                 <span class="comment">// remove the instrument from outpayments box. (If it&#39;s there -- it can be.)</span>
<a name="l01916"></a>01916                                 <span class="comment">//</span>
<a name="l01917"></a>01917                                 <span class="comment">// (This happens for acknowledged AND rejected smart contracts.)</span>
<a name="l01918"></a>01918                                 <span class="comment">//</span>
<a name="l01919"></a>01919 
<a name="l01920"></a>01920                                 <a class="code" href="class_o_t_string.html">OTString</a> strInstrument; <span class="comment">// If the instrument is in the outpayments box, we put a copy of it here.</span>
<a name="l01921"></a>01921 
<a name="l01922"></a>01922                                 <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afdc94f6f285b3e410ed6283cfc3184cc">OTTransaction::atPaymentPlan</a>   == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || <span class="comment">// No need to do this for market offers. (Because they don&#39;t</span>
<a name="l01923"></a>01923                                     (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a97fbe1a7d3cbf4a1c2476fd0374b1363">OTTransaction::atSmartContract</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))   <span class="comment">// go into the outpayments box in the first place.)</span>
<a name="l01924"></a>01924                                 {
<a name="l01925"></a>01925                                     <span class="comment">// --------------------------------------------</span>
<a name="l01926"></a>01926                                     <span class="comment">// If success, save a copy in my &quot;active cron items&quot; folder.</span>
<a name="l01927"></a>01927                                     <span class="comment">//</span>
<a name="l01928"></a>01928                                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l01929"></a>01929                                     {
<a name="l01930"></a>01930                                         pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a215530a92d43d8260dfe8f42327cb3de">SaveActiveCronReceipt</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
<a name="l01931"></a>01931                                     }
<a name="l01932"></a>01932                                     <span class="comment">// --------------------------------------------</span>
<a name="l01933"></a>01933                                     <a class="code" href="class_o_t_num_list.html">OTNumList</a>   numlistOutpayment(lNymOpeningNumber);
<a name="l01934"></a>01934                                     <span class="keyword">const</span> int32_t   nOutpaymentIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(lNymOpeningNumber);
<a name="l01935"></a>01935                                     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg             = NULL;
<a name="l01936"></a>01936                                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMessageAngel;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938                                     <span class="keywordflow">if</span> (nOutpaymentIndex &gt;= 0)
<a name="l01939"></a>01939                                     {
<a name="l01940"></a>01940                                         pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acb808e89943f1f2d0009825a3fbcb34f">GetOutpaymentsByIndex</a>(nOutpaymentIndex);
<a name="l01941"></a>01941 
<a name="l01942"></a>01942                                         <span class="keywordflow">if</span> (NULL == pMsg)
<a name="l01943"></a>01943                                         {
<a name="l01944"></a>01944                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment message in outpayment box based on index %d.\n&quot;</span>,
<a name="l01945"></a>01945                                                 __FUNCTION__, nOutpaymentIndex);
<a name="l01946"></a>01946                                         }
<a name="l01947"></a>01947                                         <span class="keywordflow">else</span>
<a name="l01948"></a>01948                                         {
<a name="l01949"></a>01949                                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemovedOutpayment = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(nOutpaymentIndex, <span class="keyword">false</span>); <span class="comment">//bDeleteIt=false (deleted later on.)</span>
<a name="l01950"></a>01950                                             theMessageAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pMsg); <span class="comment">// Since we chose to keep pMsg alive and undeleted, after removing it from the outpayments box, we set the angel here to make sure it gets cleaned up later, whenever we return out of this godforsaken function.</span>
<a name="l01951"></a>01951                                             <span class="comment">// --------------------------------------------------</span>
<a name="l01952"></a>01952                                             <span class="keywordflow">if</span> (bRemovedOutpayment)
<a name="l01953"></a>01953                                                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l01954"></a>01954                                             <span class="keywordflow">else</span>
<a name="l01955"></a>01955                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove outpayment at index: %d\n&quot;</span>, __FUNCTION__, nOutpaymentIndex);
<a name="l01956"></a>01956                                             <span class="comment">// --------------------------------------------------</span>
<a name="l01957"></a>01957                                             <span class="keywordflow">if</span> (!pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strInstrument))
<a name="l01958"></a>01958                                             {
<a name="l01959"></a>01959                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment instrument in outpayment message at index %d.\n&quot;</span>,
<a name="l01960"></a>01960                                                     __FUNCTION__, nOutpaymentIndex);
<a name="l01961"></a>01961                                             }
<a name="l01962"></a>01962                                             <span class="comment">// --------------------------------------------------</span>
<a name="l01963"></a>01963                                             <span class="keywordflow">else</span>
<a name="l01964"></a>01964                                             {                                                
<a name="l01965"></a>01965                                                 <span class="comment">// At this point, we&#39;ve removed the outpayment already, and it will be deleted</span>
<a name="l01966"></a>01966                                                 <span class="comment">// when it goes out of scope already. And we&#39;ve got a copy of the original financial</span>
<a name="l01967"></a>01967                                                 <span class="comment">// instrument that was SENT in that outpayment.</span>
<a name="l01968"></a>01968                                                 <span class="comment">//</span>
<a name="l01969"></a>01969                                                 <span class="comment">// But what for? Why did I want that instrument here in a string, in strInstrument?</span>
<a name="l01970"></a>01970                                                 <span class="comment">// Do I still need to do something with it? Yes: I need to drop a copy of it into</span>
<a name="l01971"></a>01971                                                 <span class="comment">// the record box!</span>
<a name="l01972"></a>01972 
<a name="l01973"></a>01973                                                 <span class="comment">// NOTE: strInstrument is added to the RecordBox below. So there&#39;s no need to</span>
<a name="l01974"></a>01974                                                 <span class="comment">// do that here, ATM.</span>
<a name="l01975"></a>01975                                             }
<a name="l01976"></a>01976                                         }
<a name="l01977"></a>01977                                     } <span class="comment">// if (nOutpaymentIndex &gt;= 0)</span>
<a name="l01978"></a>01978                                     <span class="comment">// ------------------------------------------------------</span>
<a name="l01979"></a>01979                                     <span class="comment">// When party receives notice that smart contract has failed activation attempt, then remove</span>
<a name="l01980"></a>01980                                     <span class="comment">// the instrument from payments inbox AND outpayments box. (If there -- could be for either.)</span>
<a name="l01981"></a>01981                                     <span class="comment">// (Outbox is done just above, so now let&#39;s do inbox...)</span>
<a name="l01982"></a>01982                                     <span class="comment">//</span>
<a name="l01983"></a>01983 
<a name="l01984"></a>01984                                     <span class="comment">// Why only rejected items? Why not remove it from the payments inbox on success as well?</span>
<a name="l01985"></a>01985                                     <span class="comment">// Normally wouldn&#39;t we expect that a successful activation of an inbox item, should remove</span>
<a name="l01986"></a>01986                                     <span class="comment">// that inbox item? Especially if there&#39;s already a copy in the outbox as well...</span>
<a name="l01987"></a>01987                                     <span class="comment">//</span>
<a name="l01988"></a>01988 <span class="comment">//                                  if (OTItem::rejection == pReplyItem-&gt;GetStatus()) // REJECTION</span>
<a name="l01989"></a>01989                                     {
<a name="l01990"></a>01990                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l01991"></a>01991                                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists1   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01992"></a>01992                                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists2   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>()   .Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01993"></a>01993                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l01994"></a>01994                                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
<a name="l01995"></a>01995                                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
<a name="l01996"></a>01996                                         <span class="comment">// ------------------------------------------------------</span>
<a name="l01997"></a>01997                                         <span class="keywordtype">bool</span> bSuccessLoading1 = (bExists1 &amp;&amp; thePmntInbox.LoadPaymentInbox());
<a name="l01998"></a>01998                                         <span class="keywordtype">bool</span> bSuccessLoading2 = (bExists2 &amp;&amp; theRecordBox.<a class="code" href="class_o_t_ledger.html#ad283d675ba07160bddde117386b872a6">LoadRecordBox</a>());
<a name="l01999"></a>01999                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l02000"></a>02000                                         <span class="keywordflow">if</span> (bExists1 &amp;&amp; bSuccessLoading1)
<a name="l02001"></a>02001                                             bSuccessLoading1  = (thePmntInbox.VerifyContractID() &amp;&amp;
<a name="l02002"></a>02002                                             thePmntInbox.VerifySignature(*pNym));
<a name="l02003"></a>02003 <span class="comment">//                                      bSuccessLoading1      = (thePmntInbox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
<a name="l02004"></a>02004                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists1)
<a name="l02005"></a>02005                                             bSuccessLoading1  = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l02006"></a>02006                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l02007"></a>02007                                         <span class="keywordflow">if</span> (bExists2 &amp;&amp; bSuccessLoading2)
<a name="l02008"></a>02008                                             bSuccessLoading2  = (theRecordBox.<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>() &amp;&amp;
<a name="l02009"></a>02009                                             theRecordBox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym));
<a name="l02010"></a>02010 <span class="comment">//                                      bSuccessLoading2      = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
<a name="l02011"></a>02011                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists2)
<a name="l02012"></a>02012                                             bSuccessLoading2  = theRecordBox.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l02013"></a>02013                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l02014"></a>02014                                         <span class="comment">// by this point, the boxes DEFINITELY exist -- or not. (generation might have failed, or verification.)</span>
<a name="l02015"></a>02015                                         <span class="comment">//</span>
<a name="l02016"></a>02016                                         <span class="keywordflow">if</span> (!bSuccessLoading1 || !bSuccessLoading2)
<a name="l02017"></a>02017                                         {
<a name="l02018"></a>02018                                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server reply containing rejection of cron item: &quot;</span>
<a name="l02019"></a>02019                                                 <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate paymentInbox or recordBox, with IDs: %s / %s\n&quot;</span>,
<a name="l02020"></a>02020                                                 __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02021"></a>02021                                         }
<a name="l02022"></a>02022                                         <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying</span>
<a name="l02023"></a>02023                                         {   <span class="comment">// their contractID and signature, (OR success generating the ledger.)</span>
<a name="l02024"></a>02024                                             <span class="comment">// -------------------------------------------------------------------------------</span>
<a name="l02025"></a>02025                                             <span class="comment">// See if there&#39;s a receipt in the payments inbox.</span>
<a name="l02026"></a>02026                                             <span class="comment">// If so, remove it.</span>
<a name="l02027"></a>02027                                             <span class="comment">//                                            </span>
<a name="l02028"></a>02028                                             <span class="comment">// ------------------------------------------------------</span>
<a name="l02029"></a>02029                                             <span class="comment">// What&#39;s going on here?</span>
<a name="l02030"></a>02030                                             <span class="comment">//</span>
<a name="l02031"></a>02031                                             <span class="comment">// Well let&#39;s say Alice sends Bob a payment plan. (This applies to smart contracts, too.)</span>
<a name="l02032"></a>02032                                             <span class="comment">// This means Bob has a payment plan in his PAYMENTS INBOX, with the recipient&#39;s (Alice)</span>
<a name="l02033"></a>02033                                             <span class="comment">// transaction number set to X, and the sender&#39;s transaction number set to 0. It&#39;s 0 because</span>
<a name="l02034"></a>02034                                             <span class="comment">// the instrument is still in Bob&#39;s inbox -- he hasn&#39;t signed it yet -- so his transaction</span>
<a name="l02035"></a>02035                                             <span class="comment">// number isn&#39;t on it yet. It&#39;s blank (0).</span>
<a name="l02036"></a>02036                                             <span class="comment">//</span>
<a name="l02037"></a>02037                                             <span class="comment">// Next, let&#39;s say Bob signs/confirms the contract, which puts a copy of it into his PAYMENTS</span>
<a name="l02038"></a>02038                                             <span class="comment">// OUTBOX. On the outbox version, Alice&#39;s transaction number is X, and Bob&#39;s transaction number</span>
<a name="l02039"></a>02039                                             <span class="comment">// is Y.</span>
<a name="l02040"></a>02040                                             <span class="comment">//</span>
<a name="l02041"></a>02041                                             <span class="comment">// Later on, Bob needs to lookup the payment plan in his PAYMENTS INBOX (for example, to remove</span>
<a name="l02042"></a>02042                                             <span class="comment">// it, AS YOU SEE IN THE BELOW LOOP.) Remember, Bob&#39;s transaction number is Y. But he can&#39;t use</span>
<a name="l02043"></a>02043                                             <span class="comment">// that number (Y) to lookup the payment plan in his inbox, since it&#39;s set to ZERO in his inbox!</span>
<a name="l02044"></a>02044                                             <span class="comment">// The inbox version simply doesn&#39;t HAVE Y set onto it yet -- only the outbox version does.</span>
<a name="l02045"></a>02045                                             <span class="comment">//</span>
<a name="l02046"></a>02046                                             <span class="comment">// So how in the fuck does Bob lookup the inbox version, if the transaction number isn&#39;t SET on</span>
<a name="l02047"></a>02047                                             <span class="comment">// it yet??</span>
<a name="l02048"></a>02048                                             <span class="comment">//</span>
<a name="l02049"></a>02049                                             <span class="comment">// The solution:</span>
<a name="l02050"></a>02050                                             <span class="comment">// 1. Bob grabs an OTNumList containing all the transaction numbers from the OUTBOX VERSION,</span>
<a name="l02051"></a>02051                                             <span class="comment">//    which ends up containing &quot;X,Y&quot; (that happens in this block.)</span>
<a name="l02052"></a>02052                                             <span class="comment">// 2. Bob loops through the payments INBOX, and for each, he grabs an OTNumList containing all</span>
<a name="l02053"></a>02053                                             <span class="comment">//    the transaction numbers. One of those (the matching one) will contain &quot;X,0&quot;. (Except it</span>
<a name="l02054"></a>02054                                             <span class="comment">//    will actually only contain &quot;X&quot;, since 0 is ignored in the call to GetAllTransactionNumbers.)</span>
<a name="l02055"></a>02055                                             <span class="comment">// 3. Bob then checks like this:    if (numlistOutpayment.VerifyAny(numlistIncomingPayment))</span>
<a name="l02056"></a>02056                                             <span class="comment">//    This is equivalent to saying: if (&quot;X,Y&quot;.VerifyAny(&quot;X&quot;)) which RETURNS TRUE -- and we have</span>
<a name="l02057"></a>02057                                             <span class="comment">//    found the instrument!</span>
<a name="l02058"></a>02058 
<a name="l02059"></a>02059                                             <a class="code" href="class_o_t_payment.html">OTPayment</a> theOutpayment;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061                                             <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()                  &amp;&amp;
<a name="l02062"></a>02062                                                 theOutpayment.<a class="code" href="class_o_t_payment.html#a294a4886d8701ff1366bca5fdd1e7b56">SetPayment</a>(strInstrument) &amp;&amp;
<a name="l02063"></a>02063                                                 theOutpayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l02064"></a>02064                                             {
<a name="l02065"></a>02065                                                 theOutpayment.<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistOutpayment);
<a name="l02066"></a>02066                                             }
<a name="l02067"></a>02067                                             <span class="comment">// ------------------------------------------------------</span>
<a name="l02068"></a>02068                                             <span class="keyword">const</span> int32_t nTransCount = thePmntInbox.GetTransactionCount();
<a name="l02069"></a>02069 
<a name="l02070"></a>02070                                             <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// Count backwards since we are removing things.</span>
<a name="l02071"></a>02071                                             {
<a name="l02072"></a>02072                                                 int64_t lPaymentTransNum = 0;
<a name="l02073"></a>02073                                                 <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = thePmntInbox.GetInstrument(*pNym, ii);
<a name="l02074"></a>02074                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076                                                 <span class="keywordflow">if</span> (NULL == pPayment)
<a name="l02077"></a>02077                                                 {
<a name="l02078"></a>02078                                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: While looping payments inbox to remove a payment, unable to retrieve payment at index %d (skipping.)\n&quot;</span>,
<a name="l02079"></a>02079                                                         __FUNCTION__, ii);
<a name="l02080"></a>02080                                                     <span class="keywordflow">continue</span>;
<a name="l02081"></a>02081                                                 }
<a name="l02082"></a>02082                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l02083"></a>02083                                                 {
<a name="l02084"></a>02084                                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: While looping payments inbox to remove a payment, unable to set temp values for payment at index %d (skipping.)\n&quot;</span>,
<a name="l02085"></a>02085                                                         __FUNCTION__, ii);
<a name="l02086"></a>02086                                                     <span class="keywordflow">continue</span>;
<a name="l02087"></a>02087                                                 }
<a name="l02088"></a>02088                                                 <span class="comment">// ---------------------------------------------------</span>
<a name="l02089"></a>02089 
<a name="l02090"></a>02090                                                 <a class="code" href="class_o_t_num_list.html">OTNumList</a> numlistIncomingPayment;
<a name="l02091"></a>02091 
<a name="l02092"></a>02092                                                 pPayment-&gt;<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistIncomingPayment);
<a name="l02093"></a>02093 
<a name="l02094"></a>02094                                                 <span class="comment">// ---------------------------------------------------                                                    </span>
<a name="l02095"></a>02095 
<a name="l02096"></a>02096                                                 <span class="keywordflow">if</span> (numlistOutpayment.<a class="code" href="class_o_t_num_list.html#abe227d7816c9bac6831c95b55a797c44">VerifyAny</a>(numlistIncomingPayment))
<a name="l02097"></a>02097                                                 {
<a name="l02098"></a>02098                                                     <span class="comment">// ** It&#39;s the same instrument.**</span>
<a name="l02099"></a>02099                                                     <span class="comment">// Remove it from the payments inbox, and save.</span>
<a name="l02100"></a>02100                                                     <span class="comment">//</span>
<a name="l02101"></a>02101                                                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a>    * pTransPaymentInbox = thePmntInbox.GetTransactionByIndex(ii);
<a name="l02102"></a>02102                                                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL  != pTransPaymentInbox); <span class="comment">// It DEFINITELY should be there. (Assert otherwise.)</span>
<a name="l02103"></a>02103                                                     lPaymentTransNum = pTransPaymentInbox-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l02104"></a>02104 
<a name="l02105"></a>02105                                                     <span class="comment">// DON&#39;T I NEED to call DeleteBoxReceipt at this point?</span>
<a name="l02106"></a>02106                                                     <span class="comment">// Since that needs to be called now whenever removing something from any box?</span>
<a name="l02107"></a>02107                                                     <span class="comment">//</span>
<a name="l02108"></a>02108                                                     <span class="comment">// NOTE: might need to just MOVE this box receipt to the record box, instead of</span>
<a name="l02109"></a>02109                                                     <span class="comment">// deleting it.</span>
<a name="l02110"></a>02110                                                     <span class="comment">//</span>
<a name="l02111"></a>02111                                                     <span class="comment">// Probably I need to do that ONLY if the version in the payments outbox doesn&#39;t exist.</span>
<a name="l02112"></a>02112                                                     <span class="comment">// For example, if strInstrument doesn&#39;t exist, then there was nothing in the payments</span>
<a name="l02113"></a>02113                                                     <span class="comment">// outbox, and therefore the version in the payment INBOX is the ONLY version I have,</span>
<a name="l02114"></a>02114                                                     <span class="comment">// and therefore I should stick it in the Record Box.</span>
<a name="l02115"></a>02115                                                     <span class="comment">//</span>
<a name="l02116"></a>02116                                                     <span class="comment">// HOWEVER, if strInstrument DOES exist, then I should create its own transaction to add</span>
<a name="l02117"></a>02117                                                     <span class="comment">// to the record box, and delete the one that was in the payment inbox. Why delete it? Because</span>
<a name="l02118"></a>02118                                                     <span class="comment">// otherwise I would be adding the same thing TWICE to the record box, which I don&#39;t really</span>
<a name="l02119"></a>02119                                                     <span class="comment">// need to do. And if I&#39;m going to choose one of the two, the one in the outpayments box will</span>
<a name="l02120"></a>02120                                                     <span class="comment">// be the more recent / more relevant one of the two. So I favor that one, unless it doesn&#39;t</span>
<a name="l02121"></a>02121                                                     <span class="comment">// exist, in which case I should add the other one instead. (Todo.)</span>
<a name="l02122"></a>02122                                                     <span class="comment">//</span>
<a name="l02123"></a>02123                                                     <span class="comment">// NOTE: Until the above is completed, the current behavior is that the outpayments box item</span>
<a name="l02124"></a>02124                                                     <span class="comment">// will be moved to the record box if it exists, and otherwise nothing will be, since any payments</span>
<a name="l02125"></a>02125                                                     <span class="comment">// inbox item will be deleted.</span>
<a name="l02126"></a>02126 
<a name="l02127"></a>02127                                                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePmntInbox.DeleteBoxReceipt(lPaymentTransNum))
<a name="l02128"></a>02128                                                     {
<a name="l02129"></a>02129                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
<a name="l02130"></a>02130                                                             <span class="stringliteral">&quot;from the payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l02131"></a>02131                                                     }
<a name="l02132"></a>02132                                                     <span class="comment">// --------------------------------------------------</span>
<a name="l02133"></a>02133                                                     <span class="keywordflow">if</span> (thePmntInbox.RemoveTransaction(lPaymentTransNum))
<a name="l02134"></a>02134                                                     {
<a name="l02135"></a>02135                                                         thePmntInbox.ReleaseSignatures();
<a name="l02136"></a>02136                                                         thePmntInbox.SignContract(*pNym);
<a name="l02137"></a>02137                                                         thePmntInbox.SaveContract();
<a name="l02138"></a>02138 
<a name="l02139"></a>02139                                                         <span class="keywordflow">if</span> (!thePmntInbox.SavePaymentInbox())
<a name="l02140"></a>02140                                                         {
<a name="l02141"></a>02141                                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l02142"></a>02142                                                         }
<a name="l02143"></a>02143                                                         <span class="keywordflow">else</span>
<a name="l02144"></a>02144                                                         {
<a name="l02145"></a>02145                                                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed instrument from payment inbox.\n&quot;</span>
<a name="l02146"></a>02146                                                                 <span class="stringliteral">&quot;Saved payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l02147"></a>02147                                                         }
<a name="l02148"></a>02148                                                     }
<a name="l02149"></a>02149                                                     <span class="keywordflow">else</span>
<a name="l02150"></a>02150                                                     {
<a name="l02151"></a>02151                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove transaction from payment inbox. &quot;</span>
<a name="l02152"></a>02152                                                             <span class="stringliteral">&quot;(Should never happen.)\n&quot;</span>, __FUNCTION__);
<a name="l02153"></a>02153                                                     }
<a name="l02154"></a>02154                                                     <span class="comment">// -----------------------------------------------</span>
<a name="l02155"></a>02155                                                     <span class="comment">// Note: I could break right here, if this is the only transaction in the</span>
<a name="l02156"></a>02156                                                     <span class="comment">// payment inbox which contains the instrument in question. Which I believe</span>
<a name="l02157"></a>02157                                                     <span class="comment">// it is.  Todo: if that&#39;s true, which I think it is, then call break here.</span>
<a name="l02158"></a>02158                                                     <span class="comment">// After all, you wouldn&#39;t send me the SAME instrument TWICE, would you?</span>
<a name="l02159"></a>02159                                                     <span class="comment">// But it still seems theoretically possible (albeit stupid.)</span>
<a name="l02160"></a>02160                                                 }
<a name="l02161"></a>02161                                             }
<a name="l02162"></a>02162                                             <span class="comment">// for (int32_t ii = 0; ii &lt; nTransCount; ++ii)</span>
<a name="l02163"></a>02163                                             <span class="comment">// -------------------------------------------------------------------------------</span>
<a name="l02164"></a>02164                                             <span class="comment">// Also, if there was a message in the outpayments box (which we already removed</span>
<a name="l02165"></a>02165                                             <span class="comment">// a bit above), go ahead and add a receipt for it into the record box.</span>
<a name="l02166"></a>02166                                             <span class="comment">//</span>
<a name="l02167"></a>02167                                             <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// Found the instrument in the outpayments box.</span>
<a name="l02168"></a>02168                                             {
<a name="l02169"></a>02169                                                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pNewTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theRecordBox, <span class="comment">// recordbox.</span>
<a name="l02170"></a>02170                                                     <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>,
<a name="l02171"></a>02171                                                     lNymOpeningNumber);
<a name="l02172"></a>02172                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel(pNewTransaction);
<a name="l02173"></a>02173 
<a name="l02174"></a>02174                                                 <span class="keywordflow">if</span> (NULL != pNewTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
<a name="l02175"></a>02175                                                 {
<a name="l02176"></a>02176                                                     pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lNymOpeningNumber); <span class="comment">// Referencing myself here. We&#39;ll see how it works out.</span>
<a name="l02177"></a>02177                                                     pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInstrument);    <span class="comment">// The cheque, invoice, etc that used to be in the outpayments box.</span>
<a name="l02178"></a>02178                                                     pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l02179"></a>02179                                                     pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02180"></a>02180                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l02181"></a>02181                                                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pNewTransaction);
<a name="l02182"></a>02182 
<a name="l02183"></a>02183                                                     <span class="keywordflow">if</span> (!bAdded)
<a name="l02184"></a>02184                                                     {
<a name="l02185"></a>02185                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (after tentatively removing &quot;</span>
<a name="l02186"></a>02186                                                             <span class="stringliteral">&quot;from payment outbox, an action that is now canceled.)\n&quot;</span>, __FUNCTION__,
<a name="l02187"></a>02187                                                             pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l02188"></a>02188                                                     }
<a name="l02189"></a>02189                                                     <span class="keywordflow">else</span>
<a name="l02190"></a>02190                                                     {
<a name="l02191"></a>02191                                                         theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>
<a name="l02192"></a>02192 
<a name="l02193"></a>02193                                                         theRecordBox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l02194"></a>02194                                                         theRecordBox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l02195"></a>02195                                                         theRecordBox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02196"></a>02196                                                         <span class="comment">// -------------------------------</span>
<a name="l02197"></a>02197                                                         theRecordBox.<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>(); <span class="comment">// todo log failure.</span>
<a name="l02198"></a>02198 
<a name="l02199"></a>02199                                                         <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
<a name="l02200"></a>02200                                                         <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
<a name="l02201"></a>02201                                                         <span class="comment">//</span>
<a name="l02202"></a>02202                                                         <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
<a name="l02203"></a>02203                                                         <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
<a name="l02204"></a>02204                                                         <span class="comment">// is removed from a box.</span>
<a name="l02205"></a>02205                                                         <span class="comment">//</span>
<a name="l02206"></a>02206                                                         <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
<a name="l02207"></a>02207                                                         {
<a name="l02208"></a>02208                                                             <a class="code" href="class_o_t_string.html">OTString</a> strNewTransaction(*pNewTransaction);
<a name="l02209"></a>02209                                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... &quot;</span>
<a name="l02210"></a>02210                                                                 <span class="stringliteral">&quot;Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
<a name="l02211"></a>02211                                                                 __FUNCTION__, strNewTransaction.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02212"></a>02212                                                         }
<a name="l02213"></a>02213                                                     }
<a name="l02214"></a>02214                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l02215"></a>02215                                                 } <span class="comment">// if (NULL != pNewTransaction)</span>
<a name="l02216"></a>02216                                                 <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
<a name="l02217"></a>02217                                                 {
<a name="l02218"></a>02218                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
<a name="l02219"></a>02219                                                         <span class="stringliteral">&quot;add a new transaction to record box (for a payment instrument we just removed &quot;</span>
<a name="l02220"></a>02220                                                         <span class="stringliteral">&quot;from the outpayments box): %s\n&quot;</span>, __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02221"></a>02221                                                 }
<a name="l02222"></a>02222                                             } <span class="comment">// if (strInstrument.Exists()) (then add a copy to record box.)</span>
<a name="l02223"></a>02223                                         } <span class="comment">// else (Success loading the payment inbox and recordBox)</span>
<a name="l02224"></a>02224                                     } <span class="comment">// (OTItem::rejection == pReplyItem-&gt;GetStatus()) (loading payment inbox and record box.)</span>
<a name="l02225"></a>02225                                 } <span class="comment">// if payment plan or smart contract.</span>
<a name="l02226"></a>02226                             } <span class="comment">// if (NULL != pCronItem)</span>
<a name="l02227"></a>02227                             <span class="keywordflow">else</span>
<a name="l02228"></a>02228                             {
<a name="l02229"></a>02229                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading cronitem from original item, from string:\n%s\n&quot;</span>,
<a name="l02230"></a>02230                                     __FUNCTION__, strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02231"></a>02231                             }
<a name="l02232"></a>02232                         } <span class="comment">// if (NULL != pOriginalItem)</span>
<a name="l02233"></a>02233                         <span class="keywordflow">else</span>
<a name="l02234"></a>02234                         {
<a name="l02235"></a>02235                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading original item from string:\n%s\n\n&quot;</span>,
<a name="l02236"></a>02236                                 __FUNCTION__, strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02237"></a>02237                         }
<a name="l02238"></a>02238                     } <span class="comment">// if (NULL != pReplyItem)</span>
<a name="l02239"></a>02239                 } <span class="comment">// Case market offer, payment plan, or smart contract.</span>
<a name="l02240"></a>02240                 <span class="keywordflow">break</span>;
<a name="l02241"></a>02241 
<a name="l02242"></a>02242             <span class="keywordflow">default</span>: 
<a name="l02243"></a>02243                 <span class="comment">// Error</span>
<a name="l02244"></a>02244                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: wrong transaction type: %s\n&quot;</span>,
<a name="l02245"></a>02245                     __FUNCTION__, pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5baeb1d30c71f3a37565cb2e91b05447">GetTypeString</a>());
<a name="l02246"></a>02246                 <span class="keywordflow">break</span>;
<a name="l02247"></a>02247             } <span class="comment">// switch</span>
<a name="l02248"></a>02248             <span class="comment">// -----------------------------------------------------------------            </span>
<a name="l02249"></a>02249             <span class="comment">// atTransfer:      If success, KEEP the number on my list of responsibility. If fail, REMOVE it.</span>
<a name="l02250"></a>02250             <span class="comment">//                  (Do the same for atMarketOffer, atPaymentPlan, and atSmartContract.)</span>
<a name="l02251"></a>02251             <span class="comment">// atDeposit:       Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l02252"></a>02252             <span class="comment">// atWithdrawal:    Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l02253"></a>02253             <span class="comment">// atAcceptPending: Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l02254"></a>02254             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l02255"></a>02255             <span class="comment">//</span>
<a name="l02256"></a>02256             <span class="comment">// SAVE THE RECEIPT....</span>
<a name="l02257"></a>02257             <span class="comment">//</span>
<a name="l02258"></a>02258             <span class="comment">//OTFolders::Receipt().Get()</span>
<a name="l02259"></a>02259             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l02260"></a>02260             <a class="code" href="class_o_t_string.html">OTString</a> strReceiptFilename; <span class="comment">//contains: strReceiptID .success, fail, or error.</span>
<a name="l02261"></a>02261             <span class="comment">// ---------------------------------------------------------</span>
<a name="l02262"></a>02262             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
<a name="l02263"></a>02263 
<a name="l02264"></a>02264             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l02265"></a>02265             {
<a name="l02266"></a>02266                 pItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
<a name="l02267"></a>02267 
<a name="l02268"></a>02268                 <span class="keywordflow">if</span> (NULL != pItem)
<a name="l02269"></a>02269                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strReceiptID); <span class="comment">// In this case, the receipt ID is the Nym ID</span>
<a name="l02270"></a>02270             }
<a name="l02271"></a>02271             <span class="keywordflow">else</span> 
<a name="l02272"></a>02272             {
<a name="l02273"></a>02273                 strReceiptID = theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>; <span class="comment">// If a balance statement, then the receipt ID is the Account ID.</span>
<a name="l02274"></a>02274             }
<a name="l02275"></a>02275             <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02276"></a>02276             <span class="comment">// Try to save the transaction receipt to local storage.</span>
<a name="l02277"></a>02277             <span class="comment">//</span>
<a name="l02278"></a>02278             <a class="code" href="class_o_t_string.html">OTString</a> strTransaction;
<a name="l02279"></a>02279             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTransaction);
<a name="l02280"></a>02280             <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02281"></a>02281             <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
<a name="l02282"></a>02282             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(strTransaction);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284             <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strFinal, <span class="stringliteral">&quot;TRANSACTION&quot;</span>)) <span class="comment">// todo hardcoding.</span>
<a name="l02285"></a>02285             {
<a name="l02286"></a>02286                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving transaction receipt (failed writing armored string):\n&quot;</span>
<a name="l02287"></a>02287                     <span class="stringliteral">&quot;%s%s%s%s%s\n&quot;</span>, __FUNCTION__,
<a name="l02288"></a>02288                     <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l02289"></a>02289                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02290"></a>02290                 <span class="keywordflow">return</span>;
<a name="l02291"></a>02291             }
<a name="l02292"></a>02292             <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l02293"></a>02293             <span class="keywordflow">if</span> (NULL != pItem)
<a name="l02294"></a>02294             {
<a name="l02295"></a>02295                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02296"></a>02296                 <span class="comment">// Filename is based on transaction success/failure.</span>
<a name="l02297"></a>02297                 <span class="comment">//</span>
<a name="l02298"></a>02298                 <span class="keywordflow">if</span> (pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
<a name="l02299"></a>02299                     strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02300"></a>02300                 <span class="keywordflow">else</span>
<a name="l02301"></a>02301                     strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.fail&quot;</span>,    strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02302"></a>02302                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02303"></a>02303 
<a name="l02304"></a>02304                 <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l02305"></a>02305                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02306"></a>02306             }
<a name="l02307"></a>02307             <span class="keywordflow">else</span> <span class="comment">// This should never happen...</span>
<a name="l02308"></a>02308             {
<a name="l02309"></a>02309                 strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.error&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02310"></a>02310 
<a name="l02311"></a>02311                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving transaction receipt, since pItem was NULL: %s\n&quot;</span>,
<a name="l02312"></a>02312                     __FUNCTION__, strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02313"></a>02313 
<a name="l02314"></a>02314                 <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02315"></a>02315                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());               
<a name="l02316"></a>02316             }
<a name="l02317"></a>02317 
<a name="l02318"></a>02318             <span class="comment">// No matter what kind of transaction it is,</span>
<a name="l02319"></a>02319             <span class="comment">// let&#39;s see if the server gave us some new transaction numbers with it...</span>
<a name="l02320"></a>02320             <span class="comment">// UPDATE: the server will not give me transaction numbers unless I have SIGNED FOR THEM.</span>
<a name="l02321"></a>02321             <span class="comment">// Therefore, they are now dropped into the Nymbox, and that is where they will be.</span>
<a name="l02322"></a>02322             <span class="comment">//          HarvestTransactionNumbers(*pTransaction, *pNym);</span>
<a name="l02323"></a>02323         }
<a name="l02324"></a>02324         <span class="keywordflow">else</span> 
<a name="l02325"></a>02325         {
<a name="l02326"></a>02326             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying server ownership of this transaction.\n&quot;</span>,
<a name="l02327"></a>02327                 __FUNCTION__);
<a name="l02328"></a>02328         }       
<a name="l02329"></a>02329     }
<a name="l02330"></a>02330 }
<a name="l02331"></a>02331 
<a name="l02332"></a>02332 
<a name="l02333"></a>02333 <span class="comment">// Usually a transaction from the server includes some new transaction numbers.</span>
<a name="l02334"></a>02334 <span class="comment">// Use this function to harvest them.</span>
<a name="l02335"></a>02335 <span class="comment">//void OTClient::HarvestTransactionNumbers(OTTransaction &amp; theTransaction, OTPseudonym &amp; theNym)</span>
<a name="l02336"></a>02336 <span class="comment">//{ </span>
<a name="l02337"></a>02337 <span class="comment">//  FOR_EACH(listOfItems, theTransaction.GetItemList())</span>
<a name="l02338"></a>02338 <span class="comment">//  {</span>
<a name="l02339"></a>02339 <span class="comment">//      OTItem * pItem = *it;</span>
<a name="l02340"></a>02340 <span class="comment">//      OT_ASSERT(NULL != pItem);</span>
<a name="l02341"></a>02341 <span class="comment">//      </span>
<a name="l02342"></a>02342 <span class="comment">//      if (OTItem::atTransaction == pItem-&gt;GetType())</span>
<a name="l02343"></a>02343 <span class="comment">//      { </span>
<a name="l02344"></a>02344 <span class="comment">//          if (OTItem::acknowledgement == pItem-&gt;GetStatus())</span>
<a name="l02345"></a>02345 <span class="comment">//          {</span>
<a name="l02346"></a>02346 <span class="comment">//              OTLog::Output(0, &quot;SUCCESS -- Received new transaction number(s) from Server for storage.\n&quot;);</span>
<a name="l02347"></a>02347 <span class="comment">//              </span>
<a name="l02348"></a>02348 <span class="comment">//              OTString strAttachment;</span>
<a name="l02349"></a>02349 <span class="comment">//              pItem-&gt;GetAttachment(strAttachment);</span>
<a name="l02350"></a>02350 <span class="comment">//              if (strAttachment.GetLength())</span>
<a name="l02351"></a>02351 <span class="comment">//              {</span>
<a name="l02352"></a>02352 <span class="comment">//                  OTPseudonym thePseudonym;</span>
<a name="l02353"></a>02353 <span class="comment">//                  </span>
<a name="l02354"></a>02354 <span class="comment">//                  if (thePseudonym.LoadFromString(strAttachment))</span>
<a name="l02355"></a>02355 <span class="comment">//                  {</span>
<a name="l02356"></a>02356 <span class="comment">//                      theNym.HarvestTransactionNumbers(pItem-&gt;GetPurportedServerID(), theNym, thePseudonym);</span>
<a name="l02357"></a>02357 <span class="comment">//                  }</span>
<a name="l02358"></a>02358 <span class="comment">//              }</span>
<a name="l02359"></a>02359 <span class="comment">//          }</span>
<a name="l02360"></a>02360 <span class="comment">//          else </span>
<a name="l02361"></a>02361 <span class="comment">//          {</span>
<a name="l02362"></a>02362 <span class="comment">//              OTLog::Output(0, &quot;FAILURE -- Server refuses to send transaction num.\n&quot;); // in practice will never occur.</span>
<a name="l02363"></a>02363 <span class="comment">//          }</span>
<a name="l02364"></a>02364 <span class="comment">//      }</span>
<a name="l02365"></a>02365 <span class="comment">//  }   // for each</span>
<a name="l02366"></a>02366 <span class="comment">//}</span>
<a name="l02367"></a>02367 
<a name="l02368"></a>02368 
<a name="l02369"></a>02369 
<a name="l02370"></a><a class="code" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">02370</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#aef4ff4a25033a395f916881a074c58fb">OTClient::ProcessPayDividendResponse</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction, <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection, <a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theReply)
<a name="l02371"></a>02371 {
<a name="l02372"></a>02372     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l02373"></a>02373     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
<a name="l02374"></a>02374     theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
<a name="l02375"></a>02375     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
<a name="l02376"></a>02376     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
<a name="l02377"></a>02377     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
<a name="l02378"></a>02378     <span class="comment">//  OTWallet * pWallet = theConnection.GetWallet();</span>
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to pay dividend.</span>
<a name="l02381"></a>02381 
<a name="l02382"></a>02382     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
<a name="l02383"></a>02383     {
<a name="l02384"></a>02384         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l02385"></a>02385         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l02386"></a>02386 
<a name="l02387"></a>02387         <span class="comment">// if pointer not null, and it&#39;s a dividend payout, and it&#39;s an acknowledgement (not a rejection or error)</span>
<a name="l02388"></a>02388 
<a name="l02389"></a>02389         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae8f15961c19cf2d7645061df47e59650">OTItem::atPayDividend</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l02390"></a>02390         { 
<a name="l02391"></a>02391             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l02392"></a>02392             {
<a name="l02393"></a>02393                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION SUCCESS -- Server acknowledges dividend payout.\n&quot;</span>);
<a name="l02394"></a>02394             }
<a name="l02395"></a>02395             <span class="keywordflow">else</span> 
<a name="l02396"></a>02396             {
<a name="l02397"></a>02397                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION FAILURE -- Server rejects dividend payout.\n&quot;</span>);
<a name="l02398"></a>02398             }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400         }
<a name="l02401"></a>02401     }
<a name="l02402"></a>02402 }
<a name="l02403"></a>02403 
<a name="l02404"></a>02404 
<a name="l02405"></a>02405 
<a name="l02406"></a>02406 
<a name="l02407"></a><a class="code" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">02407</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#a50baddc0e9243a64e8ba5b8e76acbdb2">OTClient::ProcessDepositResponse</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction, <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection, <a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theReply)
<a name="l02408"></a>02408 {
<a name="l02409"></a>02409     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l02410"></a>02410     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
<a name="l02411"></a>02411     theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
<a name="l02412"></a>02412     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
<a name="l02413"></a>02413     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
<a name="l02414"></a>02414     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
<a name="l02415"></a>02415     <span class="comment">//  OTWallet * pWallet = theConnection.GetWallet();</span>
<a name="l02416"></a>02416 
<a name="l02417"></a>02417     <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to deposit.</span>
<a name="l02418"></a>02418 
<a name="l02419"></a>02419     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
<a name="l02420"></a>02420     {
<a name="l02421"></a>02421         <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it;
<a name="l02422"></a>02422         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pReplyItem);
<a name="l02423"></a>02423 
<a name="l02424"></a>02424         <span class="comment">// if pointer not null, and it&#39;s a deposit, and it&#39;s an acknowledgement (not a rejection or error)</span>
<a name="l02425"></a>02425 
<a name="l02426"></a>02426         <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a814d6a51c7059307c8fe8d073fb9de9e">OTItem::atDeposit</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) || (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()))
<a name="l02427"></a>02427         {            
<a name="l02428"></a>02428             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l02429"></a>02429             {
<a name="l02430"></a>02430                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;TRANSACTION SUCCESS -- Server acknowledges deposit.\n&quot;</span>);
<a name="l02431"></a>02431 
<a name="l02432"></a>02432                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae12946cd205221592c0fa44e4c7399b2">OTItem::atDepositCheque</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l02433"></a>02433                 {
<a name="l02434"></a>02434                     <span class="comment">// Inside OT, when processing a successful server reply to a depositCheque request,</span>
<a name="l02435"></a>02435                     <span class="comment">// and if that cheque is found inside the Payments Inbox, ==&gt; move it to the record box.</span>
<a name="l02436"></a>02436                     <span class="comment">//</span>
<a name="l02437"></a>02437                     <span class="comment">// -----------------------------------------------------</span>
<a name="l02438"></a>02438                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
<a name="l02439"></a>02439                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theLedgerAngel(pLedger);
<a name="l02440"></a>02440                     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l02441"></a>02441                     <span class="comment">// ------------------------------------------------------</span>
<a name="l02442"></a>02442                     <span class="keywordflow">if</span> ((NULL != pLedger) &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a2089e14094b2047e668bc50e2d5d3eb2">LoadPaymentInbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
<a name="l02443"></a>02443                     {
<a name="l02444"></a>02444                         <span class="comment">// If an incoming payment exists that matches the instrument inside the server&#39;s deposit response,</span>
<a name="l02445"></a>02445                         <span class="comment">// then remove it from the payments inbox and save. Save a copy to the records box.</span>
<a name="l02446"></a>02446                         <span class="comment">//</span>
<a name="l02447"></a>02447                         <span class="comment">// --------------------------------------------------</span>
<a name="l02448"></a>02448                         <span class="comment">// Response item contains a copy of the original item, as reference string.</span>
<a name="l02449"></a>02449                         <span class="comment">//</span>
<a name="l02450"></a>02450                         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalDepositItem;
<a name="l02451"></a>02451                         <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = NULL;
<a name="l02452"></a>02452                         pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalDepositItem);
<a name="l02453"></a>02453 
<a name="l02454"></a>02454                         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strOriginalDepositItem);
<a name="l02455"></a>02455                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType);
<a name="l02456"></a>02456 
<a name="l02457"></a>02457                         <span class="keywordflow">if</span> (NULL != pTransType)
<a name="l02458"></a>02458                         {
<a name="l02459"></a>02459                             pOriginalItem = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_item.html">OTItem</a> *<span class="keyword">&gt;</span>(pTransType);
<a name="l02460"></a>02460                         }
<a name="l02461"></a>02461                         <span class="comment">// ------------------------------------------------</span>
<a name="l02462"></a>02462                         <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l02463"></a>02463                         {
<a name="l02464"></a>02464                             <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
<a name="l02465"></a>02465                             pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);
<a name="l02466"></a>02466 
<a name="l02467"></a>02467                             <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque;
<a name="l02468"></a>02468                             <span class="keywordtype">bool</span> bLoadContractFromString = theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque);
<a name="l02469"></a>02469 
<a name="l02470"></a>02470                             <span class="keywordflow">if</span> (!bLoadContractFromString)
<a name="l02471"></a>02471                             {
<a name="l02472"></a>02472                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR loading cheque from string:\n%s\n&quot;</span>,
<a name="l02473"></a>02473                                     __FUNCTION__, strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02474"></a>02474                             }
<a name="l02475"></a>02475                             <span class="keywordflow">else</span> <span class="comment">// Okay, we&#39;ve got the cheque!</span>
<a name="l02476"></a>02476                             {
<a name="l02477"></a>02477                                 <span class="comment">// Let&#39;s loop through the payment inbox and see if there&#39;s a matching cheque.</span>
<a name="l02478"></a>02478                                 <span class="comment">//</span>
<a name="l02479"></a>02479                                 <span class="keyword">const</span> int64_t lChequeTransNum = theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>();
<a name="l02480"></a>02480                                 <span class="keyword">const</span> int32_t  nTransCount = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>();
<a name="l02481"></a>02481 
<a name="l02482"></a>02482                                 <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// going backwards since we are deleting something. (Probably only one thing, but still...)</span>
<a name="l02483"></a>02483                                 {
<a name="l02484"></a>02484                                     <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym, ii);
<a name="l02485"></a>02485                                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l02486"></a>02486 
<a name="l02487"></a>02487                                     int64_t lPaymentTransNum = 0;
<a name="l02488"></a>02488 
<a name="l02489"></a>02489                                     <span class="keywordflow">if</span> ((NULL != pPayment) &amp;&amp; pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>() &amp;&amp;
<a name="l02490"></a>02490                                         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a02ffc34caf84cf6e9f88910b6354fbd8">GetTransactionNum</a>(lPaymentTransNum) &amp;&amp; (lPaymentTransNum == lChequeTransNum))                                    
<a name="l02491"></a>02491                                     {
<a name="l02492"></a>02492                                         <span class="comment">// -----------------------------------------------</span>
<a name="l02493"></a>02493                                         <span class="comment">// It&#39;s the same cheque.</span>
<a name="l02494"></a>02494                                         <span class="comment">// Remove it from the payments inbox, and save.</span>
<a name="l02495"></a>02495                                         <span class="comment">//</span>
<a name="l02496"></a>02496                                         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(ii);
<a name="l02497"></a>02497                                         <a class="code" href="class_o_t_string.html">OTString</a> strPmntInboxTransaction;
<a name="l02498"></a>02498                                         int64_t lRemoveTransaction = 0;
<a name="l02499"></a>02499 
<a name="l02500"></a>02500                                         <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l02501"></a>02501                                         {
<a name="l02502"></a>02502                                             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPmntInboxTransaction);
<a name="l02503"></a>02503                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02504"></a>02504                                             lRemoveTransaction = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l02505"></a>02505 
<a name="l02506"></a>02506                                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pLedger-&gt;<a class="code" href="class_o_t_ledger.html#aea09d3dd8bf2fc5630ce87184fc937c1">DeleteBoxReceipt</a>(lRemoveTransaction))
<a name="l02507"></a>02507                                             {
<a name="l02508"></a>02508                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a cheque being removed &quot;</span>
<a name="l02509"></a>02509                                                     <span class="stringliteral">&quot;from a payments inbox: %lld\n&quot;</span>, __FUNCTION__, lRemoveTransaction);
<a name="l02510"></a>02510                                             }
<a name="l02511"></a>02511                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02512"></a>02512                                             <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lRemoveTransaction))
<a name="l02513"></a>02513                                             {
<a name="l02514"></a>02514                                                 pLedger-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l02515"></a>02515                                                 pLedger-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l02516"></a>02516                                                 pLedger-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02517"></a>02517 
<a name="l02518"></a>02518                                                 <span class="keywordflow">if</span> (!pLedger-&gt;<a class="code" href="class_o_t_ledger.html#ab6f6af26a690d49f61ec7ffcc557a302">SavePaymentInbox</a>())
<a name="l02519"></a>02519                                                 {
<a name="l02520"></a>02520                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l02521"></a>02521                                                 }
<a name="l02522"></a>02522                                                 <span class="keywordflow">else</span>
<a name="l02523"></a>02523                                                 {
<a name="l02524"></a>02524                                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed cheque from payments inbox. (Deposited successfully.)\n&quot;</span>
<a name="l02525"></a>02525                                                         <span class="stringliteral">&quot;Saved payments inbox.\n&quot;</span>, __FUNCTION__);
<a name="l02526"></a>02526                                                 }
<a name="l02527"></a>02527                                             }
<a name="l02528"></a>02528                                         } <span class="comment">// if (NULL != pTransaction)</span>
<a name="l02529"></a>02529                                         <span class="comment">// -----------------------------------------------</span>
<a name="l02530"></a>02530                                         <span class="comment">// We&#39;re still in the loop backwards through the paymentInbox, checking each for</span>
<a name="l02531"></a>02531                                         <span class="comment">// a payment instrument. Specifically, theCheque&#39;s cheque. That&#39;s because this is</span>
<a name="l02532"></a>02532                                         <span class="comment">// processChequeResponse. If there was a cheque in my payments inbox, and I just</span>
<a name="l02533"></a>02533                                         <span class="comment">// successfully deposited the cheque, then I want to remove it from my payments</span>
<a name="l02534"></a>02534                                         <span class="comment">// inbox. We already just did that -- so now we want to drop a copy of it into</span>
<a name="l02535"></a>02535                                         <span class="comment">// the record box.</span>
<a name="l02536"></a>02536                                         <span class="comment">//</span>
<a name="l02537"></a>02537                                         <span class="comment">// Save a copy to the record box.</span>
<a name="l02538"></a>02538                                         <span class="comment">//</span>
<a name="l02539"></a>02539                                         <span class="keywordflow">if</span> (strPmntInboxTransaction.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02540"></a>02540                                         {
<a name="l02541"></a>02541                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID     (USER_ID);
<a name="l02542"></a>02542                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l02543"></a>02543                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02544"></a>02544                                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02545"></a>02545                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02546"></a>02546                                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
<a name="l02547"></a>02547                                             <span class="comment">// ------------------------------------------------------</span>
<a name="l02548"></a>02548                                             <span class="keywordtype">bool</span> bSuccessLoading = (bExists &amp;&amp; theRecordBox.LoadRecordBox());
<a name="l02549"></a>02549                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02550"></a>02550                                             <span class="keywordflow">if</span> (bExists &amp;&amp; bSuccessLoading)
<a name="l02551"></a>02551                                                 bSuccessLoading = (theRecordBox.VerifyContractID() &amp;&amp;
<a name="l02552"></a>02552                                                 theRecordBox.VerifySignature(*pNym));
<a name="l02553"></a>02553                                             <span class="comment">//                                              bSuccessLoading = (theRecordBox.VerifyAccount(*pNym)); // (No need here to load all the Box Receipts by using VerifyAccount)</span>
<a name="l02554"></a>02554                                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists)
<a name="l02555"></a>02555                                                 bSuccessLoading = theRecordBox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l02556"></a>02556                                             <span class="comment">// -----------------------------------------------------</span>
<a name="l02557"></a>02557                                             <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
<a name="l02558"></a>02558                                             <span class="comment">//</span>
<a name="l02559"></a>02559                                             <span class="keywordflow">if</span> (!bSuccessLoading)
<a name="l02560"></a>02560                                             {
<a name="l02561"></a>02561                                                 <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
<a name="l02562"></a>02562                                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: WARNING: Unable to load, verify, or &quot;</span>
<a name="l02563"></a>02563                                                     <span class="stringliteral">&quot;generate recordBox, with IDs: %s / %s\n&quot;</span>,
<a name="l02564"></a>02564                                                     __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02565"></a>02565                                             }
<a name="l02566"></a>02566                                             <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the recordBox and verifying its contractID and signature, (OR success generating the ledger.)</span>
<a name="l02567"></a>02567                                             {
<a name="l02568"></a>02568                                                 <span class="comment">// Currently in @getBoxReceipt, we are taking an incoming cheque from the nymbox</span>
<a name="l02569"></a>02569                                                 <span class="comment">// and adding it to the payments inbox. From there the user might choose to deposit it.</span>
<a name="l02570"></a>02570                                                 <span class="comment">// When he does that, he&#39;ll receive a server reply, which is what we&#39;re processing here</span>
<a name="l02571"></a>02571                                                 <span class="comment">// in this function. So now that we&#39;ve got that reply, we want to move the cheque notice</span>
<a name="l02572"></a>02572                                                 <span class="comment">// from the payments inbox, and into the record box at this point HERE, when we&#39;ve just</span>
<a name="l02573"></a>02573                                                 <span class="comment">// above removed it from the payments inbox (on successful deposit.)</span>
<a name="l02574"></a>02574                                                 <span class="comment">//</span>
<a name="l02575"></a>02575                                                 <a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">load_str_trans_add_to_ledger</a>(USER_ID, strPmntInboxTransaction, <span class="stringliteral">&quot;recordBox&quot;</span>, lRemoveTransaction, *pNym, theRecordBox);
<a name="l02576"></a>02576                                             }
<a name="l02577"></a>02577                                         }
<a name="l02578"></a>02578                                     } <span class="comment">// pPayment</span>
<a name="l02579"></a>02579                                 }
<a name="l02580"></a>02580                                 <span class="comment">// for (payments inbox) ----------------------------------</span>
<a name="l02581"></a>02581                             }
<a name="l02582"></a>02582                         } <span class="comment">// if NULL != pOriginalItem</span>
<a name="l02583"></a>02583                         <span class="comment">// ------------------------------------------------</span>
<a name="l02584"></a>02584                     }
<a name="l02585"></a>02585                     <span class="keywordflow">else</span>
<a name="l02586"></a>02586                     {
<a name="l02587"></a>02587                         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
<a name="l02588"></a>02588                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify payments inbox: User %s / Acct %s\n&quot;</span>,
<a name="l02589"></a>02589                             __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02590"></a>02590                     }
<a name="l02591"></a>02591                 }
<a name="l02592"></a>02592             }
<a name="l02593"></a>02593             <span class="keywordflow">else</span> 
<a name="l02594"></a>02594             {
<a name="l02595"></a>02595                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: TRANSACTION FAILURE -- Server rejects deposit.\n&quot;</span>, __FUNCTION__);
<a name="l02596"></a>02596             }
<a name="l02597"></a>02597         }
<a name="l02598"></a>02598     }
<a name="l02599"></a>02599 }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 
<a name="l02602"></a>02602 
<a name="l02603"></a>02603 
<a name="l02606"></a><a class="code" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">02606</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_client.html#a51c30a192bba147351ac5b1e83620afb">OTClient::ProcessWithdrawalResponse</a>(<a class="code" href="class_o_t_transaction.html">OTTransaction</a> &amp; theTransaction, <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection, <a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theReply)
<a name="l02607"></a>02607 {
<a name="l02608"></a>02608     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l02609"></a>02609     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID;
<a name="l02610"></a>02610     theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
<a name="l02611"></a>02611 
<a name="l02612"></a>02612     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l02613"></a>02613 
<a name="l02614"></a>02614     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
<a name="l02615"></a>02615     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID;
<a name="l02616"></a>02616     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(USER_ID);
<a name="l02617"></a>02617 
<a name="l02618"></a>02618     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l02619"></a>02619 
<a name="l02620"></a>02620     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
<a name="l02621"></a>02621     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>());
<a name="l02622"></a>02622 
<a name="l02623"></a>02623     <span class="comment">// loop through the ALL items that make up this transaction and check to see if a response to withdrawal.</span>
<a name="l02624"></a>02624 
<a name="l02625"></a>02625     <span class="comment">// if pointer not null, and it&#39;s a withdrawal, and it&#39;s an acknowledgement (not a rejection or error)</span>
<a name="l02626"></a>02626     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, theTransaction.<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
<a name="l02627"></a>02627     {
<a name="l02628"></a>02628         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = *it;
<a name="l02629"></a>02629         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l02630"></a>02630         <span class="comment">// ----------------------------------------------------------------------------------------</span>
<a name="l02631"></a>02631         <span class="comment">// VOUCHER WITHDRAWAL</span>
<a name="l02632"></a>02632         <span class="comment">//</span>
<a name="l02633"></a>02633         <span class="comment">// If we got a reply to a voucher withdrawal, we&#39;ll just display the voucher</span>
<a name="l02634"></a>02634         <span class="comment">// on the screen (if the server sent us one...)</span>
<a name="l02635"></a>02635         <span class="comment">//</span>
<a name="l02636"></a>02636         <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a36d4c6faf8ad5aae6ea36fe5a66012c8">OTItem::atWithdrawVoucher</a>  == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
<a name="l02637"></a>02637             (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>    == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))
<a name="l02638"></a>02638         { 
<a name="l02639"></a>02639             <a class="code" href="class_o_t_string.html">OTString</a>    strVoucher;
<a name="l02640"></a>02640             <a class="code" href="class_o_t_cheque.html">OTCheque</a>    theVoucher;
<a name="l02641"></a>02641 
<a name="l02642"></a>02642             pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strVoucher);
<a name="l02643"></a>02643 
<a name="l02644"></a>02644             <span class="keywordflow">if</span> (theVoucher.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strVoucher))
<a name="l02645"></a>02645             {
<a name="l02646"></a>02646                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nReceived voucher from server:\n\n%s\n\n&quot;</span>, strVoucher.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());   
<a name="l02647"></a>02647             }
<a name="l02648"></a>02648         }
<a name="l02649"></a>02649         <span class="comment">// ----------------------------------------------------------------------------------------</span>
<a name="l02650"></a>02650         <span class="comment">// CASH WITHDRAWAL</span>
<a name="l02651"></a>02651         <span class="comment">//</span>
<a name="l02652"></a>02652         <span class="comment">// If the item is a response to a cash withdrawal, we want to save the coins into a purse</span>
<a name="l02653"></a>02653         <span class="comment">// somewhere on the computer. That&#39;s cash! Gotta keep it safe.</span>
<a name="l02654"></a>02654         <span class="comment">//</span>
<a name="l02655"></a>02655         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a16a994b2323c05a6cd00ccbf57102be8">OTItem::atWithdrawal</a>      == pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) &amp;&amp;
<a name="l02656"></a>02656                  (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a>   == pItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))
<a name="l02657"></a>02657         { 
<a name="l02658"></a>02658             <a class="code" href="class_o_t_string.html">OTString</a>    strPurse;
<a name="l02659"></a>02659             pItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strPurse);
<a name="l02660"></a>02660 
<a name="l02661"></a>02661             <a class="code" href="class_o_t_purse.html">OTPurse</a>     thePurse(SERVER_ID);
<a name="l02662"></a>02662 
<a name="l02663"></a>02663             <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPurse))
<a name="l02664"></a>02664             {
<a name="l02665"></a>02665                 <span class="comment">// When we made the withdrawal request, we saved that purse pointer in the</span>
<a name="l02666"></a>02666                 <span class="comment">// wallet so that we could get to the private coin unblinding data when we </span>
<a name="l02667"></a>02667                 <span class="comment">// needed it (now).</span>
<a name="l02668"></a>02668                 <a class="code" href="class_o_t_purse.html">OTPurse</a> * pRequestPurse     = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a08f39d74540ac2c100ee28d8689af969">GetPendingWithdrawal</a>();
<a name="l02669"></a>02669                 <a class="code" href="class_o_t_token.html">OTToken</a> * pToken            = NULL;
<a name="l02670"></a>02670                 <a class="code" href="class_o_t_token.html">OTToken</a> * pOriginalToken    = NULL;
<a name="l02671"></a>02671 
<a name="l02672"></a>02672                 <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(thePurse.<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>());
<a name="l02673"></a>02673                 <span class="comment">// -----------------------------------------------------------------</span>
<a name="l02674"></a>02674                 <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strAssetID);
<a name="l02675"></a>02675                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
<a name="l02676"></a>02676                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
<a name="l02677"></a>02677                 <span class="comment">// -----------------------------------------------------------------</span>
<a name="l02678"></a>02678                 <span class="comment">// Unlike the purse which we read out of a message,</span>
<a name="l02679"></a>02679                 <span class="comment">// now we try to open a purse as a file on the client side,</span>
<a name="l02680"></a>02680                 <span class="comment">// keyed by Asset ID.  (The client should already have one</span>
<a name="l02681"></a>02681                 <span class="comment">// purse file for each asset type, if he already has cash.)</span>
<a name="l02682"></a>02682                 <span class="comment">// </span>
<a name="l02683"></a>02683                 <span class="comment">// We don&#39;t want to just overwrite that file. So instead, we</span>
<a name="l02684"></a>02684                 <span class="comment">// try to load that purse first, then add the token, then save it</span>
<a name="l02685"></a>02685                 <span class="comment">// again.</span>
<a name="l02686"></a>02686                 <a class="code" href="class_o_t_purse.html">OTPurse</a> theWalletPurse(thePurse);
<a name="l02687"></a>02687                 <span class="comment">// TODO verify the wallet purse when loaded. My signature should be the last thing on it.</span>
<a name="l02688"></a>02688 
<a name="l02689"></a>02689                 <span class="comment">// TODO: I don&#39;t check this for failure. If the file doesn&#39;t exist,</span>
<a name="l02690"></a>02690                 <span class="comment">// we are still going to save the purse there regardless.</span>
<a name="l02691"></a>02691                 <span class="comment">// HOWEVER need to make sure the wallet software has good backup</span>
<a name="l02692"></a>02692                 <span class="comment">// strategy.  In the event that tokens are overwritten here, it</span>
<a name="l02693"></a>02693                 <span class="comment">// shouldn&#39;t be a problem since they would be in the archive somewhere.</span>
<a name="l02694"></a>02694 
<a name="l02695"></a>02695                 theWalletPurse.<a class="code" href="class_o_t_purse.html#a6cda4ea82f97fab7719242c0827846f7">LoadPurse</a>(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetID.Get());
<a name="l02696"></a>02696                 <span class="comment">//              if Load, theWalletPurse.VerifySignature();</span>
<a name="l02697"></a>02697 
<a name="l02698"></a>02698                 <span class="comment">// -------------------------------------------------------------</span>
<a name="l02699"></a>02699 
<a name="l02700"></a>02700                 <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l02701"></a>02701 
<a name="l02702"></a>02702                 <span class="keywordflow">if</span> ((NULL != pRequestPurse) &amp;&amp; (NULL != pServerNym) &amp;&amp; 
<a name="l02703"></a>02703                     pMint-&gt;LoadMint() &amp;&amp; pMint-&gt;VerifyMint(*pServerNym))
<a name="l02704"></a>02704                     <span class="keywordflow">while</span> ((pToken = thePurse.<a class="code" href="class_o_t_purse.html#a84b70b093c79a796815d9a42c8d3bd74">Pop</a>(*pNym)) != NULL)
<a name="l02705"></a>02705                     {
<a name="l02706"></a>02706                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);
<a name="l02707"></a>02707 
<a name="l02708"></a>02708                         pOriginalToken = pRequestPurse-&gt;<a class="code" href="class_o_t_purse.html#a84b70b093c79a796815d9a42c8d3bd74">Pop</a>(*pNym);
<a name="l02709"></a>02709 
<a name="l02710"></a>02710                         <span class="keywordflow">if</span> (NULL == pOriginalToken)
<a name="l02711"></a>02711                         {
<a name="l02712"></a>02712                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR, processing withdrawal response, but couldn&#39;t find original token:%s\n&quot;</span>, strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02713"></a>02713                         }
<a name="l02714"></a>02714                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_token.html#ad0fb0c562a9e37fcdb561e56075672ddade23d1dd76bccd72a985f722f6ce74bd">OTToken::signedToken</a> == pToken-&gt;<a class="code" href="class_o_t_token.html#a0b7813d8f9c8564904a7efa3be0f5a7e">GetState</a>())
<a name="l02715"></a>02715                         {
<a name="l02716"></a>02716                             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Retrieved signed token from purse, and have corresponding withdrawal request in wallet. Unblinding...\n\n&quot;</span>);
<a name="l02717"></a>02717 
<a name="l02718"></a>02718                             <span class="keywordflow">if</span> (pToken-&gt;<a class="code" href="class_o_t_token.html#a088fd14cc04aabcf3fcd47a7028b461d">ProcessToken</a>(*pNym, *pMint, *pOriginalToken))
<a name="l02719"></a>02719                             {
<a name="l02720"></a>02720                                 <span class="comment">// Now that it&#39;s processed, let&#39;s save it again.</span>
<a name="l02721"></a>02721                                 pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l02722"></a>02722                                 pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l02723"></a>02723                                 pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02724"></a>02724 
<a name="l02725"></a>02725                                 bSuccess = <span class="keyword">true</span>;
<a name="l02726"></a>02726 
<a name="l02727"></a>02727                                 <span class="comment">// add it to the existing client-side purse for storing tokens of that asset type</span>
<a name="l02728"></a>02728                                 theWalletPurse.<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pNym, *pToken);
<a name="l02729"></a>02729                             }
<a name="l02730"></a>02730                             <span class="keywordflow">else</span> 
<a name="l02731"></a>02731                             {
<a name="l02732"></a>02732                                 bSuccess = <span class="keyword">false</span>;
<a name="l02733"></a>02733                                 <span class="keywordflow">if</span> (pToken)
<a name="l02734"></a>02734                                 {
<a name="l02735"></a>02735                                     <span class="keyword">delete</span> pToken;
<a name="l02736"></a>02736                                     pToken = NULL;
<a name="l02737"></a>02737                                 }
<a name="l02738"></a>02738                                 <span class="comment">// The while loop starts by allocating a pOriginalToken, so I want to </span>
<a name="l02739"></a>02739                                 <span class="comment">// delete it for each iteration and keep things clean.</span>
<a name="l02740"></a>02740                                 <span class="keywordflow">if</span> (pOriginalToken)
<a name="l02741"></a>02741                                 {
<a name="l02742"></a>02742                                     <span class="keyword">delete</span> pOriginalToken;
<a name="l02743"></a>02743                                     pOriginalToken = NULL;
<a name="l02744"></a>02744                                 }                           
<a name="l02745"></a>02745                                 <span class="keywordflow">break</span>;
<a name="l02746"></a>02746                             }
<a name="l02747"></a>02747                         }
<a name="l02748"></a>02748 
<a name="l02749"></a>02749                         <span class="comment">// The while loop starts by allocating a pToken, so I want to </span>
<a name="l02750"></a>02750                         <span class="comment">// delete it for each iteration and keep things clean.</span>
<a name="l02751"></a>02751                         <span class="keywordflow">if</span> (NULL != pToken)
<a name="l02752"></a>02752                         {
<a name="l02753"></a>02753                             <span class="keyword">delete</span> pToken;
<a name="l02754"></a>02754                             pToken = NULL;
<a name="l02755"></a>02755                         }
<a name="l02756"></a>02756                         <span class="comment">// The while loop starts by allocating a pOriginalToken, so I want to </span>
<a name="l02757"></a>02757                         <span class="comment">// delete it for each iteration and keep things clean.</span>
<a name="l02758"></a>02758                         <span class="keywordflow">if</span> (pOriginalToken)
<a name="l02759"></a>02759                         {
<a name="l02760"></a>02760                             <span class="keyword">delete</span> pOriginalToken;
<a name="l02761"></a>02761                             pOriginalToken = NULL;
<a name="l02762"></a>02762                         }
<a name="l02763"></a>02763                     } <span class="comment">// while (pToken = thePurse.Pop(*pNym))</span>
<a name="l02764"></a>02764 
<a name="l02765"></a>02765                     <span class="keywordflow">if</span> (bSuccess)
<a name="l02766"></a>02766                     {
<a name="l02767"></a>02767                         <span class="comment">// Sign it, save it.</span>
<a name="l02768"></a>02768                         theWalletPurse.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// Might as well, they&#39;re no good anyway once the data has changed.</span>
<a name="l02769"></a>02769                         theWalletPurse.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l02770"></a>02770                         theWalletPurse.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l02771"></a>02771                         theWalletPurse.<a class="code" href="class_o_t_purse.html#a40b0557a09d2183149dfc7bbd6145e0d">SavePurse</a>(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetID.Get());
<a name="l02772"></a>02772 
<a name="l02773"></a>02773                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;SUCCESSFULLY UNBLINDED token, and added the cash to the local purse, and saved.\n&quot;</span>);
<a name="l02774"></a>02774                     }
<a name="l02775"></a>02775             } <span class="comment">// if (thePurse.LoadContractFromString(strPurse))</span>
<a name="l02776"></a>02776         }
<a name="l02777"></a>02777     } <span class="comment">// for</span>
<a name="l02778"></a>02778 }
<a name="l02779"></a>02779 
<a name="l02780"></a>02780 
<a name="l02781"></a>02781 
<a name="l02782"></a>02782 
<a name="l02783"></a>02783 
<a name="l02800"></a><a class="code" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">02800</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#a79bcaacfd59042d3e3b384d34f6b16e9">OTClient::ProcessServerReply</a>(<a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theReply, <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pNymbox<span class="comment">/*=NULL*/</span>) <span class="comment">// IF the Nymbox is passed in, then use that one, where appropriate, instead of loading it internally.</span>
<a name="l02801"></a>02801 {
<a name="l02802"></a>02802     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);
<a name="l02803"></a>02803 
<a name="l02804"></a>02804     <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a> &amp; theConnection = (*m_pConnection);
<a name="l02805"></a>02805 
<a name="l02806"></a>02806     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>), SERVER_ID;
<a name="l02807"></a>02807     theConnection.<a class="code" href="class_o_t_server_connection.html#a71bbdb149a8b79ecea4a0909c6251849">GetServerID</a>(SERVER_ID);
<a name="l02808"></a>02808 
<a name="l02809"></a>02809     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>   * pNym = theConnection.<a class="code" href="class_o_t_server_connection.html#a739b2ec134858347a8446d5c7bacbf98">GetNym</a>();
<a name="l02810"></a>02810     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    USER_ID(*pNym);
<a name="l02811"></a>02811     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l02812"></a>02812     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>   * pServerNym = (<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *)(theConnection.<a class="code" href="class_o_t_server_connection.html#aa943d4506c254d30304d681b432971d9">GetServerContract</a>()-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>());
<a name="l02813"></a>02813 
<a name="l02814"></a>02814     <span class="comment">// Just like the server verifies all messages before processing them,</span>
<a name="l02815"></a>02815     <span class="comment">// so does the client need to verify the signatures against each message</span>
<a name="l02816"></a>02816     <span class="comment">// and verify the various contract IDs and signatures.</span>
<a name="l02817"></a>02817     <span class="keywordflow">if</span> (!theReply.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pServerNym)) 
<a name="l02818"></a>02818     {
<a name="l02819"></a>02819         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Server reply signature failed to verify.\n&quot;</span>,
<a name="l02820"></a>02820             __FUNCTION__);
<a name="l02821"></a>02821 
<a name="l02822"></a>02822         <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = &amp;theReply; <span class="comment">// I&#39;m responsible to cleanup this object.</span>
<a name="l02823"></a>02823         <span class="keyword">delete</span> pMessage;
<a name="l02824"></a>02824         pMessage = NULL;
<a name="l02825"></a>02825         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02826"></a>02826     }
<a name="l02827"></a>02827     <span class="comment">// ------------------------------------</span>
<a name="l02828"></a>02828     <a class="code" href="class_o_t_message.html">OTMessage</a> * pSentMsg = this-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#ad60d6fcacb284e4ab9a3acde35bfc796">GetSentMessage</a>(atol(theReply.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()),
<a name="l02829"></a>02829                                                                       strServerID,
<a name="l02830"></a>02830                                                                       strNymID); <span class="comment">// doesn&#39;t delete.</span>
<a name="l02831"></a>02831     <span class="comment">// ------------------------------------</span>
<a name="l02832"></a>02832     <span class="comment">// We couldn&#39;t find it in the &quot;sent message&quot; outbuffer (todo: persist this buffer on the Nym.)</span>
<a name="l02833"></a>02833     <span class="comment">// That means we must have missed the original server reply, even though it DID happen. Then we</span>
<a name="l02834"></a>02834     <span class="comment">// downloaded the Nymbox to re-sync after that failure occurred, and found the reply there, and</span>
<a name="l02835"></a>02835     <span class="comment">// processed it--removing it from the sent messages outbuffer at the same time, since it was now</span>
<a name="l02836"></a>02836     <span class="comment">// definitely handled.</span>
<a name="l02837"></a>02837     <span class="comment">// FINALLY the network comes through with the server reply, and here we are trying to process it</span>
<a name="l02838"></a>02838     <span class="comment">// twice? But this time, it&#39;s NOT in the sent buffer, because we already processed it -- so we</span>
<a name="l02839"></a>02839     <span class="comment">// discard it! (todo: in a nice future version, save all of these in the recordbox or something.)</span>
<a name="l02840"></a>02840     <span class="comment">//</span>
<a name="l02841"></a>02841     <span class="comment">// Here&#39;s another plausible scenario:  You RECEIVE the server&#39;s reply properly the first time, and</span>
<a name="l02842"></a>02842     <span class="comment">// you process it. Of course, you STILL get the Nymbox copy of that same message (&quot;just in case&quot;) and</span>
<a name="l02843"></a>02843     <span class="comment">// thus ProcessServerReply gets called a second time, again leading us to this block of code right here...</span>
<a name="l02844"></a>02844     <span class="comment">//</span>
<a name="l02845"></a>02845     <span class="keywordflow">if</span> (NULL == pSentMsg) <span class="comment">// </span>
<a name="l02846"></a>02846     {
<a name="l02847"></a>02847         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);
<a name="l02848"></a>02848         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: FYI: no record of server reply in sent messages buffer. &quot;</span>
<a name="l02849"></a>02849             <span class="stringliteral">&quot;We must have already processed it, and then removed it, earlier. &quot;</span>
<a name="l02850"></a>02850             <span class="stringliteral">&quot;(Discarding.) Reply message:\n\n%s\n\n&quot;</span>, __FUNCTION__, strReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02851"></a>02851 
<a name="l02852"></a>02852         <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = &amp;theReply; <span class="comment">// I&#39;m responsible to cleanup this object.</span>
<a name="l02853"></a>02853         <span class="keyword">delete</span> pMessage;
<a name="l02854"></a>02854         pMessage = NULL;
<a name="l02855"></a>02855         <span class="comment">// --------------------</span>
<a name="l02856"></a>02856         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02857"></a>02857     }
<a name="l02858"></a>02858     <span class="comment">// ------------------------------------------------</span>
<a name="l02859"></a>02859     <span class="comment">// Below this point, we know we found the original sent message--still cached as though its reply</span>
<a name="l02860"></a>02860     <span class="comment">// hasn&#39;t been processed yet. We haven&#39;t processed it yet! We are now supposedly, processing it for</span>
<a name="l02861"></a>02861     <span class="comment">// the first and proper time! Therefore, let&#39;s remove it from the &quot;sent messages&quot; outbuffer, so we</span>
<a name="l02862"></a>02862     <span class="comment">// are able to tell, next time around, that this has already happened. (After all, we don&#39;t want</span>
<a name="l02863"></a>02863     <span class="comment">// the next FlushSentMessages call to claw back any transaction numbers when we clearly had a proper</span>
<a name="l02864"></a>02864     <span class="comment">// reply come through!)</span>
<a name="l02865"></a>02865     <span class="comment">//</span>
<a name="l02866"></a>02866     <span class="comment">// ------------------------------------</span>
<a name="l02867"></a>02867     <span class="keyword">const</span> int64_t lReplyRequestNum = atol(theReply.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02868"></a>02868 
<a name="l02869"></a>02869     <span class="comment">//  bool bRemoved = </span>
<a name="l02870"></a>02870     this-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#aefe611bcb8fab3e6fe763bfb98ccf86a">RemoveSentMessage</a>(lReplyRequestNum,
<a name="l02871"></a>02871         strServerID,
<a name="l02872"></a>02872         strNymID); <span class="comment">// deletes.</span>
<a name="l02873"></a>02873     <span class="comment">// ------------------------------------</span>
<a name="l02874"></a>02874     <span class="keywordtype">bool</span> bDirtyNym = <span class="keyword">false</span>;
<a name="l02875"></a>02875 
<a name="l02876"></a>02876     <span class="comment">// Similarly we keep a client side list of all the request numbers that we KNOW we have</span>
<a name="l02877"></a>02877     <span class="comment">// a server reply for. (Each ID is maintained until we see a mirror of it appear in the server&#39;s</span>
<a name="l02878"></a>02878     <span class="comment">// copy of that same list, and then we go ahead and remove it. This is basically an optimization</span>
<a name="l02879"></a>02879     <span class="comment">// trick that enables us to avoid downloading many box receipts -- the replyNotices, specifically.)</span>
<a name="l02880"></a>02880     <span class="comment">//</span>
<a name="l02881"></a>02881     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ae6b11aa38ba2894e1d8386d6e5589e2f">AddAcknowledgedNum</a>(strServerID, lReplyRequestNum)) <span class="comment">// doesn&#39;t save (here).</span>
<a name="l02882"></a>02882     {
<a name="l02883"></a>02883         bDirtyNym = <span class="keyword">true</span>;
<a name="l02884"></a>02884     }
<a name="l02885"></a>02885 
<a name="l02886"></a>02886     <span class="comment">// Okay, we received a reply, so we added its request number to our list of &quot;replies we have definitely received.&quot;</span>
<a name="l02887"></a>02887     <span class="comment">// But what about when the server sees that, and mirrors our list? It will send its own list, containing that mirror.</span>
<a name="l02888"></a>02888     <span class="comment">// Any number that appears there, can be removed from the local list (confirmation is total by that point.)</span>
<a name="l02889"></a>02889     <span class="comment">// Clearly the server KNOWS I saw his reply, since he copied my ack into his ack mirror list. Therefore I have no</span>
<a name="l02890"></a>02890     <span class="comment">// more reason to continue telling him that I got the reply -- he already knows it!  So I can remove the number from</span>
<a name="l02891"></a>02891     <span class="comment">// my ack list, which will cause the server to do the same to match, once he gets my next message.</span>
<a name="l02892"></a>02892     <span class="comment">//</span>
<a name="l02893"></a>02893     <span class="comment">// So next step: Loop through the ack list on the server reply, and any numbers there can be REMOVED from the local</span>
<a name="l02894"></a>02894     <span class="comment">// list...</span>
<a name="l02895"></a>02895     <span class="comment">//</span>
<a name="l02896"></a>02896     std::set&lt;int64_t&gt; numlist_ack_reply;    
<a name="l02897"></a>02897     <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a8ebd61b24f8b983cf02a1a49d21e3ec4">m_AcknowledgedReplies</a>.<a class="code" href="class_o_t_num_list.html#a3ebc9e933a8c248d0fdd0b11a3c49fe4">Output</a>(numlist_ack_reply)) <span class="comment">// returns false if the numlist was empty.</span>
<a name="l02898"></a>02898     {
<a name="l02899"></a>02899         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::set&lt;int64_t&gt;, numlist_ack_reply)
<a name="l02900"></a>02900         {
<a name="l02901"></a>02901             <span class="keyword">const</span> int64_t lTempRequestNum = *it;
<a name="l02902"></a>02902             <span class="comment">// ----------------------------</span>
<a name="l02903"></a>02903             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l02904"></a>02904 
<a name="l02905"></a>02905             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0d8fd416811828f1eb8c07eb141790c2">RemoveAcknowledgedNum</a>(*pSignerNym, strServerID, lTempRequestNum, <span class="keyword">false</span>)) <span class="comment">// bSave=false</span>
<a name="l02906"></a>02906                 bDirtyNym = <span class="keyword">true</span>;
<a name="l02907"></a>02907         }
<a name="l02908"></a>02908     }
<a name="l02909"></a>02909     <span class="comment">// ------------------------------------</span>
<a name="l02910"></a>02910 
<a name="l02911"></a>02911     <span class="keywordflow">if</span> (bDirtyNym)
<a name="l02912"></a>02912     {
<a name="l02913"></a>02913         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l02914"></a>02914         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l02915"></a>02915     }
<a name="l02916"></a>02916 
<a name="l02917"></a>02917     <span class="comment">// ------------------------------------</span>
<a name="l02918"></a>02918 
<a name="l02919"></a>02919     <span class="comment">// Done:  Do a Get Sent Message based on request number. If we find the</span>
<a name="l02920"></a>02920     <span class="comment">// sent message, then process the reply and Remove the sent message.</span>
<a name="l02921"></a>02921     <span class="comment">// But if we do NOT find the sent message, then we must have processed it</span>
<a name="l02922"></a>02922     <span class="comment">// already -- in which case discard it and return.</span>
<a name="l02923"></a>02923 
<a name="l02924"></a>02924     <span class="comment">// Here, the Client takes ownership of the message (so make sure it&#39;s heap-allocated.)</span>
<a name="l02925"></a>02925     m_MessageBuffer.<a class="code" href="class_o_t_message_buffer.html#ab7ed0d229c3d12cdf3c7d29e9a8b9192">Push</a>(theReply);
<a name="l02926"></a>02926 
<a name="l02927"></a>02927     <span class="comment">// Once that process is done, everything below that line, in this function,</span>
<a name="l02928"></a>02928     <span class="comment">// will be able to assume there is a verified Nym available, and a Server Contract,</span>
<a name="l02929"></a>02929     <span class="comment">// and an asset contract where applicable, and an account where applicable.</span>
<a name="l02930"></a>02930     <span class="comment">//</span>
<a name="l02931"></a>02931     <span class="comment">// Until that code is written, I do not have those things available to me.</span>
<a name="l02932"></a>02932     <span class="comment">//</span>
<a name="l02933"></a>02933     <span class="comment">// Furthermore also need to verify the payloads...</span>
<a name="l02934"></a>02934     <span class="comment">// If &quot;Command Responding To&quot; was not actually signed by me, and I wasn&#39;t</span>
<a name="l02935"></a>02935     <span class="comment">// expecting the new account request, then I do NOT want to sign it.</span>
<a name="l02936"></a>02936     <span class="comment">//</span>
<a name="l02937"></a>02937     <span class="comment">// Also if the new account is not signed by the server, I don&#39;t want to sign</span>
<a name="l02938"></a>02938     <span class="comment">// it either. Need to check for all these things. Right now just proof of concept.</span>
<a name="l02939"></a>02939 
<a name="l02940"></a>02940     <span class="comment">// Also, assuming all the verification shit is done here, I will have the Nym</span>
<a name="l02941"></a>02941     <span class="comment">// Wait a second, I think I have the Nym already cause there&#39;s a pointer on</span>
<a name="l02942"></a>02942     <span class="comment">// the server connection that was passed in here...</span>
<a name="l02943"></a>02943 
<a name="l02944"></a>02944     <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@triggerClause&quot;</span>))
<a name="l02945"></a>02945     {       
<a name="l02946"></a>02946         <span class="comment">// -----------------------------</span>
<a name="l02947"></a>02947         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
<a name="l02948"></a>02948         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l02949"></a>02949 
<a name="l02950"></a>02950         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02951"></a>02951         {
<a name="l02952"></a>02952             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l02953"></a>02953 
<a name="l02954"></a>02954             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l02955"></a>02955 
<a name="l02956"></a>02956             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l02957"></a>02957                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l02958"></a>02958                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l02959"></a>02959             <span class="keywordflow">else</span>
<a name="l02960"></a>02960             {
<a name="l02961"></a>02961                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l02962"></a>02962                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l02963"></a>02963             }
<a name="l02964"></a>02964         }
<a name="l02965"></a>02965         <span class="comment">// -------------------------------</span>
<a name="l02966"></a>02966 
<a name="l02967"></a>02967         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02968"></a>02968     }
<a name="l02969"></a>02969     <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getRequest&quot;</span>))
<a name="l02970"></a>02970     {
<a name="l02971"></a>02971         int64_t lNewRequestNumber = theReply.<a class="code" href="class_o_t_message.html#a2d3fecf3324ca955abb23d0a4be0af6b">m_lNewRequestNum</a>;
<a name="l02972"></a>02972 
<a name="l02973"></a>02973         <span class="comment">// so the proper request number is sent next time, we take the one that</span>
<a name="l02974"></a>02974         <span class="comment">// the server just sent us, and we ask the wallet to save it somewhere safe </span>
<a name="l02975"></a>02975         <span class="comment">// (like in the nymfile)</span>
<a name="l02976"></a>02976 
<a name="l02977"></a>02977         <span class="comment">// In the future, I will have to write a function on the wallet that actually</span>
<a name="l02978"></a>02978         <span class="comment">// takes the reply, looks up the associated nym in the wallet, verifies</span>
<a name="l02979"></a>02979         <span class="comment">// that it was EXPECTING a response to GetRequest, (cause otherwise it won&#39;t</span>
<a name="l02980"></a>02980         <span class="comment">// know which one to update) and then updates the request number there.</span>
<a name="l02981"></a>02981         <span class="comment">// In the meantime there is only one connection, and it already has a pointer to</span>
<a name="l02982"></a>02982         <span class="comment">// the Nym,  so I&#39;ll just tell it to update the request number that way for now.</span>
<a name="l02983"></a>02983 
<a name="l02984"></a>02984         theConnection.<a class="code" href="class_o_t_server_connection.html#a61901c8c0744a4746b019cfb56973ed6">OnServerResponseToGetRequestNumber</a>(lNewRequestNumber);
<a name="l02985"></a>02985 
<a name="l02986"></a>02986         <span class="comment">// -----------------------------</span>
<a name="l02987"></a>02987         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
<a name="l02988"></a>02988         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l02989"></a>02989 
<a name="l02990"></a>02990         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02991"></a>02991         {
<a name="l02992"></a>02992             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l02993"></a>02993 
<a name="l02994"></a>02994             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l02995"></a>02995 
<a name="l02996"></a>02996             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l02997"></a>02997                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l02998"></a>02998                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l02999"></a>02999             <span class="keywordflow">else</span>
<a name="l03000"></a>03000             {
<a name="l03001"></a>03001                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03002"></a>03002                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03003"></a>03003             }
<a name="l03004"></a>03004         }
<a name="l03005"></a>03005         <span class="comment">// -------------------------------</span>
<a name="l03006"></a>03006 
<a name="l03007"></a>03007         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03008"></a>03008     }
<a name="l03009"></a>03009     <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@checkUser&quot;</span>))
<a name="l03010"></a>03010     {
<a name="l03011"></a>03011         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strNymID2(theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>),
<a name="l03012"></a>03012                         strPubkey(theReply.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// Old style (It&#39;s deprecated to pass a pubkey directly like this.)</span>
<a name="l03013"></a>03013 
<a name="l03014"></a>03014         <span class="comment">// First try to get Credentials, if there are any.</span>
<a name="l03015"></a>03015         <span class="comment">//</span>
<a name="l03016"></a>03016         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor  = theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>;  <span class="comment">// credentialList  (New style! Credentials.)</span>
<a name="l03017"></a>03017         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor2 = theReply.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>; <span class="comment">// credentials</span>
<a name="l03018"></a>03018         <span class="comment">// -----------------------------------------------------</span>
<a name="l03019"></a>03019         <span class="keyword">const</span> <span class="keywordtype">bool</span> bHasCredentials = (ascArmor.Exists() &amp;&amp; ascArmor2.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>());
<a name="l03020"></a>03020         <span class="comment">// -------------------------------------------------</span>
<a name="l03021"></a>03021         <span class="keywordflow">if</span> (bHasCredentials) <span class="comment">// New style of doing things, for Nym keys. Credentials!</span>
<a name="l03022"></a>03022         {            
<a name="l03023"></a>03023             <span class="comment">// -------------------------------------------------</span>
<a name="l03024"></a>03024             <span class="comment">// credentialList</span>
<a name="l03025"></a>03025             <span class="comment">//</span>
<a name="l03026"></a>03026             <a class="code" href="class_o_t_string.html">OTString</a> strCredentialList;
<a name="l03027"></a>03027             ascArmor.GetString(strCredentialList);
<a name="l03028"></a>03028 
<a name="l03029"></a>03029             <span class="keywordflow">if</span> (strCredentialList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03030"></a>03030             {
<a name="l03031"></a>03031                 <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03032"></a>03032                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l03033"></a>03033                 <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l03034"></a>03034                 <span class="comment">// -------------------------------------------------</span>
<a name="l03035"></a>03035                 <span class="keywordflow">if</span> (NULL == pMap)
<a name="l03036"></a>03036                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object in @checkUser.\n&quot;</span>, __FUNCTION__);
<a name="l03037"></a>03037                 <span class="keywordflow">else</span> <span class="comment">// IF the list saved, then we save the credentials themselves...</span>
<a name="l03038"></a>03038                 {
<a name="l03039"></a>03039                     <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l03040"></a>03040                     <span class="comment">// ----------------------------------------</span>
<a name="l03041"></a>03041                     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theTargetNym;
<a name="l03042"></a>03042                     theTargetNym.<a class="code" href="class_o_t_pseudonym.html#a4b5f98378bb2ff1c48c5410f7283aff6">SetIdentifier</a>(strNymID2);
<a name="l03043"></a>03043 
<a name="l03044"></a>03044                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == theTargetNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strCredentialList, &amp;theMap))
<a name="l03045"></a>03045                     {
<a name="l03046"></a>03046                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @checkUser: Failure loading nym %s &quot;</span>
<a name="l03047"></a>03047                             <span class="stringliteral">&quot;from credential string.\n&quot;</span>,
<a name="l03048"></a>03048                             __FUNCTION__, strNymID2.Get());
<a name="l03049"></a>03049                     }
<a name="l03050"></a>03050                     <span class="comment">// Now that the Nym has been loaded up from the message parameters,</span>
<a name="l03051"></a>03051                     <span class="comment">// including the list of credential IDs, and the map containing the</span>
<a name="l03052"></a>03052                     <span class="comment">// credentials themselves, let&#39;s try to Verify the pseudonym. If we</span>
<a name="l03053"></a>03053                     <span class="comment">// verify, then we&#39;re safe to save the credentials to storage.</span>
<a name="l03054"></a>03054                     <span class="comment">//</span>
<a name="l03055"></a>03055                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == theTargetNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
<a name="l03056"></a>03056                     {
<a name="l03057"></a>03057                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @checkUser: Loaded nym %s &quot;</span>
<a name="l03058"></a>03058                             <span class="stringliteral">&quot;from credentials, but then it failed verifying.\n&quot;</span>,
<a name="l03059"></a>03059                             __FUNCTION__, strNymID2.Get());
<a name="l03060"></a>03060                     }
<a name="l03061"></a>03061                     <span class="keywordflow">else</span><span class="comment">// Okay, we loaded the Nym up from the credentials in the message, AND</span>
<a name="l03062"></a>03062                     {   <span class="comment">// verified the Nym (including the credentials.)</span>
<a name="l03063"></a>03063                         <span class="comment">// So let&#39;s save it to local storage...</span>
<a name="l03064"></a>03064                         <span class="comment">//</span>
<a name="l03065"></a>03065                         <span class="comment">// -------------------------------------------------------------</span>
<a name="l03066"></a>03066                         std::string str_nym_id = strNymID2.Get();
<a name="l03067"></a>03067                         <a class="code" href="class_o_t_string.html">OTString</a> strFilename;
<a name="l03068"></a>03068                         strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.cred&quot;</span>, str_nym_id.c_str());
<a name="l03069"></a>03069 
<a name="l03070"></a>03070                         <span class="keywordtype">bool</span> bStoredList = <span class="keyword">false</span>;
<a name="l03071"></a>03071                         <a class="code" href="class_o_t_string.html">OTString</a> strOutput;
<a name="l03072"></a>03072                         <span class="keywordflow">if</span> (ascArmor.Exists() &amp;&amp;
<a name="l03073"></a>03073                             ascArmor.WriteArmoredString(strOutput, <span class="stringliteral">&quot;CREDENTIAL LIST&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
<a name="l03074"></a>03074                             strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03075"></a>03075                             bStoredList = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03076"></a>03076                             <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03077"></a>03077                             strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03078"></a>03078                         <span class="keywordflow">if</span> (!bStoredList)
<a name="l03079"></a>03079                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to armor or store %s.\n&quot;</span>,
<a name="l03080"></a>03080                             __FUNCTION__, strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03081"></a>03081                         <span class="comment">// -------------------------------------------------</span>
<a name="l03082"></a>03082                         <span class="keywordflow">else</span>
<a name="l03083"></a>03083                         {
<a name="l03084"></a>03084                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: Success saving public credential list for Nym: %s\n&quot;</span>, strNymID2.Get());
<a name="l03085"></a>03085                             <span class="comment">// ----------------------------------------</span>
<a name="l03086"></a>03086                             <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>, theMap)
<a name="l03087"></a>03087                             {
<a name="l03088"></a>03088                                 std::string str_cred_id = (*it).first;
<a name="l03089"></a>03089                                 <a class="code" href="class_o_t_string.html">OTString</a>    strCredential((*it).second);
<a name="l03090"></a>03090                                 <span class="comment">// ------------------------------------------</span>
<a name="l03091"></a>03091                                 <span class="keywordtype">bool</span> bStoredCredential = <span class="keyword">false</span>;
<a name="l03092"></a>03092                                 strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03093"></a>03093                                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascLoopArmor(strCredential);
<a name="l03094"></a>03094                                 <span class="keywordflow">if</span> (ascLoopArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
<a name="l03095"></a>03095                                     ascLoopArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput, <span class="stringliteral">&quot;CREDENTIAL&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
<a name="l03096"></a>03096                                     strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03097"></a>03097                                     bStoredCredential = <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03098"></a>03098                                     <a class="code" href="class_o_t_folders.html#a00c7ea89471a90172d166a8c0eb321a6">OTFolders::Pubcred</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l03099"></a>03099                                     str_nym_id,
<a name="l03100"></a>03100                                     str_cred_id);
<a name="l03101"></a>03101                                 <span class="keywordflow">if</span> (!bStoredCredential)
<a name="l03102"></a>03102                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to store credential %s for nym %s.\n&quot;</span>,
<a name="l03103"></a>03103                                     __FUNCTION__, str_cred_id.c_str(), str_nym_id.c_str());
<a name="l03104"></a>03104                                 <span class="keywordflow">else</span>
<a name="l03105"></a>03105                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: Success saving public credential ID: %s\n&quot;</span>, str_cred_id.c_str());
<a name="l03106"></a>03106                                 <span class="comment">// -------------------------------------------------</span>
<a name="l03107"></a>03107                             } <span class="comment">//FOR_EACH</span>
<a name="l03108"></a>03108                             <span class="comment">// ----------------------------------------</span>
<a name="l03109"></a>03109                         } <span class="comment">// Success decoding string map of credential contents.</span>
<a name="l03110"></a>03110                     }
<a name="l03111"></a>03111                 }
<a name="l03112"></a>03112             } <span class="comment">// credential list exists, after base64-decoding.</span>
<a name="l03113"></a>03113         } <span class="comment">// Has Credentials.</span>
<a name="l03114"></a>03114         <span class="comment">// ---------------------------------------------------</span>
<a name="l03115"></a>03115         <span class="comment">// Old-style (deprecated.)</span>
<a name="l03116"></a>03116         <span class="comment">//</span>
<a name="l03117"></a>03117         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strPubkey.Exists())
<a name="l03118"></a>03118         {
<a name="l03119"></a>03119             <span class="comment">// ----------------------------------</span>
<a name="l03120"></a>03120             <a class="code" href="class_o_t_string.html">OTString</a> strPath = strNymID2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l03121"></a>03121             <span class="comment">// ----------------------------------</span>
<a name="l03122"></a>03122             <span class="comment">// Next we save the public key in the pubkeys folder...</span>
<a name="l03123"></a>03123             <span class="comment">//            </span>
<a name="l03124"></a>03124             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> thePubkeyNym(strNymID2);
<a name="l03125"></a>03125 
<a name="l03126"></a>03126             <span class="keywordflow">if</span> (thePubkeyNym.<a class="code" href="class_o_t_pseudonym.html#acd9b375d6c16d11d7d0df1dcf1f543a7">SetPublicKey</a>(strPubkey) &amp;&amp; thePubkeyNym.<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
<a name="l03127"></a>03127             {
<a name="l03128"></a>03128                 <span class="keywordflow">if</span> (thePubkeyNym.<a class="code" href="class_o_t_pseudonym.html#a7f665ecc7e3f70d32e8e7ffbca5b3ce2">SavePublicKey</a>(strPath))
<a name="l03129"></a>03129                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;@checkUser: (Deprecated.) Success saving public key file for Nym: %s\n&quot;</span>, strNymID2.Get());
<a name="l03130"></a>03130             }
<a name="l03131"></a>03131         }
<a name="l03132"></a>03132         <span class="comment">// ---------------------------------------------------</span>
<a name="l03133"></a>03133 
<a name="l03134"></a>03134         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03135"></a>03135     }
<a name="l03136"></a>03136     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@notarizeTransactions&quot;</span>))
<a name="l03137"></a>03137     {
<a name="l03138"></a>03138         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to notarize Transactions message.\n&quot;</span>);
<a name="l03139"></a>03139         <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to notarize Transactions message:\n%s\n&quot;, strReply.Get());</span>
<a name="l03140"></a>03140         <span class="comment">// -----------------------------</span>
<a name="l03141"></a>03141         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
<a name="l03142"></a>03142         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l03143"></a>03143 
<a name="l03144"></a>03144         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03145"></a>03145         {
<a name="l03146"></a>03146             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l03147"></a>03147 
<a name="l03148"></a>03148             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l03149"></a>03149 
<a name="l03150"></a>03150             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l03151"></a>03151                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l03152"></a>03152                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l03153"></a>03153             <span class="keywordflow">else</span>
<a name="l03154"></a>03154             {
<a name="l03155"></a>03155                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03156"></a>03156                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03157"></a>03157             }
<a name="l03158"></a>03158         }
<a name="l03159"></a>03159         <span class="comment">// -------------------------------</span>
<a name="l03160"></a>03160         <a class="code" href="class_o_t_client.html#ac5e35c630a2d920dd510c23815c70ab5">ProcessIncomingTransactions</a>(theConnection, theReply);
<a name="l03161"></a>03161 
<a name="l03162"></a>03162         <span class="comment">//todo (gui):</span>
<a name="l03163"></a>03163         <span class="comment">// This block assumes that the above &quot;@notarizeTransactions&quot;, being successful, probably changed</span>
<a name="l03164"></a>03164         <span class="comment">// the account balance. A nice GUI would probably interpret the reply and edit the local files</span>
<a name="l03165"></a>03165         <span class="comment">// to update them to match (since it was successful). In fact, the above call to ProcessIncomingTransactions</span>
<a name="l03166"></a>03166         <span class="comment">// does some of that sort of stuff already, at least for issued numbers on the nym.</span>
<a name="l03167"></a>03167         <span class="comment">//</span>
<a name="l03168"></a>03168         <span class="comment">// (For now we just re-download the files.)</span>
<a name="l03169"></a>03169         
<a name="l03170"></a>03170         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03171"></a>03171     }
<a name="l03172"></a>03172     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getTransactionNum&quot;</span>))
<a name="l03173"></a>03173     {
<a name="l03174"></a>03174         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to Get Transaction Num message.\n&quot;</span>);
<a name="l03175"></a>03175         <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to Get Transaction Num message:\n%s\n&quot;, strReply.Get());</span>
<a name="l03176"></a>03176 
<a name="l03177"></a>03177         <span class="comment">// -----------------------------</span>
<a name="l03178"></a>03178         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
<a name="l03179"></a>03179         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l03180"></a>03180 
<a name="l03181"></a>03181         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03182"></a>03182         {
<a name="l03183"></a>03183             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l03184"></a>03184 
<a name="l03185"></a>03185             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l03186"></a>03186 
<a name="l03187"></a>03187             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l03188"></a>03188                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l03189"></a>03189                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l03190"></a>03190             <span class="keywordflow">else</span>
<a name="l03191"></a>03191             {
<a name="l03192"></a>03192                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03193"></a>03193                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03194"></a>03194             }
<a name="l03195"></a>03195         }
<a name="l03196"></a>03196         <span class="comment">// -------------------------------</span>
<a name="l03197"></a>03197         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03198"></a>03198     }
<a name="l03199"></a>03199 
<a name="l03200"></a>03200     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getNymbox&quot;</span>))
<a name="l03201"></a>03201     {
<a name="l03202"></a>03202         <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);
<a name="l03203"></a>03203 
<a name="l03204"></a>03204         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received @getNymbox server response (%s)\n&quot;</span>,
<a name="l03205"></a>03205             theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;failure&quot;</span>);
<a name="l03206"></a>03206 
<a name="l03207"></a>03207         <span class="comment">// base64-Decode the server reply&#39;s payload into strInbox</span>
<a name="l03208"></a>03208         <a class="code" href="class_o_t_string.html">OTString</a> strNymbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l03209"></a>03209 
<a name="l03210"></a>03210         <span class="comment">// IF pNymbox NOT NULL, THEN USE IT INSTEAD OF LOADING MY OWN.</span>
<a name="l03211"></a>03211         <span class="comment">// Except... @getNymbox isn&#39;t dropped as a replyNotice into the Nymbox,</span>
<a name="l03212"></a>03212         <span class="comment">// so we&#39;ll never end up here except in cases where it needs to be</span>
<a name="l03213"></a>03213         <span class="comment">// loaded. I can even ASSERT here, that the pointer is actually NULL!</span>
<a name="l03214"></a>03214         <span class="comment">//</span>
<a name="l03215"></a>03215         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL == pNymbox, <span class="stringliteral">&quot;Nymbox pointer is expected to be NULL here, since @getNymbox isn&#39;t dropped as a server replyNotice into the nymbox.&quot;</span>);      
<a name="l03216"></a>03216 
<a name="l03217"></a>03217         <span class="comment">// Load the ledger object from that string.             </span>
<a name="l03218"></a>03218         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(USER_ID, USER_ID, SERVER_ID);    
<a name="l03219"></a>03219 
<a name="l03220"></a>03220         <span class="comment">// -----------------------------</span>
<a name="l03221"></a>03221         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH, RECENT_HASH;
<a name="l03222"></a>03222         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l03223"></a>03223 
<a name="l03224"></a>03224         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03225"></a>03225         {
<a name="l03226"></a>03226             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l03227"></a>03227             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l03228"></a>03228 
<a name="l03229"></a>03229             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ad4e740d990aa8aca410c0923dcde1737">SetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l03230"></a>03230             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l03231"></a>03231 
<a name="l03232"></a>03232             <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l03233"></a>03233                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting NymboxHash on Nym for server: %s\n&quot;</span>,
<a name="l03234"></a>03234                 str_server.c_str());
<a name="l03235"></a>03235             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l03236"></a>03236                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l03237"></a>03237                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l03238"></a>03238             <span class="comment">// ----------------------------------------------------</span>
<a name="l03239"></a>03239             <span class="keywordflow">if</span> (bNymboxHash || bRecentHash)
<a name="l03240"></a>03240             {
<a name="l03241"></a>03241                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03242"></a>03242                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03243"></a>03243             }
<a name="l03244"></a>03244         }
<a name="l03245"></a>03245         <span class="comment">// -------------------------------</span>
<a name="l03246"></a>03246 
<a name="l03247"></a>03247         <span class="comment">// I receive the nymbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
<a name="l03248"></a>03248         <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this nymbox</span>
<a name="l03249"></a>03249         <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
<a name="l03250"></a>03250         <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
<a name="l03251"></a>03251         <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
<a name="l03252"></a>03252         <span class="comment">//</span>
<a name="l03253"></a>03253         <span class="keywordflow">if</span> (theNymbox.<a class="code" href="class_o_t_ledger.html#a7058093dd49939907c448cdf6c4a391a">LoadNymboxFromString</a>(strNymbox)) <span class="comment">// &amp;&amp; theNymbox.VerifyAccount(*pServerNym)) No point doing this, since the client hasn&#39;t even had a chance to download the box receipts yet. (VerifyAccount will fail before then...)</span>
<a name="l03254"></a>03254         {
<a name="l03255"></a>03255 
<a name="l03256"></a>03256             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l03257"></a>03257 
<a name="l03258"></a>03258             <span class="comment">//</span>
<a name="l03259"></a>03259             <span class="comment">// UPDATE: We will have to rely on the Developer using the OT API to call</span>
<a name="l03260"></a>03260             <span class="comment">// OT_API_FlushSentMessages IMMEDIATELY after calling getNymbox and receiving</span>
<a name="l03261"></a>03261             <span class="comment">// a successful reply. Why? Because that&#39;s the only way to give him the chance</span>
<a name="l03262"></a>03262             <span class="comment">// to see if certain replies are there or not (before they get removed.) That way</span>
<a name="l03263"></a>03263             <span class="comment">// he can do his own harvesting, do a re-try, etc and then finally when he is done</span>
<a name="l03264"></a>03264             <span class="comment">// with that, do the flush.</span>
<a name="l03265"></a>03265             <span class="comment">//</span>
<a name="l03266"></a>03266             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l03267"></a>03267 
<a name="l03268"></a>03268             theNymbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own.</span>
<a name="l03269"></a>03269             theNymbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym); <span class="comment">// UPDATE: Releasing the signature again, since Receipts are now fully functional.</span>
<a name="l03270"></a>03270             theNymbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();       <span class="comment">// Thus we can prove the Nymbox using the last signed transaction receipt. This means</span>
<a name="l03271"></a>03271             theNymbox.<a class="code" href="class_o_t_ledger.html#aa2dec5beccd6e4a55cfe45788ebd2137">SaveNymbox</a>();         <span class="comment">// the receipt is our proof, and the nymbox becomes just an intermediary file that is</span>
<a name="l03272"></a>03272                                             <span class="comment">// downloaded occasionally (like checking for new email) but no trust is risked since</span>
<a name="l03273"></a>03273                                             <span class="comment">// the downloaded file is always verified against the receipt!</span>
<a name="l03274"></a>03274         }
<a name="l03275"></a>03275         <span class="keywordflow">else</span> 
<a name="l03276"></a>03276         {
<a name="l03277"></a>03277             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error loading or verifying nymbox during @getNymbox:\n\n%s\n&quot;</span>, strNymbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03278"></a>03278         }
<a name="l03279"></a>03279 
<a name="l03280"></a>03280         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03281"></a>03281     }
<a name="l03282"></a>03282     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03283"></a>03283 
<a name="l03284"></a>03284     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getBoxReceipt&quot;</span>))
<a name="l03285"></a>03285     {
<a name="l03286"></a>03286         <span class="comment">//      OTString strReply(theReply);</span>
<a name="l03287"></a>03287         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received server response to getBoxReceipt request (%s)\n&quot;</span>,
<a name="l03288"></a>03288             theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;failure&quot;</span>);
<a name="l03289"></a>03289 
<a name="l03290"></a>03290         <span class="comment">// IF pNymbox NOT NULL, THEN USE IT INSTEAD OF LOADING MY OWN.</span>
<a name="l03291"></a>03291         <span class="comment">// Except... @getNymbox isn&#39;t dropped as a replyNotice into the Nymbox,</span>
<a name="l03292"></a>03292         <span class="comment">// so we&#39;ll never end up here except in cases where it needs to be</span>
<a name="l03293"></a>03293         <span class="comment">// loaded. I can even ASSERT here, that the pointer is actually NULL!</span>
<a name="l03294"></a>03294         <span class="comment">//</span>
<a name="l03295"></a>03295         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL == pNymbox, <span class="stringliteral">&quot;Nymbox pointer is expected to be NULL here, since @getBoxReceipt isn&#39;t dropped as a server replyNotice into the nymbox.&quot;</span>);
<a name="l03296"></a>03296 
<a name="l03297"></a>03297         <span class="comment">// Note: I don&#39;t HAVE to load the ledger, and what if there are 500000 receipts in it?</span>
<a name="l03298"></a>03298         <span class="comment">// Do I want to reload it EVERY time? Therefore     </span>
<a name="l03299"></a>03299         <span class="keywordtype">bool</span> bErrorCondition = <span class="keyword">false</span>;
<a name="l03300"></a>03300         <span class="keywordtype">bool</span> bSuccessLoading = <span class="keyword">true</span>;    <span class="comment">// We don&#39;t need to load the ledger, so that&#39;s commented out.</span>
<a name="l03301"></a>03301 
<a name="l03302"></a>03302         <span class="keywordflow">switch</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>)
<a name="l03303"></a>03303         {   <span class="comment">// No need to load the ledger at this point...  plus, it would slow things down.</span>
<a name="l03304"></a>03304         <span class="keywordflow">case</span> 0: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadNymbox();  break;</span>
<a name="l03305"></a>03305         <span class="keywordflow">case</span> 1: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadInbox();   break;</span>
<a name="l03306"></a>03306         <span class="keywordflow">case</span> 2: <span class="comment">//bSuccessLoading = pLedger-&gt;LoadOutbox();  break;</span>
<a name="l03307"></a>03307             <span class="keywordflow">break</span>;
<a name="l03308"></a>03308         <span class="keywordflow">default</span>:
<a name="l03309"></a>03309             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Unknown box type: %lld\n&quot;</span>, __FUNCTION__, theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>);
<a name="l03310"></a>03310             bErrorCondition = <span class="keyword">true</span>;
<a name="l03311"></a>03311             <span class="keywordflow">break</span>;
<a name="l03312"></a>03312         }
<a name="l03313"></a>03313         <span class="comment">// ----------------------------------</span>
<a name="l03314"></a>03314 
<a name="l03315"></a>03315         <span class="keywordflow">if</span> (    bSuccessLoading &amp;&amp; !bErrorCondition)
<a name="l03316"></a>03316             <span class="comment">//          &amp;&amp;  pLedger-&gt;VerifyAccount(*pServerNym)) // commenting this out for now -- unnecessary. Plus, it speeds things up to remove this.</span>
<a name="l03317"></a>03317         {
<a name="l03318"></a>03318             <span class="comment">// At this point, the ledger is loaded. Now let&#39;s use it for what we really</span>
<a name="l03319"></a>03319             <span class="comment">// wanted: To save the Box Receipt!</span>
<a name="l03320"></a>03320             <span class="comment">// Update: not loading ledger -- it would slow things down. Added a method that allowed me to circumvent loading it.</span>
<a name="l03321"></a>03321 
<a name="l03322"></a>03322             <span class="comment">// base64-Decode the server reply&#39;s payload into strTransaction</span>
<a name="l03323"></a>03323             <span class="comment">//</span>
<a name="l03324"></a>03324             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTransType(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l03325"></a>03325             <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = NULL;
<a name="l03326"></a>03326 
<a name="l03327"></a>03327             <span class="keywordflow">if</span> (strTransType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03328"></a>03328                 pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strTransType);
<a name="l03329"></a>03329             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType); <span class="comment">// Still works if NULL argument. (Does nothing.)</span>
<a name="l03330"></a>03330 
<a name="l03331"></a>03331             <span class="keywordflow">if</span> (NULL == pTransType)
<a name="l03332"></a>03332                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error instantiating transaction &quot;</span>
<a name="l03333"></a>03333                 <span class="stringliteral">&quot;type based on decoded theReply.m_ascPayload:\n\n%s\n&quot;</span>,
<a name="l03334"></a>03334                 __FUNCTION__, strTransType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03335"></a>03335             <span class="keywordflow">else</span> <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03336"></a>03336             {
<a name="l03337"></a>03337                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pBoxReceipt = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);
<a name="l03338"></a>03338 
<a name="l03339"></a>03339                 <span class="keywordflow">if</span> (NULL == pBoxReceipt)
<a name="l03340"></a>03340                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error dynamic_cast from transaction &quot;</span>
<a name="l03341"></a>03341                     <span class="stringliteral">&quot;type to transaction, based on decoded theReply.m_ascPayload:\n\n%s\n\n&quot;</span>,
<a name="l03342"></a>03342                     __FUNCTION__, strTransType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03343"></a>03343                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03344"></a>03344                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#afba0d981b40568e307178f908788fd7b">VerifyAccount</a>(*pServerNym))
<a name="l03345"></a>03345                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: Box Receipt %lld in %s fails VerifyAccount().\n&quot;</span>,
<a name="l03346"></a>03346                     __FUNCTION__, pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(),
<a name="l03347"></a>03347                     (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0) ? <span class="stringliteral">&quot;nymbox&quot;</span> : ((theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 1) ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>)); <span class="comment">// outbox is 2.);</span>
<a name="l03348"></a>03348                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03349"></a>03349                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>() != theReply.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>)
<a name="l03350"></a>03350                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: Transaction Number doesn&#39;t match &quot;</span>
<a name="l03351"></a>03351                     <span class="stringliteral">&quot;on the box receipt itself (%lld), versus the one listed in the reply message (%lld).\n&quot;</span>,
<a name="l03352"></a>03352                     __FUNCTION__, pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), theReply.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>);
<a name="l03353"></a>03353                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03354"></a>03354                 <span class="comment">// Note: Account ID and Server ID were already verified, in VerifyAccount().                </span>
<a name="l03355"></a>03355                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03356"></a>03356                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>() != USER_ID)
<a name="l03357"></a>03357                 {
<a name="l03358"></a>03358                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPurportedUserID(pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>());
<a name="l03359"></a>03359                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt: Error: NymID doesn&#39;t match &quot;</span>
<a name="l03360"></a>03360                         <span class="stringliteral">&quot;on the box receipt itself (%s), versus the one listed in the reply message (%s).\n&quot;</span>,
<a name="l03361"></a>03361                         __FUNCTION__, strPurportedUserID.Get(), theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03362"></a>03362                 }
<a name="l03363"></a>03363                 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03364"></a>03364                 <span class="keywordflow">else</span>    <span class="comment">// FINALLY we have the Ledger AND the Box Receipt both loaded at the same time.</span>
<a name="l03365"></a>03365 
<a name="l03366"></a>03366                 {       <span class="comment">// UPDATE: Not loading the ledger at this point. Not necessary. Faster without it.</span>
<a name="l03367"></a>03367 
<a name="l03368"></a>03368                     <span class="comment">// UPDATE: We will ASSUME the abbreviated receipt is in the NYMBOX, which is WHY</span>
<a name="l03369"></a>03369                     <span class="comment">// we are now downloading the FULL BOX RECEIPT. We will SAVE it for the Nymbox,</span>
<a name="l03370"></a>03370                     <span class="comment">// which finishes the Nymbox (already in box as abbreviated, and already saved in full</span>
<a name="l03371"></a>03371                     <span class="comment">// in box receipts folder). Next we will also add it to the PAYMENT INBOX and RECORD BOX,</span>
<a name="l03372"></a>03372                     <span class="comment">// if it&#39;s the right sort of receipt. We will also save THEIR versions of the FULL BOX RECEIPT,</span>
<a name="l03373"></a>03373                     <span class="comment">// just as we did for the Nymbox here.</span>
<a name="l03374"></a>03374 
<a name="l03375"></a>03375                     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3bb6c95074edec038831f5282423163f">OTTransaction::instrumentNotice</a>    == pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()) || 
<a name="l03376"></a>03376                         (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a47605348be0f35786bececebacd7170b">OTTransaction::instrumentRejection</a> == pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>()))
<a name="l03377"></a>03377                     {
<a name="l03378"></a>03378                         <span class="comment">// Just make sure not to add it if it&#39;s already there...</span>
<a name="l03379"></a>03379                         <span class="comment">// ------------------------------------------------------</span>
<a name="l03380"></a>03380                         <span class="keywordflow">if</span> (!strServerID.Exists()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %s dosn&#39;t Exist!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;strServerID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l03381"></a>03381                         <span class="keywordflow">if</span> (!strNymID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())    { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: %s dosn&#39;t Exist!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;strNymID&quot;</span>    ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l03382"></a>03382                         <span class="comment">// -----------------------------------------------------</span>
<a name="l03383"></a>03383                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03384"></a>03384                         <span class="comment">// -----------------------------------------------------</span>
<a name="l03385"></a>03385                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
<a name="l03386"></a>03386                         <span class="comment">// ------------------------------------------------------</span>
<a name="l03387"></a>03387                         <span class="keywordtype">bool</span> bSuccessLoading = (bExists &amp;&amp; thePmntInbox.LoadPaymentInbox());
<a name="l03388"></a>03388                         <span class="comment">// -----------------------------------------------------</span>
<a name="l03389"></a>03389                         <span class="keywordflow">if</span> (bExists &amp;&amp; bSuccessLoading)
<a name="l03390"></a>03390                             bSuccessLoading = (thePmntInbox.VerifyContractID() &amp;&amp; 
<a name="l03391"></a>03391                             thePmntInbox.VerifySignature(*pNym));
<a name="l03392"></a>03392                         <span class="comment">//                          bSuccessLoading = (thePmntInbox.VerifyAccount(*pNym)); // (No need here to load all the Box Receipts by using VerifyAccount)</span>
<a name="l03393"></a>03393                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists)
<a name="l03394"></a>03394                             bSuccessLoading = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l03395"></a>03395                         <span class="comment">// -----------------------------------------------------</span>
<a name="l03396"></a>03396                         <span class="comment">// by this point, the nymbox DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
<a name="l03397"></a>03397 
<a name="l03398"></a>03398                         <span class="keywordflow">if</span> (!bSuccessLoading)
<a name="l03399"></a>03399                         {
<a name="l03400"></a>03400                             <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
<a name="l03401"></a>03401                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: @getBoxReceipt: WARNING: Unable to load, verify, or &quot;</span>
<a name="l03402"></a>03402                                 <span class="stringliteral">&quot;generate paymentInbox, with IDs: %s / %s\n&quot;</span>,
<a name="l03403"></a>03403                                 __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03404"></a>03404                         }
<a name="l03405"></a>03405                         <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying their contractID and signature, (OR success generating the ledger.)</span>
<a name="l03406"></a>03406                         {
<a name="l03407"></a>03407                             <span class="comment">// The transaction (which we are putting into the payment inbox) will not</span>
<a name="l03408"></a>03408                             <span class="comment">// be removed from the nymbox until we receive the server&#39;s success reply to</span>
<a name="l03409"></a>03409                             <span class="comment">// this &quot;process Nymbox&quot; message. That&#39;s why you see me adding it here to</span>
<a name="l03410"></a>03410                             <span class="comment">// the payment inbox, while not removing it from the Nymbox (because that</span>
<a name="l03411"></a>03411                             <span class="comment">// will happen once the reply is received.) NOTE: Need to make sure the</span>
<a name="l03412"></a>03412                             <span class="comment">// associated box receipt doesn&#39;t get MARKED FOR DELETION when being removed</span>
<a name="l03413"></a>03413                             <span class="comment">// at that time.</span>
<a name="l03414"></a>03414                             <span class="comment">//</span>
<a name="l03415"></a>03415                             <span class="comment">//                          void load_str_trans_add_to_ledger( const OTIdentifier &amp; the_nym_id,</span>
<a name="l03416"></a>03416                             <span class="comment">//                                                             const OTString &amp; str_trans,</span>
<a name="l03417"></a>03417                             <span class="comment">//                                                             const OTString str_box_type,</span>
<a name="l03418"></a>03418                             <span class="comment">//                                                             const int64_t &amp; lTransNum,</span>
<a name="l03419"></a>03419                             <span class="comment">//                                                             OTPseudonym &amp; the_nym,</span>
<a name="l03420"></a>03420                             <span class="comment">//                                                             OTLedger &amp; ledger );</span>
<a name="l03421"></a>03421 
<a name="l03422"></a>03422                             <span class="comment">// Basically we are taking this receipt from the Nymbox, and also adding copies of it</span>
<a name="l03423"></a>03423                             <span class="comment">// to the paymentInbox and the recordBox.</span>
<a name="l03424"></a>03424                             <span class="comment">//</span>
<a name="l03425"></a>03425                             <span class="comment">// QUESTION: what if I ERASE it out of my recordBox. Won&#39;t it pop back up again?</span>
<a name="l03426"></a>03426                             <span class="comment">// ANSWER: YES, but not if I do this instead at @getBoxReceipt which will only happen once. </span>
<a name="l03427"></a>03427                             <span class="comment">//         UPDATE: which I now AM (see our location here...)</span>
<a name="l03428"></a>03428                             <span class="comment">// HOWEVER: Most likely not, because this notice will no longer BE in my Nymbox...</span>
<a name="l03429"></a>03429                             <span class="comment">//</span>
<a name="l03430"></a>03430                             <span class="comment">// QUESTION: What if I ERASE it out of my paymentInbox? Won&#39;t this pop back there again?</span>
<a name="l03431"></a>03431                             <span class="comment">// ANSWER: I can&#39;t erase it out of there. I can either accept it or reject it. Either way,</span>
<a name="l03432"></a>03432                             <span class="comment">// it is removed from my paymentInbox at that time by OT. Like above, if a copy were still</span>
<a name="l03433"></a>03433                             <span class="comment">// in the Nymbox, I would get a duplicate here when processing Nymbox again. But MOST TIMES,</span>
<a name="l03434"></a>03434                             <span class="comment">// there will be no duplicate, because it will already be cleaned out of my Nymbox anyway.</span>
<a name="l03435"></a>03435                             <span class="comment">//</span>
<a name="l03436"></a>03436                             <span class="comment">// </span>
<a name="l03437"></a>03437                             <span class="keyword">const</span> int64_t lTransNum = pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l03438"></a>03438 
<a name="l03439"></a>03439                             <span class="comment">// If pBoxReceipt-&gt;GetType() is instrument notice, add to the payments inbox.</span>
<a name="l03440"></a>03440                             <span class="comment">// (It will be moved to record box after the incoming payment is deposited or discarded.)</span>
<a name="l03441"></a>03441                             <span class="comment">// </span>
<a name="l03442"></a>03442                             <a class="code" href="_o_t_client_8cpp.html#a182b603418aaaf4ed7186ed6af16a796">load_str_trans_add_to_ledger</a>(USER_ID, strTransType, <span class="stringliteral">&quot;paymentInbox&quot;</span>, lTransNum, *pNym, thePmntInbox);
<a name="l03443"></a>03443                             <span class="comment">//                          load_str_trans_add_to_ledger(USER_ID, strTransType, &quot;recordBox&quot;,    lTransNum, *pNym, theRecordBox); // No longer here. Moved to processDepositResponse</span>
<a name="l03444"></a>03444                             <span class="comment">// --------------------------------------------------------------</span>
<a name="l03445"></a>03445 
<a name="l03446"></a>03446                         } <span class="comment">// --- ELSE --- Success loading the payment inbox and verifying its contractID and signature, OR success generating the ledger.</span>
<a name="l03447"></a>03447                     } <span class="comment">// if pBoxReceipt is instrumentNotice or instrumentRejection...</span>
<a name="l03448"></a>03448                     <span class="comment">// *********************************************************************</span>
<a name="l03449"></a>03449 
<a name="l03450"></a>03450                     <span class="comment">//                  pBoxReceipt-&gt;ReleaseSignatures();</span>
<a name="l03451"></a>03451 
<a name="l03452"></a>03452                     <span class="comment">// I don&#39;t release the server&#39;s signature, so later on I can verify either</span>
<a name="l03453"></a>03453                     <span class="comment">// signature -- the server&#39;s or pNym&#39;s. Both should be on the receipt.</span>
<a name="l03454"></a>03454                     <span class="comment">// UPDATE: We&#39;re not changing the content of the Box Receipt AT ALL</span>
<a name="l03455"></a>03455                     <span class="comment">// because we don&#39;t want to already its message digest, which will be</span>
<a name="l03456"></a>03456                     <span class="comment">// compared to the hash stored in the abbreviated version of the same receipt.</span>
<a name="l03457"></a>03457                     <span class="comment">//</span>
<a name="l03458"></a>03458                     <span class="comment">//                  pBoxReceipt-&gt;SignContract(*pNym);</span>
<a name="l03459"></a>03459                     <span class="comment">//                  pBoxReceipt-&gt;SaveContract();</span>
<a name="l03460"></a>03460 
<a name="l03461"></a>03461                     <span class="comment">//                  if (!pBoxReceipt-&gt;SaveBoxReceipt(*pLedger))             // &lt;===================</span>
<a name="l03462"></a>03462                     <span class="keywordflow">if</span> (!pBoxReceipt-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>))    <span class="comment">// &lt;===================</span>
<a name="l03463"></a>03463                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: @getBoxReceipt(): Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
<a name="l03464"></a>03464                         __FUNCTION__, strTransType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03465"></a>03465                     <span class="comment">/* theReply.m_lDepth in this context stores boxType. Value can be: 0/nymbox,1/inbox,2/outbox*/</span>
<a name="l03466"></a>03466 
<a name="l03467"></a>03467                 } <span class="comment">// We can save the box receipt.</span>
<a name="l03468"></a>03468             } <span class="comment">// Success loading the boxReceipt from the server reply</span>
<a name="l03469"></a>03469         } <span class="comment">// No error condition.</span>
<a name="l03470"></a>03470         <span class="keywordflow">else</span>
<a name="l03471"></a>03471         {
<a name="l03472"></a>03472             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: SHOULD NEVER HAPPEN: @getBoxReceipt: failure &quot;</span>
<a name="l03473"></a>03473                 <span class="stringliteral">&quot;loading box, or verifying it. UserID: %s  AcctID: %s \n&quot;</span>,
<a name="l03474"></a>03474                 __FUNCTION__, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03475"></a>03475         }
<a name="l03476"></a>03476         <span class="comment">// ----------------------------------</span>
<a name="l03477"></a>03477 
<a name="l03478"></a>03478         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03479"></a>03479 
<a name="l03480"></a>03480     }   <span class="comment">// @getBoxReceipt</span>
<a name="l03481"></a>03481     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l03482"></a>03482     <span class="comment">// IN EITHER of these cases, the number of transaction numbers on my Nym has probably changed.</span>
<a name="l03483"></a>03483     <span class="comment">// But the server acknowledgment here confirms it, so I should remove any issued numbers, </span>
<a name="l03484"></a>03484     <span class="comment">// save the nym, etc.</span>
<a name="l03485"></a>03485     <span class="comment">//</span>
<a name="l03486"></a>03486     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp;
<a name="l03487"></a>03487         (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processInbox&quot;</span> ) ||
<a name="l03488"></a>03488         theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processNymbox&quot;</span>) )
<a name="l03489"></a>03489         )
<a name="l03490"></a>03490     {
<a name="l03491"></a>03491         <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strReply(theReply);
<a name="l03492"></a>03492 
<a name="l03493"></a>03493         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Received server response: %s \n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03494"></a>03494         <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to processInbox or processNymbox message:\n%s\n&quot;, strReply.Get());</span>
<a name="l03495"></a>03495         <span class="comment">// -----------------------------</span>
<a name="l03496"></a>03496         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> RECENT_HASH;
<a name="l03497"></a>03497         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l03498"></a>03498 
<a name="l03499"></a>03499         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03500"></a>03500         {
<a name="l03501"></a>03501             RECENT_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l03502"></a>03502 
<a name="l03503"></a>03503             <span class="keyword">const</span> <span class="keywordtype">bool</span> bRecentHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a9c8005d30622ea76cf81c6a9bbfd4d91">SetRecentHash</a>(str_server, RECENT_HASH);
<a name="l03504"></a>03504 
<a name="l03505"></a>03505             <span class="keywordflow">if</span> (!bRecentHash)
<a name="l03506"></a>03506                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash (to store as &#39;recent hash&#39;) from Nym for server: %s\n&quot;</span>,
<a name="l03507"></a>03507                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_server.c_str());
<a name="l03508"></a>03508             <span class="keywordflow">else</span>
<a name="l03509"></a>03509             {
<a name="l03510"></a>03510                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03511"></a>03511                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03512"></a>03512             }
<a name="l03513"></a>03513         }
<a name="l03514"></a>03514         <span class="comment">// -------------------------------</span>
<a name="l03515"></a>03515         <span class="comment">// If the server acknowledges either of the above commands, then my transaction</span>
<a name="l03516"></a>03516         <span class="comment">// numbers have changed. I need to read the numbers from my last transaction agreement</span>
<a name="l03517"></a>03517         <span class="comment">// (which should be saved in this server reply) and make sure to update my nym accordingly.</span>
<a name="l03518"></a>03518         <span class="comment">//</span>
<a name="l03519"></a>03519         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
<a name="l03520"></a>03520         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03521"></a>03521             theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);
<a name="l03522"></a>03522 
<a name="l03523"></a>03523         <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;
<a name="l03524"></a>03524 
<a name="l03525"></a>03525         <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
<a name="l03526"></a>03526             theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
<a name="l03527"></a>03527             theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym)
<a name="l03528"></a>03528             )
<a name="l03529"></a>03529         {
<a name="l03530"></a>03530             <a class="code" href="class_o_t_string.html">OTString</a>    strLedger, strReplyLedger;
<a name="l03531"></a>03531 
<a name="l03532"></a>03532             <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processNymbox&quot;</span>))
<a name="l03533"></a>03533                 ACCOUNT_ID = USER_ID; <span class="comment">// For Nymbox, UserID *is* AcctID.</span>
<a name="l03534"></a>03534 
<a name="l03535"></a>03535             <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theLedger     (USER_ID, ACCOUNT_ID, SERVER_ID),
<a name="l03536"></a>03536                         theReplyLedger(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l03537"></a>03537 
<a name="l03538"></a>03538             theOriginalMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strLedger);
<a name="l03539"></a>03539             theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strReplyLedger);
<a name="l03540"></a>03540             <span class="comment">// -----------------------------------------</span>
<a name="l03541"></a>03541 
<a name="l03542"></a>03542             <span class="keywordflow">if</span> (!strLedger.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03543"></a>03543             {
<a name="l03544"></a>03544                 <a class="code" href="class_o_t_string.html">OTString</a> strLogData(theOriginalMessage);
<a name="l03545"></a>03545                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but found no request ledger within your original message:\n\n%s\n\n&quot;</span>,
<a name="l03546"></a>03546                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLogData.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());             
<a name="l03547"></a>03547             }
<a name="l03548"></a>03548             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strReplyLedger.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03549"></a>03549             {
<a name="l03550"></a>03550                 <a class="code" href="class_o_t_string.html">OTString</a> strReply(theReply);
<a name="l03551"></a>03551                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... received server acknowledgment (%s), but found no reply ledger within:\n\n%s\n\n&quot;</span>,
<a name="l03552"></a>03552                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());               
<a name="l03553"></a>03553             }
<a name="l03554"></a>03554             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theLedger.LoadLedgerFromString(strLedger))
<a name="l03555"></a>03555             {
<a name="l03556"></a>03556                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to load original request ledger from string:\n\n%s\n\n&quot;</span>,
<a name="l03557"></a>03557                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());              
<a name="l03558"></a>03558             }
<a name="l03559"></a>03559             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theLedger.VerifySignature(*pNym))
<a name="l03560"></a>03560             {
<a name="l03561"></a>03561                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to verify your signature on the original request ledger:\n\n%s\n\n&quot;</span>,
<a name="l03562"></a>03562                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());              
<a name="l03563"></a>03563             }
<a name="l03564"></a>03564             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theReplyLedger.<a class="code" href="class_o_t_ledger.html#a472314e803ddaad58d3063c78ef0c22b">LoadLedgerFromString</a>(strReplyLedger))
<a name="l03565"></a>03565             {
<a name="l03566"></a>03566                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to load the reply ledger from string:\n\n%s\n\n&quot;</span>,
<a name="l03567"></a>03567                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReplyLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03568"></a>03568             }
<a name="l03569"></a>03569             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theReplyLedger.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym))
<a name="l03570"></a>03570             {
<a name="l03571"></a>03571                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Strange: Received server acknowledgment (%s), but unable to verify server&#39;s signature on the reply ledger within:\n\n%s\n\n&quot;</span>,
<a name="l03572"></a>03572                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReplyLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03573"></a>03573             }
<a name="l03574"></a>03574             <span class="keywordflow">else</span> 
<a name="l03575"></a>03575             {
<a name="l03576"></a>03576                 <span class="comment">// atAcceptItemReceipt: Whether success or fail, remove the number used from list of responsibility.</span>
<a name="l03577"></a>03577                 <span class="comment">//                      ALSO, if success, remove the number from the original cheque or the original transfer request.</span>
<a name="l03578"></a>03578                 <span class="comment">//</span>
<a name="l03579"></a>03579                 <span class="comment">// Other options are not handled here, but they ARE handled elsewhere (above). They are:</span>
<a name="l03580"></a>03580                 <span class="comment">//</span>
<a name="l03581"></a>03581                 <span class="comment">// atDeposit:       Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l03582"></a>03582                 <span class="comment">// atWithdrawal:    Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l03583"></a>03583                 <span class="comment">// atAcceptPending: Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l03584"></a>03584                 <span class="comment">// atTransfer:      If success, KEEP the number on my issued list. (Remove when transfer receipt is accepted.)</span>
<a name="l03585"></a>03585                 <span class="comment">//                  If failure, REMOVE the number from my issued list. (Use a new one next time.)</span>
<a name="l03586"></a>03586                 <span class="comment">// atMarketOffer:   If success, KEEP the number on my issued list. (Removed when final receipt is created.)</span>
<a name="l03587"></a>03587                 <span class="comment">//                  If failure, REMOVE the number from my issued list. (Use a new one next time.)</span>
<a name="l03588"></a>03588                 <span class="comment">// atCancelCronItem: Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l03589"></a>03589                 <span class="comment">// atExchangeBasket: Whether success or fail, remove the number from my list of responsibility.</span>
<a name="l03590"></a>03590 
<a name="l03591"></a>03591                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction        = NULL;
<a name="l03592"></a>03592                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pReplyTransaction   = NULL;
<a name="l03593"></a>03593 
<a name="l03594"></a>03594                 <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@processInbox&quot;</span>)) <span class="comment">// We&#39;re processing the SERVER&#39;s REPLY to our processInbox request.</span>
<a name="l03595"></a>03595                 {
<a name="l03596"></a>03596                     pTransaction        = theLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a17de28d6bffb971efeebbd9a2fff5ada">OTTransaction::processInbox</a>);
<a name="l03597"></a>03597                     pReplyTransaction   = theReplyLedger.<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ab5e618f93b8a024db636a286a10c433e">OTTransaction::atProcessInbox</a>);
<a name="l03598"></a>03598 
<a name="l03599"></a>03599                     <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l03600"></a>03600                     {
<a name="l03601"></a>03601                         <span class="comment">// pNym-&gt;RemoveTransactionNum() happened whenever I first fired off the processInbox request.</span>
<a name="l03602"></a>03602                         <span class="comment">// Now let&#39;s remove that number from our ISSUED list of responsibility, since we got a server reply...</span>
<a name="l03603"></a>03603                         <span class="comment">//  &lt;====&gt; Whatever trans num I used to process inbox is now OFF my issued list on server side! </span>
<a name="l03604"></a>03604                         <span class="comment">// (Therefore remove here too, to match..)</span>
<a name="l03605"></a>03605                         <span class="comment">//</span>
<a name="l03606"></a>03606                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bIsSignedOut = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l03607"></a>03607 
<a name="l03608"></a>03608                         <span class="comment">// Why? Because we might have already processed this, when it first happened, and now we&#39;re just</span>
<a name="l03609"></a>03609                         <span class="comment">// seeing a repeat of the message from a nymbox notice. (Some messages are so important, you get</span>
<a name="l03610"></a>03610                         <span class="comment">// a nymbox notice including a copy of the message, so the server can make SURE you have processed</span>
<a name="l03611"></a>03611                         <span class="comment">// the reply. This was added to prevent syncing issues between client and server.)</span>
<a name="l03612"></a>03612                         <span class="comment">//</span>
<a name="l03613"></a>03613                         <span class="keywordflow">if</span> (bIsSignedOut)
<a name="l03614"></a>03614                             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
<a name="l03615"></a>03615                         <span class="comment">// --------------------------------------------</span>
<a name="l03616"></a>03616                         <span class="keywordflow">if</span> (bIsSignedOut &amp;&amp; (NULL != pReplyTransaction))
<a name="l03617"></a>03617                         {
<a name="l03618"></a>03618                             <span class="comment">// Load the inbox.              </span>
<a name="l03619"></a>03619                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox    (USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l03620"></a>03620                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l03621"></a>03621 
<a name="l03622"></a>03622                             <span class="keywordtype">bool</span> bInbox = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a6f314709ced53a8c542eb5ef53126b39">OTFolders::Inbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03623"></a>03623 
<a name="l03624"></a>03624                             <span class="keywordflow">if</span> (bInbox &amp;&amp; theInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>())
<a name="l03625"></a>03625                                 bInbox = theInbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym);
<a name="l03626"></a>03626 
<a name="l03627"></a>03627                             <span class="comment">// I JUST had this loaded if I sent acceptWhatever just instants ago, (which I am now processing the reply for.)</span>
<a name="l03628"></a>03628                             <span class="comment">// Therefore I&#39;m just ASSUMING here that it loads successfully here, since it worked an instant ago. Todo.</span>
<a name="l03629"></a>03629                             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bInbox, <span class="stringliteral">&quot;Was trying to load / verify Inbox.&quot;</span>);
<a name="l03630"></a>03630                             <span class="comment">// -------------------------------------</span>
<a name="l03631"></a>03631                             <span class="keywordtype">bool</span> bLoadedRecordBox  = <span class="keyword">false</span>;
<a name="l03632"></a>03632                             <span class="keywordtype">bool</span> bRecordBoxExists  = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03633"></a>03633                             <span class="comment">// -------------------------------------</span>
<a name="l03634"></a>03634                             <span class="comment">// Next, loop through the reply items for each &quot;process inbox&quot; item that I must have previously sent.</span>
<a name="l03635"></a>03635                             <span class="comment">// For each, if successful, remove from inbox.</span>
<a name="l03636"></a>03636                             <span class="comment">// For item receipts, if successful, also remove the appropriate trans# </span>
<a name="l03637"></a>03637                             <span class="comment">// from my issued list of transaction numbers (like above.)</span>
<a name="l03638"></a>03638 
<a name="l03639"></a>03639                             <a class="code" href="_o_t_storage_8hpp.html#a4a94c3435a932ed34e5755f3f472547c">FOR_EACH_IT</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>(), it_bigloop)
<a name="l03640"></a>03640                             {
<a name="l03641"></a>03641                                 <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it_bigloop;
<a name="l03642"></a>03642                                 <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pReplyItem, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Pointer should not have been NULL.&quot;</span>);
<a name="l03643"></a>03643 
<a name="l03644"></a>03644                                 <span class="comment">//                              OTLog::Error(&quot; *** TOP OF LOOP of Reply items, one presumably for each processInbox that I sent previously.\n&quot;);</span>
<a name="l03645"></a>03645 
<a name="l03646"></a>03646                                 <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;
<a name="l03647"></a>03647 
<a name="l03648"></a>03648                                 <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l03649"></a>03649                                 {       
<a name="l03650"></a>03650                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>: 
<a name="l03651"></a>03651                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a>;
<a name="l03652"></a>03652                                     <span class="keywordflow">break</span>;
<a name="l03653"></a>03653                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:
<a name="l03654"></a>03654                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9f650965f11bddf081bb017e1cd0efe0">OTItem::acceptCronReceipt</a>;
<a name="l03655"></a>03655                                     <span class="keywordflow">break</span>;
<a name="l03656"></a>03656                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>:
<a name="l03657"></a>03657                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a357f900e6fdf2a978e3bc03f11d9cc75">OTItem::acceptItemReceipt</a>;
<a name="l03658"></a>03658                                     <span class="keywordflow">break</span>;
<a name="l03659"></a>03659 
<a name="l03660"></a>03660                                     <span class="comment">// ------------------------</span>
<a name="l03661"></a>03661                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a84f21da0049c428f2e74c573dfaff067">OTItem::atRejectPending</a>: <span class="comment">// turn down the money!</span>
<a name="l03662"></a>03662                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a873fcfb43e552e1f81d475fb898e9ac8">OTItem::rejectPending</a>;
<a name="l03663"></a>03663                                     <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
<a name="l03664"></a>03664                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a15fb11d5243db9056a4c340bc49cea43">OTItem::atDisputeCronReceipt</a>: <span class="comment">// dispute a market trade or payment for a payment plan</span>
<a name="l03665"></a>03665                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a0ae31723e4a6a715f4de40bf18aa932f">OTItem::disputeCronReceipt</a>;
<a name="l03666"></a>03666                                     <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
<a name="l03667"></a>03667                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acd9426f6754691aebb202e9c14cdc681">OTItem::atDisputeItemReceipt</a>: <span class="comment">// dispute a cheque receipt or transfer receipt.</span>
<a name="l03668"></a>03668                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4eb8608cbf2db1dd590856c3777e70a2">OTItem::disputeItemReceipt</a>;
<a name="l03669"></a>03669                                     <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
<a name="l03670"></a>03670 
<a name="l03671"></a>03671                                     <span class="comment">// ------------------------</span>
<a name="l03672"></a>03672 
<a name="l03673"></a>03673                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
<a name="l03674"></a>03674                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>;
<a name="l03675"></a>03675                                     <span class="keywordflow">break</span>;
<a name="l03676"></a>03676 
<a name="l03677"></a>03677                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
<a name="l03678"></a>03678                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1aa4bc2fbc10cdf7c47dd361c4c17c605d">OTItem::acceptBasketReceipt</a>;
<a name="l03679"></a>03679                                     <span class="keywordflow">break</span>;
<a name="l03680"></a>03680 
<a name="l03681"></a>03681                                     <span class="comment">// ------------------------</span>
<a name="l03682"></a>03682 
<a name="l03683"></a>03683                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9b353f70c54facca58998d250badcf27">OTItem::atDisputeFinalReceipt</a>:
<a name="l03684"></a>03684                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a62442ecb84d96e94176c7f9b533a9061">OTItem::disputeFinalReceipt</a>;
<a name="l03685"></a>03685                                     <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
<a name="l03686"></a>03686                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a9fc8674f161335439c48b2e9db277b9b">OTItem::atDisputeBasketReceipt</a>:
<a name="l03687"></a>03687                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a69a150fe3a7ec3726dc71d183d572a87">OTItem::disputeBasketReceipt</a>;
<a name="l03688"></a>03688                                     <span class="keywordflow">continue</span>; <span class="comment">// unused</span>
<a name="l03689"></a>03689                                     <span class="comment">// ------------------------</span>
<a name="l03690"></a>03690 
<a name="l03691"></a>03691                                     <span class="comment">// We don&#39;t care about these here.</span>
<a name="l03692"></a>03692                                     <span class="comment">//</span>
<a name="l03693"></a>03693                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>:
<a name="l03694"></a>03694                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1acc6d6f33e3d865c88f56b55d1c06dbec">OTItem::balanceStatement</a>;
<a name="l03695"></a>03695                                     <span class="keywordflow">continue</span>;
<a name="l03696"></a>03696                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>:
<a name="l03697"></a>03697                                     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>;
<a name="l03698"></a>03698                                     <span class="keywordflow">continue</span>;
<a name="l03699"></a>03699 
<a name="l03700"></a>03700                                     <span class="comment">// FYI, on server side, it does not bother to process an item,</span>
<a name="l03701"></a>03701                                     <span class="comment">// if the balance statement or transaction statement has not succeeded.</span>
<a name="l03702"></a>03702                                     <span class="comment">//</span>
<a name="l03703"></a>03703                                     <span class="comment">// Thus, if the ITEM ITSELF has succeeded, that means the balance or</span>
<a name="l03704"></a>03704                                     <span class="comment">// transaction statement MUST have succeeded! Because server wouldn&#39;t have</span>
<a name="l03705"></a>03705                                     <span class="comment">// even bothered to process the item otherwise.</span>
<a name="l03706"></a>03706                                     <span class="comment">//</span>
<a name="l03707"></a>03707                                     <span class="comment">// There still might be some future application in doing something with these</span>
<a name="l03708"></a>03708                                     <span class="comment">// statements when they come in.</span>
<a name="l03709"></a>03709 
<a name="l03710"></a>03710                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l03711"></a>03711 
<a name="l03712"></a>03712                                 <span class="keywordflow">default</span>:
<a name="l03713"></a>03713                                     {
<a name="l03714"></a>03714                                         <span class="keyword">const</span> int32_t nReplyItemType = pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
<a name="l03715"></a>03715 
<a name="l03716"></a>03716                                         <a class="code" href="class_o_t_string.html">OTString</a> strTheType;
<a name="l03717"></a>03717                                         pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTheType);
<a name="l03718"></a>03718 
<a name="l03719"></a>03719                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;*** Unexpected reply item type (%d) in @processInbox, while processing server reply: %s \n&quot;</span>,
<a name="l03720"></a>03720                                             nReplyItemType, strTheType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03721"></a>03721                                         <span class="keywordflow">continue</span>;
<a name="l03722"></a>03722                                     }
<a name="l03723"></a>03723                                 } <span class="comment">// SWITCH</span>
<a name="l03724"></a>03724 
<a name="l03725"></a>03725                                 <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l03726"></a>03726 
<a name="l03727"></a>03727                                 <span class="comment">// The below actions are only necessary if pReplyItem was a SUCCESS.</span>
<a name="l03728"></a>03728                                 <span class="comment">// (Otherwise we skip them...)</span>
<a name="l03729"></a>03729                                 <span class="comment">//</span>
<a name="l03730"></a>03730                                 <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
<a name="l03731"></a>03731                                 pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l03732"></a>03732 
<a name="l03733"></a>03733                                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l03734"></a>03734                                 {
<a name="l03735"></a>03735                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processInbox reply item %s: status == FAILED\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03736"></a>03736                                     <span class="keywordflow">continue</span>;
<a name="l03737"></a>03737                                 }
<a name="l03738"></a>03738                                 <span class="comment">// else</span>
<a name="l03739"></a>03739                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processInbox reply item %s: status == SUCCESS\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03740"></a>03740 
<a name="l03741"></a>03741                                 <span class="comment">// ------------------------------------------------------------------------------------    </span>
<a name="l03742"></a>03742 
<a name="l03743"></a>03743                                 <span class="comment">// WTF IS THIS? There could be 3 acceptPendings, 5 acceptCronReceipts, 3 acceptFinalReceipts, etc </span>
<a name="l03744"></a>03744                                 <span class="comment">// in a single ProcessInbox transaction. Therefore this &quot;get by type&quot; will NOT fly in this case.</span>
<a name="l03745"></a>03745                                 <span class="comment">// (Fixing this now to look it up by ID instead of type.)</span>
<a name="l03746"></a>03746                                 <span class="comment">//</span>
<a name="l03747"></a>03747                                 <span class="comment">//OTItem * pItem = pTransaction-&gt;GetItem(theItemType);</span>
<a name="l03748"></a>03748                                 <span class="comment">//</span>
<a name="l03749"></a>03749                                 <span class="comment">// Can&#39;t do this either:</span>
<a name="l03750"></a>03750                                 <span class="comment">// OTItem * pItem = pTransaction-&gt;GetItemInRefTo(pReplyItem-&gt;GetReferenceToNum());</span>
<a name="l03751"></a>03751                                 <span class="comment">//</span>
<a name="l03752"></a>03752                                 <span class="comment">// (pReplyItem-&gt;GetReferenceToNum() contains the processInbox transaction# of pItem, not</span>
<a name="l03753"></a>03753                                 <span class="comment">//  the inbox receipt # that pItem is in reference to.)</span>
<a name="l03754"></a>03754                                 <span class="comment">//</span>
<a name="l03755"></a>03755                                 <span class="comment">// pTransaction is the processInbox transaction request that I sent.</span>
<a name="l03756"></a>03756                                 <span class="comment">// (The items within it all share its same transaction number, but they are IN REFERENCE TO</span>
<a name="l03757"></a>03757                                 <span class="comment">//  the inbox receipts that they accept/reject.)</span>
<a name="l03758"></a>03758                                 <span class="comment">// pReplyTransaction is the server&#39;s reply to that.</span>
<a name="l03759"></a>03759                                 <span class="comment">// pReplyItem is the current item when iterating through pReplyTransaction.</span>
<a name="l03760"></a>03760                                 <span class="comment">// pItem is the corresponding REQUEST item from pTransaction, that pReplyItem is responding to.</span>
<a name="l03761"></a>03761                                 <span class="comment">//</span>
<a name="l03762"></a>03762                                 <span class="comment">// Therefore: I need to load the original item from pReplyItem&#39;s reference string (it&#39;s bundled in there).</span>
<a name="l03763"></a>03763                                 <span class="comment">// THEN I will get the &quot;in reference to&quot; number from THAT (which is the inbox Receipt #).</span>
<a name="l03764"></a>03764                                 <span class="comment">// THEN I will use that number to look up the SAME original item from pTransaction.</span>
<a name="l03765"></a>03765                                 <span class="comment">// The last step isn&#39;t technically necessary, but may be useful for security.</span>
<a name="l03766"></a>03766                                 <span class="comment">//</span>
<a name="l03767"></a>03767                                 <span class="comment">// Sheesh!</span>
<a name="l03768"></a>03768 
<a name="l03769"></a>03769                                 <a class="code" href="class_o_t_string.html">OTString</a> strProcessInboxItem;
<a name="l03770"></a>03770                                 pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strProcessInboxItem);
<a name="l03771"></a>03771 
<a name="l03772"></a>03772                                 <a class="code" href="class_o_t_item.html">OTItem</a> * pProcessInboxItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strProcessInboxItem, SERVER_ID, pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l03773"></a>03773                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theProcessInboxItemGuardian(pProcessInboxItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>
<a name="l03774"></a>03774 
<a name="l03775"></a>03775                                 <span class="comment">// pProcessInboxItem is already a copy of the correct processInbox item that I need. But still, it&#39;s a copy that the SERVER</span>
<a name="l03776"></a>03776                                 <span class="comment">// sent me. So I&#39;m going to use it to get the reference number that I need, in order to look up MY copy of the item.</span>
<a name="l03777"></a>03777                                 <span class="comment">// So pItem is my original request, inside a processInbox transaction, to accept some receipt from my inbox.</span>
<a name="l03778"></a>03778                                 <span class="comment">// </span>
<a name="l03779"></a>03779                                 <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = 
<a name="l03780"></a>03780                                     (pProcessInboxItem != NULL) ? pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">GetItemInRefTo</a>(pProcessInboxItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()) : NULL;
<a name="l03781"></a>03781 
<a name="l03782"></a>03782                                 <span class="keywordflow">if</span> (NULL == pItem)
<a name="l03783"></a>03783                                 {
<a name="l03784"></a>03784                                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to find original item in original processInbox transaction request, based on reply item.\n&quot;</span>);
<a name="l03785"></a>03785                                     <span class="keywordflow">continue</span>;
<a name="l03786"></a>03786                                 }
<a name="l03787"></a>03787 
<a name="l03788"></a>03788                                 <span class="comment">// If this happens, it means the item we found in our original process inbox transaction, which matched the</span>
<a name="l03789"></a>03789                                 <span class="comment">// &quot;in reference to&quot; number that we expected from the copy of that original item we loaded from within the </span>
<a name="l03790"></a>03790                                 <span class="comment">// pReplyItem that&#39;s supposedly responding to it, does not have the same TYPE that we would have expected it to</span>
<a name="l03791"></a>03791                                 <span class="comment">// have, based on the intelligence in the above switch statement.</span>
<a name="l03792"></a>03792                                 <span class="comment">//</span>
<a name="l03793"></a>03793                                 <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != theItemType)
<a name="l03794"></a>03794                                 {   <span class="comment">// (Possible types for pItem: acceptItemReceipt, acceptPending, acceptCronReceipt, acceptFinalReceipt, acceptBasketReceipt.)</span>
<a name="l03795"></a>03795                                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Wrong original item TYPE, on reply item&#39;s copy of original item, &quot;</span>
<a name="l03796"></a>03796                                         <span class="stringliteral">&quot;than what was expected based on reply item&#39;s type.\n&quot;</span>);
<a name="l03797"></a>03797                                     <span class="keywordflow">continue</span>;
<a name="l03798"></a>03798                                 }
<a name="l03799"></a>03799 
<a name="l03800"></a>03800                                 <span class="comment">// Todo here: any other verification of pItem against pProcessInboxItem, which are supposedly copies of the same item.</span>
<a name="l03801"></a>03801 
<a name="l03802"></a>03802                                 <span class="comment">// FYI, pItem-&gt;GetReferenceToNum() is the ID of the receipt that&#39;s in the inbox.</span>
<a name="l03803"></a>03803                                 <span class="comment">//</span>
<a name="l03804"></a>03804                                 <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l03805"></a>03805 
<a name="l03806"></a>03806                                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;
<a name="l03807"></a>03807 
<a name="l03808"></a>03808                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Checking client-side inbox for expected pending or receipt transaction: %lld... \n&quot;</span>,
<a name="l03809"></a>03809                                     pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// temp remove</span>
<a name="l03810"></a>03810 
<a name="l03811"></a>03811                                 <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l03812"></a>03812                                 {
<a name="l03813"></a>03813                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>:       <span class="comment">// Server reply to my acceptance of pending transfer.</span>
<a name="l03814"></a>03814                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>:   <span class="comment">// Server reply to my acceptance of chequeReceipt, voucherReceipt or transferReceipt.</span>
<a name="l03815"></a>03815 
<a name="l03816"></a>03816                                     pServerTransaction = theInbox.<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l03817"></a>03817                                     <span class="keywordflow">break</span>;
<a name="l03818"></a>03818                                     <span class="comment">// -----------------------</span>
<a name="l03819"></a>03819                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:
<a name="l03820"></a>03820                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
<a name="l03821"></a>03821                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
<a name="l03822"></a>03822                                     pServerTransaction = theInbox.<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l03823"></a>03823                                     <span class="keywordflow">break</span>;
<a name="l03824"></a>03824 
<a name="l03825"></a>03825                                 <span class="keywordflow">default</span>:
<a name="l03826"></a>03826                                     {
<a name="l03827"></a>03827                                         <span class="keyword">const</span> int32_t nReplyItemType = pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>();
<a name="l03828"></a>03828 
<a name="l03829"></a>03829                                         <a class="code" href="class_o_t_string.html">OTString</a> strTheType;
<a name="l03830"></a>03830                                         pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTheType);
<a name="l03831"></a>03831 
<a name="l03832"></a>03832                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;*** Unexpected reply item type (%d) in @processInbox, while processing server reply: %s\n&quot;</span>,
<a name="l03833"></a>03833                                             nReplyItemType, strTheType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03834"></a>03834                                         <span class="keywordflow">break</span>; <span class="comment">// will return just below, where it checks pServerTransaction for NULL.</span>
<a name="l03835"></a>03835                                     }
<a name="l03836"></a>03836                                 }
<a name="l03837"></a>03837 
<a name="l03838"></a>03838                                 <span class="keywordflow">if</span> (NULL == pServerTransaction)
<a name="l03839"></a>03839                                 {
<a name="l03840"></a>03840                                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to find the server&#39;s receipt, in my inbox, that &quot;</span>
<a name="l03841"></a>03841                                         <span class="stringliteral">&quot;my original processInbox&#39;s item was referring to.\n&quot;</span>);
<a name="l03842"></a>03842                                     <span class="keywordflow">break</span>;  <span class="comment">// We must&#39;ve processed this already, and it came through again cause a copy was in a nymbox notice.</span>
<a name="l03843"></a>03843                                 }
<a name="l03844"></a>03844 
<a name="l03845"></a>03845                                 <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l03846"></a>03846 
<a name="l03847"></a>03847                                 <span class="keywordtype">bool</span> bAddToRecordBox = <span class="keyword">true</span>;
<a name="l03848"></a>03848 
<a name="l03849"></a>03849                                 <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l03850"></a>03850 
<a name="l03851"></a>03851                                 <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())  <span class="comment">// All of these need to remove something from the client-side inbox. (Which happens below this switch.)</span>
<a name="l03852"></a>03852                                 {                               <span class="comment">// Some also need to remove an issued transaction number from pNym.</span>
<a name="l03853"></a>03853                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5b0f7bfa18e29ce7d6ebcc861e541f4f">OTItem::atAcceptPending</a>: 
<a name="l03854"></a>03854 
<a name="l03855"></a>03855                                     <span class="keywordflow">break</span>;
<a name="l03856"></a>03856 
<a name="l03857"></a>03857                                     <span class="comment">// ---------------------------------------------------------------</span>
<a name="l03858"></a>03858                                     <span class="comment">// In the case of item receipt (not cron receipt or pending) I need to</span>
<a name="l03859"></a>03859                                     <span class="comment">// remove the issued num from my list of responsibility. (Since I finally</span>
<a name="l03860"></a>03860                                     <span class="comment">// accepted the receipt and closed it out.)</span>
<a name="l03861"></a>03861                                     <span class="comment">//</span>
<a name="l03862"></a>03862                                     <span class="comment">// (Basically closing out the original transfer I must have sent, or cheque I must have written.)</span>
<a name="l03863"></a>03863                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a919386d460c64f76c562aa216523aa9f">OTItem::atAcceptItemReceipt</a>: <span class="comment">// &lt;==================================================</span>
<a name="l03864"></a>03864                                     {
<a name="l03865"></a>03865                                         <span class="comment">// What number do I remove here? the user is accepting a transfer receipt, which</span>
<a name="l03866"></a>03866                                         <span class="comment">// is in reference to the recipient&#39;s acceptPending. THAT item is in reference to</span>
<a name="l03867"></a>03867                                         <span class="comment">// my original transfer (or contains a cheque with my original number.) (THAT&#39;s the # I need.)</span>
<a name="l03868"></a>03868                                         <span class="comment">//</span>
<a name="l03869"></a>03869                                         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItem;
<a name="l03870"></a>03870                                         pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strOriginalItem);
<a name="l03871"></a>03871 
<a name="l03872"></a>03872                                         <a class="code" href="class_o_t_item.html">OTItem</a> * pOriginalItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strOriginalItem, SERVER_ID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l03873"></a>03873                                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theOrigItemGuardian(pOriginalItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>
<a name="l03874"></a>03874 
<a name="l03875"></a>03875                                         <span class="keywordflow">if</span> (NULL != pOriginalItem)
<a name="l03876"></a>03876                                         {
<a name="l03877"></a>03877                                             <span class="comment">// If pOriginalItem is acceptPending, that means I am accepting the transfer receipt from the server, (from my inbox),</span>
<a name="l03878"></a>03878                                             <span class="comment">// which has the recipient&#39;s acceptance inside of my transfer as the original item. This means the transfer that</span>
<a name="l03879"></a>03879                                             <span class="comment">// I originally sent is now finally closed!</span>
<a name="l03880"></a>03880                                             <span class="comment">// </span>
<a name="l03881"></a>03881                                             <span class="comment">// If it&#39;s a depositCheque, that means I am accepting the cheque receipt from the server, (from my inbox)</span>
<a name="l03882"></a>03882                                             <span class="comment">// which has the recipient&#39;s deposit inside of it as the original item. This means that the cheque that</span>
<a name="l03883"></a>03883                                             <span class="comment">// I originally wrote is now finally closed!</span>
<a name="l03884"></a>03884                                             <span class="comment">//</span>
<a name="l03885"></a>03885                                             <span class="comment">// In both cases, the &quot;original item&quot; itself is not from me, but from the recipient! Therefore,</span>
<a name="l03886"></a>03886                                             <span class="comment">// the number on that item is useless for removing numbers from my list of issued numbers.</span>
<a name="l03887"></a>03887                                             <span class="comment">// Rather, I need to load that original cheque, or pending transfer, from WITHIN the original item,</span>
<a name="l03888"></a>03888                                             <span class="comment">// in order to get THAT number, to remove it from my issued list. </span>
<a name="l03889"></a>03889                                             <span class="comment">//                      </span>
<a name="l03890"></a>03890                                             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) <span class="comment">// I am accepting a CHEQUE RECEIPT, which has a depositCheque request (from the recipient) as the original item within.</span>
<a name="l03891"></a>03891                                             {
<a name="l03892"></a>03892                                                 <span class="comment">// Get the cheque from the Item and load it up into a Cheque object.</span>
<a name="l03893"></a>03893                                                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
<a name="l03894"></a>03894                                                 pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strCheque);
<a name="l03895"></a>03895 
<a name="l03896"></a>03896                                                 <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque; <span class="comment">// allocated on the stack :-)</span>
<a name="l03897"></a>03897 
<a name="l03898"></a>03898                                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == ((strCheque.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) &amp;&amp; 
<a name="l03899"></a>03899                                                     theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque)))
<a name="l03900"></a>03900                                                 {
<a name="l03901"></a>03901                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;ERROR loading cheque from string in OTClient::ProcessServerReply:\n%s\n&quot;</span>,
<a name="l03902"></a>03902                                                         strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03903"></a>03903                                                 }
<a name="l03904"></a>03904                                                 <span class="keywordflow">else</span>    <span class="comment">// Since I wrote the cheque, and I am now accepting the cheque receipt, I can now be cleared</span>
<a name="l03905"></a>03905                                                     <span class="comment">// for that issued number. (Because the server reply said SUCCESS accepting the chequeReceipt/voucherReceipt.)</span>
<a name="l03906"></a>03906                                                 {       
<a name="l03907"></a>03907                                                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
<a name="l03908"></a>03908                                                     <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l03909"></a>03909                                                     <span class="comment">/* Inside OT, when processing successful server reply to processInbox request, if a chequeReceipt</span>
<a name="l03910"></a>03910 <span class="comment">                                                    was processed out successfully (here: YES), and if that cheque is found inside the outpayments,</span>
<a name="l03911"></a>03911 <span class="comment">                                                    then move it at that time to the record box. */</span>
<a name="l03912"></a>03912 
<a name="l03913"></a>03913                                                     int32_t lOutpaymentsIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l03914"></a>03914 
<a name="l03915"></a>03915                                                     <span class="keywordflow">if</span> (lOutpaymentsIndex &gt; (-1)) <span class="comment">// found something that matches...</span>
<a name="l03916"></a>03916                                                     {
<a name="l03917"></a>03917                                                         <span class="comment">// Remove it from Outpayments box. We&#39;re done with it -- we accepted the chequeReceipt now.</span>
<a name="l03918"></a>03918                                                         <span class="comment">// (Dump it in records for your app, but OT itself is done with it.)</span>
<a name="l03919"></a>03919                                                         <span class="comment">//</span>
<a name="l03920"></a>03920                                                         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(lOutpaymentsIndex))
<a name="l03921"></a>03921                                                         {
<a name="l03922"></a>03922                                                             <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym)) <span class="comment">// &lt;== save Nym to local storage, since an outpayment was erased.</span>
<a name="l03923"></a>03923                                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving Nym: %s\n&quot;</span>, __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03924"></a>03924                                                         }
<a name="l03925"></a>03925                                                         <span class="comment">// -------------------------------------------------------</span>
<a name="l03926"></a>03926                                                     }
<a name="l03927"></a>03927                                                     <span class="comment">// --------------------------------------------------------</span>
<a name="l03928"></a>03928                                                 }
<a name="l03929"></a>03929                                             }
<a name="l03930"></a>03930                                             <span class="comment">//--------------</span>
<a name="l03931"></a>03931                                             <span class="comment">// I am accepting a TRANSFER RECEIPT, which has an acceptPending inside FROM THE RECIPIENT,</span>
<a name="l03932"></a>03932                                             <span class="comment">// as the original item within, (which is in reference to my outoing original transfer.)</span>
<a name="l03933"></a>03933                                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae3e8669bd29e01bd4ed8d1fa35ba3773">OTItem::acceptPending</a> == pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l03934"></a>03934                                             {
<a name="l03935"></a>03935                                                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#a1d99913429afbd6827becd042fac67a8">GetNumberOfOrigin</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
<a name="l03936"></a>03936                                             }
<a name="l03937"></a>03937                                             <span class="keywordflow">else</span> 
<a name="l03938"></a>03938                                             {
<a name="l03939"></a>03939                                                 <a class="code" href="class_o_t_string.html">OTString</a> strOriginalItemType;
<a name="l03940"></a>03940                                                 pOriginalItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strOriginalItemType);
<a name="l03941"></a>03941                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Original item has wrong type, while accepting item receipt:\n%s\n&quot;</span>,
<a name="l03942"></a>03942                                                     strOriginalItemType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03943"></a>03943                                             }
<a name="l03944"></a>03944                                         }
<a name="l03945"></a>03945                                         <span class="keywordflow">else</span> 
<a name="l03946"></a>03946                                         {
<a name="l03947"></a>03947                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Unable to load original item from string while accepting item receipt:\n%s\n&quot;</span>,
<a name="l03948"></a>03948                                                 strOriginalItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03949"></a>03949                                         }
<a name="l03950"></a>03950                                     } <span class="comment">// OTItem::atAcceptItemReceipt.</span>
<a name="l03951"></a>03951 
<a name="l03952"></a>03952                                     <span class="keywordflow">break</span>;
<a name="l03953"></a>03953 
<a name="l03954"></a>03954                                     <span class="comment">// -------------------------------------------------------------------------------------</span>
<a name="l03955"></a>03955 
<a name="l03956"></a>03956                                     <span class="comment">// Cron Receipt: We do not remove the original trans# until the Cron job is entirely </span>
<a name="l03957"></a>03957                                     <span class="comment">// complete. (Many Cron receipts may breeze through here before that happens.)</span>
<a name="l03958"></a>03958                                     <span class="comment">//</span>
<a name="l03959"></a>03959                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3c0d4b5c591948114dbd2550cccb3b48">OTItem::atAcceptCronReceipt</a>:  
<a name="l03960"></a>03960                                     {
<a name="l03961"></a>03961                                         <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l03962"></a>03962                                         <span class="comment">// If it&#39;s a CRON receipt, find out if it&#39;s from a MARKET TRADE, and if so,</span>
<a name="l03963"></a>03963                                         <span class="comment">// add it to my local list of Market Trades, for the GUI to use on the market panel.</span>
<a name="l03964"></a>03964                                         <span class="comment">//</span>
<a name="l03965"></a>03965                                         <span class="comment">// Todo security: add the actual sale price to boths receipts, along with both amounts,</span>
<a name="l03966"></a>03966                                         <span class="comment">// in order to verify the amount moved is in keeping with the terms of the original offer.</span>
<a name="l03967"></a>03967                                         <span class="comment">//</span>
<a name="l03968"></a>03968                                         <a class="code" href="class_o_t_item.html">OTItem</a> * pServerItem = pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac193ab9b606ec457cfba3410bc12bbfb">OTItem::marketReceipt</a>); <span class="comment">// paymentPlan and smartContract are also POSSIBLE here.</span>
<a name="l03969"></a>03969 
<a name="l03970"></a>03970                                         <span class="keywordflow">if</span> (NULL != pServerItem)
<a name="l03971"></a>03971                                         {
<a name="l03972"></a>03972                                             <a class="code" href="class_o_t_string.html">OTString</a> strOffer, strTrade;
<a name="l03973"></a>03973                                             pServerItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strOffer);   <span class="comment">// contains updated offer.</span>
<a name="l03974"></a>03974                                             pServerItem-&gt;<a class="code" href="class_o_t_item.html#aba1bd99f0402a8918f7847c7a4901206">GetNote</a>(strTrade);         <span class="comment">// contains updated trade.</span>
<a name="l03975"></a>03975 
<a name="l03976"></a>03976                                             <a class="code" href="class_o_t_offer.html">OTOffer</a> theOffer;
<a name="l03977"></a>03977                                             <a class="code" href="class_o_t_trade.html">OTTrade</a> theTrade;
<a name="l03978"></a>03978 
<a name="l03979"></a>03979                                             <span class="keywordtype">bool</span> bLoadOfferFromString = theOffer.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOffer);
<a name="l03980"></a>03980                                             <span class="keywordtype">bool</span> bLoadTradeFromString = theTrade.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTrade);
<a name="l03981"></a>03981                                             <span class="comment">// --------------------------------------------------</span>
<a name="l03982"></a>03982                                             <span class="keywordflow">if</span> (bLoadOfferFromString &amp;&amp; bLoadTradeFromString)
<a name="l03983"></a>03983                                             {
<a name="l03984"></a>03984                                                 <a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> * pData = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a10229b66b8d123dc3eda6370c1ddb022">OTDB::STORED_OBJ_TRADE_DATA_NYM</a>));
<a name="l03985"></a>03985                                                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pData);
<a name="l03986"></a>03986                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeDataNym&gt;</a> theDataAngel(*pData);
<a name="l03987"></a>03987 
<a name="l03988"></a>03988                                                 <span class="comment">/*</span>
<a name="l03989"></a>03989 <span class="comment">                                                std::stringstream ss;</span>
<a name="l03990"></a>03990 <span class="comment">                                                ss &lt;&lt; theTrade.GetTransactionNum();</span>
<a name="l03991"></a>03991 <span class="comment">                                                pData-&gt;transaction_id = ss.str(); ss.str(&quot;&quot;); */</span>
<a name="l03992"></a>03992                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l03993"></a>03993                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#af0dff6aa9d349d3c1db793371479f5b0">transaction_id</a>  = to_string&lt;int64_t&gt;(theTrade.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());     <span class="comment">// TransID for original offer. (Offer may trade many times.)</span>
<a name="l03994"></a>03994                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>      = to_string&lt;int64_t&gt;(pServerItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>()); <span class="comment">// TransID for BOTH receipts for current trade. (Asset/Currency.)</span>
<a name="l03995"></a>03995                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a4b63388a4e4a5b41301e179b6e7b2959">completed_count</a> = to_string&lt;int32_t&gt;(theTrade.<a class="code" href="class_o_t_trade.html#a632e944d79fe44e9cd503a41674b58fd">GetCompletedCount</a>());
<a name="l03996"></a>03996                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l03997"></a>03997                                                 <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_account.html#a6574057f6e3415546d3a9f7d7e445e4f">OTAccount::LoadExistingAccount</a>(ACCOUNT_ID, SERVER_ID);
<a name="l03998"></a>03998                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
<a name="l03999"></a>03999                                                 
<a name="l04000"></a>04000                                                 <span class="keywordtype">bool</span> bIsAsset    = (theTrade.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()    == pAccount-&gt;GetAssetTypeID());
<a name="l04001"></a>04001                                                 <span class="keywordtype">bool</span> bIsCurrency = (theTrade.<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>() == pAccount-&gt;GetAssetTypeID());
<a name="l04002"></a>04002                                                 
<a name="l04003"></a>04003                                                 <span class="keywordflow">if</span> (bIsAsset)
<a name="l04004"></a>04004                                                 {
<a name="l04005"></a>04005 <span class="comment">//                                                  pServerItem-&gt;GetAmount() contains:  (lAmountSold); // asset</span>
<a name="l04006"></a>04006                                                     
<a name="l04007"></a>04007                                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetID(theTrade.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>());
<a name="l04008"></a>04008                                                     int64_t lAssetsThisTrade = pServerItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l04009"></a>04009                                                     pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>       = strAssetID.Get();
<a name="l04010"></a>04010                                                     pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>    = to_string&lt;int64_t&gt;(lAssetsThisTrade); <span class="comment">// The amount of ASSETS moved, this trade.</span>
<a name="l04011"></a>04011                                                 }
<a name="l04012"></a>04012                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bIsCurrency)
<a name="l04013"></a>04013                                                 {
<a name="l04014"></a>04014 <span class="comment">//                                                  pServerItem-&gt;GetAmount() contains:  (lTotalPaidOut); // currency</span>
<a name="l04015"></a>04015                                                     
<a name="l04016"></a>04016                                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCurrencyID(theTrade.<a class="code" href="class_o_t_trade.html#a1a8b6c31bb210b4f5df3d5bfca8efa9b">GetCurrencyID</a>());
<a name="l04017"></a>04017                                                     int64_t lCurrencyThisTrade = pServerItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l04018"></a>04018                                                     pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>      = strCurrencyID.Get();
<a name="l04019"></a>04019                                                     pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>    = to_string&lt;int64_t&gt;(lCurrencyThisTrade);
<a name="l04020"></a>04020                                                 }
<a name="l04021"></a>04021                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l04022"></a>04022                                                 <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> &amp; tProcessDate = theTrade.<a class="code" href="class_o_t_cron_item.html#ad8f19edf794a54644ed4822d0bc120a4">GetLastProcessDate</a>();
<a name="l04023"></a>04023                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ab8aac05fb4457db454bb285419b46484">date</a> = to_string&lt;time64_t&gt;(tProcessDate);
<a name="l04024"></a>04024                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l04025"></a>04025                                                 <span class="comment">// The original offer price. (Might be 0, if it&#39;s a market order.)</span>
<a name="l04026"></a>04026                                                 <span class="comment">//</span>
<a name="l04027"></a>04027                                                 <span class="keyword">const</span> int64_t &amp; lPriceLimit = theOffer.<a class="code" href="class_o_t_offer.html#a8c2771f8fb8cf0ef12f82d9e7b62959f">GetPriceLimit</a>();
<a name="l04028"></a>04028                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a4e628be7c68588a5100f7da1f9db40c5">offer_price</a> = to_string&lt;int64_t&gt;(lPriceLimit);
<a name="l04029"></a>04029                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l04030"></a>04030                                                 <span class="keyword">const</span> int64_t &amp; lFinishedSoFar = theOffer.<a class="code" href="class_o_t_offer.html#ab3b709080aa7c81dcd268fd78eaef262">GetFinishedSoFar</a>();
<a name="l04031"></a>04031                                                 pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a422a8af72d297339f7dab0c54c165616">finished_so_far</a> = to_string&lt;int64_t&gt;(lFinishedSoFar);
<a name="l04032"></a>04032                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l04033"></a>04033                                                 <span class="comment">// save to local storage...</span>
<a name="l04034"></a>04034                                                 <span class="comment">//</span>
<a name="l04035"></a>04035                                                 <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l04036"></a>04036 
<a name="l04037"></a>04037                                                 <a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a> * pList = NULL;
<a name="l04038"></a>04038 
<a name="l04039"></a>04039                                                 <span class="keywordflow">if</span> (<a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
<a name="l04040"></a>04040                                                     <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
<a name="l04041"></a>04041                                                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l04042"></a>04042                                                     strUserID.Get()))
<a name="l04043"></a>04043                                                     pList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#aaf0caee055f843a828e3bac094321886">OTDB::QueryObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2172f96c85edc950ecd14d6c51c71c57">OTDB::STORED_OBJ_TRADE_LIST_NYM</a>, 
<a name="l04044"></a>04044                                                     <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
<a name="l04045"></a>04045                                                     <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
<a name="l04046"></a>04046                                                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l04047"></a>04047                                                     strUserID.Get()));
<a name="l04048"></a>04048                                                 <span class="keywordflow">if</span> (NULL == pList)
<a name="l04049"></a>04049                                                 {
<a name="l04050"></a>04050                                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;Creating storage list of trade receipts for Nym: %s\n&quot;</span>, strUserID.Get());
<a name="l04051"></a>04051                                                     pList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_nym.html">OTDB::TradeListNym</a>*<span class="keyword">&gt;</span>
<a name="l04052"></a>04052                                                         (<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2172f96c85edc950ecd14d6c51c71c57">OTDB::STORED_OBJ_TRADE_LIST_NYM</a>));
<a name="l04053"></a>04053                                                 }
<a name="l04054"></a>04054                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04055"></a>04055                                                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pList);
<a name="l04056"></a>04056                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeListNym&gt;</a> theListAngel(*pList);
<a name="l04057"></a>04057                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04058"></a>04058                                                 <span class="comment">// Loop through and see if we can find one that&#39;s ALREADY there.</span>
<a name="l04059"></a>04059                                                 <span class="comment">// We can match the asset receipt and currency receipt.</span>
<a name="l04060"></a>04060                                                 <span class="comment">// This way we insure there is only one in the end, which combines info from both.</span>
<a name="l04061"></a>04061                                                 <span class="comment">// This also enables us to calculate the sale price!</span>
<a name="l04062"></a>04062                                                 <span class="comment">//</span>
<a name="l04063"></a>04063                                                 <span class="keywordtype">bool</span> bWeFoundIt = <span class="keyword">false</span>;
<a name="l04064"></a>04064                                                 
<a name="l04065"></a>04065                                                 <span class="keywordtype">size_t</span> nTradeDataNymCount = pList-&gt;GetTradeDataNymCount();
<a name="l04066"></a>04066                                                 
<a name="l04067"></a>04067                                                 <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> nym_count = 0; nym_count &lt; nTradeDataNymCount; ++nym_count)
<a name="l04068"></a>04068                                                 {
<a name="l04069"></a>04069                                                     <a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html">OTDB::TradeDataNym</a> * pTradeData = pList-&gt;GetTradeDataNym(nym_count);
<a name="l04070"></a>04070                                                     
<a name="l04071"></a>04071                                                     <span class="keywordflow">if</span> (NULL == pTradeData) <span class="comment">// Should never happen.</span>
<a name="l04072"></a>04072                                                         <span class="keywordflow">continue</span>;
<a name="l04073"></a>04073                                                     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04074"></a>04074                                                     <span class="keywordflow">if</span> (0 == pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>.compare(pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#adc1568e5e6d073cc39b1143197079de7">updated_id</a>)) <span class="comment">// Found it!</span>
<a name="l04075"></a>04075                                                     {
<a name="l04076"></a>04076                                                         <span class="comment">// It&#39;s a repeat of the same one. (Discard.)</span>
<a name="l04077"></a>04077                                                         <span class="keywordflow">if</span> ((!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>   .empty() &amp;&amp; !pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>   .empty()) ||
<a name="l04078"></a>04078                                                             (!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty() &amp;&amp; !pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty()))
<a name="l04079"></a>04079                                                             <span class="keywordflow">break</span>;
<a name="l04080"></a>04080                                                         <span class="comment">// --------------------------------------------------</span>
<a name="l04081"></a>04081                                                         <span class="comment">// Okay looks like one is the asset receipt, and the other is the currency receipt.</span>
<a name="l04082"></a>04082                                                         <span class="comment">// Therefore let&#39;s combine them into pTradeData!</span>
<a name="l04083"></a>04083                                                         <span class="comment">//</span>
<a name="l04084"></a>04084                                                         <span class="keywordflow">if</span> (pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>.empty())
<a name="l04085"></a>04085                                                         {
<a name="l04086"></a>04086                                                             pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>    = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa65d5cebf3f08e820a9742816720646a">asset_id</a>;
<a name="l04087"></a>04087                                                             pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a> = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>;
<a name="l04088"></a>04088                                                         }
<a name="l04089"></a>04089                                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>.empty())
<a name="l04090"></a>04090                                                         {
<a name="l04091"></a>04091                                                             pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>   = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#ae76da6793153234a99d921ba31f43e19">currency_id</a>;
<a name="l04092"></a>04092                                                             pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a> = pData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>;
<a name="l04093"></a>04093                                                         }
<a name="l04094"></a>04094                                                         <span class="comment">// --------------------------------------------------</span>
<a name="l04095"></a>04095                                                         <span class="keywordflow">if</span> (!pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>.empty() &amp;&amp; !pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>.empty())
<a name="l04096"></a>04096                                                         {
<a name="l04097"></a>04097                                                             <span class="keyword">const</span> int64_t lAmountSold   = <a class="code" href="class_o_t_string.html#a3f2489a8c996db1df14479d36af3b76b">OTString::StringToLong</a>(pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#acf848f886e84b5ac326d9eaabb8b06ba">amount_sold</a>);
<a name="l04098"></a>04098                                                             <span class="keyword">const</span> int64_t lCurrencyPaid = <a class="code" href="class_o_t_string.html#a3f2489a8c996db1df14479d36af3b76b">OTString::StringToLong</a>(pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#aa42687f4cda7472c1d8c8515f4fd2e4c">currency_paid</a>);
<a name="l04099"></a>04099                                                             
<a name="l04100"></a>04100                                                             <span class="keywordflow">if</span> (lAmountSold != 0) <span class="comment">// just in case (divide by 0.)</span>
<a name="l04101"></a>04101                                                             {
<a name="l04102"></a>04102                                                                 <span class="keyword">const</span> int64_t lSalePrice = (lCurrencyPaid / lAmountSold);
<a name="l04103"></a>04103                                                                 
<a name="l04104"></a>04104                                                                 <a class="code" href="class_o_t_string.html">OTString</a> strSalePrice;
<a name="l04105"></a>04105                                                                 strSalePrice.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;&quot;</span>, lSalePrice);
<a name="l04106"></a>04106                                                                 
<a name="l04107"></a>04107                                                                 pTradeData-&gt;<a class="code" href="class_o_t_d_b_1_1_trade_data_nym.html#a7be3a27c6e1a914dbc8bd8cbde4e7e5c">price</a> = strSalePrice.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l04108"></a>04108                                                             }
<a name="l04109"></a>04109                                                         }
<a name="l04110"></a>04110                                                         <span class="comment">// ------------------------</span>
<a name="l04111"></a>04111                                                         
<a name="l04112"></a>04112                                                         bWeFoundIt = <span class="keyword">true</span>;
<a name="l04113"></a>04113                                                         
<a name="l04114"></a>04114                                                         <span class="keywordflow">break</span>;
<a name="l04115"></a>04115                                                         
<a name="l04116"></a>04116                                                     } <span class="comment">// if we found it.</span>
<a name="l04117"></a>04117                                                 } <span class="comment">// for</span>
<a name="l04118"></a>04118                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04119"></a>04119                                                 <span class="keywordflow">if</span> (!bWeFoundIt) <span class="comment">// We didn&#39;t find it. So let&#39;s add it.</span>
<a name="l04120"></a>04120                                                 {
<a name="l04121"></a>04121                                                     pList-&gt;AddTradeDataNym(*pData);
<a name="l04122"></a>04122                                                 }
<a name="l04123"></a>04123                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04124"></a>04124                                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a394420b02f48d3ebdfebb75d92a4d6dd">OTDB::StoreObject</a>(*pList,
<a name="l04125"></a>04125                                                     <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),
<a name="l04126"></a>04126                                                     <span class="stringliteral">&quot;trades&quot;</span>, <span class="comment">// todo stop hardcoding.</span>
<a name="l04127"></a>04127                                                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l04128"></a>04128                                                     strUserID.Get()))
<a name="l04129"></a>04129                                                     <span class="comment">// ----------------</span>
<a name="l04130"></a>04130                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::%s: Failed storing list of trades for Nym. Server ID: %s Nym ID: %s \n&quot;</span>,
<a name="l04131"></a>04131                                                                   __FUNCTION__, strServerID.Get(), strUserID.Get());
<a name="l04132"></a>04132                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04133"></a>04133                                             }
<a name="l04134"></a>04134                                         }
<a name="l04135"></a>04135                                         <span class="comment">//else</span>
<a name="l04136"></a>04136                                         <span class="comment">//    OTLog::Error(&quot;OTClient::ProcessServerReply: &quot;</span>
<a name="l04137"></a>04137                                         <span class="comment">//                 &quot;Expected marketReceipt item in transaction in inbox.&quot;);</span>
<a name="l04138"></a>04138                                     } <span class="comment">// OTItem::atAcceptCronReceipt</span>
<a name="l04139"></a>04139 
<a name="l04140"></a>04140                                     <span class="keywordflow">break</span>;
<a name="l04141"></a>04141 
<a name="l04142"></a>04142                                     <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l04143"></a>04143 
<a name="l04144"></a>04144                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
<a name="l04145"></a>04145                                     {
<a name="l04146"></a>04146                                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Successfully removed finalReceipt with closing num: %lld\n&quot;</span>, 
<a name="l04147"></a>04147                                             pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
<a name="l04148"></a>04148                                         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true</span>
<a name="l04149"></a>04149 
<a name="l04150"></a>04150                                         <span class="comment">// -----------------</span>
<a name="l04151"></a>04151                                         <span class="comment">// This should have already been done by this point, but I&#39;m putting it here just in case,</span>
<a name="l04152"></a>04152                                         <span class="comment">// while debugging:</span>
<a name="l04153"></a>04153                                         <span class="comment">//</span>
<a name="l04154"></a>04154                                         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l04155"></a>04155                                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
<a name="l04156"></a>04156                                             pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04157"></a>04157                                         <span class="keywordflow">else</span>
<a name="l04158"></a>04158                                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l04159"></a>04159                                             pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04160"></a>04160                                         <span class="comment">// ----------------------------------------------</span>
<a name="l04161"></a>04161                                         <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l04162"></a>04162                                         <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l04163"></a>04163                                         <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l04164"></a>04164                                         <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l04165"></a>04165                                         <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l04166"></a>04166                                         <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l04167"></a>04167                                         <span class="comment">// It is for the others.</span>
<a name="l04168"></a>04168                                         <span class="comment">//</span>
<a name="l04169"></a>04169                                         <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l04170"></a>04170                                                                            pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l04171"></a>04171                                                                            pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l04172"></a>04172                                     } <span class="comment">// OTItem::atAcceptFinalReceipt</span>
<a name="l04173"></a>04173 
<a name="l04174"></a>04174                                     <span class="keywordflow">break</span>;
<a name="l04175"></a>04175 
<a name="l04176"></a>04176 
<a name="l04177"></a>04177                                     <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l04178"></a>04178 
<a name="l04179"></a>04179                                 <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5901a9fad67b6756c6c6abcb131adc22">OTItem::atAcceptBasketReceipt</a>:
<a name="l04180"></a>04180                                     {
<a name="l04181"></a>04181                                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Successfully removed basketReceipt with closing num: %lld\n&quot;</span>, 
<a name="l04182"></a>04182                                             pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>());
<a name="l04183"></a>04183                                         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#aeaa0c946e4a737e0144cbbf102f37ed4">GetClosingNum</a>(), <span class="keyword">true</span>); <span class="comment">// bool bSave=true    </span>
<a name="l04184"></a>04184                                     } <span class="comment">// OTItem::atAcceptBasketReceipt</span>
<a name="l04185"></a>04185 
<a name="l04186"></a>04186                                     <span class="keywordflow">break</span>;
<a name="l04187"></a>04187 
<a name="l04188"></a>04188                                     <span class="comment">// ---------------------------------------------------------------</span>
<a name="l04189"></a>04189 
<a name="l04190"></a>04190                                 <span class="keywordflow">default</span>: <span class="comment">// Error</span>
<a name="l04191"></a>04191                                     {
<a name="l04192"></a>04192                                         bAddToRecordBox = <span class="keyword">false</span>;
<a name="l04193"></a>04193                                         <span class="comment">// -----------------------</span>
<a name="l04194"></a>04194                                         pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l04195"></a>04195                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: wrong reply item transaction type: %s\n&quot;</span>,
<a name="l04196"></a>04196                                             strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04197"></a>04197                                     }
<a name="l04198"></a>04198                                     <span class="keywordflow">break</span>;
<a name="l04199"></a>04199                                 }   <span class="comment">// switch replyItem type</span>
<a name="l04200"></a>04200                                 <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l04201"></a>04201                                 <span class="keywordflow">if</span> (bAddToRecordBox)
<a name="l04202"></a>04202                                 {
<a name="l04203"></a>04203                                     <span class="keywordflow">if</span> (!bLoadedRecordBox) <span class="comment">// We haven&#39;t loaded / created it yet.</span>
<a name="l04204"></a>04204                                     {
<a name="l04205"></a>04205                                         bLoadedRecordBox = (bRecordBoxExists &amp;&amp; theRecordBox.<a class="code" href="class_o_t_ledger.html#ad283d675ba07160bddde117386b872a6">LoadRecordBox</a>());
<a name="l04206"></a>04206                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l04207"></a>04207                                         <span class="keywordflow">if</span> (bRecordBoxExists &amp;&amp; bLoadedRecordBox)
<a name="l04208"></a>04208                                             bLoadedRecordBox  = (theRecordBox.<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>() &amp;&amp;
<a name="l04209"></a>04209                                             theRecordBox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym));
<a name="l04210"></a>04210                                         <span class="comment">//                                          bLoadedRecordBox  = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
<a name="l04211"></a>04211                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bLoadedRecordBox)
<a name="l04212"></a>04212                                             bLoadedRecordBox  = theRecordBox.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l04213"></a>04213                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l04214"></a>04214                                         <span class="comment">// by this point, the box DEFINITELY exists -- or not. (generation might have failed, or verification.)</span>
<a name="l04215"></a>04215                                         <span class="comment">//</span>
<a name="l04216"></a>04216                                         <span class="keywordflow">if</span> (!bLoadedRecordBox)
<a name="l04217"></a>04217                                         {
<a name="l04218"></a>04218                                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server reply to processInbox: &quot;</span>
<a name="l04219"></a>04219                                                 <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate recordBox, with IDs: %s / %s\n&quot;</span>,
<a name="l04220"></a>04220                                                 __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04221"></a>04221                                         }
<a name="l04222"></a>04222                                     }
<a name="l04223"></a>04223                                     <span class="comment">// ------------------------------------------------------</span>
<a name="l04224"></a>04224                                     <span class="keywordflow">if</span> (bLoadedRecordBox)
<a name="l04225"></a>04225                                     {
<a name="l04226"></a>04226                                         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerTransaction(*pServerTransaction);
<a name="l04227"></a>04227                                         <a class="code" href="class_o_t_transaction.html">OTTransaction</a>     * pNewTransaction = NULL;
<a name="l04228"></a>04228                                         <a class="code" href="class_o_t_transaction_type.html">OTTransactionType</a> * pTransType = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strServerTransaction);
<a name="l04229"></a>04229                                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransactionType&gt;</a> theTransTypeAngel(pTransType);
<a name="l04230"></a>04230 
<a name="l04231"></a>04231                                         <span class="keywordflow">if</span> (NULL != pTransType)
<a name="l04232"></a>04232                                         {
<a name="l04233"></a>04233                                             pNewTransaction = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_transaction.html">OTTransaction</a> *<span class="keyword">&gt;</span>(pTransType);
<a name="l04234"></a>04234                                         }
<a name="l04235"></a>04235                                         <span class="comment">// ------------------------------------------------</span>
<a name="l04236"></a>04236                                         <span class="keywordflow">if</span> (NULL != pNewTransaction)
<a name="l04237"></a>04237                                         {
<a name="l04238"></a>04238                                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pNewTransaction);
<a name="l04239"></a>04239 
<a name="l04240"></a>04240                                             <span class="keywordflow">if</span> (!bAdded)
<a name="l04241"></a>04241                                             {
<a name="l04242"></a>04242                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (still removing &quot;</span>
<a name="l04243"></a>04243                                                     <span class="stringliteral">&quot;it from asset account inbox, however.)\n&quot;</span>, __FUNCTION__,
<a name="l04244"></a>04244                                                     pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l04245"></a>04245                                             }
<a name="l04246"></a>04246                                             <span class="keywordflow">else</span> <span class="comment">// Success adding it to the record box (let&#39;s save it.)</span>
<a name="l04247"></a>04247                                             {
<a name="l04248"></a>04248                                                 theTransTypeAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>
<a name="l04249"></a>04249 
<a name="l04250"></a>04250                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04251"></a>04251                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04252"></a>04252                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04253"></a>04253                                                 <span class="comment">// -------------------------------</span>
<a name="l04254"></a>04254                                                 theRecordBox.<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>(); <span class="comment">// todo log failure.</span>
<a name="l04255"></a>04255 
<a name="l04256"></a>04256                                                 <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
<a name="l04257"></a>04257                                                 <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
<a name="l04258"></a>04258                                                 <span class="comment">//</span>
<a name="l04259"></a>04259                                                 <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
<a name="l04260"></a>04260                                                 <span class="comment">// whenever a receipt is added to a box (here), and deleted after a receipt</span>
<a name="l04261"></a>04261                                                 <span class="comment">// is removed from a box.</span>
<a name="l04262"></a>04262                                                 <span class="comment">//</span>
<a name="l04263"></a>04263                                                 <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
<a name="l04264"></a>04264                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
<a name="l04265"></a>04265                                                     __FUNCTION__, strServerTransaction.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04266"></a>04266                                             }
<a name="l04267"></a>04267                                         } <span class="comment">// if (NULL != pNewTransaction)</span>
<a name="l04268"></a>04268                                         <span class="comment">// -----------------------------------------------------</span>
<a name="l04269"></a>04269                                     } <span class="comment">// if (bLoadedRecordBox)</span>
<a name="l04270"></a>04270                                 } <span class="comment">// if (bAddToRecordBox)</span>
<a name="l04271"></a>04271                                 <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l04272"></a>04272                                 <span class="comment">// REMOVE IT FROM THE INBOX.</span>
<a name="l04273"></a>04273                                 <span class="comment">//</span>
<a name="l04274"></a>04274                                 <span class="comment">// This removal happens for ALL of the above cases.</span>
<a name="l04275"></a>04275                                 <span class="comment">// Update: Now when removing receipts from any box, we have to</span>
<a name="l04276"></a>04276                                 <span class="comment">// also delete the box receipt, which is stored as a separate file.</span>
<a name="l04277"></a>04277                                 <span class="comment">//</span>
<a name="l04278"></a>04278                                 pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(theInbox); <span class="comment">// faster</span>
<a name="l04279"></a>04279                                 <span class="comment">//                              theInbox.DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
<a name="l04280"></a>04280                                 theInbox.<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l04281"></a>04281 
<a name="l04282"></a>04282                             } <span class="comment">// for loop (reply items)</span>
<a name="l04283"></a>04283                             <span class="comment">// ---------------------------------------</span>
<a name="l04284"></a>04284                             <span class="comment">// Save the Inbox</span>
<a name="l04285"></a>04285                             <span class="comment">//</span>
<a name="l04286"></a>04286                             theInbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04287"></a>04287                             theInbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04288"></a>04288                             theInbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04289"></a>04289                             theInbox.<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();                                            
<a name="l04290"></a>04290                             <span class="comment">// ---------------------------------------</span>
<a name="l04291"></a>04291                         } <span class="comment">// if pReplyTransaction</span>
<a name="l04292"></a>04292                     } <span class="comment">// if pTransaction                    </span>
<a name="l04293"></a>04293                 }
<a name="l04294"></a>04294                 <span class="comment">// *********************************************************************************</span>
<a name="l04295"></a>04295                 <span class="comment">//</span>
<a name="l04296"></a>04296                 <span class="keywordflow">else</span>  <span class="comment">// @processNymbox.  // We&#39;re processing the SERVER&#39;s REPLY to our processNymbox request.</span>
<a name="l04297"></a>04297                 {
<a name="l04298"></a>04298                     pTransaction        = theLedger.GetTransaction(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac0914e62639aebd987882e21bdff890d">OTTransaction::processNymbox</a>);
<a name="l04299"></a>04299                     pReplyTransaction   = theReplyLedger.<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8afa0ed45f263e43a61f2315dc723b13f7">OTTransaction::atProcessNymbox</a>);
<a name="l04300"></a>04300 
<a name="l04301"></a>04301                     <span class="comment">// If I have already processed this reply, </span>
<a name="l04302"></a>04302 
<a name="l04303"></a>04303                     <span class="comment">// We did NOT have to burn a transaction number to process the Nymbox, so we don&#39;t</span>
<a name="l04304"></a>04304                     <span class="comment">// have to remove it from the list of responsibility, like we do above.</span>
<a name="l04305"></a>04305                     <span class="comment">// The reason is because the Nymbox cannot be used for financial transactions, since</span>
<a name="l04306"></a>04306                     <span class="comment">// it is associated with a user acct (instead of asset account.)</span>
<a name="l04307"></a>04307                     <span class="comment">// THIS IS ACTUALLY the WHOLE POINT of the Nymbox: If it required a transaction number</span>
<a name="l04308"></a>04308                     <span class="comment">// to process the Nymbox, and you use the Nymbox to get transaction numbers, then how</span>
<a name="l04309"></a>04309                     <span class="comment">// can you ever get a new number if you run out?  You need a number to get a number?</span>
<a name="l04310"></a>04310                     <span class="comment">//</span>
<a name="l04311"></a>04311                     <span class="comment">// That makes no logical sense.  Therefore, the Nymbox provides a way to get new transaction</span>
<a name="l04312"></a>04312                     <span class="comment">// numbers WITHOUT HAVING TO BURN ONE TO DO IT.  You still have to do a transaction statement</span>
<a name="l04313"></a>04313                     <span class="comment">// to do it (sign off on the ones that you actually do have), but you can still process</span>
<a name="l04314"></a>04314                     <span class="comment">// the Nymbox even if you have zero transaction numbers, whereas with the inbox for an asset</span>
<a name="l04315"></a>04315                     <span class="comment">// account, you cannot process it until you burn a transaction number to do so. And if you</span>
<a name="l04316"></a>04316                     <span class="comment">// don&#39;t have any transaction numbers to do that with, that&#39;s fine: you just get a new one</span>
<a name="l04317"></a>04317                     <span class="comment">// via your nymbox.  This is the original reason that I added nymboxes in the first place.</span>
<a name="l04318"></a>04318                     <span class="comment">//</span>
<a name="l04319"></a>04319                     <span class="comment">// SIMILARLY, when a transaction number is REMOVED from our list via the Nymbox, it&#39;s only</span>
<a name="l04320"></a>04320                     <span class="comment">// a NOTIFICATION. The Nymbox cannot actually REMOVE your transaction numbers, but it CAN</span>
<a name="l04321"></a>04321                     <span class="comment">// be used to drop a notice informing you that one was removed. (Usually by a recurring </span>
<a name="l04322"></a>04322                     <span class="comment">// transaction, such as a market offer, where you had already provided the closing number in</span>
<a name="l04323"></a>04323                     <span class="comment">// advance, and you expected that it could be closed at anytime.)</span>
<a name="l04324"></a>04324                     <span class="comment">//</span>
<a name="l04325"></a>04325                     <span class="comment">// ------------------------------------------------------------------</span>
<a name="l04326"></a>04326                     <span class="comment">//</span>
<a name="l04327"></a>04327                     <span class="keywordflow">if</span> ((NULL != pTransaction) &amp;&amp; (NULL != pReplyTransaction))
<a name="l04328"></a>04328                     {
<a name="l04329"></a>04329                         <span class="comment">// HARVEST TRANSACTION NUMBERS (Nymbox only)</span>
<a name="l04330"></a>04330                         <span class="comment">//</span>
<a name="l04331"></a>04331                         <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>);
<a name="l04332"></a>04332 
<a name="l04333"></a>04333                         <span class="comment">// We found it!</span>
<a name="l04334"></a>04334                         <span class="keywordflow">if</span> (NULL == pStatementItem)
<a name="l04335"></a>04335                         {
<a name="l04336"></a>04336                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found transaction in ledger in %s, but didn&#39;t find a transactionStatement item within.\n&quot;</span>,
<a name="l04337"></a>04337                                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04338"></a>04338                         }                           
<a name="l04339"></a>04339                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())
<a name="l04340"></a>04340                         {
<a name="l04341"></a>04341                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Found the receipt you&#39;re talking about, in ledger in %s, but the Server&#39;s Reply transaction says FAILED.\n&quot;</span>,
<a name="l04342"></a>04342                                 theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04343"></a>04343                         }
<a name="l04344"></a>04344                         <span class="keywordflow">else</span>
<a name="l04345"></a>04345                         {
<a name="l04346"></a>04346                             <a class="code" href="class_o_t_string.html">OTString</a>    strMessageNym;
<a name="l04347"></a>04347                             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theMessageNym;
<a name="l04348"></a>04348 
<a name="l04349"></a>04349                             pStatementItem-&gt;<a class="code" href="class_o_t_item.html#aec0f00f6526a35766297615a43429ba5">GetAttachment</a>(strMessageNym);
<a name="l04350"></a>04350 
<a name="l04351"></a>04351                             <span class="keywordflow">if</span> (strMessageNym.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theMessageNym.<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strMessageNym))
<a name="l04352"></a>04352                             {
<a name="l04353"></a>04353                                 <span class="comment">// Success!</span>
<a name="l04354"></a>04354                                 <span class="comment">// Whatever Trans#&#39;s I accepted when I processed my nymbox, I now</span>
<a name="l04355"></a>04355                                 <span class="comment">// harvest them onto my Nym for use. (Couldn&#39;t be sure until server replied &quot;success&quot;.)</span>
<a name="l04356"></a>04356                                 <span class="comment">//</span>
<a name="l04357"></a>04357                                 <span class="comment">// Contrast this with the numbers removed. In the case of Nymbox, I cannot</span>
<a name="l04358"></a>04358                                 <span class="comment">// remove numbers, only receive notice that a number was already removed.</span>
<a name="l04359"></a>04359                                 <span class="comment">// Therefore, I might as well remove it on my side also, as soon as I see that</span>
<a name="l04360"></a>04360                                 <span class="comment">// notice (and approve of it.) There&#39;s no need juggling it in that case -- it&#39;s </span>
<a name="l04361"></a>04361                                 <span class="comment">// already gone. (Therefore it&#39;s already been done by the time we&#39;re in this</span>
<a name="l04362"></a>04362                                 <span class="comment">// function reading the server&#39;s reply. Removals for Nymbox happen in Finalize for</span>
<a name="l04363"></a>04363                                 <span class="comment">// processNymbox, and in AcceptEntireNymbox.)</span>
<a name="l04364"></a>04364                                 <span class="comment">// Below however, are additions, not removals, so we don&#39;t add them until the</span>
<a name="l04365"></a>04365                                 <span class="comment">// server has DEFINITELY responded in the affirmative (here):</span>
<a name="l04366"></a>04366                                 <span class="comment">//</span>
<a name="l04367"></a>04367                                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac140c0c6ab67bb633b0826ad7914761f">HarvestTransactionNumbers</a>(pStatementItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>(), 
<a name="l04368"></a>04368                                     *pNym, theMessageNym, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l04369"></a>04369                                 <span class="comment">// New version now takes tentative numbers into account, to reduce sync issues.</span>
<a name="l04370"></a>04370                                 <span class="comment">//                              pNym-&gt;HarvestIssuedNumbers(pStatementItem-&gt;GetPurportedServerID(), </span>
<a name="l04371"></a>04371                                 <span class="comment">//                                                           *pNym, theMessageNym, true); // bSave=true</span>
<a name="l04372"></a>04372                             }
<a name="l04373"></a>04373                             <span class="keywordflow">else</span>
<a name="l04374"></a>04374                             {
<a name="l04375"></a>04375                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found transaction item in ledger in %s, but didn&#39;t find theMessageNym within.\n&quot;</span>,
<a name="l04376"></a>04376                                     theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04377"></a>04377                             }
<a name="l04378"></a>04378                         }
<a name="l04379"></a>04379 
<a name="l04380"></a>04380                         <span class="comment">// *******************************************************************************</span>
<a name="l04381"></a>04381                         <span class="comment">//</span>
<a name="l04382"></a>04382                         <span class="comment">// REMOVE VARIOUS ITEMS FROM THE LOCAL NYMBOX (THEIR TIME IS DONE.)</span>
<a name="l04383"></a>04383 
<a name="l04384"></a>04384                         <span class="comment">// Load the Nymbox.             </span>
<a name="l04385"></a>04385                         <a class="code" href="class_o_t_ledger.html">OTLedger</a>    theNymbox(USER_ID, USER_ID, SERVER_ID);
<a name="l04386"></a>04386                         <span class="keywordtype">bool</span>        bLoadedNymbox = <span class="keyword">false</span>;
<a name="l04387"></a>04387                         <span class="comment">// ---------------------------------------------------</span>
<a name="l04388"></a>04388                         <span class="keywordflow">if</span> (NULL != pNymbox) <span class="comment">// If a pointer was passed in, then we&#39;ll just use it.</span>
<a name="l04389"></a>04389                         {
<a name="l04390"></a>04390                             bLoadedNymbox = <span class="keyword">true</span>;
<a name="l04391"></a>04391                         }
<a name="l04392"></a>04392                         <span class="keywordflow">else</span> <span class="comment">// Otherwise, we have to load it ourselves. (And point the pointer to it.)</span>
<a name="l04393"></a>04393                         {
<a name="l04394"></a>04394                             pNymbox = &amp;theNymbox;
<a name="l04395"></a>04395                             bLoadedNymbox = (pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>() &amp;&amp; pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym));
<a name="l04396"></a>04396                         }
<a name="l04397"></a>04397                         <span class="comment">// ---------------------------------------------------</span>
<a name="l04398"></a>04398                         <span class="comment">// I JUST had this loaded if I sent acceptWhatever just instants ago, (which I am now processing the reply for.)</span>
<a name="l04399"></a>04399                         <span class="comment">// Therefore I&#39;m just ASSUMING here that it loads successfully here, since it worked an instant ago. Todo.</span>
<a name="l04400"></a>04400                         <span class="comment">//</span>
<a name="l04401"></a>04401                         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bLoadedNymbox, <span class="stringliteral">&quot;Was trying to load Nymbox.&quot;</span>);
<a name="l04402"></a>04402                         <span class="comment">// ---------------------------------------------------</span>
<a name="l04403"></a>04403                         <span class="comment">// Next, loop through the reply items for each &quot;process nymbox&quot; item that I must have previously sent.</span>
<a name="l04404"></a>04404                         <span class="comment">// For each, if successful, remove from inbox.</span>
<a name="l04405"></a>04405                         <span class="comment">// For item receipts, if successful, also remove the appropriate trans# </span>
<a name="l04406"></a>04406                         <span class="comment">// from my issued list of transaction numbers (like above.)</span>
<a name="l04407"></a>04407                         <span class="comment">//</span>
<a name="l04408"></a>04408                         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_item_8hpp.html#afed69f7c75742cc24ea837d6589e9d19">listOfItems</a>, pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a9821c541d3d5f92e378320c6aa190c18">GetItemList</a>())
<a name="l04409"></a>04409                         {
<a name="l04410"></a>04410                             <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = *it;
<a name="l04411"></a>04411                             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pReplyItem, <span class="stringliteral">&quot;OTClient::ProcessServerReply: Pointer should not have been NULL.&quot;</span>);
<a name="l04412"></a>04412 
<a name="l04413"></a>04413                             <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1">OTItem::itemType</a> theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a2990979bdd62bac5b4bc4f6e1a2cc5e6">OTItem::error_state</a>;
<a name="l04414"></a>04414 
<a name="l04415"></a>04415                             <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>()) 
<a name="l04416"></a>04416                             {       
<a name="l04417"></a>04417                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:  <span class="comment">// for inbox this is a closing issued number being removed from your list.</span>
<a name="l04418"></a>04418                                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6c434f644f481079015d0330d6a5efad">OTItem::acceptFinalReceipt</a>;<span class="comment">// but for Nymbox, this is only a notification that it already happened previously.</span>
<a name="l04419"></a>04419                                 <span class="keywordflow">break</span>;
<a name="l04420"></a>04420                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:     theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a6d7747de96495046d982b4eb2a38e46f">OTItem::acceptMessage</a>;     <span class="keywordflow">break</span>;
<a name="l04421"></a>04421                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:      theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a471cb7cb3653b339a64099dde1d26298">OTItem::acceptNotice</a>;      <span class="keywordflow">break</span>;
<a name="l04422"></a>04422                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>: theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a8d437fea3122fe59247f606d7e240118">OTItem::acceptTransaction</a>; <span class="keywordflow">break</span>;
<a name="l04423"></a>04423                                 <span class="comment">// ---------------------------------------------------</span>
<a name="l04424"></a>04424                                 <span class="comment">// FYI, on server side, it does not bother to process an item,</span>
<a name="l04425"></a>04425                                 <span class="comment">// if the balance statement or transaction statement has not succeeded.</span>
<a name="l04426"></a>04426                                 <span class="comment">//</span>
<a name="l04427"></a>04427                                 <span class="comment">// Thus, if the ITEM ITSELF has succeeded, that means the balance or</span>
<a name="l04428"></a>04428                                 <span class="comment">// transaction statement MUST have succeeded! Because server wouldn&#39;t have</span>
<a name="l04429"></a>04429                                 <span class="comment">// even bothered to process the item otherwise.</span>
<a name="l04430"></a>04430                                 <span class="comment">//</span>
<a name="l04431"></a>04431                                 <span class="comment">// There still might be some future application in doing something with these</span>
<a name="l04432"></a>04432                                 <span class="comment">// statements when they come in.</span>
<a name="l04433"></a>04433                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04434"></a>04434                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>:
<a name="l04435"></a>04435                                 theItemType = <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a670c28ed39e72f752c91165aa937c51b">OTItem::transactionStatement</a>; <span class="comment">// We just continue; when this happens, and skip this one.</span>
<a name="l04436"></a>04436                                 <span class="keywordflow">continue</span>; <span class="comment">// (The transaction statement itself is already handled before this &quot;for&quot; loop.)</span>
<a name="l04437"></a>04437 
<a name="l04438"></a>04438                             <span class="keywordflow">default</span>:
<a name="l04439"></a>04439                                 {
<a name="l04440"></a>04440                                     <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
<a name="l04441"></a>04441                                     pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l04442"></a>04442                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected replyItem:type while processing Nymbox: %s \n&quot;</span>,
<a name="l04443"></a>04443                                         __FUNCTION__, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04444"></a>04444                                     <span class="keywordflow">continue</span>;
<a name="l04445"></a>04445                                 }
<a name="l04446"></a>04446                             } <span class="comment">// SWITCH</span>
<a name="l04447"></a>04447                             <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l04448"></a>04448                             <span class="comment">// The below actions are only necessary if pReplyItem was a SUCCESS.</span>
<a name="l04449"></a>04449                             <span class="comment">// (Otherwise we skip them...)</span>
<a name="l04450"></a>04450                             <span class="comment">//</span>
<a name="l04451"></a>04451                             <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
<a name="l04452"></a>04452                             pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l04453"></a>04453 
<a name="l04454"></a>04454                             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> != pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>())
<a name="l04455"></a>04455                             {
<a name="l04456"></a>04456                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processNymbox reply item %s: status == FAILED\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04457"></a>04457                                 <span class="keywordflow">continue</span>;
<a name="l04458"></a>04458                             }
<a name="l04459"></a>04459                             <span class="comment">// else</span>
<a name="l04460"></a>04460                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;@processNymbox reply item %s: status == SUCCESS\n&quot;</span>, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());                            
<a name="l04461"></a>04461                             <span class="comment">// ------------------------------------------------------------------------------------    </span>
<a name="l04462"></a>04462                             <span class="comment">//</span>
<a name="l04463"></a>04463                             <span class="comment">// pReplyItem-&gt;GetReferenceToNum() contains the process transaction# of pItem (0, in</span>
<a name="l04464"></a>04464                             <span class="comment">// a transaction statement, since it usually has no transaction number of its own), not</span>
<a name="l04465"></a>04465                             <span class="comment">// the inbox receipt # that pItem is in reference to.</span>
<a name="l04466"></a>04466                             <span class="comment">//</span>
<a name="l04467"></a>04467                             <span class="comment">// pTransaction is the processNymbox transaction request that I sent.</span>
<a name="l04468"></a>04468                             <span class="comment">// (The items within it all share its same transaction number, but they are IN REFERENCE TO</span>
<a name="l04469"></a>04469                             <span class="comment">//  the Nymbox receipts that they accept/reject.)</span>
<a name="l04470"></a>04470                             <span class="comment">// pReplyTransaction is the server&#39;s reply to that.</span>
<a name="l04471"></a>04471                             <span class="comment">// pReplyItem is the current item when iterating through pReplyTransaction.</span>
<a name="l04472"></a>04472                             <span class="comment">// pItem is the corresponding REQUEST item from pTransaction, that pReplyItem is responding to.</span>
<a name="l04473"></a>04473                             <span class="comment">//</span>
<a name="l04474"></a>04474                             <span class="comment">// Therefore: I need to load the original item from pReplyItem&#39;s reference string (it&#39;s bundled in there).</span>
<a name="l04475"></a>04475                             <span class="comment">// THEN I will get the &quot;in reference to&quot; number from THAT (which is the nymbox Receipt #).</span>
<a name="l04476"></a>04476                             <span class="comment">// THEN I will use that number to look up the SAME original item from pTransaction.</span>
<a name="l04477"></a>04477                             <span class="comment">// The last step isn&#39;t technically necessary, but may be useful for security.</span>
<a name="l04478"></a>04478                             <span class="comment">//</span>
<a name="l04479"></a>04479                             <span class="comment">// Sheesh!</span>
<a name="l04480"></a>04480 
<a name="l04481"></a>04481                             <a class="code" href="class_o_t_string.html">OTString</a> strProcessNymboxItem;
<a name="l04482"></a>04482                             pReplyItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strProcessNymboxItem);
<a name="l04483"></a>04483 
<a name="l04484"></a>04484                             <a class="code" href="class_o_t_item.html">OTItem</a> * pProcessNymboxItem = <a class="code" href="class_o_t_item.html#af742fa1f4ba90d4807bda01a758d2d6a">OTItem::CreateItemFromString</a>(strProcessNymboxItem, 
<a name="l04485"></a>04485                                 SERVER_ID, 
<a name="l04486"></a>04486                                 0 <span class="comment">/* 0 is the &quot;transaction number&quot;*/</span>); <span class="comment">// todo stop hardcoding.</span>
<a name="l04487"></a>04487 
<a name="l04488"></a>04488                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTItem&gt;</a> theProcessNymboxItemGuardian(pProcessNymboxItem); <span class="comment">// So I don&#39;t have to clean it up later. No memory leaks.</span>
<a name="l04489"></a>04489 
<a name="l04490"></a>04490                             <span class="comment">// pProcessNymboxItem is already a copy of the correct processNymbox item that I need. </span>
<a name="l04491"></a>04491                             <span class="comment">// But still, it&#39;s a copy that the SERVER sent me. So I&#39;m going to use it to get the</span>
<a name="l04492"></a>04492                             <span class="comment">// reference number that I need, in order to look up MY copy of the item.</span>
<a name="l04493"></a>04493                             <span class="comment">// </span>
<a name="l04494"></a>04494                             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = 
<a name="l04495"></a>04495                                 (pProcessNymboxItem != NULL) ? pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a45f5abaf0110fbd5abe7ab3a00699703">GetItemInRefTo</a>(pProcessNymboxItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()) : NULL;
<a name="l04496"></a>04496 
<a name="l04497"></a>04497                             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l04498"></a>04498                             {
<a name="l04499"></a>04499                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find original item in original processNymbox &quot;</span>
<a name="l04500"></a>04500                                     <span class="stringliteral">&quot;transaction request, based on reply item.\n&quot;</span>, __FUNCTION__);
<a name="l04501"></a>04501                                 <span class="keywordflow">continue</span>;
<a name="l04502"></a>04502                             }
<a name="l04503"></a>04503                             <span class="comment">// ---------------------------------------------------</span>
<a name="l04504"></a>04504                             <span class="comment">// If this happens, it means the item we found in our original process Nymbox transaction, which matched the</span>
<a name="l04505"></a>04505                             <span class="comment">// &quot;in reference to&quot; number that we expected from the copy of that original item we loaded from within the </span>
<a name="l04506"></a>04506                             <span class="comment">// pReplyItem that&#39;s supposedly responding to it, does not have the same TYPE that we would have expected it to</span>
<a name="l04507"></a>04507                             <span class="comment">// have, based on the intelligence in the above switch statement.</span>
<a name="l04508"></a>04508                             <span class="comment">//</span>
<a name="l04509"></a>04509                             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>() != theItemType)
<a name="l04510"></a>04510                             {   <span class="comment">// (Possible types for pItem: acceptMessage, acceptNotice, acceptTransactions, acceptFinalReceipt.)</span>
<a name="l04511"></a>04511                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong original item TYPE, on reply item&#39;s copy of original item, &quot;</span>
<a name="l04512"></a>04512                                     <span class="stringliteral">&quot;than what was expected based on reply item&#39;s type.\n&quot;</span>, __FUNCTION__);
<a name="l04513"></a>04513                                 <span class="keywordflow">continue</span>;
<a name="l04514"></a>04514                             }
<a name="l04515"></a>04515 
<a name="l04516"></a>04516                             <span class="comment">// Todo here: any other verification of pItem against pProcessNymboxItem, which are supposedly copies of the same item.</span>
<a name="l04517"></a>04517                             <span class="comment">// (Potentially todo security.)</span>
<a name="l04518"></a>04518 
<a name="l04519"></a>04519                             <span class="comment">// FYI, pItem-&gt;GetReferenceToNum() is the ID of the receipt that&#39;s in the Nymbox.</span>
<a name="l04520"></a>04520                             <span class="comment">//                                </span>
<a name="l04521"></a>04521                             <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l04522"></a>04522                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pServerTransaction = NULL;
<a name="l04523"></a>04523 
<a name="l04524"></a>04524                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Checking client-side Nymbox for expected Nymbox item: %lld... \n&quot;</span>,
<a name="l04525"></a>04525                                 __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>()); <span class="comment">// temp remove</span>
<a name="l04526"></a>04526 
<a name="l04527"></a>04527                             <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())
<a name="l04528"></a>04528                             {
<a name="l04529"></a>04529                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:
<a name="l04530"></a>04530                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:
<a name="l04531"></a>04531                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>:
<a name="l04532"></a>04532                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
<a name="l04533"></a>04533                                 pServerTransaction = pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04534"></a>04534                                 <span class="keywordflow">break</span>;
<a name="l04535"></a>04535 
<a name="l04536"></a>04536                             <span class="keywordflow">default</span>:
<a name="l04537"></a>04537                                 {
<a name="l04538"></a>04538                                     <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
<a name="l04539"></a>04539                                     pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l04540"></a>04540                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unexpected replyItem::type while processing Nymbox: %s \n&quot;</span>, 
<a name="l04541"></a>04541                                         __FUNCTION__, strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04542"></a>04542                                     <span class="keywordflow">break</span>;
<a name="l04543"></a>04543                                 }
<a name="l04544"></a>04544                             }
<a name="l04545"></a>04545                             <span class="comment">// ---------------------------------------------------</span>
<a name="l04546"></a>04546                             <span class="keywordflow">if</span> (NULL == pServerTransaction)
<a name="l04547"></a>04547                             {
<a name="l04548"></a>04548                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: The original processNymbox item referred to trans number %lld, but that receipt wasn&#39;t in my Nymbox. &quot;</span>
<a name="l04549"></a>04549                                     <span class="stringliteral">&quot;(We probably processed this server reply ALREADY, and now we&#39;re just seeing it again, since an extra copy &quot;</span>
<a name="l04550"></a>04550                                     <span class="stringliteral">&quot;was dropped into the Nymbox originally. It happens. Skipping.)&quot;</span>, __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l04551"></a>04551                                 <span class="keywordflow">break</span>; <span class="comment">// We must have processed this reply already, and it just came through again cause a copy was in a nymbox notice.</span>
<a name="l04552"></a>04552                             }
<a name="l04553"></a>04553                             <span class="comment">// ------------------------------------------------------------------------------------</span>
<a name="l04554"></a>04554                             <span class="comment">// All of these need to remove something from the client-side Nymbox. (Which happens below this switch.)</span>
<a name="l04555"></a>04555                             <span class="comment">//</span>
<a name="l04556"></a>04556                             <span class="keywordflow">switch</span> (pReplyItem-&gt;<a class="code" href="class_o_t_item.html#a2f4535b271f23b7c2b6b1dbabf279ffe">GetType</a>())  
<a name="l04557"></a>04557                             {   <span class="comment">// Some also need to remove an issued transaction number from pNym.</span>
<a name="l04558"></a>04558 
<a name="l04559"></a>04559                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a3a3aa40758df2bff71b66962c0206a73">OTItem::atAcceptNotice</a>:
<a name="l04560"></a>04560 
<a name="l04561"></a>04561                                 <span class="comment">// There are many different types of notices.</span>
<a name="l04562"></a>04562                                 <span class="comment">// We just indiscriminately accept them all from the Nymbox.</span>
<a name="l04563"></a>04563                                 <span class="comment">// The replyNotice tells you that a transaction was processed.</span>
<a name="l04564"></a>04564                                 <span class="comment">// (We put a copy of the server reply into your Nymbox, to make sure</span>
<a name="l04565"></a>04565                                 <span class="comment">// you get it, so you stay in sync with which transaction numbers are signed out.)</span>
<a name="l04566"></a>04566                                 <span class="comment">// The successNotice tells you that you successfully signed out new transaction numbers</span>
<a name="l04567"></a>04567                                 <span class="comment">// (to use on transactions.)</span>
<a name="l04568"></a>04568                                 <span class="comment">// The &quot;plain-ole&quot; OTTransaction::notice is used to notice the parties to a smart</span>
<a name="l04569"></a>04569                                 <span class="comment">// contract that it has activated (or failed to activate.)</span>
<a name="l04570"></a>04570 
<a name="l04571"></a>04571                                 <span class="comment">// if pReplyItem is atAcceptNotice, then pItem is acceptNotice.</span>
<a name="l04572"></a>04572                                 <span class="comment">// Then pItem is accepting (IN REFERENCE TO) the original OTItem::notice that&#39;s</span>
<a name="l04573"></a>04573                                 <span class="comment">// sitting in the Nymbox!</span>
<a name="l04574"></a>04574 
<a name="l04575"></a>04575                                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a> == pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l04576"></a>04576                                 {
<a name="l04577"></a>04577 
<a name="l04578"></a>04578                                     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a>       == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) || <span class="comment">// REJECTION</span>
<a name="l04579"></a>04579                                         (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376aa099f14a8a9ef5987b1161b764895cdf">OTItem::acknowledgement</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()))   <span class="comment">// ACKNOWLEDGMENT</span>
<a name="l04580"></a>04580                                     {
<a name="l04581"></a>04581                                         <span class="comment">// NOTE: NORMALLY we do this sort of thing in the server reply to the actual</span>
<a name="l04582"></a>04582                                         <span class="comment">// transaction request (by the activating party.)</span>
<a name="l04583"></a>04583                                         <span class="comment">//</span>
<a name="l04584"></a>04584                                         <span class="comment">// For example, if you tried to activate a smart contract, and that failed, then</span>
<a name="l04585"></a>04585                                         <span class="comment">// the atSmartContract server reply will be processed, and the opening issued# will</span>
<a name="l04586"></a>04586                                         <span class="comment">// be removed at that time, and the closing numbers will be harvested. So then, why</span>
<a name="l04587"></a>04587                                         <span class="comment">// this additional notice in my Nymbox? If that will already happen?</span>
<a name="l04588"></a>04588                                         <span class="comment">//</span>
<a name="l04589"></a>04589                                         <span class="comment">// ===&gt; Because of ALL THE OTHER PARTIES to the smart contract! (This may be necessary</span>
<a name="l04590"></a>04590                                         <span class="comment">// for payment plans, too.) The activating party got his reply (he even had a back-up</span>
<a name="l04591"></a>04591                                         <span class="comment">// reply stuffed into his Nymbox to make SURE he got it.) But all the other parties will</span>
<a name="l04592"></a>04592                                         <span class="comment">// only know, if they are sent a notice! Therefore a notice is sent by the server, to all</span>
<a name="l04593"></a>04593                                         <span class="comment">// parties.</span>
<a name="l04594"></a>04594                                         <span class="comment">//</span>
<a name="l04595"></a>04595                                         <span class="comment">// ===&gt; This also means that the ACTIVATING party himself will ALSO get this same notice!</span>
<a name="l04596"></a>04596                                         <span class="comment">// But since we&#39;ve already established above that the activating party ALREADY processes</span>
<a name="l04597"></a>04597                                         <span class="comment">// his activation reply, we don&#39;t want him to process it TWICE!</span>
<a name="l04598"></a>04598                                         <span class="comment">//</span>
<a name="l04599"></a>04599                                         <span class="comment">// Therefore, we will process the notice like normal, UNLESS pNym is the activating Nym for</span>
<a name="l04600"></a>04600                                         <span class="comment">// the smart contract, in which case we skip it, since we assume he already processed the</span>
<a name="l04601"></a>04601                                         <span class="comment">// reply directly when he activated the smart contract.</span>
<a name="l04602"></a>04602                                         <span class="comment">//</span>
<a name="l04603"></a>04603                                         <span class="comment">// You might ask, then why not just let the activating party, process this notice here the</span>
<a name="l04604"></a>04604                                         <span class="comment">// same as all the other parties, and just NOT have him process it on the direct reply, as</span>
<a name="l04605"></a>04605                                         <span class="comment">// he is now? The answer is, because he will stay in sync better if we just give him that</span>
<a name="l04606"></a>04606                                         <span class="comment">// info as soon as he&#39;s able to receive it, which is preferably RIGHT when he performs the</span>
<a name="l04607"></a>04607                                         <span class="comment">// activation. The other parties are not currently present, so they HAVE to be informed by</span>
<a name="l04608"></a>04608                                         <span class="comment">// notices. But the ACTIVATING party might as well be informed instantly. Otherwise he will</span>
<a name="l04609"></a>04609                                         <span class="comment">// just be out of sync until the next time he processes his Nymbox, which causes unnecessary</span>
<a name="l04610"></a>04610                                         <span class="comment">// delays as it will result in unnecessary server messages to resync the situation.</span>
<a name="l04611"></a>04611                                         <span class="comment">// </span>
<a name="l04612"></a>04612                                         <span class="comment">// THEREFORE: We will skip this step if pNym is the activating Nym, since he&#39;s assumed to</span>
<a name="l04613"></a>04613                                         <span class="comment">// have done this already. Otherwise, pNym is NOT the activating Nym, and he&#39;s one of the</span>
<a name="l04614"></a>04614                                         <span class="comment">// other parties receiving this notice, and therefore he needs to process it accordingly</span>
<a name="l04615"></a>04615                                         <span class="comment">// (He, in fact, processes it here IDENTICALLY as the activating Nym does when he receives</span>
<a name="l04616"></a>04616                                         <span class="comment">// the reply to his transaction request: by removing the issued opening number, and by</span>
<a name="l04617"></a>04617                                         <span class="comment">// harvesting the closing numbers.)</span>
<a name="l04618"></a>04618                                         <span class="comment">// ----------------------------------------------------------</span>
<a name="l04619"></a>04619                                         <span class="comment">// If it was a failure, harvest the extra transaction numbers that were used as</span>
<a name="l04620"></a>04620                                         <span class="comment">// CLOSING numbers. They can go back on my Nym and be used another day! Remove</span>
<a name="l04621"></a>04621                                         <span class="comment">// the opening number and harvest the closing ones, basically.</span>
<a name="l04622"></a>04622                                         <span class="comment">//</span>
<a name="l04623"></a>04623 
<a name="l04624"></a>04624                                         <a class="code" href="class_o_t_string.html">OTString</a> strCronItem;
<a name="l04625"></a>04625                                         pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a88d404b8cebd7da409e551396cc45ee7">GetReferenceString</a>(strCronItem);
<a name="l04626"></a>04626 
<a name="l04627"></a>04627                                         <span class="comment">// What kind of cron item is it?</span>
<a name="l04628"></a>04628                                         <span class="comment">// Well (todo) we should probably double-check, but the only cron items we</span>
<a name="l04629"></a>04629                                         <span class="comment">// send notices for are payment plans and smart contracts. Market offers don&#39;t</span>
<a name="l04630"></a>04630                                         <span class="comment">// need notices, since anyone activating a market offer is already getting the</span>
<a name="l04631"></a>04631                                         <span class="comment">// reply. (AND getting a copy of that reply, already, inside a replyNotice in</span>
<a name="l04632"></a>04632                                         <span class="comment">// his Nymbox...) So he can&#39;t possibly miss the server&#39;s reply, and there aren&#39;t</span>
<a name="l04633"></a>04633                                         <span class="comment">// any other parties to notify (re: successful activation), besides the Nym himself.</span>
<a name="l04634"></a>04634                                         <span class="comment">//</span>
<a name="l04635"></a>04635                                         <span class="comment">// Only payment plans and smart contracts could potentially have some other signer, who</span>
<a name="l04636"></a>04636                                         <span class="comment">// would want to get notified, and to whom the notice is send.</span>
<a name="l04637"></a>04637                                         <span class="comment">//</span>
<a name="l04638"></a>04638                                         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = (strCronItem.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strCronItem) : NULL);
<a name="l04639"></a>04639                                         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theCronItemAngel(pCronItem);
<a name="l04640"></a>04640 
<a name="l04641"></a>04641                                         <span class="keywordflow">if</span> (NULL != pCronItem) <span class="comment">// the original smart contract or payment plan object.</span>
<a name="l04642"></a>04642                                         {                                                
<a name="l04643"></a>04643                                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theCancelerNymID;
<a name="l04644"></a>04644                                             <span class="keyword">const</span> int64_t   lNymOpeningNumber =  pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a8f59139b6000733ec3c1df6d1dbc7632">GetOpeningNumber</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
<a name="l04645"></a>04645                                             <span class="keyword">const</span> <span class="keywordtype">bool</span>   bCancelling       = (pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>() &amp;&amp; pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#ac9031aa34854265423155e448be01120">GetCancelerID</a>(theCancelerNymID));
<a name="l04646"></a>04646                                             <span class="keyword">const</span> <span class="keywordtype">bool</span>   bIsCancelerNym    = (bCancelling &amp;&amp; (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>() == theCancelerNymID));
<a name="l04647"></a>04647                                             <span class="keyword">const</span> <span class="keywordtype">bool</span>   bIsActivatingNym  = (pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#acd198571145b47602c121a419723b39a">GetOpeningNum</a>() == lNymOpeningNumber); <span class="comment">// If the opening number for the cron item is the SAME as Nym&#39;s opening number, then Nym is the ACTIVATING NYM (Skip him, since he does this same stuff when he receives the actual server reply. The notices are for the OTHER parties)...</span>
<a name="l04648"></a>04648 
<a name="l04649"></a>04649                                             <span class="comment">// Canceler (if cancelling) or activator (if activating) are handled already elsewhere, when they receive</span>
<a name="l04650"></a>04650                                             <span class="comment">// the server reply. A notice is also sent to all the parties (and we&#39;re processing that notice now) so here</span>
<a name="l04651"></a>04651                                             <span class="comment">// we just need to handle everyone else but him.</span>
<a name="l04652"></a>04652                                             <span class="comment">// </span>
<a name="l04653"></a>04653                                             <span class="keywordflow">if</span> ( ( bCancelling &amp;&amp; !bIsCancelerNym) ||  <span class="comment">// If canceling, and Nym is not the canceler...</span>
<a name="l04654"></a>04654                                                 (!bCancelling &amp;&amp; !bIsActivatingNym)   <span class="comment">// or if activating, and Nym is not the activator...</span>
<a name="l04655"></a>04655                                                 )
<a name="l04656"></a>04656                                             {                                                    
<a name="l04657"></a>04657                                                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_item.html#a61e86f5b6c64a518664123907235f376adbeae2ab1504a5ef318da097d21119db">OTItem::rejection</a> == pReplyItem-&gt;<a class="code" href="class_o_t_item.html#abadbfe245f0dbc8a035d8d6930dd9dfc">GetStatus</a>()) <span class="comment">// REJECTION (This is where we remove the opening number, and harvest the closing numbers.)</span>
<a name="l04658"></a>04658                                                 {
<a name="l04659"></a>04659                                                     <span class="comment">// Why do this? Oh I see, this number either gets burned from the attempt,</span>
<a name="l04660"></a>04660                                                     <span class="comment">// or it stays open for a while if success. So here what do we see? The rejection</span>
<a name="l04661"></a>04661                                                     <span class="comment">// burning the transaction number, but leaving it open if success. Perfect.</span>
<a name="l04662"></a>04662                                                     <span class="comment">//</span>
<a name="l04663"></a>04663                                                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID,
<a name="l04664"></a>04664                                                         lNymOpeningNumber,
<a name="l04665"></a>04665                                                         <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l04666"></a>04666                                                     {
<a name="l04667"></a>04667                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error removing issued number from user nym (for a cron item.)\n&quot;</span>,
<a name="l04668"></a>04668                                                             __FUNCTION__);
<a name="l04669"></a>04669                                                     }
<a name="l04670"></a>04670                                                     <span class="comment">// ---------------------------------------</span>
<a name="l04671"></a>04671                                                     <span class="comment">// If the activation was a failure, we can add all the extra transaction numbers BACK to the</span>
<a name="l04672"></a>04672                                                     <span class="comment">// Nym, that were being used as CLOSING numbers, and use them later. (They aren&#39;t burned.)</span>
<a name="l04673"></a>04673                                                     <span class="comment">// They&#39;re still all signed-out, so we should harvest them so we can still use them on something.</span>
<a name="l04674"></a>04674                                                     <span class="comment">// (Whereas if it had been a success, then we would have left them in their existing state, since</span>
<a name="l04675"></a>04675                                                     <span class="comment">// the transaction would then be in play, and the numbers could not be used again, nor removed as</span>
<a name="l04676"></a>04676                                                     <span class="comment">// issued numbers until the transaction itself had finished and its receipts had been signed-off.)</span>
<a name="l04677"></a>04677                                                     <span class="comment">//</span>
<a name="l04678"></a>04678                                                     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// saves.</span>
<a name="l04679"></a>04679                                                 }
<a name="l04680"></a>04680                                                 <span class="comment">// --------------------------------------------</span>
<a name="l04681"></a>04681                                                 <span class="comment">// If success, save a copy in my &quot;active cron items&quot; folder.</span>
<a name="l04682"></a>04682                                                 <span class="comment">//</span>
<a name="l04683"></a>04683                                                 <span class="keywordflow">else</span> <span class="comment">//if (OTItem::acknowledged == pReplyItem-&gt;GetStatus())</span>
<a name="l04684"></a>04684                                                 {
<a name="l04685"></a>04685                                                     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#a215530a92d43d8260dfe8f42327cb3de">SaveActiveCronReceipt</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
<a name="l04686"></a>04686                                                 }
<a name="l04687"></a>04687                                                 <span class="comment">// --------------------------------------------</span>
<a name="l04688"></a>04688                                                 <span class="comment">// When party receives notice that smart contract has been activated,</span>
<a name="l04689"></a>04689                                                 <span class="comment">// remove the instrument from outpayments box. (If it&#39;s there -- it can be.)</span>
<a name="l04690"></a>04690                                                 <span class="comment">//</span>
<a name="l04691"></a>04691                                                 <span class="comment">// (This happens for acknowledged AND rejected smart contracts.)</span>
<a name="l04692"></a>04692                                                 <span class="comment">//</span>
<a name="l04693"></a>04693                                                 <a class="code" href="class_o_t_num_list.html">OTNumList</a>   numlistOutpayment(lNymOpeningNumber);
<a name="l04694"></a>04694                                                 <a class="code" href="class_o_t_string.html">OTString</a>    strInstrument; <span class="comment">// If the instrument is in the outpayments box, we put a copy of it here.</span>
<a name="l04695"></a>04695                                                 <span class="keyword">const</span> int32_t   nOutpaymentIndex = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(lNymOpeningNumber);
<a name="l04696"></a>04696                                                 <a class="code" href="class_o_t_message.html">OTMessage</a> * pMsg             = NULL;
<a name="l04697"></a>04697                                                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMessageAngel;
<a name="l04698"></a>04698 
<a name="l04699"></a>04699                                                 <span class="keywordflow">if</span> (nOutpaymentIndex &gt;= 0)
<a name="l04700"></a>04700                                                 {
<a name="l04701"></a>04701                                                     pMsg = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acb808e89943f1f2d0009825a3fbcb34f">GetOutpaymentsByIndex</a>(nOutpaymentIndex);
<a name="l04702"></a>04702 
<a name="l04703"></a>04703                                                     <span class="keywordflow">if</span> (NULL == pMsg)
<a name="l04704"></a>04704                                                     {
<a name="l04705"></a>04705                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment message in outpayment box based on index %d.\n&quot;</span>,
<a name="l04706"></a>04706                                                             __FUNCTION__, nOutpaymentIndex);
<a name="l04707"></a>04707                                                     }
<a name="l04708"></a>04708                                                     <span class="keywordflow">else</span>
<a name="l04709"></a>04709                                                     {
<a name="l04710"></a>04710                                                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bRemovedOutpayment = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(nOutpaymentIndex, <span class="keyword">false</span>); <span class="comment">//bDeleteIt=false (deleted later on.)</span>
<a name="l04711"></a>04711                                                         theMessageAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pMsg); <span class="comment">// Since we chose to keep pMsg alive and undeleted, after removing it from the outpayments box, we set the angel here to make sure it gets cleaned up later, whenever we return out of this godforsaken function.</span>
<a name="l04712"></a>04712                                                         <span class="comment">// --------------------------------------------------</span>
<a name="l04713"></a>04713                                                         <span class="keywordflow">if</span> (bRemovedOutpayment)
<a name="l04714"></a>04714                                                             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l04715"></a>04715                                                         <span class="keywordflow">else</span>
<a name="l04716"></a>04716                                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove outpayment at index: %d\n&quot;</span>, __FUNCTION__, nOutpaymentIndex);
<a name="l04717"></a>04717                                                         <span class="comment">// --------------------------------------------------</span>
<a name="l04718"></a>04718                                                         <span class="keywordflow">if</span> (!pMsg-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strInstrument))
<a name="l04719"></a>04719                                                         {
<a name="l04720"></a>04720                                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment instrument in outpayment message at index %d.\n&quot;</span>,
<a name="l04721"></a>04721                                                                 __FUNCTION__, nOutpaymentIndex);
<a name="l04722"></a>04722                                                         }
<a name="l04723"></a>04723                                                         <span class="comment">// --------------------------------------------------</span>
<a name="l04724"></a>04724                                                         <span class="keywordflow">else</span>
<a name="l04725"></a>04725                                                         {
<a name="l04726"></a>04726                                                             <span class="comment">// At this point, we&#39;ve removed the outpayment already, and it will be deleted</span>
<a name="l04727"></a>04727                                                             <span class="comment">// when it goes out of scope already. And we&#39;ve got a copy of the original financial</span>
<a name="l04728"></a>04728                                                             <span class="comment">// instrument that was SENT in that outpayment.</span>
<a name="l04729"></a>04729                                                             <span class="comment">//</span>
<a name="l04730"></a>04730                                                             <span class="comment">// But what for? Why did I want that instrument here in a string, in strInstrument?</span>
<a name="l04731"></a>04731                                                             <span class="comment">// Do I still need to do something with it? Yes: I need to drop a copy of it into</span>
<a name="l04732"></a>04732                                                             <span class="comment">// the record box!</span>
<a name="l04733"></a>04733 
<a name="l04734"></a>04734                                                             <span class="comment">// NOTE: strInstrument is added to the RecordBox below. So there&#39;s no need to</span>
<a name="l04735"></a>04735                                                             <span class="comment">// do that here, ATM.</span>
<a name="l04736"></a>04736                                                         }
<a name="l04737"></a>04737                                                     }
<a name="l04738"></a>04738                                                 }
<a name="l04739"></a>04739                                                 <span class="comment">// ------------------------------------------------------</span>
<a name="l04740"></a>04740                                                 <span class="comment">// When party receives notice that smart contract has failed activation attempt, then remove</span>
<a name="l04741"></a>04741                                                 <span class="comment">// the instrument from payments inbox AND outpayments box. (If there -- could be for either.)</span>
<a name="l04742"></a>04742                                                 <span class="comment">// (Outbox is done just above, so now let&#39;s do inbox...)</span>
<a name="l04743"></a>04743                                                 <span class="comment">//</span>
<a name="l04744"></a>04744 
<a name="l04745"></a>04745                                                 <span class="comment">// Why only rejected items? Why not remove it from the payments inbox on success as well?</span>
<a name="l04746"></a>04746                                                 <span class="comment">// Normally wouldn&#39;t we expect that a successful activation of an inbox item, should remove</span>
<a name="l04747"></a>04747                                                 <span class="comment">// that inbox item? Especially if there&#39;s already a copy in the outbox as well...</span>
<a name="l04748"></a>04748                                                 <span class="comment">//</span>
<a name="l04749"></a>04749 <span class="comment">//                                              if (OTItem::rejection == pReplyItem-&gt;GetStatus()) // REJECTION</span>
<a name="l04750"></a>04750                                                 {
<a name="l04751"></a>04751                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l04752"></a>04752                                                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists1   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a92fc938529eac80e1a040a664d844847">OTFolders::PaymentInbox</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04753"></a>04753                                                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bExists2   = <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a33b17e178549458a5fa7596dcf38adc6">OTFolders::RecordBox</a>()   .Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04754"></a>04754                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l04755"></a>04755                                                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> thePmntInbox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// payment inbox</span>
<a name="l04756"></a>04756                                                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theRecordBox(USER_ID, USER_ID, SERVER_ID); <span class="comment">// record box</span>
<a name="l04757"></a>04757                                                     <span class="comment">// ------------------------------------------------------</span>
<a name="l04758"></a>04758                                                     <span class="keywordtype">bool</span> bSuccessLoading1 = (bExists1 &amp;&amp; thePmntInbox.LoadPaymentInbox());
<a name="l04759"></a>04759                                                     <span class="keywordtype">bool</span> bSuccessLoading2 = (bExists2 &amp;&amp; theRecordBox.<a class="code" href="class_o_t_ledger.html#ad283d675ba07160bddde117386b872a6">LoadRecordBox</a>());
<a name="l04760"></a>04760                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l04761"></a>04761                                                     <span class="keywordflow">if</span> (bExists1 &amp;&amp; bSuccessLoading1)
<a name="l04762"></a>04762                                                         bSuccessLoading1  = (thePmntInbox.VerifyContractID() &amp;&amp;
<a name="l04763"></a>04763                                                         thePmntInbox.VerifySignature(*pNym));
<a name="l04764"></a>04764 <span class="comment">//                                                      bSuccessLoading1      = (thePmntInbox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
<a name="l04765"></a>04765                                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists1)
<a name="l04766"></a>04766                                                         bSuccessLoading1  = thePmntInbox.GenerateLedger(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l04767"></a>04767                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l04768"></a>04768                                                     <span class="keywordflow">if</span> (bExists2 &amp;&amp; bSuccessLoading2)
<a name="l04769"></a>04769                                                         bSuccessLoading2  = (theRecordBox.<a class="code" href="class_o_t_transaction_type.html#a7799050eb71875ffd069024250854392">VerifyContractID</a>() &amp;&amp;
<a name="l04770"></a>04770                                                         theRecordBox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym));
<a name="l04771"></a>04771 <span class="comment">//                                                      bSuccessLoading2      = (theRecordBox.VerifyAccount(*pNym)); // (No need to load all the Box Receipts using VerifyAccount)</span>
<a name="l04772"></a>04772                                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bExists2)
<a name="l04773"></a>04773                                                         bSuccessLoading2  = theRecordBox.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>); <span class="comment">// bGenerateFile=true</span>
<a name="l04774"></a>04774                                                     <span class="comment">// -----------------------------------------------------</span>
<a name="l04775"></a>04775                                                     <span class="comment">// by this point, the boxes DEFINITELY exist -- or not. (generation might have failed, or verification.)</span>
<a name="l04776"></a>04776                                                     <span class="comment">//</span>
<a name="l04777"></a>04777                                                     <span class="keywordflow">if</span> (!bSuccessLoading1 || !bSuccessLoading2)
<a name="l04778"></a>04778                                                     {
<a name="l04779"></a>04779                                                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: while processing server rejection of cron item: &quot;</span>
<a name="l04780"></a>04780                                                             <span class="stringliteral">&quot;WARNING: Unable to load, verify, or generate paymentInbox or recordBox, with IDs: %s / %s\n&quot;</span>,
<a name="l04781"></a>04781                                                             __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04782"></a>04782                                                     }
<a name="l04783"></a>04783                                                     <span class="keywordflow">else</span><span class="comment">// --- ELSE --- Success loading the payment inbox and recordBox and verifying</span>
<a name="l04784"></a>04784                                                     {   <span class="comment">// their contractID and signature, (OR success generating the ledger.)</span>
<a name="l04785"></a>04785                                                         <span class="comment">// -------------------------------------------------------------------------------</span>
<a name="l04786"></a>04786                                                         <span class="comment">// See if there&#39;s a receipt in the payments inbox.</span>
<a name="l04787"></a>04787                                                         <span class="comment">// If so, remove it.</span>
<a name="l04788"></a>04788                                                         <span class="comment">//</span>
<a name="l04789"></a>04789                                                         <span class="comment">// ------------------------------------------------------</span>
<a name="l04790"></a>04790                                                         <span class="comment">// What&#39;s going on here?</span>
<a name="l04791"></a>04791                                                         <span class="comment">//</span>
<a name="l04792"></a>04792                                                         <span class="comment">// Well let&#39;s say Alice sends Bob a payment plan. (This applies to smart contracts, too.)</span>
<a name="l04793"></a>04793                                                         <span class="comment">// This means Bob has a payment plan in his PAYMENTS INBOX, with the recipient&#39;s (Alice)</span>
<a name="l04794"></a>04794                                                         <span class="comment">// transaction number set to X, and the sender&#39;s transaction number set to 0. It&#39;s 0 because</span>
<a name="l04795"></a>04795                                                         <span class="comment">// the instrument is still in Bob&#39;s inbox -- he hasn&#39;t signed it yet -- so his transaction</span>
<a name="l04796"></a>04796                                                         <span class="comment">// number isn&#39;t on it yet. It&#39;s blank (0).</span>
<a name="l04797"></a>04797                                                         <span class="comment">//</span>
<a name="l04798"></a>04798                                                         <span class="comment">// Next, let&#39;s say Bob signs/confirms the contract, which puts a copy of it into his PAYMENTS</span>
<a name="l04799"></a>04799                                                         <span class="comment">// OUTBOX. On the outbox version, Alice&#39;s transaction number is X, and Bob&#39;s transaction number</span>
<a name="l04800"></a>04800                                                         <span class="comment">// is Y.</span>
<a name="l04801"></a>04801                                                         <span class="comment">//</span>
<a name="l04802"></a>04802                                                         <span class="comment">// Later on, Bob needs to lookup the payment plan in his PAYMENTS INBOX (for example, to remove</span>
<a name="l04803"></a>04803                                                         <span class="comment">// it, AS YOU SEE IN THE BELOW LOOP.) Remember, Bob&#39;s transaction number is Y. But he can&#39;t use</span>
<a name="l04804"></a>04804                                                         <span class="comment">// that number (Y) to lookup the payment plan in his inbox, since it&#39;s set to ZERO in his inbox!</span>
<a name="l04805"></a>04805                                                         <span class="comment">// The inbox version simply doesn&#39;t HAVE Y set onto it yet -- only the outbox version does.</span>
<a name="l04806"></a>04806                                                         <span class="comment">//</span>
<a name="l04807"></a>04807                                                         <span class="comment">// So how in the fuck does Bob lookup the inbox version, if the transaction number isn&#39;t SET on</span>
<a name="l04808"></a>04808                                                         <span class="comment">// it yet??</span>
<a name="l04809"></a>04809                                                         <span class="comment">//</span>
<a name="l04810"></a>04810                                                         <span class="comment">// The solution:</span>
<a name="l04811"></a>04811                                                         <span class="comment">// 1. Bob grabs an OTNumList containing all the transaction numbers from the OUTBOX VERSION,</span>
<a name="l04812"></a>04812                                                         <span class="comment">//    which ends up containing &quot;X,Y&quot; (that happens in this block.)</span>
<a name="l04813"></a>04813                                                         <span class="comment">// 2. Bob loops through the payments INBOX, and for each, he grabs an OTNumList containing all</span>
<a name="l04814"></a>04814                                                         <span class="comment">//    the transaction numbers. One of those (the matching one) will contain &quot;X,0&quot;. (Except it</span>
<a name="l04815"></a>04815                                                         <span class="comment">//    will actually only contain &quot;X&quot;, since 0 is ignored in the call to GetAllTransactionNumbers.)</span>
<a name="l04816"></a>04816                                                         <span class="comment">// 3. Bob then checks like this:    if (numlistOutpayment.VerifyAny(numlistIncomingPayment))</span>
<a name="l04817"></a>04817                                                         <span class="comment">//    This is equivalent to saying: if (&quot;X,Y&quot;.VerifyAny(&quot;X&quot;)) which RETURNS TRUE -- and we have</span>
<a name="l04818"></a>04818                                                         <span class="comment">//    found the instrument!</span>
<a name="l04819"></a>04819 
<a name="l04820"></a>04820                                                         <a class="code" href="class_o_t_payment.html">OTPayment</a> theOutpayment;
<a name="l04821"></a>04821 
<a name="l04822"></a>04822                                                         <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()                  &amp;&amp;
<a name="l04823"></a>04823                                                             theOutpayment.<a class="code" href="class_o_t_payment.html#a294a4886d8701ff1366bca5fdd1e7b56">SetPayment</a>(strInstrument) &amp;&amp;
<a name="l04824"></a>04824                                                             theOutpayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l04825"></a>04825                                                         {
<a name="l04826"></a>04826                                                             theOutpayment.<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistOutpayment);
<a name="l04827"></a>04827                                                         }
<a name="l04828"></a>04828                                                         <span class="comment">// ------------------------------------------------------                                                            </span>
<a name="l04829"></a>04829                                                         <span class="keyword">const</span> int32_t nTransCount = thePmntInbox.GetTransactionCount();
<a name="l04830"></a>04830 
<a name="l04831"></a>04831                                                         <span class="keywordflow">for</span> (int32_t ii = (nTransCount-1); ii &gt;= 0; --ii) <span class="comment">// Count backwards since we are removing things.</span>
<a name="l04832"></a>04832                                                         {
<a name="l04833"></a>04833                                                             int64_t lPaymentTransNum = 0;
<a name="l04834"></a>04834                                                             <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = thePmntInbox.GetInstrument(*pNym, ii);
<a name="l04835"></a>04835                                                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l04836"></a>04836 
<a name="l04837"></a>04837                                                             <span class="keywordflow">if</span> (NULL == pPayment)
<a name="l04838"></a>04838                                                             {
<a name="l04839"></a>04839                                                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: (Upon receiving notice) While looping payments inbox to remove a payment, &quot;</span>
<a name="l04840"></a>04840                                                                     <span class="stringliteral">&quot;unable to retrieve payment at index %d (skipping.)\n&quot;</span>,
<a name="l04841"></a>04841                                                                     __FUNCTION__, ii);
<a name="l04842"></a>04842                                                                 <span class="keywordflow">continue</span>;
<a name="l04843"></a>04843                                                             }
<a name="l04844"></a>04844                                                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l04845"></a>04845                                                             {
<a name="l04846"></a>04846                                                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: (Upon receiving notice) While looping payments inbox to remove a payment, &quot;</span>
<a name="l04847"></a>04847                                                                     <span class="stringliteral">&quot;unable to set temp values for payment at index %d (skipping.)\n&quot;</span>,
<a name="l04848"></a>04848                                                                     __FUNCTION__, ii);
<a name="l04849"></a>04849                                                                 <span class="keywordflow">continue</span>;
<a name="l04850"></a>04850                                                             }
<a name="l04851"></a>04851                                                             <span class="comment">// ---------------------------------------------------</span>
<a name="l04852"></a>04852 
<a name="l04853"></a>04853                                                             <a class="code" href="class_o_t_num_list.html">OTNumList</a> numlistIncomingPayment;
<a name="l04854"></a>04854 
<a name="l04855"></a>04855                                                             pPayment-&gt;<a class="code" href="class_o_t_payment.html#a0ba3b1210d5e29d3a19cd5c116dd21f3">GetAllTransactionNumbers</a>(numlistIncomingPayment);
<a name="l04856"></a>04856 
<a name="l04857"></a>04857                                                             <span class="comment">// ---------------------------------------------------</span>
<a name="l04858"></a>04858 
<a name="l04859"></a>04859                                                             <span class="keywordflow">if</span> (numlistOutpayment.<a class="code" href="class_o_t_num_list.html#abe227d7816c9bac6831c95b55a797c44">VerifyAny</a>(numlistIncomingPayment))  <span class="comment">// Found it.</span>
<a name="l04860"></a>04860                                                             {                                                                    
<a name="l04861"></a>04861                                                                 <span class="comment">// ** It&#39;s the same instrument.**</span>
<a name="l04862"></a>04862                                                                 <span class="comment">// Remove it from the payments inbox, and save.</span>
<a name="l04863"></a>04863                                                                 <span class="comment">//</span>
<a name="l04864"></a>04864                                                                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a>    * pTransPaymentInbox = thePmntInbox.GetTransactionByIndex(ii);
<a name="l04865"></a>04865                                                                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL  != pTransPaymentInbox); <span class="comment">// It DEFINITELY should be there. (Assert otherwise.)</span>
<a name="l04866"></a>04866                                                                 lPaymentTransNum = pTransPaymentInbox-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l04867"></a>04867 
<a name="l04868"></a>04868                                                                 <span class="comment">// DON&#39;T I NEED to call DeleteBoxReceipt at this point?</span>
<a name="l04869"></a>04869                                                                 <span class="comment">// Since that needs to be called now whenever removing something from any box?</span>
<a name="l04870"></a>04870                                                                 <span class="comment">//</span>
<a name="l04871"></a>04871                                                                 <span class="comment">// NOTE: might need to just MOVE this box receipt to the record box, instead of</span>
<a name="l04872"></a>04872                                                                 <span class="comment">// deleting it.</span>
<a name="l04873"></a>04873                                                                 <span class="comment">//</span>
<a name="l04874"></a>04874                                                                 <span class="comment">// Probably I need to do that ONLY if the version in the payments outbox doesn&#39;t exist.</span>
<a name="l04875"></a>04875                                                                 <span class="comment">// For example, if strInstrument doesn&#39;t exist, then there was nothing in the payments</span>
<a name="l04876"></a>04876                                                                 <span class="comment">// outbox, and therefore the version in the payment INBOX is the ONLY version I have,</span>
<a name="l04877"></a>04877                                                                 <span class="comment">// and therefore I should stick it in the Record Box.</span>
<a name="l04878"></a>04878                                                                 <span class="comment">//</span>
<a name="l04879"></a>04879                                                                 <span class="comment">// HOWEVER, if strInstrument DOES exist, then I should create its own transaction to add</span>
<a name="l04880"></a>04880                                                                 <span class="comment">// to the record box, and delete the one that was in the payment inbox. Why delete it? Because</span>
<a name="l04881"></a>04881                                                                 <span class="comment">// otherwise I would be adding the same thing TWICE to the record box, which I don&#39;t really</span>
<a name="l04882"></a>04882                                                                 <span class="comment">// need to do. And if I&#39;m going to choose one of the two, the one in the outpayments box will</span>
<a name="l04883"></a>04883                                                                 <span class="comment">// be the more recent / more relevant one of the two. So I favor that one, unless it doesn&#39;t</span>
<a name="l04884"></a>04884                                                                 <span class="comment">// exist, in which case I should add the other one instead. (Todo.)</span>
<a name="l04885"></a>04885                                                                 <span class="comment">//</span>
<a name="l04886"></a>04886                                                                 <span class="comment">// NOTE: Until the above is completed, the current behavior is that the outpayments box item</span>
<a name="l04887"></a>04887                                                                 <span class="comment">// will be moved to the record box if it exists, and otherwise nothing will be, since any payments</span>
<a name="l04888"></a>04888                                                                 <span class="comment">// inbox item will be deleted.</span>
<a name="l04889"></a>04889 
<a name="l04890"></a>04890 
<a name="l04891"></a>04891                                                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePmntInbox.DeleteBoxReceipt(lPaymentTransNum))
<a name="l04892"></a>04892                                                                 {
<a name="l04893"></a>04893                                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
<a name="l04894"></a>04894                                                                         <span class="stringliteral">&quot;from the payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l04895"></a>04895                                                                 }
<a name="l04896"></a>04896                                                                 <span class="comment">// --------------------------------------------------</span>
<a name="l04897"></a>04897                                                                 <span class="keywordflow">if</span> (thePmntInbox.RemoveTransaction(lPaymentTransNum))
<a name="l04898"></a>04898                                                                 {
<a name="l04899"></a>04899                                                                     thePmntInbox.ReleaseSignatures();
<a name="l04900"></a>04900                                                                     thePmntInbox.SignContract(*pNym);
<a name="l04901"></a>04901                                                                     thePmntInbox.SaveContract();
<a name="l04902"></a>04902 
<a name="l04903"></a>04903                                                                     <span class="keywordflow">if</span> (!thePmntInbox.SavePaymentInbox())
<a name="l04904"></a>04904                                                                     {
<a name="l04905"></a>04905                                                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure while trying to save payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l04906"></a>04906                                                                     }
<a name="l04907"></a>04907                                                                     <span class="keywordflow">else</span>
<a name="l04908"></a>04908                                                                     {
<a name="l04909"></a>04909                                                                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Removed instrument from payment inbox.\n&quot;</span>
<a name="l04910"></a>04910                                                                             <span class="stringliteral">&quot;Saved payment inbox.\n&quot;</span>, __FUNCTION__);
<a name="l04911"></a>04911                                                                     }
<a name="l04912"></a>04912                                                                 }
<a name="l04913"></a>04913                                                                 <span class="keywordflow">else</span>
<a name="l04914"></a>04914                                                                 {
<a name="l04915"></a>04915                                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to remove transaction from payment inbox. &quot;</span>
<a name="l04916"></a>04916                                                                         <span class="stringliteral">&quot;(Should never happen.)\n&quot;</span>, __FUNCTION__);
<a name="l04917"></a>04917                                                                 }
<a name="l04918"></a>04918                                                                 <span class="comment">// -----------------------------------------------</span>
<a name="l04919"></a>04919                                                                 <span class="comment">// Todo: save a copy to the record box.</span>
<a name="l04920"></a>04920                                                                 <span class="comment">// -----------------------------------------------</span>
<a name="l04921"></a>04921                                                                 <span class="comment">// Note: I could break right here, if this is the only transaction in the</span>
<a name="l04922"></a>04922                                                                 <span class="comment">// payment inbox which contains the instrument in question. Which I believe</span>
<a name="l04923"></a>04923                                                                 <span class="comment">// it is.  Todo: if that&#39;s true, which I think it is, then call break here.</span>
<a name="l04924"></a>04924                                                                 <span class="comment">// After all, you wouldn&#39;t send me the SAME instrument TWICE, would you?</span>
<a name="l04925"></a>04925                                                                 <span class="comment">// But it still seems theoretically possible (albeit stupid.)</span>
<a name="l04926"></a>04926                                                             }
<a name="l04927"></a>04927                                                         }
<a name="l04928"></a>04928                                                         <span class="comment">// for (int32_t ii = 0; ii &lt; nTransCount; ++ii)</span>
<a name="l04929"></a>04929                                                         <span class="comment">// -------------------------------------------------------------------------------</span>
<a name="l04930"></a>04930                                                         <span class="comment">// Also, if there was a message in the outpayments box (which we already removed</span>
<a name="l04931"></a>04931                                                         <span class="comment">// a bit above), go ahead and add a receipt for it into the record box.</span>
<a name="l04932"></a>04932                                                         <span class="comment">//</span>
<a name="l04933"></a>04933                                                         <span class="keywordflow">if</span> (strInstrument.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// Found the instrument in the outpayments box.</span>
<a name="l04934"></a>04934                                                         {
<a name="l04935"></a>04935                                                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pNewTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(theRecordBox, <span class="comment">// recordbox.</span>
<a name="l04936"></a>04936                                                                 <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>,
<a name="l04937"></a>04937                                                                 lNymOpeningNumber);
<a name="l04938"></a>04938                                                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel(pNewTransaction);
<a name="l04939"></a>04939 
<a name="l04940"></a>04940                                                             <span class="keywordflow">if</span> (NULL != pNewTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
<a name="l04941"></a>04941                                                             {
<a name="l04942"></a>04942                                                                 pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lNymOpeningNumber); <span class="comment">// Referencing myself here. We&#39;ll see how it works out.</span>
<a name="l04943"></a>04943                                                                 pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strInstrument);    <span class="comment">// The cheque, invoice, etc that used to be in the outpayments box.</span>
<a name="l04944"></a>04944                                                                 pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04945"></a>04945                                                                 pNewTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04946"></a>04946                                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04947"></a>04947                                                                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = theRecordBox.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pNewTransaction);
<a name="l04948"></a>04948 
<a name="l04949"></a>04949                                                                 <span class="keywordflow">if</span> (!bAdded)
<a name="l04950"></a>04950                                                                 {
<a name="l04951"></a>04951                                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %lld to record box (after tentatively removing &quot;</span>
<a name="l04952"></a>04952                                                                         <span class="stringliteral">&quot;from payment outbox, an action that is now canceled.)\n&quot;</span>, __FUNCTION__,
<a name="l04953"></a>04953                                                                         pNewTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l04954"></a>04954                                                                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04955"></a>04955                                                                 }
<a name="l04956"></a>04956                                                                 <span class="keywordflow">else</span>
<a name="l04957"></a>04957                                                                     theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves. The record box owns it now.</span>
<a name="l04958"></a>04958 
<a name="l04959"></a>04959                                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04960"></a>04960                                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04961"></a>04961                                                                 theRecordBox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04962"></a>04962                                                                 <span class="comment">// -------------------------------</span>
<a name="l04963"></a>04963                                                                 theRecordBox.<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>(); <span class="comment">// todo log failure.</span>
<a name="l04964"></a>04964 
<a name="l04965"></a>04965                                                                 <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
<a name="l04966"></a>04966                                                                 <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
<a name="l04967"></a>04967                                                                 <span class="comment">//</span>
<a name="l04968"></a>04968                                                                 <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
<a name="l04969"></a>04969                                                                 <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
<a name="l04970"></a>04970                                                                 <span class="comment">// is removed from a box.</span>
<a name="l04971"></a>04971                                                                 <span class="comment">//</span>
<a name="l04972"></a>04972                                                                 <span class="keywordflow">if</span> (!pNewTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(theRecordBox)) <span class="comment">// &lt;===================</span>
<a name="l04973"></a>04973                                                                 {
<a name="l04974"></a>04974                                                                     <a class="code" href="class_o_t_string.html">OTString</a> strNewTransaction(*pNewTransaction);
<a name="l04975"></a>04975                                                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: for Record Box... &quot;</span>
<a name="l04976"></a>04976                                                                         <span class="stringliteral">&quot;Failed trying to SaveBoxReceipt. Contents:\n\n%s\n\n&quot;</span>,
<a name="l04977"></a>04977                                                                         __FUNCTION__, strNewTransaction.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04978"></a>04978                                                                 }
<a name="l04979"></a>04979                                                                 <span class="comment">// -----------------------------------------------------</span>
<a name="l04980"></a>04980                                                             }
<a name="l04981"></a>04981                                                             <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
<a name="l04982"></a>04982                                                             {
<a name="l04983"></a>04983                                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
<a name="l04984"></a>04984                                                                     <span class="stringliteral">&quot;add a new transaction to record box (for a payment instrument we just removed &quot;</span>
<a name="l04985"></a>04985                                                                     <span class="stringliteral">&quot;from the outpayments box): %s\n&quot;</span>, __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04986"></a>04986                                                             }
<a name="l04987"></a>04987                                                         } <span class="comment">// if (strInstrument.Exists()) (then add a copy to record box.)</span>
<a name="l04988"></a>04988                                                     } <span class="comment">// else (Success loading the payment inbox and recordBox)</span>
<a name="l04989"></a>04989                                                 } <span class="comment">// (OTItem::rejection == pReplyItem-&gt;GetStatus())</span>
<a name="l04990"></a>04990                                             } <span class="comment">// if (!bIsActivatingNym)</span>
<a name="l04991"></a>04991                                         } <span class="comment">// if (NULL != pCronItem)</span>
<a name="l04992"></a>04992                                         <span class="keywordflow">else</span>
<a name="l04993"></a>04993                                         {
<a name="l04994"></a>04994                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading cronitem from Nymbox receipt, from string:\n%s\n&quot;</span>,
<a name="l04995"></a>04995                                                 __FUNCTION__, strCronItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04996"></a>04996                                         }
<a name="l04997"></a>04997 
<a name="l04998"></a>04998                                     } <span class="comment">// pReplyItem is a rejection.</span>
<a name="l04999"></a>04999                                 } <span class="comment">// pServerTransaction (the Nymbox receipt we just accepted / removed) is a notice.</span>
<a name="l05000"></a>05000 
<a name="l05001"></a>05001                                 <span class="keywordflow">break</span>;
<a name="l05002"></a>05002 
<a name="l05003"></a>05003                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91caeadd2fc8999a11a392fb25b0b5c3">OTItem::atAcceptMessage</a>:
<a name="l05004"></a>05004                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a00f43bf21e890c4dd11059fc834f1ef1">OTItem::atAcceptTransaction</a>:
<a name="l05005"></a>05005                                 <span class="keywordflow">break</span>;
<a name="l05006"></a>05006                                 <span class="comment">// I don&#39;t think we need to do anything here...</span>
<a name="l05007"></a>05007 
<a name="l05008"></a>05008                             <span class="keywordflow">case</span> <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5034beca2e90df6b2b36022d365f1d38">OTItem::atAcceptFinalReceipt</a>:
<a name="l05009"></a>05009                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Successfully removed finalReceipt &quot;</span>
<a name="l05010"></a>05010                                     <span class="stringliteral">&quot;from Nymbox with opening num: %lld\n&quot;</span>, __FUNCTION__,
<a name="l05011"></a>05011                                     pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05012"></a>05012 
<a name="l05013"></a>05013                                 <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l05014"></a>05014                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
<a name="l05015"></a>05015                                     pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05016"></a>05016                                 <span class="keywordflow">else</span>
<a name="l05017"></a>05017                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l05018"></a>05018                                     pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05019"></a>05019 
<a name="l05020"></a>05020                                 <span class="comment">// BUG: RemoveIssuedNum shouldn&#39;t be here. In Nymbox, finalReceipt is only a notice, and I shoulda</span>
<a name="l05021"></a>05021                                 <span class="comment">// removed the number the instant that I saw it. (Back when processing the Nymbox, before even</span>
<a name="l05022"></a>05022                                 <span class="comment">// calculating the request.) Therefore, this is moved to AcceptEntireNymbox and Finalize for Process Inbox.</span>
<a name="l05023"></a>05023                                 <span class="comment">//</span>
<a name="l05024"></a>05024 <span class="comment">//                              pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pServerTransaction-&gt;GetReferenceToNum(), true); // bool bSave=true</span>
<a name="l05025"></a>05025                                 <span class="comment">// ----------------------------------------------</span>
<a name="l05026"></a>05026                                 <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l05027"></a>05027                                 <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l05028"></a>05028                                 <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l05029"></a>05029                                 <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l05030"></a>05030                                 <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l05031"></a>05031                                 <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l05032"></a>05032                                 <span class="comment">// It is for the others.</span>
<a name="l05033"></a>05033                                 <span class="comment">//</span>
<a name="l05034"></a>05034                                 <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
<a name="l05035"></a>05035                                 <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
<a name="l05036"></a>05036                                 <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
<a name="l05037"></a>05037                                 <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
<a name="l05038"></a>05038                                 <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
<a name="l05039"></a>05039                                 <span class="comment">//</span>
<a name="l05040"></a>05040                                 <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l05041"></a>05041                                                                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l05042"></a>05042                                                                    pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l05043"></a>05043                                 <span class="comment">// ----------------------------------------------</span>
<a name="l05044"></a>05044 
<a name="l05045"></a>05045                                 <span class="keywordflow">break</span>;
<a name="l05046"></a>05046 
<a name="l05047"></a>05047                             <span class="keywordflow">default</span>:
<a name="l05048"></a>05048                                 {
<a name="l05049"></a>05049                                     <a class="code" href="class_o_t_string.html">OTString</a> strTempTypeString;
<a name="l05050"></a>05050                                     pReplyItem-&gt;<a class="code" href="class_o_t_item.html#ad0aa349efc846dbcb46c51cf183dcc39">GetTypeString</a>(strTempTypeString);
<a name="l05051"></a>05051                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Unexpected replyItem:type while processing Nymbox: %s \n&quot;</span>, 
<a name="l05052"></a>05052                                         strTempTypeString.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05053"></a>05053                                     <span class="keywordflow">continue</span>;
<a name="l05054"></a>05054                                 }
<a name="l05055"></a>05055                             }   <span class="comment">// switch replyItem type</span>
<a name="l05056"></a>05056 
<a name="l05057"></a>05057                             <span class="comment">// Remove from pNymbox</span>
<a name="l05058"></a>05058                             <span class="comment">// This happens for ALL of the above cases.</span>
<a name="l05059"></a>05059                             <span class="comment">// Update: Now whenever removing a receipt from any box, we also have</span>
<a name="l05060"></a>05060                             <span class="comment">// to delete the box receipt, which is stored as a separate file.</span>
<a name="l05061"></a>05061                             <span class="comment">//</span>
<a name="l05062"></a>05062                             pServerTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac2e9b2e8e4a00f439109273b6a7ea658">DeleteBoxReceipt</a>(*pNymbox); <span class="comment">// faster.</span>
<a name="l05063"></a>05063 <span class="comment">//                          pNymbox-&gt;DeleteBoxReceipt(pServerTransaction-&gt;GetTransactionNum());</span>
<a name="l05064"></a>05064                             pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(pServerTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l05065"></a>05065 
<a name="l05066"></a>05066                         } <span class="comment">// for loop (reply items)</span>
<a name="l05067"></a>05067                         <span class="comment">// ---------------------------------------</span>
<a name="l05068"></a>05068                         <span class="comment">// All done? Let&#39;s save up...</span>
<a name="l05069"></a>05069                         <span class="comment">//</span>
<a name="l05070"></a>05070                         pNymbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l05071"></a>05071                         pNymbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05072"></a>05072                         pNymbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05073"></a>05073                         pNymbox-&gt;<a class="code" href="class_o_t_ledger.html#aa2dec5beccd6e4a55cfe45788ebd2137">SaveNymbox</a>();
<a name="l05074"></a>05074 
<a name="l05075"></a>05075                         pNymbox = NULL;  <span class="comment">// Since it could be pointing to a variable that&#39;s in this block (now out of scope) then we clear the pointer.</span>
<a name="l05076"></a>05076                     } <span class="comment">// pTransaction and pReplyTransaction are both NOT NULL.</span>
<a name="l05077"></a>05077                     <span class="comment">// ------------------------------------------------------------------</span>
<a name="l05078"></a>05078                 }
<a name="l05079"></a>05079 
<a name="l05080"></a>05080                 <span class="comment">// *******************************************************************************</span>
<a name="l05081"></a>05081                 <span class="comment">//</span>
<a name="l05082"></a>05082                 <span class="comment">// The below happens BOTH for Inbox AND Nymbox.</span>
<a name="l05083"></a>05083 
<a name="l05084"></a>05084                 <span class="keywordflow">if</span> ((NULL != pTransaction) &amp;&amp; (NULL != pReplyTransaction))
<a name="l05085"></a>05085                 {                   
<a name="l05086"></a>05086                     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05087"></a>05087                     <span class="comment">//</span>
<a name="l05088"></a>05088                     <span class="comment">// SAVE THE RECEIPT....</span>
<a name="l05089"></a>05089 
<a name="l05090"></a>05090                     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05091"></a>05091 
<a name="l05092"></a>05092                     <a class="code" href="class_o_t_string.html">OTString</a> strReceiptID(<span class="stringliteral">&quot;NOT_SET_YET&quot;</span>);
<a name="l05093"></a>05093 
<a name="l05094"></a>05094                     <a class="code" href="class_o_t_item.html">OTItem</a> * pReplyItem = pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1af8bcd696284c0bcd0fe198dceaf2f6d5">OTItem::atBalanceStatement</a>);
<a name="l05095"></a>05095 
<a name="l05096"></a>05096                     <span class="keywordflow">if</span> (NULL == pReplyItem)
<a name="l05097"></a>05097                     {
<a name="l05098"></a>05098                         pReplyItem = pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a62bf5069d7a7fda92fa1d6746a75bb49">GetItem</a>(<a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a53f9e1f8ef8651545c50d933db94636c">OTItem::atTransactionStatement</a>);
<a name="l05099"></a>05099 
<a name="l05100"></a>05100                         <span class="keywordflow">if</span> (NULL != pReplyItem)
<a name="l05101"></a>05101                             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strReceiptID); <span class="comment">// In this case, the receipt ID is the Nym ID</span>
<a name="l05102"></a>05102                     }
<a name="l05103"></a>05103                     <span class="keywordflow">else</span> 
<a name="l05104"></a>05104                     {
<a name="l05105"></a>05105                         strReceiptID = theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>; <span class="comment">// If a balance statement, then the receipt ID is the Account ID.</span>
<a name="l05106"></a>05106                     }
<a name="l05107"></a>05107                     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l05108"></a>05108                     <a class="code" href="class_o_t_string.html">OTString</a> strTransaction;
<a name="l05109"></a>05109                     pReplyTransaction-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTransaction); <span class="comment">// &lt;=========== Save that receipt!</span>
<a name="l05110"></a>05110                     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l05111"></a>05111                     <a class="code" href="class_o_t_string.html">OTString</a> strReceiptFilename;
<a name="l05112"></a>05112 
<a name="l05113"></a>05113                     <span class="keywordflow">if</span> (pReplyTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac5ffc9f0e274bbc617185a5335c061a3">GetSuccess</a>())                    
<a name="l05114"></a>05114                         strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.success&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05115"></a>05115                     <span class="keywordflow">else</span>
<a name="l05116"></a>05116                         strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.fail&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05117"></a>05117                     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l05118"></a>05118                     <a class="code" href="class_o_t_string.html">OTString</a> strFinal;
<a name="l05119"></a>05119                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp(strTransaction);
<a name="l05120"></a>05120 
<a name="l05121"></a>05121                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strFinal, <span class="stringliteral">&quot;TRANSACTION&quot;</span>)) <span class="comment">// todo hardcoding.</span>
<a name="l05122"></a>05122                     {
<a name="l05123"></a>05123                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error saving transaction receipt &quot;</span>
<a name="l05124"></a>05124                             <span class="stringliteral">&quot;(failed writing armored string):\n%s%s%s%s%s\n Contents:\n%s\n&quot;</span>, 
<a name="l05125"></a>05125                             <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(),
<a name="l05126"></a>05126                             strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l05127"></a>05127                             strTransaction.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05128"></a>05128                     }
<a name="l05129"></a>05129                     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l05130"></a>05130                     <span class="keywordflow">else</span> <span class="comment">// success writing armored string</span>
<a name="l05131"></a>05131                     {                        
<a name="l05132"></a>05132                         <span class="keywordflow">if</span> (NULL != pReplyItem)
<a name="l05133"></a>05133                         {
<a name="l05134"></a>05134                             <span class="comment">// -------------------------------------------------</span>
<a name="l05135"></a>05135                             <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05136"></a>05136                                 strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05137"></a>05137                             <span class="comment">// -------------------------------------------------</span>
<a name="l05138"></a>05138                         }
<a name="l05139"></a>05139                         <span class="keywordflow">else</span> <span class="comment">// This should never happen...</span>
<a name="l05140"></a>05140                         {
<a name="l05141"></a>05141                             strReceiptFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.error&quot;</span>, strReceiptID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05142"></a>05142 
<a name="l05143"></a>05143                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTClient::ProcessServerReply: Error saving transaction receipt:  %s%s%s\n&quot;</span>, 
<a name="l05144"></a>05144                                 strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05145"></a>05145 
<a name="l05146"></a>05146                             <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strFinal.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),    <a class="code" href="class_o_t_folders.html#ad5d313f4dc313c7b79780288c14e9c83">OTFolders::Receipt</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05147"></a>05147                                 strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strReceiptFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05148"></a>05148                         }
<a name="l05149"></a>05149                     } <span class="comment">// success writing armored string</span>
<a name="l05150"></a>05150                     <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l05151"></a>05151                 }
<a name="l05152"></a>05152                 <span class="keywordflow">else</span> 
<a name="l05153"></a>05153                 {
<a name="l05154"></a>05154                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strTheLedger(theLedger), strTheReplyLedger(theReplyLedger);
<a name="l05155"></a>05155                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Strange... found ledger in %s, but didn&#39;t find the right transaction type within.\n&quot;</span>
<a name="l05156"></a>05156                         <span class="stringliteral">&quot;(pTransaction == %s) &amp;&amp; (pReplyTransaction == %s)\n&quot;</span>
<a name="l05157"></a>05157                         <span class="stringliteral">&quot;theLedger: \n\n%s\n\n&quot;</span>
<a name="l05158"></a>05158                         <span class="stringliteral">&quot;theReplyLedger:\n\n%s\n\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), 
<a name="l05159"></a>05159                         (NULL != pTransaction) ? <span class="stringliteral">&quot;NOT NULL&quot;</span> : <span class="stringliteral">&quot;NULL&quot;</span>, (NULL != pReplyTransaction) ? <span class="stringliteral">&quot;NOT NULL&quot;</span> : <span class="stringliteral">&quot;NULL&quot;</span>,
<a name="l05160"></a>05160                         strTheLedger.Get(), strTheReplyLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05161"></a>05161                 }
<a name="l05162"></a>05162             }
<a name="l05163"></a>05163         }
<a name="l05164"></a>05164         <span class="keywordflow">else</span> 
<a name="l05165"></a>05165         {
<a name="l05166"></a>05166             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Strange... received server acknowledgment but &#39;in reference to&#39; message was blank.\n&quot;</span>);
<a name="l05167"></a>05167         }
<a name="l05168"></a>05168 
<a name="l05169"></a>05169         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05170"></a>05170     }
<a name="l05171"></a>05171 
<a name="l05172"></a>05172     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getAccountFiles&quot;</span>)) <span class="comment">// Replaces getAccount, getInbox, and getOutbox</span>
<a name="l05173"></a>05173     {
<a name="l05174"></a>05174         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Received server response to getAccountFiles message.\n&quot;</span>);
<a name="l05175"></a>05175 
<a name="l05176"></a>05176         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascArmor  = theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>;  <span class="comment">// containing account file + inbox and outbox.</span>
<a name="l05177"></a>05177         <span class="keyword">const</span> <span class="keywordtype">bool</span>     bHasFiles = ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
<a name="l05178"></a>05178         <span class="comment">// -------------------------------------------------</span>
<a name="l05179"></a>05179         <span class="keywordflow">if</span> (bHasFiles)
<a name="l05180"></a>05180         {
<a name="l05181"></a>05181             <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05182"></a>05182             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l05183"></a>05183             <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l05184"></a>05184             <span class="comment">// -------------------------------------------------</span>
<a name="l05185"></a>05185             <span class="keywordflow">if</span> (NULL == pMap)
<a name="l05186"></a>05186                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object in @getAccountFiles.\n&quot;</span>, __FUNCTION__);
<a name="l05187"></a>05187             <span class="keywordflow">else</span>
<a name="l05188"></a>05188             {
<a name="l05189"></a>05189                 <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l05190"></a>05190                 <span class="comment">// ----------------------------------------</span>
<a name="l05191"></a>05191                 <a class="code" href="class_o_t_string.html">OTString</a> strAccount, strInbox, strOutbox;
<a name="l05192"></a>05192                 <span class="comment">// ----------------------------------------</span>
<a name="l05193"></a>05193                 mapOfStrings::iterator it_account = theMap.find(<span class="stringliteral">&quot;account&quot;</span>);
<a name="l05194"></a>05194                 mapOfStrings::iterator it_inbox   = theMap.find(<span class="stringliteral">&quot;inbox&quot;</span>  );
<a name="l05195"></a>05195                 mapOfStrings::iterator it_outbox  = theMap.find(<span class="stringliteral">&quot;outbox&quot;</span> );
<a name="l05196"></a>05196                 <span class="comment">// ------------------------------------------------------------</span>
<a name="l05197"></a>05197                 <span class="keywordflow">if</span> ((theMap.end() != it_account) &amp;&amp; (it_account-&gt;second.size() &gt; 0))
<a name="l05198"></a>05198                     strAccount = it_account-&gt;second.c_str();
<a name="l05199"></a>05199                 <span class="comment">// ------------------------------------------------------------</span>
<a name="l05200"></a>05200                 <span class="keywordflow">if</span> ((theMap.end() != it_inbox) &amp;&amp; (it_inbox-&gt;second.size() &gt; 0))
<a name="l05201"></a>05201                     strInbox = it_inbox-&gt;second.c_str();
<a name="l05202"></a>05202                 <span class="comment">// ------------------------------------------------------------</span>
<a name="l05203"></a>05203                 <span class="keywordflow">if</span> ((theMap.end() != it_outbox) &amp;&amp; (it_outbox-&gt;second.size() &gt; 0))
<a name="l05204"></a>05204                     strOutbox = it_outbox-&gt;second.c_str();
<a name="l05205"></a>05205                 <span class="comment">// ********************************************************************************************************</span>
<a name="l05206"></a>05206                 <span class="keywordflow">if</span> (strAccount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05207"></a>05207                 {
<a name="l05208"></a>05208                     <span class="comment">// Load the account object from that string.</span>
<a name="l05209"></a>05209                     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l05210"></a>05210                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
<a name="l05211"></a>05211                     
<a name="l05212"></a>05212                     <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAccount) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
<a name="l05213"></a>05213                     {
<a name="l05214"></a>05214                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Saving updated account file to disk...\n&quot;</span>);
<a name="l05215"></a>05215                         pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
<a name="l05216"></a>05216                         <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
<a name="l05217"></a>05217                         <span class="comment">// UPDATE (above) I now release signatures again since we have receipts functional. As long as receipt has server&#39;s signature, it can prove the others.</span>
<a name="l05218"></a>05218                         pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05219"></a>05219                         pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05220"></a>05220                         pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l05221"></a>05221                         
<a name="l05222"></a>05222                         <span class="comment">// Next let&#39;s make sure the wallet&#39;s copy of this account is replaced with the new one...</span>
<a name="l05223"></a>05223                         <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
<a name="l05224"></a>05224                         
<a name="l05225"></a>05225                         <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l05226"></a>05226                         {
<a name="l05227"></a>05227                             pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
<a name="l05228"></a>05228                             pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l05229"></a>05229                             <span class="comment">// --------------------------------------------------</span>
<a name="l05230"></a>05230                             theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
<a name="l05231"></a>05231                         }
<a name="l05232"></a>05232                     }
<a name="l05233"></a>05233                 }
<a name="l05234"></a>05234                 <span class="comment">// ********************************************************************************************************</span>
<a name="l05235"></a>05235                 
<a name="l05236"></a>05236                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    strAcctID   (ACCOUNT_ID);
<a name="l05237"></a>05237                 <span class="keyword">const</span> std::string str_acct_id (strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05238"></a>05238 
<a name="l05239"></a>05239                 
<a name="l05240"></a>05240                 <span class="keywordflow">if</span> (strInbox.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05241"></a>05241                 {
<a name="l05242"></a>05242                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05243"></a>05243                     
<a name="l05244"></a>05244                     <span class="comment">// Load the ledger object from strInbox</span>
<a name="l05245"></a>05245                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l05246"></a>05246                     
<a name="l05247"></a>05247                     <span class="comment">// I receive the inbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
<a name="l05248"></a>05248                     <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this inbox</span>
<a name="l05249"></a>05249                     <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot,</span>
<a name="l05250"></a>05250                     <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
<a name="l05251"></a>05251                     <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05252"></a>05252                     <span class="keywordflow">if</span> (theInbox.<a class="code" href="class_o_t_ledger.html#adee226f0dab7315814a65a6e08be7fb5">LoadInboxFromString</a>(strInbox) &amp;&amp; theInbox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) <span class="comment">// No VerifyAccount. Can&#39;t, because client hasn&#39;t had a chance yet to download the box receipts that go with this inbox -- and VerifyAccount() tries to load those, which would fail here...</span>
<a name="l05253"></a>05253                     {
<a name="l05254"></a>05254                         <span class="comment">// -----------------------------</span>
<a name="l05255"></a>05255                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
<a name="l05256"></a>05256                         
<a name="l05257"></a>05257                         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05258"></a>05258                         {
<a name="l05259"></a>05259                             THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>);
<a name="l05260"></a>05260                             
<a name="l05261"></a>05261                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adddd63c949620e826177926f8ecae533">SetInboxHash</a>(str_acct_id, THE_HASH);
<a name="l05262"></a>05262                             
<a name="l05263"></a>05263                             <span class="keywordflow">if</span> (!bHash)
<a name="l05264"></a>05264                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting InboxHash on Nym for account: %s\n&quot;</span>,
<a name="l05265"></a>05265                                               __FUNCTION__, str_acct_id.c_str());
<a name="l05266"></a>05266                             <span class="comment">// ----------------------------------------------------</span>
<a name="l05267"></a>05267                             <span class="keywordflow">else</span>
<a name="l05268"></a>05268                             {
<a name="l05269"></a>05269                                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l05270"></a>05270                                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l05271"></a>05271                             }
<a name="l05272"></a>05272                         }
<a name="l05273"></a>05273                         <span class="comment">// -------------------------------</span>
<a name="l05274"></a>05274                         
<a name="l05275"></a>05275                         <span class="comment">// If I have Transaction #35 signed out, and I use it to start a market offer (or any other cron item)</span>
<a name="l05276"></a>05276                         <span class="comment">// then it&#39;s always possible that a finalReceipt will pop into my Inbox while I&#39;m asleep, closing</span>
<a name="l05277"></a>05277                         <span class="comment">// that transaction #. The server officially believes 35 is closed. Unfortunately, I still have it signed</span>
<a name="l05278"></a>05278                         <span class="comment">// out, on my side anyway, because I didn&#39;t know the finalReceipt came in.</span>
<a name="l05279"></a>05279                         <span class="comment">//</span>
<a name="l05280"></a>05280                         <span class="comment">// THEREFORE, WHEN A FINAL RECEIPT COMES IN, I NEED TO REMOVE ITS &quot;in reference to&quot; NUMBER FROM MY</span>
<a name="l05281"></a>05281                         <span class="comment">// ISSUED LIST. Here is clearly the best place for that:</span>
<a name="l05282"></a>05282                         <span class="comment">//</span>
<a name="l05283"></a>05283                         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l05284"></a>05284                         {
<a name="l05285"></a>05285                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTempTrans = (*it).second;
<a name="l05286"></a>05286                             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTempTrans);
<a name="l05287"></a>05287                             
<a name="l05288"></a>05288                             <span class="comment">// TODO security: Keep a client-side list of issued #s for finalReceipts. That way,</span>
<a name="l05289"></a>05289                             <span class="comment">// I&#39;ll be smart enough here not to actually remove just any number, unless it&#39;s actually</span>
<a name="l05290"></a>05290                             <span class="comment">// on my list of final receipts.  (The server does a similar thing already.)</span>
<a name="l05291"></a>05291                             <span class="comment">//</span>
<a name="l05292"></a>05292                             <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTempTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l05293"></a>05293                             {
<a name="l05294"></a>05294                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;*** Removing opening issued number (%lld), since finalReceipt found when retrieving asset account inbox. ***\n&quot;</span>,
<a name="l05295"></a>05295                                                pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05296"></a>05296                                 
<a name="l05297"></a>05297                                 <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l05298"></a>05298                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>,
<a name="l05299"></a>05299                                                    pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05300"></a>05300                                 <span class="keywordflow">else</span>
<a name="l05301"></a>05301                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l05302"></a>05302                                                    pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05303"></a>05303                                 
<a name="l05304"></a>05304 <span class="comment">//                              pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pTempTrans-&gt;GetReferenceToNum(), true); // bSave = true;</span>
<a name="l05305"></a>05305                                 <span class="comment">// ----------------------------------------------</span>
<a name="l05306"></a>05306                                 <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l05307"></a>05307                                 <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l05308"></a>05308                                 <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l05309"></a>05309                                 <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l05310"></a>05310                                 <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l05311"></a>05311                                 <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l05312"></a>05312                                 <span class="comment">// It is for the others.</span>
<a name="l05313"></a>05313                                 <span class="comment">//</span>
<a name="l05314"></a>05314                                 <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l05315"></a>05315                                                                    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l05316"></a>05316                                                                    pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l05317"></a>05317                                 <span class="comment">// ----------------------------------------------</span>
<a name="l05318"></a>05318                                 
<a name="l05319"></a>05319                             } <span class="comment">// We also do this in AcceptEntireNymbox</span>
<a name="l05320"></a>05320                         }
<a name="l05321"></a>05321                         
<a name="l05322"></a>05322                         <span class="comment">// -----------------------------------------------</span>
<a name="l05323"></a>05323                         <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own. </span>
<a name="l05324"></a>05324                         theInbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// This is back. Why? Because we have receipts functional now.</span>
<a name="l05325"></a>05325                         theInbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05326"></a>05326                         theInbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05327"></a>05327                         theInbox.<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
<a name="l05328"></a>05328                     }
<a name="l05329"></a>05329                     <span class="keywordflow">else</span> 
<a name="l05330"></a>05330                     {
<a name="l05331"></a>05331                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading (from string) or verifying inbox:\n\n%s\n&quot;</span>,
<a name="l05332"></a>05332                                       __FUNCTION__, strInbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05333"></a>05333                     }
<a name="l05334"></a>05334                 }
<a name="l05335"></a>05335                 <span class="comment">// ********************************************************************************************************</span>
<a name="l05336"></a>05336                 <span class="keywordflow">if</span> (strOutbox.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05337"></a>05337                 {
<a name="l05338"></a>05338                     <span class="comment">// Load the ledger object from strOutbox.</span>
<a name="l05339"></a>05339                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theOutbox(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l05340"></a>05340 
<a name="l05341"></a>05341                     <span class="comment">// I receive the outbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
<a name="l05342"></a>05342                     <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this outbox</span>
<a name="l05343"></a>05343                     <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
<a name="l05344"></a>05344                     <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
<a name="l05345"></a>05345                     <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05346"></a>05346                     <span class="keywordflow">if</span> (theOutbox.<a class="code" href="class_o_t_ledger.html#a3a908c983d03a683590a228c80af3b4c">LoadOutboxFromString</a>(strOutbox) &amp;&amp; theOutbox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) <span class="comment">// No point calling VerifyAccount since the client hasn&#39;t even had a chance to download the box receipts yet...</span>
<a name="l05347"></a>05347                     {
<a name="l05348"></a>05348                         <span class="comment">// -----------------------------</span>
<a name="l05349"></a>05349                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
<a name="l05350"></a>05350 
<a name="l05351"></a>05351                         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05352"></a>05352                         {
<a name="l05353"></a>05353                             THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>);
<a name="l05354"></a>05354 
<a name="l05355"></a>05355                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac5af6ed289cfcd77c388ab750da28ccc">SetOutboxHash</a>(str_acct_id, THE_HASH);
<a name="l05356"></a>05356 
<a name="l05357"></a>05357                             <span class="keywordflow">if</span> (!bHash)
<a name="l05358"></a>05358                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed setting OutboxHash on Nym for account: %s\n&quot;</span>,
<a name="l05359"></a>05359                                               __FUNCTION__, str_acct_id.c_str());
<a name="l05360"></a>05360                             <span class="comment">// ----------------------------------------------------</span>
<a name="l05361"></a>05361                             <span class="keywordflow">else</span>
<a name="l05362"></a>05362                             {
<a name="l05363"></a>05363                                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l05364"></a>05364                                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l05365"></a>05365                             }
<a name="l05366"></a>05366                         }
<a name="l05367"></a>05367                         <span class="comment">// -------------------------------</span>
<a name="l05368"></a>05368                         theOutbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05369"></a>05369                         theOutbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);  <span class="comment">// ANOTHER UPDATE: Removing signature again, since we have receipts functional now.</span>
<a name="l05370"></a>05370                         theOutbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05371"></a>05371                         theOutbox.<a class="code" href="class_o_t_ledger.html#a97cb4ada66ef13b442bfd69e0a9e0c25">SaveOutbox</a>();
<a name="l05372"></a>05372                     }
<a name="l05373"></a>05373                     <span class="keywordflow">else</span> 
<a name="l05374"></a>05374                     {
<a name="l05375"></a>05375                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading (from string) or verifying outbox:\n\n%s\n&quot;</span>,
<a name="l05376"></a>05376                                       __FUNCTION__, strOutbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05377"></a>05377                     }
<a name="l05378"></a>05378                 }
<a name="l05379"></a>05379                 <span class="comment">// ********************************************************************************************************</span>
<a name="l05380"></a>05380             } <span class="comment">// pMap loaded successfully.</span>
<a name="l05381"></a>05381         } <span class="comment">// Has the files.</span>
<a name="l05382"></a>05382         <span class="comment">// ---------------------------------------------------</span>
<a name="l05383"></a>05383 
<a name="l05384"></a>05384         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05385"></a>05385     }
<a name="l05386"></a>05386 
<a name="l05387"></a>05387     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getAccount&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
<a name="l05388"></a>05388     {
<a name="l05389"></a>05389         <span class="comment">// base64-Decode the server reply&#39;s payload into strAccount</span>
<a name="l05390"></a>05390         <a class="code" href="class_o_t_string.html">OTString</a> strAccount(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l05391"></a>05391         
<a name="l05392"></a>05392         <span class="comment">// Load the account object from that string.</span>
<a name="l05393"></a>05393         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l05394"></a>05394         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAccount&gt;</a> theAngel(pAccount);
<a name="l05395"></a>05395         
<a name="l05396"></a>05396         <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAccount) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
<a name="l05397"></a>05397         {
<a name="l05398"></a>05398             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Saving updated account file to disk...\n&quot;</span>);
<a name="l05399"></a>05399             pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
<a name="l05400"></a>05400             <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
<a name="l05401"></a>05401             <span class="comment">// UPDATE (above) I now release signatures again since we have receipts functional. As long as receipt has server&#39;s signature, it can prove the others.</span>
<a name="l05402"></a>05402             pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05403"></a>05403             pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05404"></a>05404             pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l05405"></a>05405             
<a name="l05406"></a>05406             <span class="comment">// Next let&#39;s make sure the wallet&#39;s copy of this account is replaced with the new one...</span>
<a name="l05407"></a>05407             <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
<a name="l05408"></a>05408             
<a name="l05409"></a>05409             <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l05410"></a>05410             {
<a name="l05411"></a>05411                 pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
<a name="l05412"></a>05412                 pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l05413"></a>05413                 <span class="comment">// --------------------------------------------------</span>
<a name="l05414"></a>05414                 theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
<a name="l05415"></a>05415             }
<a name="l05416"></a>05416         }
<a name="l05417"></a>05417         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05418"></a>05418     }
<a name="l05419"></a>05419 
<a name="l05420"></a>05420     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getInbox&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
<a name="l05421"></a>05421     {
<a name="l05422"></a>05422         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05423"></a>05423 
<a name="l05424"></a>05424         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Received server response to Get Inbox message.\n&quot;</span>);
<a name="l05425"></a>05425 
<a name="l05426"></a>05426         <span class="comment">// base64-Decode the server reply&#39;s payload into strInbox</span>
<a name="l05427"></a>05427         <a class="code" href="class_o_t_string.html">OTString</a> strInbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l05428"></a>05428 
<a name="l05429"></a>05429         <span class="comment">// Load the ledger object from that string.</span>
<a name="l05430"></a>05430         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(USER_ID, ACCOUNT_ID, SERVER_ID);  
<a name="l05431"></a>05431 
<a name="l05432"></a>05432         <span class="comment">// I receive the inbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
<a name="l05433"></a>05433         <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this inbox</span>
<a name="l05434"></a>05434         <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
<a name="l05435"></a>05435         <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
<a name="l05436"></a>05436         <span class="comment">// UPDATE: Keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05437"></a>05437         <span class="keywordflow">if</span> (theInbox.<a class="code" href="class_o_t_ledger.html#adee226f0dab7315814a65a6e08be7fb5">LoadInboxFromString</a>(strInbox) &amp;&amp; theInbox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) <span class="comment">// No VerifyAccount. Can&#39;t, because client hasn&#39;t had a chance yet to download the box receipts that go with this inbox -- and VerifyAccount() tries to load those, which would fail here...</span>
<a name="l05438"></a>05438         {
<a name="l05439"></a>05439             <span class="comment">// -----------------------------</span>
<a name="l05440"></a>05440             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
<a name="l05441"></a>05441             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);
<a name="l05442"></a>05442             <span class="keyword">const</span> std::string str_acct_id(strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05443"></a>05443 
<a name="l05444"></a>05444             <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05445"></a>05445             {
<a name="l05446"></a>05446                 THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#ac723a9009e413214007f3fad46164935">m_strInboxHash</a>);
<a name="l05447"></a>05447 
<a name="l05448"></a>05448                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adddd63c949620e826177926f8ecae533">SetInboxHash</a>(str_acct_id, THE_HASH);
<a name="l05449"></a>05449 
<a name="l05450"></a>05450                 <span class="keywordflow">if</span> (!bHash)
<a name="l05451"></a>05451                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting InboxHash on Nym for account: %s\n&quot;</span>,
<a name="l05452"></a>05452                     str_acct_id.c_str());
<a name="l05453"></a>05453                 <span class="comment">// ----------------------------------------------------</span>
<a name="l05454"></a>05454                 <span class="keywordflow">else</span>
<a name="l05455"></a>05455                 {
<a name="l05456"></a>05456                     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l05457"></a>05457                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l05458"></a>05458                 }
<a name="l05459"></a>05459             }
<a name="l05460"></a>05460             <span class="comment">// -------------------------------            </span>
<a name="l05461"></a>05461 
<a name="l05462"></a>05462             <span class="comment">// If I have Transaction #35 signed out, and I use it to start a market offer (or any other cron item)</span>
<a name="l05463"></a>05463             <span class="comment">// then it&#39;s always possible that a finalReceipt will pop into my Inbox while I&#39;m asleep, closing</span>
<a name="l05464"></a>05464             <span class="comment">// that transaction #. The server officially believes 35 is closed. Unfortunately, I still have it signed</span>
<a name="l05465"></a>05465             <span class="comment">// out, on my side anyway, because I didn&#39;t know the finalReceipt came in.</span>
<a name="l05466"></a>05466             <span class="comment">//</span>
<a name="l05467"></a>05467             <span class="comment">// THEREFORE, WHEN A FINAL RECEIPT COMES IN, I NEED TO REMOVE ITS &quot;in reference to&quot; NUMBER FROM MY</span>
<a name="l05468"></a>05468             <span class="comment">// ISSUED LIST. Here is clearly the best place for that:</span>
<a name="l05469"></a>05469             <span class="comment">//</span>
<a name="l05470"></a>05470             <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, theInbox.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l05471"></a>05471             {   
<a name="l05472"></a>05472                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTempTrans = (*it).second;
<a name="l05473"></a>05473                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTempTrans);
<a name="l05474"></a>05474 
<a name="l05475"></a>05475                 <span class="comment">// TODO security: Keep a client-side list of issued #s for finalReceipts. That way,</span>
<a name="l05476"></a>05476                 <span class="comment">// I&#39;ll be smart enough here not to actually remove just any number, unless it&#39;s actually</span>
<a name="l05477"></a>05477                 <span class="comment">// on my list of final receipts.  (The server does a similar thing already.)</span>
<a name="l05478"></a>05478                 <span class="comment">//</span>
<a name="l05479"></a>05479                 <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a3877decda88be6b275652a6e4930ddc4">OTTransaction::finalReceipt</a> == pTempTrans-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l05480"></a>05480                 {
<a name="l05481"></a>05481                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;*** Removing opening issued number (%lld), since finalReceipt found when getting asset account inbox. ***\n&quot;</span>, 
<a name="l05482"></a>05482                         pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05483"></a>05483 
<a name="l05484"></a>05484                     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(*pNym, strServerID, pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(), <span class="keyword">true</span>)) <span class="comment">// bool bSave=true</span>
<a name="l05485"></a>05485                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Due to finding a finalReceipt, REMOVING OPENING NUMBER FROM NYM:  %lld \n&quot;</span>, 
<a name="l05486"></a>05486                         pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05487"></a>05487                     <span class="keywordflow">else</span>
<a name="l05488"></a>05488                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;**** Noticed a finalReceipt, but Opening Number %lld had ALREADY been removed from nym. \n&quot;</span>,
<a name="l05489"></a>05489                         pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>());
<a name="l05490"></a>05490 
<a name="l05491"></a>05491 <span class="comment">//                  pNym-&gt;RemoveIssuedNum(*pNym, strServerID, pTempTrans-&gt;GetReferenceToNum(), true); // bSave = true;</span>
<a name="l05492"></a>05492 
<a name="l05493"></a>05493                     <span class="comment">// ----------------------------------------------</span>
<a name="l05494"></a>05494                     <span class="comment">// The client side keeps a list of active (recurring) transactions.</span>
<a name="l05495"></a>05495                     <span class="comment">// That is, smart contracts and payment plans. I don&#39;t think it keeps</span>
<a name="l05496"></a>05496                     <span class="comment">// market offers in that list, since we already have a list of active</span>
<a name="l05497"></a>05497                     <span class="comment">// market offers separately. And market offers produce final receipts,</span>
<a name="l05498"></a>05498                     <span class="comment">// so basically this piece of code will be executed for all final receipts.</span>
<a name="l05499"></a>05499                     <span class="comment">// It&#39;s not really necessary that it be called for market offers, but whatever.</span>
<a name="l05500"></a>05500                     <span class="comment">// It is for the others.</span>
<a name="l05501"></a>05501                     <span class="comment">//</span>
<a name="l05502"></a>05502                     <span class="comment">// Notice even though the final receipt hasn&#39;t yet been cleared out of the box,</span>
<a name="l05503"></a>05503                     <span class="comment">// we are already removing the record of the active cron receipt. Why?</span>
<a name="l05504"></a>05504                     <span class="comment">// Because regardless of when the user processes the finalReceipt, we know for</span>
<a name="l05505"></a>05505                     <span class="comment">// a fact the transaction is no longer actively running on Cron. So we don&#39;t want</span>
<a name="l05506"></a>05506                     <span class="comment">// to keep it on our list of &quot;active&quot; cron items if we know it&#39;s already inactive.</span>
<a name="l05507"></a>05507                     <span class="comment">//</span>
<a name="l05508"></a>05508                     <a class="code" href="class_o_t_cron_item.html#a06324c676feb8e551757827775055609">OTCronItem::EraseActiveCronReceipt</a>(pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a08578043dac9d53f7a5a879b02785d46">GetReferenceToNum</a>(),
<a name="l05509"></a>05509                                                        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(),
<a name="l05510"></a>05510                                                        pTempTrans-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l05511"></a>05511                     <span class="comment">// ----------------------------------------------</span>
<a name="l05512"></a>05512 
<a name="l05513"></a>05513                 } <span class="comment">// We also do this in AcceptEntireNymbox</span>
<a name="l05514"></a>05514             }
<a name="l05515"></a>05515 
<a name="l05516"></a>05516             <span class="comment">// -----------------------------------------------</span>
<a name="l05517"></a>05517             <span class="comment">// Now I&#39;m keeping the server signature, and just adding my own. </span>
<a name="l05518"></a>05518             theInbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// This is back. Why? Because we have receipts functional now.</span>
<a name="l05519"></a>05519             theInbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05520"></a>05520             theInbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05521"></a>05521             theInbox.<a class="code" href="class_o_t_ledger.html#a53d47cbd97a874f205dcfb1df75eba40">SaveInbox</a>();
<a name="l05522"></a>05522         }
<a name="l05523"></a>05523         <span class="keywordflow">else</span> 
<a name="l05524"></a>05524         {
<a name="l05525"></a>05525             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading (from string) or verifying inbox:\n\n%s\n&quot;</span>, strInbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05526"></a>05526         }
<a name="l05527"></a>05527 
<a name="l05528"></a>05528         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05529"></a>05529     }
<a name="l05530"></a>05530     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getOutbox&quot;</span>)) <span class="comment">// Deprecated. (Replaced by getAccountFiles.)</span>
<a name="l05531"></a>05531     {
<a name="l05532"></a>05532 
<a name="l05533"></a>05533         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Received server response to Get Outbox message.\n&quot;</span>);
<a name="l05534"></a>05534 <span class="comment">//      OTString strReply(theReply);</span>
<a name="l05535"></a>05535 <span class="comment">//      OTLog::vOutput(0, &quot;Received server response to Get Outbox message:\n%s\n&quot;, strReply.Get());</span>
<a name="l05536"></a>05536 
<a name="l05537"></a>05537         <span class="comment">// base64-Decode the server reply&#39;s payload into strOutbox</span>
<a name="l05538"></a>05538         <a class="code" href="class_o_t_string.html">OTString</a> strOutbox(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l05539"></a>05539 
<a name="l05540"></a>05540 <span class="comment">//      OTLog::vError(&quot;OUTBOX CONTENTS:\n%s\n&quot;, strOutbox.Get());</span>
<a name="l05541"></a>05541 
<a name="l05542"></a>05542         <span class="comment">// Load the ledger object from that string.             </span>
<a name="l05543"></a>05543         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theOutbox(USER_ID, ACCOUNT_ID, SERVER_ID); 
<a name="l05544"></a>05544 
<a name="l05545"></a>05545 
<a name="l05546"></a>05546         <span class="comment">// I receive the outbox, verify the server&#39;s signature, then RE-SIGN IT WITH MY OWN</span>
<a name="l05547"></a>05547         <span class="comment">// SIGNATURE, then SAVE it to local storage.  So any FUTURE checks of this outbox</span>
<a name="l05548"></a>05548         <span class="comment">// would require MY signature, not the server&#39;s, to verify. But in this one spot, </span>
<a name="l05549"></a>05549         <span class="comment">// just before saving, I need to verify the server&#39;s first.</span>
<a name="l05550"></a>05550         <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05551"></a>05551         <span class="keywordflow">if</span> (theOutbox.<a class="code" href="class_o_t_ledger.html#a3a908c983d03a683590a228c80af3b4c">LoadOutboxFromString</a>(strOutbox) &amp;&amp; theOutbox.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pServerNym)) <span class="comment">// No point calling VerifyAccount since the client hasn&#39;t even had a chance to download the box receipts yet...</span>
<a name="l05552"></a>05552         {
<a name="l05553"></a>05553             <span class="comment">// -----------------------------</span>
<a name="l05554"></a>05554             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> THE_HASH;
<a name="l05555"></a>05555             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(ACCOUNT_ID);
<a name="l05556"></a>05556             <span class="keyword">const</span> std::string str_acct_id(strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05557"></a>05557 
<a name="l05558"></a>05558             <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05559"></a>05559             {
<a name="l05560"></a>05560                 THE_HASH.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theReply.<a class="code" href="class_o_t_message.html#a997a2b18e078a8350b67a5874b79c812">m_strOutboxHash</a>);
<a name="l05561"></a>05561 
<a name="l05562"></a>05562                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac5af6ed289cfcd77c388ab750da28ccc">SetOutboxHash</a>(str_acct_id, THE_HASH);
<a name="l05563"></a>05563 
<a name="l05564"></a>05564                 <span class="keywordflow">if</span> (!bHash)
<a name="l05565"></a>05565                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed setting OutboxHash on Nym for account: %s\n&quot;</span>,
<a name="l05566"></a>05566                     str_acct_id.c_str());
<a name="l05567"></a>05567                 <span class="comment">// ----------------------------------------------------</span>
<a name="l05568"></a>05568                 <span class="keywordflow">else</span>
<a name="l05569"></a>05569                 {
<a name="l05570"></a>05570                     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l05571"></a>05571                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l05572"></a>05572                 }
<a name="l05573"></a>05573             }
<a name="l05574"></a>05574             <span class="comment">// -------------------------------</span>
<a name="l05575"></a>05575             theOutbox.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// UPDATE: keeping the server&#39;s signature, and just adding my own.</span>
<a name="l05576"></a>05576             theOutbox.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);  <span class="comment">// ANOTHER UPDATE: Removing signature again, since we have receipts functional now.</span>
<a name="l05577"></a>05577             theOutbox.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05578"></a>05578             theOutbox.<a class="code" href="class_o_t_ledger.html#a97cb4ada66ef13b442bfd69e0a9e0c25">SaveOutbox</a>();
<a name="l05579"></a>05579         }
<a name="l05580"></a>05580         <span class="keywordflow">else</span> 
<a name="l05581"></a>05581         {
<a name="l05582"></a>05582             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error loading (from string) or verifying outbox:\n\n%s\n&quot;</span>, strOutbox.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05583"></a>05583         }
<a name="l05584"></a>05584 
<a name="l05585"></a>05585         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05586"></a>05586     }
<a name="l05587"></a>05587     
<a name="l05588"></a>05588     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getContract&quot;</span>))
<a name="l05589"></a>05589     {
<a name="l05590"></a>05590         <span class="comment">// base64-Decode the server reply&#39;s payload into strContract</span>
<a name="l05591"></a>05591         <a class="code" href="class_o_t_string.html">OTString</a> strContract(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l05592"></a>05592 
<a name="l05593"></a>05593         <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
<a name="l05594"></a>05594         <a class="code" href="class_o_t_string.html">OTString</a> strFilename;   <span class="comment">// In this case the filename isn&#39;t actually used, since SaveToContractFolder will</span>
<a name="l05595"></a>05595         <span class="comment">// handle setting up the filename and overwrite it anyway. But I still prefer to set it</span>
<a name="l05596"></a>05596         <span class="comment">// up correctly, rather than pass a blank. I&#39;m just funny like that.</span>
<a name="l05597"></a>05597         strFilename = theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l05598"></a>05598 
<a name="l05599"></a>05599         <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername, 
<a name="l05600"></a>05600             strFilename, theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
<a name="l05601"></a>05601 
<a name="l05602"></a>05602         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
<a name="l05603"></a>05603 
<a name="l05604"></a>05604         <span class="comment">// Check the server signature on the contract here. (Perhaps the message is good enough?</span>
<a name="l05605"></a>05605         <span class="comment">// After all, the message IS signed by the server and contains the Account.</span>
<a name="l05606"></a>05606         <span class="comment">//      if (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract())</span>
<a name="l05607"></a>05607         <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strContract) &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
<a name="l05608"></a>05608         {
<a name="l05609"></a>05609             <span class="comment">// Next make sure the wallet has this contract on its list...</span>
<a name="l05610"></a>05610             <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = theConnection.<a class="code" href="class_o_t_server_connection.html#aa73d98b774148e33eab575613281edf3">GetWallet</a>();
<a name="l05611"></a>05611 
<a name="l05612"></a>05612             <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l05613"></a>05613             {
<a name="l05614"></a>05614                 pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(*pContract);
<a name="l05615"></a>05615                 pContract = NULL; <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
<a name="l05616"></a>05616             }
<a name="l05617"></a>05617         }
<a name="l05618"></a>05618         <span class="comment">// cleanup</span>
<a name="l05619"></a>05619         <span class="keywordflow">if</span> (pContract)
<a name="l05620"></a>05620         {
<a name="l05621"></a>05621             <span class="keyword">delete</span> pContract;
<a name="l05622"></a>05622             pContract = NULL;
<a name="l05623"></a>05623         }
<a name="l05624"></a>05624         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05625"></a>05625     }
<a name="l05626"></a>05626     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMint&quot;</span>))
<a name="l05627"></a>05627     {
<a name="l05628"></a>05628         <span class="comment">// base64-Decode the server reply&#39;s payload into strMint</span>
<a name="l05629"></a>05629         <a class="code" href="class_o_t_string.html">OTString</a> strMint(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l05630"></a>05630         <span class="comment">// ------------------------------------------------</span>
<a name="l05631"></a>05631         <span class="comment">// Load the mint object from that string...</span>
<a name="l05632"></a>05632         <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>, theReply.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
<a name="l05633"></a>05633         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
<a name="l05634"></a>05634         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
<a name="l05635"></a>05635         <span class="comment">// ------------------------------------------------</span>
<a name="l05636"></a>05636         <span class="comment">// TODO check the server signature on the mint here...</span>
<a name="l05637"></a>05637         <span class="keywordflow">if</span> (pMint-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strMint))
<a name="l05638"></a>05638         {
<a name="l05639"></a>05639             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Saving mint file to disk...\n&quot;</span>);
<a name="l05640"></a>05640             pMint-&gt;<a class="code" href="class_o_t_mint.html#a3ec3a56c4654df4843466194b8d5dcf9">SaveMint</a>();
<a name="l05641"></a>05641         }
<a name="l05642"></a>05642         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05643"></a>05643     }
<a name="l05644"></a>05644     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketList&quot;</span>))
<a name="l05645"></a>05645     {
<a name="l05646"></a>05646         <a class="code" href="class_o_t_string.html">OTString</a> strMarketDatafile;
<a name="l05647"></a>05647         strMarketDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;market_data.bin&quot;</span>);
<a name="l05648"></a>05648 
<a name="l05649"></a>05649         <span class="comment">// ----------------------------------------------------</span>
<a name="l05650"></a>05650 
<a name="l05651"></a>05651         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l05652"></a>05652         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l05653"></a>05653 
<a name="l05654"></a>05654         <span class="comment">// --------------------------------</span>
<a name="l05655"></a>05655         <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
<a name="l05656"></a>05656         <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
<a name="l05657"></a>05657         <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
<a name="l05658"></a>05658         <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
<a name="l05659"></a>05659         <span class="comment">//</span>
<a name="l05660"></a>05660         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
<a name="l05661"></a>05661         {
<a name="l05662"></a>05662             <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
<a name="l05663"></a>05663                 theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05664"></a>05664                 strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());       <span class="comment">// &quot;markets/&lt;serverID&gt;/market_data.bin&quot;</span>
<a name="l05665"></a>05665             <span class="keywordflow">if</span> (!bSuccessErase)
<a name="l05666"></a>05666                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing market list from market folder: %s \n&quot;</span>, strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05667"></a>05667 
<a name="l05668"></a>05668             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05669"></a>05669         }
<a name="l05670"></a>05670 
<a name="l05671"></a>05671         <span class="comment">// --------------------------------</span>
<a name="l05672"></a>05672 
<a name="l05673"></a>05673         <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
<a name="l05674"></a>05674 
<a name="l05675"></a>05675         <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
<a name="l05676"></a>05676         {
<a name="l05677"></a>05677             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketList reply.\n&quot;</span>);
<a name="l05678"></a>05678             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05679"></a>05679         }
<a name="l05680"></a>05680 
<a name="l05681"></a>05681         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05682"></a>05682         <span class="comment">// Unpack the market list...</span>
<a name="l05683"></a>05683 
<a name="l05684"></a>05684         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l05685"></a>05685 
<a name="l05686"></a>05686         <span class="comment">// -----------------------------</span>
<a name="l05687"></a>05687 
<a name="l05688"></a>05688         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
<a name="l05689"></a>05689         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
<a name="l05690"></a>05690         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>
<a name="l05691"></a>05691 
<a name="l05692"></a>05692         pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());
<a name="l05693"></a>05693 
<a name="l05694"></a>05694         <span class="comment">// -----------------------------</span>
<a name="l05695"></a>05695 
<a name="l05696"></a>05696         <a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a> * pMarketList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a7a0f581c82f5599271fcd57d0a020f99">OTDB::STORED_OBJ_MARKET_LIST</a>));
<a name="l05697"></a>05697         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::MarketList&gt;</a> theListAngel(*pMarketList);
<a name="l05698"></a>05698 
<a name="l05699"></a>05699         <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pMarketList);
<a name="l05700"></a>05700 
<a name="l05701"></a>05701         <span class="comment">// ----------------------</span>
<a name="l05702"></a>05702 
<a name="l05703"></a>05703         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
<a name="l05704"></a>05704         {
<a name="l05705"></a>05705             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Process Server Reply: Failed unpacking data for @getMarketList.\n&quot;</span>);
<a name="l05706"></a>05706             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05707"></a>05707         }
<a name="l05708"></a>05708 
<a name="l05709"></a>05709         <span class="comment">// --------------------------------------------------------</span>
<a name="l05710"></a>05710 
<a name="l05711"></a>05711 
<a name="l05712"></a>05712         <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pMarketList,    
<a name="l05713"></a>05713             <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
<a name="l05714"></a>05714             theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05715"></a>05715             strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());       <span class="comment">// &quot;markets/&lt;serverID&gt;/market_data.bin&quot;</span>
<a name="l05716"></a>05716         <span class="keywordflow">if</span> (!bSuccessStore)
<a name="l05717"></a>05717             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing market list to market folder: %s \n&quot;</span>, strMarketDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05718"></a>05718 
<a name="l05719"></a>05719         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05720"></a>05720     }
<a name="l05721"></a>05721     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketOffers&quot;</span>))
<a name="l05722"></a>05722     {
<a name="l05723"></a>05723         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMarketID = theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>; <span class="comment">// market ID stored here.</span>
<a name="l05724"></a>05724 
<a name="l05725"></a>05725         <a class="code" href="class_o_t_string.html">OTString</a> strOfferDatafile;
<a name="l05726"></a>05726         strOfferDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, strMarketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05727"></a>05727 
<a name="l05728"></a>05728         <span class="comment">// ---------------------------------------</span>
<a name="l05729"></a>05729 
<a name="l05730"></a>05730         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l05731"></a>05731         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l05732"></a>05732 
<a name="l05733"></a>05733         <span class="comment">// --------------------------------</span>
<a name="l05734"></a>05734         <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
<a name="l05735"></a>05735         <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
<a name="l05736"></a>05736         <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
<a name="l05737"></a>05737         <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
<a name="l05738"></a>05738         <span class="comment">//</span>
<a name="l05739"></a>05739         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
<a name="l05740"></a>05740         {
<a name="l05741"></a>05741             <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
<a name="l05742"></a>05742                 theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05743"></a>05743                 <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
<a name="l05744"></a>05744                 strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/offers/&lt;marketID&gt;.bin&quot;</span>
<a name="l05745"></a>05745             <span class="keywordflow">if</span> (!bSuccessErase)
<a name="l05746"></a>05746                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing offers list from market folder: %s \n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05747"></a>05747 
<a name="l05748"></a>05748             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05749"></a>05749         }
<a name="l05750"></a>05750 
<a name="l05751"></a>05751         <span class="comment">// --------------------------------</span>
<a name="l05752"></a>05752 
<a name="l05753"></a>05753         <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
<a name="l05754"></a>05754 
<a name="l05755"></a>05755         <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
<a name="l05756"></a>05756         {
<a name="l05757"></a>05757             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketOffers reply.\n&quot;</span>);
<a name="l05758"></a>05758             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05759"></a>05759         }
<a name="l05760"></a>05760 
<a name="l05761"></a>05761         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05762"></a>05762         <span class="comment">// Unpack the market list...</span>
<a name="l05763"></a>05763 
<a name="l05764"></a>05764         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l05765"></a>05765 
<a name="l05766"></a>05766         <span class="comment">// -----------------------------</span>
<a name="l05767"></a>05767 
<a name="l05768"></a>05768         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
<a name="l05769"></a>05769         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
<a name="l05770"></a>05770         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>
<a name="l05771"></a>05771 
<a name="l05772"></a>05772         pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());
<a name="l05773"></a>05773 
<a name="l05774"></a>05774         <span class="comment">// -----------------------------</span>
<a name="l05775"></a>05775 
<a name="l05776"></a>05776         <a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> * pOfferList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_market.html">OTDB::OfferListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a2b54a22ce17683d3970981ec94203ad1">OTDB::STORED_OBJ_OFFER_LIST_MARKET</a>));
<a name="l05777"></a>05777         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListMarket&gt;</a> theListAngel(*pOfferList);
<a name="l05778"></a>05778 
<a name="l05779"></a>05779         <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pOfferList);
<a name="l05780"></a>05780 
<a name="l05781"></a>05781         <span class="comment">// --------------------------------------------------------</span>
<a name="l05782"></a>05782 
<a name="l05783"></a>05783         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
<a name="l05784"></a>05784         {
<a name="l05785"></a>05785             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getMarketOffers.\n&quot;</span>);
<a name="l05786"></a>05786             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05787"></a>05787         }
<a name="l05788"></a>05788 
<a name="l05789"></a>05789         <span class="comment">// --------------------------------------------------------</span>
<a name="l05790"></a>05790 
<a name="l05791"></a>05791         <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pOfferList, 
<a name="l05792"></a>05792             <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
<a name="l05793"></a>05793             theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05794"></a>05794             <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
<a name="l05795"></a>05795             strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/offers/&lt;marketID&gt;.bin&quot;</span>
<a name="l05796"></a>05796         <span class="keywordflow">if</span> (!bSuccessStore)
<a name="l05797"></a>05797             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to market folder.\n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05798"></a>05798 
<a name="l05799"></a>05799         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05800"></a>05800     }
<a name="l05801"></a>05801     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getMarketRecentTrades&quot;</span>))
<a name="l05802"></a>05802     {
<a name="l05803"></a>05803         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strMarketID = theReply.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>; <span class="comment">// market ID stored here.</span>
<a name="l05804"></a>05804 
<a name="l05805"></a>05805         <a class="code" href="class_o_t_string.html">OTString</a> strTradeDatafile;
<a name="l05806"></a>05806         strTradeDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, strMarketID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05807"></a>05807 
<a name="l05808"></a>05808         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05809"></a>05809 
<a name="l05810"></a>05810         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l05811"></a>05811         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l05812"></a>05812 
<a name="l05813"></a>05813         <span class="comment">// --------------------------------</span>
<a name="l05814"></a>05814         <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
<a name="l05815"></a>05815         <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
<a name="l05816"></a>05816         <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
<a name="l05817"></a>05817         <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
<a name="l05818"></a>05818         <span class="comment">//</span>
<a name="l05819"></a>05819         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
<a name="l05820"></a>05820         {
<a name="l05821"></a>05821             <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),           <span class="comment">// &quot;markets&quot;</span>
<a name="l05822"></a>05822                 theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05823"></a>05823                 <span class="stringliteral">&quot;recent&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/recent&quot;   // todo stop hardcoding.</span>
<a name="l05824"></a>05824                 strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/recent/&lt;marketID&gt;.bin&quot;</span>
<a name="l05825"></a>05825             <span class="keywordflow">if</span> (!bSuccessErase)
<a name="l05826"></a>05826                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing recent trades list from market folder: %s \n&quot;</span>, strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05827"></a>05827 
<a name="l05828"></a>05828             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05829"></a>05829         }
<a name="l05830"></a>05830 
<a name="l05831"></a>05831         <span class="comment">// --------------------------------</span>
<a name="l05832"></a>05832 
<a name="l05833"></a>05833         <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
<a name="l05834"></a>05834 
<a name="l05835"></a>05835         <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
<a name="l05836"></a>05836         {
<a name="l05837"></a>05837             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getMarketRecentTrades reply.\n&quot;</span>);
<a name="l05838"></a>05838             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05839"></a>05839         }
<a name="l05840"></a>05840 
<a name="l05841"></a>05841         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05842"></a>05842         <span class="comment">// Unpack the market list...</span>
<a name="l05843"></a>05843 
<a name="l05844"></a>05844         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l05845"></a>05845 
<a name="l05846"></a>05846         <span class="comment">// -----------------------------</span>
<a name="l05847"></a>05847 
<a name="l05848"></a>05848         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
<a name="l05849"></a>05849         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
<a name="l05850"></a>05850         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>
<a name="l05851"></a>05851 
<a name="l05852"></a>05852         pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());
<a name="l05853"></a>05853 
<a name="l05854"></a>05854         <span class="comment">// -----------------------------</span>
<a name="l05855"></a>05855 
<a name="l05856"></a>05856         <a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a> * pTradeList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_trade_list_market.html">OTDB::TradeListMarket</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a3d18519334f9da70d7341ecb6c18010f">OTDB::STORED_OBJ_TRADE_LIST_MARKET</a>));
<a name="l05857"></a>05857         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::TradeListMarket&gt;</a> theListAngel(*pTradeList);
<a name="l05858"></a>05858 
<a name="l05859"></a>05859         <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pTradeList);
<a name="l05860"></a>05860 
<a name="l05861"></a>05861         <span class="comment">// --------------------------------------------------------</span>
<a name="l05862"></a>05862 
<a name="l05863"></a>05863         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
<a name="l05864"></a>05864         {
<a name="l05865"></a>05865             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getMarketRecentTrades.\n&quot;</span>);
<a name="l05866"></a>05866             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05867"></a>05867         }
<a name="l05868"></a>05868 
<a name="l05869"></a>05869         <span class="comment">// --------------------------------------------------------</span>
<a name="l05870"></a>05870 
<a name="l05871"></a>05871         <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pTradeList, 
<a name="l05872"></a>05872             <a class="code" href="class_o_t_folders.html#a7ed5b4b672d4645f7f72f9ca94421a61">OTFolders::Market</a>().Get(),          <span class="comment">// &quot;markets&quot;</span>
<a name="l05873"></a>05873             theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;markets/&lt;serverID&gt;&quot;</span>
<a name="l05874"></a>05874             <span class="stringliteral">&quot;recent&quot;</span>,                       <span class="comment">// &quot;markets/&lt;serverID&gt;/recent&quot;   // todo stop hardcoding.</span>
<a name="l05875"></a>05875             strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;markets/&lt;serverID&gt;/recent/&lt;marketID&gt;.bin&quot;</span>
<a name="l05876"></a>05876         <span class="keywordflow">if</span> (!bSuccessStore)
<a name="l05877"></a>05877             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to market folder.\n&quot;</span>, strTradeDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05878"></a>05878 
<a name="l05879"></a>05879         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05880"></a>05880     }
<a name="l05881"></a>05881     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@getNym_MarketOffers&quot;</span>))
<a name="l05882"></a>05882     {
<a name="l05883"></a>05883         <a class="code" href="class_o_t_string.html">OTString</a> strOfferDatafile;
<a name="l05884"></a>05884         strOfferDatafile.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.bin&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05885"></a>05885 
<a name="l05886"></a>05886         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05887"></a>05887 
<a name="l05888"></a>05888         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l05889"></a>05889         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l05890"></a>05890 
<a name="l05891"></a>05891         <span class="comment">// --------------------------------</span>
<a name="l05892"></a>05892         <span class="comment">// The reply is a SUCCESS, and the COUNT is 0 (empty list was returned.)</span>
<a name="l05893"></a>05893         <span class="comment">// Since it was a success, but the list was empty, then we need to erase</span>
<a name="l05894"></a>05894         <span class="comment">// the data file. (So when the file is loaded from storage, it will correctly</span>
<a name="l05895"></a>05895         <span class="comment">// display an empty list on the screen, instead of a list of outdated items.)</span>
<a name="l05896"></a>05896         <span class="comment">//</span>
<a name="l05897"></a>05897         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a> == 0)
<a name="l05898"></a>05898         {
<a name="l05899"></a>05899             <span class="keywordtype">bool</span> bSuccessErase = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#ad1a20354a3bf349b33ea8ce9b0db0d64">EraseValueByKey</a>(<a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),              <span class="comment">// &quot;nyms&quot;</span>
<a name="l05900"></a>05900                 theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;nyms/&lt;serverID&gt;&quot;</span>
<a name="l05901"></a>05901                 <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
<a name="l05902"></a>05902                 strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers/&lt;NymID&gt;.bin&quot;</span>
<a name="l05903"></a>05903             <span class="keywordflow">if</span> (!bSuccessErase)
<a name="l05904"></a>05904                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error erasing offers list from nyms folder: %s \n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05905"></a>05905 
<a name="l05906"></a>05906             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05907"></a>05907         }
<a name="l05908"></a>05908 
<a name="l05909"></a>05909         <span class="comment">// --------------------------------</span>
<a name="l05910"></a>05910 
<a name="l05911"></a>05911         <a class="code" href="class_o_t_payload.html">OTPayload</a> thePayload;
<a name="l05912"></a>05912 
<a name="l05913"></a>05913         <span class="keywordflow">if</span> ((theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 2) || (<span class="keyword">false</span> == theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a5564f05ead3366c5b97c8b7edfea083b">GetData</a>(thePayload)))
<a name="l05914"></a>05914         {
<a name="l05915"></a>05915             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;ProcessServerReply: unable to decode ascii-armored payload in @getNym_MarketOffers reply.\n&quot;</span>);
<a name="l05916"></a>05916             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05917"></a>05917         }
<a name="l05918"></a>05918 
<a name="l05919"></a>05919         <span class="comment">// -------------------------------------------------------------</span>
<a name="l05920"></a>05920         <span class="comment">// Unpack the nym&#39;s offer list...</span>
<a name="l05921"></a>05921 
<a name="l05922"></a>05922         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l05923"></a>05923 
<a name="l05924"></a>05924         <span class="comment">// -----------------------------</span>
<a name="l05925"></a>05925 
<a name="l05926"></a>05926         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a0782e21522b9971ffc30c5b96c227270">CreateBuffer</a>(); <span class="comment">// Need to clean this up.</span>
<a name="l05927"></a>05927         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBuffer);
<a name="l05928"></a>05928         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure buffer is deleted.</span>
<a name="l05929"></a>05929 
<a name="l05930"></a>05930         pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a2606072b6e318e2e6777904734a0578d">SetData</a>(static_cast&lt;const uint8_t*&gt;(thePayload.<a class="code" href="class_o_t_payload.html#aef8d7f40ba7886f7da16290091681aa9">GetPayloadPointer</a>()), thePayload.<a class="code" href="class_o_t_data.html#a18fd0599061eaf2c031548e030c3112d">GetSize</a>());
<a name="l05931"></a>05931 
<a name="l05932"></a>05932         <span class="comment">// -----------------------------</span>
<a name="l05933"></a>05933 
<a name="l05934"></a>05934         <a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> * pOfferList = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a976d0f2d070c94e031644952c6fb78d4">OTDB::STORED_OBJ_OFFER_LIST_NYM</a>));
<a name="l05935"></a>05935         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListNym&gt;</a> theListAngel(*pOfferList);
<a name="l05936"></a>05936 
<a name="l05937"></a>05937         <span class="keywordtype">bool</span> bUnpacked = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a2e3ce402e77d0cbeb4b4507b24f51cf0">Unpack</a>(*pBuffer, *pOfferList);
<a name="l05938"></a>05938 
<a name="l05939"></a>05939         <span class="comment">// --------------------------------------------------------</span>
<a name="l05940"></a>05940 
<a name="l05941"></a>05941         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bUnpacked)
<a name="l05942"></a>05942         {
<a name="l05943"></a>05943             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed unpacking data for process server reply, @getNym_MarketOffers.\n&quot;</span>);
<a name="l05944"></a>05944             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05945"></a>05945         }
<a name="l05946"></a>05946 
<a name="l05947"></a>05947         <span class="comment">// --------------------------------------------------------</span>
<a name="l05948"></a>05948 
<a name="l05949"></a>05949         <span class="keywordtype">bool</span> bSuccessStore = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a8e54119f93134acde9b6072f61e16e1b">StoreObject</a>(*pOfferList, 
<a name="l05950"></a>05950             <a class="code" href="class_o_t_folders.html#a3bcdf222bf351ad8b5cfb37e9b8e5143">OTFolders::Nym</a>().Get(),             <span class="comment">// &quot;nyms&quot;</span>
<a name="l05951"></a>05951             theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),   <span class="comment">// &quot;nyms/&lt;serverID&gt;&quot;</span>
<a name="l05952"></a>05952             <span class="stringliteral">&quot;offers&quot;</span>,                       <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers&quot;   // todo stop hardcoding.</span>
<a name="l05953"></a>05953             strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());            <span class="comment">// &quot;nyms/&lt;serverID&gt;/offers/&lt;NymID&gt;.bin&quot;</span>
<a name="l05954"></a>05954         <span class="keywordflow">if</span> (!bSuccessStore)
<a name="l05955"></a>05955             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error storing %s to nyms folder.\n&quot;</span>, strOfferDatafile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05956"></a>05956 
<a name="l05957"></a>05957         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05958"></a>05958     }
<a name="l05959"></a>05959 
<a name="l05960"></a>05960     <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l05961"></a>05961     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@deleteUserAccount&quot;</span>))
<a name="l05962"></a>05962     {
<a name="l05963"></a>05963         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
<a name="l05964"></a>05964         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05965"></a>05965             theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);
<a name="l05966"></a>05966 
<a name="l05967"></a>05967         <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;
<a name="l05968"></a>05968 
<a name="l05969"></a>05969         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05970"></a>05970 
<a name="l05971"></a>05971         <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
<a name="l05972"></a>05972             theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
<a name="l05973"></a>05973             theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym) &amp;&amp;
<a name="l05974"></a>05974             theOriginalMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>) &amp;&amp;
<a name="l05975"></a>05975             theOriginalMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteUserAccount&quot;</span>)
<a name="l05976"></a>05976             )
<a name="l05977"></a>05977         {
<a name="l05978"></a>05978             <span class="comment">// O-kayy!!</span>
<a name="l05979"></a>05979 
<a name="l05980"></a>05980             <span class="comment">// ------------------------------------------------</span>
<a name="l05981"></a>05981             <span class="keywordflow">while</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &gt; 0)
<a name="l05982"></a>05982             {
<a name="l05983"></a>05983                 int64_t lTemp = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aaeccb4cd9e65abe19f382faee5ad8fd1">GetTransactionNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
<a name="l05984"></a>05984                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3fb93588f8e68c7f56cee00930f07d34">RemoveTransactionNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
<a name="l05985"></a>05985             }
<a name="l05986"></a>05986             <span class="comment">// ------------------------------------------------</span>
<a name="l05987"></a>05987             <span class="keywordflow">while</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac4fec9b0b744c9fbe3bae82c25661d19">GetIssuedNumCount</a>(SERVER_ID) &gt; 0)
<a name="l05988"></a>05988             {
<a name="l05989"></a>05989                 int64_t lTemp = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ada98078d45460303c6a746c53381f5aa">GetIssuedNum</a>(SERVER_ID, 0); <span class="comment">// index 0</span>
<a name="l05990"></a>05990                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a17f25f5eb52440cc3ffc139dcbff75fe">RemoveIssuedNum</a>(strServerID, lTemp); <span class="comment">// doesn&#39;t save.</span>
<a name="l05991"></a>05991             }       
<a name="l05992"></a>05992             <span class="comment">// ------------------------------------------------</span>
<a name="l05993"></a>05993             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aec22b071d4218d5b49ce88236cd8cfb5">UnRegisterAtServer</a>(strServerID); <span class="comment">// Remove request number for that server.</span>
<a name="l05994"></a>05994             <span class="comment">// ------------------------------------------------</span>
<a name="l05995"></a>05995 
<a name="l05996"></a>05996             <span class="comment">// SAVE the updated Nym to local storage.</span>
<a name="l05997"></a>05997             <span class="comment">//</span>
<a name="l05998"></a>05998             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; extraNym = *pNym;
<a name="l05999"></a>05999             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(extraNym);
<a name="l06000"></a>06000 
<a name="l06001"></a>06001             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Successfully DELETED Nym from Server: removed request number, plus all issued and transaction numbers &quot;</span>
<a name="l06002"></a>06002                 <span class="stringliteral">&quot;for Nym %s for Server %s.\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06003"></a>06003         }
<a name="l06004"></a>06004         <span class="keywordflow">else</span>
<a name="l06005"></a>06005             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;The server just for some reason tried to trick me into erasing my issued &quot;</span>
<a name="l06006"></a>06006             <span class="stringliteral">&quot;and transaction numbers for Nym %s, Server %s.\n&quot;</span>, theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06007"></a>06007 
<a name="l06008"></a>06008         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06009"></a>06009     }
<a name="l06010"></a>06010     <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l06011"></a>06011 
<a name="l06012"></a>06012     <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l06013"></a>06013     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@deleteAssetAccount&quot;</span>))
<a name="l06014"></a>06014     {
<a name="l06015"></a>06015         <a class="code" href="class_o_t_string.html">OTString</a> strOriginalMessage;
<a name="l06016"></a>06016         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06017"></a>06017             theReply.<a class="code" href="class_o_t_message.html#ad43c857a2a741df19c3c31b551df5eb0">m_ascInReferenceTo</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOriginalMessage);
<a name="l06018"></a>06018 
<a name="l06019"></a>06019         <a class="code" href="class_o_t_message.html">OTMessage</a> theOriginalMessage;
<a name="l06020"></a>06020 
<a name="l06021"></a>06021         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l06022"></a>06022 
<a name="l06023"></a>06023         <span class="keywordflow">if</span> (strOriginalMessage.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
<a name="l06024"></a>06024             theOriginalMessage.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strOriginalMessage) &amp;&amp;
<a name="l06025"></a>06025             theOriginalMessage.<a class="code" href="class_o_t_message.html#aa61f745665166abf8bed98f47c6252d0">VerifySignature</a>(*pNym) &amp;&amp;
<a name="l06026"></a>06026             theOriginalMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>) &amp;&amp;
<a name="l06027"></a>06027             theOriginalMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>) &amp;&amp;
<a name="l06028"></a>06028             theOriginalMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;deleteAssetAccount&quot;</span>)
<a name="l06029"></a>06029             )
<a name="l06030"></a>06030         {
<a name="l06031"></a>06031             <span class="comment">// O-kayy!!</span>
<a name="l06032"></a>06032 
<a name="l06033"></a>06033             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID(theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l06034"></a>06034 
<a name="l06035"></a>06035             <a class="code" href="class_o_t_account.html">OTAccount</a> * pDeletedAcct = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);
<a name="l06036"></a>06036 
<a name="l06037"></a>06037             <span class="keywordflow">if</span> (NULL != pDeletedAcct)
<a name="l06038"></a>06038             {
<a name="l06039"></a>06039                 pDeletedAcct-&gt;<a class="code" href="class_o_t_account.html#aea147dd5991690f6a6f9e2500cf39872">MarkForDeletion</a>();
<a name="l06040"></a>06040                 <span class="comment">// ---------------------------------</span>
<a name="l06041"></a>06041                 pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l06042"></a>06042                 pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l06043"></a>06043                 pDeletedAcct-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); 
<a name="l06044"></a>06044                 pDeletedAcct-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l06045"></a>06045                 <span class="comment">// (The account still exists in storage, but has been MARKED FOR DELETION.)</span>
<a name="l06046"></a>06046 
<a name="l06047"></a>06047                 <span class="comment">// ---------------------------------</span>
<a name="l06048"></a>06048                 <span class="comment">// Remove the account from the wallet:</span>
<a name="l06049"></a>06049                 <span class="comment">//</span>
<a name="l06050"></a>06050                 <span class="keywordflow">if</span> (m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#abc47515d8104ba094bab2417d66a5161">RemoveAccount</a>(theAccountID))
<a name="l06051"></a>06051                 {
<a name="l06052"></a>06052                     m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l06053"></a>06053                 }
<a name="l06054"></a>06054                 <span class="comment">// ---------------------------------</span>
<a name="l06055"></a>06055             }
<a name="l06056"></a>06056 
<a name="l06057"></a>06057             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Successfully DELETED Asset Acct %s from Server: %s.\n&quot;</span>,
<a name="l06058"></a>06058                 theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06059"></a>06059         }
<a name="l06060"></a>06060         <span class="keywordflow">else</span>
<a name="l06061"></a>06061             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;The server just for some reason tried to trick me into erasing my account %s on Server %s.\n&quot;</span>,
<a name="l06062"></a>06062             theReply.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06063"></a>06063 
<a name="l06064"></a>06064         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06065"></a>06065     }
<a name="l06066"></a>06066     <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l06067"></a>06067 
<a name="l06068"></a>06068     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@issueAssetType&quot;</span>))
<a name="l06069"></a>06069     {
<a name="l06070"></a>06070         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
<a name="l06071"></a>06071         {
<a name="l06072"></a>06072             <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount = NULL;
<a name="l06073"></a>06073 
<a name="l06074"></a>06074             <span class="comment">// this decodes the ascii-armor payload where the new account file</span>
<a name="l06075"></a>06075             <span class="comment">// is stored, and returns a normal string in strAcctContents.</span>
<a name="l06076"></a>06076             <a class="code" href="class_o_t_string.html">OTString</a>    strAcctContents(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l06077"></a>06077 
<a name="l06078"></a>06078             <span class="comment">// TODO check return value</span>
<a name="l06079"></a>06079             pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l06080"></a>06080 
<a name="l06081"></a>06081             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAcctContents) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
<a name="l06082"></a>06082             {
<a name="l06083"></a>06083                 <span class="comment">// (2) Sign the Account </span>
<a name="l06084"></a>06084                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);      
<a name="l06085"></a>06085                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06086"></a>06086 
<a name="l06087"></a>06087                 <span class="comment">// (3) Save the Account to file</span>
<a name="l06088"></a>06088                 pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l06089"></a>06089 
<a name="l06090"></a>06090                 <span class="comment">// Need to consider other security considerations.</span>
<a name="l06091"></a>06091                 <span class="comment">// What if I wasn&#39;t EXPECTING a @issueAssetType message?</span>
<a name="l06092"></a>06092                 <span class="comment">// Well actually, in that case, the server wouldn&#39;t have a</span>
<a name="l06093"></a>06093                 <span class="comment">// copy of my request to send back to me, would he? So I should</span>
<a name="l06094"></a>06094                 <span class="comment">// check that request to make sure it&#39;s good.</span>
<a name="l06095"></a>06095                 <span class="comment">// Also maybe should check to see if I was expecting this message</span>
<a name="l06096"></a>06096                 <span class="comment">// in the first place.</span>
<a name="l06097"></a>06097 
<a name="l06098"></a>06098                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);               
<a name="l06099"></a>06099                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); 
<a name="l06100"></a>06100 
<a name="l06101"></a>06101                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06102"></a>06102             }
<a name="l06103"></a>06103             <span class="keywordflow">else</span> 
<a name="l06104"></a>06104             {
<a name="l06105"></a>06105                 <span class="keyword">delete</span> pAccount;
<a name="l06106"></a>06106                 pAccount = NULL;
<a name="l06107"></a>06107             }
<a name="l06108"></a>06108 
<a name="l06109"></a>06109         }
<a name="l06110"></a>06110     }
<a name="l06111"></a>06111 
<a name="l06112"></a>06112     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> &amp;&amp; theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;@createAccount&quot;</span>))
<a name="l06113"></a>06113     {
<a name="l06114"></a>06114         <span class="keywordflow">if</span> (theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>())
<a name="l06115"></a>06115         {
<a name="l06116"></a>06116             <a class="code" href="class_o_t_account.html">OTAccount</a>   * pAccount = NULL;
<a name="l06117"></a>06117 
<a name="l06118"></a>06118             <span class="comment">// this decodes the ascii-armor payload where the new account file</span>
<a name="l06119"></a>06119             <span class="comment">// is stored, and returns a normal string in strAcctContents.</span>
<a name="l06120"></a>06120             <a class="code" href="class_o_t_string.html">OTString</a>    strAcctContents(theReply.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>);
<a name="l06121"></a>06121 
<a name="l06122"></a>06122             pAccount = <span class="keyword">new</span> <a class="code" href="class_o_t_account.html">OTAccount</a>(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l06123"></a>06123 
<a name="l06124"></a>06124             <span class="keywordflow">if</span> (pAccount &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strAcctContents) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a5df67ad1e0b4d60e205c0a8e1ae5e703">VerifyAccount</a>(*pServerNym))
<a name="l06125"></a>06125             {
<a name="l06126"></a>06126                 <span class="comment">// (2) Sign the Account</span>
<a name="l06127"></a>06127                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();  <span class="comment">// So I don&#39;t get the annoying failure to verify message from the server&#39;s signature.</span>
<a name="l06128"></a>06128                 <span class="comment">// Will eventually end up keeping the signature, however, just for reasons of proof.</span>
<a name="l06129"></a>06129                 <span class="comment">// UPDATE (above) we are releasing these now, for good, since server&#39;s signature is not needed. Receipts are functional now, </span>
<a name="l06130"></a>06130                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);      <span class="comment">// and the last receipt IS signed by the server, and it can be used to verify the nym, account, inbox, and outbox. Nifty!</span>
<a name="l06131"></a>06131                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06132"></a>06132 
<a name="l06133"></a>06133                 <span class="comment">// (3) Save the Account to file</span>
<a name="l06134"></a>06134                 pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l06135"></a>06135 
<a name="l06136"></a>06136                 <span class="comment">// Need to consider other security considerations.</span>
<a name="l06137"></a>06137                 <span class="comment">// What if I wasn&#39;t EXPECTING a @createAccount message?</span>
<a name="l06138"></a>06138                 <span class="comment">// Well actually, in that case, the server wouldn&#39;t have a</span>
<a name="l06139"></a>06139                 <span class="comment">// copy of my request to send back to me, would he? So I should</span>
<a name="l06140"></a>06140                 <span class="comment">// check that request to make sure it&#39;s good.</span>
<a name="l06141"></a>06141                 <span class="comment">// Also maybe should check to see if I was expecting this message</span>
<a name="l06142"></a>06142                 <span class="comment">// in the first place.</span>
<a name="l06143"></a>06143 
<a name="l06144"></a>06144                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad9d3208fb49a461c1bc6310ea438cd6a">AddAccount</a>(*pAccount);
<a name="l06145"></a>06145                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l06146"></a>06146 
<a name="l06147"></a>06147                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06148"></a>06148             }
<a name="l06149"></a>06149             <span class="keywordflow">else</span> 
<a name="l06150"></a>06150             {
<a name="l06151"></a>06151                 <span class="keyword">delete</span> pAccount;
<a name="l06152"></a>06152                 pAccount = NULL;
<a name="l06153"></a>06153             }
<a name="l06154"></a>06154 
<a name="l06155"></a>06155         }
<a name="l06156"></a>06156     }
<a name="l06157"></a>06157     <span class="keywordflow">else</span> 
<a name="l06158"></a>06158     {
<a name="l06159"></a>06159 
<a name="l06160"></a>06160     }
<a name="l06161"></a>06161     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06162"></a>06162 }
<a name="l06163"></a>06163 
<a name="l06164"></a>06164 
<a name="l06165"></a>06165 
<a name="l06166"></a>06166 
<a name="l06167"></a>06167 
<a name="l06171"></a>06171 <span class="comment">//</span>
<a name="l06178"></a><a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">06178</a> <span class="comment"></span>int32_t <a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">OTClient::ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7">OTClient::OT_CLIENT_CMD_TYPE</a> requestedCommand,
<a name="l06179"></a>06179                                  <a class="code" href="class_o_t_message.html">OTMessage</a> &amp; theMessage,
<a name="l06180"></a>06180                                  <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l06181"></a>06181                                  <span class="comment">//                               OTAssetContract &amp; theContract,</span>
<a name="l06182"></a>06182                                  <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> &amp; theServer,
<a name="l06183"></a>06183                                  <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount<span class="comment">/*=NULL*/</span>,
<a name="l06184"></a>06184                                  int64_t lTransactionAmount<span class="comment">/*=0*/</span>,
<a name="l06185"></a>06185                                  <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pMyAssetContract<span class="comment">/*=NULL*/</span>,
<a name="l06186"></a>06186                                  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pHisNymID<span class="comment">/*=NULL*/</span>,
<a name="l06187"></a>06187                                  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pHisAcctID<span class="comment">/*=NULL*/</span>)
<a name="l06188"></a>06188 {
<a name="l06189"></a>06189     <span class="comment">// This is all preparatory work to get the various pieces of data together -- only</span>
<a name="l06190"></a>06190     <span class="comment">// then can we put those pieces into a message.</span>
<a name="l06191"></a>06191     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> CONTRACT_ID;
<a name="l06192"></a>06192     <a class="code" href="class_o_t_string.html">OTString</a> strNymID, strContractID, strServerID, strNymPublicKey, strAccountID;
<a name="l06193"></a>06193     int64_t lRequestNumber = 0;
<a name="l06194"></a>06194 
<a name="l06195"></a>06195     theNym.<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strNymID);
<a name="l06196"></a>06196     theServer.<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strServerID);
<a name="l06197"></a>06197 
<a name="l06198"></a>06198     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_ID(strServerID);
<a name="l06199"></a>06199 
<a name="l06200"></a>06200     <span class="keywordflow">if</span> (NULL != pAccount)
<a name="l06201"></a>06201     {
<a name="l06202"></a>06202         pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strAccountID);
<a name="l06203"></a>06203 
<a name="l06204"></a>06204         <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l06205"></a>06205         {
<a name="l06206"></a>06206             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l06207"></a>06207                 <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l06208"></a>06208             <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(-1);;
<a name="l06209"></a>06209         }
<a name="l06210"></a>06210     }
<a name="l06211"></a>06211     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l06212"></a>06212     <span class="keywordtype">bool</span> bSendCommand = <span class="keyword">false</span>;
<a name="l06213"></a>06213     int64_t lReturnValue = 0;
<a name="l06214"></a>06214 
<a name="l06215"></a>06215 
<a name="l06216"></a>06216     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l06217"></a>06217     <span class="comment">// -------------------------------------------------------------------- </span>
<a name="l06218"></a>06218 
<a name="l06219"></a>06219     <span class="comment">// THE BIG SWITCH (inside a code block for neatness</span>
<a name="l06220"></a>06220     <span class="keywordflow">switch</span>(requestedCommand)
<a name="l06221"></a>06221     {
<a name="l06222"></a>06222 
<a name="l06223"></a>06223     <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">OTClient::checkServerID</a>) :
<a name="l06224"></a>06224         {
<a name="l06225"></a>06225             <a class="code" href="class_o_t_string.html">OTString</a> strAuthentKey, strEncryptionKey;
<a name="l06226"></a>06226 
<a name="l06227"></a>06227             theNym.<a class="code" href="class_o_t_pseudonym.html#add05942697a8f16ee9259d8cccc271c8">GetPublicAuthKey</a>().<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strAuthentKey   );
<a name="l06228"></a>06228             theNym.<a class="code" href="class_o_t_pseudonym.html#a7a7b836bb9e8e0df7b3601f44e1b7220">GetPublicEncrKey</a>().<a class="code" href="class_o_t_asymmetric_key.html#ab4eee84fb4faf0a374fa10f110853214">GetPublicKey</a>(strEncryptionKey);
<a name="l06229"></a>06229 
<a name="l06230"></a>06230             <span class="comment">// (1) set up member variables </span>
<a name="l06231"></a>06231             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;checkServerID&quot;</span>;
<a name="l06232"></a>06232             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;          <span class="comment">// Not expected to verify in any way (for this message.) Just mirrored back in the reply.</span>
<a name="l06233"></a>06233             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l06234"></a>06234             theMessage.<a class="code" href="class_o_t_message.html#af528755324c93b7364ddef38cd6b6709">m_strNymPublicKey</a> = strAuthentKey;     <span class="comment">// Authentication public key for this Nym. (That he&#39;s signing this message with...)</span>
<a name="l06235"></a>06235             theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strEncryptionKey;  <span class="comment">// Encryption public key for this Nym (to send an encrypted reply back.)</span>
<a name="l06236"></a>06236 
<a name="l06237"></a>06237             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>
<a name="l06238"></a>06238 
<a name="l06239"></a>06239             <span class="comment">// (2) Sign the Message </span>
<a name="l06240"></a>06240             <span class="comment">// When a message is signed, it updates its m_xmlUnsigned contents to</span>
<a name="l06241"></a>06241             <span class="comment">// the values in the member variables</span>
<a name="l06242"></a>06242             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06243"></a>06243 
<a name="l06244"></a>06244             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06245"></a>06245             <span class="comment">//</span>
<a name="l06246"></a>06246             <span class="comment">// FYI, SaveContract takes m_xmlUnsigned and wraps it with the signatures and ------- BEGIN  bookends</span>
<a name="l06247"></a>06247             <span class="comment">// If you don&#39;t pass a string in, then SaveContract saves the new version to its member, m_strRawFile</span>
<a name="l06248"></a>06248             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06249"></a>06249 
<a name="l06250"></a>06250             bSendCommand = <span class="keyword">true</span>;
<a name="l06251"></a>06251             lReturnValue = 1;
<a name="l06252"></a>06252 
<a name="l06253"></a>06253             <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06254"></a>06254         }
<a name="l06255"></a>06255         <span class="keywordflow">break</span>;
<a name="l06256"></a>06256             
<a name="l06257"></a>06257     <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">OTClient::createUserAccount</a>):
<a name="l06258"></a>06258         {
<a name="l06259"></a>06259             <span class="comment">// -----------------------------</span>
<a name="l06260"></a>06260             <span class="comment">// Create a new OTDB::StringMap object.</span>
<a name="l06261"></a>06261             <span class="comment">//</span>
<a name="l06262"></a>06262             <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
<a name="l06263"></a>06263             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
<a name="l06264"></a>06264             <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
<a name="l06265"></a>06265             <span class="comment">// --------------------------------------------------------------</span>
<a name="l06266"></a>06266             pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
<a name="l06267"></a>06267             theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l06268"></a>06268             pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l06269"></a>06269             <span class="comment">// --------------------------------------------------------------</span>
<a name="l06270"></a>06270             <span class="keywordflow">if</span> (NULL == pMap)
<a name="l06271"></a>06271                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to load or create a STORED_OBJ_STRING_MAP.\n&quot;</span>,
<a name="l06272"></a>06272                 __FUNCTION__);        
<a name="l06273"></a>06273             <span class="keywordflow">else</span> <span class="comment">// It instantiated.</span>
<a name="l06274"></a>06274             {    <span class="comment">// -----------------------------------------------</span>
<a name="l06275"></a>06275                 <a class="code" href="class_o_t_string.html">OTString</a>       strCredList;
<a name="l06276"></a>06276                 <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l06277"></a>06277 
<a name="l06278"></a>06278                 <span class="comment">// Credentials exist already.</span>
<a name="l06279"></a>06279                 <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0)
<a name="l06280"></a>06280                 {
<a name="l06281"></a>06281                     theNym.<a class="code" href="class_o_t_pseudonym.html#a356d33b203d025ec66a43e23c63c55ed">GetPublicCredentials</a>(strCredList, &amp;theMap);
<a name="l06282"></a>06282                 }
<a name="l06283"></a>06283                 <span class="keywordflow">else</span> <span class="comment">// No credentials? Create them, then.</span>
<a name="l06284"></a>06284                 {
<a name="l06285"></a>06285                     <a class="code" href="class_o_t_string.html">OTString</a> strMasterCredID;
<a name="l06286"></a>06286                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bAddedMaster = theNym.<a class="code" href="class_o_t_pseudonym.html#aca99509bdb4ceb7ff4fdb793998aa794">AddNewMasterCredential</a>(strMasterCredID);
<a name="l06287"></a>06287 
<a name="l06288"></a>06288                     <span class="keywordflow">if</span> (bAddedMaster &amp;&amp; strMasterCredID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theNym.<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0))
<a name="l06289"></a>06289                     {
<a name="l06290"></a>06290                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Adding new keyCredential to master credential: %s\n&quot;</span>,
<a name="l06291"></a>06291                             __FUNCTION__, strMasterCredID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06292"></a>06292 
<a name="l06293"></a>06293                         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theMasterCredID(strMasterCredID);
<a name="l06294"></a>06294 
<a name="l06295"></a>06295                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bAddedSubkey = theNym.<a class="code" href="class_o_t_pseudonym.html#a85bd691ffa8d5f066ba04886dccd0d4d">AddNewSubkey</a>(theMasterCredID);
<a name="l06296"></a>06296 
<a name="l06297"></a>06297                         <span class="keywordflow">if</span> (bAddedSubkey)
<a name="l06298"></a>06298                         {
<a name="l06299"></a>06299                             theNym.<a class="code" href="class_o_t_pseudonym.html#af3709c1b5203330b607ca0f0acff9c53">SaveCredentialList</a>();
<a name="l06300"></a>06300                             theNym.<a class="code" href="class_o_t_pseudonym.html#a356d33b203d025ec66a43e23c63c55ed">GetPublicCredentials</a>(strCredList, &amp;theMap);
<a name="l06301"></a>06301                         }
<a name="l06302"></a>06302                         <span class="keywordflow">else</span>
<a name="l06303"></a>06303                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to add new keyCredential to new Master credential.\n&quot;</span>,
<a name="l06304"></a>06304                             __FUNCTION__);
<a name="l06305"></a>06305                     }
<a name="l06306"></a>06306                     <span class="keywordflow">else</span>
<a name="l06307"></a>06307                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to add new master credential (for Nym who doesn&#39;t have one yet.)\n&quot;</span>,
<a name="l06308"></a>06308                         __FUNCTION__);
<a name="l06309"></a>06309                 }
<a name="l06310"></a>06310                 <span class="comment">// -----------------------------------------------</span>
<a name="l06311"></a>06311                 <span class="comment">// Serialize the StringMap to a string...</span>
<a name="l06312"></a>06312                 <span class="comment">//</span>
<a name="l06313"></a>06313                 <span class="keywordflow">if</span> (strCredList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theMap.size() &gt; 0)) <span class="comment">// Won&#39;t bother if there are zero credentials somehow.</span>
<a name="l06314"></a>06314                 {
<a name="l06315"></a>06315                     std::string str_Encoded     = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
<a name="l06316"></a>06316                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessEncoding = (str_Encoded.size() &gt; 0);
<a name="l06317"></a>06317                     <span class="keywordflow">if</span> (bSuccessEncoding)
<a name="l06318"></a>06318                     {
<a name="l06319"></a>06319                         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strCredList);   <span class="comment">// &lt;========== Success</span>
<a name="l06320"></a>06320                         theMessage.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str());  <span class="comment">// Payload contains credentials list, payload2 contains actual credentials.</span>
<a name="l06321"></a>06321                     }
<a name="l06322"></a>06322                 }
<a name="l06323"></a>06323             }
<a name="l06324"></a>06324             <span class="comment">// ----------------------------------------------</span>
<a name="l06325"></a>06325             <span class="keywordflow">if</span> (!theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !theMessage.<a class="code" href="class_o_t_message.html#a8dfedea3c1a03a28ea67310bc4260c2b">m_ascPayload2</a>.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l06326"></a>06326             {
<a name="l06327"></a>06327                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to assemble a createUserAccount message: This Nym &quot;</span>
<a name="l06328"></a>06328                     <span class="stringliteral">&quot;has no credentials to use for registration. Convert this Nym &quot;</span>
<a name="l06329"></a>06329                     <span class="stringliteral">&quot;first to the new credential system, then try again.\n&quot;</span>, __FUNCTION__);
<a name="l06330"></a>06330             }
<a name="l06331"></a>06331             <span class="keywordflow">else</span>
<a name="l06332"></a>06332             {
<a name="l06333"></a>06333                 <span class="comment">// ----------------------------------------------</span>
<a name="l06334"></a>06334                 <span class="comment">// (1) set up member variables</span>
<a name="l06335"></a>06335                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;createUserAccount&quot;</span>;
<a name="l06336"></a>06336                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06337"></a>06337                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06338"></a>06338 
<a name="l06339"></a>06339                 <span class="comment">//          theNym.GetPublicKey().GetPublicKey(strNymPublicKey);</span>
<a name="l06340"></a>06340                 <span class="comment">//          theMessage.m_strNymPublicKey    = strNymPublicKey; // Deprecated. (Credentials are new.)</span>
<a name="l06341"></a>06341 
<a name="l06342"></a>06342                 <span class="comment">// THIS APPEARS SLIGHTLY ABOVE. Just leaving as a comment</span>
<a name="l06343"></a>06343                 <span class="comment">// here so it&#39;s not forgotten that this is also happening.</span>
<a name="l06344"></a>06344                 <span class="comment">//</span>
<a name="l06345"></a>06345                 <span class="comment">//          theMessage.m_ascPayload.SetString(strCredList);   // &lt;========== Success</span>
<a name="l06346"></a>06346                 <span class="comment">//          theMessage.m_ascPayload2.Set(str_Encoded.c_str());  // Payload contains credentials list, payload2 contains actual credentials.</span>
<a name="l06347"></a>06347 
<a name="l06348"></a>06348                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>
<a name="l06349"></a>06349 
<a name="l06350"></a>06350                 <span class="comment">// (2) Sign the Message </span>
<a name="l06351"></a>06351                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);
<a name="l06352"></a>06352 
<a name="l06353"></a>06353                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06354"></a>06354                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06355"></a>06355 
<a name="l06356"></a>06356                 bSendCommand = <span class="keyword">true</span>;
<a name="l06357"></a>06357                 lReturnValue = 1;
<a name="l06358"></a>06358             }
<a name="l06359"></a>06359         }
<a name="l06360"></a>06360 
<a name="l06361"></a>06361         <span class="keywordflow">break</span>;
<a name="l06362"></a>06362     <span class="keywordflow">case</span>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">OTClient::getRequest</a>):
<a name="l06363"></a>06363         {
<a name="l06364"></a>06364             <span class="comment">//      OTLog::vOutput(0, &quot;(User has instructed to send a getRequest command to the server...)\n&quot;);</span>
<a name="l06365"></a>06365 
<a name="l06366"></a>06366             <span class="comment">// (1) set up member variables </span>
<a name="l06367"></a>06367             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getRequest&quot;</span>;
<a name="l06368"></a>06368             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06369"></a>06369             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06370"></a>06370 
<a name="l06371"></a>06371             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%d&quot;</span>, 1); <span class="comment">// Request Number, if unused, should be set to 1.</span>
<a name="l06372"></a>06372 
<a name="l06373"></a>06373             <span class="comment">// (2) Sign the Message </span>
<a name="l06374"></a>06374             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06375"></a>06375 
<a name="l06376"></a>06376             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06377"></a>06377             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06378"></a>06378 
<a name="l06379"></a>06379             bSendCommand = <span class="keyword">true</span>;
<a name="l06380"></a>06380             lReturnValue = 1;
<a name="l06381"></a>06381         }
<a name="l06382"></a>06382 
<a name="l06383"></a>06383         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06384"></a>06384 
<a name="l06385"></a>06385         <span class="comment">// **************************************************************************************</span>
<a name="l06386"></a>06386         <span class="comment">// EVERY COMMAND BELOW THIS POINT (THEY ARE ALL OUTGOING TO THE SERVER) MUST INCLUDE THE</span>
<a name="l06387"></a>06387         <span class="comment">// CORRECT REQUEST NUMBER, OR BE REJECTED BY THE SERVER.</span>
<a name="l06388"></a>06388         <span class="comment">//</span>
<a name="l06389"></a>06389         <span class="comment">// The same commands must also increment the local counter of the request number by calling theNym.IncrementRequestNum</span>
<a name="l06390"></a>06390         <span class="comment">// Otherwise it will get out of sync, and future commands will start failing (until it is resynchronized with</span>
<a name="l06391"></a>06391         <span class="comment">// a getRequest message to the server, which replies with the latest number. The code on this side that processes</span>
<a name="l06392"></a>06392         <span class="comment">// that server reply is already smart enough to update the local nym&#39;s copy of the request number when it is received.</span>
<a name="l06393"></a>06393         <span class="comment">// In this way, the client becomes resynchronized and the next command will work again. But it&#39;s better to increment the</span>
<a name="l06394"></a>06394         <span class="comment">// counter properly.</span>
<a name="l06395"></a>06395         <span class="comment">// PROPERLY == every time you actually get the request number from a nym and use it to make a server request,</span>
<a name="l06396"></a>06396         <span class="comment">// then you should therefore also increment that counter. If you call GetCurrentRequestNum AND USE IT WITH THE SERVER,</span>
<a name="l06397"></a>06397         <span class="comment">// then make sure you call IncrementRequestNum immediately after. Otherwise future commands will start failing.</span>
<a name="l06398"></a>06398         <span class="comment">//</span>
<a name="l06399"></a>06399         <span class="comment">// This is all because the server requres a new request number (last one +1) with each request. This is in</span>
<a name="l06400"></a>06400         <span class="comment">// order to thwart would-be attackers who cannot break the crypto, but try to capture encrypted messages and</span>
<a name="l06401"></a>06401         <span class="comment">// send them to the server twice. Better that new requests requre new request numbers :-)</span>
<a name="l06402"></a>06402 
<a name="l06403"></a>06403         <span class="keywordflow">break</span>;
<a name="l06404"></a>06404     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821">OTClient::deleteUserAccount</a>:
<a name="l06405"></a>06405         {
<a name="l06406"></a>06406             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l06407"></a>06407             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l06408"></a>06408             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l06409"></a>06409             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l06410"></a>06410 
<a name="l06411"></a>06411             <span class="comment">//      OTLog::vOutput(0, &quot;(User has instructed to send a deleteUserAccount command to the server...)\n&quot;);</span>
<a name="l06412"></a>06412 
<a name="l06413"></a>06413             <span class="comment">// (1) set up member variables </span>
<a name="l06414"></a>06414             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;deleteUserAccount&quot;</span>;
<a name="l06415"></a>06415             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06416"></a>06416             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06417"></a>06417             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06418"></a>06418 
<a name="l06419"></a>06419             <span class="comment">// (2) Sign the Message </span>
<a name="l06420"></a>06420             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06421"></a>06421 
<a name="l06422"></a>06422             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06423"></a>06423             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06424"></a>06424 
<a name="l06425"></a>06425             bSendCommand = <span class="keyword">true</span>;
<a name="l06426"></a>06426             lReturnValue = lRequestNumber;
<a name="l06427"></a>06427         }
<a name="l06428"></a>06428 
<a name="l06429"></a>06429         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06430"></a>06430         <span class="keywordflow">break</span>;
<a name="l06431"></a>06431     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aca0882f708bf1fc33dfc9768b0ed956b">OTClient::sendUserMessage</a>: <span class="comment">// SEND USER MESSAGE</span>
<a name="l06432"></a>06432         {
<a name="l06433"></a>06433             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a NymID (for recipient): &quot;</span>);
<a name="l06434"></a>06434 
<a name="l06435"></a>06435             <span class="comment">// User input.</span>
<a name="l06436"></a>06436             <span class="comment">// I need a second NymID, so I allow the user to enter it here.</span>
<a name="l06437"></a>06437             <a class="code" href="class_o_t_string.html">OTString</a> strNymID2;
<a name="l06438"></a>06438             strNymID2.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06439"></a>06439 
<a name="l06440"></a>06440             <span class="comment">// -----------------------------------</span>
<a name="l06441"></a>06441 
<a name="l06442"></a>06442             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter recipient&#39;s public key:\n&gt; &quot;</span>);
<a name="l06443"></a>06443 
<a name="l06444"></a>06444             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> theArmoredText;
<a name="l06445"></a>06445             <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof - 1.</span>
<a name="l06446"></a>06446 
<a name="l06447"></a>06447             <span class="keywordflow">do</span> {
<a name="l06448"></a>06448                 decode_buffer[0] = 0;
<a name="l06449"></a>06449                 <span class="keywordflow">if</span> (NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin))
<a name="l06450"></a>06450                 {
<a name="l06451"></a>06451                     theArmoredText.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, decode_buffer);
<a name="l06452"></a>06452                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l06453"></a>06453                 }
<a name="l06454"></a>06454                 <span class="keywordflow">else</span> 
<a name="l06455"></a>06455                 {
<a name="l06456"></a>06456                     <span class="keywordflow">break</span>;
<a name="l06457"></a>06457                 }
<a name="l06458"></a>06458 
<a name="l06459"></a>06459             } <span class="keywordflow">while</span> (strlen(decode_buffer)&gt;1);
<a name="l06460"></a>06460 
<a name="l06461"></a>06461             <span class="comment">// ----------------------------------------</span>
<a name="l06462"></a>06462 
<a name="l06463"></a>06463             decode_buffer[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l06464"></a>06464             <a class="code" href="class_o_t_string.html">OTString</a> strPlaintext;
<a name="l06465"></a>06465 
<a name="l06466"></a>06466             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a plaintext message, terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l06467"></a>06467 
<a name="l06468"></a>06468             <span class="keywordflow">do</span> {
<a name="l06469"></a>06469                 fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer), stdin);
<a name="l06470"></a>06470 
<a name="l06471"></a>06471                 <span class="keywordflow">if</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>)
<a name="l06472"></a>06472                 {
<a name="l06473"></a>06473                     strPlaintext.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l06474"></a>06474                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l06475"></a>06475                 }
<a name="l06476"></a>06476             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l06477"></a>06477 
<a name="l06478"></a>06478             <span class="comment">// -----------------------------------</span>
<a name="l06479"></a>06479 
<a name="l06480"></a>06480             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l06481"></a>06481             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l06482"></a>06482             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l06483"></a>06483             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l06484"></a>06484 
<a name="l06485"></a>06485             <span class="comment">// (1) set up member variables </span>
<a name="l06486"></a>06486             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;sendUserMessage&quot;</span>;
<a name="l06487"></a>06487             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06488"></a>06488             theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l06489"></a>06489             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06490"></a>06490             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06491"></a>06491 
<a name="l06492"></a>06492             <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
<a name="l06493"></a>06493             <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pPubkey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
<a name="l06494"></a>06494             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPubkey);
<a name="l06495"></a>06495             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theKeyAngel(pPubkey);
<a name="l06496"></a>06496 
<a name="l06497"></a>06497             <span class="keywordflow">if</span> (theArmoredText.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; !pPubkey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(theArmoredText))
<a name="l06498"></a>06498             {
<a name="l06499"></a>06499                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed setting public key.\n&quot;</span>);
<a name="l06500"></a>06500             }
<a name="l06501"></a>06501             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strPlaintext.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; 
<a name="l06502"></a>06502                 theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pPubkey, strPlaintext) &amp;&amp;
<a name="l06503"></a>06503                 theEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>))
<a name="l06504"></a>06504             {
<a name="l06505"></a>06505                 <span class="comment">// (2) Sign the Message </span>
<a name="l06506"></a>06506                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06507"></a>06507 
<a name="l06508"></a>06508                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06509"></a>06509                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06510"></a>06510 
<a name="l06511"></a>06511                 <span class="comment">// (Send it)</span>
<a name="l06512"></a>06512                 bSendCommand = <span class="keyword">true</span>;
<a name="l06513"></a>06513                 lReturnValue = lRequestNumber;
<a name="l06514"></a>06514 
<a name="l06515"></a>06515                 <span class="comment">// -----------------------------------</span>
<a name="l06516"></a>06516                 <span class="comment">// store a copy in the outmail.</span>
<a name="l06517"></a>06517                 <span class="comment">// (not encrypted, since the Nymfile will be encrypted anyway.</span>
<a name="l06518"></a>06518                 <span class="comment">//</span>
<a name="l06519"></a>06519                 <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l06520"></a>06520 
<a name="l06521"></a>06521                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l06522"></a>06522 
<a name="l06523"></a>06523                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outmailMessage&quot;</span>;
<a name="l06524"></a>06524                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l06525"></a>06525                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
<a name="l06526"></a>06526                 pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;          
<a name="l06527"></a>06527                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber);
<a name="l06528"></a>06528 
<a name="l06529"></a>06529                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06530"></a>06530 
<a name="l06531"></a>06531                 pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPlaintext);
<a name="l06532"></a>06532 
<a name="l06533"></a>06533                 pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);     
<a name="l06534"></a>06534                 pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06535"></a>06535 
<a name="l06536"></a>06536                 theNym.<a class="code" href="class_o_t_pseudonym.html#a908900d7fa217571e2dd3a6c06789a9b">AddOutmail</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outmail&quot;.</span>
<a name="l06537"></a>06537 
<a name="l06538"></a>06538                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; extraNym = theNym;
<a name="l06539"></a>06539                 theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(extraNym);
<a name="l06540"></a>06540             }
<a name="l06541"></a>06541             <span class="keywordflow">else</span>
<a name="l06542"></a>06542             {
<a name="l06543"></a>06543                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed sealing envelope.\n&quot;</span>);
<a name="l06544"></a>06544             }   
<a name="l06545"></a>06545         }
<a name="l06546"></a>06546 
<a name="l06547"></a>06547         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06548"></a>06548 
<a name="l06549"></a>06549         <span class="keywordflow">break</span>;
<a name="l06550"></a>06550     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a29479df423e07d29409fc18b20862871">OTClient::checkUser</a>: <span class="comment">// CHECK USER</span>
<a name="l06551"></a>06551         {
<a name="l06552"></a>06552             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a NymID: &quot;</span>);
<a name="l06553"></a>06553 
<a name="l06554"></a>06554             <span class="comment">// User input.</span>
<a name="l06555"></a>06555             <span class="comment">// I need a second NymID, so I allow the user to enter it here.</span>
<a name="l06556"></a>06556             <a class="code" href="class_o_t_string.html">OTString</a> strNymID2;
<a name="l06557"></a>06557             strNymID2.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06558"></a>06558 
<a name="l06559"></a>06559             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l06560"></a>06560             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l06561"></a>06561             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l06562"></a>06562             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l06563"></a>06563 
<a name="l06564"></a>06564             <span class="comment">// (1) set up member variables </span>
<a name="l06565"></a>06565             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;checkUser&quot;</span>;
<a name="l06566"></a>06566             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06567"></a>06567             theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l06568"></a>06568             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06569"></a>06569             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06570"></a>06570 
<a name="l06571"></a>06571             <span class="comment">// (2) Sign the Message </span>
<a name="l06572"></a>06572             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06573"></a>06573 
<a name="l06574"></a>06574             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06575"></a>06575             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06576"></a>06576 
<a name="l06577"></a>06577             bSendCommand = <span class="keyword">true</span>;
<a name="l06578"></a>06578             lReturnValue = lRequestNumber;
<a name="l06579"></a>06579         }
<a name="l06580"></a>06580 
<a name="l06581"></a>06581         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06582"></a>06582 
<a name="l06583"></a>06583         <span class="comment">// The standard &quot;contract&quot; key inside the new currency contract must be the same key</span>
<a name="l06584"></a>06584         <span class="comment">// used by the Nym who is signing the requests to issue the currency.</span>
<a name="l06585"></a>06585         <span class="keywordflow">break</span>;
<a name="l06586"></a>06586     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a7d1c1bcc58abf8b966d3abf5736f3eee">OTClient::issueAssetType</a>: <span class="comment">// ISSUE ASSET TYPE</span>
<a name="l06587"></a>06587         {               
<a name="l06588"></a>06588             <a class="code" href="class_o_t_string.html">OTString</a> strSourceContract;
<a name="l06589"></a>06589 
<a name="l06590"></a>06590             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter currency contract, terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l06591"></a>06591             <span class="keywordtype">char</span> decode_buffer[200];
<a name="l06592"></a>06592 
<a name="l06593"></a>06593             <span class="keywordflow">do</span> {
<a name="l06594"></a>06594                 fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer), stdin);
<a name="l06595"></a>06595 
<a name="l06596"></a>06596                 <span class="keywordflow">if</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>)
<a name="l06597"></a>06597                 {
<a name="l06598"></a>06598                     strSourceContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l06599"></a>06599                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l06600"></a>06600                 }
<a name="l06601"></a>06601             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l06602"></a>06602 
<a name="l06603"></a>06603             <span class="comment">/*</span>
<a name="l06604"></a>06604 <span class="comment">            // While debugging, sometimes I just want it to read the source contract directly out of a test file.</span>
<a name="l06605"></a>06605 <span class="comment">            // So I use this code, instead of the above code, when I am doing that, to set strSourceContract&#39;s value...</span>
<a name="l06606"></a>06606 <span class="comment">            //</span>
<a name="l06607"></a>06607 <span class="comment"></span>
<a name="l06608"></a>06608 <span class="comment">            OTString strTempPath;</span>
<a name="l06609"></a>06609 <span class="comment">            strTempPath.Format(&quot;%s%s%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(), &quot;sample-contract&quot;, OTLog::PathSeparator(), &quot;tokens.xml&quot;);</span>
<a name="l06610"></a>06610 <span class="comment">            std::ifstream in(strTempPath.Get(), std::ios::binary);</span>
<a name="l06611"></a>06611 <span class="comment"></span>
<a name="l06612"></a>06612 <span class="comment">            std::ifstream in(strTempPath.Get(), std::ios::binary);</span>
<a name="l06613"></a>06613 <span class="comment"></span>
<a name="l06614"></a>06614 <span class="comment">            if (in.fail())</span>
<a name="l06615"></a>06615 <span class="comment">            {</span>
<a name="l06616"></a>06616 <span class="comment">            OTLog::vError(&quot;Error opening file WHILE DEBUGGING: %s\n&quot;, strTempPath.Get());</span>
<a name="l06617"></a>06617 <span class="comment">            }</span>
<a name="l06618"></a>06618 <span class="comment">            OT_ASSERT(!in.fail());</span>
<a name="l06619"></a>06619 <span class="comment"></span>
<a name="l06620"></a>06620 <span class="comment">            std::stringstream buffer;</span>
<a name="l06621"></a>06621 <span class="comment">            buffer &lt;&lt; in.rdbuf();</span>
<a name="l06622"></a>06622 <span class="comment"></span>
<a name="l06623"></a>06623 <span class="comment">            std::string contents(buffer.str());</span>
<a name="l06624"></a>06624 <span class="comment"></span>
<a name="l06625"></a>06625 <span class="comment">            strSourceContract = contents.c_str();</span>
<a name="l06626"></a>06626 <span class="comment">            */</span>
<a name="l06627"></a>06627 
<a name="l06628"></a>06628             <span class="comment">// -------------------------------------------------------------------</span>
<a name="l06629"></a>06629 
<a name="l06630"></a>06630             <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;
<a name="l06631"></a>06631 
<a name="l06632"></a>06632             <span class="keywordflow">if</span> (theAssetContract.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strSourceContract))
<a name="l06633"></a>06633             {
<a name="l06634"></a>06634                 <span class="comment">// In some places the ID is already set, and I&#39;d verify it here.</span>
<a name="l06635"></a>06635                 <span class="comment">// But in this place, I am adding it and generating the ID from the string.</span>
<a name="l06636"></a>06636                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    newID;
<a name="l06637"></a>06637                 theAssetContract.<a class="code" href="class_o_t_contract.html#a705597c0b741d3d120624b0388f73508">CalculateContractID</a>(newID);    
<a name="l06638"></a>06638                 theAssetContract.<a class="code" href="class_o_t_contract.html#a18b55003e207dff89912f7c895af45f6">SetIdentifier</a>(newID); <span class="comment">// probably unnecessary</span>
<a name="l06639"></a>06639 
<a name="l06640"></a>06640                 <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l06641"></a>06641                 theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l06642"></a>06642                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l06643"></a>06643                 theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l06644"></a>06644 
<a name="l06645"></a>06645                 <span class="comment">// (1) Set up member variables </span>
<a name="l06646"></a>06646                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueAssetType&quot;</span>;
<a name="l06647"></a>06647                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06648"></a>06648                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06649"></a>06649                 theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06650"></a>06650 
<a name="l06651"></a>06651                 newID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>); <span class="comment">// I&#39;ve calculated the ID, and now put it on the message...</span>
<a name="l06652"></a>06652                 <a class="code" href="class_o_t_string.html">OTString</a> strAssetContract(theAssetContract);
<a name="l06653"></a>06653                 theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strAssetContract);
<a name="l06654"></a>06654 
<a name="l06655"></a>06655                 <span class="comment">// (2) Sign the Message </span>
<a name="l06656"></a>06656                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06657"></a>06657 
<a name="l06658"></a>06658                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06659"></a>06659                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06660"></a>06660 
<a name="l06661"></a>06661                 bSendCommand = <span class="keyword">true</span>;        
<a name="l06662"></a>06662                 lReturnValue = lRequestNumber;
<a name="l06663"></a>06663 
<a name="l06664"></a>06664                 <span class="comment">// ------------------------------------ </span>
<a name="l06665"></a>06665                 <span class="comment">// Save the contract to local storage and add to wallet.</span>
<a name="l06666"></a>06666 
<a name="l06667"></a>06667                 <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
<a name="l06668"></a>06668                 <a class="code" href="class_o_t_string.html">OTString</a> strFilename(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());    <span class="comment">// In this case the filename isn&#39;t actually used, since SaveToContractFolder will</span>
<a name="l06669"></a>06669                 <span class="comment">// handle setting up the filename and overwrite it anyway. But I still prefer to set it</span>
<a name="l06670"></a>06670                 <span class="comment">// up correctly, rather than pass a blank. I&#39;m just funny like that.</span>
<a name="l06671"></a>06671 
<a name="l06672"></a>06672                 <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername, 
<a name="l06673"></a>06673                     strFilename, theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
<a name="l06674"></a>06674                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
<a name="l06675"></a>06675 
<a name="l06676"></a>06676                 <span class="comment">// Check the server signature on the contract here. (Perhaps the message is good enough?</span>
<a name="l06677"></a>06677                 <span class="comment">// After all, the message IS signed by the server and contains the Account.</span>
<a name="l06678"></a>06678                 <span class="comment">//          if (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract())</span>
<a name="l06679"></a>06679                 <span class="keywordflow">if</span> (pContract-&gt;LoadContractFromString(strSourceContract) &amp;&amp; pContract-&gt;VerifyContract())
<a name="l06680"></a>06680                 {
<a name="l06681"></a>06681                     <span class="comment">// Next make sure the wallet has this contract on its list...</span>
<a name="l06682"></a>06682                     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = NULL;
<a name="l06683"></a>06683 
<a name="l06684"></a>06684                     <span class="keywordflow">if</span> (NULL != (pWallet = m_pWallet))
<a name="l06685"></a>06685                     {
<a name="l06686"></a>06686                         pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(*pContract); <span class="comment">// this saves both the contract and the wallet.</span>
<a name="l06687"></a>06687                         pContract = NULL; <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
<a name="l06688"></a>06688                     }
<a name="l06689"></a>06689                 }
<a name="l06690"></a>06690                 <span class="comment">// cleanup</span>
<a name="l06691"></a>06691                 <span class="keywordflow">if</span> (pContract)
<a name="l06692"></a>06692                 {
<a name="l06693"></a>06693                     <span class="keyword">delete</span> pContract;
<a name="l06694"></a>06694                     pContract = NULL;
<a name="l06695"></a>06695                 }
<a name="l06696"></a>06696             }       
<a name="l06697"></a>06697         }
<a name="l06698"></a>06698 
<a name="l06699"></a>06699         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06700"></a>06700 
<a name="l06701"></a>06701         <span class="comment">// DONE: This will have to be changed from a simple message, to a transaction,</span>
<a name="l06702"></a>06702         <span class="comment">// BECAUSE IT CHANGES ACCOUNT BALANCES, and thus requires balance agreement for all affected accounts!</span>
<a name="l06703"></a>06703 
<a name="l06704"></a>06704         <span class="keywordflow">break</span>;
<a name="l06705"></a>06705     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7af5d28fce545520f3fba25ca7e51f8374">OTClient::exchangeBasket</a>: <span class="comment">// EXCHANGE BASKET</span>
<a name="l06706"></a>06706         {               
<a name="l06707"></a>06707             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym);
<a name="l06708"></a>06708 
<a name="l06709"></a>06709             <a class="code" href="class_o_t_string.html">OTString</a> strBasketInfo, strNymID(USER_ID);
<a name="l06710"></a>06710             <a class="code" href="class_o_t_string.html">OTString</a> str_BASKET_CONTRACT_ID, str_MAIN_ACCOUNT_ID, strTemp;
<a name="l06711"></a>06711 
<a name="l06712"></a>06712             <span class="comment">// FIRST get the Asset Type ID for the basket</span>
<a name="l06713"></a>06713             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the basket&#39;s Asset Type ID (aka Contract ID): &quot;</span>);
<a name="l06714"></a>06714             str_BASKET_CONTRACT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06715"></a>06715 
<a name="l06716"></a>06716             <span class="comment">// FIRST get the Asset Type ID for the basket</span>
<a name="l06717"></a>06717             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours for an account that has the same asset type: &quot;</span>);
<a name="l06718"></a>06718             str_MAIN_ACCOUNT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06719"></a>06719             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MAIN_ACCOUNT_ID(str_MAIN_ACCOUNT_ID);
<a name="l06720"></a>06720 
<a name="l06721"></a>06721             <span class="comment">// which direction is the exchange?</span>
<a name="l06722"></a>06722             <a class="code" href="class_o_t_string.html">OTString</a> strDirection;
<a name="l06723"></a>06723             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Are you exchanging in or out? [in]: &quot;</span>);
<a name="l06724"></a>06724             strDirection.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06725"></a>06725 
<a name="l06726"></a>06726             <span class="keyword">const</span> <span class="keywordtype">bool</span> bDirection = (strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;in&quot;</span>) || strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;In&quot;</span>));
<a name="l06727"></a>06727 
<a name="l06728"></a>06728             <span class="comment">// load up the asset contract</span>
<a name="l06729"></a>06729             <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
<a name="l06730"></a>06730             <a class="code" href="class_o_t_string.html">OTString</a> strContractPath(str_BASKET_CONTRACT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06731"></a>06731             <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(str_BASKET_CONTRACT_ID, strFoldername,
<a name="l06732"></a>06732                 strContractPath, str_BASKET_CONTRACT_ID);
<a name="l06733"></a>06733             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
<a name="l06734"></a>06734             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAssetContract&gt;</a> theAssetContractAngel(*pContract);
<a name="l06735"></a>06735 
<a name="l06736"></a>06736             <span class="keywordflow">if</span> (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract()) 
<a name="l06737"></a>06737             {
<a name="l06738"></a>06738                 <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l06739"></a>06739                 <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l06740"></a>06740 
<a name="l06741"></a>06741                 <span class="comment">// todo perhaps verify the basket here, even though I just verified the asset contract itself...</span>
<a name="l06742"></a>06742                 <span class="comment">// Can&#39;t never be too sure.</span>
<a name="l06743"></a>06743                 <span class="keywordflow">if</span> (pContract-&gt;GetBasketInfo().GetLength() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;GetBasketInfo()))
<a name="l06744"></a>06744                 {                
<a name="l06745"></a>06745                     <span class="comment">// We need a transaction number just to send this thing. Plus, we need a number for</span>
<a name="l06746"></a>06746                     <span class="comment">// each sub-account to the basket, as well as the basket&#39;s main account.</span>
<a name="l06747"></a>06747                     <span class="comment">// That is: 1 + theBasket.Count() + 1</span>
<a name="l06748"></a>06748 
<a name="l06749"></a>06749                     <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &lt; (2 + theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>()))
<a name="l06750"></a>06750                     {
<a name="l06751"></a>06751                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Trying to exchange basket: you don&#39;t have enough transaction numbers &quot;</span>
<a name="l06752"></a>06752                             <span class="stringliteral">&quot;to perform the exchange.\n&quot;</span>, __FUNCTION__);
<a name="l06753"></a>06753                     }
<a name="l06754"></a>06754                     <span class="keywordflow">else</span>
<a name="l06755"></a>06755                     {
<a name="l06756"></a>06756                         int64_t lStoredTransactionNumber=0;
<a name="l06757"></a>06757                         <span class="keywordtype">bool</span> bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber); <span class="comment">// this saves</span>
<a name="l06758"></a>06758 
<a name="l06759"></a>06759                         <span class="keywordflow">if</span> (bGotTransNum)
<a name="l06760"></a>06760                         {
<a name="l06761"></a>06761                             <span class="comment">// Create a transaction</span>
<a name="l06762"></a>06762                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = 
<a name="l06763"></a>06763                                 <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, MAIN_ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>, lStoredTransactionNumber); 
<a name="l06764"></a>06764 
<a name="l06765"></a>06765                             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l06766"></a>06766                             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1332f32813f158436fd58abdddec855c">OTItem::exchangeBasket</a>);
<a name="l06767"></a>06767 
<a name="l06768"></a>06768                             <span class="comment">// This pItem is where the Basket Info will be stored. (So it ends up on receipts...)                        </span>
<a name="l06769"></a>06769                             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l06770"></a>06770 
<a name="l06771"></a>06771                             <span class="comment">// ----------------------------------------------------</span>
<a name="l06772"></a>06772                             <span class="comment">// GET / LOAD the ACCOUNT / INBOX /OUTBOX for the MAIN ACCOUNT</span>
<a name="l06773"></a>06773 
<a name="l06774"></a>06774                             <a class="code" href="class_o_t_account.html">OTAccount</a> * pMainAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(MAIN_ACCOUNT_ID);
<a name="l06775"></a>06775                             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMainAccount); <span class="comment">// todo. better than nothing for now.</span>
<a name="l06776"></a>06776 
<a name="l06777"></a>06777                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pMainAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l06778"></a>06778                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pMainAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l06779"></a>06779 
<a name="l06780"></a>06780                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l06781"></a>06781                             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l06782"></a>06782 
<a name="l06783"></a>06783                             <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l06784"></a>06784                             {
<a name="l06785"></a>06785                                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l06786"></a>06786 
<a name="l06787"></a>06787                                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l06788"></a>06788                                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l06789"></a>06789                             }
<a name="l06790"></a>06790                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l06791"></a>06791                             {
<a name="l06792"></a>06792                                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l06793"></a>06793 
<a name="l06794"></a>06794                                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l06795"></a>06795                                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l06796"></a>06796                             }
<a name="l06797"></a>06797                             <span class="comment">// Set up the Request Basket! ------------------------------</span>
<a name="l06798"></a>06798                             <span class="keywordflow">else</span>
<a name="l06799"></a>06799                             {
<a name="l06800"></a>06800                                 int32_t nTransferMultiple = 0;
<a name="l06801"></a>06801 
<a name="l06802"></a>06802                                 <a class="code" href="class_o_t_basket.html">OTBasket</a> theRequestBasket(theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(), theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>());
<a name="l06803"></a>06803 
<a name="l06804"></a>06804                                 theRequestBasket.<a class="code" href="class_o_t_basket.html#a75757d74f9e52043611a7ac6bedcb362">SetExchangingIn</a>(bDirection);
<a name="l06805"></a>06805                                 <span class="comment">// --------------------------------------------------</span>
<a name="l06806"></a>06806                                 <span class="comment">// Show the minimum transfer amount to the customer and ask him to choose a multiple for the transfer</span>
<a name="l06807"></a>06807                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;The minimum transfer amount for this basket is %lld. You may only exchange in multiples of it.\n&quot;</span>
<a name="l06808"></a>06808                                     <span class="stringliteral">&quot;Choose any multiple [1]: &quot;</span>, theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>());
<a name="l06809"></a>06809                                 strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06810"></a>06810                                 nTransferMultiple = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); 
<a name="l06811"></a>06811                                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l06812"></a>06812                                 <span class="keywordflow">if</span> (nTransferMultiple &lt;= 0)
<a name="l06813"></a>06813                                     nTransferMultiple = 1;
<a name="l06814"></a>06814 
<a name="l06815"></a>06815                                 theRequestBasket.SetTransferMultiple(nTransferMultiple);
<a name="l06816"></a>06816 
<a name="l06817"></a>06817                                 <span class="comment">// NOTE: I&#39;m not checking this call for success...</span>
<a name="l06818"></a>06818                                 <span class="comment">// But, I DID check the count beforehand, and I know there are enough numbers.</span>
<a name="l06819"></a>06819                                 <span class="comment">//</span>
<a name="l06820"></a>06820                                 int64_t lClosingTransactionNo = 0;
<a name="l06821"></a>06821                                 theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lClosingTransactionNo); <span class="comment">// this saves</span>
<a name="l06822"></a>06822 
<a name="l06823"></a>06823                                 theRequestBasket.SetClosingNum(lClosingTransactionNo); <span class="comment">// For the basketReceipt (Closing Transaction Num) for main account.</span>
<a name="l06824"></a>06824 
<a name="l06825"></a>06825                                 <span class="comment">// -----------------------------------------------------------</span>
<a name="l06826"></a>06826 
<a name="l06827"></a>06827                                 <span class="comment">// Then loop through the BasketItems... </span>
<a name="l06828"></a>06828                                 <span class="keywordflow">for</span> (int32_t i = 0; i &lt; theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(); i++)
<a name="l06829"></a>06829                                 {
<a name="l06830"></a>06830                                     <span class="comment">// pItem-&gt; contains SUB_CONTRACT_ID, SUB_ACCOUNT_ID, and lMinimumTransferAmount.</span>
<a name="l06831"></a>06831                                     <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(i);
<a name="l06832"></a>06832 
<a name="l06833"></a>06833                                     <span class="comment">// ...and for each one, ask the user to enter his corresponding account ID.</span>
<a name="l06834"></a>06834                                     <span class="comment">// IT MUST BE THE SAME ASSET TYPE AS THE BASKET ITEM, SO SHOW USER THE ASSET ID!</span>
<a name="l06835"></a>06835                                     <a class="code" href="class_o_t_string.html">OTString</a> str_SUB_CONTRACT_ID(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>);
<a name="l06836"></a>06836                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nBasket currency type (Asset Type) #%d is:\n%s\n\nPlease enter your own &quot;</span>
<a name="l06837"></a>06837                                         <span class="stringliteral">&quot;existing Account ID of the same asset type: &quot;</span>, 
<a name="l06838"></a>06838                                         i+1, str_SUB_CONTRACT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06839"></a>06839                                     <a class="code" href="class_o_t_string.html">OTString</a> str_TEMP_ACCOUNT_ID;
<a name="l06840"></a>06840                                     str_TEMP_ACCOUNT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06841"></a>06841                                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> TEMP_ACCOUNT_ID(str_TEMP_ACCOUNT_ID);
<a name="l06842"></a>06842 
<a name="l06843"></a>06843 
<a name="l06844"></a>06844                                     <span class="comment">// TODO (later) Load up the user&#39;s account at this point to make sure it even exists.</span>
<a name="l06845"></a>06845                                     <span class="comment">// Then check the asset type on that account against pItem-&gt;SUB_CONTRACT_ID and make sure they match.</span>
<a name="l06846"></a>06846                                     <span class="comment">// The server will definitely have to do this anyway. The client can skip it, but the command</span>
<a name="l06847"></a>06847                                     <span class="comment">// won&#39;t work unless the user enters this data properly. UI will have to do a popup here if something is wrong.</span>
<a name="l06848"></a>06848 
<a name="l06849"></a>06849 
<a name="l06850"></a>06850                                     <span class="comment">// As this is happening, we&#39;re creating ANOTHER basket object (theRequestBasket), with items that </span>
<a name="l06851"></a>06851                                     <span class="comment">// contain MY account IDs. </span>
<a name="l06852"></a>06852                                     <span class="comment">// The minimum transfer amounts on the new basket are set based on a multiple of the original.</span>
<a name="l06853"></a>06853                                     <span class="comment">// (I already set the multiple just above this loop.)</span>
<a name="l06854"></a>06854 
<a name="l06855"></a>06855                                     <span class="comment">// NOTE: I&#39;m not checking this call for success...</span>
<a name="l06856"></a>06856                                     <span class="comment">// But, I DID check the count beforehand, and I know there are enough numbers.</span>
<a name="l06857"></a>06857                                     <span class="comment">//</span>
<a name="l06858"></a>06858                                     int64_t lSubClosingTransactionNo = 0; <span class="comment">// For the basketReceipt (closing transaction num) for the sub account.</span>
<a name="l06859"></a>06859                                     theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lSubClosingTransactionNo); <span class="comment">// this saves</span>
<a name="l06860"></a>06860                                     <span class="comment">// -------------------------------------------------------------------------------------</span>
<a name="l06861"></a>06861                                     theRequestBasket.AddRequestSubContract(pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>, TEMP_ACCOUNT_ID, lSubClosingTransactionNo);
<a name="l06862"></a>06862                                 }
<a name="l06863"></a>06863 
<a name="l06864"></a>06864                                 <span class="comment">// Make sure the server knows where to put my new basket currency once the exchange is done.</span>
<a name="l06865"></a>06865                                 theRequestBasket.SetRequestAccountID(MAIN_ACCOUNT_ID);
<a name="l06866"></a>06866 
<a name="l06867"></a>06867                                 <span class="comment">// Export the OTBasket object into a string, add it as</span>
<a name="l06868"></a>06868                                 <span class="comment">// a payload on my request, and send to server.</span>
<a name="l06869"></a>06869                                 theRequestBasket.SignContract(theNym);
<a name="l06870"></a>06870                                 theRequestBasket.SaveContractRaw(strBasketInfo);
<a name="l06871"></a>06871 
<a name="l06872"></a>06872                                 <span class="comment">//***********************************************************************</span>
<a name="l06873"></a>06873 
<a name="l06874"></a>06874                                 pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strBasketInfo);
<a name="l06875"></a>06875 
<a name="l06876"></a>06876                                 <span class="comment">// sign the item. save it.</span>
<a name="l06877"></a>06877                                 <span class="comment">//</span>
<a name="l06878"></a>06878                                 pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l06879"></a>06879                                 pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06880"></a>06880 
<a name="l06881"></a>06881                                 <span class="comment">//***********************************************************************</span>
<a name="l06882"></a>06882 
<a name="l06883"></a>06883                                 <span class="comment">// ---------------------------------------------</span>
<a name="l06884"></a>06884                                 <span class="comment">// BALANCE AGREEMENT!</span>
<a name="l06885"></a>06885                                 <span class="comment">//</span>
<a name="l06886"></a>06886                                 <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l06887"></a>06887                                 <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(0, <span class="comment">// Change in balance is 0. (The accounts will all be changed, </span>
<a name="l06888"></a>06888                                     *pTransaction, theNym, *pMainAccount, *pOutbox); <span class="comment">// but basketReceipts will be used to account for it.) </span>
<a name="l06889"></a>06889 
<a name="l06890"></a>06890                                 <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l06891"></a>06891                                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l06892"></a>06892 
<a name="l06893"></a>06893                                 <span class="comment">// ---------------------------------------------</span>
<a name="l06894"></a>06894 
<a name="l06895"></a>06895                                 <span class="comment">// sign the transaction</span>
<a name="l06896"></a>06896                                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l06897"></a>06897                                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06898"></a>06898 
<a name="l06899"></a>06899                                 <span class="comment">// set up the ledger</span>
<a name="l06900"></a>06900                                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, MAIN_ACCOUNT_ID, SERVER_ID);
<a name="l06901"></a>06901                                 theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(MAIN_ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l06902"></a>06902                                 theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l06903"></a>06903 
<a name="l06904"></a>06904                                 <span class="comment">// sign the ledger</span>
<a name="l06905"></a>06905                                 theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l06906"></a>06906                                 theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06907"></a>06907 
<a name="l06908"></a>06908                                 <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l06909"></a>06909                                 <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l06910"></a>06910                                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l06911"></a>06911 
<a name="l06912"></a>06912                                 <span class="comment">// Encoding...</span>
<a name="l06913"></a>06913                                 ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l06914"></a>06914 
<a name="l06915"></a>06915 
<a name="l06916"></a>06916                                 <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l06917"></a>06917                                 theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l06918"></a>06918                                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l06919"></a>06919                                 theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l06920"></a>06920 
<a name="l06921"></a>06921                                 <span class="comment">// (1) Set up member variables </span>
<a name="l06922"></a>06922                                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l06923"></a>06923                                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l06924"></a>06924                                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l06925"></a>06925                                 theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l06926"></a>06926 
<a name="l06927"></a>06927                                 theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_MAIN_ACCOUNT_ID;
<a name="l06928"></a>06928                                 theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l06929"></a>06929 
<a name="l06930"></a>06930                                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l06931"></a>06931                                 <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06932"></a>06932                                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l06933"></a>06933 
<a name="l06934"></a>06934                                 <span class="keywordflow">if</span> (bNymboxHash)
<a name="l06935"></a>06935                                     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l06936"></a>06936                                 <span class="keywordflow">else</span>
<a name="l06937"></a>06937                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l06938"></a>06938                                     str_server.c_str());
<a name="l06939"></a>06939 
<a name="l06940"></a>06940                                 <span class="comment">// (2) Sign the Message </span>
<a name="l06941"></a>06941                                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l06942"></a>06942 
<a name="l06943"></a>06943                                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l06944"></a>06944                                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06945"></a>06945 
<a name="l06946"></a>06946                                 bSendCommand = <span class="keyword">true</span>;
<a name="l06947"></a>06947                                 lReturnValue = lRequestNumber;                            
<a name="l06948"></a>06948                             } <span class="comment">// Inbox loaded.</span>
<a name="l06949"></a>06949                         } <span class="comment">// successfully got first transaction number.</span>
<a name="l06950"></a>06950                         <span class="keywordflow">else</span> 
<a name="l06951"></a>06951                         {
<a name="l06952"></a>06952                             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;SUPPOSEDLY transaction numbers were available, but the call failed...\n&quot;</span>);
<a name="l06953"></a>06953                         }
<a name="l06954"></a>06954 
<a name="l06955"></a>06955                     } <span class="comment">// theNym apparently has enough transaction numbers to exchange the basket.</span>
<a name="l06956"></a>06956 
<a name="l06957"></a>06957                     <span class="comment">// ----------------------------------------------------------------</span>
<a name="l06958"></a>06958 
<a name="l06959"></a>06959                 } <span class="comment">// loaded Basket Info from string.</span>
<a name="l06960"></a>06960                 <span class="keywordflow">else</span> {
<a name="l06961"></a>06961                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error loading basket info from asset contract. Are you SURE this is a basket currency?\n&quot;</span>);
<a name="l06962"></a>06962                 }
<a name="l06963"></a>06963             }
<a name="l06964"></a>06964             <span class="keywordflow">else</span> {
<a name="l06965"></a>06965                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Failure loading or verifying %s\n&quot;</span>, strContractPath.Get());
<a name="l06966"></a>06966             }
<a name="l06967"></a>06967         }
<a name="l06968"></a>06968 
<a name="l06969"></a>06969         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l06970"></a>06970 
<a name="l06971"></a>06971         <span class="keywordflow">break</span>;
<a name="l06972"></a>06972     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a92257b2272c666c28d7b73b4376636c3">OTClient::issueBasket</a>: <span class="comment">// ISSUE BASKET</span>
<a name="l06973"></a>06973         {               
<a name="l06974"></a>06974             <a class="code" href="class_o_t_string.html">OTString</a> strTemp, strBasketInfo;
<a name="l06975"></a>06975 
<a name="l06976"></a>06976             <span class="comment">// Collect NUMBER OF CONTRACTS for the basket.</span>
<a name="l06977"></a>06977             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many different asset types will compose this new basket? [2]: &quot;</span>);
<a name="l06978"></a>06978             strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06979"></a>06979             int32_t nBasketCount = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06980"></a>06980             <span class="keywordflow">if</span> (0 &gt;= nBasketCount)
<a name="l06981"></a>06981                 nBasketCount = 2;
<a name="l06982"></a>06982 
<a name="l06983"></a>06983             <span class="comment">// Collect the MINIMUM TRANSFER AMOUNT for the basket. Default 100.</span>
<a name="l06984"></a>06984             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;If your basket has a minimum transfer amount of 100, you might have 2 or 3 sub-currencies,\n&quot;</span>
<a name="l06985"></a>06985                 <span class="stringliteral">&quot;with the first being a minimum of 2 gold, the second being a minimum of 50 dollars, and the\n&quot;</span>
<a name="l06986"></a>06986                 <span class="stringliteral">&quot;third being a minimum of 30 silver. In this example, 100 units of the basket currency is\n&quot;</span>
<a name="l06987"></a>06987                 <span class="stringliteral">&quot;transferrable in or out of the basket currency, in return for 2 gold, 50 dollars, and 30 silver.\n&quot;</span>
<a name="l06988"></a>06988                 <span class="stringliteral">&quot;As those are only the *minimum* amounts, you could also transfer (in or out) in *any* multiple of\n&quot;</span>
<a name="l06989"></a>06989                 <span class="stringliteral">&quot;those numbers.\n\n&quot;</span>);
<a name="l06990"></a>06990             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the minimum transfer amount for the basket currency itself? [100]: &quot;</span>);
<a name="l06991"></a>06991             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l06992"></a>06992             int64_t lMinimumTransferAmount = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06993"></a>06993             <span class="keywordflow">if</span> (0 == lMinimumTransferAmount)
<a name="l06994"></a>06994                 lMinimumTransferAmount = 100;
<a name="l06995"></a>06995 
<a name="l06996"></a>06996             <span class="comment">// ADD THESE VALUES TO A BASKET OBJECT HERE SO I CAN RE-USE lMinimumTransferAmount for the loop below.</span>
<a name="l06997"></a>06997             <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket(nBasketCount, lMinimumTransferAmount);
<a name="l06998"></a>06998 
<a name="l06999"></a>06999             <span class="comment">// Collect all the contract IDs for the above contracts</span>
<a name="l07000"></a>07000             <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nBasketCount; i++)
<a name="l07001"></a>07001             {
<a name="l07002"></a>07002                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Enter contract ID # %d: &quot;</span>, i+1);
<a name="l07003"></a>07003                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07004"></a>07004 
<a name="l07005"></a>07005                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SUB_CONTRACT_ID(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07006"></a>07006 
<a name="l07007"></a>07007                 <span class="comment">// After each ID, collect the minimum transfer amount for EACH contract.</span>
<a name="l07008"></a>07008                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter minimum transfer amount for that asset type: &quot;</span>);
<a name="l07009"></a>07009                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07010"></a>07010 
<a name="l07011"></a>07011                 lMinimumTransferAmount = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07012"></a>07012 
<a name="l07013"></a>07013                 <span class="comment">// ADD THE CONTRACT ID TO A LIST TO BE SENT TO THE SERVER.</span>
<a name="l07014"></a>07014                 <span class="comment">// ADD THE MINIMUM TRANSFER AMOUNT TO THE SAME OBJECT</span>
<a name="l07015"></a>07015                 theBasket.<a class="code" href="class_o_t_basket.html#ae0a4fc1320ad66dd613b70cbc8e6a32b">AddSubContract</a>(SUB_CONTRACT_ID, lMinimumTransferAmount);
<a name="l07016"></a>07016 
<a name="l07017"></a>07017                 <span class="comment">// The object storing these should also have a space for storing</span>
<a name="l07018"></a>07018                 <span class="comment">// the account ID that will go with each one. The server will add</span>
<a name="l07019"></a>07019                 <span class="comment">// the Account ID when the reserve accounts are generated.</span>
<a name="l07020"></a>07020                 <span class="comment">//</span>
<a name="l07021"></a>07021                 <span class="comment">// (The basket issuer account will contain sub-accounts for the</span>
<a name="l07022"></a>07022                 <span class="comment">// reserves, which are stored there and 100% redeemable at all times.)</span>
<a name="l07023"></a>07023             }
<a name="l07024"></a>07024 
<a name="l07025"></a>07025             <span class="comment">// Export the OTBasket object into a string, add it as</span>
<a name="l07026"></a>07026             <span class="comment">// a payload on message, and send to server.</span>
<a name="l07027"></a>07027             theBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l07028"></a>07028             theBasket.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBasketInfo);
<a name="l07029"></a>07029 
<a name="l07030"></a>07030             <span class="comment">// The user signs and saves the contract, but once the server gets it,</span>
<a name="l07031"></a>07031             <span class="comment">// the server releases signatures and signs it, calculating the hash from the result,</span>
<a name="l07032"></a>07032             <span class="comment">// in order to form the ID.</span>
<a name="l07033"></a>07033             <span class="comment">//</span>
<a name="l07034"></a>07034             <span class="comment">// The result is the same as any other currency contract, but with the server&#39;s signature</span>
<a name="l07035"></a>07035             <span class="comment">// on it (and thus it must store the server&#39;s public key).  The server handles all</span>
<a name="l07036"></a>07036             <span class="comment">// transactions in and out of the basket currency based upon the rules set up by the user.</span>
<a name="l07037"></a>07037             <span class="comment">//</span>
<a name="l07038"></a>07038             <span class="comment">// The user who created the currency has no more control over it. The server reserves the</span>
<a name="l07039"></a>07039             <span class="comment">// right to exchange out to the various users and close the basket.</span>
<a name="l07040"></a>07040 
<a name="l07041"></a>07041             <span class="comment">// AT SOME POINT, strBasketInfo has been populated with the relevant data.</span>
<a name="l07042"></a>07042 
<a name="l07043"></a>07043             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07044"></a>07044             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07045"></a>07045             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07046"></a>07046             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07047"></a>07047 
<a name="l07048"></a>07048             <span class="comment">// (1) Set up member variables </span>
<a name="l07049"></a>07049             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueBasket&quot;</span>;
<a name="l07050"></a>07050             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07051"></a>07051             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07052"></a>07052             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07053"></a>07053 
<a name="l07054"></a>07054             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strBasketInfo);
<a name="l07055"></a>07055 
<a name="l07056"></a>07056             <span class="comment">// (2) Sign the Message </span>
<a name="l07057"></a>07057             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07058"></a>07058 
<a name="l07059"></a>07059             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07060"></a>07060             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07061"></a>07061 
<a name="l07062"></a>07062             bSendCommand = <span class="keyword">true</span>;            
<a name="l07063"></a>07063             lReturnValue = lRequestNumber;
<a name="l07064"></a>07064         }
<a name="l07065"></a>07065 
<a name="l07066"></a>07066         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07067"></a>07067 
<a name="l07068"></a>07068         <span class="keywordflow">break</span>;
<a name="l07069"></a>07069     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aab742ba1837ac9ac107806ba97b66e13">OTClient::createAccount</a>: <span class="comment">// CREATE ACCOUNT</span>
<a name="l07070"></a>07070         {   
<a name="l07071"></a>07071             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type (contract ID): &quot;</span>);
<a name="l07072"></a>07072             <span class="comment">// User input.</span>
<a name="l07073"></a>07073             <span class="comment">// I need a from account</span>
<a name="l07074"></a>07074             <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
<a name="l07075"></a>07075             strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07076"></a>07076 
<a name="l07077"></a>07077             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07078"></a>07078             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07079"></a>07079             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07080"></a>07080             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07081"></a>07081 
<a name="l07082"></a>07082             <span class="comment">// (1) Set up member variables </span>
<a name="l07083"></a>07083             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;createAccount&quot;</span>;
<a name="l07084"></a>07084             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07085"></a>07085             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07086"></a>07086             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07087"></a>07087 
<a name="l07088"></a>07088             theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;<span class="comment">// the hash of the contract is the AssetID</span>
<a name="l07089"></a>07089 
<a name="l07090"></a>07090             <span class="comment">// (2) Sign the Message </span>
<a name="l07091"></a>07091             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07092"></a>07092 
<a name="l07093"></a>07093             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07094"></a>07094             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07095"></a>07095 
<a name="l07096"></a>07096             bSendCommand = <span class="keyword">true</span>;
<a name="l07097"></a>07097             lReturnValue = lRequestNumber;
<a name="l07098"></a>07098         }
<a name="l07099"></a>07099 
<a name="l07100"></a>07100         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07101"></a>07101         <span class="keywordflow">break</span>;
<a name="l07102"></a>07102     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab982770b40b71822dc40f0bb3617d6ec">OTClient::notarizeTransfer</a>: <span class="comment">// NOTARIZE TRANSFER</span>
<a name="l07103"></a>07103         {
<a name="l07104"></a>07104             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07105"></a>07105 
<a name="l07106"></a>07106             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07107"></a>07107             {
<a name="l07108"></a>07108                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (FROM acct): &quot;</span>);
<a name="l07109"></a>07109                 <span class="comment">// User input.</span>
<a name="l07110"></a>07110                 <span class="comment">// I need a from account</span>
<a name="l07111"></a>07111                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07112"></a>07112 
<a name="l07113"></a>07113                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07114"></a>07114                     <span class="keywordflow">return</span> (-1);
<a name="l07115"></a>07115 
<a name="l07116"></a>07116                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l07117"></a>07117 
<a name="l07118"></a>07118                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l07119"></a>07119                 {
<a name="l07120"></a>07120                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07121"></a>07121                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07122"></a>07122                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07123"></a>07123                 }
<a name="l07124"></a>07124                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l07125"></a>07125                 {
<a name="l07126"></a>07126                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07127"></a>07127                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07128"></a>07128                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07129"></a>07129                 }
<a name="l07130"></a>07130                 <span class="keywordflow">else</span>
<a name="l07131"></a>07131                 {
<a name="l07132"></a>07132                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to transfer without a &#39;FROM&#39; account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l07133"></a>07133                     <span class="keywordflow">return</span> (-1);
<a name="l07134"></a>07134                 }
<a name="l07135"></a>07135             }
<a name="l07136"></a>07136             <span class="keywordflow">else</span>
<a name="l07137"></a>07137             {
<a name="l07138"></a>07138                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07139"></a>07139                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07140"></a>07140                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07141"></a>07141             }
<a name="l07142"></a>07142 
<a name="l07143"></a>07143             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l07144"></a>07144             {
<a name="l07145"></a>07145                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l07146"></a>07146                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l07147"></a>07147                 <span class="keywordflow">return</span> (-1);
<a name="l07148"></a>07148             }
<a name="l07149"></a>07149 
<a name="l07150"></a>07150             <span class="comment">// -----------------------------------------------------</span>
<a name="l07151"></a>07151 
<a name="l07152"></a>07152             <a class="code" href="class_o_t_string.html">OTString</a> strRecipientAcct;
<a name="l07153"></a>07153 
<a name="l07154"></a>07154             <span class="keywordflow">if</span> (NULL == pHisAcctID)
<a name="l07155"></a>07155             {
<a name="l07156"></a>07156                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s asset account ID (no partial IDs here): &quot;</span>);
<a name="l07157"></a>07157 
<a name="l07158"></a>07158                 <span class="comment">// User input.</span>
<a name="l07159"></a>07159                 <span class="comment">// I need a from account</span>
<a name="l07160"></a>07160                 strRecipientAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07161"></a>07161 
<a name="l07162"></a>07162                 <span class="keywordflow">if</span> (strRecipientAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07163"></a>07163                     <span class="keywordflow">return</span> (-1);            
<a name="l07164"></a>07164             }
<a name="l07165"></a>07165             <span class="keywordflow">else</span>
<a name="l07166"></a>07166             {
<a name="l07167"></a>07167                 pHisAcctID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientAcct);            
<a name="l07168"></a>07168             }
<a name="l07169"></a>07169 
<a name="l07170"></a>07170             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_ACCT_ID(strRecipientAcct);
<a name="l07171"></a>07171 
<a name="l07172"></a>07172             <span class="comment">// ----------------------------------------------   </span>
<a name="l07173"></a>07173             <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
<a name="l07174"></a>07174             <span class="keywordflow">if</span> (0 == lTransactionAmount)
<a name="l07175"></a>07175             {
<a name="l07176"></a>07176                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
<a name="l07177"></a>07177                 <span class="comment">// User input.</span>
<a name="l07178"></a>07178                 <span class="comment">// I need an amount</span>
<a name="l07179"></a>07179                 strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07180"></a>07180             }
<a name="l07181"></a>07181 
<a name="l07182"></a>07182             <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
<a name="l07183"></a>07183                 (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
<a name="l07184"></a>07184             <span class="comment">// ----------------------------------------------</span>
<a name="l07185"></a>07185 
<a name="l07186"></a>07186             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    ACCT_FROM_ID(strFromAcct), USER_ID(theNym);
<a name="l07187"></a>07187 
<a name="l07188"></a>07188             int64_t lStoredTransactionNumber=0;
<a name="l07189"></a>07189             <span class="keywordtype">bool</span> bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber); <span class="comment">// this saves</span>
<a name="l07190"></a>07190 
<a name="l07191"></a>07191             <span class="comment">//      int32_t GetTransactionNumCount(const OTIdentifier &amp; theServerID); // count</span>
<a name="l07192"></a>07192 
<a name="l07193"></a>07193             <span class="keywordflow">if</span> (bGotTransNum)
<a name="l07194"></a>07194             {
<a name="l07195"></a>07195                 <span class="comment">// Create a transaction</span>
<a name="l07196"></a>07196                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>, lStoredTransactionNumber); 
<a name="l07197"></a>07197 
<a name="l07198"></a>07198                 <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l07199"></a>07199                 <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>, &amp;HIS_ACCT_ID);
<a name="l07200"></a>07200 
<a name="l07201"></a>07201                 pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
<a name="l07202"></a>07202 
<a name="l07203"></a>07203                 <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Just testing the notes...blah blah blah blah blah blah&quot;</span>);
<a name="l07204"></a>07204                 pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l07205"></a>07205 
<a name="l07206"></a>07206                 <span class="comment">// sign the item</span>
<a name="l07207"></a>07207                 pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l07208"></a>07208                 pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07209"></a>07209 
<a name="l07210"></a>07210                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l07211"></a>07211 
<a name="l07212"></a>07212                 <span class="comment">// ---------------------------------------------</span>
<a name="l07213"></a>07213 
<a name="l07214"></a>07214                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l07215"></a>07215                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l07216"></a>07216 
<a name="l07217"></a>07217                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l07218"></a>07218                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l07219"></a>07219 
<a name="l07220"></a>07220                 <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l07221"></a>07221                 {
<a name="l07222"></a>07222                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l07223"></a>07223 
<a name="l07224"></a>07224                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l07225"></a>07225                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
<a name="l07226"></a>07226                 }
<a name="l07227"></a>07227 
<a name="l07228"></a>07228                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l07229"></a>07229                 {
<a name="l07230"></a>07230                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l07231"></a>07231 
<a name="l07232"></a>07232                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l07233"></a>07233                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
<a name="l07234"></a>07234                 }
<a name="l07235"></a>07235                 <span class="comment">// BALANCE AGREEMENT </span>
<a name="l07236"></a>07236 
<a name="l07237"></a>07237                 <span class="keywordflow">else</span> 
<a name="l07238"></a>07238                 {
<a name="l07239"></a>07239                     <span class="comment">// Need to setup a dummy outbox transaction (to mimic the one that will be on the server side when this pending transaction is actually put into the real outbox.)</span>
<a name="l07240"></a>07240                     <span class="comment">// When the server adds its own, and then compares the two, they should both show the same pending transaction, in order for this balance agreement to be valid..</span>
<a name="l07241"></a>07241                     <span class="comment">// Otherwise the server would have to refuse it for being inaccurate (server can&#39;t sign something inaccurate!) So I throw a dummy on there before generating balance statement.</span>
<a name="l07242"></a>07242 
<a name="l07243"></a>07243                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pOutboxTransaction  = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pOutbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
<a name="l07244"></a>07244                         1<span class="comment">/*todo pick some number that everyone agrees doesn&#39;t matter, like 1. The referring-to is the important </span>
<a name="l07245"></a>07245 <span class="comment">                         number in this case, and perhaps server should update this value too before signing and returning.*/</span>); <span class="comment">// todo use a constant instead of &#39;1&#39;</span>
<a name="l07246"></a>07246 
<a name="l07247"></a>07247                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOutboxTransaction); <span class="comment">// for now.</span>
<a name="l07248"></a>07248 
<a name="l07249"></a>07249                     <a class="code" href="class_o_t_string.html">OTString</a> strItem(*pItem);
<a name="l07250"></a>07250                     pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strItem); <span class="comment">// So the GenerateBalanceStatement function below can get the other info off this item (like amount, etc)</span>
<a name="l07251"></a>07251                     pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l07252"></a>07252 
<a name="l07253"></a>07253                     <span class="comment">//              pOutboxTransaction-&gt;SignContract(theNym);   // Unnecessary to sign/save, since this is just a dummy data for verification</span>
<a name="l07254"></a>07254                     <span class="comment">//              pOutboxTransaction-&gt;SaveContract();         // purposes, and isn&#39;t being serialized anywhere.</span>
<a name="l07255"></a>07255 
<a name="l07256"></a>07256                     pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pOutboxTransaction);  <span class="comment">// no need to cleanup pOutboxTransaction since pOutbox will handle it now.</span>
<a name="l07257"></a>07257 
<a name="l07258"></a>07258                     <span class="comment">// ---------------------------------------------</span>
<a name="l07259"></a>07259 
<a name="l07260"></a>07260                     <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l07261"></a>07261                     <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(atol(strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())*(-1), *pTransaction, theNym, *pAccount, *pOutbox);               
<a name="l07262"></a>07262 
<a name="l07263"></a>07263                     <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l07264"></a>07264                         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l07265"></a>07265 
<a name="l07266"></a>07266                     <span class="comment">// ---------------------------------------------</span>
<a name="l07267"></a>07267 
<a name="l07268"></a>07268 
<a name="l07269"></a>07269                     <span class="comment">// sign the transaction</span>
<a name="l07270"></a>07270                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l07271"></a>07271                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07272"></a>07272 
<a name="l07273"></a>07273 
<a name="l07274"></a>07274                     <span class="comment">// set up the ledger</span>
<a name="l07275"></a>07275                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
<a name="l07276"></a>07276                     theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l07277"></a>07277                     theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l07278"></a>07278 
<a name="l07279"></a>07279                     <span class="comment">// sign the ledger</span>
<a name="l07280"></a>07280                     theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l07281"></a>07281                     theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07282"></a>07282 
<a name="l07283"></a>07283                     <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l07284"></a>07284                     <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l07285"></a>07285                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l07286"></a>07286 
<a name="l07287"></a>07287                     <span class="comment">// Encoding...</span>
<a name="l07288"></a>07288                     ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l07289"></a>07289 
<a name="l07290"></a>07290 
<a name="l07291"></a>07291                     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07292"></a>07292                     theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l07293"></a>07293                     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07294"></a>07294                     theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07295"></a>07295 
<a name="l07296"></a>07296                     <span class="comment">// (1) Set up member variables </span>
<a name="l07297"></a>07297                     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l07298"></a>07298                     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07299"></a>07299                     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07300"></a>07300                     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07301"></a>07301 
<a name="l07302"></a>07302                     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l07303"></a>07303                     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l07304"></a>07304 
<a name="l07305"></a>07305                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l07306"></a>07306                     <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07307"></a>07307                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l07308"></a>07308 
<a name="l07309"></a>07309                     <span class="keywordflow">if</span> (bNymboxHash)
<a name="l07310"></a>07310                         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l07311"></a>07311                     <span class="keywordflow">else</span>
<a name="l07312"></a>07312                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l07313"></a>07313                         str_server.c_str());
<a name="l07314"></a>07314 
<a name="l07315"></a>07315                     <span class="comment">// (2) Sign the Message </span>
<a name="l07316"></a>07316                     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07317"></a>07317 
<a name="l07318"></a>07318                     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07319"></a>07319                     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07320"></a>07320 
<a name="l07321"></a>07321                     bSendCommand = <span class="keyword">true</span>;
<a name="l07322"></a>07322                     lReturnValue = lRequestNumber;
<a name="l07323"></a>07323                 }
<a name="l07324"></a>07324 
<a name="l07325"></a>07325             }
<a name="l07326"></a>07326             <span class="keywordflow">else</span> 
<a name="l07327"></a>07327             {
<a name="l07328"></a>07328                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No transaction numbers were available. Suggest requesting the server for one.\n&quot;</span>);
<a name="l07329"></a>07329             }
<a name="l07330"></a>07330         }
<a name="l07331"></a>07331 
<a name="l07332"></a>07332         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07333"></a>07333 
<a name="l07334"></a>07334         <span class="keywordflow">break</span>;
<a name="l07335"></a>07335     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5a1a6394ec07704c99303e9e5fafd96f">OTClient::setAssetName</a>: <span class="comment">// SET ASSET CONTRACT NAME (wallet label only)</span>
<a name="l07336"></a>07336         {   
<a name="l07337"></a>07337             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
<a name="l07338"></a>07338 
<a name="l07339"></a>07339             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Type ID: &quot;</span>);
<a name="l07340"></a>07340             <span class="comment">// User input.</span>
<a name="l07341"></a>07341             <span class="comment">// I need a server ID</span>
<a name="l07342"></a>07342             <a class="code" href="class_o_t_string.html">OTString</a> strContractID;
<a name="l07343"></a>07343             strContractID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07344"></a>07344 
<a name="l07345"></a>07345             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetID(strContractID);
<a name="l07346"></a>07346 
<a name="l07347"></a>07347             <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pTargetContract = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a4daee51036b24439e687383a6c66c6f7">GetAssetContract</a>(theTargetID);
<a name="l07348"></a>07348 
<a name="l07349"></a>07349             <span class="keywordflow">if</span> (NULL != pTargetContract)
<a name="l07350"></a>07350             {
<a name="l07351"></a>07351                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that asset type: &quot;</span>);
<a name="l07352"></a>07352                 <span class="comment">// User input.</span>
<a name="l07353"></a>07353                 <span class="comment">// I need a name</span>
<a name="l07354"></a>07354                 <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
<a name="l07355"></a>07355                 strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07356"></a>07356 
<a name="l07357"></a>07357                 pTargetContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);
<a name="l07358"></a>07358 
<a name="l07359"></a>07359                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the server&#39;s name is stored here.</span>
<a name="l07360"></a>07360             }
<a name="l07361"></a>07361             <span class="keywordflow">else</span> 
<a name="l07362"></a>07362             {
<a name="l07363"></a>07363                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Asset Contract found with that ID. Try &#39;load&#39;.\n&quot;</span>);
<a name="l07364"></a>07364             }
<a name="l07365"></a>07365         }
<a name="l07366"></a>07366 
<a name="l07367"></a>07367         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07368"></a>07368 
<a name="l07369"></a>07369         <span class="keywordflow">break</span>;
<a name="l07370"></a>07370     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7abac2774f1d2494b6e545436b9b39b5b2">OTClient::setServerName</a>: <span class="comment">// SET SERVER CONTRACT NAME (wallet label only)</span>
<a name="l07371"></a>07371         {   
<a name="l07372"></a>07372             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
<a name="l07373"></a>07373 
<a name="l07374"></a>07374             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a Server ID: &quot;</span>);
<a name="l07375"></a>07375             <span class="comment">// User input.</span>
<a name="l07376"></a>07376             <span class="comment">// I need a server ID</span>
<a name="l07377"></a>07377             <a class="code" href="class_o_t_string.html">OTString</a> strContractID;
<a name="l07378"></a>07378             strContractID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07379"></a>07379 
<a name="l07380"></a>07380             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetID(strContractID);
<a name="l07381"></a>07381 
<a name="l07382"></a>07382             <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pTargetContract = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(theTargetID);
<a name="l07383"></a>07383 
<a name="l07384"></a>07384             <span class="keywordflow">if</span> (NULL != pTargetContract)
<a name="l07385"></a>07385             {
<a name="l07386"></a>07386                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that transaction server: &quot;</span>);
<a name="l07387"></a>07387                 <span class="comment">// User input.</span>
<a name="l07388"></a>07388                 <span class="comment">// I need a name</span>
<a name="l07389"></a>07389                 <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
<a name="l07390"></a>07390                 strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07391"></a>07391 
<a name="l07392"></a>07392                 pTargetContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);
<a name="l07393"></a>07393 
<a name="l07394"></a>07394                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the server&#39;s name is stored here.</span>
<a name="l07395"></a>07395             }
<a name="l07396"></a>07396             <span class="keywordflow">else</span> 
<a name="l07397"></a>07397             {
<a name="l07398"></a>07398                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Server Contract found with that ID. Try &#39;load&#39;.\n&quot;</span>);
<a name="l07399"></a>07399             }
<a name="l07400"></a>07400         }
<a name="l07401"></a>07401 
<a name="l07402"></a>07402         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07403"></a>07403 
<a name="l07404"></a>07404         <span class="keywordflow">break</span>;
<a name="l07405"></a>07405     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a00d77f12e9e7f03560b1554f74c1eae5">OTClient::setNymName</a>: <span class="comment">// SET NYM NAME (wallet label only)</span>
<a name="l07406"></a>07406         {   
<a name="l07407"></a>07407             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
<a name="l07408"></a>07408 
<a name="l07409"></a>07409             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a Nym ID: &quot;</span>);
<a name="l07410"></a>07410             <span class="comment">// User input.</span>
<a name="l07411"></a>07411             <span class="comment">// I need a nym ID</span>
<a name="l07412"></a>07412             <a class="code" href="class_o_t_string.html">OTString</a> strNymID;
<a name="l07413"></a>07413             strNymID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07414"></a>07414 
<a name="l07415"></a>07415             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTargetNymID(strNymID);
<a name="l07416"></a>07416 
<a name="l07417"></a>07417             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pTargetNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(theTargetNymID);
<a name="l07418"></a>07418 
<a name="l07419"></a>07419             <span class="keywordflow">if</span> (NULL != pTargetNym)
<a name="l07420"></a>07420             {
<a name="l07421"></a>07421                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that Nym: &quot;</span>);
<a name="l07422"></a>07422                 <span class="comment">// User input.</span>
<a name="l07423"></a>07423                 <span class="comment">// I need a name</span>
<a name="l07424"></a>07424                 <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
<a name="l07425"></a>07425                 strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07426"></a>07426 
<a name="l07427"></a>07427                 <a class="code" href="class_o_t_string.html">OTString</a> strOldName(pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a42e63697c3c3b1bdb526ee7990a9c0e7">GetNymName</a>()); <span class="comment">// just in case.</span>
<a name="l07428"></a>07428 
<a name="l07429"></a>07429                 pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strNewName);
<a name="l07430"></a>07430 
<a name="l07431"></a>07431                 <span class="keywordflow">if</span> (pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(theNym)) <span class="comment">// theNym is signer on this file.</span>
<a name="l07432"></a>07432                 {
<a name="l07433"></a>07433                     m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the nym&#39;s name is stored here, too.</span>
<a name="l07434"></a>07434                 }
<a name="l07435"></a>07435                 <span class="keywordflow">else</span>
<a name="l07436"></a>07436                     pTargetNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strOldName);
<a name="l07437"></a>07437             }
<a name="l07438"></a>07438             <span class="keywordflow">else</span> 
<a name="l07439"></a>07439             {
<a name="l07440"></a>07440                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Nym found with that ID. Try &#39;load&#39;.\n&quot;</span>);
<a name="l07441"></a>07441             }
<a name="l07442"></a>07442         }
<a name="l07443"></a>07443 
<a name="l07444"></a>07444         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07445"></a>07445 
<a name="l07446"></a>07446         <span class="keywordflow">break</span>;
<a name="l07447"></a>07447     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a408a59824c97ac7fed449e944f950da9">OTClient::setAccountName</a>: <span class="comment">// SET ACCOUNT NAME (wallet label only)</span>
<a name="l07448"></a>07448         {   
<a name="l07449"></a>07449             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
<a name="l07450"></a>07450 
<a name="l07451"></a>07451             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset account ID: &quot;</span>);
<a name="l07452"></a>07452             <span class="comment">// User input.</span>
<a name="l07453"></a>07453             <span class="comment">// I need an account</span>
<a name="l07454"></a>07454             <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
<a name="l07455"></a>07455             strAcctID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07456"></a>07456 
<a name="l07457"></a>07457             <span class="keywordflow">if</span> (strAcctID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07458"></a>07458                 <span class="keywordflow">return</span> (-1);
<a name="l07459"></a>07459 
<a name="l07460"></a>07460             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID(strAcctID);
<a name="l07461"></a>07461 
<a name="l07462"></a>07462             <a class="code" href="class_o_t_account.html">OTAccount</a> * pTheAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(theAccountID);
<a name="l07463"></a>07463 
<a name="l07464"></a>07464             <span class="keywordflow">if</span> (NULL != pTheAccount)
<a name="l07465"></a>07465             {
<a name="l07466"></a>07466                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the new client-side \&quot;name\&quot; label for that Account: &quot;</span>);
<a name="l07467"></a>07467                 <span class="comment">// User input.</span>
<a name="l07468"></a>07468                 <span class="comment">// I need a name</span>
<a name="l07469"></a>07469                 <a class="code" href="class_o_t_string.html">OTString</a> strNewName;
<a name="l07470"></a>07470                 strNewName.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07471"></a>07471 
<a name="l07472"></a>07472                 pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(strNewName);
<a name="l07473"></a>07473                 pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l07474"></a>07474 
<a name="l07475"></a>07475                 pTheAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l07476"></a>07476                 pTheAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>();
<a name="l07477"></a>07477 
<a name="l07478"></a>07478                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l07479"></a>07479             }
<a name="l07480"></a>07480             <span class="keywordflow">else</span> 
<a name="l07481"></a>07481             {
<a name="l07482"></a>07482                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No account found with that ID. Try &#39;load&#39;.\n&quot;</span>);
<a name="l07483"></a>07483             }
<a name="l07484"></a>07484         }
<a name="l07485"></a>07485 
<a name="l07486"></a>07486         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07487"></a>07487 
<a name="l07488"></a>07488         <span class="keywordflow">break</span>;
<a name="l07489"></a>07489     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a81f19a83547bbc089eb7efa134c9e22a">OTClient::getNymbox</a>: <span class="comment">// GET NYMBOX</span>
<a name="l07490"></a>07490         {           
<a name="l07491"></a>07491 
<a name="l07492"></a>07492             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07493"></a>07493             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07494"></a>07494             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07495"></a>07495             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07496"></a>07496 
<a name="l07497"></a>07497             <span class="comment">// (1) Set up member variables </span>
<a name="l07498"></a>07498             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getNymbox&quot;</span>;
<a name="l07499"></a>07499             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07500"></a>07500             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07501"></a>07501             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07502"></a>07502 
<a name="l07503"></a>07503             <span class="comment">// (2) Sign the Message </span>
<a name="l07504"></a>07504             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07505"></a>07505 
<a name="l07506"></a>07506             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07507"></a>07507             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07508"></a>07508 
<a name="l07509"></a>07509             bSendCommand = <span class="keyword">true</span>;
<a name="l07510"></a>07510             lReturnValue = lRequestNumber;
<a name="l07511"></a>07511         }
<a name="l07512"></a>07512 
<a name="l07513"></a>07513         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07514"></a>07514 
<a name="l07515"></a>07515         <span class="keywordflow">break</span>;
<a name="l07516"></a>07516     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9072509cb34ebc5805957ebeb0866d76">OTClient::getInbox</a>: <span class="comment">// GET INBOX</span>
<a name="l07517"></a>07517         {           
<a name="l07518"></a>07518             <span class="comment">// --------------------------------</span>
<a name="l07519"></a>07519 
<a name="l07520"></a>07520             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07521"></a>07521 
<a name="l07522"></a>07522             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07523"></a>07523             {
<a name="l07524"></a>07524                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to get its INBOX): &quot;</span>);
<a name="l07525"></a>07525                 <span class="comment">// User input.</span>
<a name="l07526"></a>07526                 <span class="comment">// I need a from account</span>
<a name="l07527"></a>07527                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07528"></a>07528 
<a name="l07529"></a>07529                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07530"></a>07530                     <span class="keywordflow">return</span> (-1);
<a name="l07531"></a>07531 
<a name="l07532"></a>07532                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l07533"></a>07533 
<a name="l07534"></a>07534                 <span class="keywordflow">if</span> ( (pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL )
<a name="l07535"></a>07535                 {
<a name="l07536"></a>07536                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07537"></a>07537                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07538"></a>07538                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07539"></a>07539                 }
<a name="l07540"></a>07540                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l07541"></a>07541                 {
<a name="l07542"></a>07542                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07543"></a>07543                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07544"></a>07544                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07545"></a>07545                 }
<a name="l07546"></a>07546                 <span class="keywordflow">else</span>
<a name="l07547"></a>07547                 {
<a name="l07548"></a>07548                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download Inbox without an account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l07549"></a>07549                     <span class="keywordflow">return</span> (-1);
<a name="l07550"></a>07550                 }
<a name="l07551"></a>07551             }
<a name="l07552"></a>07552             <span class="keywordflow">else</span>
<a name="l07553"></a>07553             {
<a name="l07554"></a>07554                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07555"></a>07555                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07556"></a>07556                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07557"></a>07557             }
<a name="l07558"></a>07558 
<a name="l07559"></a>07559             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l07560"></a>07560             {
<a name="l07561"></a>07561                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l07562"></a>07562                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l07563"></a>07563                 <span class="keywordflow">return</span> (-1);
<a name="l07564"></a>07564             }
<a name="l07565"></a>07565 
<a name="l07566"></a>07566             <span class="comment">// ------------------------------------</span>
<a name="l07567"></a>07567 
<a name="l07568"></a>07568             <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
<a name="l07569"></a>07569             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l07570"></a>07570 
<a name="l07571"></a>07571             pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theAccountID);
<a name="l07572"></a>07572             theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);
<a name="l07573"></a>07573 
<a name="l07574"></a>07574             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07575"></a>07575             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07576"></a>07576             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07577"></a>07577             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07578"></a>07578 
<a name="l07579"></a>07579             <span class="comment">// (1) Set up member variables </span>
<a name="l07580"></a>07580             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getInbox&quot;</span>;
<a name="l07581"></a>07581             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07582"></a>07582             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07583"></a>07583             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07584"></a>07584 
<a name="l07585"></a>07585             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l07586"></a>07586 
<a name="l07587"></a>07587             <span class="comment">// (2) Sign the Message </span>
<a name="l07588"></a>07588             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07589"></a>07589 
<a name="l07590"></a>07590             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07591"></a>07591             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07592"></a>07592 
<a name="l07593"></a>07593             bSendCommand = <span class="keyword">true</span>;
<a name="l07594"></a>07594             lReturnValue = lRequestNumber;
<a name="l07595"></a>07595         }
<a name="l07596"></a>07596 
<a name="l07597"></a>07597         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07598"></a>07598 
<a name="l07599"></a>07599         <span class="keywordflow">break</span>;
<a name="l07600"></a>07600     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5711ae103a3c7b16a3769fd95b907113">OTClient::getOutbox</a>: <span class="comment">// GET OUTBOX</span>
<a name="l07601"></a>07601         {   
<a name="l07602"></a>07602             <span class="comment">// --------------------------------</span>
<a name="l07603"></a>07603 
<a name="l07604"></a>07604             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07605"></a>07605 
<a name="l07606"></a>07606             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07607"></a>07607             {
<a name="l07608"></a>07608                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to get its OUTBOX): &quot;</span>);
<a name="l07609"></a>07609                 <span class="comment">// User input.</span>
<a name="l07610"></a>07610                 <span class="comment">// I need a from account</span>
<a name="l07611"></a>07611                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07612"></a>07612 
<a name="l07613"></a>07613                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07614"></a>07614                     <span class="keywordflow">return</span> (-1);
<a name="l07615"></a>07615 
<a name="l07616"></a>07616                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l07617"></a>07617 
<a name="l07618"></a>07618                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l07619"></a>07619                 {
<a name="l07620"></a>07620                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07621"></a>07621                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07622"></a>07622                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07623"></a>07623                 }
<a name="l07624"></a>07624                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l07625"></a>07625                 {
<a name="l07626"></a>07626                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07627"></a>07627                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07628"></a>07628                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07629"></a>07629                 }
<a name="l07630"></a>07630                 <span class="keywordflow">else</span>
<a name="l07631"></a>07631                 {
<a name="l07632"></a>07632                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download outbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l07633"></a>07633                     <span class="keywordflow">return</span> (-1);
<a name="l07634"></a>07634                 }
<a name="l07635"></a>07635             }
<a name="l07636"></a>07636             <span class="keywordflow">else</span>
<a name="l07637"></a>07637             {
<a name="l07638"></a>07638                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07639"></a>07639                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07640"></a>07640                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07641"></a>07641             }
<a name="l07642"></a>07642 
<a name="l07643"></a>07643             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l07644"></a>07644             {
<a name="l07645"></a>07645                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l07646"></a>07646                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l07647"></a>07647                 <span class="keywordflow">return</span> (-1);
<a name="l07648"></a>07648             }
<a name="l07649"></a>07649 
<a name="l07650"></a>07650             <span class="comment">// ------------------------------------</span>
<a name="l07651"></a>07651 
<a name="l07652"></a>07652             <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
<a name="l07653"></a>07653             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l07654"></a>07654 
<a name="l07655"></a>07655             pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theAccountID);
<a name="l07656"></a>07656             theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  
<a name="l07657"></a>07657 
<a name="l07658"></a>07658             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07659"></a>07659             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07660"></a>07660             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07661"></a>07661             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07662"></a>07662 
<a name="l07663"></a>07663             <span class="comment">// (1) Set up member variables </span>
<a name="l07664"></a>07664             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getOutbox&quot;</span>;
<a name="l07665"></a>07665             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07666"></a>07666             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07667"></a>07667             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07668"></a>07668 
<a name="l07669"></a>07669             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l07670"></a>07670 
<a name="l07671"></a>07671             <span class="comment">// (2) Sign the Message </span>
<a name="l07672"></a>07672             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07673"></a>07673 
<a name="l07674"></a>07674             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07675"></a>07675             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07676"></a>07676 
<a name="l07677"></a>07677             bSendCommand = <span class="keyword">true</span>;
<a name="l07678"></a>07678             lReturnValue = lRequestNumber;
<a name="l07679"></a>07679         }
<a name="l07680"></a>07680 
<a name="l07681"></a>07681 
<a name="l07682"></a>07682         <span class="comment">/*</span>
<a name="l07683"></a>07683 <span class="comment">        bool OTClient::ProcessUserCommand(OTClient::OT_CLIENT_CMD_TYPE requestedCommand,</span>
<a name="l07684"></a>07684 <span class="comment">        OTMessage &amp; theMessage,</span>
<a name="l07685"></a>07685 <span class="comment">        OTPseudonym &amp; theNym,</span>
<a name="l07686"></a>07686 <span class="comment">        //                                OTAssetContract &amp; theContract,</span>
<a name="l07687"></a>07687 <span class="comment">        OTServerContract &amp; theServer,</span>
<a name="l07688"></a>07688 <span class="comment">        OTAccount * pAccount=NULL,</span>
<a name="l07689"></a>07689 <span class="comment">        int64_t lTransactionAmount=0,</span>
<a name="l07690"></a>07690 <span class="comment">        OTAssetContract * pMyAssetContract=NULL,</span>
<a name="l07691"></a>07691 <span class="comment">        OTIdentifier * pHisNymID=NULL,</span>
<a name="l07692"></a>07692 <span class="comment">        OTIdentifier * pHisAcctID=NULL)</span>
<a name="l07693"></a>07693 <span class="comment">        {</span>
<a name="l07694"></a>07694 <span class="comment">        // This is all preparatory work to get the various pieces of data together -- only</span>
<a name="l07695"></a>07695 <span class="comment">        // then can we put those pieces into a message.</span>
<a name="l07696"></a>07696 <span class="comment">        OTIdentifier CONTRACT_ID;</span>
<a name="l07697"></a>07697 <span class="comment">        OTString strNymID, strContractID, strServerID, strNymPublicKey, strAccountID;</span>
<a name="l07698"></a>07698 <span class="comment">        int64_t lRequestNumber = 0;</span>
<a name="l07699"></a>07699 <span class="comment"></span>
<a name="l07700"></a>07700 <span class="comment">        theNym.GetIdentifier(strNymID);</span>
<a name="l07701"></a>07701 <span class="comment">        theServer.GetIdentifier(strServerID);</span>
<a name="l07702"></a>07702 <span class="comment"></span>
<a name="l07703"></a>07703 <span class="comment">        const OTIdentifier SERVER_ID(strServerID);</span>
<a name="l07704"></a>07704 <span class="comment">        */</span>
<a name="l07705"></a>07705 
<a name="l07706"></a>07706         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07707"></a>07707         <span class="comment">// This is called by the command line user.</span>
<a name="l07708"></a>07708 
<a name="l07709"></a>07709         <span class="keywordflow">break</span>;
<a name="l07710"></a>07710     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a371b16fad327b8e308761027a59e4a00">OTClient::processEntireNymbox</a>: <span class="comment">// PROCESS ENTIRE NYMBOX</span>
<a name="l07711"></a>07711         {
<a name="l07712"></a>07712             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);
<a name="l07713"></a>07713 
<a name="l07714"></a>07714             <span class="comment">// Load up the appropriate Nymbox... </span>
<a name="l07715"></a>07715             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox(MY_NYM_ID, MY_NYM_ID, SERVER_ID);
<a name="l07716"></a>07716 
<a name="l07717"></a>07717             <span class="keywordtype">bool</span> bSuccess           = <span class="keyword">false</span>;
<a name="l07718"></a>07718             <span class="keywordtype">bool</span> bLoadedNymbox      = theNymbox.<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>();
<a name="l07719"></a>07719             <span class="keywordtype">bool</span> bVerifiedNymbox    = bLoadedNymbox ? theNymbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(theNym) : <span class="keyword">false</span>;
<a name="l07720"></a>07720             <span class="keywordtype">bool</span> bIsEmpty           = theNymbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &lt; 1;
<a name="l07721"></a>07721 
<a name="l07722"></a>07722             <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedNymbox)
<a name="l07723"></a>07723                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed loading Nymbox: %s \n&quot;</span>,
<a name="l07724"></a>07724                 strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07725"></a>07725             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bVerifiedNymbox)
<a name="l07726"></a>07726                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed verifying Nymbox: %s \n&quot;</span>,
<a name="l07727"></a>07727                 strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07728"></a>07728             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bIsEmpty)
<a name="l07729"></a>07729                 bSuccess = <a class="code" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">AcceptEntireNymbox</a>(theNymbox, SERVER_ID, theServer, theNym, theMessage);
<a name="l07730"></a>07730             <span class="comment">// -----------------</span>
<a name="l07731"></a>07731 
<a name="l07732"></a>07732             <span class="keywordflow">if</span> (!bSuccess)
<a name="l07733"></a>07733             {
<a name="l07734"></a>07734                 <span class="keywordflow">if</span> (bIsEmpty)
<a name="l07735"></a>07735                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Nymbox (%s) is empty (so, skipping processNymbox.)\n&quot;</span>,
<a name="l07736"></a>07736                     strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07737"></a>07737                 <span class="keywordflow">else</span>
<a name="l07738"></a>07738                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::ProcessUserCommand::processEntireNymbox: Failed trying to accept the entire Nymbox.\n&quot;</span>);
<a name="l07739"></a>07739             }
<a name="l07740"></a>07740             <span class="keywordflow">else</span>
<a name="l07741"></a>07741             {
<a name="l07742"></a>07742                 <span class="comment">// (2) Sign the Message </span>
<a name="l07743"></a>07743                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07744"></a>07744 
<a name="l07745"></a>07745                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07746"></a>07746                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07747"></a>07747 
<a name="l07748"></a>07748                 bSendCommand = <span class="keyword">true</span>;
<a name="l07749"></a>07749             }
<a name="l07750"></a>07750         }
<a name="l07751"></a>07751 
<a name="l07752"></a>07752         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07753"></a>07753         <span class="comment">// This is called by AcceptEntireNymbox().</span>
<a name="l07754"></a>07754 
<a name="l07755"></a>07755         <span class="keywordflow">break</span>;
<a name="l07756"></a>07756     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a463175ff68504609265120b65a0b72e7">OTClient::processNymbox</a>: <span class="comment">// PROCESS NYMBOX</span>
<a name="l07757"></a>07757         {           
<a name="l07758"></a>07758             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07759"></a>07759             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07760"></a>07760             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07761"></a>07761             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07762"></a>07762 
<a name="l07763"></a>07763             <span class="comment">// (1) Set up member variables </span>
<a name="l07764"></a>07764             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;processNymbox&quot;</span>;
<a name="l07765"></a>07765             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07766"></a>07766             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07767"></a>07767             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07768"></a>07768 
<a name="l07769"></a>07769             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> EXISTING_NYMBOX_HASH;
<a name="l07770"></a>07770             <span class="keyword">const</span> std::string str_server_id(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07771"></a>07771 
<a name="l07772"></a>07772             <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server_id, EXISTING_NYMBOX_HASH);
<a name="l07773"></a>07773 
<a name="l07774"></a>07774             <span class="keywordflow">if</span> (bSuccess)
<a name="l07775"></a>07775                 EXISTING_NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l07776"></a>07776 
<a name="l07777"></a>07777             <span class="comment">// (2) Sign the Message </span>
<a name="l07778"></a>07778             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07779"></a>07779 
<a name="l07780"></a>07780             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07781"></a>07781             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07782"></a>07782 
<a name="l07783"></a>07783             bSendCommand = <span class="keyword">true</span>;
<a name="l07784"></a>07784             lReturnValue = lRequestNumber;        
<a name="l07785"></a>07785         }
<a name="l07786"></a>07786 
<a name="l07787"></a>07787         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07788"></a>07788         <span class="comment">// This is called by the user of the command line utility.</span>
<a name="l07789"></a>07789         <span class="comment">//</span>
<a name="l07790"></a>07790         <span class="keywordflow">break</span>;
<a name="l07791"></a>07791     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ae5da54e97abe09fdebbf73f36a957222">OTClient::processEntireInbox</a>: <span class="comment">// PROCESS ENTIRE INBOX</span>
<a name="l07792"></a>07792         {
<a name="l07793"></a>07793             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);
<a name="l07794"></a>07794 
<a name="l07795"></a>07795             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07796"></a>07796 
<a name="l07797"></a>07797             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07798"></a>07798             {
<a name="l07799"></a>07799                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to PROCESS its INBOX): &quot;</span>);
<a name="l07800"></a>07800                 <span class="comment">// User input.</span>
<a name="l07801"></a>07801                 <span class="comment">// I need a from account</span>
<a name="l07802"></a>07802                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07803"></a>07803 
<a name="l07804"></a>07804                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07805"></a>07805                     <span class="keywordflow">return</span> (-1);
<a name="l07806"></a>07806 
<a name="l07807"></a>07807                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l07808"></a>07808 
<a name="l07809"></a>07809                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL )
<a name="l07810"></a>07810                 {
<a name="l07811"></a>07811                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07812"></a>07812                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07813"></a>07813                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07814"></a>07814                 }
<a name="l07815"></a>07815                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l07816"></a>07816                 {
<a name="l07817"></a>07817                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07818"></a>07818                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07819"></a>07819                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07820"></a>07820                 }
<a name="l07821"></a>07821                 <span class="keywordflow">else</span>
<a name="l07822"></a>07822                 {
<a name="l07823"></a>07823                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to process inbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l07824"></a>07824                     <span class="keywordflow">return</span> (-1);
<a name="l07825"></a>07825                 }
<a name="l07826"></a>07826             }
<a name="l07827"></a>07827             <span class="keywordflow">else</span>
<a name="l07828"></a>07828             {
<a name="l07829"></a>07829                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07830"></a>07830                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07831"></a>07831                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07832"></a>07832             }
<a name="l07833"></a>07833 
<a name="l07834"></a>07834             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l07835"></a>07835             {
<a name="l07836"></a>07836                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l07837"></a>07837                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l07838"></a>07838                 <span class="keywordflow">return</span> (-1);
<a name="l07839"></a>07839             }
<a name="l07840"></a>07840 
<a name="l07841"></a>07841             <span class="comment">// ------------------------------------</span>
<a name="l07842"></a>07842 
<a name="l07843"></a>07843             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l07844"></a>07844             pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theAccountID);
<a name="l07845"></a>07845 
<a name="l07846"></a>07846             <span class="comment">// ----------------------------------------------------</span>
<a name="l07847"></a>07847             <span class="comment">// Load up the appropriate Inbox... </span>
<a name="l07848"></a>07848             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theInbox(MY_NYM_ID, theAccountID, SERVER_ID);
<a name="l07849"></a>07849 
<a name="l07850"></a>07850             <span class="keywordtype">bool</span> bLoadedInbox   = theInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>();
<a name="l07851"></a>07851 
<a name="l07852"></a>07852             <span class="keywordtype">bool</span> bVerifiedInbox = (bLoadedInbox ? theInbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(theNym) : <span class="keyword">false</span>);
<a name="l07853"></a>07853 
<a name="l07854"></a>07854             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07855"></a>07855             <span class="comment">// (1) Set up member variables </span>
<a name="l07856"></a>07856             <span class="keywordtype">bool</span> bSuccess = (bLoadedInbox &amp;&amp; 
<a name="l07857"></a>07857                 bVerifiedInbox &amp;&amp; 
<a name="l07858"></a>07858                 <a class="code" href="class_o_t_client.html#a8e026d8854d91883c369c486c8355eb7">AcceptEntireInbox</a>(theInbox, SERVER_ID, theServer, theNym, theMessage, *pAccount));
<a name="l07859"></a>07859             <span class="comment">// -----------------        </span>
<a name="l07860"></a>07860 
<a name="l07861"></a>07861             <span class="keywordflow">if</span> (bSuccess)
<a name="l07862"></a>07862             {
<a name="l07863"></a>07863                 <span class="comment">// (2) Sign the Message </span>
<a name="l07864"></a>07864                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07865"></a>07865 
<a name="l07866"></a>07866                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07867"></a>07867                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07868"></a>07868 
<a name="l07869"></a>07869                 bSendCommand = <span class="keyword">true</span>;
<a name="l07870"></a>07870             }
<a name="l07871"></a>07871             <span class="keywordflow">else</span>
<a name="l07872"></a>07872             {
<a name="l07873"></a>07873                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTClient::processEntireInbox: Failure Inbox: Loading (%s), verifying (%s), or accepting (%s) entire Inbox.\n&quot;</span>,
<a name="l07874"></a>07874                     bLoadedInbox ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>, bVerifiedInbox ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>, bSuccess ? <span class="stringliteral">&quot;Success&quot;</span> : <span class="stringliteral">&quot;Failure&quot;</span>);
<a name="l07875"></a>07875             }
<a name="l07876"></a>07876         }
<a name="l07877"></a>07877 
<a name="l07878"></a>07878         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07879"></a>07879         <span class="comment">// This is called by AcceptEntireInbox(). </span>
<a name="l07880"></a>07880         <span class="comment">//</span>
<a name="l07881"></a>07881         <span class="keywordflow">break</span>;
<a name="l07882"></a>07882     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aeccf5cda8c73b68c5771e2ff9b479b97">OTClient::processInbox</a>: <span class="comment">// PROCESS INBOX</span>
<a name="l07883"></a>07883         {
<a name="l07884"></a>07884             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07885"></a>07885 
<a name="l07886"></a>07886             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07887"></a>07887             {
<a name="l07888"></a>07888                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to PROCESS its INBOX): &quot;</span>);
<a name="l07889"></a>07889                 <span class="comment">// User input.</span>
<a name="l07890"></a>07890                 <span class="comment">// I need a from account</span>
<a name="l07891"></a>07891                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07892"></a>07892 
<a name="l07893"></a>07893                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l07894"></a>07894                     <span class="keywordflow">return</span> (-1);
<a name="l07895"></a>07895 
<a name="l07896"></a>07896                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l07897"></a>07897 
<a name="l07898"></a>07898                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l07899"></a>07899                 {
<a name="l07900"></a>07900                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07901"></a>07901                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07902"></a>07902                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07903"></a>07903                 }
<a name="l07904"></a>07904                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l07905"></a>07905                 {
<a name="l07906"></a>07906                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07907"></a>07907                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07908"></a>07908                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07909"></a>07909                 }
<a name="l07910"></a>07910                 <span class="keywordflow">else</span>
<a name="l07911"></a>07911                 {
<a name="l07912"></a>07912                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to process inbox without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l07913"></a>07913                     <span class="keywordflow">return</span> (-1);
<a name="l07914"></a>07914                 }
<a name="l07915"></a>07915             }
<a name="l07916"></a>07916             <span class="keywordflow">else</span>
<a name="l07917"></a>07917             {
<a name="l07918"></a>07918                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l07919"></a>07919                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l07920"></a>07920                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l07921"></a>07921             }
<a name="l07922"></a>07922 
<a name="l07923"></a>07923             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l07924"></a>07924             {
<a name="l07925"></a>07925                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l07926"></a>07926                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l07927"></a>07927                 <span class="keywordflow">return</span> (-1);
<a name="l07928"></a>07928             }
<a name="l07929"></a>07929 
<a name="l07930"></a>07930             <span class="comment">// ------------------------------------</span>
<a name="l07931"></a>07931 
<a name="l07932"></a>07932             <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
<a name="l07933"></a>07933             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l07934"></a>07934 
<a name="l07935"></a>07935             pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theAccountID);
<a name="l07936"></a>07936             theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  
<a name="l07937"></a>07937 
<a name="l07938"></a>07938 
<a name="l07939"></a>07939             <span class="comment">// Normally processInbox command is sent with a transaction ledger</span>
<a name="l07940"></a>07940             <span class="comment">// in the payload, accepting or rejecting various transactions in</span>
<a name="l07941"></a>07941             <span class="comment">// my inbox.</span>
<a name="l07942"></a>07942             <span class="comment">// If pAccount was passed in, that means somewhere else in the code</span>
<a name="l07943"></a>07943             <span class="comment">// a ledger is being added to this message after this point, and it</span>
<a name="l07944"></a>07944             <span class="comment">// is being re-signed and sent out.</span>
<a name="l07945"></a>07945             <span class="comment">// That&#39;s why you don&#39;t see a ledger being constructed and added to</span>
<a name="l07946"></a>07946             <span class="comment">// the payload here. Because it&#39;s being done somewhere else, and that</span>
<a name="l07947"></a>07947             <span class="comment">// same place is what passed the account pointer in here.</span>
<a name="l07948"></a>07948             <span class="comment">// I only put this block here for now because I&#39;d rather have it with</span>
<a name="l07949"></a>07949             <span class="comment">// all the others.</span>
<a name="l07950"></a>07950 
<a name="l07951"></a>07951 
<a name="l07952"></a>07952             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l07953"></a>07953             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l07954"></a>07954             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l07955"></a>07955             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l07956"></a>07956 
<a name="l07957"></a>07957             <span class="comment">// (1) Set up member variables </span>
<a name="l07958"></a>07958             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;processInbox&quot;</span>;
<a name="l07959"></a>07959             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l07960"></a>07960             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l07961"></a>07961             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l07962"></a>07962 
<a name="l07963"></a>07963             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l07964"></a>07964 
<a name="l07965"></a>07965             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l07966"></a>07966             <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07967"></a>07967             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l07968"></a>07968 
<a name="l07969"></a>07969             <span class="keywordflow">if</span> (bNymboxHash)
<a name="l07970"></a>07970                 NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l07971"></a>07971             <span class="keywordflow">else</span>
<a name="l07972"></a>07972                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l07973"></a>07973                 str_server.c_str());
<a name="l07974"></a>07974 
<a name="l07975"></a>07975             <span class="comment">// (2) Sign the Message </span>
<a name="l07976"></a>07976             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l07977"></a>07977 
<a name="l07978"></a>07978             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l07979"></a>07979             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07980"></a>07980 
<a name="l07981"></a>07981             bSendCommand = <span class="keyword">true</span>;
<a name="l07982"></a>07982             lReturnValue = lRequestNumber;        
<a name="l07983"></a>07983         }
<a name="l07984"></a>07984 
<a name="l07985"></a>07985         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l07986"></a>07986 
<a name="l07987"></a>07987 
<a name="l07988"></a>07988         <span class="keywordflow">break</span>;
<a name="l07989"></a>07989     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a83dc60e33659baf6d5ce60c3aa254f06">OTClient::getAccount</a>: <span class="comment">// GET ACCOUNT</span>
<a name="l07990"></a>07990         {   
<a name="l07991"></a>07991             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l07992"></a>07992 
<a name="l07993"></a>07993             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l07994"></a>07994             {
<a name="l07995"></a>07995                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to download its intermediary file): &quot;</span>);
<a name="l07996"></a>07996                 <span class="comment">// User input.</span>
<a name="l07997"></a>07997                 <span class="comment">// I need a from account</span>
<a name="l07998"></a>07998                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l07999"></a>07999 
<a name="l08000"></a>08000                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08001"></a>08001                     <span class="keywordflow">return</span> (-1);
<a name="l08002"></a>08002 
<a name="l08003"></a>08003                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l08004"></a>08004 
<a name="l08005"></a>08005                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l08006"></a>08006                 {
<a name="l08007"></a>08007                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08008"></a>08008                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08009"></a>08009                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08010"></a>08010                 }
<a name="l08011"></a>08011                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l08012"></a>08012                 {
<a name="l08013"></a>08013                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08014"></a>08014                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08015"></a>08015                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08016"></a>08016                 }
<a name="l08017"></a>08017                 <span class="keywordflow">else</span>
<a name="l08018"></a>08018                 {
<a name="l08019"></a>08019                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to download account without account ID. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l08020"></a>08020                     <span class="keywordflow">return</span> (-1);
<a name="l08021"></a>08021                 }
<a name="l08022"></a>08022             }
<a name="l08023"></a>08023             <span class="keywordflow">else</span>
<a name="l08024"></a>08024             {
<a name="l08025"></a>08025                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08026"></a>08026                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08027"></a>08027                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08028"></a>08028             }
<a name="l08029"></a>08029 
<a name="l08030"></a>08030             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l08031"></a>08031             {
<a name="l08032"></a>08032                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l08033"></a>08033                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l08034"></a>08034                 <span class="keywordflow">return</span> (-1);
<a name="l08035"></a>08035             }
<a name="l08036"></a>08036 
<a name="l08037"></a>08037             <span class="comment">// ------------------------------------</span>
<a name="l08038"></a>08038 
<a name="l08039"></a>08039             <a class="code" href="class_o_t_string.html">OTString</a> strAcctID;
<a name="l08040"></a>08040             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAccountID;
<a name="l08041"></a>08041 
<a name="l08042"></a>08042             pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(theAccountID);
<a name="l08043"></a>08043             theAccountID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAcctID);  
<a name="l08044"></a>08044 
<a name="l08045"></a>08045 
<a name="l08046"></a>08046             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08047"></a>08047             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08048"></a>08048             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08049"></a>08049             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08050"></a>08050 
<a name="l08051"></a>08051             <span class="comment">// (1) Set up member variables </span>
<a name="l08052"></a>08052             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getAccount&quot;</span>;
<a name="l08053"></a>08053             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08054"></a>08054             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08055"></a>08055             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08056"></a>08056 
<a name="l08057"></a>08057             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l08058"></a>08058 
<a name="l08059"></a>08059             <span class="comment">// (2) Sign the Message </span>
<a name="l08060"></a>08060             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08061"></a>08061 
<a name="l08062"></a>08062             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08063"></a>08063             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08064"></a>08064 
<a name="l08065"></a>08065             bSendCommand = <span class="keyword">true</span>;
<a name="l08066"></a>08066             lReturnValue = lRequestNumber;        
<a name="l08067"></a>08067         }
<a name="l08068"></a>08068 
<a name="l08069"></a>08069         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l08070"></a>08070 
<a name="l08071"></a>08071 
<a name="l08072"></a>08072         <span class="keywordflow">break</span>;
<a name="l08073"></a>08073     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a5b059c3a4ea9668eeb8fab51ed52926c">OTClient::getContract</a>: <span class="comment">// GET CONTRACT</span>
<a name="l08074"></a>08074         {   
<a name="l08075"></a>08075             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type ID: &quot;</span>);
<a name="l08076"></a>08076             <span class="comment">// User input.</span>
<a name="l08077"></a>08077             <span class="comment">// I need an account</span>
<a name="l08078"></a>08078             <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
<a name="l08079"></a>08079             strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08080"></a>08080 
<a name="l08081"></a>08081             <span class="keywordflow">if</span> (strAssetID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08082"></a>08082                 <span class="keywordflow">return</span> (-1);
<a name="l08083"></a>08083 
<a name="l08084"></a>08084             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08085"></a>08085             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08086"></a>08086             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08087"></a>08087             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08088"></a>08088 
<a name="l08089"></a>08089             <span class="comment">// (1) Set up member variables </span>
<a name="l08090"></a>08090             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getContract&quot;</span>;
<a name="l08091"></a>08091             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08092"></a>08092             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08093"></a>08093             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08094"></a>08094 
<a name="l08095"></a>08095             theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;
<a name="l08096"></a>08096 
<a name="l08097"></a>08097             <span class="comment">// (2) Sign the Message </span>
<a name="l08098"></a>08098             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08099"></a>08099 
<a name="l08100"></a>08100             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08101"></a>08101             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08102"></a>08102 
<a name="l08103"></a>08103             bSendCommand = <span class="keyword">true</span>;
<a name="l08104"></a>08104             lReturnValue = lRequestNumber;        
<a name="l08105"></a>08105         }
<a name="l08106"></a>08106 
<a name="l08107"></a>08107         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l08108"></a>08108 
<a name="l08109"></a>08109 
<a name="l08110"></a>08110         <span class="keywordflow">break</span>;
<a name="l08111"></a>08111     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a4c340c363c96261623287d7bbb988ab4">OTClient::getMint</a>: <span class="comment">// GET MINT</span>
<a name="l08112"></a>08112         {   
<a name="l08113"></a>08113             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset type ID: &quot;</span>);
<a name="l08114"></a>08114             <span class="comment">// User input.</span>
<a name="l08115"></a>08115             <span class="comment">// I need an account</span>
<a name="l08116"></a>08116             <a class="code" href="class_o_t_string.html">OTString</a> strAssetID;
<a name="l08117"></a>08117             strAssetID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08118"></a>08118 
<a name="l08119"></a>08119             <span class="keywordflow">if</span> (strAssetID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08120"></a>08120                 <span class="keywordflow">return</span> (-1);
<a name="l08121"></a>08121 
<a name="l08122"></a>08122             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08123"></a>08123             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08124"></a>08124             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08125"></a>08125             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08126"></a>08126 
<a name="l08127"></a>08127             <span class="comment">// (1) Set up member variables </span>
<a name="l08128"></a>08128             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMint&quot;</span>;
<a name="l08129"></a>08129             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08130"></a>08130             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08131"></a>08131             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08132"></a>08132 
<a name="l08133"></a>08133             theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetID;
<a name="l08134"></a>08134 
<a name="l08135"></a>08135             <span class="comment">// (2) Sign the Message </span>
<a name="l08136"></a>08136             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08137"></a>08137 
<a name="l08138"></a>08138             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08139"></a>08139             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08140"></a>08140 
<a name="l08141"></a>08141             bSendCommand = <span class="keyword">true</span>;
<a name="l08142"></a>08142             lReturnValue = lRequestNumber;        
<a name="l08143"></a>08143         }
<a name="l08144"></a>08144 
<a name="l08145"></a>08145 
<a name="l08146"></a>08146         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l08147"></a>08147 
<a name="l08148"></a>08148 
<a name="l08149"></a>08149 
<a name="l08150"></a>08150         <span class="keywordflow">break</span>;
<a name="l08151"></a>08151     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac0d3b6c44604abdd3b07bab8e69ea602">OTClient::notarizeDeposit</a>: <span class="comment">// NOTARIZE DEPOSIT</span>
<a name="l08152"></a>08152         {   
<a name="l08153"></a>08153             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l08154"></a>08154 
<a name="l08155"></a>08155             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l08156"></a>08156             {
<a name="l08157"></a>08157                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID to deposit your tokens to: &quot;</span>);
<a name="l08158"></a>08158                 <span class="comment">// User input.</span>
<a name="l08159"></a>08159                 <span class="comment">// I need a from account</span>
<a name="l08160"></a>08160                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08161"></a>08161 
<a name="l08162"></a>08162                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08163"></a>08163                     <span class="keywordflow">return</span> (-1);
<a name="l08164"></a>08164 
<a name="l08165"></a>08165                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l08166"></a>08166 
<a name="l08167"></a>08167                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l08168"></a>08168                 {
<a name="l08169"></a>08169                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08170"></a>08170                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08171"></a>08171                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08172"></a>08172                 }
<a name="l08173"></a>08173                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l08174"></a>08174                 {
<a name="l08175"></a>08175                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08176"></a>08176                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08177"></a>08177                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08178"></a>08178                 }
<a name="l08179"></a>08179                 <span class="keywordflow">else</span>
<a name="l08180"></a>08180                 {
<a name="l08181"></a>08181                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit tokens without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l08182"></a>08182                     <span class="keywordflow">return</span> (-1);
<a name="l08183"></a>08183                 }
<a name="l08184"></a>08184             }
<a name="l08185"></a>08185             <span class="keywordflow">else</span>
<a name="l08186"></a>08186             {
<a name="l08187"></a>08187                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08188"></a>08188                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08189"></a>08189                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08190"></a>08190             }
<a name="l08191"></a>08191 
<a name="l08192"></a>08192             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l08193"></a>08193             {
<a name="l08194"></a>08194                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l08195"></a>08195                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l08196"></a>08196                 <span class="keywordflow">return</span> (-1);
<a name="l08197"></a>08197             }
<a name="l08198"></a>08198 
<a name="l08199"></a>08199             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);
<a name="l08200"></a>08200 
<a name="l08201"></a>08201             <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, CONTRACT_ID);
<a name="l08202"></a>08202 
<a name="l08203"></a>08203             <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l08204"></a>08204 
<a name="l08205"></a>08205             int64_t lStoredTransactionNumber=0;
<a name="l08206"></a>08206             <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;
<a name="l08207"></a>08207 
<a name="l08208"></a>08208             <span class="comment">// ---------------------------------------------</span>
<a name="l08209"></a>08209 
<a name="l08210"></a>08210             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l08211"></a>08211             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l08212"></a>08212 
<a name="l08213"></a>08213             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l08214"></a>08214             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l08215"></a>08215 
<a name="l08216"></a>08216             <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l08217"></a>08217             {
<a name="l08218"></a>08218                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l08219"></a>08219                 <span class="keywordflow">break</span>;
<a name="l08220"></a>08220             }
<a name="l08221"></a>08221 
<a name="l08222"></a>08222             <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l08223"></a>08223             {
<a name="l08224"></a>08224                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l08225"></a>08225                 <span class="keywordflow">break</span>;
<a name="l08226"></a>08226             }
<a name="l08227"></a>08227 
<a name="l08228"></a>08228             bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber);
<a name="l08229"></a>08229             <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l08230"></a>08230             {
<a name="l08231"></a>08231                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
<a name="l08232"></a>08232                 <span class="keywordflow">break</span>;
<a name="l08233"></a>08233             }
<a name="l08234"></a>08234 
<a name="l08235"></a>08235             <span class="keywordflow">if</span> (!pServerNym)
<a name="l08236"></a>08236             {
<a name="l08237"></a>08237                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08238"></a>08238                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08239"></a>08239                 <span class="keywordflow">break</span>;
<a name="l08240"></a>08240             }
<a name="l08241"></a>08241 
<a name="l08242"></a>08242             <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l08243"></a>08243 
<a name="l08244"></a>08244             <span class="comment">// Create a transaction</span>
<a name="l08245"></a>08245             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
<a name="l08246"></a>08246                 <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 
<a name="l08247"></a>08247 
<a name="l08248"></a>08248             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l08249"></a>08249             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);
<a name="l08250"></a>08250 
<a name="l08251"></a>08251             <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cash, please!&quot;</span>);
<a name="l08252"></a>08252             pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l08253"></a>08253 
<a name="l08254"></a>08254             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many tokens would you like to deposit? &quot;</span>);
<a name="l08255"></a>08255             <a class="code" href="class_o_t_string.html">OTString</a> strTokenCount;
<a name="l08256"></a>08256             strTokenCount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08257"></a>08257             <span class="keyword">const</span> int32_t nTokenCount = atoi(strTokenCount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08258"></a>08258 
<a name="l08259"></a>08259             <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> theNymAsOwner(theNym), theServerNymAsOwner(*pServerNym);
<a name="l08260"></a>08260 
<a name="l08261"></a>08261             <span class="keywordflow">for</span> (int32_t nTokenIndex = 1; nTokenIndex &lt;= nTokenCount; nTokenIndex++)
<a name="l08262"></a>08262             {
<a name="l08263"></a>08263                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Please enter plaintext token # %d; terminate with ~ on a new line:\n&gt; &quot;</span>, nTokenIndex);
<a name="l08264"></a>08264                 <a class="code" href="class_o_t_string.html">OTString</a> strToken;
<a name="l08265"></a>08265                 <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>
<a name="l08266"></a>08266 
<a name="l08267"></a>08267                 <span class="keywordflow">do</span> {
<a name="l08268"></a>08268                     decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>
<a name="l08269"></a>08269 
<a name="l08270"></a>08270                     <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
<a name="l08271"></a>08271                         (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l08272"></a>08272                     {
<a name="l08273"></a>08273                         strToken.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l08274"></a>08274                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l08275"></a>08275                     }
<a name="l08276"></a>08276                     <span class="keywordflow">else</span> 
<a name="l08277"></a>08277                     {
<a name="l08278"></a>08278                         <span class="keywordflow">break</span>;
<a name="l08279"></a>08279                     }
<a name="l08280"></a>08280 
<a name="l08281"></a>08281                 } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l08282"></a>08282 
<a name="l08283"></a>08283                 <span class="comment">// Create the relevant token request with same server/asset ID as the purse.</span>
<a name="l08284"></a>08284                 <span class="comment">// the purse does NOT own the token at this point. the token&#39;s constructor</span>
<a name="l08285"></a>08285                 <span class="comment">// just uses it to copy some IDs, since they must match.</span>
<a name="l08286"></a>08286                 <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ac758de04ed60991098005a7ac9578d71">OTToken::TokenFactory</a>(strToken, thePurse);
<a name="l08287"></a>08287                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l08288"></a>08288                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);
<a name="l08289"></a>08289 
<a name="l08290"></a>08290                 <span class="keywordflow">if</span> (NULL != pToken) <span class="comment">// TODO verify the token contract</span>
<a name="l08291"></a>08291                 {
<a name="l08292"></a>08292                     <span class="comment">// TODO need 2-recipient envelopes. My request to the server is encrypted to the server&#39;s nym,</span>
<a name="l08293"></a>08293                     <span class="comment">// but it should be encrypted to my Nym also, so both have access to decrypt it.</span>
<a name="l08294"></a>08294 
<a name="l08295"></a>08295                     <span class="comment">// Now the token is ready, let&#39;s add it to a purse</span>
<a name="l08296"></a>08296                     <span class="comment">// By pushing pToken into thePurse with *pServerNym, I encrypt it to pServerNym.</span>
<a name="l08297"></a>08297                     <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
<a name="l08298"></a>08298                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(theNymAsOwner, theServerNymAsOwner))
<a name="l08299"></a>08299                     {
<a name="l08300"></a>08300                         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l08301"></a>08301                         bSuccess = <span class="keyword">false</span>;
<a name="l08302"></a>08302                         <span class="keywordflow">break</span>;
<a name="l08303"></a>08303                     }
<a name="l08304"></a>08304                     <span class="keywordflow">else</span> 
<a name="l08305"></a>08305                     {
<a name="l08306"></a>08306                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Success re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l08307"></a>08307 
<a name="l08308"></a>08308                         bSuccess = <span class="keyword">true</span>;
<a name="l08309"></a>08309 
<a name="l08310"></a>08310                         pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08311"></a>08311                         pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08312"></a>08312                         pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08313"></a>08313 
<a name="l08314"></a>08314                         thePurse.<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(theServerNymAsOwner, *pToken);
<a name="l08315"></a>08315 
<a name="l08316"></a>08316                         int64_t lTemp = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l08317"></a>08317                         pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTemp + pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>());
<a name="l08318"></a>08318                     }
<a name="l08319"></a>08319                 }
<a name="l08320"></a>08320                 <span class="keywordflow">else</span> 
<a name="l08321"></a>08321                 {
<a name="l08322"></a>08322                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading token from string.\n&quot;</span>);
<a name="l08323"></a>08323                 }
<a name="l08324"></a>08324             } <span class="comment">// for</span>
<a name="l08325"></a>08325 
<a name="l08326"></a>08326             <span class="keywordflow">if</span> (bSuccess)
<a name="l08327"></a>08327             {
<a name="l08328"></a>08328                 thePurse.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08329"></a>08329                 thePurse.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// I think this one is unnecessary.</span>
<a name="l08330"></a>08330 
<a name="l08331"></a>08331                 <span class="comment">// Save the purse into a string...</span>
<a name="l08332"></a>08332                 <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
<a name="l08333"></a>08333                 thePurse.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);
<a name="l08334"></a>08334 
<a name="l08335"></a>08335                 <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
<a name="l08336"></a>08336                 pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>
<a name="l08337"></a>08337 
<a name="l08338"></a>08338                 <span class="comment">// sign the item</span>
<a name="l08339"></a>08339                 pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08340"></a>08340                 pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08341"></a>08341 
<a name="l08342"></a>08342                 <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l08343"></a>08343                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l08344"></a>08344 
<a name="l08345"></a>08345                 <span class="comment">// ---------------------------------------------</span>
<a name="l08346"></a>08346                 <span class="comment">// BALANCE AGREEMENT</span>
<a name="l08347"></a>08347 
<a name="l08348"></a>08348                 <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l08349"></a>08349                 <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), *pTransaction, theNym, *pAccount, *pOutbox);
<a name="l08350"></a>08350 
<a name="l08351"></a>08351                 <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l08352"></a>08352                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l08353"></a>08353 
<a name="l08354"></a>08354                 <span class="comment">// ---------------------------------------------</span>
<a name="l08355"></a>08355 
<a name="l08356"></a>08356                 <span class="comment">// sign the transaction</span>
<a name="l08357"></a>08357                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08358"></a>08358                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08359"></a>08359 
<a name="l08360"></a>08360                 <span class="comment">// set up the ledger</span>
<a name="l08361"></a>08361                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
<a name="l08362"></a>08362                 theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l08363"></a>08363                 theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l08364"></a>08364 
<a name="l08365"></a>08365                 <span class="comment">// sign the ledger</span>
<a name="l08366"></a>08366                 theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08367"></a>08367                 theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08368"></a>08368 
<a name="l08369"></a>08369                 <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l08370"></a>08370                 <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l08371"></a>08371                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger); <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l08372"></a>08372 
<a name="l08373"></a>08373                 <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08374"></a>08374                 theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l08375"></a>08375                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08376"></a>08376                 theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08377"></a>08377 
<a name="l08378"></a>08378                 <span class="comment">// (1) Set up member variables </span>
<a name="l08379"></a>08379                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l08380"></a>08380                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08381"></a>08381                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08382"></a>08382                 theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08383"></a>08383 
<a name="l08384"></a>08384                 theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l08385"></a>08385                 theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l08386"></a>08386 
<a name="l08387"></a>08387                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l08388"></a>08388                 <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08389"></a>08389                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l08390"></a>08390 
<a name="l08391"></a>08391                 <span class="keywordflow">if</span> (bNymboxHash)
<a name="l08392"></a>08392                     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l08393"></a>08393                 <span class="keywordflow">else</span>
<a name="l08394"></a>08394                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l08395"></a>08395                     str_server.c_str());
<a name="l08396"></a>08396 
<a name="l08397"></a>08397                 <span class="comment">// (2) Sign the Message </span>
<a name="l08398"></a>08398                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08399"></a>08399 
<a name="l08400"></a>08400                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08401"></a>08401                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08402"></a>08402 
<a name="l08403"></a>08403                 bSendCommand = <span class="keyword">true</span>;
<a name="l08404"></a>08404                 lReturnValue = lRequestNumber;
<a name="l08405"></a>08405 
<a name="l08406"></a>08406             } <span class="comment">// bSuccess</span>
<a name="l08407"></a>08407             <span class="keywordflow">else</span> 
<a name="l08408"></a>08408             {
<a name="l08409"></a>08409                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08410"></a>08410                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                                </span>
<a name="l08411"></a>08411 
<a name="l08412"></a>08412                 <span class="keyword">delete</span> pItem;       pItem = NULL;
<a name="l08413"></a>08413                 <span class="keyword">delete</span> pTransaction;pTransaction = NULL;
<a name="l08414"></a>08414             }           
<a name="l08415"></a>08415         }
<a name="l08416"></a>08416 
<a name="l08417"></a>08417         <span class="keywordflow">break</span>;
<a name="l08418"></a>08418     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a9f04f3ee9323ef6ab4319c78a6139506">OTClient::notarizePurse</a>: <span class="comment">// NOTARIZE PURSE (deposit)</span>
<a name="l08419"></a>08419         {
<a name="l08420"></a>08420             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l08421"></a>08421 
<a name="l08422"></a>08422             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l08423"></a>08423             {
<a name="l08424"></a>08424                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID: &quot;</span>);
<a name="l08425"></a>08425                 <span class="comment">// User input.</span>
<a name="l08426"></a>08426                 <span class="comment">// I need a from account</span>
<a name="l08427"></a>08427                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08428"></a>08428 
<a name="l08429"></a>08429                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08430"></a>08430                     <span class="keywordflow">return</span> (-1);
<a name="l08431"></a>08431 
<a name="l08432"></a>08432                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l08433"></a>08433 
<a name="l08434"></a>08434                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l08435"></a>08435                 {
<a name="l08436"></a>08436                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08437"></a>08437                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08438"></a>08438                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08439"></a>08439                 }
<a name="l08440"></a>08440                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l08441"></a>08441                 {
<a name="l08442"></a>08442                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08443"></a>08443                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08444"></a>08444                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08445"></a>08445                 }
<a name="l08446"></a>08446                 <span class="keywordflow">else</span>
<a name="l08447"></a>08447                 {
<a name="l08448"></a>08448                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l08449"></a>08449                     <span class="keywordflow">return</span> (-1);
<a name="l08450"></a>08450                 }
<a name="l08451"></a>08451             }
<a name="l08452"></a>08452             <span class="keywordflow">else</span>
<a name="l08453"></a>08453             {
<a name="l08454"></a>08454                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08455"></a>08455                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08456"></a>08456                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08457"></a>08457             }
<a name="l08458"></a>08458 
<a name="l08459"></a>08459             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l08460"></a>08460             {
<a name="l08461"></a>08461                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l08462"></a>08462                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l08463"></a>08463                 <span class="keywordflow">return</span> (-1);
<a name="l08464"></a>08464             }
<a name="l08465"></a>08465 
<a name="l08466"></a>08466             <span class="comment">// ---------------------------------------------------------</span>
<a name="l08467"></a>08467             <span class="comment">//</span>
<a name="l08468"></a>08468             <span class="comment">// &quot;from acct&quot; is the acct we are depositing this cash to. aka MyAcct.</span>
<a name="l08469"></a>08469             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);
<a name="l08470"></a>08470 
<a name="l08471"></a>08471             <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, CONTRACT_ID);
<a name="l08472"></a>08472 
<a name="l08473"></a>08473             <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l08474"></a>08474 
<a name="l08475"></a>08475             <span class="comment">// ---------------------------------------------</span>
<a name="l08476"></a>08476 
<a name="l08477"></a>08477             <a class="code" href="class_o_t_purse.html">OTPurse</a> theSourcePurse(thePurse);
<a name="l08478"></a>08478 
<a name="l08479"></a>08479             <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID;
<a name="l08480"></a>08480 
<a name="l08481"></a>08481             <span class="keywordtype">bool</span> bUseThePurseInStorage = <span class="keyword">false</span>; <span class="comment">// deposit the purse stored in local storage, versus one supplied on stdin.</span>
<a name="l08482"></a>08482 
<a name="l08483"></a>08483             <span class="comment">// If no asset contract was passed in, then --mypurse was not specified. Therefore,</span>
<a name="l08484"></a>08484             <span class="comment">// we can get the purse from the user, and verify that it has the same asset type ID</span>
<a name="l08485"></a>08485             <span class="comment">// as pAccount does. (No need to ask for the type.)</span>
<a name="l08486"></a>08486             <span class="comment">//</span>
<a name="l08487"></a>08487             <span class="comment">// But if an asset contract WAS passed in, then we will assume (for now) that the purse</span>
<a name="l08488"></a>08488             <span class="comment">// from local storage will be used, of that same type, and thus no need to ask for the type.</span>
<a name="l08489"></a>08489             <span class="comment">//</span>
<a name="l08490"></a>08490             <span class="keywordflow">if</span> (NULL == pMyAssetContract)
<a name="l08491"></a>08491             {
<a name="l08492"></a>08492                 bUseThePurseInStorage = <span class="keyword">false</span>;
<a name="l08493"></a>08493                 <a class="code" href="class_o_t_string.html">OTString</a> strSourcePurse;
<a name="l08494"></a>08494 
<a name="l08495"></a>08495                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter a plaintext purse (of the same asset type as the account), \n&quot;</span>
<a name="l08496"></a>08496                     <span class="stringliteral">&quot;and terminate with a ~ (tilde character) on a new line:\n&gt; &quot;</span>);
<a name="l08497"></a>08497                 <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>
<a name="l08498"></a>08498 
<a name="l08499"></a>08499                 <span class="keywordflow">do</span> {
<a name="l08500"></a>08500                     decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>
<a name="l08501"></a>08501 
<a name="l08502"></a>08502                     <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
<a name="l08503"></a>08503                         (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l08504"></a>08504                     {
<a name="l08505"></a>08505                         strSourcePurse.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l08506"></a>08506                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l08507"></a>08507                     }
<a name="l08508"></a>08508                     <span class="keywordflow">else</span> 
<a name="l08509"></a>08509                     {
<a name="l08510"></a>08510                         <span class="keywordflow">break</span>;
<a name="l08511"></a>08511                     }
<a name="l08512"></a>08512 
<a name="l08513"></a>08513                 } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l08514"></a>08514 
<a name="l08515"></a>08515                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == theSourcePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strSourcePurse))
<a name="l08516"></a>08516                 {
<a name="l08517"></a>08517                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failure trying to load purse from string provided by user.\n&quot;</span>);
<a name="l08518"></a>08518                     <span class="keywordflow">return</span> (-1);
<a name="l08519"></a>08519                 }
<a name="l08520"></a>08520 
<a name="l08521"></a>08521                 <span class="comment">// todo verify signature?</span>
<a name="l08522"></a>08522 
<a name="l08523"></a>08523                 theSourcePurse.<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>().<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAssetTypeID);
<a name="l08524"></a>08524             }
<a name="l08525"></a>08525             <span class="keywordflow">else</span>
<a name="l08526"></a>08526             {
<a name="l08527"></a>08527                 bUseThePurseInStorage = <span class="keyword">true</span>;
<a name="l08528"></a>08528                 pMyAssetContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strAssetTypeID);
<a name="l08529"></a>08529 
<a name="l08530"></a>08530                 <span class="keywordtype">bool</span> bLoadedSourcePurse = theSourcePurse.<a class="code" href="class_o_t_purse.html#a6cda4ea82f97fab7719242c0827846f7">LoadPurse</a>(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08531"></a>08531 
<a name="l08532"></a>08532                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedSourcePurse)
<a name="l08533"></a>08533                 {
<a name="l08534"></a>08534                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Deposit purse: Failure trying to load purse from local storage:\n&quot;</span>
<a name="l08535"></a>08535                         <span class="stringliteral">&quot;Server %s  Nym %s  Asset Type %s\n&quot;</span>,
<a name="l08536"></a>08536                         strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08537"></a>08537                     <span class="keywordflow">return</span> (-1);
<a name="l08538"></a>08538                 }
<a name="l08539"></a>08539                 <span class="keywordflow">else</span>
<a name="l08540"></a>08540                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;WARNING: This operation is very low-level. Once you deposit the purse in local storage,\n&quot;</span>
<a name="l08541"></a>08541                     <span class="stringliteral">&quot;you need to erase the purse file from local storage, since the tokens within it are\n&quot;</span>
<a name="l08542"></a>08542                     <span class="stringliteral">&quot;all spent. (Otherwise, when you withdraw again, good tokens would be mixed in with\n&quot;</span>
<a name="l08543"></a>08543                     <span class="stringliteral">&quot;the spent ones, and then you&#39;ll have to sit there depositing them one-by-one, in order\n&quot;</span>
<a name="l08544"></a>08544                     <span class="stringliteral">&quot;to sort it all out.\n (So just use the GUI and save yourself the trouble.)\n\n&quot;</span>
<a name="l08545"></a>08545                     <span class="stringliteral">&quot;Deposit purse: using purse from local storage.\n Server %s  Nym %s  Asset Type %s\n&quot;</span>,
<a name="l08546"></a>08546                     strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08547"></a>08547 
<a name="l08548"></a>08548                 theSourcePurse.<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>().<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strAssetTypeID);
<a name="l08549"></a>08549             }
<a name="l08550"></a>08550 
<a name="l08551"></a>08551             <span class="comment">// By this point, theSourcePurse is DEFINITELY good,</span>
<a name="l08552"></a>08552             <span class="comment">// and strAssetTypeID contains its ID. </span>
<a name="l08553"></a>08553             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ASSET_TYPE_ID(strAssetTypeID);
<a name="l08554"></a>08554 
<a name="l08555"></a>08555             <span class="keywordflow">if</span> (ASSET_TYPE_ID != CONTRACT_ID)
<a name="l08556"></a>08556             {
<a name="l08557"></a>08557                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Asset ID on purse didn&#39;t match asset ID on account. \n&quot;</span>
<a name="l08558"></a>08558                     <span class="stringliteral">&quot;Try: --myacct ACCT_ID  (to specify a different account.)\n&quot;</span>
<a name="l08559"></a>08559                     <span class="stringliteral">&quot;To use the purse in local storage, try:  --mypurse ASSET_TYPE_ID\n&quot;</span>
<a name="l08560"></a>08560                     <span class="stringliteral">&quot;FYI, if you PREFER to provide the purse from user input, OT *will* ask you to\n&quot;</span>
<a name="l08561"></a>08561                     <span class="stringliteral">&quot;input a purse when doing this, just as long as --mypurse is NOT provided. (And\n&quot;</span>
<a name="l08562"></a>08562                     <span class="stringliteral">&quot;that includes the defaultmypurse value stored in ~/.ot/command-line-ot.opt)\n\n&quot;</span>);
<a name="l08563"></a>08563                 <span class="keywordflow">return</span> (-1);
<a name="l08564"></a>08564             }
<a name="l08565"></a>08565 
<a name="l08566"></a>08566             <span class="comment">// By this point, I have theSourcePurse loaded, whether from local storage or from </span>
<a name="l08567"></a>08567             <span class="comment">// the command-line, and I know that it has the same asset type as pAccount.</span>
<a name="l08568"></a>08568             <span class="comment">//</span>
<a name="l08569"></a>08569             <span class="comment">// ----------------------------------------------------------</span>
<a name="l08570"></a>08570 
<a name="l08571"></a>08571             int64_t lStoredTransactionNumber=0;
<a name="l08572"></a>08572             <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;
<a name="l08573"></a>08573 
<a name="l08574"></a>08574             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l08575"></a>08575             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l08576"></a>08576 
<a name="l08577"></a>08577             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l08578"></a>08578             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l08579"></a>08579 
<a name="l08580"></a>08580             <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l08581"></a>08581             {
<a name="l08582"></a>08582                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l08583"></a>08583                 <span class="keywordflow">break</span>;
<a name="l08584"></a>08584             }
<a name="l08585"></a>08585 
<a name="l08586"></a>08586             <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l08587"></a>08587             {
<a name="l08588"></a>08588                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l08589"></a>08589                 <span class="keywordflow">break</span>;
<a name="l08590"></a>08590             }
<a name="l08591"></a>08591 
<a name="l08592"></a>08592             bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber);
<a name="l08593"></a>08593             <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l08594"></a>08594             {
<a name="l08595"></a>08595                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
<a name="l08596"></a>08596                 <span class="keywordflow">break</span>;
<a name="l08597"></a>08597             }
<a name="l08598"></a>08598 
<a name="l08599"></a>08599             <span class="keywordflow">if</span> (!pServerNym)
<a name="l08600"></a>08600             {
<a name="l08601"></a>08601                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08602"></a>08602                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08603"></a>08603                 <span class="keywordflow">break</span>;
<a name="l08604"></a>08604             }
<a name="l08605"></a>08605 
<a name="l08606"></a>08606             <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l08607"></a>08607 
<a name="l08608"></a>08608             <span class="comment">// Create a transaction</span>
<a name="l08609"></a>08609             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
<a name="l08610"></a>08610                 <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 
<a name="l08611"></a>08611 
<a name="l08612"></a>08612             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l08613"></a>08613             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);
<a name="l08614"></a>08614 
<a name="l08615"></a>08615             <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cash, please!&quot;</span>);
<a name="l08616"></a>08616             pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l08617"></a>08617 
<a name="l08618"></a>08618             <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> theNymAsOwner(theNym), theServerNymAsOwner(*pServerNym);
<a name="l08619"></a>08619 
<a name="l08620"></a>08620             <span class="keywordflow">while</span> (!theSourcePurse.<a class="code" href="class_o_t_purse.html#ad8e03aa9b3d80b7e3bc927db699cafe5">IsEmpty</a>()) 
<a name="l08621"></a>08621             {
<a name="l08622"></a>08622                 <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = theSourcePurse.<a class="code" href="class_o_t_purse.html#a84b70b093c79a796815d9a42c8d3bd74">Pop</a>(theNym);
<a name="l08623"></a>08623                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l08624"></a>08624 
<a name="l08625"></a>08625                 <span class="keywordflow">if</span> (pToken)
<a name="l08626"></a>08626                 {
<a name="l08627"></a>08627                     <span class="comment">// TODO need 2-recipient envelopes. My request to the server is encrypted to the server&#39;s nym,</span>
<a name="l08628"></a>08628                     <span class="comment">// but it should be encrypted to my Nym also, so both have access to decrypt it.</span>
<a name="l08629"></a>08629                     <span class="comment">// TODO: AHH OR I could just put a copy of everything into a SINGLE-recipient envelope made out to ME!!</span>
<a name="l08630"></a>08630                     <span class="comment">//</span>
<a name="l08631"></a>08631 
<a name="l08632"></a>08632                     <span class="comment">// Now the token is ready, let&#39;s add it to a purse</span>
<a name="l08633"></a>08633                     <span class="comment">// By pushing theToken into thePurse with *pServerNym, I encrypt it to pServerNym.</span>
<a name="l08634"></a>08634                     <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
<a name="l08635"></a>08635                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(theNymAsOwner, theServerNymAsOwner))
<a name="l08636"></a>08636                     {
<a name="l08637"></a>08637                         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l08638"></a>08638                         bSuccess = <span class="keyword">false</span>;
<a name="l08639"></a>08639                         <span class="keywordflow">break</span>;
<a name="l08640"></a>08640                     }
<a name="l08641"></a>08641                     <span class="keywordflow">else</span> 
<a name="l08642"></a>08642                     {
<a name="l08643"></a>08643                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;Success re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l08644"></a>08644 
<a name="l08645"></a>08645                         bSuccess = <span class="keyword">true</span>;
<a name="l08646"></a>08646 
<a name="l08647"></a>08647                         pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08648"></a>08648                         pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08649"></a>08649                         pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08650"></a>08650 
<a name="l08651"></a>08651                         thePurse.<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(theServerNymAsOwner, *pToken); <span class="comment">// &lt;================</span>
<a name="l08652"></a>08652 
<a name="l08653"></a>08653                         int64_t lTemp = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l08654"></a>08654                         pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTemp + pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>()); <span class="comment">// &lt;==================</span>
<a name="l08655"></a>08655                     }
<a name="l08656"></a>08656                 }
<a name="l08657"></a>08657                 <span class="keywordflow">else</span> 
<a name="l08658"></a>08658                 {
<a name="l08659"></a>08659                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading token from purse.\n&quot;</span>);
<a name="l08660"></a>08660                     bSuccess = <span class="keyword">false</span>;
<a name="l08661"></a>08661                     <span class="keywordflow">break</span>;
<a name="l08662"></a>08662                 }
<a name="l08663"></a>08663             }
<a name="l08664"></a>08664 
<a name="l08665"></a>08665             <span class="keywordflow">if</span> (bSuccess)
<a name="l08666"></a>08666             {
<a name="l08667"></a>08667                 thePurse.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08668"></a>08668                 thePurse.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// I think this one is unnecessary. UPDATE: WRONG. It&#39;s necessary.</span>
<a name="l08669"></a>08669 
<a name="l08670"></a>08670                 <span class="comment">// Save the purse into a string...</span>
<a name="l08671"></a>08671                 <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
<a name="l08672"></a>08672                 thePurse.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);
<a name="l08673"></a>08673 
<a name="l08674"></a>08674                 <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
<a name="l08675"></a>08675                 pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>
<a name="l08676"></a>08676 
<a name="l08677"></a>08677                 <span class="comment">// sign the item</span>
<a name="l08678"></a>08678                 pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08679"></a>08679                 pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08680"></a>08680 
<a name="l08681"></a>08681                 <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l08682"></a>08682                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l08683"></a>08683 
<a name="l08684"></a>08684                 <span class="comment">// ---------------------------------------------</span>
<a name="l08685"></a>08685                 <span class="comment">// BALANCE AGREEMENT</span>
<a name="l08686"></a>08686 
<a name="l08687"></a>08687                 <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l08688"></a>08688                 <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), *pTransaction, theNym, *pAccount, *pOutbox);
<a name="l08689"></a>08689 
<a name="l08690"></a>08690                 <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l08691"></a>08691                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l08692"></a>08692 
<a name="l08693"></a>08693                 <span class="comment">// ---------------------------------------------</span>
<a name="l08694"></a>08694 
<a name="l08695"></a>08695                 <span class="comment">// sign the transaction</span>
<a name="l08696"></a>08696                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08697"></a>08697                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08698"></a>08698 
<a name="l08699"></a>08699                 <span class="comment">// set up the ledger</span>
<a name="l08700"></a>08700                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
<a name="l08701"></a>08701                 theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l08702"></a>08702                 theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l08703"></a>08703 
<a name="l08704"></a>08704                 <span class="comment">// sign the ledger</span>
<a name="l08705"></a>08705                 theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08706"></a>08706                 theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08707"></a>08707 
<a name="l08708"></a>08708                 <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l08709"></a>08709                 <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l08710"></a>08710                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger); <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l08711"></a>08711 
<a name="l08712"></a>08712                 <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08713"></a>08713                 theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l08714"></a>08714                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08715"></a>08715                 theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08716"></a>08716 
<a name="l08717"></a>08717                 <span class="comment">// (1) Set up member variables </span>
<a name="l08718"></a>08718                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l08719"></a>08719                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08720"></a>08720                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08721"></a>08721                 theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08722"></a>08722 
<a name="l08723"></a>08723                 theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l08724"></a>08724                 theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l08725"></a>08725 
<a name="l08726"></a>08726                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l08727"></a>08727                 <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08728"></a>08728                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l08729"></a>08729 
<a name="l08730"></a>08730                 <span class="keywordflow">if</span> (bNymboxHash)
<a name="l08731"></a>08731                     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l08732"></a>08732                 <span class="keywordflow">else</span>
<a name="l08733"></a>08733                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l08734"></a>08734                     str_server.c_str());
<a name="l08735"></a>08735 
<a name="l08736"></a>08736                 <span class="comment">// (2) Sign the Message </span>
<a name="l08737"></a>08737                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08738"></a>08738 
<a name="l08739"></a>08739                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08740"></a>08740                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08741"></a>08741 
<a name="l08742"></a>08742                 bSendCommand = <span class="keyword">true</span>;
<a name="l08743"></a>08743                 lReturnValue = lRequestNumber;                
<a name="l08744"></a>08744             } <span class="comment">// bSuccess</span>
<a name="l08745"></a>08745             <span class="keywordflow">else</span> 
<a name="l08746"></a>08746             {
<a name="l08747"></a>08747                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08748"></a>08748                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>
<a name="l08749"></a>08749 
<a name="l08750"></a>08750                 <span class="keyword">delete</span> pItem;       pItem = NULL;
<a name="l08751"></a>08751                 <span class="keyword">delete</span> pTransaction;pTransaction = NULL;
<a name="l08752"></a>08752             }
<a name="l08753"></a>08753         } <span class="comment">// else if (OTClient::notarizePurse == requestedCommand) // NOTARIZE PURSE</span>
<a name="l08754"></a>08754 
<a name="l08755"></a>08755         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l08756"></a>08756 
<a name="l08757"></a>08757 
<a name="l08758"></a>08758         <span class="keywordflow">break</span>;
<a name="l08759"></a>08759     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a393f2048b156f634595bd6d628c80209">OTClient::notarizeCheque</a>: <span class="comment">// DEPOSIT CHEQUE</span>
<a name="l08760"></a>08760         {   
<a name="l08761"></a>08761             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l08762"></a>08762 
<a name="l08763"></a>08763             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l08764"></a>08764             {
<a name="l08765"></a>08765                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an asset Account ID (to deposit to): &quot;</span>);
<a name="l08766"></a>08766                 <span class="comment">// User input.</span>
<a name="l08767"></a>08767                 <span class="comment">// I need a from account</span>
<a name="l08768"></a>08768                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08769"></a>08769 
<a name="l08770"></a>08770                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08771"></a>08771                     <span class="keywordflow">return</span> (-1);
<a name="l08772"></a>08772 
<a name="l08773"></a>08773                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l08774"></a>08774 
<a name="l08775"></a>08775                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l08776"></a>08776                 {
<a name="l08777"></a>08777                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08778"></a>08778                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08779"></a>08779                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08780"></a>08780                 }
<a name="l08781"></a>08781                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l08782"></a>08782                 {
<a name="l08783"></a>08783                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08784"></a>08784                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08785"></a>08785                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08786"></a>08786                 }
<a name="l08787"></a>08787                 <span class="keywordflow">else</span>
<a name="l08788"></a>08788                 {
<a name="l08789"></a>08789                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to deposit without an account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l08790"></a>08790                     <span class="keywordflow">return</span> (-1);
<a name="l08791"></a>08791                 }
<a name="l08792"></a>08792             }
<a name="l08793"></a>08793             <span class="keywordflow">else</span>
<a name="l08794"></a>08794             {
<a name="l08795"></a>08795                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08796"></a>08796                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08797"></a>08797                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08798"></a>08798             }
<a name="l08799"></a>08799 
<a name="l08800"></a>08800             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l08801"></a>08801             {
<a name="l08802"></a>08802                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l08803"></a>08803                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l08804"></a>08804                 <span class="keywordflow">return</span> (-1);
<a name="l08805"></a>08805             }
<a name="l08806"></a>08806 
<a name="l08807"></a>08807             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);
<a name="l08808"></a>08808 
<a name="l08809"></a>08809             <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(SERVER_ID, CONTRACT_ID);
<a name="l08810"></a>08810 
<a name="l08811"></a>08811             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext cheque, terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l08812"></a>08812             <a class="code" href="class_o_t_string.html">OTString</a> strCheque;
<a name="l08813"></a>08813             <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer) - 1</span>
<a name="l08814"></a>08814 
<a name="l08815"></a>08815             <span class="keywordflow">do</span> {
<a name="l08816"></a>08816                 decode_buffer[0] = 0; <span class="comment">// Make sure it&#39;s starting out fresh.</span>
<a name="l08817"></a>08817 
<a name="l08818"></a>08818                 <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer) - 1, stdin)) &amp;&amp; 
<a name="l08819"></a>08819                     (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l08820"></a>08820                 {
<a name="l08821"></a>08821                     strCheque.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l08822"></a>08822                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l08823"></a>08823                 }
<a name="l08824"></a>08824                 <span class="keywordflow">else</span> 
<a name="l08825"></a>08825                 {
<a name="l08826"></a>08826                     <span class="keywordflow">break</span>;
<a name="l08827"></a>08827                 }
<a name="l08828"></a>08828 
<a name="l08829"></a>08829             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l08830"></a>08830 
<a name="l08831"></a>08831             int64_t lStoredTransactionNumber=0;
<a name="l08832"></a>08832             <span class="keywordtype">bool</span> bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber);
<a name="l08833"></a>08833 
<a name="l08834"></a>08834             <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l08835"></a>08835             {
<a name="l08836"></a>08836                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Try requesting the server for a new one.\n&quot;</span>);
<a name="l08837"></a>08837             }
<a name="l08838"></a>08838             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strCheque))
<a name="l08839"></a>08839             {
<a name="l08840"></a>08840                 <span class="keywordflow">if</span> (theCheque.<a class="code" href="class_o_t_cheque.html#abcc7ebe7be1754456681a25a012040ee">HasRecipient</a>() &amp;&amp; (theCheque.<a class="code" href="class_o_t_cheque.html#a2628b445784aa1f6cdea370acca92077">GetRecipientUserID</a>() != USER_ID))
<a name="l08841"></a>08841                 {
<a name="l08842"></a>08842                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym(theCheque.<a class="code" href="class_o_t_cheque.html#a2628b445784aa1f6cdea370acca92077">GetRecipientUserID</a>());
<a name="l08843"></a>08843                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;This cheque is made out to the Nym: %s (and that is NOT you, so you can&#39;t deposit it!)\n You are: %s \n&quot;</span>,
<a name="l08844"></a>08844                         strRecipientNym.Get(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08845"></a>08845                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08846"></a>08846                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08847"></a>08847                 }
<a name="l08848"></a>08848                 <span class="keywordflow">else</span> <span class="comment">// the cheque is blank, or is made out to me.</span>
<a name="l08849"></a>08849                 {
<a name="l08850"></a>08850                     <span class="comment">// Create a transaction</span>
<a name="l08851"></a>08851                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
<a name="l08852"></a>08852                         <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber); 
<a name="l08853"></a>08853 
<a name="l08854"></a>08854                     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l08855"></a>08855                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>);
<a name="l08856"></a>08856 
<a name="l08857"></a>08857                     <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Deposit this cheque, please!&quot;</span>);
<a name="l08858"></a>08858                     pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l08859"></a>08859 
<a name="l08860"></a>08860                     strCheque.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l08861"></a>08861                     theCheque.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strCheque);
<a name="l08862"></a>08862 
<a name="l08863"></a>08863                     <span class="comment">// Add the cheque string as the attachment on the transaction item.</span>
<a name="l08864"></a>08864                     pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strCheque); <span class="comment">// The cheque is contained in the reference string.</span>
<a name="l08865"></a>08865 
<a name="l08866"></a>08866                     <span class="comment">// sign the item</span>
<a name="l08867"></a>08867                     pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08868"></a>08868                     pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08869"></a>08869 
<a name="l08870"></a>08870                     <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l08871"></a>08871                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l08872"></a>08872 
<a name="l08873"></a>08873                     <span class="comment">// ---------------------------------------------</span>
<a name="l08874"></a>08874 
<a name="l08875"></a>08875                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l08876"></a>08876                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l08877"></a>08877 
<a name="l08878"></a>08878                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l08879"></a>08879                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l08880"></a>08880 
<a name="l08881"></a>08881                     <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l08882"></a>08882                     {
<a name="l08883"></a>08883                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l08884"></a>08884 
<a name="l08885"></a>08885                         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08886"></a>08886                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>
<a name="l08887"></a>08887                     }
<a name="l08888"></a>08888                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l08889"></a>08889                     {
<a name="l08890"></a>08890                         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l08891"></a>08891 
<a name="l08892"></a>08892                         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08893"></a>08893                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                </span>
<a name="l08894"></a>08894                     }
<a name="l08895"></a>08895                     <span class="keywordflow">else</span> 
<a name="l08896"></a>08896                     {
<a name="l08897"></a>08897                         <span class="comment">// BALANCE AGREEMENT </span>
<a name="l08898"></a>08898                         <span class="comment">// ---------------------------------------------</span>
<a name="l08899"></a>08899 
<a name="l08900"></a>08900                         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l08901"></a>08901                         <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(theCheque.<a class="code" href="class_o_t_cheque.html#a84e570d654f20e69f64f0037b96b7c7e">GetAmount</a>(), *pTransaction, theNym, *pAccount, *pOutbox);
<a name="l08902"></a>08902 
<a name="l08903"></a>08903                         <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l08904"></a>08904                             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l08905"></a>08905 
<a name="l08906"></a>08906                         <span class="comment">// ---------------------------------------------</span>
<a name="l08907"></a>08907 
<a name="l08908"></a>08908                         <span class="comment">// sign the transaction</span>
<a name="l08909"></a>08909                         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08910"></a>08910                         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08911"></a>08911 
<a name="l08912"></a>08912                         <span class="comment">// set up the ledger</span>
<a name="l08913"></a>08913                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
<a name="l08914"></a>08914                         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l08915"></a>08915                         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l08916"></a>08916 
<a name="l08917"></a>08917                         <span class="comment">// sign the ledger</span>
<a name="l08918"></a>08918                         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l08919"></a>08919                         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08920"></a>08920 
<a name="l08921"></a>08921                         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l08922"></a>08922                         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l08923"></a>08923                         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l08924"></a>08924 
<a name="l08925"></a>08925                         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08926"></a>08926                         theNym.GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l08927"></a>08927                         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08928"></a>08928                         theNym.IncrementRequestNum(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08929"></a>08929 
<a name="l08930"></a>08930                         <span class="comment">// (1) Set up member variables </span>
<a name="l08931"></a>08931                         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l08932"></a>08932                         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08933"></a>08933                         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08934"></a>08934                         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08935"></a>08935 
<a name="l08936"></a>08936                         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l08937"></a>08937                         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l08938"></a>08938 
<a name="l08939"></a>08939                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l08940"></a>08940                         <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08941"></a>08941                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l08942"></a>08942 
<a name="l08943"></a>08943                         <span class="keywordflow">if</span> (bNymboxHash)
<a name="l08944"></a>08944                             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l08945"></a>08945                         <span class="keywordflow">else</span>
<a name="l08946"></a>08946                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l08947"></a>08947                             str_server.c_str());
<a name="l08948"></a>08948 
<a name="l08949"></a>08949                         <span class="comment">// (2) Sign the Message </span>
<a name="l08950"></a>08950                         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l08951"></a>08951 
<a name="l08952"></a>08952                         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08953"></a>08953                         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08954"></a>08954 
<a name="l08955"></a>08955                         bSendCommand = <span class="keyword">true</span>;
<a name="l08956"></a>08956                         lReturnValue = lRequestNumber;        
<a name="l08957"></a>08957 
<a name="l08958"></a>08958                     } <span class="comment">// inbox/outbox loaded</span>
<a name="l08959"></a>08959                 } <span class="comment">// the cheque is blank, or is made out to me</span>
<a name="l08960"></a>08960             } <span class="comment">// cheque loaded</span>
<a name="l08961"></a>08961             <span class="keywordflow">else</span> <span class="comment">// cheque failed to load </span>
<a name="l08962"></a>08962             {
<a name="l08963"></a>08963                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08964"></a>08964                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08965"></a>08965             }       
<a name="l08966"></a>08966         } <span class="comment">// else if (OTClient::notarizeCheque == requestedCommand) // DEPOSIT CHEQUE</span>
<a name="l08967"></a>08967 
<a name="l08968"></a>08968 
<a name="l08969"></a>08969         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l08970"></a>08970 
<a name="l08971"></a>08971         <span class="keywordflow">break</span>;
<a name="l08972"></a>08972     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac31b4267e60dbdc9c28b5c7ba8fde62c">OTClient::withdrawVoucher</a>: <span class="comment">// WITHDRAW VOUCHER</span>
<a name="l08973"></a>08973         {       
<a name="l08974"></a>08974             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != m_pWallet);
<a name="l08975"></a>08975             <span class="comment">// --------------------------------</span>
<a name="l08976"></a>08976             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l08977"></a>08977 
<a name="l08978"></a>08978             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l08979"></a>08979             {
<a name="l08980"></a>08980                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;This is like a banker&#39;s cheque, aka cashier&#39;s cheque.\n&quot;</span>
<a name="l08981"></a>08981                     <span class="stringliteral">&quot;Please enter an asset Account ID (FROM acct): &quot;</span>);
<a name="l08982"></a>08982                 <span class="comment">// User input.</span>
<a name="l08983"></a>08983                 <span class="comment">// I need a from account</span>
<a name="l08984"></a>08984                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l08985"></a>08985 
<a name="l08986"></a>08986                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l08987"></a>08987                     <span class="keywordflow">return</span> (-1);
<a name="l08988"></a>08988 
<a name="l08989"></a>08989                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l08990"></a>08990 
<a name="l08991"></a>08991                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l08992"></a>08992                 {
<a name="l08993"></a>08993                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l08994"></a>08994                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08995"></a>08995                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08996"></a>08996                 }
<a name="l08997"></a>08997                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l08998"></a>08998                 {
<a name="l08999"></a>08999                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09000"></a>09000                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09001"></a>09001                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09002"></a>09002                 }
<a name="l09003"></a>09003                 <span class="keywordflow">else</span>
<a name="l09004"></a>09004                 {
<a name="l09005"></a>09005                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to purchase voucher without a &#39;FROM&#39; account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l09006"></a>09006                     <span class="keywordflow">return</span> (-1);
<a name="l09007"></a>09007                 }
<a name="l09008"></a>09008             }
<a name="l09009"></a>09009             <span class="keywordflow">else</span>
<a name="l09010"></a>09010             {
<a name="l09011"></a>09011                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09012"></a>09012                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09013"></a>09013                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09014"></a>09014             }
<a name="l09015"></a>09015 
<a name="l09016"></a>09016             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l09017"></a>09017 
<a name="l09018"></a>09018             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l09019"></a>09019             {
<a name="l09020"></a>09020                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l09021"></a>09021                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l09022"></a>09022                 <span class="keywordflow">return</span> (-1);
<a name="l09023"></a>09023             }
<a name="l09024"></a>09024             <span class="comment">// ---------------------------------------------------------</span>
<a name="l09025"></a>09025             <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym;
<a name="l09026"></a>09026 
<a name="l09027"></a>09027             <span class="keywordflow">if</span> (NULL == pHisNymID)
<a name="l09028"></a>09028             {
<a name="l09029"></a>09029                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s Nym ID (full ID -- no partials here.) Blank IS allowed: &quot;</span>);
<a name="l09030"></a>09030 
<a name="l09031"></a>09031                 <span class="comment">// User input.</span>
<a name="l09032"></a>09032                 <span class="comment">// I need a from account</span>
<a name="l09033"></a>09033                 strRecipientNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09034"></a>09034 
<a name="l09035"></a>09035                 <span class="comment">//          if (strRecipientNym.GetLength() &lt; 2) // blank cheques are allowed.</span>
<a name="l09036"></a>09036                 <span class="comment">//              return (-1);            </span>
<a name="l09037"></a>09037             }
<a name="l09038"></a>09038             <span class="keywordflow">else</span>
<a name="l09039"></a>09039             {
<a name="l09040"></a>09040                 pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientNym);            
<a name="l09041"></a>09041             }
<a name="l09042"></a>09042 
<a name="l09043"></a>09043             <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>
<a name="l09044"></a>09044 
<a name="l09045"></a>09045             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID (theNym);
<a name="l09046"></a>09046             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strRecipientNym);
<a name="l09047"></a>09047             <span class="comment">// ----------------------------------------------   </span>
<a name="l09048"></a>09048             <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
<a name="l09049"></a>09049             <span class="keywordflow">if</span> (0 == lTransactionAmount)
<a name="l09050"></a>09050             {
<a name="l09051"></a>09051                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
<a name="l09052"></a>09052                 <span class="comment">// User input.</span>
<a name="l09053"></a>09053                 <span class="comment">// I need an amount</span>
<a name="l09054"></a>09054                 strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09055"></a>09055             }
<a name="l09056"></a>09056 
<a name="l09057"></a>09057             <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount),</span>
<a name="l09058"></a>09058                 (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
<a name="l09059"></a>09059             <span class="comment">// ----------------------------------------------</span>
<a name="l09060"></a>09060             int64_t lWithdrawTransNum = 0,
<a name="l09061"></a>09061                 lVoucherTransNum  = 0;
<a name="l09062"></a>09062 
<a name="l09063"></a>09063             <span class="keywordtype">bool</span> bGotTransNum1 = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lWithdrawTransNum);
<a name="l09064"></a>09064             <span class="keywordtype">bool</span> bGotTransNum2 = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lVoucherTransNum);
<a name="l09065"></a>09065 
<a name="l09066"></a>09066             <span class="keywordflow">if</span> (!bGotTransNum1 || !bGotTransNum2)
<a name="l09067"></a>09067             {
<a name="l09068"></a>09068                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Not enough Transaction Numbers were available. &quot;</span>
<a name="l09069"></a>09069                     <span class="stringliteral">&quot;(Suggest requesting the server for more.)\n&quot;</span>, __FUNCTION__);
<a name="l09070"></a>09070 
<a name="l09071"></a>09071                 <span class="keywordflow">if</span> (bGotTransNum1)
<a name="l09072"></a>09072                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09073"></a>09073                 <span class="keywordflow">if</span> (bGotTransNum2)
<a name="l09074"></a>09074                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09075"></a>09075             }
<a name="l09076"></a>09076             <span class="keywordflow">else</span>
<a name="l09077"></a>09077             {
<a name="l09078"></a>09078                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09079"></a>09079                 <span class="comment">// Memo</span>
<a name="l09080"></a>09080                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo for your check: &quot;</span>);
<a name="l09081"></a>09081                 <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo;
<a name="l09082"></a>09082                 strChequeMemo.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09083"></a>09083                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09084"></a>09084                 <span class="comment">// Expiration (ignored by server -- it sets its own for its vouchers.)</span>
<a name="l09085"></a>09085                 <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
<a name="l09086"></a>09086                 <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>)); <span class="comment">// 6 months.</span>
<a name="l09087"></a>09087                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09088"></a>09088                 <span class="comment">// The server only uses the memo, amount, and recipient from this cheque when it</span>
<a name="l09089"></a>09089                 <span class="comment">// constructs the actual voucher.</span>
<a name="l09090"></a>09090                 <a class="code" href="class_o_t_cheque.html">OTCheque</a> theRequestVoucher(SERVER_ID, CONTRACT_ID);
<a name="l09091"></a>09091                 <span class="keywordtype">bool</span> bIssueCheque = theRequestVoucher.<a class="code" href="class_o_t_cheque.html#af554e93b31bf218e373bdc8f457d7605">IssueCheque</a>(lTotalAmount, lVoucherTransNum,
<a name="l09092"></a>09092                     VALID_FROM, VALID_TO, ACCOUNT_ID, MY_NYM_ID, strChequeMemo,
<a name="l09093"></a>09093                     (strRecipientNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) ? &amp;(HIS_NYM_ID) : NULL);
<a name="l09094"></a>09094 
<a name="l09095"></a>09095                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l09096"></a>09096                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l09097"></a>09097 
<a name="l09098"></a>09098                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l09099"></a>09099                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09100"></a>09100 
<a name="l09101"></a>09101                 <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l09102"></a>09102                 {
<a name="l09103"></a>09103                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l09104"></a>09104 
<a name="l09105"></a>09105                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09106"></a>09106                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09107"></a>09107                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09108"></a>09108                 }
<a name="l09109"></a>09109                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l09110"></a>09110                 {
<a name="l09111"></a>09111                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l09112"></a>09112 
<a name="l09113"></a>09113                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09114"></a>09114                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09115"></a>09115                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09116"></a>09116                 }           
<a name="l09117"></a>09117                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bIssueCheque)
<a name="l09118"></a>09118                 {
<a name="l09119"></a>09119                     <span class="comment">// Create a transaction</span>
<a name="l09120"></a>09120                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (MY_NYM_ID, ACCOUNT_ID, SERVER_ID, 
<a name="l09121"></a>09121                         <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lWithdrawTransNum); 
<a name="l09122"></a>09122 
<a name="l09123"></a>09123                     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09124"></a>09124                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>);
<a name="l09125"></a>09125                     pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
<a name="l09126"></a>09126                     <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Withdraw Voucher: &quot;</span>);
<a name="l09127"></a>09127                     pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l09128"></a>09128 
<a name="l09129"></a>09129                     <span class="comment">// Add the voucher request string as the attachment on the transaction item.</span>
<a name="l09130"></a>09130                     <a class="code" href="class_o_t_string.html">OTString</a> strVoucher;
<a name="l09131"></a>09131                     theRequestVoucher.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09132"></a>09132                     theRequestVoucher.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09133"></a>09133                     theRequestVoucher.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strVoucher);          
<a name="l09134"></a>09134                     pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strVoucher); <span class="comment">// The voucher request is contained in the reference string.</span>
<a name="l09135"></a>09135 
<a name="l09136"></a>09136                     <span class="comment">// sign the item</span>
<a name="l09137"></a>09137                     pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09138"></a>09138                     pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09139"></a>09139 
<a name="l09140"></a>09140                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09141"></a>09141                     <span class="comment">// ---------------------------------------------</span>
<a name="l09142"></a>09142                     <span class="comment">// BALANCE AGREEMENT </span>
<a name="l09143"></a>09143 
<a name="l09144"></a>09144                     <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
<a name="l09145"></a>09145                     <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalAmount*(-1), *pTransaction, theNym, *pAccount, *pOutbox);
<a name="l09146"></a>09146 
<a name="l09147"></a>09147                     <span class="keywordflow">if</span> (NULL != pBalanceItem)
<a name="l09148"></a>09148                         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09149"></a>09149                     <span class="comment">// ---------------------------------------------</span>
<a name="l09150"></a>09150                     <span class="comment">// sign the transaction</span>
<a name="l09151"></a>09151                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09152"></a>09152                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09153"></a>09153 
<a name="l09154"></a>09154                     <span class="comment">// set up the ledger</span>
<a name="l09155"></a>09155                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(MY_NYM_ID, ACCOUNT_ID, SERVER_ID);
<a name="l09156"></a>09156                     theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09157"></a>09157                     theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l09158"></a>09158 
<a name="l09159"></a>09159                     <span class="comment">// sign the ledger</span>
<a name="l09160"></a>09160                     theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09161"></a>09161                     theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09162"></a>09162 
<a name="l09163"></a>09163                     <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l09164"></a>09164                     <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09165"></a>09165                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l09166"></a>09166 
<a name="l09167"></a>09167                     <span class="comment">// Encoding...</span>
<a name="l09168"></a>09168                     ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l09169"></a>09169 
<a name="l09170"></a>09170                     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09171"></a>09171                     theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09172"></a>09172                     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09173"></a>09173                     theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09174"></a>09174 
<a name="l09175"></a>09175                     <span class="comment">// (1) Set up member variables </span>
<a name="l09176"></a>09176                     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09177"></a>09177                     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09178"></a>09178                     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09179"></a>09179                     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09180"></a>09180 
<a name="l09181"></a>09181                     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l09182"></a>09182                     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09183"></a>09183 
<a name="l09184"></a>09184                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09185"></a>09185                     <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09186"></a>09186                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09187"></a>09187 
<a name="l09188"></a>09188                     <span class="keywordflow">if</span> (bNymboxHash)
<a name="l09189"></a>09189                         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09190"></a>09190                     <span class="keywordflow">else</span>
<a name="l09191"></a>09191                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09192"></a>09192                         str_server.c_str());
<a name="l09193"></a>09193 
<a name="l09194"></a>09194                     <span class="comment">// (2) Sign the Message </span>
<a name="l09195"></a>09195                     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l09196"></a>09196 
<a name="l09197"></a>09197                     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09198"></a>09198                     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09199"></a>09199 
<a name="l09200"></a>09200                     bSendCommand = <span class="keyword">true</span>;
<a name="l09201"></a>09201                     lReturnValue = lRequestNumber;
<a name="l09202"></a>09202                 }
<a name="l09203"></a>09203                 <span class="keywordflow">else</span> 
<a name="l09204"></a>09204                 {
<a name="l09205"></a>09205                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09206"></a>09206                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09207"></a>09207                     theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09208"></a>09208                 }
<a name="l09209"></a>09209             }
<a name="l09210"></a>09210         }
<a name="l09211"></a>09211 
<a name="l09212"></a>09212         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09213"></a>09213 
<a name="l09214"></a>09214         <span class="comment">/*</span>
<a name="l09215"></a>09215 <span class="comment">        bool ProcessUserCommand(OT_CLIENT_CMD_TYPE requestedCommand,</span>
<a name="l09216"></a>09216 <span class="comment">        OTMessage &amp; theMessage,</span>
<a name="l09217"></a>09217 <span class="comment">        OTPseudonym &amp; theNym,</span>
<a name="l09218"></a>09218 <span class="comment">        //                          OTAssetContract &amp; theContract,</span>
<a name="l09219"></a>09219 <span class="comment">        OTServerContract &amp; theServer,</span>
<a name="l09220"></a>09220 <span class="comment">        OTAccount * pAccount=NULL,</span>
<a name="l09221"></a>09221 <span class="comment">        int64_t lTransactionAmount = 0,</span>
<a name="l09222"></a>09222 <span class="comment">        OTAssetContract * pMyAssetContract=NULL,</span>
<a name="l09223"></a>09223 <span class="comment">        OTAccount * pHisAcct=NULL,</span>
<a name="l09224"></a>09224 <span class="comment">        OTPseudonym * pHisNym=NULL);</span>
<a name="l09225"></a>09225 <span class="comment">        */</span>
<a name="l09226"></a>09226 
<a name="l09227"></a>09227         <span class="keywordflow">break</span>;
<a name="l09228"></a>09228     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a6a1880142e9d121429e7a48189e82654">OTClient::notarizeWithdrawal</a>: <span class="comment">// NOTARIZE WITHDRAWAL</span>
<a name="l09229"></a>09229         {   
<a name="l09230"></a>09230             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l09231"></a>09231 
<a name="l09232"></a>09232             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l09233"></a>09233             {
<a name="l09234"></a>09234                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Account ID: &quot;</span>);
<a name="l09235"></a>09235                 <span class="comment">// User input.</span>
<a name="l09236"></a>09236                 <span class="comment">// I need a from account</span>
<a name="l09237"></a>09237                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09238"></a>09238 
<a name="l09239"></a>09239                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l09240"></a>09240                     <span class="keywordflow">return</span> (-1);
<a name="l09241"></a>09241 
<a name="l09242"></a>09242                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l09243"></a>09243 
<a name="l09244"></a>09244                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l09245"></a>09245                 {
<a name="l09246"></a>09246                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09247"></a>09247                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09248"></a>09248                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09249"></a>09249                 }
<a name="l09250"></a>09250                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l09251"></a>09251                 {
<a name="l09252"></a>09252                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09253"></a>09253                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09254"></a>09254                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09255"></a>09255                 }
<a name="l09256"></a>09256                 <span class="keywordflow">else</span>
<a name="l09257"></a>09257                 {
<a name="l09258"></a>09258                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to withdraw without account. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l09259"></a>09259                     <span class="keywordflow">return</span> (-1);
<a name="l09260"></a>09260                 }
<a name="l09261"></a>09261             }
<a name="l09262"></a>09262             <span class="keywordflow">else</span>
<a name="l09263"></a>09263             {
<a name="l09264"></a>09264                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09265"></a>09265                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09266"></a>09266                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09267"></a>09267             }
<a name="l09268"></a>09268 
<a name="l09269"></a>09269             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l09270"></a>09270             {
<a name="l09271"></a>09271                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l09272"></a>09272                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l09273"></a>09273                 <span class="keywordflow">return</span> (-1);
<a name="l09274"></a>09274             }
<a name="l09275"></a>09275 
<a name="l09276"></a>09276             <span class="comment">// ----------------------------------------------</span>
<a name="l09277"></a>09277 
<a name="l09278"></a>09278             <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
<a name="l09279"></a>09279             <span class="keywordflow">if</span> (0 == lTransactionAmount)
<a name="l09280"></a>09280             {
<a name="l09281"></a>09281                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
<a name="l09282"></a>09282                 <span class="comment">// User input.</span>
<a name="l09283"></a>09283                 <span class="comment">// I need an amount</span>
<a name="l09284"></a>09284                 strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09285"></a>09285             }
<a name="l09286"></a>09286 
<a name="l09287"></a>09287             <span class="keyword">const</span>   int64_t lTotalAmount    = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
<a name="l09288"></a>09288                 (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
<a name="l09289"></a>09289             int64_t lAmount     = lTotalAmount; <span class="comment">// Used in calculating the denominations of tokens needed for the withdrawal.</span>
<a name="l09290"></a>09290 
<a name="l09291"></a>09291             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCT_FROM_ID(strFromAcct), USER_ID(theNym);
<a name="l09292"></a>09292 
<a name="l09293"></a>09293             int64_t lStoredTransactionNumber=0;
<a name="l09294"></a>09294             <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;
<a name="l09295"></a>09295 
<a name="l09296"></a>09296             <span class="comment">// ---------------------------------------------</span>
<a name="l09297"></a>09297 
<a name="l09298"></a>09298             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(theNym);
<a name="l09299"></a>09299             <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(theNym);
<a name="l09300"></a>09300 
<a name="l09301"></a>09301             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l09302"></a>09302             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09303"></a>09303 
<a name="l09304"></a>09304             <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l09305"></a>09305             {
<a name="l09306"></a>09306                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading inbox!\n&quot;</span>);
<a name="l09307"></a>09307                 <span class="keywordflow">break</span>;
<a name="l09308"></a>09308             }
<a name="l09309"></a>09309 
<a name="l09310"></a>09310             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l09311"></a>09311             {
<a name="l09312"></a>09312                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Failed loading outbox!\n&quot;</span>);
<a name="l09313"></a>09313                 <span class="keywordflow">break</span>;
<a name="l09314"></a>09314             }
<a name="l09315"></a>09315 
<a name="l09316"></a>09316             bGotTransNum = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber);
<a name="l09317"></a>09317             <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l09318"></a>09318             {
<a name="l09319"></a>09319                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No Transaction Numbers were available. Suggest requesting the server for a new one.\n&quot;</span>);
<a name="l09320"></a>09320                 <span class="keywordflow">break</span>;
<a name="l09321"></a>09321             }
<a name="l09322"></a>09322 
<a name="l09323"></a>09323             <span class="comment">// Create a transaction</span>
<a name="l09324"></a>09324             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM_ID, SERVER_ID, 
<a name="l09325"></a>09325                 <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lStoredTransactionNumber); 
<a name="l09326"></a>09326 
<a name="l09327"></a>09327             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09328"></a>09328             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>);
<a name="l09329"></a>09329             pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
<a name="l09330"></a>09330             <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Gimme cash!&quot;</span>);
<a name="l09331"></a>09331             pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l09332"></a>09332 
<a name="l09333"></a>09333             <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = theServer.<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l09334"></a>09334             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09335"></a>09335             <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strContractID);
<a name="l09336"></a>09336             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
<a name="l09337"></a>09337             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
<a name="l09338"></a>09338             <span class="comment">// ------------------------------</span>
<a name="l09339"></a>09339             <span class="keywordflow">if</span> (pServerNym &amp;&amp;
<a name="l09340"></a>09340                 pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>() &amp;&amp;
<a name="l09341"></a>09341                 pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>((<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>&amp;)*pServerNym))
<a name="l09342"></a>09342             {
<a name="l09343"></a>09343                 <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse        = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID);
<a name="l09344"></a>09344                 <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurseMyCopy  = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID);
<a name="l09345"></a>09345 
<a name="l09346"></a>09346                 <span class="comment">// Create all the necessary tokens for the withdrawal amount.</span>
<a name="l09347"></a>09347                 <span class="comment">// Push copies of each token into a purse to be sent to the server,</span>
<a name="l09348"></a>09348                 <span class="comment">// as well as a purse to be kept for unblinding when we receive the</span>
<a name="l09349"></a>09349                 <span class="comment">// server response.  (Coin private unblinding keys are not sent to</span>
<a name="l09350"></a>09350                 <span class="comment">// the server, obviously.)</span>
<a name="l09351"></a>09351                 int64_t lTokenAmount = 0;
<a name="l09352"></a>09352                 <span class="keywordflow">while</span> ((lTokenAmount = pMint-&gt;<a class="code" href="class_o_t_mint.html#a623b821ad01b8c0ce2568b6d84102c35">GetLargestDenomination</a>(lAmount)) &gt; 0)
<a name="l09353"></a>09353                 {
<a name="l09354"></a>09354                     lAmount -= lTokenAmount;
<a name="l09355"></a>09355 
<a name="l09356"></a>09356                     <span class="comment">// Create the relevant token request with same server/asset ID as the purse.</span>
<a name="l09357"></a>09357                     <span class="comment">// the purse does NOT own the token at this point. the token&#39;s constructor</span>
<a name="l09358"></a>09358                     <span class="comment">// just uses it to copy some IDs, since they must match.</span>
<a name="l09359"></a>09359                     <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ad661596f621b1b697f1e8328cdbc3683">OTToken::InstantiateAndGenerateTokenRequest</a>(*pPurse, theNym, *pMint, lTokenAmount);
<a name="l09360"></a>09360                     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l09361"></a>09361                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);
<a name="l09362"></a>09362 
<a name="l09363"></a>09363                     <span class="comment">// GENERATE new token, sign it and save it. </span>
<a name="l09364"></a>09364                     pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09365"></a>09365                     pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09366"></a>09366 
<a name="l09367"></a>09367                     <span class="comment">// Now the proto-token is generated, let&#39;s add it to a purse</span>
<a name="l09368"></a>09368                     <span class="comment">// By pushing pToken into pPurse with *pServerNym, I encrypt it to pServerNym.</span>
<a name="l09369"></a>09369                     <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
<a name="l09370"></a>09370                     pPurse-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pServerNym, *pToken);
<a name="l09371"></a>09371 
<a name="l09372"></a>09372                     <span class="comment">// I&#39;m saving my own copy of all this, encrypted to my nym</span>
<a name="l09373"></a>09373                     <span class="comment">// instead of the server&#39;s, so I can get to my private coin data.</span>
<a name="l09374"></a>09374                     <span class="comment">// The server&#39;s copy of pToken is already Pushed, so I can re-use</span>
<a name="l09375"></a>09375                     <span class="comment">// the variable now for my own purse.</span>
<a name="l09376"></a>09376                     pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l09377"></a>09377                     pToken-&gt;<a class="code" href="class_o_t_token.html#a8666afcdee1f4cb0b45e278d7196d6db">SetSavePrivateKeys</a>(); <span class="comment">// This time it will save the private keys when I sign it</span>
<a name="l09378"></a>09378                     pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09379"></a>09379                     pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09380"></a>09380 
<a name="l09381"></a>09381                     pPurseMyCopy-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(theNym, *pToken);    <span class="comment">// Now my copy of the purse has a version of the token,</span>
<a name="l09382"></a>09382                 }
<a name="l09383"></a>09383 
<a name="l09384"></a>09384                 pPurse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09385"></a>09385                 pPurse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>(); <span class="comment">// I think this one is unnecessary.</span>
<a name="l09386"></a>09386 
<a name="l09387"></a>09387                 <span class="comment">// Save the purse into a string...</span>
<a name="l09388"></a>09388                 <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
<a name="l09389"></a>09389                 pPurse-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);
<a name="l09390"></a>09390 
<a name="l09391"></a>09391                 <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
<a name="l09392"></a>09392                 pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>
<a name="l09393"></a>09393 
<a name="l09394"></a>09394 
<a name="l09395"></a>09395                 pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);     <span class="comment">// encrypted to me instead of the server, and including </span>
<a name="l09396"></a>09396                 pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();           <span class="comment">// the private keys for unblinding the server response.</span>
<a name="l09397"></a>09397                 <span class="comment">// This thing is neat and tidy. The wallet can just save it as an ascii-armored string as a</span>
<a name="l09398"></a>09398                 <span class="comment">// purse field inside the wallet file.  It doesn&#39;t do that for now (TODO) but it easily could.</span>
<a name="l09399"></a>09399 
<a name="l09400"></a>09400 
<a name="l09401"></a>09401                 <span class="comment">// Add the purse to the wallet</span>
<a name="l09402"></a>09402                 <span class="comment">// (We will need it to look up the private coin info for unblinding the token,</span>
<a name="l09403"></a>09403                 <span class="comment">//  when the response comes from the server.)</span>
<a name="l09404"></a>09404                 m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a098029976b57c592f220ae6bf0cc3822">AddPendingWithdrawal</a>(*pPurseMyCopy);
<a name="l09405"></a>09405 
<a name="l09406"></a>09406                 <span class="keyword">delete</span> pPurse;
<a name="l09407"></a>09407                 pPurse          = NULL; <span class="comment">// We&#39;re done with this one.</span>
<a name="l09408"></a>09408                 pPurseMyCopy    = NULL; <span class="comment">// The wallet owns my copy now and will handle cleaning it up.</span>
<a name="l09409"></a>09409 
<a name="l09410"></a>09410 
<a name="l09411"></a>09411                 <span class="comment">// sign the item</span>
<a name="l09412"></a>09412                 pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09413"></a>09413                 pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09414"></a>09414 
<a name="l09415"></a>09415                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09416"></a>09416 
<a name="l09417"></a>09417                 <span class="comment">// ---------------------------------------------</span>
<a name="l09418"></a>09418                 <span class="comment">// BALANCE AGREEMENT</span>
<a name="l09419"></a>09419 
<a name="l09420"></a>09420                 <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l09421"></a>09421                 <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalAmount*(-1), *pTransaction, theNym, *pAccount, *pOutbox);
<a name="l09422"></a>09422 
<a name="l09423"></a>09423                 <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l09424"></a>09424                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09425"></a>09425 
<a name="l09426"></a>09426                 <span class="comment">// ---------------------------------------------</span>
<a name="l09427"></a>09427 
<a name="l09428"></a>09428                 <span class="comment">// sign the transaction</span>
<a name="l09429"></a>09429                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09430"></a>09430                 pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09431"></a>09431 
<a name="l09432"></a>09432 
<a name="l09433"></a>09433                 <span class="comment">// set up the ledger</span>
<a name="l09434"></a>09434                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM_ID, SERVER_ID);
<a name="l09435"></a>09435                 theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09436"></a>09436                 theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l09437"></a>09437 
<a name="l09438"></a>09438                 <span class="comment">// sign the ledger</span>
<a name="l09439"></a>09439                 theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09440"></a>09440                 theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09441"></a>09441 
<a name="l09442"></a>09442                 <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l09443"></a>09443                 <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09444"></a>09444                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l09445"></a>09445 
<a name="l09446"></a>09446                 <span class="comment">// Encoding...</span>
<a name="l09447"></a>09447                 ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l09448"></a>09448 
<a name="l09449"></a>09449 
<a name="l09450"></a>09450                 <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09451"></a>09451                 theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09452"></a>09452                 theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09453"></a>09453                 theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09454"></a>09454 
<a name="l09455"></a>09455                 <span class="comment">// (1) Set up member variables </span>
<a name="l09456"></a>09456                 theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09457"></a>09457                 theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09458"></a>09458                 theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09459"></a>09459                 theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09460"></a>09460 
<a name="l09461"></a>09461                 theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l09462"></a>09462                 theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09463"></a>09463 
<a name="l09464"></a>09464                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09465"></a>09465                 <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09466"></a>09466                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09467"></a>09467 
<a name="l09468"></a>09468                 <span class="keywordflow">if</span> (bNymboxHash)
<a name="l09469"></a>09469                     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09470"></a>09470                 <span class="keywordflow">else</span>
<a name="l09471"></a>09471                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09472"></a>09472                     str_server.c_str());
<a name="l09473"></a>09473 
<a name="l09474"></a>09474                 <span class="comment">// (2) Sign the Message </span>
<a name="l09475"></a>09475                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l09476"></a>09476 
<a name="l09477"></a>09477                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09478"></a>09478                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09479"></a>09479 
<a name="l09480"></a>09480                 bSendCommand = <span class="keyword">true</span>;
<a name="l09481"></a>09481                 lReturnValue = lRequestNumber;                
<a name="l09482"></a>09482             }
<a name="l09483"></a>09483             <span class="keywordflow">else</span> 
<a name="l09484"></a>09484             {
<a name="l09485"></a>09485                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09486"></a>09486                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                                </span>
<a name="l09487"></a>09487             }
<a name="l09488"></a>09488 
<a name="l09489"></a>09489         }
<a name="l09490"></a>09490 
<a name="l09491"></a>09491         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09492"></a>09492 
<a name="l09493"></a>09493         <span class="keywordflow">break</span>;
<a name="l09494"></a>09494     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">OTClient::getTransactionNum</a>: <span class="comment">// GET TRANSACTION NUM</span>
<a name="l09495"></a>09495         {   
<a name="l09496"></a>09496             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09497"></a>09497             theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09498"></a>09498             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09499"></a>09499             theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09500"></a>09500 
<a name="l09501"></a>09501             <span class="comment">// (1) Set up member variables </span>
<a name="l09502"></a>09502             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getTransactionNum&quot;</span>;
<a name="l09503"></a>09503             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09504"></a>09504             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09505"></a>09505             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09506"></a>09506 
<a name="l09507"></a>09507             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09508"></a>09508             <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09509"></a>09509             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09510"></a>09510 
<a name="l09511"></a>09511             <span class="keywordflow">if</span> (bNymboxHash)
<a name="l09512"></a>09512                 NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09513"></a>09513             <span class="keywordflow">else</span>
<a name="l09514"></a>09514                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09515"></a>09515                 str_server.c_str());
<a name="l09516"></a>09516 
<a name="l09517"></a>09517             <span class="comment">// (2) Sign the Message </span>
<a name="l09518"></a>09518             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l09519"></a>09519 
<a name="l09520"></a>09520             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09521"></a>09521             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09522"></a>09522 
<a name="l09523"></a>09523             bSendCommand = <span class="keyword">true</span>;
<a name="l09524"></a>09524             lReturnValue = lRequestNumber;        
<a name="l09525"></a>09525         }
<a name="l09526"></a>09526 
<a name="l09527"></a>09527 
<a name="l09528"></a>09528         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09529"></a>09529 
<a name="l09530"></a>09530 
<a name="l09531"></a>09531         <span class="keywordflow">break</span>;
<a name="l09532"></a>09532     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7aa3e1744621c050d38a934d77749d891e">OTClient::marketOffer</a>: <span class="comment">// PUT AN OFFER ON A MARKET</span>
<a name="l09533"></a>09533         {
<a name="l09534"></a>09534             <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(strServerID) &lt; 3)
<a name="l09535"></a>09535             {
<a name="l09536"></a>09536                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;You need at least 3 transaction numbers to do this (You don&#39;t have enough.)\n&quot;</span>);
<a name="l09537"></a>09537             }
<a name="l09538"></a>09538             <span class="keywordflow">else</span>
<a name="l09539"></a>09539             {
<a name="l09540"></a>09540                 int64_t lStoredTransactionNumber=0, lClosingTransactionNoAssetAcct=0, lClosingTransactionNoCurrencyAcct=0;
<a name="l09541"></a>09541                 <span class="keywordtype">bool</span> bGotTransNum   = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>);
<a name="l09542"></a>09542                 <span class="keywordtype">bool</span> bGotClosingNumAssetAcct = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>);
<a name="l09543"></a>09543                 <span class="keywordtype">bool</span> bGotClosingNumCurrencyAcct = theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">true</span>);
<a name="l09544"></a>09544 
<a name="l09545"></a>09545                 <span class="keywordflow">if</span> (!bGotTransNum || !bGotClosingNumAssetAcct || !bGotClosingNumCurrencyAcct)
<a name="l09546"></a>09546                 {
<a name="l09547"></a>09547                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Strange... had enough transcation numbers, but error trying to get one (or both.)\n&quot;</span>);
<a name="l09548"></a>09548 
<a name="l09549"></a>09549                     <span class="keywordflow">if</span> (bGotTransNum)
<a name="l09550"></a>09550                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>);
<a name="l09551"></a>09551 
<a name="l09552"></a>09552                     <span class="keywordflow">if</span> (bGotClosingNumAssetAcct)
<a name="l09553"></a>09553                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>);
<a name="l09554"></a>09554 
<a name="l09555"></a>09555                     <span class="keywordflow">if</span> (bGotClosingNumCurrencyAcct)
<a name="l09556"></a>09556                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">false</span>);
<a name="l09557"></a>09557 
<a name="l09558"></a>09558                     <span class="keywordflow">if</span> (bGotTransNum || bGotClosingNumAssetAcct || bGotClosingNumCurrencyAcct)
<a name="l09559"></a>09559                         theNym.<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(theNym);
<a name="l09560"></a>09560                 }
<a name="l09561"></a>09561                 <span class="keywordflow">else</span>
<a name="l09562"></a>09562                 {
<a name="l09563"></a>09563                     <a class="code" href="class_o_t_string.html">OTString</a> str_ASSET_TYPE_ID, str_CURRENCY_TYPE_ID, str_ASSET_ACCT_ID, str_CURRENCY_ACCT_ID;
<a name="l09564"></a>09564 
<a name="l09565"></a>09565                     <span class="comment">// FIRST get the Asset Type ID</span>
<a name="l09566"></a>09566                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the Asset Type ID of the market you want to trade in: &quot;</span>);
<a name="l09567"></a>09567                     str_ASSET_TYPE_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09568"></a>09568 
<a name="l09569"></a>09569                     <span class="comment">// THEN GET AN ACCOUNT ID FOR THAT ASSET TYPE</span>
<a name="l09570"></a>09570                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours for an account of the same asset type: &quot;</span>);
<a name="l09571"></a>09571                     str_ASSET_ACCT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);        
<a name="l09572"></a>09572 
<a name="l09573"></a>09573                     <span class="comment">// NEXT get the Currency Type ID (which is also an asset type ID, FYI.)</span>
<a name="l09574"></a>09574                     <span class="comment">// The trader just chooses one of them to be the &quot;asset&quot; and the other, the &quot;currency&quot;.</span>
<a name="l09575"></a>09575                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter the Currency Type ID of the market you want to trade in: &quot;</span>);
<a name="l09576"></a>09576                     str_CURRENCY_TYPE_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09577"></a>09577 
<a name="l09578"></a>09578                     <span class="comment">// THEN GET AN ACCOUNT ID FOR THAT CURRENCY TYPE</span>
<a name="l09579"></a>09579                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter an ACCOUNT ID of yours, for an account of that same currency type: &quot;</span>);
<a name="l09580"></a>09580                     str_CURRENCY_ACCT_ID.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);     
<a name="l09581"></a>09581 
<a name="l09582"></a>09582 
<a name="l09583"></a>09583                     <span class="comment">// Get a few int64_t integers that we need...</span>
<a name="l09584"></a>09584 
<a name="l09585"></a>09585                     <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l09586"></a>09586                     int64_t lTotalAssetsOnOffer = 0, 
<a name="l09587"></a>09587                         lMinimumIncrement = 0, 
<a name="l09588"></a>09588                         lPriceLimit = 0,
<a name="l09589"></a>09589                         lMarketScale = 1;
<a name="l09590"></a>09590 
<a name="l09591"></a>09591                     <span class="comment">// -------------------------------------------------------------------</span>
<a name="l09592"></a>09592 
<a name="l09593"></a>09593                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the market granularity (or &#39;scale&#39;)? [1]: &quot;</span>);
<a name="l09594"></a>09594                     strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09595"></a>09595                     lMarketScale = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09596"></a>09596 
<a name="l09597"></a>09597                     <span class="keywordflow">if</span> (lMarketScale &lt; 1)
<a name="l09598"></a>09598                         lMarketScale = 1;
<a name="l09599"></a>09599 
<a name="l09600"></a>09600                     <span class="comment">// -------------------------------------------------------------------</span>
<a name="l09601"></a>09601 
<a name="l09602"></a>09602                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;What is the minimum increment per trade? (will be multiplied by the scale) [1]: &quot;</span>);
<a name="l09603"></a>09603                     strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09604"></a>09604                     lMinimumIncrement = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09605"></a>09605 
<a name="l09606"></a>09606                     lMinimumIncrement *= lMarketScale;
<a name="l09607"></a>09607 
<a name="l09608"></a>09608                     <span class="comment">// In case they entered 0.</span>
<a name="l09609"></a>09609                     <span class="keywordflow">if</span> (lMinimumIncrement &lt; 1)
<a name="l09610"></a>09610                         lMinimumIncrement = lMarketScale;
<a name="l09611"></a>09611 
<a name="l09612"></a>09612                     <span class="comment">// -------------------------------------------------------------------</span>
<a name="l09613"></a>09613 
<a name="l09614"></a>09614                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;How many assets total do you have available for sale or purchase?\n&quot;</span>
<a name="l09615"></a>09615                         <span class="stringliteral">&quot;(Will be multiplied by minimum increment) [1]: &quot;</span>);
<a name="l09616"></a>09616                     strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09617"></a>09617                     lTotalAssetsOnOffer = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09618"></a>09618 
<a name="l09619"></a>09619                     <span class="comment">//              lTotalAssetsOnOffer *= lMinimumIncrement;  // this was a bug.</span>
<a name="l09620"></a>09620 
<a name="l09621"></a>09621                     <span class="keywordflow">if</span> (lTotalAssetsOnOffer &lt; 1)
<a name="l09622"></a>09622                         lTotalAssetsOnOffer = lMinimumIncrement;
<a name="l09623"></a>09623 
<a name="l09624"></a>09624 
<a name="l09625"></a>09625 
<a name="l09626"></a>09626                     <span class="keywordflow">for</span> (;;)
<a name="l09627"></a>09627                     {
<a name="l09628"></a>09628                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;The Market Scale is: %lld\n&quot;</span>
<a name="l09629"></a>09629                             <span class="stringliteral">&quot;What is your price limit, in currency, PER SCALE of assets?\n&quot;</span>
<a name="l09630"></a>09630                             <span class="stringliteral">&quot;That is, what is the lowest amount of currency you&#39;d sell for, (if selling)\n&quot;</span>
<a name="l09631"></a>09631                             <span class="stringliteral">&quot;Or the highest amount you&#39;d pay (if you are buying).\nAgain, PER SCALE: &quot;</span>,
<a name="l09632"></a>09632                             lMarketScale);
<a name="l09633"></a>09633                         strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09634"></a>09634                         lPriceLimit = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09635"></a>09635 
<a name="l09636"></a>09636                         <span class="keywordflow">if</span> (lPriceLimit &lt; 1)
<a name="l09637"></a>09637                             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Price must be at least 1.\n\n&quot;</span>);
<a name="l09638"></a>09638                         <span class="keywordflow">else</span>
<a name="l09639"></a>09639                             <span class="keywordflow">break</span>;          
<a name="l09640"></a>09640                     }
<a name="l09641"></a>09641 
<a name="l09642"></a>09642                     <span class="comment">// which direction is the offer? Buy or sell?</span>
<a name="l09643"></a>09643                     <span class="keywordtype">bool</span> bBuyingOrSelling;
<a name="l09644"></a>09644                     <a class="code" href="class_o_t_string.html">OTString</a> strDirection;
<a name="l09645"></a>09645                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Are you in the market to buy the asset type, or to sell? [buy]: &quot;</span>);
<a name="l09646"></a>09646                     strDirection.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09647"></a>09647 
<a name="l09648"></a>09648                     <span class="keywordflow">if</span> (strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;sell&quot;</span>) || strDirection.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;Sell&quot;</span>))
<a name="l09649"></a>09649                         bBuyingOrSelling    = <span class="keyword">true</span>;
<a name="l09650"></a>09650                     <span class="keywordflow">else</span>
<a name="l09651"></a>09651                         bBuyingOrSelling    = <span class="keyword">false</span>;
<a name="l09652"></a>09652 
<a name="l09653"></a>09653 
<a name="l09654"></a>09654                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(strNymID),
<a name="l09655"></a>09655                         ASSET_TYPE_ID(str_ASSET_TYPE_ID),   CURRENCY_TYPE_ID(str_CURRENCY_TYPE_ID),
<a name="l09656"></a>09656                         ASSET_ACCT_ID(str_ASSET_ACCT_ID),   CURRENCY_ACCT_ID(str_CURRENCY_ACCT_ID);
<a name="l09657"></a>09657 
<a name="l09658"></a>09658 
<a name="l09659"></a>09659                     <a class="code" href="class_o_t_offer.html">OTOffer</a> theOffer(SERVER_ID, ASSET_TYPE_ID, CURRENCY_TYPE_ID, lMarketScale);
<a name="l09660"></a>09660 
<a name="l09661"></a>09661 
<a name="l09662"></a>09662                     <span class="keywordtype">bool</span> bCreateOffer = theOffer.<a class="code" href="class_o_t_offer.html#abe8307270d023aec4d0e812bf50b7e37">MakeOffer</a>(bBuyingOrSelling,    <span class="comment">// True == SELLING, False == BUYING</span>
<a name="l09663"></a>09663                         lPriceLimit,            <span class="comment">// Per Minimum Increment...</span>
<a name="l09664"></a>09664                         lTotalAssetsOnOffer,    <span class="comment">// Total assets available for sale or purchase.</span>
<a name="l09665"></a>09665                         lMinimumIncrement,  <span class="comment">// The minimum increment that must be bought or sold for each transaction</span>
<a name="l09666"></a>09666                         lStoredTransactionNumber); <span class="comment">// Transaction number matches on transaction, item, offer, and trade.</span>
<a name="l09667"></a>09667 
<a name="l09668"></a>09668                     <span class="keywordflow">if</span> (bCreateOffer)
<a name="l09669"></a>09669                     {
<a name="l09670"></a>09670                         bCreateOffer =  theOffer.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09671"></a>09671 
<a name="l09672"></a>09672                         <span class="keywordflow">if</span> (bCreateOffer)
<a name="l09673"></a>09673                             bCreateOffer = theOffer.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09674"></a>09674                     }
<a name="l09675"></a>09675 
<a name="l09676"></a>09676                     <a class="code" href="class_o_t_trade.html">OTTrade</a> theTrade(SERVER_ID, 
<a name="l09677"></a>09677                         ASSET_TYPE_ID, ASSET_ACCT_ID, 
<a name="l09678"></a>09678                         USER_ID, 
<a name="l09679"></a>09679                         CURRENCY_TYPE_ID, CURRENCY_ACCT_ID);
<a name="l09680"></a>09680 
<a name="l09681"></a>09681 
<a name="l09682"></a>09682                     <span class="keywordtype">bool</span> bIssueTrade = theTrade.<a class="code" href="class_o_t_trade.html#a64013127ededb1a9729aeb07ea9cadb7">IssueTrade</a>(theOffer);
<a name="l09683"></a>09683 
<a name="l09684"></a>09684                     <span class="keywordflow">if</span> (bIssueTrade)
<a name="l09685"></a>09685                     {
<a name="l09686"></a>09686                         theTrade.<a class="code" href="class_o_t_cron_item.html#a310153e4e82ec7fbc887e93c4d12220d">AddClosingTransactionNo</a>(lClosingTransactionNoAssetAcct);
<a name="l09687"></a>09687                         theTrade.<a class="code" href="class_o_t_cron_item.html#a310153e4e82ec7fbc887e93c4d12220d">AddClosingTransactionNo</a>(lClosingTransactionNoCurrencyAcct);
<a name="l09688"></a>09688 
<a name="l09689"></a>09689                         bIssueTrade =   theTrade.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09690"></a>09690 
<a name="l09691"></a>09691                         <span class="keywordflow">if</span> (bIssueTrade)
<a name="l09692"></a>09692                             bIssueTrade = theTrade.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09693"></a>09693                     }
<a name="l09694"></a>09694 
<a name="l09695"></a>09695 
<a name="l09696"></a>09696                     <span class="keywordflow">if</span> (bCreateOffer &amp;&amp; bIssueTrade)
<a name="l09697"></a>09697                     {
<a name="l09698"></a>09698                         <span class="comment">// Create a transaction</span>
<a name="l09699"></a>09699                         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ASSET_ACCT_ID, SERVER_ID, 
<a name="l09700"></a>09700                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>, lStoredTransactionNumber); 
<a name="l09701"></a>09701 
<a name="l09702"></a>09702                         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09703"></a>09703                         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae973afad2dc8a8349e8889304b20e73b">OTItem::marketOffer</a>, 
<a name="l09704"></a>09704                             &amp;CURRENCY_ACCT_ID); <span class="comment">// the &quot;To&quot; account (normally used for a TRANSFER transaction) is used here </span>
<a name="l09705"></a>09705                         <span class="comment">// storing the Currency Acct ID. The Server will expect the Trade object bundled </span>
<a name="l09706"></a>09706                         <span class="comment">// within this item to have an Asset Acct ID and &quot;Currency&quot; Acct ID that match</span>
<a name="l09707"></a>09707                         <span class="comment">// those on this Item. Otherwise it will reject the offer.</span>
<a name="l09708"></a>09708 
<a name="l09709"></a>09709                         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l09710"></a>09710 
<a name="l09711"></a>09711                         <a class="code" href="class_o_t_string.html">OTString</a> strTrade;
<a name="l09712"></a>09712                         theTrade.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTrade);
<a name="l09713"></a>09713 
<a name="l09714"></a>09714                         <span class="comment">// Add the trade string as the attachment on the transaction item.</span>
<a name="l09715"></a>09715                         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strTrade); <span class="comment">// The trade is contained in the attachment string. (The offer is within the trade.)</span>
<a name="l09716"></a>09716 
<a name="l09717"></a>09717                         <span class="comment">// sign the item</span>
<a name="l09718"></a>09718                         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09719"></a>09719                         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09720"></a>09720 
<a name="l09721"></a>09721                         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l09722"></a>09722                         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09723"></a>09723 
<a name="l09724"></a>09724                         <span class="comment">// ---------------------------------------------</span>
<a name="l09725"></a>09725                         <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l09726"></a>09726 
<a name="l09727"></a>09727                         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l09728"></a>09728                         <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = theNym.<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l09729"></a>09729 
<a name="l09730"></a>09730                         <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l09731"></a>09731                             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09732"></a>09732 
<a name="l09733"></a>09733                         <span class="comment">// ---------------------------------------------</span>
<a name="l09734"></a>09734 
<a name="l09735"></a>09735                         <span class="comment">// sign the transaction</span>
<a name="l09736"></a>09736                         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09737"></a>09737                         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09738"></a>09738 
<a name="l09739"></a>09739                         <span class="comment">// set up the ledger</span>
<a name="l09740"></a>09740                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ASSET_ACCT_ID, SERVER_ID);
<a name="l09741"></a>09741                         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ASSET_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09742"></a>09742                         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l09743"></a>09743 
<a name="l09744"></a>09744                         <span class="comment">// sign the ledger</span>
<a name="l09745"></a>09745                         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l09746"></a>09746                         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09747"></a>09747 
<a name="l09748"></a>09748                         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l09749"></a>09749                         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09750"></a>09750                         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l09751"></a>09751 
<a name="l09752"></a>09752                         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09753"></a>09753                         theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09754"></a>09754                         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09755"></a>09755                         theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09756"></a>09756 
<a name="l09757"></a>09757                         <span class="comment">// (1) Set up member variables </span>
<a name="l09758"></a>09758                         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09759"></a>09759                         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09760"></a>09760                         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09761"></a>09761                         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09762"></a>09762 
<a name="l09763"></a>09763                         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_ASSET_ACCT_ID;
<a name="l09764"></a>09764                         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09765"></a>09765 
<a name="l09766"></a>09766                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09767"></a>09767                         <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09768"></a>09768                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09769"></a>09769 
<a name="l09770"></a>09770                         <span class="keywordflow">if</span> (bNymboxHash)
<a name="l09771"></a>09771                             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09772"></a>09772                         <span class="keywordflow">else</span>
<a name="l09773"></a>09773                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09774"></a>09774                             str_server.c_str());
<a name="l09775"></a>09775 
<a name="l09776"></a>09776                         <span class="comment">// (2) Sign the Message </span>
<a name="l09777"></a>09777                         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l09778"></a>09778 
<a name="l09779"></a>09779                         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09780"></a>09780                         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09781"></a>09781 
<a name="l09782"></a>09782                         bSendCommand = <span class="keyword">true</span>;
<a name="l09783"></a>09783                         lReturnValue = lRequestNumber;
<a name="l09784"></a>09784                     }
<a name="l09785"></a>09785 
<a name="l09786"></a>09786                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSendCommand)  
<a name="l09787"></a>09787                     {
<a name="l09788"></a>09788                         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09789"></a>09789                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
<a name="l09790"></a>09790                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lClosingTransactionNoAssetAcct, <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
<a name="l09791"></a>09791                         theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lClosingTransactionNoCurrencyAcct, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09792"></a>09792                     }
<a name="l09793"></a>09793                 } <span class="comment">// Got Transaction Num</span>
<a name="l09794"></a>09794             }
<a name="l09795"></a>09795         } <span class="comment">// else if (OTClient::marketOffer == requestedCommand) // MARKET OFFER</span>
<a name="l09796"></a>09796 
<a name="l09797"></a>09797 
<a name="l09798"></a>09798         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09799"></a>09799 
<a name="l09800"></a>09800         <span class="keywordflow">break</span>;
<a name="l09801"></a>09801     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ac5c8e57a658c61b11369d11204b73cbd">OTClient::signContract</a>: <span class="comment">// Sign a CONTRACT. (Sends no message to server.)</span>
<a name="l09802"></a>09802         {
<a name="l09803"></a>09803             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract a server contract, or an asset contract [s/a]: &quot;</span>);
<a name="l09804"></a>09804             <a class="code" href="class_o_t_string.html">OTString</a> strContractType;
<a name="l09805"></a>09805             strContractType.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09806"></a>09806 
<a name="l09807"></a>09807             <span class="keywordtype">char</span> cContractType=<span class="charliteral">&#39;s&#39;</span>;
<a name="l09808"></a>09808             <span class="keywordtype">bool</span> bIsAssetContract = strContractType.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cContractType);
<a name="l09809"></a>09809 
<a name="l09810"></a>09810             <span class="keywordflow">if</span> (bIsAssetContract)
<a name="l09811"></a>09811             {
<a name="l09812"></a>09812                 <span class="keywordflow">if</span> (<span class="charliteral">&#39;S&#39;</span> == cContractType || <span class="charliteral">&#39;s&#39;</span> == cContractType)
<a name="l09813"></a>09813                     bIsAssetContract = <span class="keyword">false</span>;
<a name="l09814"></a>09814             }
<a name="l09815"></a>09815             <span class="comment">// ----------------------------</span>
<a name="l09816"></a>09816 
<a name="l09817"></a>09817             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Is the contract properly escaped already? (If escaped, all lines beginning with ----- will instead appear as - ----- ) [y/n]: &quot;</span>);
<a name="l09818"></a>09818             <span class="comment">// User input.</span>
<a name="l09819"></a>09819             <span class="comment">// I need a from account, Yes even in a deposit, it&#39;s still the &quot;From&quot; account.</span>
<a name="l09820"></a>09820             <span class="comment">// The &quot;To&quot; account is only used for a transfer. (And perhaps for a 2-way trade.)</span>
<a name="l09821"></a>09821             <a class="code" href="class_o_t_string.html">OTString</a> strEscape;
<a name="l09822"></a>09822             strEscape.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09823"></a>09823 
<a name="l09824"></a>09824             <span class="keywordtype">char</span> cEscape=<span class="charliteral">&#39;n&#39;</span>;
<a name="l09825"></a>09825             <span class="keywordtype">bool</span> bEscaped = strEscape.<a class="code" href="class_o_t_string.html#a0b183402da9a9ea6da94b3fcaa8740e8">At</a>(0, cEscape);
<a name="l09826"></a>09826 
<a name="l09827"></a>09827             <span class="keywordflow">if</span> (bEscaped)
<a name="l09828"></a>09828             {
<a name="l09829"></a>09829                 <span class="keywordflow">if</span> (<span class="charliteral">&#39;N&#39;</span> == cEscape || <span class="charliteral">&#39;n&#39;</span> == cEscape)
<a name="l09830"></a>09830                     bEscaped = <span class="keyword">false</span>;
<a name="l09831"></a>09831             }
<a name="l09832"></a>09832 
<a name="l09833"></a>09833             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an unsigned asset contract; terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l09834"></a>09834             <a class="code" href="class_o_t_string.html">OTString</a> strContract;
<a name="l09835"></a>09835             <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>
<a name="l09836"></a>09836 
<a name="l09837"></a>09837             <span class="keywordflow">do</span> {
<a name="l09838"></a>09838                 decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>
<a name="l09839"></a>09839 
<a name="l09840"></a>09840                 <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
<a name="l09841"></a>09841                     (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l09842"></a>09842                 {
<a name="l09843"></a>09843                     <span class="keywordflow">if</span> (!bEscaped &amp;&amp; decode_buffer[0] == <span class="charliteral">&#39;-&#39;</span>)
<a name="l09844"></a>09844                     {
<a name="l09845"></a>09845                         strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;- &quot;</span>);
<a name="l09846"></a>09846                     }
<a name="l09847"></a>09847                     strContract.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l09848"></a>09848                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l09849"></a>09849                 }
<a name="l09850"></a>09850                 <span class="keywordflow">else</span> 
<a name="l09851"></a>09851                 {
<a name="l09852"></a>09852                     <span class="keywordflow">break</span>;
<a name="l09853"></a>09853                 }
<a name="l09854"></a>09854 
<a name="l09855"></a>09855             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l09856"></a>09856 
<a name="l09857"></a>09857             <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> theServerContract;
<a name="l09858"></a>09858             <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;
<a name="l09859"></a>09859 
<a name="l09860"></a>09860             <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = bIsAssetContract ? <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_contract.html">OTContract</a>*<span class="keyword">&gt;</span>(&amp;theAssetContract) : dynamic_cast&lt;OTContract*&gt;(&amp;theServerContract);
<a name="l09861"></a>09861 
<a name="l09862"></a>09862             pContract-&gt;<a class="code" href="class_o_t_contract.html#aefeed014e39aa6dc843d090e03769b5d">CreateContract</a>(strContract, theNym);
<a name="l09863"></a>09863 
<a name="l09864"></a>09864             <span class="comment">// re-using strContract here for output this time.</span>
<a name="l09865"></a>09865             strContract.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l09866"></a>09866             pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strContract);
<a name="l09867"></a>09867 
<a name="l09868"></a>09868             <a class="code" href="class_o_t_string.html">OTString</a> strNewID;
<a name="l09869"></a>09869             pContract-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strNewID);
<a name="l09870"></a>09870 
<a name="l09871"></a>09871             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;.\n..\n...\n....\n.....\n......\n.......\n........\n.........\n\n&quot;</span>
<a name="l09872"></a>09872                 <span class="stringliteral">&quot;NEW CONTRACT ID:  %s\n\n&quot;</span>, strNewID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09873"></a>09873 
<a name="l09874"></a>09874             std::cout &lt;&lt; strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;
<a name="l09875"></a>09875 
<a name="l09876"></a>09876             <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09877"></a>09877 
<a name="l09878"></a>09878             <span class="keywordflow">return</span> 0;
<a name="l09879"></a>09879         }
<a name="l09880"></a>09880 
<a name="l09881"></a>09881         <span class="keywordflow">break</span>;
<a name="l09882"></a>09882     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab15b3869502823da3286c4a3be9b83bc">OTClient::writeCheque</a>: <span class="comment">// Write a CHEQUE. (Sends no message to server.)</span>
<a name="l09883"></a>09883         {
<a name="l09884"></a>09884             <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct;
<a name="l09885"></a>09885 
<a name="l09886"></a>09886             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l09887"></a>09887             {
<a name="l09888"></a>09888                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an Asset Account ID (to draw the cheque from): &quot;</span>);
<a name="l09889"></a>09889                 <span class="comment">// User input.</span>
<a name="l09890"></a>09890                 <span class="comment">// I need a from account</span>
<a name="l09891"></a>09891                 strFromAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09892"></a>09892 
<a name="l09893"></a>09893                 <span class="keywordflow">if</span> (strFromAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l09894"></a>09894                     <span class="keywordflow">return</span> (-1);
<a name="l09895"></a>09895 
<a name="l09896"></a>09896                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l09897"></a>09897 
<a name="l09898"></a>09898                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l09899"></a>09899                 {
<a name="l09900"></a>09900                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09901"></a>09901                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09902"></a>09902                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09903"></a>09903                 }
<a name="l09904"></a>09904                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l09905"></a>09905                 {
<a name="l09906"></a>09906                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09907"></a>09907                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09908"></a>09908                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09909"></a>09909                 }
<a name="l09910"></a>09910                 <span class="keywordflow">else</span>
<a name="l09911"></a>09911                 {
<a name="l09912"></a>09912                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to write cheque without account to draw from. On comand line, try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l09913"></a>09913                     <span class="keywordflow">return</span> (-1);
<a name="l09914"></a>09914                 }
<a name="l09915"></a>09915             }
<a name="l09916"></a>09916             <span class="keywordflow">else</span>
<a name="l09917"></a>09917             {
<a name="l09918"></a>09918                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strFromAcct);
<a name="l09919"></a>09919                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09920"></a>09920                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09921"></a>09921             }
<a name="l09922"></a>09922 
<a name="l09923"></a>09923             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strFromAcct);
<a name="l09924"></a>09924 
<a name="l09925"></a>09925             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l09926"></a>09926             {
<a name="l09927"></a>09927                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l09928"></a>09928                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l09929"></a>09929                 <span class="keywordflow">return</span> (-1);
<a name="l09930"></a>09930             }
<a name="l09931"></a>09931 
<a name="l09932"></a>09932             <span class="comment">// ---------------------------------------------------------</span>
<a name="l09933"></a>09933 
<a name="l09934"></a>09934             <a class="code" href="class_o_t_string.html">OTString</a> strRecipientNym;
<a name="l09935"></a>09935 
<a name="l09936"></a>09936             <span class="keywordflow">if</span> (NULL == pHisNymID)
<a name="l09937"></a>09937             {
<a name="l09938"></a>09938                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Recipient&#39;s Nym ID (full ID -- no partials here.) Blank IS allowed: &quot;</span>);
<a name="l09939"></a>09939 
<a name="l09940"></a>09940                 <span class="comment">// User input.</span>
<a name="l09941"></a>09941                 <span class="comment">// I need a from account</span>
<a name="l09942"></a>09942                 strRecipientNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09943"></a>09943 
<a name="l09944"></a>09944                 <span class="comment">//          if (strRecipientNym.GetLength() &lt; 2) // blank cheques are allowed.</span>
<a name="l09945"></a>09945                 <span class="comment">//              return (-1);            </span>
<a name="l09946"></a>09946             }
<a name="l09947"></a>09947             <span class="keywordflow">else</span>
<a name="l09948"></a>09948             {
<a name="l09949"></a>09949                 pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strRecipientNym);
<a name="l09950"></a>09950             }
<a name="l09951"></a>09951 
<a name="l09952"></a>09952             <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>
<a name="l09953"></a>09953 
<a name="l09954"></a>09954             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);
<a name="l09955"></a>09955 
<a name="l09956"></a>09956             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strRecipientNym);
<a name="l09957"></a>09957 
<a name="l09958"></a>09958             <span class="comment">// ----------------------------------------------   </span>
<a name="l09959"></a>09959             <a class="code" href="class_o_t_string.html">OTString</a> strAmount;
<a name="l09960"></a>09960             <span class="keywordflow">if</span> (0 == lTransactionAmount)
<a name="l09961"></a>09961             {
<a name="l09962"></a>09962                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter an amount: &quot;</span>);
<a name="l09963"></a>09963                 <span class="comment">// User input.</span>
<a name="l09964"></a>09964                 <span class="comment">// I need an amount</span>
<a name="l09965"></a>09965                 strAmount.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09966"></a>09966             }
<a name="l09967"></a>09967 
<a name="l09968"></a>09968             <span class="keyword">const</span> int64_t lTotalAmount  = (0 == lTransactionAmount) ?  <span class="comment">// If nothing was passed in, then use atol(strAmount), </span>
<a name="l09969"></a>09969                 (atol(strAmount.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strAmount.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;0&quot;</span>)) : lTransactionAmount; <span class="comment">// otherwise lTransactionAmount.</span>
<a name="l09970"></a>09970             <span class="comment">// ----------------------------------------------</span>
<a name="l09971"></a>09971 
<a name="l09972"></a>09972             <span class="comment">// To write a cheque, we need to burn one of our transaction numbers. (Presumably the wallet</span>
<a name="l09973"></a>09973             <span class="comment">// is also storing a couple of these, since they are needed to perform any transaction.)</span>
<a name="l09974"></a>09974             <span class="comment">//</span>
<a name="l09975"></a>09975             <span class="comment">// I don&#39;t have to contact the server to write a cheque -- as long as I already have a transaction</span>
<a name="l09976"></a>09976             <span class="comment">// number I can use to write it. Otherwise I&#39;d have to ask the server to send me one first.</span>
<a name="l09977"></a>09977 
<a name="l09978"></a>09978             int64_t lTransactionNumber=0;
<a name="l09979"></a>09979 
<a name="l09980"></a>09980             <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(theNym, strServerID, lTransactionNumber))
<a name="l09981"></a>09981             {
<a name="l09982"></a>09982                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Cheques are written offline, but you still need a transaction number\n&quot;</span>
<a name="l09983"></a>09983                     <span class="stringliteral">&quot;(and you have none, currently.) Try using &#39;n&#39; to request another transaction number.\n&quot;</span>);
<a name="l09984"></a>09984                 <span class="keywordflow">return</span> (-1);
<a name="l09985"></a>09985             }
<a name="l09986"></a>09986 
<a name="l09987"></a>09987 
<a name="l09988"></a>09988             <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>(), pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
<a name="l09989"></a>09989 
<a name="l09990"></a>09990             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09991"></a>09991 
<a name="l09992"></a>09992             <span class="comment">// Memo</span>
<a name="l09993"></a>09993             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo for your check: &quot;</span>);
<a name="l09994"></a>09994             <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo;
<a name="l09995"></a>09995             strChequeMemo.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l09996"></a>09996 
<a name="l09997"></a>09997             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09998"></a>09998 
<a name="l09999"></a>09999             <span class="comment">// Valid date range (in seconds)</span>
<a name="l10000"></a>10000             OTLog::Output(0, 
<a name="l10001"></a>10001                 <span class="stringliteral">&quot; 6 minutes ==      360 Seconds\n&quot;</span>
<a name="l10002"></a>10002                 <span class="stringliteral">&quot;10 minutes ==      600 Seconds\n&quot;</span>
<a name="l10003"></a>10003                 <span class="stringliteral">&quot;1 hour     ==     3600 Seconds\n&quot;</span>
<a name="l10004"></a>10004                 <span class="stringliteral">&quot;1 day      ==    86400 Seconds\n&quot;</span>
<a name="l10005"></a>10005                 <span class="stringliteral">&quot;30 days    ==  2592000 Seconds\n&quot;</span>
<a name="l10006"></a>10006                 <span class="stringliteral">&quot;3 months   ==  7776000 Seconds\n&quot;</span>
<a name="l10007"></a>10007                 <span class="stringliteral">&quot;6 months   == 15552000 Seconds\n\n&quot;</span>
<a name="l10008"></a>10008                 );
<a name="l10009"></a>10009 
<a name="l10010"></a>10010             int64_t lExpirationInSeconds = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ace532edc311602e99a6821d417fec988">OT_TIME_HOUR_IN_SECONDS</a>);
<a name="l10011"></a>10011             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;How many seconds before cheque expires? (defaults to 1 hour: %lld): &quot;</span>, lExpirationInSeconds);
<a name="l10012"></a>10012             <a class="code" href="class_o_t_string.html">OTString</a> strTemp;
<a name="l10013"></a>10013             strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10014"></a>10014 
<a name="l10015"></a>10015             <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
<a name="l10016"></a>10016                 lExpirationInSeconds = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10017"></a>10017 
<a name="l10018"></a>10018 
<a name="l10019"></a>10019             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10020"></a>10020 
<a name="l10021"></a>10021             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
<a name="l10022"></a>10022 
<a name="l10023"></a>10023             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Cheque may be cashed STARTING date (defaults to now, in seconds) [%lld]: &quot;</span>, VALID_FROM);
<a name="l10024"></a>10024             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10025"></a>10025             strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10026"></a>10026 
<a name="l10027"></a>10027             <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2)
<a name="l10028"></a>10028                 VALID_FROM = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10029"></a>10029 
<a name="l10030"></a>10030 
<a name="l10031"></a>10031             <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, lExpirationInSeconds); <span class="comment">// now + 3600</span>
<a name="l10032"></a>10032 
<a name="l10033"></a>10033             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10034"></a>10034 
<a name="l10035"></a>10035             <span class="keywordtype">bool</span> bIssueCheque = theCheque.IssueCheque(lTotalAmount, lTransactionNumber, VALID_FROM, VALID_TO, 
<a name="l10036"></a>10036                 ACCOUNT_ID, MY_NYM_ID, strChequeMemo,
<a name="l10037"></a>10037                 (strRecipientNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) ? &amp;(HIS_NYM_ID) : NULL); <span class="comment">// blank cheques are allowed.</span>
<a name="l10038"></a>10038 
<a name="l10039"></a>10039             <span class="keywordflow">if</span> (bIssueCheque)
<a name="l10040"></a>10040             {
<a name="l10041"></a>10041                 theCheque.SignContract(theNym);
<a name="l10042"></a>10042                 theCheque.SaveContract();
<a name="l10043"></a>10043 
<a name="l10044"></a>10044                 <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);
<a name="l10045"></a>10045 
<a name="l10046"></a>10046                 OTLog::Output(0, <span class="stringliteral">&quot;\n\nOUTPUT (writeCheque):\n\n\n&quot;</span>);
<a name="l10047"></a>10047                 <span class="comment">// OTLog::Output actually goes to stderr, whereas the cout below is actually sent to standard output.</span>
<a name="l10048"></a>10048                 std::cout &lt;&lt; strCheque.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;
<a name="l10049"></a>10049             }
<a name="l10050"></a>10050             <span class="keywordflow">else</span> 
<a name="l10051"></a>10051             {
<a name="l10052"></a>10052                 OTLog::Output(0, <span class="stringliteral">&quot;Failed trying to issue the cheque!\n&quot;</span>);
<a name="l10053"></a>10053 
<a name="l10054"></a>10054                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l10055"></a>10055                 theNym.<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(theNym, strServerID, lTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true                              </span>
<a name="l10056"></a>10056             }
<a name="l10057"></a>10057 
<a name="l10058"></a>10058             <span class="keywordflow">return</span> -1;
<a name="l10059"></a>10059         }
<a name="l10060"></a>10060 
<a name="l10061"></a>10061         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l10062"></a>10062 
<a name="l10063"></a>10063         <span class="keywordflow">break</span>;
<a name="l10064"></a>10064     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a2e9a6e919c7ee32a962aaf24b1ffb697">OTClient::proposePaymentPlan</a> : <span class="comment">// Propose a payment plan (sends no message to server.)</span>
<a name="l10065"></a>10065         {   
<a name="l10066"></a>10066             <a class="code" href="class_o_t_string.html">OTString</a> strMerchantAcct;
<a name="l10067"></a>10067 
<a name="l10068"></a>10068             <span class="keywordflow">if</span> (NULL == pAccount)
<a name="l10069"></a>10069             {
<a name="l10070"></a>10070                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;You are the Merchant, proposing this payment plan so your customer can confirm it.\n&quot;</span>
<a name="l10071"></a>10071                     <span class="stringliteral">&quot;After this command, use &#39;confirm&#39; (customer) to confirm it, and then activate it using\n&quot;</span>
<a name="l10072"></a>10072                     <span class="stringliteral">&quot;&#39;plan&#39; (customer) from the OT prompt, or &#39;--activateplan&#39; from the command line.\n\n&quot;</span>
<a name="l10073"></a>10073                     <span class="stringliteral">&quot;Enter the Merchant&#39;s (your) Asset Account ID that the payments will go to: &quot;</span>);
<a name="l10074"></a>10074                 <span class="comment">// User input.</span>
<a name="l10075"></a>10075                 <span class="comment">// I need a from account</span>
<a name="l10076"></a>10076                 strMerchantAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10077"></a>10077 
<a name="l10078"></a>10078                 <span class="keywordflow">if</span> (strMerchantAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l10079"></a>10079                     <span class="keywordflow">return</span> -1;
<a name="l10080"></a>10080 
<a name="l10081"></a>10081                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(strMerchantAcct);
<a name="l10082"></a>10082 
<a name="l10083"></a>10083                 <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID)) != NULL)
<a name="l10084"></a>10084                 {
<a name="l10085"></a>10085                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strMerchantAcct);
<a name="l10086"></a>10086                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l10087"></a>10087                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l10088"></a>10088                 }
<a name="l10089"></a>10089                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(strMerchantAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())) != NULL)
<a name="l10090"></a>10090                 {
<a name="l10091"></a>10091                     pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strMerchantAcct);
<a name="l10092"></a>10092                     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l10093"></a>10093                     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l10094"></a>10094                 }
<a name="l10095"></a>10095                 <span class="keywordflow">else</span>
<a name="l10096"></a>10096                 {
<a name="l10097"></a>10097                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to propose payment plan without account to pay to. Try adding:  --myacct ACCOUNT_ID\n&quot;</span>);
<a name="l10098"></a>10098                     <span class="keywordflow">return</span> -1;
<a name="l10099"></a>10099                 }
<a name="l10100"></a>10100             }
<a name="l10101"></a>10101             <span class="keywordflow">else</span>
<a name="l10102"></a>10102             {
<a name="l10103"></a>10103                 pAccount-&gt;<a class="code" href="class_o_t_contract.html#acf77d2db6da3904aa8b03e7b87c02e4e">GetIdentifier</a>(strMerchantAcct);
<a name="l10104"></a>10104                 CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l10105"></a>10105                 CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l10106"></a>10106             }
<a name="l10107"></a>10107 
<a name="l10108"></a>10108             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_ACCT_ID(strMerchantAcct);
<a name="l10109"></a>10109 
<a name="l10110"></a>10110             <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID)
<a name="l10111"></a>10111             {
<a name="l10112"></a>10112                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTClient::ProcessUserCommand: pAccount-&gt;GetPurportedServerID() doesn&#39;t match SERVER_ID.\n&quot;</span>
<a name="l10113"></a>10113                     <span class="stringliteral">&quot;(Try adding:  --server SERVER_ID)\n&quot;</span>);
<a name="l10114"></a>10114                 <span class="keywordflow">return</span> -1;
<a name="l10115"></a>10115             }
<a name="l10116"></a>10116 
<a name="l10117"></a>10117             <span class="comment">// pAccount is the MERCHANT&#39;s (recipient) account. CONTRACT_ID is its ASSET_TYPE.</span>
<a name="l10118"></a>10118             <span class="comment">// strContractID is the string version of that. And strMerchantAcct is the string</span>
<a name="l10119"></a>10119             <span class="comment">// version of pAccount&#39;s ID.</span>
<a name="l10120"></a>10120             <span class="comment">// theNym, FYI, is the Merchant&#39;s Nym.</span>
<a name="l10121"></a>10121 
<a name="l10122"></a>10122             <span class="comment">// -----------------------------------------------------</span>
<a name="l10123"></a>10123 
<a name="l10124"></a>10124             <a class="code" href="class_o_t_string.html">OTString</a> strCustomerAcct;
<a name="l10125"></a>10125 
<a name="l10126"></a>10126             <span class="keywordflow">if</span> (NULL == pHisAcctID)
<a name="l10127"></a>10127             {
<a name="l10128"></a>10128                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Customer&#39;s Asset Account ID that payments will come FROM (no partials): &quot;</span>);
<a name="l10129"></a>10129 
<a name="l10130"></a>10130                 <span class="comment">// User input.</span>
<a name="l10131"></a>10131                 <span class="comment">// I need a from account</span>
<a name="l10132"></a>10132                 strCustomerAcct.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10133"></a>10133 
<a name="l10134"></a>10134                 <span class="keywordflow">if</span> (strCustomerAcct.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l10135"></a>10135                     <span class="keywordflow">return</span> -1;          
<a name="l10136"></a>10136             }
<a name="l10137"></a>10137             <span class="keywordflow">else</span>
<a name="l10138"></a>10138             {
<a name="l10139"></a>10139                 pHisAcctID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strCustomerAcct);            
<a name="l10140"></a>10140             }
<a name="l10141"></a>10141 
<a name="l10142"></a>10142             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_ACCT_ID(strCustomerAcct);
<a name="l10143"></a>10143 
<a name="l10144"></a>10144             <span class="comment">// HIS_ACCT_ID is the Customer&#39;s asset account id.</span>
<a name="l10145"></a>10145             <span class="comment">// strCustomerAcct is the OTString version of that.</span>
<a name="l10146"></a>10146             <span class="comment">// -----------------------------------------------------</span>
<a name="l10147"></a>10147 
<a name="l10148"></a>10148             <a class="code" href="class_o_t_string.html">OTString</a> strCustomerNym;
<a name="l10149"></a>10149 
<a name="l10150"></a>10150             <span class="keywordflow">if</span> (NULL == pHisNymID)
<a name="l10151"></a>10151             {
<a name="l10152"></a>10152                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter Customer&#39;s Nym ID (full ID -- no partials here): &quot;</span>);
<a name="l10153"></a>10153 
<a name="l10154"></a>10154                 <span class="comment">// User input.</span>
<a name="l10155"></a>10155                 <span class="comment">// I need a from account</span>
<a name="l10156"></a>10156                 strCustomerNym.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10157"></a>10157 
<a name="l10158"></a>10158                 <span class="keywordflow">if</span> (strCustomerNym.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt; 2)
<a name="l10159"></a>10159                     <span class="keywordflow">return</span> -1;          
<a name="l10160"></a>10160             }
<a name="l10161"></a>10161             <span class="keywordflow">else</span>
<a name="l10162"></a>10162             {
<a name="l10163"></a>10163                 pHisNymID-&gt;<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strCustomerNym);
<a name="l10164"></a>10164             }
<a name="l10165"></a>10165 
<a name="l10166"></a>10166             <span class="comment">// Todo add partial lookups here from wallet and/or address book.</span>
<a name="l10167"></a>10167 
<a name="l10168"></a>10168             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MY_NYM_ID(theNym);
<a name="l10169"></a>10169 
<a name="l10170"></a>10170             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> HIS_NYM_ID(strCustomerNym);
<a name="l10171"></a>10171 
<a name="l10172"></a>10172             <span class="comment">// HIS_NYM_ID is the Customer&#39;s nym id. MY_NYM_ID is the Merchant&#39;s.</span>
<a name="l10173"></a>10173             <span class="comment">// strCustomerNym is the OTString version of HIS_NYM_ID.</span>
<a name="l10174"></a>10174             <span class="comment">// -----------------------------------------------------</span>
<a name="l10175"></a>10175 
<a name="l10176"></a>10176             <a class="code" href="class_o_t_string.html">OTString</a> strConsideration, strTemp;
<a name="l10177"></a>10177 
<a name="l10178"></a>10178             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Enter a memo describing consideration for the payment plan: &quot;</span>);
<a name="l10179"></a>10179             strConsideration.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);     
<a name="l10180"></a>10180 
<a name="l10181"></a>10181             <span class="comment">// To write a payment plan, like a cheque, we need to burn one of our transaction numbers. (Presumably</span>
<a name="l10182"></a>10182             <span class="comment">// the wallet is also storing a couple of these, since they are needed to perform any transaction.)</span>
<a name="l10183"></a>10183             <span class="comment">//</span>
<a name="l10184"></a>10184             <span class="comment">// I don&#39;t have to contact the server to write a payment plan -- as long as I already have a transaction</span>
<a name="l10185"></a>10185             <span class="comment">// number I can use to write it. Otherwise I&#39;d have to ask the server to send me one first.</span>
<a name="l10186"></a>10186 
<a name="l10187"></a>10187             <span class="keywordflow">if</span> (theNym.<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(strServerID) &lt; 2)
<a name="l10188"></a>10188             {
<a name="l10189"></a>10189                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Payment Plans are written offline, but you still need a 2 transaction numbers\n&quot;</span>
<a name="l10190"></a>10190                     <span class="stringliteral">&quot;(and you don&#39;t, currently.) Try using &#39;n&#39; to request another transaction number.\n&quot;</span>);
<a name="l10191"></a>10191                 <span class="keywordflow">return</span> -1;
<a name="l10192"></a>10192             }
<a name="l10193"></a>10193 
<a name="l10194"></a>10194             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10195"></a>10195 
<a name="l10196"></a>10196             <span class="comment">/*</span>
<a name="l10197"></a>10197 <span class="comment">            OTPaymentPlan( const OTIdentifier &amp; SERVER_ID,          const OTIdentifier &amp; ASSET_ID,</span>
<a name="l10198"></a>10198 <span class="comment">            const OTIdentifier &amp; SENDER_ACCT_ID,    const OTIdentifier &amp; SENDER_USER_ID,</span>
<a name="l10199"></a>10199 <span class="comment">            const OTIdentifier &amp; RECIPIENT_ACCT_ID, const OTIdentifier &amp; RECIPIENT_USER_ID);</span>
<a name="l10200"></a>10200 <span class="comment"></span>
<a name="l10201"></a>10201 <span class="comment">            */</span>
<a name="l10202"></a>10202             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>(), pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>(),
<a name="l10203"></a>10203                 HIS_ACCT_ID,  HIS_NYM_ID,
<a name="l10204"></a>10204                 MY_ACCT_ID,   MY_NYM_ID);
<a name="l10205"></a>10205 
<a name="l10206"></a>10206             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10207"></a>10207 
<a name="l10208"></a>10208             <span class="comment">// Valid date range (in seconds)</span>
<a name="l10209"></a>10209             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, 
<a name="l10210"></a>10210                 <span class="stringliteral">&quot; 6 minutes ==      360 Seconds\n&quot;</span>
<a name="l10211"></a>10211                 <span class="stringliteral">&quot;10 minutes ==      600 Seconds\n&quot;</span>
<a name="l10212"></a>10212                 <span class="stringliteral">&quot;1 hour     ==     3600 Seconds\n&quot;</span>
<a name="l10213"></a>10213                 <span class="stringliteral">&quot;1 day      ==    86400 Seconds\n&quot;</span>
<a name="l10214"></a>10214                 <span class="stringliteral">&quot;30 days            ==  2592000 Seconds\n&quot;</span>
<a name="l10215"></a>10215                 <span class="stringliteral">&quot;3 months       ==  7776000 Seconds\n&quot;</span>
<a name="l10216"></a>10216                 <span class="stringliteral">&quot;6 months       == 15552000 Seconds\n\n&quot;</span>
<a name="l10217"></a>10217                 );
<a name="l10218"></a>10218 
<a name="l10219"></a>10219             int64_t lExpirationInSeconds = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ae431139997436f8522341a67e64d0d32">OT_TIME_DAY_IN_SECONDS</a>);
<a name="l10220"></a>10220             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;How many seconds before payment plan expires? (defaults to 1 day: %lld): &quot;</span>, 
<a name="l10221"></a>10221                 lExpirationInSeconds);
<a name="l10222"></a>10222             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10223"></a>10223             strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10224"></a>10224 
<a name="l10225"></a>10225             <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
<a name="l10226"></a>10226                 lExpirationInSeconds = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10227"></a>10227 
<a name="l10228"></a>10228 
<a name="l10229"></a>10229             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10230"></a>10230 
<a name="l10231"></a>10231             <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
<a name="l10232"></a>10232 
<a name="l10233"></a>10233             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Payment plan becomes valid for processing STARTING date\n&quot;</span>
<a name="l10234"></a>10234                 <span class="stringliteral">&quot;(defaults to now, in seconds) [%lld]: &quot;</span>, VALID_FROM);
<a name="l10235"></a>10235             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10236"></a>10236             strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10237"></a>10237 
<a name="l10238"></a>10238             <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2)
<a name="l10239"></a>10239                 VALID_FROM = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10240"></a>10240 
<a name="l10241"></a>10241             <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, lExpirationInSeconds); <span class="comment">// now + 86400</span>
<a name="l10242"></a>10242 
<a name="l10243"></a>10243             <span class="comment">// ************************************************************************</span>
<a name="l10244"></a>10244             <span class="comment">// This pulls two transaction numbers off of pMerchantNym.</span>
<a name="l10245"></a>10245             <span class="comment">// (So we have to put them back if there is some early failure and crap-out...)</span>
<a name="l10246"></a>10246             <span class="comment">//</span>
<a name="l10247"></a>10247             <span class="keywordtype">bool</span> bSuccessSetAgreement = thePlan.SetProposal(theNym, strConsideration, VALID_FROM, VALID_TO);
<a name="l10248"></a>10248 
<a name="l10249"></a>10249             <span class="keywordflow">if</span> (!bSuccessSetAgreement)
<a name="l10250"></a>10250             {
<a name="l10251"></a>10251                 OTLog::Output(0, <span class="stringliteral">&quot;Failed trying to set the proposal!\n&quot;</span>);
<a name="l10252"></a>10252 
<a name="l10253"></a>10253                 <span class="keywordflow">return</span> -1;
<a name="l10254"></a>10254             }
<a name="l10255"></a>10255             <span class="comment">// ************************************************************************</span>
<a name="l10256"></a>10256 
<a name="l10257"></a>10257             <span class="keywordtype">bool</span> bSuccessSetInitialPayment  = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to even have this payment.</span>
<a name="l10258"></a>10258             <span class="keywordtype">bool</span> bSuccessSetPaymentPlan     = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to have a payment plan</span>
<a name="l10259"></a>10259 
<a name="l10260"></a>10260             OTLog::Output(0, <span class="stringliteral">&quot;What is the Initial Payment Amount, if any? [0]: &quot;</span>);
<a name="l10261"></a>10261             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10262"></a>10262             int64_t lInitialPayment = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10263"></a>10263 
<a name="l10264"></a>10264             <span class="keywordflow">if</span> (lInitialPayment &gt; 0)
<a name="l10265"></a>10265             {
<a name="l10266"></a>10266                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a0267b9efa7d67ca819f176d0a234213f">OT_TIME_MINUTE_IN_SECONDS</a>; <span class="comment">// 60 seconds.</span>
<a name="l10267"></a>10267 
<a name="l10268"></a>10268                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From the Start Date forward, how int64_t until the Initial Payment should charge?\n&quot;</span>
<a name="l10269"></a>10269                     <span class="stringliteral">&quot;(defaults to one minute, in seconds) [%d]: &quot;</span>, PAYMENT_DELAY);
<a name="l10270"></a>10270                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10271"></a>10271                 strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10272"></a>10272 
<a name="l10273"></a>10273                 <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
<a name="l10274"></a>10274                     PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10275"></a>10275 
<a name="l10276"></a>10276                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10277"></a>10277 
<a name="l10278"></a>10278                 bSuccessSetInitialPayment = thePlan.SetInitialPayment(lInitialPayment, PAYMENT_DELAY);
<a name="l10279"></a>10279             }
<a name="l10280"></a>10280 
<a name="l10281"></a>10281             <span class="keywordflow">if</span> (!bSuccessSetInitialPayment)
<a name="l10282"></a>10282             {
<a name="l10283"></a>10283                 OTLog::Output(0, <span class="stringliteral">&quot;Failed trying to set the initial payment!\n&quot;</span>);
<a name="l10284"></a>10284 
<a name="l10285"></a>10285                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l10286"></a>10286                 thePlan.HarvestClosingNumbers(theNym); <span class="comment">// puts the relevant numbers back onto Nym.</span>
<a name="l10287"></a>10287 
<a name="l10288"></a>10288                 <span class="keywordflow">return</span> -1;
<a name="l10289"></a>10289             }
<a name="l10290"></a>10290 
<a name="l10291"></a>10291             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10292"></a>10292 
<a name="l10293"></a>10293             OTLog::Output(0, <span class="stringliteral">&quot;What is the regular payment amount, if any? [0]: &quot;</span>);
<a name="l10294"></a>10294             strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10295"></a>10295             int64_t lRegularPayment = atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10296"></a>10296 
<a name="l10297"></a>10297             <span class="keywordflow">if</span> (lRegularPayment &gt; 0) <span class="comment">// If there are regular payments.</span>
<a name="l10298"></a>10298             {
<a name="l10299"></a>10299                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10300"></a>10300 
<a name="l10301"></a>10301                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(120); <span class="comment">// 120 seconds.</span>
<a name="l10302"></a>10302 
<a name="l10303"></a>10303                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From the Start Date forward, how int64_t until the Regular Payments start?\n&quot;</span>
<a name="l10304"></a>10304                     <span class="stringliteral">&quot;(defaults to two minutes, in seconds) [%d]: &quot;</span>, PAYMENT_DELAY);
<a name="l10305"></a>10305                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10306"></a>10306                 strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10307"></a>10307 
<a name="l10308"></a>10308                 <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
<a name="l10309"></a>10309                     PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10310"></a>10310 
<a name="l10311"></a>10311                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10312"></a>10312 
<a name="l10313"></a>10313                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_PERIOD = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(30); <span class="comment">// 30 seconds.</span>
<a name="l10314"></a>10314 
<a name="l10315"></a>10315                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Once payments begin, how much time should elapse between each payment?\n&quot;</span>
<a name="l10316"></a>10316                     <span class="stringliteral">&quot;(defaults to thirty seconds) [%d]: &quot;</span>, PAYMENT_PERIOD);
<a name="l10317"></a>10317                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10318"></a>10318                 strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10319"></a>10319 
<a name="l10320"></a>10320                 <span class="keywordflow">if</span> ((strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1) &amp;&amp; atol(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>())&gt;0)
<a name="l10321"></a>10321                     PAYMENT_PERIOD = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10322"></a>10322 
<a name="l10323"></a>10323                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10324"></a>10324 
<a name="l10325"></a>10325                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> PLAN_LENGTH = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>; <span class="comment">// 0 seconds (for no max length).</span>
<a name="l10326"></a>10326 
<a name="l10327"></a>10327                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;From start date, do you want the plan to expire after a certain maximum time?\n&quot;</span>
<a name="l10328"></a>10328                     <span class="stringliteral">&quot;(defaults to 0 for no) [%d]: &quot;</span>, PLAN_LENGTH);
<a name="l10329"></a>10329                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10330"></a>10330                 strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10331"></a>10331 
<a name="l10332"></a>10332                 <span class="keywordflow">if</span> (strTemp.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 1)
<a name="l10333"></a>10333                     PLAN_LENGTH = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10334"></a>10334 
<a name="l10335"></a>10335                 <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10336"></a>10336 
<a name="l10337"></a>10337                 OTLog::Output(0, <span class="stringliteral">&quot;Should there be some maximum number of payments? (Zero for no maximum.) [0]: &quot;</span>);
<a name="l10338"></a>10338                 strTemp.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); strTemp.<a class="code" href="class_o_t_string.html#a13fb6736596f57c6052851c29268f2a8">OTfgets</a>(std::cin);
<a name="l10339"></a>10339                 int32_t nMaxPayments = atoi(strTemp.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10340"></a>10340 
<a name="l10341"></a>10341                 bSuccessSetPaymentPlan = thePlan.SetPaymentPlan(lRegularPayment, PAYMENT_DELAY, 
<a name="l10342"></a>10342                     PAYMENT_PERIOD, PLAN_LENGTH, nMaxPayments);
<a name="l10343"></a>10343             }
<a name="l10344"></a>10344 
<a name="l10345"></a>10345             <span class="keywordflow">if</span> (!bSuccessSetPaymentPlan)
<a name="l10346"></a>10346             {
<a name="l10347"></a>10347                 OTLog::Output(0, <span class="stringliteral">&quot;Failed trying to set the payment plan!\n&quot;</span>);
<a name="l10348"></a>10348 
<a name="l10349"></a>10349                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l10350"></a>10350                 thePlan.HarvestClosingNumbers(theNym); <span class="comment">// puts the relevant numbers back onto Nym.</span>
<a name="l10351"></a>10351 
<a name="l10352"></a>10352                 <span class="keywordflow">return</span> -1;
<a name="l10353"></a>10353             }
<a name="l10354"></a>10354 
<a name="l10355"></a>10355             thePlan.SignContract(theNym);
<a name="l10356"></a>10356             thePlan.SaveContract();
<a name="l10357"></a>10357 
<a name="l10358"></a>10358             <a class="code" href="class_o_t_string.html">OTString</a> strPlan(thePlan);
<a name="l10359"></a>10359 
<a name="l10360"></a>10360             OTLog::Output(0, <span class="stringliteral">&quot;\n\n(Make sure to have your Customer &#39;confirm&#39; the payment plan, before he activates it at &quot;</span>
<a name="l10361"></a>10361                 <span class="stringliteral">&quot;the server using the &#39;plan&#39; command in the OT prompt, or --activateplan at the command-line):\n\n&quot;</span>);
<a name="l10362"></a>10362 
<a name="l10363"></a>10363             std::cout &lt;&lt; strPlan.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;
<a name="l10364"></a>10364 
<a name="l10365"></a>10365             <span class="keywordflow">return</span> 0; <span class="comment">// sends no server message in this case.</span>
<a name="l10366"></a>10366         }
<a name="l10367"></a>10367 
<a name="l10368"></a>10368         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l10369"></a>10369 
<a name="l10370"></a>10370         <span class="keywordflow">break</span>;
<a name="l10371"></a>10371     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a901ce90148ddf82944a19bc4338682ad">OTClient::confirmPaymentPlan</a>: <span class="comment">// Confirm a payment plan (sends no message to server.)</span>
<a name="l10372"></a>10372         {   
<a name="l10373"></a>10373             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;(You are the customer, confirming a payment plan that the merchant has just sent you.)\n\n&quot;</span>);
<a name="l10374"></a>10374 
<a name="l10375"></a>10375             <span class="comment">// -----------------------------------------------</span>
<a name="l10376"></a>10376 
<a name="l10377"></a>10377             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan;
<a name="l10378"></a>10378 
<a name="l10379"></a>10379             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext payment plan. Terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l10380"></a>10380             <a class="code" href="class_o_t_string.html">OTString</a> strPlan;
<a name="l10381"></a>10381             <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>
<a name="l10382"></a>10382 
<a name="l10383"></a>10383             <span class="keywordflow">do</span> {
<a name="l10384"></a>10384                 decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>
<a name="l10385"></a>10385 
<a name="l10386"></a>10386                 <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
<a name="l10387"></a>10387                     (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l10388"></a>10388                 {
<a name="l10389"></a>10389                     strPlan.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l10390"></a>10390                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l10391"></a>10391                 }
<a name="l10392"></a>10392                 <span class="keywordflow">else</span> 
<a name="l10393"></a>10393                 {
<a name="l10394"></a>10394                     <span class="keywordflow">break</span>;
<a name="l10395"></a>10395                 }
<a name="l10396"></a>10396 
<a name="l10397"></a>10397             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l10398"></a>10398 
<a name="l10399"></a>10399 
<a name="l10400"></a>10400             <span class="keywordflow">if</span> (!thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPlan))
<a name="l10401"></a>10401             {
<a name="l10402"></a>10402                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load payment plan from string.\n&quot;</span>);
<a name="l10403"></a>10403                 <span class="keywordflow">return</span> -1;
<a name="l10404"></a>10404             }
<a name="l10405"></a>10405 
<a name="l10406"></a>10406             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10407"></a>10407 
<a name="l10408"></a>10408             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pCustomerNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(thePlan.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>());
<a name="l10409"></a>10409 
<a name="l10410"></a>10410             <span class="keywordflow">if</span> (NULL == pCustomerNym)
<a name="l10411"></a>10411             {
<a name="l10412"></a>10412                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;The customer Nym on this payment plan (you, supposedly) wasn&#39;t found in the wallet. Try &#39;load&#39;.\n&quot;</span>);
<a name="l10413"></a>10413                 <span class="keywordflow">return</span> -1;
<a name="l10414"></a>10414             }
<a name="l10415"></a>10415             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10416"></a>10416             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pMerchantNym = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(thePlan.<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>());
<a name="l10417"></a>10417 
<a name="l10418"></a>10418             <span class="comment">//      if (NULL == pMerchantNym)</span>
<a name="l10419"></a>10419             <span class="comment">//      {</span>
<a name="l10420"></a>10420             <span class="comment">//          OTLog::Output(0, &quot;Merchant Nym wasn&#39;t found in the wallet. Try &#39;load&#39;.\n&quot;);</span>
<a name="l10421"></a>10421             <span class="comment">//          // TODO add lookups from address book here as well?</span>
<a name="l10422"></a>10422             <span class="comment">//          return -1;</span>
<a name="l10423"></a>10423             <span class="comment">//      }</span>
<a name="l10424"></a>10424             <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l10425"></a>10425             <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePlan.<a class="code" href="class_o_t_agreement.html#aa58d2054b933bffe9c2b2ca5564b7f49">Confirm</a>(*pCustomerNym, pMerchantNym, &amp;thePlan.<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>()))
<a name="l10426"></a>10426             {
<a name="l10427"></a>10427                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Error while confirming payment plan. Sorry.\n&quot;</span>);
<a name="l10428"></a>10428                 <span class="keywordflow">return</span> -1;
<a name="l10429"></a>10429             }
<a name="l10430"></a>10430 
<a name="l10431"></a>10431             thePlan.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pCustomerNym);
<a name="l10432"></a>10432             thePlan.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10433"></a>10433 
<a name="l10434"></a>10434             <a class="code" href="class_o_t_string.html">OTString</a> strOutput(thePlan);
<a name="l10435"></a>10435 
<a name="l10436"></a>10436             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n\nMake sure to submit the payment plan to the server, to activate it:\n\n&quot;</span>);
<a name="l10437"></a>10437 
<a name="l10438"></a>10438             <span class="comment">// The above OTLog::Output() actually outputs to stderr (cerr). That&#39;s on purpose.</span>
<a name="l10439"></a>10439             <span class="comment">// But the below output actually outputs to stdout, which is also on purpose.</span>
<a name="l10440"></a>10440             <span class="comment">//</span>
<a name="l10441"></a>10441             std::cout &lt;&lt; strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() &lt;&lt; std::endl;
<a name="l10442"></a>10442 
<a name="l10443"></a>10443             <span class="keywordflow">return</span> 0; <span class="comment">// no server message being sent, in this case.</span>
<a name="l10444"></a>10444         }
<a name="l10445"></a>10445 
<a name="l10446"></a>10446         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l10447"></a>10447 
<a name="l10448"></a>10448         <span class="keywordflow">break</span>;
<a name="l10449"></a>10449     <span class="keywordflow">case</span> <a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ab70cae2211349300334a71529c942b75">OTClient::paymentPlan</a>: <span class="comment">// Activate a PAYMENT PLAN</span>
<a name="l10450"></a>10450         {   
<a name="l10451"></a>10451             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> USER_ID(theNym);
<a name="l10452"></a>10452 
<a name="l10453"></a>10453             <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> thePlan;
<a name="l10454"></a>10454 
<a name="l10455"></a>10455             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Please enter plaintext payment plan. Terminate with ~ on a new line:\n&gt; &quot;</span>);
<a name="l10456"></a>10456             <a class="code" href="class_o_t_string.html">OTString</a> strPlan;
<a name="l10457"></a>10457             <span class="keywordtype">char</span> decode_buffer[200]; <span class="comment">// Safe since we only read sizeof(decode_buffer)-1</span>
<a name="l10458"></a>10458 
<a name="l10459"></a>10459             <span class="keywordflow">do</span> {
<a name="l10460"></a>10460                 decode_buffer[0] = 0; <span class="comment">// Make it fresh.</span>
<a name="l10461"></a>10461 
<a name="l10462"></a>10462                 <span class="keywordflow">if</span> ((NULL != fgets(decode_buffer, <span class="keyword">sizeof</span>(decode_buffer)-1, stdin)) &amp;&amp;
<a name="l10463"></a>10463                     (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>))
<a name="l10464"></a>10464                 {
<a name="l10465"></a>10465                     strPlan.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, decode_buffer);
<a name="l10466"></a>10466                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l10467"></a>10467                 }
<a name="l10468"></a>10468                 <span class="keywordflow">else</span> 
<a name="l10469"></a>10469                 {
<a name="l10470"></a>10470                     <span class="keywordflow">break</span>;
<a name="l10471"></a>10471                 }
<a name="l10472"></a>10472 
<a name="l10473"></a>10473             } <span class="keywordflow">while</span> (decode_buffer[0] != <span class="charliteral">&#39;~&#39;</span>);
<a name="l10474"></a>10474 
<a name="l10475"></a>10475 
<a name="l10476"></a>10476             <span class="keywordflow">if</span> (thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPlan))
<a name="l10477"></a>10477             {
<a name="l10478"></a>10478                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> ACCOUNT_ID(thePlan.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>());
<a name="l10479"></a>10479 
<a name="l10480"></a>10480                 <a class="code" href="class_o_t_account.html">OTAccount</a> * pSenderAccount = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(ACCOUNT_ID);
<a name="l10481"></a>10481 
<a name="l10482"></a>10482                 <span class="keywordflow">if</span> (NULL == pSenderAccount)
<a name="l10483"></a>10483                 {
<a name="l10484"></a>10484                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;There is no account loaded on this wallet with that sender acct ID, sorry.\n&quot;</span>);
<a name="l10485"></a>10485                 }
<a name="l10486"></a>10486                 <span class="keywordflow">if</span> ((NULL != pAccount) &amp;&amp; (pSenderAccount != pAccount))
<a name="l10487"></a>10487                 {
<a name="l10488"></a>10488                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;This Payment Plan is already confirmed, yet now you try to activate it, and you \n&quot;</span>
<a name="l10489"></a>10489                         <span class="stringliteral">&quot;have supplied a different account ID than the one that originally confirmed it.\n&quot;</span>
<a name="l10490"></a>10490                         <span class="stringliteral">&quot;Perhaps it&#39;s just an unfortunate default in your ~/.ot/command-line-ot.opt file.\n&quot;</span>
<a name="l10491"></a>10491                         <span class="stringliteral">&quot;Be explicit, and use:  --myacct &lt;acct_id&gt;\n&quot;</span>);
<a name="l10492"></a>10492                 }
<a name="l10493"></a>10493                 <span class="keywordflow">else</span>
<a name="l10494"></a>10494                 {   
<a name="l10495"></a>10495                     <a class="code" href="class_o_t_string.html">OTString</a> strFromAcct(ACCOUNT_ID);
<a name="l10496"></a>10496 
<a name="l10497"></a>10497                     <span class="comment">// Create a transaction</span>
<a name="l10498"></a>10498                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCOUNT_ID, SERVER_ID, 
<a name="l10499"></a>10499                         <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>, thePlan.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>()); 
<a name="l10500"></a>10500 
<a name="l10501"></a>10501                     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l10502"></a>10502                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);
<a name="l10503"></a>10503 
<a name="l10504"></a>10504                     strPlan.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l10505"></a>10505                     thePlan.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPlan);
<a name="l10506"></a>10506 
<a name="l10507"></a>10507                     <span class="comment">// Add the payment plan string as the attachment on the transaction item.</span>
<a name="l10508"></a>10508                     pItem-&gt;SetAttachment(strPlan); <span class="comment">// The payment plan is contained in the reference string.</span>
<a name="l10509"></a>10509 
<a name="l10510"></a>10510                     <span class="comment">// sign the item</span>
<a name="l10511"></a>10511                     pItem-&gt;SignContract(theNym);
<a name="l10512"></a>10512                     pItem-&gt;SaveContract();
<a name="l10513"></a>10513 
<a name="l10514"></a>10514                     <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l10515"></a>10515                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l10516"></a>10516 
<a name="l10517"></a>10517                     <span class="comment">// ---------------------------------------------</span>
<a name="l10518"></a>10518                     <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l10519"></a>10519 
<a name="l10520"></a>10520                     <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l10521"></a>10521                     <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = theNym.<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l10522"></a>10522 
<a name="l10523"></a>10523                     <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l10524"></a>10524                         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l10525"></a>10525 
<a name="l10526"></a>10526                     <span class="comment">// ---------------------------------------------</span>
<a name="l10527"></a>10527 
<a name="l10528"></a>10528                     <span class="comment">// sign the transaction</span>
<a name="l10529"></a>10529                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l10530"></a>10530                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10531"></a>10531 
<a name="l10532"></a>10532                     <span class="comment">// set up the ledger</span>
<a name="l10533"></a>10533                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCOUNT_ID, SERVER_ID);
<a name="l10534"></a>10534                     theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l10535"></a>10535                     theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l10536"></a>10536 
<a name="l10537"></a>10537                     <span class="comment">// sign the ledger</span>
<a name="l10538"></a>10538                     theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(theNym);
<a name="l10539"></a>10539                     theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10540"></a>10540 
<a name="l10541"></a>10541                     <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l10542"></a>10542                     <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l10543"></a>10543                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l10544"></a>10544 
<a name="l10545"></a>10545                     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10546"></a>10546                     theNym.<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l10547"></a>10547                     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10548"></a>10548                     theNym.<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(theNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10549"></a>10549 
<a name="l10550"></a>10550                     <span class="comment">// (1) Set up member variables </span>
<a name="l10551"></a>10551                     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l10552"></a>10552                     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10553"></a>10553                     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10554"></a>10554                     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(theNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10555"></a>10555 
<a name="l10556"></a>10556                     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l10557"></a>10557                     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l10558"></a>10558 
<a name="l10559"></a>10559                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10560"></a>10560                     <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10561"></a>10561                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l10562"></a>10562 
<a name="l10563"></a>10563                     <span class="keywordflow">if</span> (bNymboxHash)
<a name="l10564"></a>10564                         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10565"></a>10565                     <span class="keywordflow">else</span>
<a name="l10566"></a>10566                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10567"></a>10567                         str_server.c_str());
<a name="l10568"></a>10568 
<a name="l10569"></a>10569                     <span class="comment">// (2) Sign the Message </span>
<a name="l10570"></a>10570                     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);        
<a name="l10571"></a>10571 
<a name="l10572"></a>10572                     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10573"></a>10573                     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10574"></a>10574 
<a name="l10575"></a>10575                     bSendCommand = <span class="keyword">true</span>;
<a name="l10576"></a>10576                     lReturnValue = lRequestNumber;
<a name="l10577"></a>10577 
<a name="l10578"></a>10578                 } <span class="comment">// pAccount not NULL          </span>
<a name="l10579"></a>10579             } <span class="comment">// thePlan.LoadContractFromString()</span>
<a name="l10580"></a>10580             <span class="keywordflow">else</span> 
<a name="l10581"></a>10581             {
<a name="l10582"></a>10582                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load payment plan from string. Sorry.\n&quot;</span>);
<a name="l10583"></a>10583             }
<a name="l10584"></a>10584 
<a name="l10585"></a>10585         } <span class="comment">// else if (OTClient::paymentPlan == requestedCommand) // PAYMENT PLAN</span>
<a name="l10586"></a>10586 
<a name="l10587"></a>10587 
<a name="l10588"></a>10588         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l10589"></a>10589 
<a name="l10590"></a>10590         <span class="comment">/*</span>
<a name="l10591"></a>10591 <span class="comment">        else if (OTClient::withdrawTest == requestedCommand) // TEST OF TOKEN BLINDING. NOT PART OF THE REAL PROTOCOL.</span>
<a name="l10592"></a>10592 <span class="comment">        {   </span>
<a name="l10593"></a>10593 <span class="comment">        // (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10594"></a>10594 <span class="comment">        theNym.GetCurrentRequestNum(strServerID, lRequestNumber);</span>
<a name="l10595"></a>10595 <span class="comment">        theMessage.m_strRequestNum.Format(&quot;%lld&quot;, lRequestNumber); // Always have to send this.</span>
<a name="l10596"></a>10596 <span class="comment">        theNym.IncrementRequestNum(strServerID); // since I used it for a server request, I have to increment it</span>
<a name="l10597"></a>10597 <span class="comment"></span>
<a name="l10598"></a>10598 <span class="comment">        // (1) Set up member variables </span>
<a name="l10599"></a>10599 <span class="comment">        theMessage.m_strCommand         = &quot;debitAccount&quot;;</span>
<a name="l10600"></a>10600 <span class="comment">        theMessage.m_strNymID           = strNymID;</span>
<a name="l10601"></a>10601 <span class="comment">        theMessage.m_strServerID        = strServerID;</span>
<a name="l10602"></a>10602 <span class="comment">        theMessage.SetAcknowledgments(theNym); // Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10603"></a>10603 <span class="comment"></span>
<a name="l10604"></a>10604 <span class="comment">        theMessage.m_strAssetID         = strContractID;// the hash of the contract is the AssetID</span>
<a name="l10605"></a>10605 <span class="comment"></span>
<a name="l10606"></a>10606 <span class="comment">        // (2) Sign the Message </span>
<a name="l10607"></a>10607 <span class="comment">        OTContract &amp; aSigningDoc = theMessage;</span>
<a name="l10608"></a>10608 <span class="comment">        aSigningDoc.SignContract(theNym);       </span>
<a name="l10609"></a>10609 <span class="comment"></span>
<a name="l10610"></a>10610 <span class="comment">        // (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10611"></a>10611 <span class="comment">        theMessage.SaveContract();</span>
<a name="l10612"></a>10612 <span class="comment"></span>
<a name="l10613"></a>10613 <span class="comment">        bSendCommand = true;</span>
<a name="l10614"></a>10614 <span class="comment">        }</span>
<a name="l10615"></a>10615 <span class="comment">        */</span>
<a name="l10616"></a>10616         <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l10617"></a>10617         <span class="keywordflow">break</span>;
<a name="l10618"></a>10618 
<a name="l10619"></a>10619     <span class="keywordflow">default</span>:
<a name="l10620"></a>10620         {
<a name="l10621"></a>10621             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l10622"></a>10622         }
<a name="l10623"></a>10623     } <span class="comment">// Get out og the big switch statement!</span>
<a name="l10624"></a>10624 
<a name="l10625"></a>10625 
<a name="l10626"></a>10626     <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lReturnValue);
<a name="l10627"></a>10627 
<a name="l10628"></a>10628     <span class="comment">//  return bSendCommand;</span>
<a name="l10629"></a>10629 }
<a name="l10630"></a>10630 
<a name="l10631"></a>10631 
<a name="l10632"></a>10632 
<a name="l10633"></a>10633 
<a name="l10643"></a><a class="code" href="class_o_t_client.html#a77bd8f98f5d1a62e37e233b9542337a7">10643</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#a77bd8f98f5d1a62e37e233b9542337a7">OTClient::ConnectToTheFirstServerOnList</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l10644"></a>10644                                              <a class="code" href="class_o_t_string.html">OTString</a> &amp; strCA_FILE, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strKEY_FILE, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strKEY_PASSWORD)
<a name="l10645"></a>10645 {
<a name="l10646"></a>10646     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    SERVER_ID;
<a name="l10647"></a>10647     <a class="code" href="class_o_t_string.html">OTString</a>        SERVER_NAME;
<a name="l10648"></a>10648 
<a name="l10649"></a>10649     <span class="keywordflow">if</span> (m_pWallet &amp;&amp; m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aad6abb5e5fd19ffd69a9b6f0eb75f1c7">GetServer</a>(0, SERVER_ID, SERVER_NAME))
<a name="l10650"></a>10650     {
<a name="l10651"></a>10651         <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = m_pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(SERVER_ID);
<a name="l10652"></a>10652 
<a name="l10653"></a>10653         <span class="keywordflow">if</span> (NULL != pServer)
<a name="l10654"></a>10654         {
<a name="l10655"></a>10655             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);
<a name="l10656"></a>10656             <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#a3ffc7dae5e742e234cea0d63a6624b67">Connect</a>(theNym, *pServer, strCA_FILE, strKEY_FILE, strKEY_PASSWORD);
<a name="l10657"></a>10657         }
<a name="l10658"></a>10658     }
<a name="l10659"></a>10659 
<a name="l10660"></a>10660     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l10661"></a>10661 }
<a name="l10662"></a>10662 
<a name="l10666"></a><a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">10666</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">OTClient::SetFocusToServerAndNym</a>(<a class="code" href="class_o_t_server_contract.html">OTServerContract</a> &amp; theServerContract, <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym, <a class="code" href="struct_transport_callback.html">TransportCallback</a> * pCallback)
<a name="l10667"></a>10667 {
<a name="l10668"></a>10668     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pCallback);
<a name="l10669"></a>10669     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>);
<a name="l10670"></a>10670 
<a name="l10671"></a>10671     <span class="keywordflow">return</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>-&gt;<a class="code" href="class_o_t_server_connection.html#a7415f258bbfe6295f87a366b1c93dde0">SetFocus</a>(theNym, theServerContract, pCallback);
<a name="l10672"></a>10672 }
<a name="l10673"></a>10673 
<a name="l10674"></a>10674 
<a name="l10675"></a>10675 
<a name="l10676"></a>10676 
<a name="l10677"></a>10677 
<a name="l10678"></a>10678 
<a name="l10680"></a><a class="code" href="class_o_t_client.html#af93ba422f820281eb6022798563d588d">10680</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_client.html#af93ba422f820281eb6022798563d588d" title="Need to call this before using.">OTClient::InitClient</a>(<a class="code" href="class_o_t_wallet.html">OTWallet</a> &amp; theWallet)
<a name="l10681"></a>10681 {
<a name="l10682"></a>10682     <span class="comment">// only run once.</span>
<a name="l10683"></a>10683     <span class="comment">//</span>
<a name="l10684"></a>10684     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a>)
<a name="l10685"></a>10685     {
<a name="l10686"></a>10686         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OTClient::InitClient: Already initialized. (Returning true.)\n&quot;</span>);
<a name="l10687"></a>10687         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l10688"></a>10688     }
<a name="l10689"></a>10689     <a class="code" href="class_o_t_client.html#a8d45ac1c031bb12782e5ce0d2ca60597">m_bInitialized</a>  = <span class="keyword">true</span>;
<a name="l10690"></a>10690     <span class="comment">// -----------------------</span>
<a name="l10691"></a>10691 
<a name="l10692"></a>10692 
<a name="l10693"></a>10693     <span class="comment">// UPDATE: SSL is now initialized in OTLog::OT_Init(), not in OTServerConnection.</span>
<a name="l10694"></a>10694     <span class="comment">//</span>
<a name="l10695"></a>10695     <span class="comment">// Old:</span>
<a name="l10696"></a>10696     <span class="comment">// SSL gets initialized in the OTServerConnection, so no need to do it here twice.</span>
<a name="l10697"></a>10697     <span class="comment">// BUT warning: don&#39;t load any private keys until this happens, or that won&#39;t work.</span>
<a name="l10698"></a>10698     <span class="comment">//  SSL_library_init();</span>
<a name="l10699"></a>10699     <span class="comment">//  SSL_load_error_strings();   // UPDATE: Moved to OTLog::OT_Init();</span>
<a name="l10700"></a>10700 
<a name="l10701"></a>10701 
<a name="l10702"></a>10702 
<a name="l10703"></a>10703     <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>   = <span class="keyword">new</span> <a class="code" href="class_o_t_server_connection.html">OTServerConnection</a>(theWallet, *<span class="keyword">this</span>);
<a name="l10704"></a>10704     m_pWallet       = &amp;theWallet;
<a name="l10705"></a>10705 
<a name="l10706"></a>10706 
<a name="l10707"></a>10707 
<a name="l10708"></a>10708     <span class="comment">// openssl initialization</span>
<a name="l10709"></a>10709     <span class="comment">// UPDATE: Moved to OTLog::OT_Init()</span>
<a name="l10710"></a>10710     <span class="comment">//</span>
<a name="l10711"></a>10711     <span class="comment">//  ERR_load_crypto_strings();  // Todo deal with error logging mechanism later.</span>
<a name="l10712"></a>10712     <span class="comment">//  OpenSSL_add_all_algorithms();  </span>
<a name="l10713"></a>10713 
<a name="l10714"></a>10714     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l10715"></a>10715 }
<a name="l10716"></a>10716 
<a name="l10717"></a>10717 
<a name="l10718"></a>10718 
<a name="l10719"></a>10719 
<a name="l10720"></a><a class="code" href="class_o_t_client.html#aaed4f52867ed4de23ba1871aef930a5d">10720</a> <a class="code" href="class_o_t_client.html#aaed4f52867ed4de23ba1871aef930a5d">OTClient::OTClient</a>() :
<a name="l10721"></a>10721     m_pWallet(NULL), 
<a name="l10722"></a>10722     m_bRunningAsScript(false), 
<a name="l10723"></a>10723     m_lMostRecentRequestNumber(0), 
<a name="l10724"></a>10724     m_pConnection(NULL), 
<a name="l10725"></a>10725     m_bInitialized(false)
<a name="l10726"></a>10726 {
<a name="l10727"></a>10727 
<a name="l10728"></a>10728 }
<a name="l10729"></a>10729 
<a name="l10730"></a><a class="code" href="class_o_t_client.html#adb75966e8195f25807fa5f521709109e">10730</a> <a class="code" href="class_o_t_client.html#adb75966e8195f25807fa5f521709109e">OTClient::~OTClient</a>()
<a name="l10731"></a>10731 {
<a name="l10732"></a>10732     <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>)
<a name="l10733"></a>10733         <span class="keyword">delete</span> <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>;
<a name="l10734"></a>10734     <a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a> = NULL;
<a name="l10735"></a>10735 
<a name="l10736"></a>10736     <span class="comment">// (FYI, Moved openssl cleanup to OT_Cleanup.)</span>
<a name="l10737"></a>10737 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_client_8cpp.html">OTClient.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:02 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
