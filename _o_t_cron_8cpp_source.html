<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otlib/OTCron.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_cron_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otlib/OTCron.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_cron_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *    </span>
<a name="l00003"></a>00003 <span class="comment"> *  OTCron.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *  </span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"> </span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"> </span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"> </span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cron_8hpp.html">OTCron.hpp</a>&gt;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#include &quot;irrxml/irrXML.hpp&quot;</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_storage_8hpp.html">OTStorage.hpp</a>&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_market_8hpp.html">OTMarket.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_a_s_c_i_i_armor_8hpp.html">OTASCIIArmor.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cron_item_8hpp.html">OTCronItem.hpp</a>&gt;</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;<a class="code" href="_timer_8hpp.html">Timer.hpp</a>&gt;</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="keyword">using namespace </span>irr;
<a name="l00149"></a>00149 <span class="keyword">using namespace </span>io;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="comment">// Note: these are only code defaults -- the values are actually loaded from ~/.ot/server.cfg.</span>
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 int32_t OTCron::__trans_refill_amount       = 500;      <span class="comment">// The number of transaction numbers Cron will grab for itself, when it gets low, before each round.</span>
<a name="l00155"></a>00155 int32_t OTCron::__cron_ms_between_process   = 10000;    <span class="comment">// The number of milliseconds (ideally) between each &quot;Cron Process&quot; event.</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 int32_t OTCron::__cron_max_items_per_nym    = 10; <span class="comment">// The maximum number of cron items any given Nym can have active at the same time.</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">// Make sure Server Nym is set on this cron object before loading or saving, since it&#39;s</span>
<a name="l00161"></a>00161 <span class="comment">// used for signing and verifying..</span>
<a name="l00162"></a><a class="code" href="class_o_t_cron.html#a6ad24d6d2669343157613f0efa017312">00162</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a6ad24d6d2669343157613f0efa017312">OTCron::LoadCron</a>()
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#aabb5605423422af18b156b9cd5e48c22">OTFolders::Cron</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00165"></a>00165     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = <span class="stringliteral">&quot;OT-CRON.crn&quot;</span>; <span class="comment">// todo stop hardcoding filenames.</span>
<a name="l00166"></a>00166     
<a name="l00167"></a>00167     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != GetServerNym());
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     bSuccess = LoadContract(szFoldername, szFilename);
<a name="l00173"></a>00173         
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (bSuccess)
<a name="l00175"></a>00175         bSuccess = VerifySignature(*(GetServerNym()));
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="keywordflow">return</span> bSuccess;
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="class_o_t_cron.html#a24df32b4bf36e48867e7afda0955bb72">00181</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a24df32b4bf36e48867e7afda0955bb72">OTCron::SaveCron</a>()
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFoldername   = <a class="code" href="class_o_t_folders.html#aabb5605423422af18b156b9cd5e48c22">OTFolders::Cron</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00184"></a>00184     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename     = <span class="stringliteral">&quot;OT-CRON.crn&quot;</span>; <span class="comment">// todo stop hardcoding filenames.</span>
<a name="l00185"></a>00185     
<a name="l00186"></a>00186     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != GetServerNym());
<a name="l00187"></a>00187     
<a name="l00188"></a>00188     
<a name="l00189"></a>00189     ReleaseSignatures();
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment">// Sign it, save it internally to string, and then save that out to the file.</span>
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (!SignContract(*m_pServerNym) || !SaveContract() || !SaveContract(szFoldername, szFilename))
<a name="l00193"></a>00193     {
<a name="l00194"></a>00194         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving main Cronfile:\n%s%s%s\n&quot;</span>, szFoldername,
<a name="l00195"></a>00195                       <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), szFilename);
<a name="l00196"></a>00196         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198     <span class="keywordflow">else</span>
<a name="l00199"></a>00199         <span class="keywordflow">return</span> <span class="keyword">true</span>;    
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="comment">// Loops through ALL markets, and calls pMarket-&gt;GetNym_OfferList(NYM_ID, *pOfferList) for each.</span>
<a name="l00204"></a>00204 <span class="comment">// Returns a list of all the offers that a specific Nym has on all the markets.</span>
<a name="l00205"></a>00205 <span class="comment">//</span>
<a name="l00206"></a><a class="code" href="class_o_t_cron.html#a581f68b86ff6f5ef1200e885a8f159f9">00206</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a581f68b86ff6f5ef1200e885a8f159f9">OTCron::GetNym_OfferList</a>(<a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascOutput, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, int32_t &amp; nOfferCount)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208     nOfferCount = 0; <span class="comment">// Outputs the number of offers on this nym.</span>
<a name="l00209"></a>00209     
<a name="l00210"></a>00210     
<a name="l00211"></a>00211     <a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a> * pOfferList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_offer_list_nym.html">OTDB::OfferListNym</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a976d0f2d070c94e031644952c6fb78d4">OTDB::STORED_OBJ_OFFER_LIST_NYM</a>));
<a name="l00212"></a>00212     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::OfferListNym&gt;</a> theListAngel(*pOfferList);
<a name="l00213"></a>00213     
<a name="l00214"></a>00214     
<a name="l00215"></a>00215     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#a59d4f7139328282aa9ee62a031844246">mapOfMarkets</a>, m_mapMarkets)
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = (*it).second;
<a name="l00218"></a>00218         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l00219"></a>00219         
<a name="l00220"></a>00220         int32_t nNymOfferCount = 0;
<a name="l00221"></a>00221         
<a name="l00222"></a>00222         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pMarket-&gt;<a class="code" href="class_o_t_market.html#a5b14418890823e00d07549c513292cd1">GetNym_OfferList</a>(NYM_ID, *pOfferList, nNymOfferCount)) <span class="comment">// appends to *pOfferList, each iteration.</span>
<a name="l00223"></a>00223         {
<a name="l00224"></a>00224                 <span class="comment">// may wish to add a log later. Anyway, keep iterationg and appending, then send back whatever we have.</span>
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226         <span class="keywordflow">else</span> <span class="comment">// Success!</span>
<a name="l00227"></a>00227             nOfferCount += nNymOfferCount;
<a name="l00228"></a>00228     }       
<a name="l00229"></a>00229     
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     <span class="comment">// Now pack the list into strOutput...</span>
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (nOfferCount == 0)
<a name="l00233"></a>00233         <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but 0 offers being returned. (List is empty.)</span>
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nOfferCount &gt; 0)
<a name="l00236"></a>00236     {
<a name="l00237"></a>00237         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l00238"></a>00238         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l00239"></a>00239         
<a name="l00240"></a>00240         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l00241"></a>00241         
<a name="l00242"></a>00242         
<a name="l00243"></a>00243         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*pOfferList); <span class="comment">// Now we PACK our nym&#39;s offer list.</span>
<a name="l00244"></a>00244         
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (NULL == pBuffer)
<a name="l00246"></a>00246         {
<a name="l00247"></a>00247             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pOfferList in OTCron::GetNym_OfferList. \n&quot;</span>);
<a name="l00248"></a>00248             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250         
<a name="l00251"></a>00251         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
<a name="l00252"></a>00252         
<a name="l00253"></a>00253         
<a name="l00254"></a>00254         <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
<a name="l00255"></a>00255         
<a name="l00256"></a>00256         <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
<a name="l00257"></a>00257         <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
<a name="l00258"></a>00258         
<a name="l00259"></a>00259         <span class="keywordflow">if</span> ((NULL != pUint) || (theSize &lt; 2))
<a name="l00260"></a>00260         {
<a name="l00261"></a>00261             <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
<a name="l00262"></a>00262             
<a name="l00263"></a>00263             <span class="comment">// This function will base64 ENCODE theData,</span>
<a name="l00264"></a>00264             <span class="comment">// and then Set() that as the string contents.</span>
<a name="l00265"></a>00265             ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
<a name="l00266"></a>00266             
<a name="l00267"></a>00267             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269         <span class="keywordflow">else</span> 
<a name="l00270"></a>00270             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Null returned, or bad size, while getting buffer data in OTCron::GetNym_OfferList.\n&quot;</span>);
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     <span class="keywordflow">else</span>
<a name="l00274"></a>00274         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error: Less-than-zero nOfferCount in OTCron::GetNym_OfferList: %d.\n&quot;</span>, nOfferCount); 
<a name="l00275"></a>00275     
<a name="l00276"></a>00276     <span class="keywordflow">return</span> <span class="keyword">false</span>;   
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="class_o_t_cron.html#ae331e0bba385dfd33a8f7cca095d2380">00280</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#ae331e0bba385dfd33a8f7cca095d2380">OTCron::GetMarketList</a> (<a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ascOutput, int32_t &amp; nMarketCount)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     nMarketCount        = 0; <span class="comment">// This parameter is set to zero here, and incremented in the loop below.</span>
<a name="l00283"></a>00283     
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket  = NULL;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a> * pMarketList  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_market_list.html">OTDB::MarketList</a>*<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82a7a0f581c82f5599271fcd57d0a020f99">OTDB::STORED_OBJ_MARKET_LIST</a>));
<a name="l00288"></a>00288     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::MarketList&gt;</a> theListAngel(*pMarketList);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         
<a name="l00291"></a>00291     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#a59d4f7139328282aa9ee62a031844246">mapOfMarkets</a>, m_mapMarkets)
<a name="l00292"></a>00292     {       
<a name="l00293"></a>00293         pMarket = (*it).second;
<a name="l00294"></a>00294         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l00295"></a>00295         
<a name="l00296"></a>00296         <a class="code" href="class_o_t_d_b_1_1_market_data.html">OTDB::MarketData</a> * pMarketData  = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_d_b_1_1_market_data.html">OTDB::MarketData</a> *<span class="keyword">&gt;</span>(<a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82af692b998fb062c5d9655b4cd7d55aa25">OTDB::STORED_OBJ_MARKET_DATA</a>));
<a name="l00297"></a>00297         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::MarketData&gt;</a> theDataAngel(*pMarketData);
<a name="l00298"></a>00298         
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  MARKET_ID(*pMarket);
<a name="l00301"></a>00301         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      str_MARKET_ID(MARKET_ID);
<a name="l00302"></a>00302         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      str_ServerID(pMarket-&gt;<a class="code" href="class_o_t_market.html#acbe41dd985ce33b5b72957b99a984444">GetServerID</a>());
<a name="l00303"></a>00303         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      str_ASSET_ID(pMarket-&gt;<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>());
<a name="l00304"></a>00304         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      str_CURRENCY_ID(pMarket-&gt;<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>());
<a name="l00305"></a>00305         
<a name="l00306"></a>00306         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#a259cf0034349d580b465bd10aacd06ed">server_id</a>          = str_ServerID.Get();
<a name="l00307"></a>00307         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#adbe791894d6afbfa49af07102e94b10c">market_id</a>          = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00308"></a>00308         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#ad94bc54282a6acefbd34088f8ee5afa6">asset_type_id</a>      = str_ASSET_ID.Get();
<a name="l00309"></a>00309         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#a1116aae82af6f197a038688704c2138f">currency_type_id</a>   = str_CURRENCY_ID.Get();
<a name="l00310"></a>00310         <span class="comment">// --------------------------------------------     </span>
<a name="l00311"></a>00311         <span class="keyword">const</span> int64_t &amp; lScale  = pMarket-&gt;<a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>();
<a name="l00312"></a>00312         
<a name="l00313"></a>00313         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#a76e9d00702cfa1284813a1c45fc9d91b">scale</a>              = to_string&lt;int64_t&gt;(lScale);
<a name="l00314"></a>00314         
<a name="l00315"></a>00315         <span class="comment">// --------------------------------------------</span>
<a name="l00316"></a>00316         
<a name="l00317"></a>00317         <span class="keyword">const</span> uint64_t theCurrentBid    = pMarket-&gt;<a class="code" href="class_o_t_market.html#af56483f0c0166de3859bdc706c071531">GetHighestBidPrice</a>();
<a name="l00318"></a>00318         <span class="keyword">const</span> uint64_t theCurrentAsk    = pMarket-&gt;<a class="code" href="class_o_t_market.html#a5580893d6510e601ca3ea48164485764">GetLowestAskPrice</a>();
<a name="l00319"></a>00319         
<a name="l00320"></a>00320         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#a34e5138f9d4a2c77bfd646f4ecce6845">current_bid</a>        = to_string&lt;uint64_t&gt;(theCurrentBid);
<a name="l00321"></a>00321         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#aae01cd5fa908b576bc2309ff4bc28ff4">current_ask</a>        = to_string&lt;uint64_t&gt;(theCurrentAsk);
<a name="l00322"></a>00322         
<a name="l00323"></a>00323         <span class="comment">// ---------------------------------------------</span>
<a name="l00324"></a>00324         
<a name="l00325"></a>00325         <span class="keyword">const</span> int64_t &amp; lLastSalePrice          = pMarket-&gt;<a class="code" href="class_o_t_market.html#a4d5f6b5c240b331bc6d2984d5dce4150">GetLastSalePrice</a>();
<a name="l00326"></a>00326         <span class="keyword">const</span> int64_t &amp; lTotalAvailableAssets   = pMarket-&gt;<a class="code" href="class_o_t_market.html#a2dd9eab76501e15105aca7a8f1ed7acd">GetTotalAvailableAssets</a>();
<a name="l00327"></a>00327         
<a name="l00328"></a>00328         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#ae4136bf50fadeb1cc3e4230add9aca7c">total_assets</a>       = to_string&lt;int64_t&gt;(lTotalAvailableAssets);
<a name="l00329"></a>00329         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#a07d21103b5c195f9cb5b618a3eac88e7">last_sale_price</a>    = to_string&lt;int64_t&gt;(lLastSalePrice);
<a name="l00330"></a>00330         
<a name="l00331"></a>00331         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#ae19de6144aae0681f53573888b8daf30">last_sale_date</a>     = pMarket-&gt;<a class="code" href="class_o_t_market.html#a489ad89157e72903d0d977ace2b25849">GetLastSaleDate</a>();
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <span class="comment">// ---------------------------------------------</span>
<a name="l00334"></a>00334         
<a name="l00335"></a>00335         <span class="keyword">const</span> mapOfOffers::size_type theBidCount = pMarket-&gt;<a class="code" href="class_o_t_market.html#ae5f15aabe47f37edad46b11c78a5440a">GetBidCount</a>();
<a name="l00336"></a>00336         <span class="keyword">const</span> mapOfOffers::size_type theAskCount = pMarket-&gt;<a class="code" href="class_o_t_market.html#af38989995c44f5083df1acc5ab1c3557">GetAskCount</a>();
<a name="l00337"></a>00337         
<a name="l00338"></a>00338         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#ab60c0a4fbf6fca65c9040a52b57054ea">number_bids</a>        = to_string&lt;mapOfOffers::size_type&gt;(theBidCount);
<a name="l00339"></a>00339         pMarketData-&gt;<a class="code" href="class_o_t_d_b_1_1_market_data.html#afc912eddb01ab728e292c3bc88604467">number_asks</a>        = to_string&lt;mapOfOffers::size_type&gt;(theAskCount);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">// ---------------------------------------------</span>
<a name="l00342"></a>00342         <span class="comment">// In the past 24 hours.</span>
<a name="l00343"></a>00343         <span class="comment">// (I&#39;m not collecting this data yet, (maybe never), so these values aren&#39;t set at all.)</span>
<a name="l00344"></a>00344         <span class="comment">//</span>
<a name="l00345"></a>00345 <span class="comment">//      pMarketData-&gt;volume_trades      = ???;</span>
<a name="l00346"></a>00346 <span class="comment">//      pMarketData-&gt;volume_assets      = ???;</span>
<a name="l00347"></a>00347 <span class="comment">//      pMarketData-&gt;volume_currency    = ???;</span>
<a name="l00348"></a>00348 <span class="comment">//      </span>
<a name="l00349"></a>00349 <span class="comment">//      pMarketData-&gt;recent_highest_bid = ???;</span>
<a name="l00350"></a>00350 <span class="comment">//      pMarketData-&gt;recent_lowest_ask  = ???;</span>
<a name="l00351"></a>00351         <span class="comment">// ---------------------------------------------</span>
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="comment">// *pMarketData is CLONED at this time (I&#39;m still responsible to delete.)</span>
<a name="l00354"></a>00354         <span class="comment">// That&#39;s also why I add it here, below: So the data is set right before the cloning occurs.</span>
<a name="l00355"></a>00355         <span class="comment">//</span>
<a name="l00356"></a>00356         pMarketList-&gt;AddMarketData(*pMarketData);
<a name="l00357"></a>00357         nMarketCount++;
<a name="l00358"></a>00358     }       
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00361"></a>00361     
<a name="l00362"></a>00362     <span class="comment">// Now pack the list into strOutput...</span>
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (0 == nMarketCount)
<a name="l00364"></a>00364     {
<a name="l00365"></a>00365         <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Success, but the list contains 0 markets.</span>
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nMarketCount &gt; 0)
<a name="l00369"></a>00369     {
<a name="l00370"></a>00370         <a class="code" href="class_o_t_d_b_1_1_storage.html">OTDB::Storage</a> * pStorage = <a class="code" href="namespace_o_t_d_b.html#acd05e317915b73ee26869659969dad02">OTDB::GetDefaultStorage</a>();
<a name="l00371"></a>00371         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pStorage);
<a name="l00372"></a>00372         
<a name="l00373"></a>00373         <a class="code" href="class_o_t_d_b_1_1_o_t_packer.html">OTDB::OTPacker</a> * pPacker = pStorage-&gt;<a class="code" href="class_o_t_d_b_1_1_storage.html#a693564a7129d4c08f739a398929e83c6">GetPacker</a>(); <span class="comment">// No need to check for failure, since this already ASSERTS. No need to cleanup either.</span>
<a name="l00374"></a>00374             
<a name="l00375"></a>00375         <span class="comment">// -----------------------------</span>
<a name="l00376"></a>00376         
<a name="l00377"></a>00377         <a class="code" href="class_o_t_d_b_1_1_packed_buffer.html">OTDB::PackedBuffer</a> * pBuffer = pPacker-&gt;<a class="code" href="class_o_t_d_b_1_1_o_t_packer.html#a67bd4a569fa37ffdcd0b0ae429b69fe1">Pack</a>(*pMarketList); <span class="comment">// Now we PACK our market list.</span>
<a name="l00378"></a>00378         
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (NULL == pBuffer)
<a name="l00380"></a>00380         {
<a name="l00381"></a>00381             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Failed packing pMarketList in OTCron::GetMarketList. \n&quot;</span>);
<a name="l00382"></a>00382             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384         
<a name="l00385"></a>00385         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::PackedBuffer&gt;</a> theBufferAngel(*pBuffer); <span class="comment">// make sure memory is cleaned up.</span>
<a name="l00386"></a>00386         
<a name="l00387"></a>00387         <span class="comment">// -------------------------------------------------------- </span>
<a name="l00388"></a>00388         
<a name="l00389"></a>00389         <span class="comment">// Now we need to translate pBuffer into strOutput.</span>
<a name="l00390"></a>00390         
<a name="l00391"></a>00391         <span class="keyword">const</span> uint8_t* pUint = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#a5fc68599bb27d14066abc0ada509e6b1">GetData</a>());
<a name="l00392"></a>00392         <span class="keyword">const</span> <span class="keywordtype">size_t</span> theSize = pBuffer-&gt;<a class="code" href="class_o_t_d_b_1_1_packed_buffer.html#ac1528fc43c64e1268eca83065c9e0c29">GetSize</a>();
<a name="l00393"></a>00393         
<a name="l00394"></a>00394         <span class="keywordflow">if</span> ((theSize &gt; 0) &amp;&amp; (NULL != pUint))
<a name="l00395"></a>00395         {
<a name="l00396"></a>00396             <a class="code" href="class_o_t_data.html">OTData</a> theData(pUint, static_cast&lt;uint32_t&gt; (theSize));
<a name="l00397"></a>00397 
<a name="l00398"></a>00398             <span class="comment">// This function will base64 ENCODE theData,</span>
<a name="l00399"></a>00399             <span class="comment">// and then Set() that as the string contents.</span>
<a name="l00400"></a>00400             ascOutput.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a48e0e2e2eff86ad382a2cc63298a0b8b">SetData</a>(theData);
<a name="l00401"></a>00401 <span class="comment">//            bool bSuccessSetData = false;</span>
<a name="l00402"></a>00402 <span class="comment">//            bSuccessSetData = ascOutput.SetData(theData);</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406         <span class="keywordflow">else</span> 
<a name="l00407"></a>00407             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTCron::GetMarketList: 0 size, or null return value, while getting raw data from packed buffer.\n&quot;</span>);
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409     
<a name="l00410"></a>00410     <span class="keywordflow">else</span>
<a name="l00411"></a>00411         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTCron::GetMarketList: nMarketCount is less than zero: %d.\n&quot;</span>, nMarketCount);      
<a name="l00412"></a>00412         
<a name="l00413"></a>00413     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 
<a name="l00417"></a><a class="code" href="class_o_t_cron.html#ae241ecf6802b59ccde653082f098e80c">00417</a> int32_t <a class="code" href="class_o_t_cron.html#ae241ecf6802b59ccde653082f098e80c">OTCron::GetTransactionCount</a>()<span class="keyword"> const</span>
<a name="l00418"></a>00418 <span class="keyword"></span>{
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (m_listTransactionNumbers.empty())
<a name="l00420"></a>00420         <span class="keywordflow">return</span> 0;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span> (m_listTransactionNumbers.size());
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="class_o_t_cron.html#aad85faf2146cea516d7a5f169904485d">00426</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#aad85faf2146cea516d7a5f169904485d">OTCron::AddTransactionNumber</a>(<span class="keyword">const</span> int64_t &amp; lTransactionNum)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     m_listTransactionNumbers.push_back(lTransactionNum);
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">// Once this starts returning 0, OTCron can no longer process trades and</span>
<a name="l00433"></a>00433 <span class="comment">// payment plans until the server object replenishes this list.</span>
<a name="l00434"></a><a class="code" href="class_o_t_cron.html#a22822e0aeced441b6404cd8a2c8e00da">00434</a> int64_t <a class="code" href="class_o_t_cron.html#a22822e0aeced441b6404cd8a2c8e00da">OTCron::GetNextTransactionNumber</a>()
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (m_listTransactionNumbers.empty())
<a name="l00437"></a>00437         <span class="keywordflow">return</span> 0;
<a name="l00438"></a>00438     
<a name="l00439"></a>00439     int64_t lTransactionNum = m_listTransactionNumbers.front();
<a name="l00440"></a>00440     
<a name="l00441"></a>00441     m_listTransactionNumbers.pop_front();
<a name="l00442"></a>00442     
<a name="l00443"></a>00443     <span class="keywordflow">return</span> lTransactionNum;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="comment">// return -1 if error, 0 if nothing, and 1 if the node was processed.</span>
<a name="l00448"></a><a class="code" href="class_o_t_cron.html#a004071b22676a0419f1b6de519f00b78">00448</a> int32_t <a class="code" href="class_o_t_cron.html#a004071b22676a0419f1b6de519f00b78">OTCron::ProcessXMLNode</a>(<a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>*&amp; xml)
<a name="l00449"></a>00449 {
<a name="l00450"></a>00450     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != GetServerNym());
<a name="l00451"></a>00451     
<a name="l00452"></a>00452     int32_t nReturnVal = 0;
<a name="l00453"></a>00453     
<a name="l00454"></a>00454     <span class="comment">// Here we call the parent class first.</span>
<a name="l00455"></a>00455     <span class="comment">// If the node is found there, or there is some error,</span>
<a name="l00456"></a>00456     <span class="comment">// then we just return either way.  But if it comes back</span>
<a name="l00457"></a>00457     <span class="comment">// as &#39;0&#39;, then nothing happened, and we&#39;ll continue executing.</span>
<a name="l00458"></a>00458     <span class="comment">//</span>
<a name="l00459"></a>00459     <span class="comment">// -- Note you can choose not to call the parent if</span>
<a name="l00460"></a>00460     <span class="comment">// you don&#39;t want to use any of those xml tags.</span>
<a name="l00461"></a>00461     <span class="comment">// As I do below, in the case of OTAccount.</span>
<a name="l00462"></a>00462     <span class="comment">//if (nReturnVal = OTContract::ProcessXMLNode(xml))</span>
<a name="l00463"></a>00463     <span class="comment">//  return nReturnVal;</span>
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;cron&quot;</span>, xml-&gt;getNodeName())) 
<a name="l00467"></a>00467     {       
<a name="l00468"></a>00468         m_strVersion = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;version&quot;</span>);
<a name="l00469"></a>00469         <span class="comment">// ---------------------</span>
<a name="l00470"></a>00470         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;serverID&quot;</span>));
<a name="l00471"></a>00471         
<a name="l00472"></a>00472         m_SERVER_ID.SetString(strServerID);
<a name="l00473"></a>00473         <span class="comment">// ---------------------</span>
<a name="l00474"></a>00474         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nLoading OTCron for ServerID: %s\n&quot;</span>, 
<a name="l00475"></a>00475                        strServerID.Get());
<a name="l00476"></a>00476                 
<a name="l00477"></a>00477         nReturnVal = 1;
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;transactionNum&quot;</span>, xml-&gt;getNodeName()))
<a name="l00480"></a>00480     {
<a name="l00481"></a>00481         <span class="keyword">const</span> int64_t lTransactionNum = atol(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;value&quot;</span>));
<a name="l00482"></a>00482         
<a name="l00483"></a>00483         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Transaction Number %lld available for Cron.\n&quot;</span>,
<a name="l00484"></a>00484                        lTransactionNum);
<a name="l00485"></a>00485         
<a name="l00486"></a>00486         AddTransactionNumber(lTransactionNum); <span class="comment">// This doesn&#39;t save to disk. Make sure to save Cron when it changes.</span>
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         nReturnVal = 1;
<a name="l00489"></a>00489     }   
<a name="l00490"></a>00490     
<a name="l00491"></a>00491     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;cronItem&quot;</span>, xml-&gt;getNodeName())) 
<a name="l00492"></a>00492     {
<a name="l00493"></a>00493         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    str_date_added = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;dateAdded&quot;</span>);
<a name="l00494"></a>00494         <span class="keyword">const</span> int64_t     lDateAdded     = (!str_date_added.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? 0 : str_date_added.<a class="code" href="class_o_t_string.html#a18ca8f42f6e90ab7801c019611d9dca8">ToLong</a>());
<a name="l00495"></a>00495         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      tDateAdded = <a class="code" href="_o_t_common_8hpp.html#a5c0893ffd83818f1c3c6b3b7ae92da13">OTTimeGetTimeFromSeconds</a>(lDateAdded);
<a name="l00496"></a>00496         <span class="comment">// ------------------------------------</span>
<a name="l00497"></a>00497         <a class="code" href="class_o_t_string.html">OTString</a> strData;
<a name="l00498"></a>00498         
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, strData) || !strData.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00500"></a>00500         {
<a name="l00501"></a>00501             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error in OTCron::ProcessXMLNode: cronItem field without value.\n&quot;</span>);
<a name="l00502"></a>00502             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504         <span class="keywordflow">else</span> 
<a name="l00505"></a>00505         {
<a name="l00506"></a>00506             <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(strData);
<a name="l00507"></a>00507             
<a name="l00508"></a>00508             <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00509"></a>00509             {
<a name="l00510"></a>00510                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Unable to create cron item from data in cron file.\n&quot;</span>);
<a name="l00511"></a>00511                 <span class="keywordflow">return</span> (-1);
<a name="l00512"></a>00512             }
<a name="l00513"></a>00513             <span class="comment">// -------------------------------------------</span>
<a name="l00514"></a>00514             
<a name="l00515"></a>00515             <span class="comment">// Why not do this here (when loading from storage), as well as when first adding the item to cron,</span>
<a name="l00516"></a>00516             <span class="comment">// and thus save myself the trouble of verifying the signature EVERY ITERATION of ProcessCron().</span>
<a name="l00517"></a>00517             <span class="comment">//</span>
<a name="l00518"></a>00518             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pItem-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*m_pServerNym))
<a name="l00519"></a>00519             {
<a name="l00520"></a>00520                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTCron::ProcessXMLNode: ERROR SECURITY: Server signature failed to &quot;</span>
<a name="l00521"></a>00521                               <span class="stringliteral">&quot;verify on a cron item while loading: %lld\n&quot;</span>, pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00522"></a>00522                 <span class="keyword">delete</span> pItem;
<a name="l00523"></a>00523                 pItem = NULL;
<a name="l00524"></a>00524                 <span class="keywordflow">return</span> (-1);
<a name="l00525"></a>00525             }
<a name="l00526"></a>00526             <span class="comment">// -------------------------------------------              </span>
<a name="l00527"></a>00527             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AddCronItem(*pItem,
<a name="l00528"></a>00528                                  NULL,
<a name="l00529"></a>00529                                  <span class="keyword">false</span>, <span class="comment">// bSaveReceipt=false. The receipt is only saved once: When item FIRST added to cron...</span>
<a name="l00530"></a>00530                                  tDateAdded))
<a name="l00531"></a>00531             {   <span class="comment">// ...But here, the item was ALREADY in cron, and is merely being loaded from disk.</span>
<a name="l00532"></a>00532                 <span class="comment">// Thus, it would be wrong to try to create the &quot;original record&quot; as if it were brand</span>
<a name="l00533"></a>00533                 <span class="comment">// new and still had the user&#39;s signature on it. (Once added to Cron, the signatures are</span>
<a name="l00534"></a>00534                 <span class="comment">// released and the SERVER signs it from there. That&#39;s why the user&#39;s version is saved</span>
<a name="l00535"></a>00535                 <span class="comment">// as a receipt in the first place -- so we have a record of the user&#39;s authorization.)</span>
<a name="l00536"></a>00536                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Successfully loaded cron item and added to list.\n&quot;</span>);
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538             <span class="keywordflow">else</span> 
<a name="l00539"></a>00539             {
<a name="l00540"></a>00540                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTCron::ProcessXMLNode: Though loaded / verified successfully, &quot;</span>
<a name="l00541"></a>00541                              <span class="stringliteral">&quot;unable to add cron item (from cron file) to cron list.\n&quot;</span>);
<a name="l00542"></a>00542                 <span class="keyword">delete</span> pItem;
<a name="l00543"></a>00543                 pItem = NULL;
<a name="l00544"></a>00544                 <span class="keywordflow">return</span> (-1);
<a name="l00545"></a>00545             }
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         
<a name="l00548"></a>00548         nReturnVal = 1;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550     
<a name="l00551"></a>00551     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;market&quot;</span>, xml-&gt;getNodeName()))
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strMarketID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;marketID&quot;</span>));
<a name="l00554"></a>00554         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strAssetID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;assetID&quot;</span>));
<a name="l00555"></a>00555         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strCurrencyID(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;currencyID&quot;</span>));
<a name="l00556"></a>00556         
<a name="l00557"></a>00557         <span class="keyword">const</span> int64_t       lScale = atol(xml-&gt;getAttributeValue(<span class="stringliteral">&quot;marketScale&quot;</span>));
<a name="l00558"></a>00558         
<a name="l00559"></a>00559         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  ASSET_ID(strAssetID), CURRENCY_ID(strCurrencyID);
<a name="l00560"></a>00560         
<a name="l00561"></a>00561         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;Loaded cron entry for Market:\n%s.\n&quot;</span>, strMarketID.Get());
<a name="l00562"></a>00562         
<a name="l00563"></a>00563         <span class="comment">// LoadMarket() needs this info to do its thing.</span>
<a name="l00564"></a>00564         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = <span class="keyword">new</span> <a class="code" href="class_o_t_market.html">OTMarket</a>(m_SERVER_ID, ASSET_ID, CURRENCY_ID, lScale);
<a name="l00565"></a>00565         
<a name="l00566"></a>00566         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l00567"></a>00567         
<a name="l00568"></a>00568         pMarket-&gt;SetCronPointer(*<span class="keyword">this</span>); <span class="comment">// This way every Market has a pointer to Cron.</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <span class="comment">//  AddMarket normally saves to file, but we don&#39;t want that when we&#39;re LOADING from file, now do we?</span>
<a name="l00571"></a>00571         <span class="keywordflow">if</span> (!pMarket-&gt;LoadMarket() ||
<a name="l00572"></a>00572             !pMarket-&gt;VerifySignature(*GetServerNym()) ||
<a name="l00573"></a>00573             !AddMarket(*pMarket, <span class="keyword">false</span>)) <span class="comment">// bSaveFile=false: don&#39;t save this file WHILE loading it!!! </span>
<a name="l00574"></a>00574         {
<a name="l00575"></a>00575             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Somehow error while loading, verifying, or adding market while loading Cron file.\n&quot;</span>);
<a name="l00576"></a>00576             <span class="keyword">delete</span> pMarket; pMarket = NULL;
<a name="l00577"></a>00577             <span class="keywordflow">return</span> (-1);
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579         <span class="keywordflow">else</span> 
<a name="l00580"></a>00580         {
<a name="l00581"></a>00581             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(1, <span class="stringliteral">&quot;Loaded market entry from cronfile, and also loaded the market file itself.\n&quot;</span>);
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583         nReturnVal = 1;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585     
<a name="l00586"></a>00586     <span class="keywordflow">return</span> nReturnVal;  
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 
<a name="l00590"></a><a class="code" href="class_o_t_cron.html#a0eee508b9330b0dc0776c4a8cb9e2b9b">00590</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#a0eee508b9330b0dc0776c4a8cb9e2b9b">OTCron::UpdateContents</a>()
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <span class="comment">// I release this because I&#39;m about to repopulate it.</span>
<a name="l00593"></a>00593     m_xmlUnsigned.Release();
<a name="l00594"></a>00594     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00595"></a>00595     m_xmlUnsigned.Concatenate(<span class="stringliteral">&quot;&lt;?xml version=\&quot;%s\&quot;?&gt;\n\n&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>);     
<a name="l00596"></a>00596     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00597"></a>00597     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  SERVER_ID(m_SERVER_ID);
<a name="l00598"></a>00598     
<a name="l00599"></a>00599     m_xmlUnsigned.Concatenate(<span class="stringliteral">&quot;&lt;cron\n version=\&quot;%s\&quot;\n&quot;</span>
<a name="l00600"></a>00600                               <span class="stringliteral">&quot; serverID=\&quot;%s\&quot;&quot;</span>
<a name="l00601"></a>00601                               <span class="stringliteral">&quot; &gt;\n\n&quot;</span>, 
<a name="l00602"></a>00602                               m_strVersion.Get(),
<a name="l00603"></a>00603                               SERVER_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); 
<a name="l00604"></a>00604     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00605"></a>00605     <span class="comment">// Save the Market entries (the markets themselves are saved in a markets folder.)</span>
<a name="l00606"></a>00606     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#a59d4f7139328282aa9ee62a031844246">mapOfMarkets</a>, m_mapMarkets)
<a name="l00607"></a>00607     {
<a name="l00608"></a>00608         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = (*it).second;
<a name="l00609"></a>00609         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l00610"></a>00610         
<a name="l00611"></a>00611         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(*pMarket);
<a name="l00612"></a>00612         <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l00613"></a>00613         
<a name="l00614"></a>00614         <a class="code" href="class_o_t_string.html">OTString</a>        str_ASSET_ID(pMarket-&gt;<a class="code" href="class_o_t_market.html#a0a4e04126fb83f13b1477fccc169c0e9">GetAssetID</a>());
<a name="l00615"></a>00615         <a class="code" href="class_o_t_string.html">OTString</a>        str_CURRENCY_ID(pMarket-&gt;<a class="code" href="class_o_t_market.html#aeeac45c32cade4a24d29e7a829304956">GetCurrencyID</a>());
<a name="l00616"></a>00616         
<a name="l00617"></a>00617         m_xmlUnsigned.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;market\n marketID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00618"></a>00618                                   <span class="stringliteral">&quot; assetID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00619"></a>00619                                   <span class="stringliteral">&quot; currencyID=\&quot;%s\&quot;\n&quot;</span>
<a name="l00620"></a>00620                                   <span class="stringliteral">&quot; marketScale=\&quot;%lld\&quot;&quot;</span>
<a name="l00621"></a>00621                                   <span class="stringliteral">&quot; /&gt;\n\n&quot;</span>,
<a name="l00622"></a>00622                                   str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l00623"></a>00623                                   str_ASSET_ID.Get(),
<a name="l00624"></a>00624                                   str_CURRENCY_ID.Get(),
<a name="l00625"></a>00625                                   pMarket-&gt;<a class="code" href="class_o_t_market.html#aebe1f377a1c3a56d8dc0bb90168eea67">GetScale</a>()); 
<a name="l00626"></a>00626     }       
<a name="l00627"></a>00627     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00628"></a>00628     <span class="comment">// Save the Cron Items</span>
<a name="l00629"></a>00629     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#af0fe73fce142b8d47867d7a760b73bcd">multimapOfCronItems</a>, m_multimapCronItems)
<a name="l00630"></a>00630     {
<a name="l00631"></a>00631         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*it).second;
<a name="l00632"></a>00632         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l00633"></a>00633         <span class="comment">// -------------------------------------</span>
<a name="l00634"></a>00634         <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  tDateAdded = (*it).first;
<a name="l00635"></a>00635         int64_t lDateAdded = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tDateAdded);
<a name="l00636"></a>00636         <span class="comment">// -------------------------------------</span>
<a name="l00637"></a>00637         <a class="code" href="class_o_t_string.html">OTString</a> strItem(*pItem);       <span class="comment">// Extract the cron item contract into string form.</span>
<a name="l00638"></a>00638         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascItem(strItem);  <span class="comment">// Base64-encode that for storage.</span>
<a name="l00639"></a>00639         <span class="comment">// -------------------------------------</span>
<a name="l00640"></a>00640         m_xmlUnsigned.Concatenate(<span class="stringliteral">&quot;&lt;cronItem dateAdded=\&quot;%&quot;</span> PRId64<span class="stringliteral">&quot;\&quot; &gt;\n%s&lt;/cronItem&gt;\n\n&quot;</span>,
<a name="l00641"></a>00641                                   lDateAdded, ascItem.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00644"></a>00644     <span class="comment">// Save the transaction numbers.</span>
<a name="l00645"></a>00645     <span class="comment">//</span>
<a name="l00646"></a>00646     int64_t lTransactionNumber = 0;
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#ae45e9feb4c88f9ee64b708e395602fed">listOfLongNumbers</a>, m_listTransactionNumbers)
<a name="l00649"></a>00649     {   
<a name="l00650"></a>00650         lTransactionNumber = *it;
<a name="l00651"></a>00651         
<a name="l00652"></a>00652         m_xmlUnsigned.Concatenate(<span class="stringliteral">&quot;&lt;transactionNum value=\&quot;%lld\&quot; /&gt;\n\n&quot;</span>, 
<a name="l00653"></a>00653                            lTransactionNumber);
<a name="l00654"></a>00654     } <span class="comment">// for</span>
<a name="l00655"></a>00655     <span class="comment">// -------------------------------------------------------------</span>
<a name="l00656"></a>00656     m_xmlUnsigned.Concatenate(<span class="stringliteral">&quot;&lt;/cron&gt;\n&quot;</span>);
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="comment">// Make sure to call this regularly so the CronItems get a chance to process and expire.</span>
<a name="l00661"></a><a class="code" href="class_o_t_cron.html#a1a8bdc614a109ccecf9712531ba9cf14">00661</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#a1a8bdc614a109ccecf9712531ba9cf14">OTCron::ProcessCronItems</a>()
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (!m_bIsActivated)
<a name="l00665"></a>00665     {
<a name="l00666"></a>00666         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTCron::ProcessCronItems: Not activated yet. (Skipping.)\n&quot;</span>);
<a name="l00667"></a>00667         <span class="keywordflow">return</span>; <span class="comment">// No Cron processing until Cron is activated.</span>
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00670"></a>00670     <span class="keyword">static</span> <span class="keyword">const</span> int64_t lMsBetweenCronBeats = <a class="code" href="class_o_t_cron.html#af81a76731bdaa2d9d32df8c02ec0739d">OTCron::GetCronMsBetweenProcess</a>(); <span class="comment">// Default: 10 seconds aka 10000</span>
<a name="l00671"></a>00671     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00672"></a>00672     <span class="comment">// CRON RUNS ON A TIMER...</span>
<a name="l00673"></a>00673     <span class="keyword">static</span>  <a class="code" href="class_timer.html">Timer</a>   tCron(<span class="keyword">true</span>);    <span class="comment">// bStart=true.</span>
<a name="l00674"></a>00674     <span class="keyword">static</span>  <span class="keywordtype">double</span>  cron_tick1      = tCron.<a class="code" href="class_timer.html#a71a44ab36290730bc49f8719546194fc">getElapsedTimeInMilliSec</a>(); <span class="comment">// This initially occurs the first time function is called.</span>
<a name="l00675"></a>00675             <span class="keywordtype">double</span>  cron_tick2      = tCron.<a class="code" href="class_timer.html#a71a44ab36290730bc49f8719546194fc">getElapsedTimeInMilliSec</a>(); <span class="comment">// This occurs EVERY time this function is called.</span>
<a name="l00676"></a>00676     <span class="keyword">const</span>   int64_t cron_elapsed    = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(cron_tick2 - cron_tick1);    <span class="comment">// This calculates every time this function is called.</span>
<a name="l00677"></a>00677     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00678"></a>00678     <span class="comment">// If it&#39;s been at least ten seconds...</span>
<a name="l00679"></a>00679     <span class="comment">//</span>
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (cron_elapsed &gt; lMsBetweenCronBeats)
<a name="l00681"></a>00681         <span class="comment">// Reset the timer -- we&#39;re executing!</span>
<a name="l00682"></a>00682         cron_tick1  = tCron.<a class="code" href="class_timer.html#a71a44ab36290730bc49f8719546194fc">getElapsedTimeInMilliSec</a>(); <span class="comment">// cron_tick1 only changes here, every X ms.</span>
<a name="l00683"></a>00683     <span class="keywordflow">else</span>
<a name="l00684"></a>00684         <span class="keywordflow">return</span>; <span class="comment">// (it&#39;s not our time yet.)</span>
<a name="l00685"></a>00685     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00686"></a>00686     <span class="keyword">const</span> int32_t nTwentyPercent = <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>() / 5;
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (GetTransactionCount() &lt;= nTwentyPercent)
<a name="l00688"></a>00688     {
<a name="l00689"></a>00689         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;WARNING: Cron has fewer than 20 percent of its normal transaction number count available since the previous round! \n&quot;</span>
<a name="l00690"></a>00690                      <span class="stringliteral">&quot;That is, %d are currently available, with a max of %d, meaning %d were used in the last round alone!!! \n&quot;</span>
<a name="l00691"></a>00691                      <span class="stringliteral">&quot;SKIPPING THE CRON ITEMS THAT WERE SCHEDULED FOR THIS ROUND!!!\n\n&quot;</span>, GetTransactionCount(), 
<a name="l00692"></a>00692                       <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>(), <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>() - GetTransactionCount());
<a name="l00693"></a>00693         <span class="keywordflow">return</span>;
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00696"></a>00696     <span class="keywordtype">bool</span> bNeedToSave = <span class="keyword">false</span>;
<a name="l00697"></a>00697     
<a name="l00698"></a>00698     <span class="comment">// loop through the cron items and tell each one to ProcessCron().</span>
<a name="l00699"></a>00699     <span class="comment">// If the item returns true, that means leave it on the list. Otherwise,</span>
<a name="l00700"></a>00700     <span class="comment">// if it returns false, that means &quot;it&#39;s done: remove it.&quot;</span>
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="keywordflow">for</span> (multimapOfCronItems::iterator          <span class="comment">// Iterating through the multimap means we process the cronitems</span>
<a name="l00703"></a>00703             it  = m_multimapCronItems.begin();  <span class="comment">// in the same order that they were originally added to Cron.</span>
<a name="l00704"></a>00704             it != m_multimapCronItems.end();    <span class="comment">// (This is necessary for market orders to process properly.)</span>
<a name="l00705"></a>00705          <span class="comment">/* NOTICE THIS THIRD SPOT IS EMPTY*/</span>
<a name="l00706"></a>00706         )
<a name="l00707"></a>00707 <span class="comment">//  FOR_EACH(multimapOfCronItems, m_multimapCronItems)</span>
<a name="l00708"></a>00708     {
<a name="l00709"></a>00709         <span class="keyword">const</span> int32_t nTwentyPercent2 = <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>() / 5;
<a name="l00710"></a>00710         <span class="comment">// ----------------------------------------------------------</span>
<a name="l00711"></a>00711         <span class="keywordflow">if</span> (GetTransactionCount() &lt;= nTwentyPercent2)
<a name="l00712"></a>00712         {
<a name="l00713"></a>00713             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;WARNING: Cron has fewer than 20 percent of its normal transaction &quot;</span>
<a name="l00714"></a>00714                           <span class="stringliteral">&quot;number count available since the previous cron item alone! \n&quot;</span>
<a name="l00715"></a>00715                           <span class="stringliteral">&quot;That is, %d are currently available, with a max of %d, meaning %d &quot;</span>
<a name="l00716"></a>00716                           <span class="stringliteral">&quot;were used in the current round alone!!! \n&quot;</span>
<a name="l00717"></a>00717                           <span class="stringliteral">&quot;SKIPPING THE REMAINDER OF THE CRON ITEMS THAT WERE SCHEDULED FOR THIS ROUND!!!\n\n&quot;</span>,
<a name="l00718"></a>00718                           GetTransactionCount(),
<a name="l00719"></a>00719                           <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>(), <a class="code" href="class_o_t_cron.html#a6e1ade4402e6db7aad96b8b2177be9d9">OTCron::GetCronRefillAmount</a>() - GetTransactionCount());
<a name="l00720"></a>00720             <span class="keywordflow">break</span>;
<a name="l00721"></a>00721         }
<a name="l00722"></a>00722         <span class="comment">// ----------------------------------------------------------</span>
<a name="l00723"></a>00723         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*it).second;
<a name="l00724"></a>00724         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem);
<a name="l00725"></a>00725         
<a name="l00726"></a>00726         <span class="keywordtype">bool</span> bProcessCron   = <span class="keyword">false</span>;
<a name="l00727"></a>00727         <span class="comment">// ----------------------------------------------------------</span>
<a name="l00728"></a>00728         <span class="comment">//  We already verify and sign the cron item when FIRST ADDING it to Cron.</span>
<a name="l00729"></a>00729         <span class="comment">//  We also verify the signature on the cron item whenever loading it up</span>
<a name="l00730"></a>00730         <span class="comment">//  from storage.</span>
<a name="l00731"></a>00731         <span class="comment">//  THEREFORE, FOR NOW, I&#39;VE DECIDED THAT VERIFYING THE SIGNATURE AGAIN </span>
<a name="l00732"></a>00732         <span class="comment">//  (HERE) IS OVERKILL, SO IT&#39;s COMMENTED OUT.</span>
<a name="l00733"></a>00733         <span class="comment">//</span>
<a name="l00734"></a>00734 <span class="comment">//      bool bVerifySig = pItem-&gt;VerifySignature(*m_pServerNym);</span>
<a name="l00735"></a>00735 <span class="comment">//      if (bVerifySig)</span>
<a name="l00736"></a>00736         {
<a name="l00737"></a>00737             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;OTCron::%s: Processing item number: %lld \n&quot;</span>,
<a name="l00738"></a>00738                            __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00739"></a>00739             
<a name="l00740"></a>00740             bProcessCron = pItem-&gt;<a class="code" href="class_o_t_cron_item.html#afe5c6a9af86b637fd8b2b3459825565b">ProcessCron</a>();
<a name="l00741"></a>00741             
<a name="l00742"></a>00742             <span class="comment">// false means &quot;remove it&quot;.</span>
<a name="l00743"></a>00743             <span class="comment">// ProcessCron returns true if should stay on the list.</span>
<a name="l00744"></a>00744             <span class="comment">//</span>
<a name="l00745"></a>00745             <span class="keywordflow">if</span> (<span class="keyword">false</span> == bProcessCron)
<a name="l00746"></a>00746                 pItem-&gt;<a class="code" href="class_o_t_cron_item.html#a70fe4a9257f50547dc62b4f553b05f2d">HookRemovalFromCron</a>(NULL); <span class="comment">// We give the hook a chance to do its thing.</span>
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748 <span class="comment">//      else</span>
<a name="l00749"></a>00749 <span class="comment">//          OTLog::Error(&quot;OTCron::ProcessCronItems: Signature failed to verify on cron item!\n&quot;);</span>
<a name="l00750"></a>00750         <span class="comment">// -----------------------------------------------------</span>
<a name="l00751"></a>00751         <span class="comment">// Remove it from the list.</span>
<a name="l00752"></a>00752         <span class="comment">//</span>
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bProcessCron)
<a name="l00754"></a>00754         {
<a name="l00755"></a>00755             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTCron::%s: Removing cron item: %lld\n&quot;</span>,
<a name="l00756"></a>00756                            __FUNCTION__, pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00757"></a>00757             <span class="comment">// -------------------------------</span>
<a name="l00758"></a>00758             <span class="comment">// Remove from MultiMap</span>
<a name="l00759"></a>00759             <span class="comment">//</span>
<a name="l00760"></a>00760             multimapOfCronItems::iterator it_delete = it;
<a name="l00761"></a>00761             ++it;
<a name="l00762"></a>00762             m_multimapCronItems.erase(it_delete);
<a name="l00763"></a>00763             <span class="comment">// -------------------------------</span>
<a name="l00764"></a>00764             <span class="comment">// Remove from Map</span>
<a name="l00765"></a>00765             <span class="comment">//</span>
<a name="l00766"></a>00766             mapOfCronItems::iterator it_map = this-&gt;FindItemOnMap(pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00767"></a>00767             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(m_mapCronItems.end() != it_map); <span class="comment">// If it&#39;s on the multimap, then it should also ALWAYS be on the map.</span>
<a name="l00768"></a>00768             m_mapCronItems.erase(it_map);
<a name="l00769"></a>00769             <span class="comment">// -------------------------------</span>
<a name="l00770"></a>00770             <span class="keyword">delete</span> pItem;
<a name="l00771"></a>00771             pItem = NULL;
<a name="l00772"></a>00772             <span class="comment">// -------------------------------</span>
<a name="l00773"></a>00773             bNeedToSave = <span class="keyword">true</span>; <span class="comment">// We&#39;ll save to file at the bottom if anything was removed.</span>
<a name="l00774"></a>00774         } 
<a name="l00775"></a>00775         <span class="keywordflow">else</span>    <span class="comment">// the special i++ and ++i arrangement here allows me to erase an item</span>
<a name="l00776"></a>00776         {       <span class="comment">// from the list WHILE iterating through it  :-)   (Supposedly.)</span>
<a name="l00777"></a>00777             ++it;
<a name="l00778"></a>00778         }
<a name="l00779"></a>00779     } <span class="comment">// for</span>
<a name="l00780"></a>00780     <span class="comment">// ----------------------------------------------------------</span>
<a name="l00781"></a>00781     <span class="comment">// Items were removed from Cron -- Save to storage!</span>
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (bNeedToSave)
<a name="l00783"></a>00783         SaveCron();
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="comment">// OTCron IS responsible for cleaning up theItem, and takes ownership.</span>
<a name="l00788"></a>00788 <span class="comment">// So make SURE it is allocated on the HEAP before you pass it in here, and</span>
<a name="l00789"></a>00789 <span class="comment">// also make sure to delete it again if this call fails!</span>
<a name="l00790"></a><a class="code" href="class_o_t_cron.html#a2d42c183c174f56a7c7c3da1e844a53f">00790</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a2d42c183c174f56a7c7c3da1e844a53f">OTCron::AddCronItem</a>(<a class="code" href="class_o_t_cron_item.html">OTCronItem</a>  &amp; theItem,
<a name="l00791"></a>00791                          <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pActivator,
<a name="l00792"></a>00792                          <span class="keywordtype">bool</span>          bSaveReceipt,
<a name="l00793"></a>00793                          <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>        tDateAdded)
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != GetServerNym());
<a name="l00796"></a>00796     
<a name="l00797"></a>00797     <span class="comment">// See if there&#39;s something else already there with the same transaction number.</span>
<a name="l00798"></a>00798     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = this-&gt;GetItemByOfficialNum(theItem.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00799"></a>00799     
<a name="l00800"></a>00800     <span class="comment">// If it&#39;s not already on the list, then add it...</span>
<a name="l00801"></a>00801     <span class="keywordflow">if</span> ( NULL == pCronItem )
<a name="l00802"></a>00802     {
<a name="l00803"></a>00803         <span class="comment">// If I&#39;ve been instructed to save the receipt, and theItem did NOT successfully save the receipt,</span>
<a name="l00804"></a>00804         <span class="comment">// then return false.</span>
<a name="l00805"></a>00805         <span class="comment">//</span>
<a name="l00806"></a>00806         <span class="comment">// This will happen if filesystem problems, but it will also happen if the cron item WAS ALREADY THERE.</span>
<a name="l00807"></a>00807         <span class="comment">// I don&#39;t want to save over it. If I&#39;m trying to save over one that is already there, then THAT is the</span>
<a name="l00808"></a>00808         <span class="comment">// real problem.</span>
<a name="l00809"></a>00809         <span class="comment">//</span>
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (bSaveReceipt &amp;&amp; 
<a name="l00811"></a>00811             <span class="comment">// ---------------------------</span>
<a name="l00812"></a>00812             (!theItem.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*GetServerNym()) ||  <span class="comment">// Notice the server adds its signature before saving the cron receipt to local storage. This way, the server can verify its own signature later, as evidence the file hasn&#39;t been tampered with. (BOTH signatures are there now--user&#39;s and server&#39;s.)</span>
<a name="l00813"></a>00813              !theItem.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>() || 
<a name="l00814"></a>00814              !theItem.<a class="code" href="class_o_t_cron_item.html#aebfbcf50eeb2effe9c3189518910b48d">SaveCronReceipt</a>()))
<a name="l00815"></a>00815         {
<a name="l00816"></a>00816             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving receipt while adding new CronItem to Cron.\n&quot;</span>,
<a name="l00817"></a>00817                           __FUNCTION__);
<a name="l00818"></a>00818             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820         <span class="comment">// --------------------------------------------------------</span>
<a name="l00821"></a>00821         <span class="comment">// Insert to the MAP (by Transaction Number)</span>
<a name="l00822"></a>00822         <span class="comment">//</span>
<a name="l00823"></a>00823         m_mapCronItems.insert( std::pair&lt;int64_t, OTCronItem *&gt;(theItem.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(), &amp;theItem) );
<a name="l00824"></a>00824         <span class="comment">// --------------------------------------------------------</span>
<a name="l00825"></a>00825         <span class="comment">// Insert to the MULTIMAP (by Date)</span>
<a name="l00826"></a>00826         <span class="comment">//</span>
<a name="l00827"></a>00827         m_multimapCronItems.insert (m_multimapCronItems.upper_bound(tDateAdded),
<a name="l00828"></a>00828                                     std::pair&lt;time64_t, OTCronItem *&gt;(tDateAdded, &amp;theItem) );
<a name="l00829"></a>00829         <span class="comment">// --------------------------------------------------------</span>
<a name="l00830"></a>00830         theItem.<a class="code" href="class_o_t_cron_item.html#a3ec8412d780384e48c756eff6726002c">SetCronPointer</a>(*<span class="keyword">this</span>); <span class="comment">// This way every CronItem has a pointer to momma.</span>
<a name="l00831"></a>00831         <span class="comment">// --------------------------------------------------------</span>
<a name="l00832"></a>00832         <span class="keywordtype">bool</span> bSuccess = <span class="keyword">true</span>;
<a name="l00833"></a>00833         <span class="comment">// ------------------------------------------------------</span>
<a name="l00834"></a>00834         theItem.<a class="code" href="class_o_t_cron_item.html#a9f3818706d6fe1b8880c538392b4d62c">HookActivationOnCron</a>(pActivator, <span class="comment">// (OTPseudonym * pActivator) // sometimes NULL.</span>
<a name="l00835"></a>00835                                      bSaveReceipt); <span class="comment">// If merely being reloaded after server reboot, this is false. </span>
<a name="l00836"></a>00836                                                     <span class="comment">// But if actually being activated for the first time, then this is true.</span>
<a name="l00837"></a>00837         <span class="comment">// ------------------------------------------------------</span>
<a name="l00838"></a>00838         <span class="comment">// When an item is added to Cron for the first time, a copy of it is saved to the</span>
<a name="l00839"></a>00839         <span class="comment">// cron folder, and it has the user&#39;s original signature on it. (If it&#39;s a Trade, </span>
<a name="l00840"></a>00840         <span class="comment">// it also contains an Offer with the user&#39;s original signature.) This occurs</span>
<a name="l00841"></a>00841         <span class="comment">// wherever this function is called with bSaveReceipt=true.</span>
<a name="l00842"></a>00842         <span class="comment">//</span>
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (bSaveReceipt)   <span class="comment">// This executes only the first time that an item is added to Cron. </span>
<a name="l00844"></a>00844                             <span class="comment">// (versus when it&#39;s just being reloaded from file and added back to the internal list.)</span>
<a name="l00845"></a>00845         {
<a name="l00846"></a>00846             <span class="comment">// Now that a copy of the cronitem is safely stored, I can release the signature on it</span>
<a name="l00847"></a>00847             <span class="comment">// and sign it with the Server&#39;s Nym instead. That way I can use the server to verify</span>
<a name="l00848"></a>00848             <span class="comment">// all cron and market-related activity from here on out.</span>
<a name="l00849"></a>00849 <span class="comment">//          theItem.ReleaseSignatures();</span>
<a name="l00850"></a>00850 <span class="comment">//          theItem.SignContract(*GetServerNym()); // THIS IS NOW DONE ABOVE. See if (bSaveReceipt) ...</span>
<a name="l00851"></a>00851 <span class="comment">//          theItem.SaveContract(); </span>
<a name="l00852"></a>00852             
<a name="l00853"></a>00853             <span class="comment">// Since we added an item to the Cron, we SAVE it. </span>
<a name="l00854"></a>00854             bSuccess = SaveCron();
<a name="l00855"></a>00855             
<a name="l00856"></a>00856             <span class="keywordflow">if</span> (bSuccess)
<a name="l00857"></a>00857                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: New CronItem has been added to Cron: %lld\n&quot;</span>,
<a name="l00858"></a>00858                               __FUNCTION__, theItem.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00859"></a>00859             <span class="keywordflow">else</span>                
<a name="l00860"></a>00860                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error saving while adding new CronItem to Cron: %lld\n&quot;</span>,
<a name="l00861"></a>00861                               __FUNCTION__, theItem.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00862"></a>00862         }
<a name="l00863"></a>00863         
<a name="l00864"></a>00864         <span class="keywordflow">return</span> bSuccess; 
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866     <span class="comment">// Otherwise, if it was already there, log an error.</span>
<a name="l00867"></a>00867     <span class="keywordflow">else</span> 
<a name="l00868"></a>00868     {
<a name="l00869"></a>00869         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed attempt to add CronItem with pre-existing transaction number: %lld\n&quot;</span>,
<a name="l00870"></a>00870                       __FUNCTION__, theItem.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872     
<a name="l00873"></a>00873     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="class_o_t_cron.html#a8db968a79df5cee7258c4c08ba07973b">00877</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a8db968a79df5cee7258c4c08ba07973b">OTCron::RemoveCronItem</a>(int64_t lTransactionNum, <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theRemover) <span class="comment">// if returns false, item wasn&#39;t found.</span>
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879     <span class="comment">// See if there&#39;s a cron item with that transaction number.</span>
<a name="l00880"></a>00880     mapOfCronItems::iterator it_map = this-&gt;FindItemOnMap(lTransactionNum);
<a name="l00881"></a>00881     <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00882"></a>00882     <span class="comment">// If it&#39;s not already on the list, then there&#39;s nothing to remove.</span>
<a name="l00883"></a>00883     <span class="keywordflow">if</span> ( m_mapCronItems.end() == it_map )
<a name="l00884"></a>00884     {
<a name="l00885"></a>00885         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Attempt to remove non-existent CronItem from OTCron. Transaction #: %lld\n&quot;</span>,
<a name="l00886"></a>00886                       __FUNCTION__, lTransactionNum);
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888     <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00889"></a>00889     <span class="comment">// Otherwise, if it WAS already there, remove it properly.</span>
<a name="l00890"></a>00890     <span class="keywordflow">else</span> 
<a name="l00891"></a>00891     {
<a name="l00892"></a>00892         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*it_map).second;
<a name="l00893"></a>00893 <span class="comment">//      OT_ASSERT(NULL != pItem); // Already done in FindItemOnMap.</span>
<a name="l00894"></a>00894         <span class="comment">// ---------------------------------------</span>
<a name="l00895"></a>00895         <span class="comment">// We have to remove it from the multimap as well.</span>
<a name="l00896"></a>00896         multimapOfCronItems::iterator it_multimap = this-&gt;FindItemOnMultimap(lTransactionNum);
<a name="l00897"></a>00897         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(m_multimapCronItems.end() != it_multimap); <span class="comment">// If found on map, MUST be on multimap also.</span>
<a name="l00898"></a>00898         <span class="comment">// ---------------------------------------</span>
<a name="l00899"></a>00899         pItem-&gt;<a class="code" href="class_o_t_cron_item.html#a70fe4a9257f50547dc62b4f553b05f2d">HookRemovalFromCron</a>(&amp;theRemover); <span class="comment">// We give the hook a chance to do its thing.</span>
<a name="l00900"></a>00900         <span class="comment">// ---------------------------------------</span>
<a name="l00901"></a>00901         m_mapCronItems     .erase(it_map);      <span class="comment">// Remove from MAP.</span>
<a name="l00902"></a>00902         m_multimapCronItems.erase(it_multimap); <span class="comment">// Remove from MULTIMAP.</span>
<a name="l00903"></a>00903         <span class="comment">// ---------------------------------------</span>
<a name="l00904"></a>00904         <span class="keyword">delete</span> pItem;
<a name="l00905"></a>00905         <span class="comment">// ---------------------------------------</span>
<a name="l00906"></a>00906         <span class="comment">// An item has been removed from Cron. SAVE.</span>
<a name="l00907"></a>00907         <span class="keywordflow">return</span> SaveCron();
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909     <span class="comment">// ---------------------------------------</span>
<a name="l00910"></a>00910     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 <span class="comment">// Look up a transaction by transaction number and see if it is in the map.</span>
<a name="l00915"></a>00915 <span class="comment">// If it is, return an iterator to it, otherwise return m_mapCronItems.end()</span>
<a name="l00916"></a>00916 <span class="comment">//</span>
<a name="l00917"></a>00917 <span class="comment">// Note: only the &quot;official&quot; transaction number will work here.</span>
<a name="l00918"></a>00918 <span class="comment">// If the cron item contains multiple opening numbers, the only one</span>
<a name="l00919"></a>00919 <span class="comment">// that will work in this function is the &quot;official&quot; one, the one that</span>
<a name="l00920"></a>00920 <span class="comment">// belongs to the Nym who actually activated this Cron Item.</span>
<a name="l00921"></a>00921 <span class="comment">//</span>
<a name="l00922"></a><a class="code" href="class_o_t_cron.html#aedcabce992fbabf7737fcbd9ae89b1d6">00922</a> mapOfCronItems::iterator <a class="code" href="class_o_t_cron.html#aedcabce992fbabf7737fcbd9ae89b1d6">OTCron::FindItemOnMap</a>(int64_t lTransactionNum)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924     <span class="comment">// See if there&#39;s something there with lTransactionNum</span>
<a name="l00925"></a>00925     <span class="comment">// as its &quot;official&quot; number.</span>
<a name="l00926"></a>00926     <span class="comment">//</span>
<a name="l00927"></a>00927     mapOfCronItems::iterator itt = m_mapCronItems.find(lTransactionNum);
<a name="l00928"></a>00928     
<a name="l00929"></a>00929     <span class="keywordflow">if</span> ( itt != m_mapCronItems.end() ) <span class="comment">// Found it!</span>
<a name="l00930"></a>00930     {
<a name="l00931"></a>00931         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*itt).second;
<a name="l00932"></a>00932         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pItem));
<a name="l00933"></a>00933         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>() == lTransactionNum);
<a name="l00934"></a>00934         
<a name="l00935"></a>00935         <span class="keywordflow">return</span> itt;
<a name="l00936"></a>00936     }
<a name="l00937"></a>00937     
<a name="l00938"></a>00938     <span class="keywordflow">return</span> itt;
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 <span class="comment">// Look up a transaction by transaction number and see if it is in the multimap.</span>
<a name="l00943"></a>00943 <span class="comment">// If it is, return an iterator to it, otherwise return m_multimapCronItems.end()</span>
<a name="l00944"></a>00944 <span class="comment">//</span>
<a name="l00945"></a>00945 <span class="comment">// Note: only the &quot;official&quot; transaction number will work here.</span>
<a name="l00946"></a>00946 <span class="comment">// If the cron item contains multiple opening numbers, the only one</span>
<a name="l00947"></a>00947 <span class="comment">// that will work in this function is the &quot;official&quot; one, the one that</span>
<a name="l00948"></a>00948 <span class="comment">// belongs to the Nym who actually activated this Cron Item.</span>
<a name="l00949"></a>00949 <span class="comment">//</span>
<a name="l00950"></a><a class="code" href="class_o_t_cron.html#ab412c2adb3f43e26df041737f854dde1">00950</a> multimapOfCronItems::iterator <a class="code" href="class_o_t_cron.html#ab412c2adb3f43e26df041737f854dde1">OTCron::FindItemOnMultimap</a>(int64_t lTransactionNum)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952     multimapOfCronItems::iterator itt = m_multimapCronItems.begin();
<a name="l00953"></a>00953     
<a name="l00954"></a>00954     <span class="keywordflow">while</span> (m_multimapCronItems.end() != itt)
<a name="l00955"></a>00955     {
<a name="l00956"></a>00956         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*itt).second;
<a name="l00957"></a>00957         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pItem));
<a name="l00958"></a>00958         <span class="comment">// --------------------------------</span>
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>() == lTransactionNum)
<a name="l00960"></a>00960             <span class="keywordflow">break</span>;
<a name="l00961"></a>00961         <span class="comment">// --------------------------------</span>
<a name="l00962"></a>00962         ++itt;
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964     
<a name="l00965"></a>00965     <span class="keywordflow">return</span> itt;
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 <span class="comment">// Look up a transaction by transaction number and see if it is in the map.</span>
<a name="l00970"></a>00970 <span class="comment">// If it is, return a pointer to it, otherwise return NULL.</span>
<a name="l00971"></a>00971 <span class="comment">//</span>
<a name="l00972"></a>00972 <span class="comment">// Note: only the &quot;official&quot; transaction number will work here.</span>
<a name="l00973"></a>00973 <span class="comment">// If the cron item contains multiple opening numbers, the only one</span>
<a name="l00974"></a>00974 <span class="comment">// that will work in this function is the &quot;official&quot; one, the one that</span>
<a name="l00975"></a>00975 <span class="comment">// belongs to the Nym who actually activated this Cron Item.</span>
<a name="l00976"></a>00976 <span class="comment">//</span>
<a name="l00977"></a><a class="code" href="class_o_t_cron.html#a6d121cbd4e80ffc9c9237304af5d6370">00977</a> <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * <a class="code" href="class_o_t_cron.html#a6d121cbd4e80ffc9c9237304af5d6370">OTCron::GetItemByOfficialNum</a>(int64_t lTransactionNum)
<a name="l00978"></a>00978 {
<a name="l00979"></a>00979     <span class="comment">// See if there&#39;s something there with lTransactionNum</span>
<a name="l00980"></a>00980     <span class="comment">// as its &quot;official&quot; number.</span>
<a name="l00981"></a>00981     <span class="comment">//</span>
<a name="l00982"></a>00982     mapOfCronItems::iterator itt = m_mapCronItems.find(lTransactionNum);
<a name="l00983"></a>00983     
<a name="l00984"></a>00984     <span class="keywordflow">if</span> ( itt != m_mapCronItems.end() ) <span class="comment">// Found it!</span>
<a name="l00985"></a>00985     {
<a name="l00986"></a>00986         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*itt).second;
<a name="l00987"></a>00987         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pItem));
<a name="l00988"></a>00988         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pItem-&gt;<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>() == lTransactionNum);
<a name="l00989"></a>00989         
<a name="l00990"></a>00990         <span class="keywordflow">return</span> pItem;
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992     
<a name="l00993"></a>00993     <span class="keywordflow">return</span> NULL;
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="comment">// Look up a transaction by opening number and see if it is in the map.</span>
<a name="l00998"></a>00998 <span class="comment">// If it is, return a pointer to it, otherwise return NULL.</span>
<a name="l00999"></a>00999 <span class="comment">//</span>
<a name="l01000"></a>01000 <span class="comment">// Note: The &quot;official&quot; transaction number for a cron item belongs</span>
<a name="l01001"></a>01001 <span class="comment">// to to the Nym who activated it. But there are several &quot;valid&quot;</span>
<a name="l01002"></a>01002 <span class="comment">// opening numbers, each belonging to a different Nym who signed the</span>
<a name="l01003"></a>01003 <span class="comment">// Cron Item.</span>
<a name="l01004"></a>01004 <span class="comment">//</span>
<a name="l01005"></a>01005 <span class="comment">// This function searches based on any valid opening number, not necessarily</span>
<a name="l01006"></a>01006 <span class="comment">// by the one &quot;official&quot; number.</span>
<a name="l01007"></a>01007 <span class="comment">//</span>
<a name="l01008"></a><a class="code" href="class_o_t_cron.html#ab732ac1263aac936d8d948df3412119b">01008</a> <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * <a class="code" href="class_o_t_cron.html#ab732ac1263aac936d8d948df3412119b">OTCron::GetItemByValidOpeningNum</a>(int64_t lOpeningNum)
<a name="l01009"></a>01009 {
<a name="l01010"></a>01010     <span class="comment">// See if there&#39;s something there with that transaction number.</span>
<a name="l01011"></a>01011     mapOfCronItems::iterator itt = m_mapCronItems.find(lOpeningNum);
<a name="l01012"></a>01012 
<a name="l01013"></a>01013     <span class="keywordflow">if</span> ( itt == m_mapCronItems.end() )
<a name="l01014"></a>01014     {
<a name="l01015"></a>01015         <span class="comment">// We didn&#39;t find it as the &quot;official&quot; number, so let&#39;s loop</span>
<a name="l01016"></a>01016         <span class="comment">// through the cron items one-by-one and see if it&#39;s a valid</span>
<a name="l01017"></a>01017         <span class="comment">// opening number. (We searched for the &quot;official&quot; number first,</span>
<a name="l01018"></a>01018         <span class="comment">// since it will often be the right one, and avoids doing this</span>
<a name="l01019"></a>01019         <span class="comment">// longer search. Basically for optimization purposes.)</span>
<a name="l01020"></a>01020         <span class="comment">//</span>
<a name="l01021"></a>01021         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_cron_8hpp.html#a90e72314c5fd92c5f141cab3981cda22">mapOfCronItems</a>, m_mapCronItems)
<a name="l01022"></a>01022         {
<a name="l01023"></a>01023             <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*it).second;
<a name="l01024"></a>01024             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pItem));
<a name="l01025"></a>01025             <span class="comment">// ------------------------</span>
<a name="l01026"></a>01026             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_cron_item.html#a9fd34100c4c79adf325c61ba268008ef">IsValidOpeningNumber</a>(lOpeningNum)) <span class="comment">// Todo optimization. Probably can remove this check.</span>
<a name="l01027"></a>01027                 <span class="keywordflow">return</span> pItem;
<a name="l01028"></a>01028         }
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030     <span class="comment">// Found it!</span>
<a name="l01031"></a>01031     <span class="keywordflow">else</span> 
<a name="l01032"></a>01032     {
<a name="l01033"></a>01033         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = (*itt).second;
<a name="l01034"></a>01034         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pItem));
<a name="l01035"></a>01035         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pItem-&gt;<a class="code" href="class_o_t_cron_item.html#a9fd34100c4c79adf325c61ba268008ef">IsValidOpeningNumber</a>(lOpeningNum)); <span class="comment">// Todo optimization. Probably can remove this check.</span>
<a name="l01036"></a>01036         
<a name="l01037"></a>01037         <span class="keywordflow">return</span> pItem;
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039     
<a name="l01040"></a>01040     <span class="keywordflow">return</span> NULL;
<a name="l01041"></a>01041 }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 <span class="comment">// OTCron IS responsible for cleaning up theMarket, and takes ownership.</span>
<a name="l01045"></a>01045 <span class="comment">// So make SURE it is allocated on the HEAP before you pass it in here, and</span>
<a name="l01046"></a>01046 <span class="comment">// also make sure to delete it again if this call fails!</span>
<a name="l01047"></a><a class="code" href="class_o_t_cron.html#a140c03fce539cd99e61e2b5baed85f76">01047</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a140c03fce539cd99e61e2b5baed85f76">OTCron::AddMarket</a>(<a class="code" href="class_o_t_market.html">OTMarket</a> &amp; theMarket, <span class="keywordtype">bool</span> bSaveMarketFile<span class="comment">/*=true*/</span>)
<a name="l01048"></a>01048 {   
<a name="l01049"></a>01049     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != GetServerNym());
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     theMarket.<a class="code" href="class_o_t_market.html#afc579c8a9d0eb969ce4cd302701c7c9d">SetCronPointer</a>(*<span class="keyword">this</span>); <span class="comment">// This way every Market has a pointer to Cron.</span>
<a name="l01052"></a>01052     
<a name="l01053"></a>01053     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    MARKET_ID(theMarket);
<a name="l01054"></a>01054     <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l01055"></a>01055     std::string     std_MARKET_ID = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01056"></a>01056     
<a name="l01057"></a>01057     <span class="comment">// See if there&#39;s something else already there with the same market ID.</span>
<a name="l01058"></a>01058     mapOfMarkets::iterator ii = m_mapMarkets.find(std_MARKET_ID);
<a name="l01059"></a>01059     
<a name="l01060"></a>01060     <span class="comment">// If it&#39;s not already on the list, then add it...</span>
<a name="l01061"></a>01061     <span class="keywordflow">if</span> ( ii == m_mapMarkets.end() )
<a name="l01062"></a>01062     {
<a name="l01063"></a>01063         <span class="comment">// If I&#39;ve been instructed to save the market, and Cron did NOT successfully save the market</span>
<a name="l01064"></a>01064         <span class="comment">//  (to its own file), then return false.  This will happen if filesystem problems.</span>
<a name="l01065"></a>01065         <span class="keywordflow">if</span> (bSaveMarketFile &amp;&amp; !theMarket.<a class="code" href="class_o_t_market.html#ad19e688ee73a7358fe343358ff3e5b8a">SaveMarket</a>())
<a name="l01066"></a>01066         {
<a name="l01067"></a>01067             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Error saving market file while adding new Market to Cron:\n%s\n&quot;</span>,
<a name="l01068"></a>01068                          std_MARKET_ID.c_str());
<a name="l01069"></a>01069             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01070"></a>01070         }
<a name="l01071"></a>01071         
<a name="l01072"></a>01072         m_mapMarkets[std_MARKET_ID] = &amp;theMarket;
<a name="l01073"></a>01073         
<a name="l01074"></a>01074         <span class="keywordtype">bool</span> bSuccess = <span class="keyword">true</span>;
<a name="l01075"></a>01075         
<a name="l01076"></a>01076         <span class="comment">// When Cron serializes, it stores a list of all its markets in the main cron file.</span>
<a name="l01077"></a>01077         <span class="comment">// The actual markets themselves serialize separately to the market folder.</span>
<a name="l01078"></a>01078         <span class="comment">//</span>
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (bSaveMarketFile)    <span class="comment">// This executes only the first time that a market is added to Cron. </span>
<a name="l01080"></a>01080             <span class="comment">// (versus when it&#39;s just being reloaded from file and added back to the internal list.)</span>
<a name="l01081"></a>01081         {
<a name="l01082"></a>01082             <span class="comment">// Since we added a market to the Cron, we SAVE it. </span>
<a name="l01083"></a>01083             bSuccess = SaveCron(); <span class="comment">// If we&#39;re loading from file, and bSaveMarketFile is false, I don&#39;t want to save here. that&#39;s why it&#39;s in this block.</span>
<a name="l01084"></a>01084             
<a name="l01085"></a>01085             <span class="keywordflow">if</span> (bSuccess) 
<a name="l01086"></a>01086                 <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;New Market has been added to Cron.\n&quot;</span>);
<a name="l01087"></a>01087             <span class="keywordflow">else</span>                
<a name="l01088"></a>01088                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error saving while adding new Market to Cron.\n&quot;</span>);
<a name="l01089"></a>01089         }
<a name="l01090"></a>01090         
<a name="l01091"></a>01091         <span class="keywordflow">return</span> bSuccess; 
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093     <span class="comment">// Otherwise, if it was already there, log an error.</span>
<a name="l01094"></a>01094     <span class="keywordflow">else</span> 
<a name="l01095"></a>01095     {
<a name="l01096"></a>01096         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to add Market that was already there: %s\n&quot;</span>, std_MARKET_ID.c_str());
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098     
<a name="l01099"></a>01099     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 
<a name="l01103"></a><a class="code" href="class_o_t_cron.html#a3ef869ba62f1f9bf651ec48fe3fa2df0">01103</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#a3ef869ba62f1f9bf651ec48fe3fa2df0">OTCron::RemoveMarket</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; MARKET_ID) <span class="comment">// if false, market wasn&#39;t found.</span>
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105     <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l01106"></a>01106     std::string     std_MARKET_ID = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01107"></a>01107     
<a name="l01108"></a>01108     <span class="comment">// See if there&#39;s something there with that transaction number.</span>
<a name="l01109"></a>01109     mapOfMarkets::iterator ii = m_mapMarkets.find(std_MARKET_ID);
<a name="l01110"></a>01110     
<a name="l01111"></a>01111     <span class="comment">// If it&#39;s not already on the list, then there&#39;s nothing to remove.</span>
<a name="l01112"></a>01112     <span class="keywordflow">if</span> ( ii == m_mapMarkets.end() )
<a name="l01113"></a>01113     {
<a name="l01114"></a>01114         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Attempt to remove non-existent Market from OTCron:\n%s\n&quot;</span>,
<a name="l01115"></a>01115                       std_MARKET_ID.c_str());
<a name="l01116"></a>01116         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01117"></a>01117     }
<a name="l01118"></a>01118     <span class="comment">// Otherwise, if it WAS already there, remove it properly.</span>
<a name="l01119"></a>01119     <span class="keywordflow">else</span> 
<a name="l01120"></a>01120     {
<a name="l01121"></a>01121         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = (*ii).second;
<a name="l01122"></a>01122         
<a name="l01123"></a>01123         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l01124"></a>01124         
<a name="l01125"></a>01125         m_mapMarkets.erase(ii);
<a name="l01126"></a>01126         <span class="keyword">delete</span> pMarket;
<a name="l01127"></a>01127         
<a name="l01128"></a>01128         <span class="comment">// A market has been removed from Cron. SAVE.       </span>
<a name="l01129"></a>01129         <span class="keywordflow">return</span> SaveCron();      
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="comment">// Create it if it&#39;s not there.</span>
<a name="l01135"></a><a class="code" href="class_o_t_cron.html#af4fa1a950a600220ac5e570b58e892ff">01135</a> <a class="code" href="class_o_t_market.html">OTMarket</a> * <a class="code" href="class_o_t_cron.html#af4fa1a950a600220ac5e570b58e892ff">OTCron::GetOrCreateMarket</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID, 
<a name="l01136"></a>01136                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; CURRENCY_ID, <span class="keyword">const</span> int64_t &amp; lScale)
<a name="l01137"></a>01137 {   
<a name="l01138"></a>01138     <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = <span class="keyword">new</span> <a class="code" href="class_o_t_market.html">OTMarket</a>(GetServerID(), ASSET_ID, CURRENCY_ID, lScale);
<a name="l01139"></a>01139     
<a name="l01140"></a>01140     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMarket);
<a name="l01141"></a>01141     
<a name="l01142"></a>01142     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> MARKET_ID(*pMarket);
<a name="l01143"></a>01143     
<a name="l01144"></a>01144     <a class="code" href="class_o_t_market.html">OTMarket</a> * pExistingMarket = GetMarket(MARKET_ID);
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     <span class="comment">// If it was already there, there&#39;s no need to create it.</span>
<a name="l01147"></a>01147     <span class="keywordflow">if</span> (NULL != pExistingMarket)
<a name="l01148"></a>01148     {
<a name="l01149"></a>01149         <span class="keyword">delete</span> pMarket; pMarket = NULL;
<a name="l01150"></a>01150         <span class="keywordflow">return</span> pExistingMarket;
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152     
<a name="l01153"></a>01153     <span class="comment">// If we got this far, it means the Market does NOT already exist in this Cron.</span>
<a name="l01154"></a>01154     <span class="comment">// So let&#39;s add it...</span>
<a name="l01155"></a>01155     <span class="keywordtype">bool</span> bAdded = AddMarket(*pMarket, <span class="keyword">true</span>); <span class="comment">// bool bSaveMarketFile=true, since it was created new.</span>
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keywordflow">if</span> (bAdded)
<a name="l01158"></a>01158     {
<a name="l01159"></a>01159         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;New market created and added to Cron.\n&quot;</span>);
<a name="l01160"></a>01160     }
<a name="l01161"></a>01161     <span class="keywordflow">else</span> 
<a name="l01162"></a>01162     {
<a name="l01163"></a>01163         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error trying to add new market to Cron.\n&quot;</span>);
<a name="l01164"></a>01164         <span class="keyword">delete</span> pMarket;
<a name="l01165"></a>01165         pMarket = NULL;
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167     
<a name="l01168"></a>01168     <span class="keywordflow">return</span> pMarket;
<a name="l01169"></a>01169 }
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 
<a name="l01172"></a>01172 <span class="comment">// Look up a transaction by transaction number and see if it is in the ledger.</span>
<a name="l01173"></a>01173 <span class="comment">// If it is, return a pointer to it, otherwise return NULL.</span>
<a name="l01174"></a><a class="code" href="class_o_t_cron.html#afcc38ab744f5e3710982c600c4412cf2">01174</a> <a class="code" href="class_o_t_market.html">OTMarket</a> * <a class="code" href="class_o_t_cron.html#afcc38ab744f5e3710982c600c4412cf2">OTCron::GetMarket</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; MARKET_ID)
<a name="l01175"></a>01175 {
<a name="l01176"></a>01176     <a class="code" href="class_o_t_string.html">OTString</a>        str_MARKET_ID(MARKET_ID);
<a name="l01177"></a>01177     std::string     std_MARKET_ID = str_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01178"></a>01178     
<a name="l01179"></a>01179     <span class="comment">// See if there&#39;s something there with that transaction number.</span>
<a name="l01180"></a>01180     mapOfMarkets::iterator ii = m_mapMarkets.find(std_MARKET_ID);
<a name="l01181"></a>01181     
<a name="l01182"></a>01182     <span class="keywordflow">if</span> ( ii == m_mapMarkets.end() )
<a name="l01183"></a>01183     {
<a name="l01184"></a>01184         <span class="comment">// nothing found.</span>
<a name="l01185"></a>01185         <span class="keywordflow">return</span> NULL;
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     <span class="comment">// Found it!</span>
<a name="l01188"></a>01188     <span class="keywordflow">else</span> 
<a name="l01189"></a>01189     {
<a name="l01190"></a>01190         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = (*ii).second;
<a name="l01191"></a>01191         
<a name="l01192"></a>01192         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pMarket));
<a name="l01193"></a>01193         
<a name="l01194"></a>01194         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  LOOP_MARKET_ID(*pMarket);
<a name="l01195"></a>01195         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      str_LOOP_MARKET_ID(LOOP_MARKET_ID);
<a name="l01196"></a>01196         
<a name="l01197"></a>01197         <span class="keywordflow">if</span> (MARKET_ID == LOOP_MARKET_ID)
<a name="l01198"></a>01198             <span class="keywordflow">return</span> pMarket;
<a name="l01199"></a>01199         <span class="keywordflow">else</span> 
<a name="l01200"></a>01200             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Expected Market with ID:\n%s\n but found %s\n&quot;</span>,
<a name="l01201"></a>01201                           std_MARKET_ID.c_str(), str_LOOP_MARKET_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203     
<a name="l01204"></a>01204     <span class="keywordflow">return</span> NULL;
<a name="l01205"></a>01205 }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207 
<a name="l01208"></a><a class="code" href="class_o_t_cron.html#a5a23a6680d03524413273619754b50f8">01208</a> <a class="code" href="class_o_t_cron.html#a5a23a6680d03524413273619754b50f8">OTCron::OTCron</a>() : <a class="code" href="class_o_t_contract.html">ot_super</a>(), m_bIsActivated(false), m_pServerNym(NULL) <span class="comment">// just here for convenience, not responsible to cleanup this pointer.</span>
<a name="l01209"></a>01209 {
<a name="l01210"></a>01210     <a class="code" href="class_o_t_cron.html#a77c951666003558d04a02228bd2d2ff7">InitCron</a>();
<a name="l01211"></a>01211     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;OTCron::OTCron: Finished calling InitCron 0.\n&quot;</span>);
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 
<a name="l01215"></a><a class="code" href="class_o_t_cron.html#ab9187f8ef70b5e8da33b0a7f7288b8e2">01215</a> <a class="code" href="class_o_t_cron.html#a5a23a6680d03524413273619754b50f8">OTCron::OTCron</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID) : <a class="code" href="class_o_t_contract.html">ot_super</a>(), m_bIsActivated(false), m_pServerNym(NULL) <span class="comment">// just here for convenience, not responsible to cleanup this pointer.</span>
<a name="l01216"></a>01216 {
<a name="l01217"></a>01217     <a class="code" href="class_o_t_cron.html#a77c951666003558d04a02228bd2d2ff7">InitCron</a>(); 
<a name="l01218"></a>01218     <a class="code" href="class_o_t_cron.html#a7c421c0abe1a6728a2a056bfb46a3de2">SetServerID</a>(SERVER_ID);
<a name="l01219"></a>01219     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;OTCron::OTCron: Finished calling InitCron 1.\n&quot;</span>);
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 
<a name="l01223"></a><a class="code" href="class_o_t_cron.html#a38ae0d6032705c5024f33b81d97dc8a6">01223</a> <a class="code" href="class_o_t_cron.html#a5a23a6680d03524413273619754b50f8">OTCron::OTCron</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * szFilename) : <a class="code" href="class_o_t_contract.html">ot_super</a>(), m_bIsActivated(false), m_pServerNym(NULL) <span class="comment">// just here for convenience, not responsible to cleanup this pointer.</span>
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != szFilename);
<a name="l01226"></a>01226     <a class="code" href="class_o_t_cron.html#a77c951666003558d04a02228bd2d2ff7">InitCron</a>();
<a name="l01227"></a>01227     
<a name="l01228"></a>01228     <a class="code" href="class_o_t_contract.html#ab1e11693a38a1673037b1f29c9d84010">m_strFoldername</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<a class="code" href="class_o_t_folders.html#aabb5605423422af18b156b9cd5e48c22">OTFolders::Cron</a>().Get());
<a name="l01229"></a>01229     <a class="code" href="class_o_t_contract.html#ab7ab1f1fe7ff7e52f2c126404a8f4f92">m_strFilename</a>.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(szFilename);
<a name="l01230"></a>01230     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(3, <span class="stringliteral">&quot;OTCron::OTCron: Finished calling InitCron 2.\n&quot;</span>);
<a name="l01231"></a>01231 }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233 
<a name="l01234"></a><a class="code" href="class_o_t_cron.html#aecf46efa13fe912238e3218d404f8f6d">01234</a> <a class="code" href="class_o_t_cron.html#aecf46efa13fe912238e3218d404f8f6d">OTCron::~OTCron</a>()
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236     <a class="code" href="class_o_t_cron.html#aa1cf58f86207ccdd857ae16ef2488f8f">Release_Cron</a>();
<a name="l01237"></a>01237     
<a name="l01238"></a>01238     m_pServerNym = NULL;
<a name="l01239"></a>01239 }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 
<a name="l01242"></a><a class="code" href="class_o_t_cron.html#a77c951666003558d04a02228bd2d2ff7">01242</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#a77c951666003558d04a02228bd2d2ff7">OTCron::InitCron</a>()
<a name="l01243"></a>01243 {
<a name="l01244"></a>01244     <a class="code" href="class_o_t_contract.html#ac523dac7d72b72e54b1ebb5b3a3b21cc">m_strContractType</a> = <span class="stringliteral">&quot;CRON&quot;</span>;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 
<a name="l01248"></a><a class="code" href="class_o_t_cron.html#a7ec2571d52ceaab093afe06f7746c08b">01248</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#a7ec2571d52ceaab093afe06f7746c08b">OTCron::Release</a>()
<a name="l01249"></a>01249 {
<a name="l01250"></a>01250     <a class="code" href="class_o_t_cron.html#aa1cf58f86207ccdd857ae16ef2488f8f">Release_Cron</a>();
<a name="l01251"></a>01251     <span class="comment">// ------------------ </span>
<a name="l01252"></a>01252     <a class="code" href="class_o_t_contract.html#a15e423ca0d650858a23e54f8285feae1">ot_super::Release</a>();
<a name="l01253"></a>01253     <span class="comment">// ------------------ </span>
<a name="l01254"></a>01254     <span class="comment">// Then I call this to re-initialize everything for myself.</span>
<a name="l01255"></a>01255     <span class="comment">//</span>
<a name="l01256"></a>01256 <span class="comment">//  InitCron();         </span>
<a name="l01257"></a>01257 }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 
<a name="l01260"></a><a class="code" href="class_o_t_cron.html#aa1cf58f86207ccdd857ae16ef2488f8f">01260</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_cron.html#aa1cf58f86207ccdd857ae16ef2488f8f">OTCron::Release_Cron</a>()
<a name="l01261"></a>01261 {
<a name="l01262"></a>01262     <span class="comment">// If there were any dynamically allocated objects, clean them up here.</span>
<a name="l01263"></a>01263     <span class="comment">// --------------------------------------------</span>
<a name="l01264"></a>01264     <span class="keywordflow">while</span> (!m_multimapCronItems.empty())
<a name="l01265"></a>01265     {
<a name="l01266"></a>01266         multimapOfCronItems::iterator ii = m_multimapCronItems.begin();
<a name="l01267"></a>01267         m_multimapCronItems.erase(ii);
<a name="l01268"></a>01268         
<a name="l01269"></a>01269         <span class="comment">// We don&#39;t delete the pItem in here, since these are the</span>
<a name="l01270"></a>01270         <span class="comment">// same pItems being deleted in the next block.</span>
<a name="l01271"></a>01271     }
<a name="l01272"></a>01272     <span class="comment">// --------------------------------------------</span>
<a name="l01273"></a>01273     <span class="keywordflow">while</span> (!m_mapCronItems.empty())
<a name="l01274"></a>01274     {
<a name="l01275"></a>01275         <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = m_mapCronItems.begin()-&gt;second;
<a name="l01276"></a>01276         mapOfCronItems::iterator ii = m_mapCronItems.begin();
<a name="l01277"></a>01277         m_mapCronItems.erase(ii);
<a name="l01278"></a>01278         <span class="keyword">delete</span> pItem;
<a name="l01279"></a>01279         pItem = NULL;
<a name="l01280"></a>01280     }
<a name="l01281"></a>01281     <span class="comment">// --------------------------------------------</span>
<a name="l01282"></a>01282     <span class="keywordflow">while</span> (!m_mapMarkets.empty())
<a name="l01283"></a>01283     {
<a name="l01284"></a>01284         <a class="code" href="class_o_t_market.html">OTMarket</a> * pMarket = m_mapMarkets.begin()-&gt;second;
<a name="l01285"></a>01285         mapOfMarkets::iterator ii = m_mapMarkets.begin();
<a name="l01286"></a>01286         m_mapMarkets.erase(ii);
<a name="l01287"></a>01287         <span class="keyword">delete</span> pMarket;
<a name="l01288"></a>01288         pMarket = NULL;     
<a name="l01289"></a>01289     }
<a name="l01290"></a>01290 }
<a name="l01291"></a>01291 
<a name="l01292"></a>01292 
<a name="l01293"></a><a class="code" href="class_o_t_cron.html#aa40e13f9fa75869b77e57de7b88c21b9">01293</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_cron.html#aa40e13f9fa75869b77e57de7b88c21b9">OTCron::SaveContractWallet</a>(std::ofstream &amp; ofs)
<a name="l01294"></a>01294 {
<a name="l01295"></a>01295     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01296"></a>01296 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_cron_8cpp.html">OTCron.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:03 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
