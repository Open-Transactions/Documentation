<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otapi/OpenTransactions.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_open_transactions_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otapi/OpenTransactions.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_open_transactions_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*****************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *  OpenTransactions.cpp  ( low-level api for OTLIB )</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *      This file contains 2 classes:</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> *  OTSocket: This class helps with connecting to a ot server.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *  OT_API: This class provides functions for many core tasks</span>
<a name="l00010"></a>00010 <span class="comment"> *      using the otlib.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> */</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">/************************************************************</span>
<a name="l00015"></a>00015 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00016"></a>00016 <span class="comment"> Hash: SHA1</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00021"></a>00021 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00024"></a>00024 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00025"></a>00025 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00026"></a>00026 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00027"></a>00027 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00028"></a>00028 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00029"></a>00029 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> *  EMAIL:</span>
<a name="l00034"></a>00034 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00039"></a>00039 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00042"></a>00042 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00043"></a>00043 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00044"></a>00044 <span class="comment"> *</span>
<a name="l00045"></a>00045 <span class="comment"> *  WEBSITE:</span>
<a name="l00046"></a>00046 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> *  Components and licensing:</span>
<a name="l00049"></a>00049 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00050"></a>00050 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00051"></a>00051 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00052"></a>00052 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00053"></a>00053 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00054"></a>00054 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00057"></a>00057 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00058"></a>00058 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00059"></a>00059 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00060"></a>00060 <span class="comment"> *</span>
<a name="l00061"></a>00061 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   LICENSE:</span>
<a name="l00064"></a>00064 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00065"></a>00065 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00066"></a>00066 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00067"></a>00067 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00068"></a>00068 <span class="comment"> *   option) any later version.</span>
<a name="l00069"></a>00069 <span class="comment"> *</span>
<a name="l00070"></a>00070 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00071"></a>00071 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00072"></a>00072 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00073"></a>00073 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00074"></a>00074 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00075"></a>00075 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00076"></a>00076 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00077"></a>00077 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00078"></a>00078 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00079"></a>00079 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00080"></a>00080 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00081"></a>00081 <span class="comment"> *</span>
<a name="l00082"></a>00082 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00083"></a>00083 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00084"></a>00084 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00085"></a>00085 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00086"></a>00086 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00087"></a>00087 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00088"></a>00088 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00089"></a>00089 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00090"></a>00090 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00091"></a>00091 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00092"></a>00092 <span class="comment"> *</span>
<a name="l00093"></a>00093 <span class="comment"> *   Lucre License:</span>
<a name="l00094"></a>00094 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00095"></a>00095 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00096"></a>00096 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00097"></a>00097 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00098"></a>00098 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00099"></a>00099 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00100"></a>00100 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00101"></a>00101 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00102"></a>00102 <span class="comment"> *   will continue to operate.</span>
<a name="l00103"></a>00103 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00104"></a>00104 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00105"></a>00105 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00106"></a>00106 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00107"></a>00107 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00108"></a>00108 <span class="comment"> *</span>
<a name="l00109"></a>00109 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00110"></a>00110 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00111"></a>00111 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00112"></a>00112 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00113"></a>00113 <span class="comment"> *</span>
<a name="l00114"></a>00114 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00115"></a>00115 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00116"></a>00116 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00117"></a>00117 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00118"></a>00118 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00119"></a>00119 <span class="comment"> *   more details.</span>
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00122"></a>00122 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00125"></a>00125 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00126"></a>00126 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00127"></a>00127 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00128"></a>00128 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00129"></a>00129 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00130"></a>00130 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00131"></a>00131 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00132"></a>00132 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00133"></a>00133 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00134"></a>00134 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00135"></a>00135 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00136"></a>00136 <span class="comment"> =uSzz</span>
<a name="l00137"></a>00137 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00138"></a>00138 <span class="comment"> **************************************************************/</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;<a class="code" href="_open_transactions_8hpp.html">OpenTransactions.hpp</a>&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_client_8hpp.html">OTClient.hpp</a>&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_a_p_i_8hpp.html">OTAPI.hpp</a>&gt;</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_basket_8hpp.html">OTBasket.hpp</a>&gt;</span>
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_cheque_8hpp.html">OTCheque.hpp</a>&gt;</span>
<a name="l00148"></a>00148 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_envelope_8hpp.html">OTEnvelope.hpp</a>&gt;</span>
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_ledger_8hpp.html">OTLedger.hpp</a>&gt;</span>
<a name="l00150"></a>00150 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00151"></a>00151 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_message_8hpp.html">OTMessage.hpp</a>&gt;</span>
<a name="l00152"></a>00152 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_mint_8hpp.html">OTMint.hpp</a>&gt;</span>
<a name="l00153"></a>00153 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_offer_8hpp.html">OTOffer.hpp</a>&gt;</span>
<a name="l00154"></a>00154 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_password_8hpp.html">OTPassword.hpp</a>&gt;</span>
<a name="l00155"></a>00155 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_paths_8hpp.html">OTPaths.hpp</a>&gt;</span>
<a name="l00156"></a>00156 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_8hpp.html">OTPayment.hpp</a>&gt;</span>
<a name="l00157"></a>00157 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_payment_plan_8hpp.html">OTPaymentPlan.hpp</a>&gt;</span>
<a name="l00158"></a>00158 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_purse_8hpp.html">OTPurse.hpp</a>&gt;</span>
<a name="l00159"></a>00159 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_smart_contract_8hpp.html">OTSmartContract.hpp</a>&gt;</span>
<a name="l00160"></a>00160 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_symmetric_key_8hpp.html">OTSymmetricKey.hpp</a>&gt;</span>
<a name="l00161"></a>00161 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_trade_8hpp.html">OTTrade.hpp</a>&gt;</span>
<a name="l00162"></a>00162 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_wallet_8hpp.html">OTWallet.hpp</a>&gt;</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_socket_8hpp.html">OTSocket.hpp</a>&gt;</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00167"></a>00167 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="preprocessor">#include &quot;tinythread.hpp&quot;</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="preprocessor">#if defined (OPENTXS_HAVE_NETINET_IN_H)</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span>
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 <span class="preprocessor">#endif</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="_open_transactions_8cpp.html#a290ff9c13a30b35f59668b82ca68d4e3">00183</a> <span class="preprocessor">#define CLIENT_DEFAULT_LATENCY_SEND_MS              200</span>
<a name="l00184"></a><a class="code" href="_open_transactions_8cpp.html#a0a9667963ecd92a68b3b014f07083f0c">00184</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DEFAULT_LATENCY_SEND_NO_TRIES        7</span>
<a name="l00185"></a><a class="code" href="_open_transactions_8cpp.html#a260f7705019dbcde2805b187fc32c296">00185</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DEFAULT_LATENCY_RECEIVE_MS           200</span>
<a name="l00186"></a><a class="code" href="_open_transactions_8cpp.html#ac9f275dd072f7e6a8f3513667150a952">00186</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DEFAULT_LATENCY_RECEIVE_NO_TRIES 7</span>
<a name="l00187"></a><a class="code" href="_open_transactions_8cpp.html#a307024706ce20afb5f4626ea769e81d2">00187</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DEFAULT_LATENCY_DELAY_AFTER          50</span>
<a name="l00188"></a><a class="code" href="_open_transactions_8cpp.html#a8d9c01e8d496678f796ee06962de888c">00188</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DEFAULT_IS_BLOCKING                  false</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="_open_transactions_8cpp.html#a4675407b5b05d15570f0483f144789fd">00191</a> <span class="preprocessor">#define CLIENT_CONFIG_KEY &quot;client&quot;</span>
<a name="l00192"></a><a class="code" href="_open_transactions_8cpp.html#a3c2c6b23858dc4cdcce514e29ae41a61">00192</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_DATA_DIR &quot;client_data&quot;</span>
<a name="l00193"></a><a class="code" href="_open_transactions_8cpp.html#a8666fc105432efdd07053787800e7214">00193</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_LOGFILE_FILENAME &quot;log-client.log&quot;</span>
<a name="l00194"></a><a class="code" href="_open_transactions_8cpp.html#a6ca020e7a6f02c7a8d769e9fa32dcd01">00194</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_MASTER_KEY_TIMEOUT_DEFAULT 300</span>
<a name="l00195"></a><a class="code" href="_open_transactions_8cpp.html#a0b134c6acd01ee1f9ed1fd48cd7c9511">00195</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_WALLET_FILENAME &quot;wallet.xml&quot;</span>
<a name="l00196"></a><a class="code" href="_open_transactions_8cpp.html#af566d6ce4bb1ffea9f5a698fc199bbc2">00196</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_USE_SYSTEM_KEYRING false</span>
<a name="l00197"></a><a class="code" href="_open_transactions_8cpp.html#afa01c4388d318bdf43542fcbf23b0659">00197</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_PASSWORD_FOLDER &quot;&quot;</span>
<a name="l00198"></a><a class="code" href="_open_transactions_8cpp.html#ab958b72fdeccb19281ea04c460db92cb">00198</a> <span class="preprocessor"></span><span class="preprocessor">#define CLIENT_PID_FILENAME &quot;ot.pid&quot;</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">// ------------------------------------------------------------------------------</span>
<a name="l00203"></a>00203 <span class="comment">//static</span>
<a name="l00204"></a>00204 <span class="keywordtype">bool</span> OT_API::bInitOTApp = <span class="keyword">false</span>;
<a name="l00205"></a>00205 <span class="comment">//static</span>
<a name="l00206"></a>00206 <span class="keywordtype">bool</span> OT_API::bCleanupOTApp = <span class="keyword">false</span>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="struct_transport_callback.html#ae441ce16f6993a651a4ca819ca9e1b35">00209</a> <a class="code" href="struct_transport_callback.html#ae441ce16f6993a651a4ca819ca9e1b35">TransportCallback::TransportCallback</a>(<a class="code" href="class_o_t___a_p_i.html">OT_API</a> &amp; refOT_API)
<a name="l00210"></a>00210     : m_refOT_API(refOT_API)
<a name="l00211"></a>00211     {
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="struct_transport_callback.html#a590f7bfcba5cd19137101de5d4bcf354">00214</a> <a class="code" href="struct_transport_callback.html#a590f7bfcba5cd19137101de5d4bcf354">TransportCallback::~TransportCallback</a>()
<a name="l00215"></a>00215     {
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="comment">// Transport Callback Main Operator</span>
<a name="l00220"></a><a class="code" href="struct_transport_callback.html#af5b03ed966e31c6fe8e994a4c785be8f">00220</a> <span class="keywordtype">bool</span> <a class="code" href="struct_transport_callback.html#af5b03ed966e31c6fe8e994a4c785be8f">TransportCallback::operator() </a>(<a class="code" href="class_o_t_server_contract.html">OTServerContract</a>&amp; theserverContract,<a class="code" href="class_o_t_envelope.html">OTEnvelope</a>&amp; theEnvelope)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (this-&gt;m_refOT_API.<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>())
<a name="l00223"></a>00223         <span class="keywordflow">return</span> this-&gt;m_refOT_API.<a class="code" href="class_o_t___a_p_i.html#a597eab7dd06eba0ae38de43717fb775f">TransportFunction</a>(theserverContract,theEnvelope);
<a name="l00224"></a>00224     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="comment">// ***************************************************************************</span>
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="comment">// Call this once per run of the software. (enforced by a static value)</span>
<a name="l00230"></a>00230 <span class="comment">//</span>
<a name="l00231"></a>00231 <span class="comment">//static</span>
<a name="l00232"></a><a class="code" href="class_o_t___a_p_i.html#adc39b64382968c133c59fd7bf52124de">00232</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#adc39b64382968c133c59fd7bf52124de">OT_API::InitOTApp</a>()
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(!OT_API::bCleanupOTApp);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (!OT_API::bInitOTApp)
<a name="l00237"></a>00237     {
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_log.html#a35ff36b83c644febc07a8a736c4ea9b5">OTLog::Init</a>(<span class="stringliteral">&quot;client&quot;</span>)) { assert(<span class="keyword">false</span>); }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="comment">// ------------------------------------</span>
<a name="l00241"></a>00241         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nWelcome to Open Transactions -- version %s\n&quot;</span>,
<a name="l00242"></a>00242             <a class="code" href="class_o_t_log.html#a3d4addadb76f6dec42a806cbc634ee0f">OTLog::Version</a>());
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;(transport build: OTMessage -&gt; OTEnvelope -&gt; ZMQ )\n&quot;</span>);
<a name="l00245"></a>00245         <span class="comment">// ------------------------------------</span>
<a name="l00246"></a>00246 <span class="preprocessor">#ifdef OT_ZMQ_2_MODE</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span><span class="preprocessor">#ifdef _WIN32</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>        WSADATA wsaData;
<a name="l00249"></a>00249         WORD wVersionRequested = MAKEWORD( 2, 2 );
<a name="l00250"></a>00250         int32_t err = WSAStartup( wVersionRequested, &amp;wsaData );
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">/* Tell the user that we could not find a usable        */</span>
<a name="l00253"></a>00253         <span class="comment">/* Winsock DLL.                                         */</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((err == 0), <span class="stringliteral">&quot;WSAStartup failed!\n&quot;</span>);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="comment">/*  Confirm that the WinSock DLL supports 2.2.          */</span>
<a name="l00259"></a>00259         <span class="comment">/*  Note that if the DLL supports versions greater      */</span>
<a name="l00260"></a>00260         <span class="comment">/*  than 2.2 in addition to 2.2, it will still return   */</span>
<a name="l00261"></a>00261         <span class="comment">/*  2.2 in wVersion since that is the version we        */</span>
<a name="l00262"></a>00262         <span class="comment">/*  requested.                                          */</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="keywordtype">bool</span> bWinsock = (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="comment">/* Tell the user that we could not find a usable */</span>
<a name="l00267"></a>00267         <span class="comment">/* WinSock DLL.                                  */</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (!bWinsock) WSACleanup();  <span class="comment">// do cleanup.</span>
<a name="l00270"></a>00270         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((!bWinsock), <span class="stringliteral">&quot;Could not find a usable version of Winsock.dll\n&quot;</span>);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="comment">/* The Winsock DLL is acceptable. Proceed to use it. */</span>
<a name="l00273"></a>00273         <span class="comment">/* Add network programming using Winsock here */</span>
<a name="l00274"></a>00274         <span class="comment">/* then call WSACleanup when done using the Winsock dll */</span>
<a name="l00275"></a>00275         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,<span class="stringliteral">&quot;The Winsock 2.2 dll was found okay\n&quot;</span>);
<a name="l00276"></a>00276 <span class="preprocessor">#endif</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>        <span class="comment">// ------------------------------------</span>
<a name="l00279"></a>00279         <span class="comment">// SIGNALS</span>
<a name="l00280"></a>00280         <span class="comment">//</span>
<a name="l00281"></a>00281 <span class="preprocessor">#if defined(OT_SIGNAL_HANDLING)</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>        <span class="comment">//</span>
<a name="l00283"></a>00283         <a class="code" href="class_o_t_log.html#a3fb27300b83fb9ed8c7c96283ff55fa0">OTLog::SetupSignalHandler</a>();  <span class="comment">// &lt;===== SIGNALS</span>
<a name="l00284"></a>00284         <span class="comment">//</span>
<a name="l00285"></a>00285         <span class="comment">// This is optional! You can always remove it using the OT_NO_SIGNAL_HANDLING</span>
<a name="l00286"></a>00286         <span class="comment">//  option, and plus, the internals only execute once anyway. (It keeps count.)</span>
<a name="l00287"></a>00287 <span class="preprocessor">#endif</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>        <span class="comment">// ------------------------------------</span>
<a name="l00289"></a>00289         <a class="code" href="class_o_t_crypto.html#af10d51149df4803f79b4b2fed829430b">OTCrypto::It</a>()-&gt;<a class="code" href="class_o_t_crypto.html#ae83b19ae07a5a0ba00780cf031014fcc">Init</a>(); <span class="comment">// (OpenSSL gets initialized here.)</span>
<a name="l00290"></a>00290         <span class="comment">// ------------------------------------</span>
<a name="l00291"></a>00291         <span class="comment">// TODO in the case of Windows, figure err into this return val somehow.</span>
<a name="l00292"></a>00292         <span class="comment">// (Or log it or something.)</span>
<a name="l00293"></a>00293         <span class="comment">//</span>
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         OT_API::bInitOTApp = <span class="keyword">true</span>;
<a name="l00296"></a>00296         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">else</span>
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: This function can only be called once.\n&quot;</span>, __FUNCTION__);
<a name="l00301"></a>00301         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="comment">// ------------------------------------</span>
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">//static</span>
<a name="l00309"></a><a class="code" href="class_o_t___a_p_i.html#a7c1ce59287a7919d518149d9252e9d34">00309</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a7c1ce59287a7919d518149d9252e9d34">OT_API::CleanupOTApp</a>()
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (!OT_API::bInitOTApp)
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: WARNING: Never Successfully called:  %s\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;OT_API::InitCTX()&quot;</span>);
<a name="l00314"></a>00314         OT_API::bInitOTApp = <span class="keyword">true</span>;
<a name="l00315"></a>00315         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (!OT_API::bCleanupOTApp)
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320         <span class="comment">// ------------------------------------</span>
<a name="l00321"></a>00321         <a class="code" href="class_o_t_cached_key.html#a60f1041be525c88bde575ac183e64435">OTCachedKey::Cleanup</a>(); <span class="comment">// it has a static list of dynamically allocated master keys that need to be cleaned up, if the application is shutting down.</span>
<a name="l00322"></a>00322         <span class="comment">// ------------------------------------</span>
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         <span class="comment">// We clean these up in reverse order from the Init function, which just seems</span>
<a name="l00325"></a>00325         <span class="comment">// like the best default, in absence of any brighter ideas.</span>
<a name="l00326"></a>00326         <span class="comment">//</span>
<a name="l00327"></a>00327         <a class="code" href="class_o_t_crypto.html#af10d51149df4803f79b4b2fed829430b">OTCrypto::It</a>()-&gt;<a class="code" href="class_o_t_crypto.html#a0b59b9598063be8d46a733bbd3449514">Cleanup</a>();  <span class="comment">// (OpenSSL gets cleaned up here.)</span>
<a name="l00328"></a>00328         <span class="comment">// ------------------------------------</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">else</span>
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: This function can only be called once.\n&quot;</span>, __FUNCTION__);
<a name="l00335"></a>00335         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">// The API begins here...</span>
<a name="l00342"></a><a class="code" href="class_o_t___a_p_i.html#adc2385facb91965076934474d827dd6d">00342</a> <a class="code" href="class_o_t___a_p_i.html#adc2385facb91965076934474d827dd6d">OT_API::OT_API</a>() :
<a name="l00343"></a>00343     m_pPid(new Pid()),
<a name="l00344"></a>00344     m_pTransportCallback(NULL),
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 #ifdef OT_ZMQ_2_MODE
<a name="l00347"></a>00347     m_pSocket(new OTSocket_ZMQ_2()),
<a name="l00348"></a>00348 #endif
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 #ifdef <a class="code" href="_o_t_socket_8hpp.html#a8d52076351a67a04479d123c391748a4">OT_ZMQ_4_MODE</a>
<a name="l00351"></a>00351     m_pSocket(new <a class="code" href="class_o_t_socket___z_m_q__4.html">OTSocket_ZMQ_4</a>()),
<a name="l00352"></a>00352 #endif
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     m_pWallet(NULL),
<a name="l00355"></a>00355     m_pClient(NULL),
<a name="l00356"></a>00356     m_bInitialized(false)
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     m_strDataPath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00360"></a>00360     m_strWalletFilename = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00361"></a>00361     m_strWalletFilePath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00362"></a>00362     m_strConfigFilename = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00363"></a>00363     m_strConfigFilePath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (!this-&gt;Init())
<a name="l00366"></a>00366     {
<a name="l00367"></a>00367         this-&gt;Cleanup();
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="class_o_t___a_p_i.html#a652314745fe8d849224ccd851c5eb94e">00373</a> <a class="code" href="class_o_t___a_p_i.html#a652314745fe8d849224ccd851c5eb94e">OT_API::~OT_API</a>()
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <span class="comment">// DELETE AND SET NULL</span>
<a name="l00376"></a>00376     <span class="comment">//</span>
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (NULL != m_pSocket) <span class="keyword">delete</span> m_pSocket; m_pSocket = NULL;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (NULL != m_pTransportCallback) <span class="keyword">delete</span> m_pTransportCallback; m_pTransportCallback = NULL;
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>) <span class="keyword">delete</span> <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>; <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a> = NULL;
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (NULL != <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>) <span class="keyword">delete</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>; <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> = NULL;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (m_bInitialized)
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (!(this-&gt;Cleanup())) <span class="comment">// we only cleanup if we need to</span>
<a name="l00385"></a>00385     {
<a name="l00386"></a>00386         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="comment">// this must be last!</span>
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (NULL != m_pPid) <span class="keyword">delete</span> m_pPid;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 OT_API::Pid::Pid()
<a name="l00395"></a>00395     : m_bIsPidOpen(false)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397     m_strPidFilePath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 OT_API::Pid::~Pid()
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <span class="comment">// nothing for now</span>
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="keywordtype">void</span> OT_API::Pid::OpenPid(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPidFilePath)
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407     <span class="keywordflow">if</span> (this-&gt;IsPidOpen()) { <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: Pid is OPEN, MUST CLOSE BEFORE OPENING A NEW ONE!\n&quot;</span>,__FUNCTION__,<span class="stringliteral">&quot;strPidFilePath&quot;</span>); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (!strPidFilePath.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) { <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: %s is Empty!\n&quot;</span>,__FUNCTION__,<span class="stringliteral">&quot;strPidFilePath&quot;</span>); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (3 &gt; strPidFilePath.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()) { <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: %s is Too Short! (%s)\n&quot;</span>,__FUNCTION__,<span class="stringliteral">&quot;strPidFilePath&quot;</span>,strPidFilePath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Using Pid File: %s\n&quot;</span>,__FUNCTION__,strPidFilePath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00413"></a>00413     this-&gt;m_strPidFilePath = strPidFilePath;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     {
<a name="l00416"></a>00416         <span class="comment">// 1. READ A FILE STORING THE PID. (It will already exist, if OT is already running.)</span>
<a name="l00417"></a>00417         <span class="comment">//</span>
<a name="l00418"></a>00418         <span class="comment">// We open it for reading first, to see if it already exists. If it does,</span>
<a name="l00419"></a>00419         <span class="comment">// we read the number. 0 is fine, since we overwrite with 0 on shutdown. But</span>
<a name="l00420"></a>00420         <span class="comment">// any OTHER number means OT is still running. Or it means it was killed while</span>
<a name="l00421"></a>00421         <span class="comment">// running and didn&#39;t shut down properly, and that you need to delete the pid file</span>
<a name="l00422"></a>00422         <span class="comment">// by hand before running OT again. (This is all for the purpose of preventing two</span>
<a name="l00423"></a>00423         <span class="comment">// copies of OT running at the same time and corrupting the data folder.)</span>
<a name="l00424"></a>00424         <span class="comment">//</span>
<a name="l00425"></a>00425         std::ifstream pid_infile(this-&gt;m_strPidFilePath.Get());
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         <span class="comment">// 2. (IF FILE EXISTS WITH ANY PID INSIDE, THEN DIE.)</span>
<a name="l00428"></a>00428         <span class="comment">//</span>
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (pid_infile.is_open()) <span class="comment">// it existed already</span>
<a name="l00431"></a>00431         {
<a name="l00432"></a>00432             uint32_t old_pid = 0;
<a name="l00433"></a>00433             pid_infile &gt;&gt; old_pid;
<a name="l00434"></a>00434             pid_infile.close();
<a name="l00435"></a>00435 
<a name="l00436"></a>00436             <span class="comment">// There was a real PID in there.</span>
<a name="l00437"></a>00437             <span class="keywordflow">if</span> (old_pid != 0)
<a name="l00438"></a>00438             {
<a name="l00439"></a>00439                 <span class="keyword">const</span> uint64_t lPID = old_pid;
<a name="l00440"></a>00440                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;\n\n\nIS OPEN-TRANSACTIONS ALREADY RUNNING?\n\n&quot;</span>
<a name="l00441"></a>00441                     <span class="stringliteral">&quot;I found a PID (%llu) in the data lock file, located at: %s\n\n&quot;</span>
<a name="l00442"></a>00442                     <span class="stringliteral">&quot;If the OT process with PID %llu is truly not running anymore, &quot;</span>
<a name="l00443"></a>00443                     <span class="stringliteral">&quot;then just erase that file and restart.\nThis is normally cleaned &quot;</span>
<a name="l00444"></a>00444                               <span class="stringliteral">&quot;up during AppCleanup / AppShutdown. (Or should be.)\n&quot;</span>,
<a name="l00445"></a>00445                               lPID, this-&gt;m_strPidFilePath.Get(), lPID);
<a name="l00446"></a>00446 <span class="preprocessor">#ifndef ANDROID</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>                this-&gt;m_bIsPidOpen = <span class="keyword">false</span>;
<a name="l00448"></a>00448                 <span class="keywordflow">return</span>;
<a name="l00449"></a>00449 <span class="preprocessor">#endif</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>            }
<a name="l00451"></a>00451             <span class="comment">// Otherwise, though the file existed, the PID within was 0.</span>
<a name="l00452"></a>00452             <span class="comment">// (Meaning the previous instance of OT already set it to 0 as it was shutting down.)</span>
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454         <span class="comment">// Next let&#39;s record our PID to the same file, so other copies of OT can&#39;t trample on US.</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         <span class="comment">// 3. GET THE CURRENT (ACTUAL) PROCESS ID.</span>
<a name="l00457"></a>00457         <span class="comment">//</span>
<a name="l00458"></a>00458         uint64_t the_pid = 0;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>        the_pid = GetCurrentProcessId();
<a name="l00462"></a>00462 <span class="preprocessor">#else</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span>        the_pid = getpid();
<a name="l00464"></a>00464 <span class="preprocessor">#endif</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span>
<a name="l00466"></a>00466         <span class="comment">// 4. OPEN THE FILE IN WRITE MODE, AND SAVE THE PID TO IT.</span>
<a name="l00467"></a>00467         <span class="comment">//</span>
<a name="l00468"></a>00468         std::ofstream pid_outfile(this-&gt;m_strPidFilePath.Get());
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (pid_outfile.is_open())
<a name="l00471"></a>00471         {
<a name="l00472"></a>00472             pid_outfile &lt;&lt; the_pid;
<a name="l00473"></a>00473             pid_outfile.close();
<a name="l00474"></a>00474             this-&gt;m_bIsPidOpen = <span class="keyword">true</span>;
<a name="l00475"></a>00475         }
<a name="l00476"></a>00476         <span class="keywordflow">else</span>
<a name="l00477"></a>00477         {
<a name="l00478"></a>00478             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed trying to open data locking file (to store PID %llu): %s\n&quot;</span>, the_pid, this-&gt;m_strPidFilePath.Get());
<a name="l00479"></a>00479             this-&gt;m_bIsPidOpen = <span class="keyword">false</span>;
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="keywordtype">void</span> OT_API::Pid::ClosePid()
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (!this-&gt;IsPidOpen()) { <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: Pid is CLOSED, WHY CLOSE A PID IF NONE IS OPEN!\n&quot;</span>,__FUNCTION__,<span class="stringliteral">&quot;strPidFilePath&quot;</span>); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (!this-&gt;m_strPidFilePath.Exists()) { <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: %s is Empty!\n&quot;</span>,__FUNCTION__,<span class="stringliteral">&quot;m_strPidFilePath&quot;</span>); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="comment">// -------------------------------------------------------</span>
<a name="l00490"></a>00490     <span class="comment">// PID -- Set it to 0 in the lock file so the next time we run OT, it knows there isn&#39;t</span>
<a name="l00491"></a>00491     <span class="comment">// another copy already running (otherwise we might wind up with two copies trying to write</span>
<a name="l00492"></a>00492     <span class="comment">// to the same data folder simultaneously, which could corrupt the data...)</span>
<a name="l00493"></a>00493     <span class="comment">//</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     uint32_t the_pid = 0;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     std::ofstream pid_outfile(this-&gt;m_strPidFilePath.Get());
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (pid_outfile.is_open())
<a name="l00500"></a>00500     {
<a name="l00501"></a>00501         pid_outfile &lt;&lt; the_pid;
<a name="l00502"></a>00502         pid_outfile.close();
<a name="l00503"></a>00503         m_bIsPidOpen = <span class="keyword">false</span>;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505     <span class="keywordflow">else</span> {
<a name="l00506"></a>00506         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed trying to open data locking file (to wipe PID back to 0): %s\n&quot;</span>,this-&gt;m_strPidFilePath.Get());
<a name="l00507"></a>00507         this-&gt;m_bIsPidOpen = <span class="keyword">true</span>;
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="keywordtype">bool</span> OT_API::Pid::IsPidOpen()<span class="keyword"> const</span>
<a name="l00512"></a>00512 <span class="keyword"></span>{
<a name="l00513"></a>00513     <span class="keywordflow">return</span> this-&gt;m_bIsPidOpen;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="comment">// Call this once per INSTANCE of OT_API.</span>
<a name="l00517"></a>00517 <span class="comment">//</span>
<a name="l00518"></a>00518 <span class="comment">// Theoretically, someday OTAPI can be the &quot;OT_CTX&quot; and we will be able to instantiate</span>
<a name="l00519"></a>00519 <span class="comment">// multiple instances of it within a single application.</span>
<a name="l00520"></a>00520 <span class="comment">//</span>
<a name="l00521"></a>00521 <span class="comment">// So you use OT_API::InitOTAPI to initialize the entire application, and then you use</span>
<a name="l00522"></a>00522 <span class="comment">// OT_API::Init() to initialize THIS &quot;OT_CTX&quot; (the OT_API object.)</span>
<a name="l00523"></a>00523 <span class="comment">//</span>
<a name="l00524"></a>00524 <span class="comment">// If not initialized yet, but then this function is successful, it will return true.</span>
<a name="l00525"></a>00525 <span class="comment">// If ALREADY initialized, this function still returns true.</span>
<a name="l00526"></a>00526 <span class="comment">// If initialization fails, it will return false, but you can just call it again.</span>
<a name="l00527"></a>00527 <span class="comment">//</span>
<a name="l00528"></a>00528 <span class="keywordtype">bool</span> OT_API::Init()
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::Init&quot;</span>;
<a name="l00531"></a>00531     <span class="comment">// --------------------------------------</span>
<a name="l00532"></a>00532     <span class="keywordflow">if</span> (<span class="keyword">true</span> == this-&gt;m_bInitialized)
<a name="l00533"></a>00533     {
<a name="l00534"></a>00534         <a class="code" href="class_o_t_string.html">OTString</a> strDataPath;
<a name="l00535"></a>00535         <span class="keywordtype">bool</span> bGetDataFolderSuccess = <a class="code" href="class_o_t_data_folder.html#a3cc847ac0fc0e30eb0f37dc8ecc9cec3">OTDataFolder::Get</a>(strDataPath);
<a name="l00536"></a>00536         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bGetDataFolderSuccess,<span class="stringliteral">&quot;OT_API::Init(): Error! Data path not set!&quot;</span>);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: OTAPI was already initialized. (Skipping) and using path: %s\n&quot;</span>,
<a name="l00539"></a>00539                       szFunc, strDataPath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00540"></a>00540         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#ab8b6cd17737f8b362c64a39d86faf604">OTDataFolder::Init</a>(<a class="code" href="_open_transactions_8cpp.html#a4675407b5b05d15570f0483f144789fd">CLIENT_CONFIG_KEY</a>)) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to Init data folders&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">// --------------------------------------</span>
<a name="l00546"></a>00546     <span class="keyword">static</span> <span class="keywordtype">bool</span> bConstruct = <span class="keyword">false</span>;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bConstruct)
<a name="l00549"></a>00549     {
<a name="l00550"></a>00550         bConstruct = <span class="keyword">true</span>;
<a name="l00551"></a>00551         <span class="comment">// ----------------------------</span>
<a name="l00552"></a>00552         <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a> = <span class="keyword">new</span> <a class="code" href="class_o_t_wallet.html">OTWallet</a>;
<a name="l00553"></a>00553         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> = <span class="keyword">new</span> <a class="code" href="class_o_t_client.html">OTClient</a>;
<a name="l00554"></a>00554         <span class="comment">// ----------------------------</span>
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="comment">// --------------------------------------</span>
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_o_t___a_p_i.html#a8de0d3d75ac1cbef23abdb746e9e2c61">LoadConfigFile</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to Load Config File!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="comment">// --------------------------------------</span>
<a name="l00561"></a>00561     <span class="comment">// PID -- Make sure we&#39;re not running two copies of OT on the same data simultaneously here.</span>
<a name="l00562"></a>00562     <span class="comment">//</span>
<a name="l00563"></a>00563     <span class="comment">// we need to get the loacation of where the pid file should be.</span>
<a name="l00564"></a>00564     <span class="comment">// then we pass it to the OpenPid function.</span>
<a name="l00565"></a>00565     <a class="code" href="class_o_t_string.html">OTString</a> strDataPath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00566"></a>00566     <span class="keyword">const</span> <span class="keywordtype">bool</span> bGetDataFolderSuccess = <a class="code" href="class_o_t_data_folder.html#a3cc847ac0fc0e30eb0f37dc8ecc9cec3">OTDataFolder::Get</a>(strDataPath);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     {
<a name="l00569"></a>00569         <span class="keywordtype">bool</span> bExists = <span class="keyword">false</span>, bIsNew = <span class="keyword">false</span>;
<a name="l00570"></a>00570         <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_paths.html#a7178a5f18d9816e0d5aef470e2841354">OTPaths::ConfirmCreateFolder</a>(strDataPath,bExists,bIsNew)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <a class="code" href="class_o_t_string.html">OTString</a> strPIDPath = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00574"></a>00574     <a class="code" href="class_o_t_paths.html#a149093f1bcedb1b792a8262f41b05f35">OTPaths::AppendFile</a>(strPIDPath,strDataPath,<a class="code" href="_open_transactions_8cpp.html#ab958b72fdeccb19281ea04c460db92cb">CLIENT_PID_FILENAME</a>);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (bGetDataFolderSuccess) this-&gt;m_pPid-&gt;OpenPid(strPIDPath);
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (!this-&gt;m_pPid-&gt;IsPidOpen()) { this-&gt;m_bInitialized = <span class="keyword">false</span>; <span class="keywordflow">return</span> <span class="keyword">false</span>; }  <span class="comment">// failed loading</span>
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">// --------------------------------------</span>
<a name="l00581"></a>00581     <span class="comment">// This way, everywhere else I can use the default storage context (for now) and it will work</span>
<a name="l00582"></a>00582     <span class="comment">// everywhere I put it. (Because it&#39;s now set up...)</span>
<a name="l00583"></a>00583     <span class="comment">//</span>
<a name="l00584"></a>00584     this-&gt;m_bDefaultStore = <a class="code" href="namespace_o_t_d_b.html#a346935608a31e0f724d839833e90e2f1">OTDB::InitDefaultStorage</a>(<a class="code" href="_o_t_storage_8hpp.html#aa14839d27201385945fff99b52448a29">OTDB_DEFAULT_STORAGE</a>, <a class="code" href="_o_t_storage_8hpp.html#aae47b801ed98c155ad4705c110987b25">OTDB_DEFAULT_PACKER</a>); <span class="comment">// We only need to do this once now.</span>
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <span class="keywordflow">if</span> (this-&gt;m_bDefaultStore) <span class="comment">// success initializing default storage on OTDB.</span>
<a name="l00587"></a>00587     {
<a name="l00588"></a>00588         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Success invoking OTDB::InitDefaultStorage&quot;</span>, szFunc);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="keywordflow">if</span> (this-&gt;m_bInitialized)
<a name="l00591"></a>00591             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: m_pClient-&gt;InitClient() was already initialized. (Skipping.)\n&quot;</span>, szFunc);
<a name="l00592"></a>00592         <span class="keywordflow">else</span>
<a name="l00593"></a>00593         {
<a name="l00594"></a>00594             this-&gt;m_bInitialized = this-&gt;<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#af93ba422f820281eb6022798563d588d" title="Need to call this before using.">InitClient</a>(*this-&gt;<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>);
<a name="l00595"></a>00595             <span class="comment">// -----------------------------</span>
<a name="l00596"></a>00596             <span class="keywordflow">if</span> (this-&gt;m_bInitialized) <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Success invoking m_pClient-&gt;InitClient() \n&quot;</span>, szFunc);
<a name="l00597"></a>00597             <span class="keywordflow">else</span> <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed invoking m_pClient-&gt;InitClient()\n&quot;</span>, szFunc);
<a name="l00598"></a>00598         }
<a name="l00599"></a>00599         <span class="keywordflow">return</span> this-&gt;m_bInitialized;
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601     <span class="keywordflow">else</span>
<a name="l00602"></a>00602         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed invoking OTDB::InitDefaultStorage\n&quot;</span>, szFunc);
<a name="l00603"></a>00603     <span class="comment">// -------------------------------------</span>
<a name="l00604"></a>00604     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="keywordtype">bool</span> OT_API::Cleanup()
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (!this-&gt;m_pPid-&gt;IsPidOpen()) { <span class="keywordflow">return</span> <span class="keyword">false</span>; } <span class="comment">// pid isn&#39;t open, just return false.</span>
<a name="l00612"></a>00612 
<a name="l00613"></a>00613     this-&gt;m_pPid-&gt;ClosePid();
<a name="l00614"></a>00614     <span class="keywordflow">if</span> (this-&gt;m_pPid-&gt;IsPidOpen()) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }  <span class="comment">// failed loading</span>
<a name="l00615"></a>00615     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <span class="comment">// Get</span>
<a name="l00622"></a><a class="code" href="class_o_t___a_p_i.html#a6e79ce6216fb40ef9c2f48615e72072a">00622</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a6e79ce6216fb40ef9c2f48615e72072a">OT_API::GetWalletFilename</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strPath) { <span class="keywordflow">if</span> (m_strWalletFilename.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) { strPath = m_strWalletFilename; <span class="keywordflow">return</span> <span class="keyword">true</span>; } <span class="keywordflow">else</span> { strPath.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(<span class="stringliteral">&quot;&quot;</span>); <span class="keywordflow">return</span> <span class="keyword">false</span>; } }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">// Set</span>
<a name="l00625"></a><a class="code" href="class_o_t___a_p_i.html#a5eaacf363f5fb27e71c196cbb099cced">00625</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a5eaacf363f5fb27e71c196cbb099cced">OT_API::SetWalletFilename</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strPath) { <span class="keywordflow">if</span> (strPath.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) { m_strWalletFilename = strPath; <span class="keywordflow">return</span> <span class="keyword">true</span>; } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00626"></a>00626 
<a name="l00627"></a><a class="code" href="class_o_t___a_p_i.html#aae7802dad48d8347a4b3d6b91e7aac0c">00627</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aae7802dad48d8347a4b3d6b91e7aac0c">OT_API::SetTransportCallback</a>(<a class="code" href="struct_transport_callback.html">TransportCallback</a> * pTransportCallback)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     <span class="keywordflow">if</span> (NULL != pTransportCallback) { this-&gt;m_pTransportCallback = pTransportCallback; <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00630"></a>00630     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a><a class="code" href="class_o_t___a_p_i.html#a86e129f94dfef872f8809ae9bb1bbb75">00633</a> <a class="code" href="struct_transport_callback.html">TransportCallback</a> * <a class="code" href="class_o_t___a_p_i.html#a86e129f94dfef872f8809ae9bb1bbb75">OT_API::GetTransportCallback</a>()
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (NULL != this-&gt;m_pTransportCallback) { <span class="keywordflow">return</span> this-&gt;m_pTransportCallback; }
<a name="l00636"></a>00636     <span class="keywordflow">else</span> { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="comment">// Load the configuration file.</span>
<a name="l00640"></a>00640 <span class="comment">//</span>
<a name="l00641"></a><a class="code" href="class_o_t___a_p_i.html#a8de0d3d75ac1cbef23abdb746e9e2c61">00641</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a8de0d3d75ac1cbef23abdb746e9e2c61">OT_API::LoadConfigFile</a>()
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::LoadConfigFile()&quot;</span>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="comment">// Setup Config File</span>
<a name="l00646"></a>00646     <a class="code" href="class_o_t_string.html">OTString</a> strConfigPath, strConfigFilename;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     <span class="keywordflow">if</span>(!<a class="code" href="class_o_t_data_folder.html#a624a126d059f0db031d894de786b4011">OTDataFolder::IsInitialized</a>()) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="comment">// Create Config Object (OTSettings)</span>
<a name="l00652"></a>00652     <a class="code" href="class_o_t_string.html">OTString</a> strConfigFilePath=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00653"></a>00653     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a03f3da5b6d8d7f3df43757c66cbb8693">OTDataFolder::GetConfigFilePath</a>(strConfigFilePath)) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00654"></a>00654     <a class="code" href="class_o_t_settings.html">OTSettings</a> * p_Config = NULL;
<a name="l00655"></a>00655     p_Config = <span class="keyword">new</span> <a class="code" href="class_o_t_settings.html">OTSettings</a>(strConfigFilePath);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="comment">// First Load, Create new fresh config file if failed loading.</span>
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (!p_Config -&gt; Load())
<a name="l00659"></a>00659     {
<a name="l00660"></a>00660         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;%s: Note: Unable to Load Config. Creating a new file: %s\n&quot;</span>, szFunc, strConfigFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00662"></a>00662         <span class="keywordflow">if</span> (!p_Config -&gt; Save() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="comment">// Second Load, Throw Assert if Failed loading.</span>
<a name="l00669"></a>00669     <span class="keywordflow">if</span> (!p_Config -&gt; Load())
<a name="l00670"></a>00670     {
<a name="l00671"></a>00671         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(0,<span class="stringliteral">&quot;%s: Error: Unable to load config file: %s It should exist, as we just saved it!\n&quot;</span>, szFunc, strConfigFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00672"></a>00672         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l00673"></a>00673     }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="comment">// ---------------------------------------------</span>
<a name="l00677"></a>00677     <span class="comment">// LOG LEVEL</span>
<a name="l00678"></a>00678     {
<a name="l00679"></a>00679         <span class="keywordtype">bool</span> bIsNewKey;
<a name="l00680"></a>00680         int64_t lValue;
<a name="l00681"></a>00681         p_Config -&gt; CheckSet_long(<span class="stringliteral">&quot;logging&quot;</span>,<span class="stringliteral">&quot;log_level&quot;</span>,0,lValue,bIsNewKey);
<a name="l00682"></a>00682         <a class="code" href="class_o_t_log.html#a42b7411eaf5734cc10825d53939f4a0d">OTLog::SetLogLevel</a>(static_cast&lt;int32_t&gt; (lValue));
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="comment">// ---------------------------------------------</span>
<a name="l00686"></a>00686     <span class="comment">// WALLET</span>
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     <span class="comment">// WALLET FILENAME</span>
<a name="l00689"></a>00689     <span class="comment">//</span>
<a name="l00690"></a>00690     <span class="comment">// Clean and Set</span>
<a name="l00691"></a>00691     {
<a name="l00692"></a>00692         <span class="keywordtype">bool</span> bIsNewKey;
<a name="l00693"></a>00693         <a class="code" href="class_o_t_string.html">OTString</a> strValue;
<a name="l00694"></a>00694         p_Config -&gt; CheckSet_str(<span class="stringliteral">&quot;wallet&quot;</span>,<span class="stringliteral">&quot;wallet_filename&quot;</span>,<a class="code" href="_open_transactions_8cpp.html#a0b134c6acd01ee1f9ed1fd48cd7c9511">CLIENT_WALLET_FILENAME</a>,strValue,bIsNewKey);
<a name="l00695"></a>00695         <a class="code" href="class_o_t___a_p_i.html#a5eaacf363f5fb27e71c196cbb099cced">OT_API::SetWalletFilename</a>(strValue);
<a name="l00696"></a>00696         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1,<span class="stringliteral">&quot;Using Wallet: %s\n&quot;</span>,strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="comment">// -----------------------------------</span>
<a name="l00700"></a>00700     <span class="comment">// LATENCY</span>
<a name="l00701"></a>00701     {
<a name="l00702"></a>00702         <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
<a name="l00703"></a>00703             <span class="stringliteral">&quot;;; LATENCY:\n\n&quot;</span>
<a name="l00704"></a>00704             <span class="stringliteral">&quot;;; For sending and receiving:\n&quot;</span>
<a name="l00705"></a>00705             <span class="stringliteral">&quot;;; blocking=true (usually not recommended) means OT will hang on the send/receive\n&quot;</span>
<a name="l00706"></a>00706             <span class="stringliteral">&quot;;; call, and wait indefinitely until the send or receive has actually occurred.\n&quot;</span>
<a name="l00707"></a>00707             <span class="stringliteral">&quot;;; IF BLOCKING IS FALSE (normal, default):\n&quot;</span>
<a name="l00708"></a>00708             <span class="stringliteral">&quot;;; - no_tries is the number of times OT will try to send or receive a message.\n&quot;</span>
<a name="l00709"></a>00709             <span class="stringliteral">&quot;;; - ms is the number of milliseconds it will wait between each attempt.\n&quot;</span>
<a name="l00710"></a>00710             <span class="stringliteral">&quot;;; UPDATE: send_ms and receive_ms now DOUBLE after each failed attempt! (up to 3 tries)\n&quot;</span>
<a name="l00711"></a>00711             <span class="stringliteral">&quot;;; Meaning that after 3 tries, it&#39;s already waited over 21 seconds trying to get\n&quot;</span>
<a name="l00712"></a>00712             <span class="stringliteral">&quot;;; the message. \n&quot;</span>
<a name="l00713"></a>00713             <span class="stringliteral">&quot;;; send_delay_after happens after EVERY SINGLE server request/reply, which can be\n&quot;</span>
<a name="l00714"></a>00714             <span class="stringliteral">&quot;;; multiple times per use case. (They can add up quick...)\n&quot;</span>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716         <span class="keywordtype">bool</span> b_SectionExist;
<a name="l00717"></a>00717         p_Config-&gt;<a class="code" href="class_o_t_settings.html#a2d5bbcf1220477060e6d6d8e1db70859">CheckSetSection</a>(<span class="stringliteral">&quot;latency&quot;</span>, szComment, b_SectionExist);
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722         <span class="keywordflow">if</span> (NULL == m_pSocket) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="keyword">const</span> <a class="code" href="class_o_t_socket_1_1_defaults.html">OTSocket::Defaults</a> socketDefaults(
<a name="l00725"></a>00725             <a class="code" href="_open_transactions_8cpp.html#a290ff9c13a30b35f59668b82ca68d4e3">CLIENT_DEFAULT_LATENCY_SEND_MS</a>,
<a name="l00726"></a>00726             <a class="code" href="_open_transactions_8cpp.html#a0a9667963ecd92a68b3b014f07083f0c">CLIENT_DEFAULT_LATENCY_SEND_NO_TRIES</a>,
<a name="l00727"></a>00727             <a class="code" href="_open_transactions_8cpp.html#a260f7705019dbcde2805b187fc32c296">CLIENT_DEFAULT_LATENCY_RECEIVE_MS</a>,
<a name="l00728"></a>00728             <a class="code" href="_open_transactions_8cpp.html#ac9f275dd072f7e6a8f3513667150a952">CLIENT_DEFAULT_LATENCY_RECEIVE_NO_TRIES</a>,
<a name="l00729"></a>00729             <a class="code" href="_open_transactions_8cpp.html#a307024706ce20afb5f4626ea769e81d2">CLIENT_DEFAULT_LATENCY_DELAY_AFTER</a>,
<a name="l00730"></a>00730             <a class="code" href="_open_transactions_8cpp.html#a8d9c01e8d496678f796ee06962de888c">CLIENT_DEFAULT_IS_BLOCKING</a>
<a name="l00731"></a>00731             );
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#aac7b28cf63c959f95c3e47b8091b774f">Init</a>(socketDefaults, p_Config);  <span class="comment">// setup the socket.</span>
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">// ---------------------------------------------</span>
<a name="l00739"></a>00739     <span class="comment">// SECURITY (beginnings of..)</span>
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="comment">// Master Key Timeout</span>
<a name="l00742"></a>00742     {
<a name="l00743"></a>00743     <span class="keyword">const</span> <span class="keywordtype">char</span> * szComment =
<a name="l00744"></a>00744         <span class="stringliteral">&quot;; master_key_timeout is how int64_t the master key will be in memory until a thread wipes it out.\n&quot;</span>
<a name="l00745"></a>00745         <span class="stringliteral">&quot;; 0   : means you have to type your password EVERY time OT uses a private key. (Even multiple times in a single function.)\n&quot;</span>
<a name="l00746"></a>00746         <span class="stringliteral">&quot;; 300 : means you only have to type it once per 5 minutes.\n&quot;</span>
<a name="l00747"></a>00747         <span class="stringliteral">&quot;; -1  : means you only type it once PER RUN (popular for servers.)\n&quot;</span>;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <span class="keywordtype">bool</span> bIsNewKey;
<a name="l00750"></a>00750         int64_t lValue;
<a name="l00751"></a>00751     p_Config -&gt; CheckSet_long(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;master_key_timeout&quot;</span>,<a class="code" href="_open_transactions_8cpp.html#a6ca020e7a6f02c7a8d769e9fa32dcd01">CLIENT_MASTER_KEY_TIMEOUT_DEFAULT</a>,lValue,bIsNewKey,szComment);
<a name="l00752"></a>00752     <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SetTimeoutSeconds(static_cast&lt;int32_t&gt;(lValue));
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">// Use System Keyring</span>
<a name="l00756"></a>00756     {
<a name="l00757"></a>00757     <span class="keywordtype">bool</span> bValue, bIsNewKey;
<a name="l00758"></a>00758     p_Config -&gt; CheckSet_bool(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;use_system_keyring&quot;</span>,<a class="code" href="_open_transactions_8cpp.html#af566d6ce4bb1ffea9f5a698fc199bbc2">CLIENT_USE_SYSTEM_KEYRING</a>,bValue,bIsNewKey);
<a name="l00759"></a>00759     <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;UseSystemKeyring(bValue);
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <span class="comment">// Use System Keyring</span>
<a name="l00763"></a>00763     {
<a name="l00764"></a>00764     <span class="keywordtype">bool</span> bValue, bIsNewKey;
<a name="l00765"></a>00765     p_Config -&gt; CheckSet_bool(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;use_system_keyring&quot;</span>,<a class="code" href="_open_transactions_8cpp.html#af566d6ce4bb1ffea9f5a698fc199bbc2">CLIENT_USE_SYSTEM_KEYRING</a>,bValue,bIsNewKey);
<a name="l00766"></a>00766     <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;UseSystemKeyring(bValue);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 <span class="preprocessor">#if defined(OT_KEYRING_FLATFILE)</span>
<a name="l00769"></a>00769 <span class="preprocessor"></span>        <span class="comment">// Is there a password folder? (There shouldn&#39;t be, but we allow it...)</span>
<a name="l00770"></a>00770         <span class="comment">//</span>
<a name="l00771"></a>00771         <span class="keywordflow">if</span> (bValue)
<a name="l00772"></a>00772         {
<a name="l00773"></a>00773             <span class="keywordtype">bool</span> bIsNewKey2;
<a name="l00774"></a>00774             <a class="code" href="class_o_t_string.html">OTString</a> strValue;
<a name="l00775"></a>00775             p_Config -&gt; CheckSet_str(<span class="stringliteral">&quot;security&quot;</span>,<span class="stringliteral">&quot;password_folder&quot;</span>,<a class="code" href="_open_transactions_8cpp.html#afa01c4388d318bdf43542fcbf23b0659">CLIENT_PASSWORD_FOLDER</a>,strValue,bIsNewKey2);
<a name="l00776"></a>00776             <span class="keywordflow">if</span> (strValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00777"></a>00777             {
<a name="l00778"></a>00778                 OTKeyring::FlatFile_SetPasswordFolder(strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00779"></a>00779                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot; **DANGEROUS!**  Using password folder: %s\n&quot;</span>,strValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781         }
<a name="l00782"></a>00782 <span class="preprocessor">#endif</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>    }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     <span class="comment">// Done Loading... Lets save any changes...</span>
<a name="l00787"></a>00787     <span class="keywordflow">if</span> (!p_Config -&gt; Save())
<a name="l00788"></a>00788     {
<a name="l00789"></a>00789         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error! Unable to save updated Config!!!\n&quot;</span>,szFunc);
<a name="l00790"></a>00790         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="comment">// Finsihed Saving... now lets cleanup!</span>
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="keywordflow">if</span> (NULL != p_Config) <span class="keyword">delete</span> p_Config;
<a name="l00797"></a>00797     p_Config = NULL;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00800"></a>00800 }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 <span class="comment">// ------------------------------------</span>
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 
<a name="l00807"></a><a class="code" href="class_o_t___a_p_i.html#af6c984fa7aa142e79ed4ddbc14d14503">00807</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#af6c984fa7aa142e79ed4ddbc14d14503">OT_API::SetWallet</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strFilename) {
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keywordflow">if</span> (!m_bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     {
<a name="l00812"></a>00812         <span class="keywordtype">bool</span> bExists = strFilename.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>();
<a name="l00813"></a>00813         <span class="keywordflow">if</span> (bExists) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: strFilename dose not exist!\n&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(strFilename.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>(),<span class="stringliteral">&quot;OT_API::SetWalletFilename: strFilename does not exist.\n&quot;</span>);
<a name="l00817"></a>00817     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((3 &lt; strFilename.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()),<span class="stringliteral">&quot;OT_API::SetWalletFilename: strFilename is too short.\n&quot;</span>);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment">// Set New Wallet Filename</span>
<a name="l00820"></a>00820     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;%s: Setting Wallet Filename... \n&quot;</span>, __FUNCTION__);
<a name="l00821"></a>00821     <a class="code" href="class_o_t_string.html">OTString</a> strWalletFilename; <a class="code" href="class_o_t___a_p_i.html#a6e79ce6216fb40ef9c2f48615e72072a">OT_API::GetWalletFilename</a>(strWalletFilename);
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (strFilename.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(strWalletFilename))
<a name="l00824"></a>00824     {
<a name="l00825"></a>00825         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Wallet Filename: %s  is same as in configuration. (skipping)\n&quot;</span>,__FUNCTION__,strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00826"></a>00826         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00827"></a>00827     }
<a name="l00828"></a>00828     <span class="keywordflow">else</span>
<a name="l00829"></a>00829         strWalletFilename.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(strWalletFilename);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831     <span class="comment">// Will save updated config filename.</span>
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="comment">// Create Config Object (OTSettings)</span>
<a name="l00834"></a>00834     <a class="code" href="class_o_t_string.html">OTString</a> strConfigFilePath;
<a name="l00835"></a>00835     <a class="code" href="class_o_t_data_folder.html#a03f3da5b6d8d7f3df43757c66cbb8693">OTDataFolder::GetConfigFilePath</a>(strConfigFilePath);
<a name="l00836"></a>00836     <a class="code" href="class_o_t_settings.html">OTSettings</a> * p_Config(<span class="keyword">new</span> <a class="code" href="class_o_t_settings.html">OTSettings</a>(strConfigFilePath));
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">// First Load, Create new fresh config file if failed loading.</span>
<a name="l00839"></a>00839     <span class="keywordflow">if</span> (!p_Config -&gt; Load())
<a name="l00840"></a>00840     {
<a name="l00841"></a>00841         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;%s: Note: Unable to Load Config. Creating a new file: %s\n&quot;</span>, __FUNCTION__, strConfigFilePath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00842"></a>00842         <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (!p_Config -&gt; Save() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="comment">// Second Load, Throw Assert if Failed loading.</span>
<a name="l00849"></a>00849     <span class="keywordflow">if</span> (!p_Config -&gt; Load())
<a name="l00850"></a>00850     {
<a name="l00851"></a>00851         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(0,<span class="stringliteral">&quot;%s: Error: Unable to load config file: %s It should exist, as we just saved it!\n&quot;</span>, __FUNCTION__, strConfigFilePath.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00852"></a>00852         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     <span class="comment">// ----------------------------------------------</span>
<a name="l00857"></a>00857     <span class="comment">// Set New Wallet Filename</span>
<a name="l00858"></a>00858     {
<a name="l00859"></a>00859         <span class="keywordtype">bool</span> bNewOrUpdated;
<a name="l00860"></a>00860         p_Config -&gt; Set_str(<span class="stringliteral">&quot;wallet&quot;</span>,<span class="stringliteral">&quot;wallet_filename&quot;</span>,strWalletFilename,bNewOrUpdated,<span class="stringliteral">&quot;; Wallet updated\n&quot;</span>);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         <a class="code" href="class_o_t___a_p_i.html#a5eaacf363f5fb27e71c196cbb099cced">OT_API::SetWalletFilename</a>(strWalletFilename);
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="comment">// Done Loading... Lets save any changes...</span>
<a name="l00867"></a>00867     <span class="keywordflow">if</span> (!p_Config -&gt; Save())
<a name="l00868"></a>00868     {
<a name="l00869"></a>00869         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error! Unable to save updated Config!!!\n&quot;</span>,__FUNCTION__);
<a name="l00870"></a>00870         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="comment">// Finsihed Saving... now lets cleanup!</span>
<a name="l00874"></a>00874     <span class="keywordflow">if</span> (!p_Config -&gt; Reset()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;%s: Updated Wallet filename: %s \n&quot;</span>,__FUNCTION__,strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00879"></a>00879 }
<a name="l00880"></a>00880 
<a name="l00881"></a><a class="code" href="class_o_t___a_p_i.html#a798f3a326f18f31b8e62a682bbaa6a6d">00881</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a798f3a326f18f31b8e62a682bbaa6a6d">OT_API::WalletExists</a>()
<a name="l00882"></a>00882 {
<a name="l00883"></a>00883     <span class="keywordflow">return</span> (NULL != <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a><a class="code" href="class_o_t___a_p_i.html#a3a0ae20d8736f8588d76441a18ac2c6e">00886</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a3a0ae20d8736f8588d76441a18ac2c6e">OT_API::LoadWallet</a>()
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::LoadWallet&quot;</span>;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.\n&quot;</span>);
<a name="l00891"></a>00891     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bDefaultStore, <span class="stringliteral">&quot;Default Storage not Initialized; call OT_API::Init first.\n&quot;</span>);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <a class="code" href="class_o_t_string.html">OTString</a> strWalletFilename;
<a name="l00894"></a>00894     <span class="keywordtype">bool</span> bGetWalletFilenameSuccess = <a class="code" href="class_o_t___a_p_i.html#a6e79ce6216fb40ef9c2f48615e72072a">OT_API::GetWalletFilename</a>(strWalletFilename);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bGetWalletFilenameSuccess, <span class="stringliteral">&quot;OT_API::GetWalletFilename failed, wallet filename isn&#39;t set!&quot;</span>);
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="comment">// Atempt Load</span>
<a name="l00899"></a>00899     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2,<span class="stringliteral">&quot;m_pWallet-&gt;LoadWallet() with: %s\n&quot;</span>, strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00900"></a>00900     <span class="keywordtype">bool</span> bSuccess = <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#a2932e7c8d6b5d7764707e653a3c2f216">LoadWallet</a>(strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <span class="keywordflow">if</span> (bSuccess) <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Success invoking m_pWallet-&gt;LoadWallet() with filename: %s\n&quot;</span>,
<a name="l00903"></a>00903                                szFunc, strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00904"></a>00904     <span class="keywordflow">else</span> <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed invoking m_pWallet-&gt;LoadWallet() with filename: %s\n&quot;</span>,
<a name="l00905"></a>00905                               szFunc, strWalletFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00906"></a>00906     <span class="keywordflow">return</span> bSuccess;
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="comment">// -------------------------------------------------------------------------</span>
<a name="l00913"></a>00913 <span class="comment">// When the server and client (this API being a client) are built in XmlRpc/HTTP</span>
<a name="l00914"></a>00914 <span class="comment">// mode, then a callback must be provided for passing the messages back and forth</span>
<a name="l00915"></a>00915 <span class="comment">// with the server. (Provided below.)</span>
<a name="l00916"></a>00916 <span class="comment">//</span>
<a name="l00917"></a>00917 <span class="comment">// IMPORTANT: If you ever wanted to use a different transport mechanism, it would</span>
<a name="l00918"></a>00918 <span class="comment">// be as easy as adding your own version of this callback function, but having it</span>
<a name="l00919"></a>00919 <span class="comment">// use your own transport mechanism instead of the xmlrpc in this example.</span>
<a name="l00920"></a>00920 <span class="comment">// Of course, the server would also have to support this transport layer...</span>
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 <span class="comment">// The Callback so OT can give us messages to send using our xmlrpc transport.</span>
<a name="l00924"></a>00924 <span class="comment">// Whenever OT needs to pop a message on over to the server, it calls this so we</span>
<a name="l00925"></a>00925 <span class="comment">// can do the work here.</span>
<a name="l00926"></a>00926 <span class="comment">//</span>
<a name="l00927"></a>00927 <span class="comment">//typedef bool (*OT_CALLBACK_MSG)(OTPayload &amp; thePayload);</span>
<a name="l00928"></a>00928 <span class="comment">//</span>
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 
<a name="l00931"></a><a class="code" href="class_o_t___a_p_i.html#a597eab7dd06eba0ae38de43717fb775f">00931</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a597eab7dd06eba0ae38de43717fb775f">OT_API::TransportFunction</a>(<a class="code" href="class_o_t_server_contract.html">OTServerContract</a> &amp; theServerContract, <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> &amp; theEnvelope)
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933     <span class="comment">// ----------------------------------------------</span>
<a name="l00934"></a>00934     <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>())                 { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is not Initialized!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;OT_API&quot;</span>);     <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (NULL == this-&gt;<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>)                { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is a NULL!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;m_pClient&quot;</span>);       <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (NULL == this-&gt;<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a28169697045727fc9e3bb2228a0fd21d">m_pConnection</a>) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is a NULL!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;m_pConnection&quot;</span>);   <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00937"></a>00937     <span class="comment">// ----------------------------------------------</span>
<a name="l00938"></a>00938     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym(<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> -&gt; m_pConnection -&gt; <a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>());
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (NULL == pNym)                           { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is a NULL!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;pNym&quot;</span>);                <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00940"></a>00940     <span class="keywordflow">if</span> (NULL == this-&gt;m_pSocket)                { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is a NULL!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;m_Socket&quot;</span>);            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00941"></a>00941     <span class="keywordflow">if</span> (NULL == this-&gt;m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#a1154b4c4830d860ec5c4047bfc15af34">GetMutex</a>())        { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is a NULL!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;m_Socket&quot;</span>);            <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00942"></a>00942     <span class="keywordflow">if</span> (!m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#a9a82b48711ebe8ce96b94717a3cf6005">IsInitialized</a>())            { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: %s is not Initialized!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;m_Socket&quot;</span>);   <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l00943"></a>00943     <span class="comment">// ----------------------------------------------</span>
<a name="l00944"></a>00944     tthread::lock_guard&lt;tthread::mutex&gt;  lock(*m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#a1154b4c4830d860ec5c4047bfc15af34">GetMutex</a>());
<a name="l00945"></a>00945     <span class="comment">// ----------------------------------------------</span>
<a name="l00946"></a>00946     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::TransportCallback&quot;</span>;
<a name="l00947"></a>00947     <span class="comment">// ----------------------------------------------</span>
<a name="l00948"></a>00948     int32_t         nServerPort = 0;
<a name="l00949"></a>00949     <a class="code" href="class_o_t_string.html">OTString</a>    strServerHostname;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="keywordflow">if</span> (<span class="keyword">false</span> == theServerContract.<a class="code" href="class_o_t_server_contract.html#a0714f92ddd215d7a0120dffc4c9c8cd5">GetConnectInfo</a>(strServerHostname, nServerPort))
<a name="l00952"></a>00952     {
<a name="l00953"></a>00953         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed retrieving connection info from server contract.\n&quot;</span>, szFunc);
<a name="l00954"></a>00954         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956     <span class="comment">// ----------------------------------------------</span>
<a name="l00957"></a>00957     <a class="code" href="class_o_t_string.html">OTString</a> strConnectPath;
<a name="l00958"></a>00958     strConnectPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;tcp://%s:%d&quot;</span>, strServerHostname.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), nServerPort);
<a name="l00959"></a>00959     <span class="comment">// --------------------------------------------</span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascEnvelope(theEnvelope);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keywordflow">if</span> (ascEnvelope.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00964"></a>00964     {
<a name="l00965"></a>00965         <span class="keywordflow">if</span> (!m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#abf3a3309b1db9a9f069fc73f6621f2f6">HasContext</a>()) <span class="keywordflow">if</span>(!m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#a7e398f4273932d4d43d3012120326bb0">NewContext</a>())
<a name="l00966"></a>00966             <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// unable to make context. btw. should have been already made.</span>
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="comment">// --------------------------------------------</span>
<a name="l00969"></a>00969 
<a name="l00970"></a>00970         <span class="keywordtype">bool</span> bSuccessSending = m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#ab87369f9469c9881c6bd821636657523">Send</a>(ascEnvelope, strConnectPath);  <span class="comment">// &lt;========</span>
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="keywordflow">if</span> (!bSuccessSending)
<a name="l00973"></a>00973         {
<a name="l00974"></a>00974             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed, even with error correction and retries, &quot;</span>
<a name="l00975"></a>00975                 <span class="stringliteral">&quot;while trying to send message to server.&quot;</span>, szFunc);
<a name="l00976"></a>00976         }
<a name="l00977"></a>00977         <span class="keywordflow">else</span>
<a name="l00978"></a>00978         {
<a name="l00979"></a>00979             <a class="code" href="class_o_t_string.html">OTString</a>  strRawServerReply;
<a name="l00980"></a>00980             <span class="keywordtype">bool</span>      bSuccessReceiving = m_pSocket-&gt;<a class="code" href="class_o_t_socket.html#a22c16b853dab1812a724d91c436135af">Receive</a>(strRawServerReply); <span class="comment">// &lt;========</span>
<a name="l00981"></a>00981 
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (!bSuccessReceiving || !strRawServerReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00983"></a>00983             {
<a name="l00984"></a>00984                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to receive expected reply from server.\n&quot;</span>, szFunc);
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986             <span class="comment">// ----------------------------------------------------------</span>
<a name="l00987"></a>00987             <span class="keywordflow">else</span>
<a name="l00988"></a>00988             {
<a name="l00989"></a>00989                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascServerReply;
<a name="l00990"></a>00990                 <span class="keyword">const</span> <span class="keywordtype">bool</span>   bLoaded = strRawServerReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; ascServerReply.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a6b5c0069db88e2c884d213ea64d3bbe4">LoadFromString</a>(strRawServerReply);
<a name="l00991"></a>00991                 <span class="comment">// -----------------------------</span>
<a name="l00992"></a>00992                 <a class="code" href="class_o_t_string.html">OTString</a> strServerReply;
<a name="l00993"></a>00993                 <span class="keywordtype">bool</span>     bRetrievedReply = <span class="keyword">false</span>;
<a name="l00994"></a>00994                 <span class="comment">// -----------------------------</span>
<a name="l00995"></a>00995                 <span class="keywordflow">if</span> (!bLoaded)
<a name="l00996"></a>00996                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to load OTASCIIArmor object from string:\n\n%s\n\n&quot;</span>,
<a name="l00997"></a>00997                     szFunc, strRawServerReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00998"></a>00998                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strRawServerReply.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;ENVELOPE&quot;</span>)) <span class="comment">// Server sent this encrypted to my public key, in an armored envelope.</span>
<a name="l01001"></a>01001                 {
<a name="l01002"></a>01002                     <a class="code" href="class_o_t_envelope.html">OTEnvelope</a>
<a name="l01003"></a>01003                         theServerEnvelope;
<a name="l01004"></a>01004                     <span class="keywordflow">if</span> (theServerEnvelope.<a class="code" href="class_o_t_envelope.html#ad0d76f534bcda708b0298bcf906cb923">SetAsciiArmoredData</a>(ascServerReply))
<a name="l01005"></a>01005                     {
<a name="l01006"></a>01006 
<a name="l01007"></a>01007                         bRetrievedReply = theServerEnvelope.<a class="code" href="class_o_t_envelope.html#ae2e8fafc4e508ce5d323c089b71c7e7b">Open</a>(*pNym, strServerReply);
<a name="l01008"></a>01008                     }
<a name="l01009"></a>01009                     <span class="keywordflow">else</span>
<a name="l01010"></a>01010                     {
<a name="l01011"></a>01011                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: while setting OTASCIIArmor&#39;d string into an OTEnvelope.\n&quot;</span>, szFunc);
<a name="l01012"></a>01012                     }
<a name="l01013"></a>01013                 }
<a name="l01014"></a>01014                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l01015"></a>01015                 <span class="comment">// NOW ABLE TO HANDLE MESSAGES HERE IN ADDITION TO ENVELOPES!!!!</span>
<a name="l01016"></a>01016                 <span class="comment">// (Sometimes the server HAS to reply with an unencrypted reply,</span>
<a name="l01017"></a>01017                 <span class="comment">// and this is what makes it possible for the client to RECEIVE</span>
<a name="l01018"></a>01018                 <span class="comment">// that reply.)</span>
<a name="l01019"></a>01019                 <span class="comment">//</span>
<a name="l01020"></a>01020                 <span class="comment">// The Server doesn&#39;t have to accept both types, but the client does,</span>
<a name="l01021"></a>01021                 <span class="comment">// since technically all clients cannot talk to it without knowing its key first.</span>
<a name="l01022"></a>01022                 <span class="comment">//</span>
<a name="l01023"></a>01023                 <span class="comment">// ===&gt; A CLIENT could POTENTIALLY have sent a message to server when unregistered,</span>
<a name="l01024"></a>01024                 <span class="comment">// leaving server NO WAY to reply! Therefore server HAS to have the OPTION to send</span>
<a name="l01025"></a>01025                 <span class="comment">// an unencrypted message, in that case, and the client HAS to be able to receive it</span>
<a name="l01026"></a>01026                 <span class="comment">// properly!!</span>
<a name="l01027"></a>01027                 <span class="comment">//</span>
<a name="l01028"></a>01028                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l01029"></a>01029 
<a name="l01030"></a>01030                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strRawServerReply.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;MESSAGE&quot;</span>)) <span class="comment">// Server sent this NOT encrypted, in an armored message.</span>
<a name="l01031"></a>01031                 {
<a name="l01032"></a>01032                     bRetrievedReply = ascServerReply.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strServerReply);
<a name="l01033"></a>01033                 }
<a name="l01034"></a>01034                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l01035"></a>01035                 <span class="keywordflow">else</span>
<a name="l01036"></a>01036                 {
<a name="l01037"></a>01037                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Unknown reply type received from server. (Expected envelope or message.)\n&quot;</span>
<a name="l01038"></a>01038                         <span class="stringliteral">&quot;\n\n PERHAPS YOU ARE RUNNING AN OLD VERSION OF THE SERVER ????? \n\n&quot;</span>, szFunc);
<a name="l01039"></a>01039                 }
<a name="l01040"></a>01040                 <span class="comment">// **********************************************************************</span>
<a name="l01041"></a>01041                 <a class="code" href="class_o_t_message.html">OTMessage</a> * pServerReply(<span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>());
<a name="l01042"></a>01042                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pServerReply);
<a name="l01043"></a>01043 
<a name="l01044"></a>01044                 <span class="keywordflow">if</span> (bRetrievedReply &amp;&amp; strServerReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; pServerReply-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strServerReply))
<a name="l01045"></a>01045                 {
<a name="l01046"></a>01046                     <span class="comment">// Now the fully-loaded message object (from the server, this time) can be processed by the OT library...</span>
<a name="l01047"></a>01047                     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> -&gt; ProcessServerReply(*pServerReply); <span class="comment">// Client takes ownership and will handle cleanup.</span>
<a name="l01048"></a>01048                 }
<a name="l01049"></a>01049                 <span class="keywordflow">else</span>
<a name="l01050"></a>01050                 {
<a name="l01051"></a>01051                     <span class="keywordflow">if</span> (NULL != pServerReply) <span class="keyword">delete</span> pServerReply; pServerReply = NULL;  <span class="comment">// cleanup</span>
<a name="l01052"></a>01052 
<a name="l01053"></a>01053                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading server reply from string:\n\n%s\n\n&quot;</span>,
<a name="l01054"></a>01054                         szFunc, strRawServerReply.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01055"></a>01055                 }
<a name="l01056"></a>01056                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l01057"></a>01057             } <span class="comment">// !success receiving.</span>
<a name="l01058"></a>01058             <span class="comment">// ----------------------------------------------------------</span>
<a name="l01059"></a>01059         } <span class="comment">// else (bSuccessSending)</span>
<a name="l01060"></a>01060     } <span class="comment">// if envelope exists.</span>
<a name="l01061"></a>01061     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 <span class="comment">// -------------------------------------------------------------------------</span>
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 <span class="comment">// *************************************************************************</span>
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 
<a name="l01072"></a><a class="code" href="class_o_t___a_p_i.html#a267d362ca74da9e01ab8e956da42b386">01072</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a267d362ca74da9e01ab8e956da42b386">OT_API::GetNymCount</a>()
<a name="l01073"></a>01073 {
<a name="l01074"></a>01074     <span class="comment">// -------------------------</span>
<a name="l01075"></a>01075     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01076"></a>01076     <span class="comment">// -------------------------</span>
<a name="l01077"></a>01077     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01078"></a>01078         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad98f3386c700710d76e44580c59c505a">GetNymCount</a>();
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">return</span> 0;
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a><a class="code" href="class_o_t___a_p_i.html#a0fad5fe7f5da3cac88b0794c705b1a9b">01083</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a0fad5fe7f5da3cac88b0794c705b1a9b">OT_API::GetServerCount</a>()
<a name="l01084"></a>01084 {
<a name="l01085"></a>01085     <span class="comment">// -------------------------</span>
<a name="l01086"></a>01086     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01087"></a>01087     <span class="comment">// -------------------------</span>
<a name="l01088"></a>01088     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01089"></a>01089         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a4fe8fefbb7d541cab17d920259cd81b7">GetServerCount</a>();
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="keywordflow">return</span> 0;
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a><a class="code" href="class_o_t___a_p_i.html#acb9cb01e0d828ad885aa8da40b69ffb3">01094</a> int32_t <a class="code" href="class_o_t___a_p_i.html#acb9cb01e0d828ad885aa8da40b69ffb3">OT_API::GetAssetTypeCount</a>()
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096     <span class="comment">// -------------------------</span>
<a name="l01097"></a>01097     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01098"></a>01098     <span class="comment">// -------------------------</span>
<a name="l01099"></a>01099     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01100"></a>01100         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a32deda2a4c48baf8e339796f65499f3e">GetAssetTypeCount</a>();
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     <span class="keywordflow">return</span> 0;
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01105"></a><a class="code" href="class_o_t___a_p_i.html#a318b1ae501a4ad2b99ce8ff036546e5e">01105</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a318b1ae501a4ad2b99ce8ff036546e5e">OT_API::GetAccountCount</a>()
<a name="l01106"></a>01106 {
<a name="l01107"></a>01107     <span class="comment">// -------------------------</span>
<a name="l01108"></a>01108     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01109"></a>01109     <span class="comment">// -------------------------</span>
<a name="l01110"></a>01110     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01111"></a>01111         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ac41d592707a250be4b86d23b7a3ea552">GetAccountCount</a>();
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <span class="keywordflow">return</span> 0;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="comment">// *************************************************************************</span>
<a name="l01117"></a>01117 
<a name="l01118"></a><a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">01118</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">OT_API::GetNym</a>(int32_t iIndex, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; NYM_NAME)
<a name="l01119"></a>01119 {
<a name="l01120"></a>01120     <span class="comment">// -------------------------</span>
<a name="l01121"></a>01121     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01122"></a>01122     <span class="comment">// -------------------------</span>
<a name="l01123"></a>01123     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01124"></a>01124         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a146e2339010f1e6b8b9cba252c8d3213">GetNym</a>(iIndex, NYM_ID, NYM_NAME);
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 
<a name="l01129"></a><a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">01129</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">OT_API::GetServer</a>(int32_t iIndex, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; THE_NAME)
<a name="l01130"></a>01130 {
<a name="l01131"></a>01131     <span class="comment">// -------------------------</span>
<a name="l01132"></a>01132     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01133"></a>01133     <span class="comment">// -------------------------</span>
<a name="l01134"></a>01134     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01135"></a>01135         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aad6abb5e5fd19ffd69a9b6f0eb75f1c7">GetServer</a>(iIndex, THE_ID, THE_NAME);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01140"></a><a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">01140</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">OT_API::GetAssetType</a>(int32_t iIndex, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; THE_NAME)
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142     <span class="comment">// -------------------------</span>
<a name="l01143"></a>01143     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01144"></a>01144     <span class="comment">// -------------------------</span>
<a name="l01145"></a>01145     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01146"></a>01146         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a5f328a7ca7030125cc121b5062e0627a">GetAssetType</a>(iIndex, THE_ID, THE_NAME);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01149"></a>01149 }
<a name="l01150"></a>01150 
<a name="l01151"></a><a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">01151</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">OT_API::GetAccount</a>(int32_t iIndex, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; THE_NAME)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     <span class="comment">// -------------------------</span>
<a name="l01154"></a>01154     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01155"></a>01155     <span class="comment">// -------------------------</span>
<a name="l01156"></a>01156     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01157"></a>01157         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(iIndex, THE_ID, THE_NAME);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01160"></a>01160 }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162 <span class="comment">// *************************************************************************</span>
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 
<a name="l01165"></a><a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">01165</a> <a class="code" href="class_o_t_wallet.html">OTWallet</a> * <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">OT_API::GetWallet</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167     <span class="comment">// Any function that calls GetWallet() thus asserts here.</span>
<a name="l01168"></a>01168     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l01169"></a>01169     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01170"></a>01170     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : __FUNCTION__;
<a name="l01171"></a>01171     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01172"></a>01172     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>; <span class="comment">// This is where we &quot;get&quot; the wallet.  :P</span>
<a name="l01173"></a>01173     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01174"></a>01174     <span class="keywordflow">if</span> (NULL == pWallet)
<a name="l01175"></a>01175         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s %s: -- The Wallet is not loaded.\n&quot;</span>,
<a name="l01176"></a>01176                        __FUNCTION__, szFunc);
<a name="l01177"></a>01177     <span class="keywordflow">return</span> pWallet;
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <span class="comment">// *************************************************************************</span>
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 
<a name="l01183"></a><a class="code" href="class_o_t___a_p_i.html#a5bc096141864f38038f2860076d93f9e">01183</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">OT_API::GetNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01184"></a>01184 {
<a name="l01185"></a>01185     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01186"></a>01186     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01187"></a>01187     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetNym&quot;</span>;
<a name="l01188"></a>01188     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01189"></a>01189     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01190"></a>01190     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01192"></a>01192     {
<a name="l01193"></a>01193         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aab65a5710311cc6eeb9fbd0d7f881f0e">GetNymByID</a>(NYM_ID);
<a name="l01194"></a>01194         <span class="keywordflow">if</span> ((NULL == pNym) &amp;&amp; (NULL != szFuncName)) <span class="comment">// We only log if the caller asked us to.</span>
<a name="l01195"></a>01195         {
<a name="l01196"></a>01196             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(NYM_ID);
<a name="l01197"></a>01197             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::GetNym %s: No Nym found in wallet with ID: %s\n&quot;</span>,
<a name="l01198"></a>01198                            szFunc, strID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01199"></a>01199         }
<a name="l01200"></a>01200         <span class="keywordflow">return</span> pNym;
<a name="l01201"></a>01201     }
<a name="l01202"></a>01202     <span class="keywordflow">return</span> NULL;
<a name="l01203"></a>01203 }
<a name="l01204"></a>01204 
<a name="l01205"></a><a class="code" href="class_o_t___a_p_i.html#acb7f145e4c952265f06719ef525c3543">01205</a> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * <a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">OT_API::GetServer</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01206"></a>01206 {
<a name="l01207"></a>01207     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01208"></a>01208     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetServer&quot;</span>;
<a name="l01209"></a>01209     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01210"></a>01210     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01211"></a>01211     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01212"></a>01212     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01213"></a>01213     {
<a name="l01214"></a>01214         <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pContract = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae897619f652a0d3d9fba99a8bc747993">GetServerContract</a>(THE_ID);
<a name="l01215"></a>01215         <span class="keywordflow">if</span> ((NULL == pContract) &amp;&amp; (NULL != szFuncName)) <span class="comment">// We only log if the caller asked us to.</span>
<a name="l01216"></a>01216         {
<a name="l01217"></a>01217             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(THE_ID);
<a name="l01218"></a>01218             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::GetServer %s: No server contract found in wallet with ID: %s\n&quot;</span>,
<a name="l01219"></a>01219                            szFunc, strID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01220"></a>01220         }
<a name="l01221"></a>01221         <span class="keywordflow">return</span> pContract;
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223     <span class="keywordflow">return</span> NULL;
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a><a class="code" href="class_o_t___a_p_i.html#ac31d39fb3e703cebc6a9e2842593040f">01226</a> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * <a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">OT_API::GetAssetType</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01227"></a>01227 {
<a name="l01228"></a>01228     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01229"></a>01229     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetAssetType&quot;</span>;
<a name="l01230"></a>01230     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01231"></a>01231     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01232"></a>01232     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01233"></a>01233     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01234"></a>01234     {
<a name="l01235"></a>01235         <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a4daee51036b24439e687383a6c66c6f7">GetAssetContract</a>(THE_ID);
<a name="l01236"></a>01236         <span class="keywordflow">if</span> ((NULL == pContract) &amp;&amp; (NULL != szFuncName)) <span class="comment">// We only log if the caller asked us to.</span>
<a name="l01237"></a>01237         {
<a name="l01238"></a>01238             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(THE_ID);
<a name="l01239"></a>01239             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::GetAssetType %s: No asset contract found in wallet with ID: %s\n&quot;</span>,
<a name="l01240"></a>01240                            szFunc, strID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01241"></a>01241         }
<a name="l01242"></a>01242         <span class="keywordflow">return</span> pContract;
<a name="l01243"></a>01243     }
<a name="l01244"></a>01244     <span class="keywordflow">return</span> NULL;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a><a class="code" href="class_o_t___a_p_i.html#a1591843600750cfacc015a9bbd12b26f">01247</a> <a class="code" href="class_o_t_account.html">OTAccount</a> * <a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">OT_API::GetAccount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; THE_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01250"></a>01250     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetAccount&quot;</span>;
<a name="l01251"></a>01251     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01252"></a>01252     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01253"></a>01253     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01254"></a>01254     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01255"></a>01255     {
<a name="l01256"></a>01256         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAcct = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aee1809973c356a82e9c0f80d201668f4">GetAccount</a>(THE_ID);
<a name="l01257"></a>01257         <span class="keywordflow">if</span> ((NULL == pAcct) &amp;&amp; (NULL != szFuncName)) <span class="comment">// We only log if the caller asked us to.</span>
<a name="l01258"></a>01258         {
<a name="l01259"></a>01259             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strID(THE_ID);
<a name="l01260"></a>01260             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::GetAccount %s: No account found in wallet with ID: %s\n&quot;</span>,
<a name="l01261"></a>01261                            szFunc, strID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263         <span class="keywordflow">return</span> pAcct;
<a name="l01264"></a>01264     }
<a name="l01265"></a>01265     <span class="keywordflow">return</span> NULL;
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268 <span class="comment">// *************************************************************************</span>
<a name="l01269"></a>01269 
<a name="l01270"></a>01270 
<a name="l01271"></a>01271 
<a name="l01272"></a><a class="code" href="class_o_t___a_p_i.html#aa0bdb71f4b4b19f8a49061cbc2d037c4">01272</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#aa0bdb71f4b4b19f8a49061cbc2d037c4">OT_API::GetNymByIDPartialMatch</a>(<span class="keyword">const</span> std::string PARTIAL_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01273"></a>01273 {
<a name="l01274"></a>01274     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01275"></a>01275     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetNymByIDPartialMatch&quot;</span>;
<a name="l01276"></a>01276     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01277"></a>01277     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01278"></a>01278     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01279"></a>01279     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01280"></a>01280         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a66e64e6ea0c2a9d74099b83b8fe87637">GetNymByIDPartialMatch</a>(PARTIAL_ID);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     <span class="keywordflow">return</span> NULL;
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a><a class="code" href="class_o_t___a_p_i.html#a27228b655e5c661959812e3a2b7f144e">01285</a> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * <a class="code" href="class_o_t___a_p_i.html#a27228b655e5c661959812e3a2b7f144e">OT_API::GetServerContractPartialMatch</a>(<span class="keyword">const</span> std::string PARTIAL_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01288"></a>01288     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetServerContractPartialMatch&quot;</span>;
<a name="l01289"></a>01289     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01290"></a>01290     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01291"></a>01291     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01292"></a>01292     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01293"></a>01293         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a2c08b5bd12930371f99e793762819dd5">GetServerContractPartialMatch</a>(PARTIAL_ID);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     <span class="keywordflow">return</span> NULL;
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01298"></a><a class="code" href="class_o_t___a_p_i.html#aec51f205544c3c4a8acf95e1562292ba">01298</a> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * <a class="code" href="class_o_t___a_p_i.html#aec51f205544c3c4a8acf95e1562292ba">OT_API::GetAssetContractPartialMatch</a>(<span class="keyword">const</span> std::string PARTIAL_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01299"></a>01299 {
<a name="l01300"></a>01300     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01301"></a>01301     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetAssetContractPartialMatch&quot;</span>;
<a name="l01302"></a>01302     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01303"></a>01303     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01304"></a>01304     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01305"></a>01305     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01306"></a>01306         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aaab24113b89af3d58010e308bf2dce8f">GetAssetContractPartialMatch</a>(PARTIAL_ID);
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="keywordflow">return</span> NULL;
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a><a class="code" href="class_o_t___a_p_i.html#a7a602b75fccd8b11b73508ce358a4594">01311</a> <a class="code" href="class_o_t_account.html">OTAccount</a> * <a class="code" href="class_o_t___a_p_i.html#a7a602b75fccd8b11b73508ce358a4594">OT_API::GetAccountPartialMatch</a>(<span class="keyword">const</span> std::string PARTIAL_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l01312"></a>01312 {
<a name="l01313"></a>01313     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01314"></a>01314     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetAccountPartialMatch&quot;</span>;
<a name="l01315"></a>01315     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01316"></a>01316     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01317"></a>01317     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01318"></a>01318     <span class="keywordflow">if</span> (NULL != pWallet)
<a name="l01319"></a>01319         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab25801b4fc2815bd397b523acf65c2d6">GetAccountPartialMatch</a>(PARTIAL_ID);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     <span class="keywordflow">return</span> NULL;
<a name="l01322"></a>01322 }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="comment">// *************************************************************************</span>
<a name="l01325"></a>01325 
<a name="l01326"></a>01326 
<a name="l01327"></a>01327 
<a name="l01328"></a>01328 <span class="comment">// returns a new nym (with key pair) and files created. (Or NULL.)</span>
<a name="l01329"></a>01329 <span class="comment">//</span>
<a name="l01330"></a>01330 <span class="comment">// Adds to wallet. (No need to delete.)</span>
<a name="l01331"></a>01331 <span class="comment">//</span>
<a name="l01332"></a><a class="code" href="class_o_t___a_p_i.html#a0de395c333a49913b59ae8cac223d526">01332</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#a0de395c333a49913b59ae8cac223d526">OT_API::CreateNym</a>(int32_t nKeySize<span class="comment">/*=1024*/</span>,
<a name="l01333"></a>01333                                 <span class="keyword">const</span> std::string str_id_source   <span class="comment">/*=&quot;&quot;*/</span>,
<a name="l01334"></a>01334                                 <span class="keyword">const</span> std::string str_alt_location<span class="comment">/*=&quot;&quot;*/</span>)
<a name="l01335"></a>01335 {
<a name="l01336"></a>01336     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l01337"></a>01337     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = __FUNCTION__;
<a name="l01338"></a>01338     <span class="comment">// -----------------------------------------------------</span>
<a name="l01339"></a>01339     <span class="keywordflow">switch</span> (nKeySize)
<a name="l01340"></a>01340     {
<a name="l01341"></a>01341         <span class="keywordflow">case</span> 1024:
<a name="l01342"></a>01342         <span class="keywordflow">case</span> 2048:
<a name="l01343"></a>01343         <span class="keywordflow">case</span> 4096:
<a name="l01344"></a>01344         <span class="keywordflow">case</span> 8192:
<a name="l01345"></a>01345             <span class="keywordflow">break</span>;
<a name="l01346"></a>01346         <span class="keywordflow">default</span>:
<a name="l01347"></a>01347             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: nKeySize must be one of: &quot;</span>
<a name="l01348"></a>01348                           <span class="stringliteral">&quot;1024, 2048, 4096, 8192. (%d was passed...)\n&quot;</span>,
<a name="l01349"></a>01349                           szFuncName, nKeySize);
<a name="l01350"></a>01350             <span class="keywordflow">return</span> NULL;
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352     <span class="comment">// ---------------------------</span>
<a name="l01353"></a>01353     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l01355"></a>01355     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l01356"></a>01356     <span class="comment">// -----------------------------------------------------</span>
<a name="l01357"></a>01357     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = <span class="keyword">new</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>;
<a name="l01358"></a>01358     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01359"></a>01359     <span class="comment">// ---------------------------</span>
<a name="l01360"></a>01360     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7a215c63b72b47034e3f92e4334f44f6">GenerateNym</a>(nKeySize, <span class="keyword">true</span>, str_id_source, str_alt_location))
<a name="l01361"></a>01361     {
<a name="l01362"></a>01362         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to generate Nym.\n&quot;</span>, szFuncName);
<a name="l01363"></a>01363         <span class="keyword">delete</span> pNym; pNym = NULL;
<a name="l01364"></a>01364         <span class="keywordflow">return</span> NULL;
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366     <span class="comment">// ---------------------------</span>
<a name="l01367"></a>01367     pWallet-&gt;<a class="code" href="class_o_t_wallet.html#acb570de733658a4ad24756dde0f22a34">AddNym</a>(*pNym); <span class="comment">// Add our new nym to the wallet, who &quot;owns&quot; it hereafter.</span>
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <span class="comment">// Note: It&#39;s already on the master key. To prevent that, we would have had</span>
<a name="l01370"></a>01370     <span class="comment">// to PAUSE the master key before calling GenerateNym above. So the below call</span>
<a name="l01371"></a>01371     <span class="comment">// is less about the Nym&#39;s encryption, and more about the wallet KNOWING. Because</span>
<a name="l01372"></a>01372     <span class="comment">// OTWallet::ConvertNymToCachedKey is what adds this nym to the wallet&#39;s list of</span>
<a name="l01373"></a>01373     <span class="comment">// &quot;master key nyms&quot;. Until that happens, the wallet has no idea.</span>
<a name="l01374"></a>01374     <span class="comment">//</span>
<a name="l01375"></a>01375     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a59daeb8ce8f92530c5ddb4fcd1dde7d4">ConvertNymToCachedKey</a>(*pNym))
<a name="l01376"></a>01376         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed in pWallet-&gt;ConvertNymToCachedKey \n&quot;</span>,
<a name="l01377"></a>01377                       szFuncName);
<a name="l01378"></a>01378     pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Since it just changed.</span>
<a name="l01379"></a>01379     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l01380"></a>01380     <span class="comment">//  (No need to cleanup.)</span>
<a name="l01381"></a>01381     <span class="comment">// ---------------------------</span>
<a name="l01382"></a>01382     <span class="keywordflow">return</span> pNym;
<a name="l01383"></a>01383 }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 <span class="comment">// ------------------------------------------------------------------</span>
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 <span class="comment">// The Asset Type&#39;s Name is basically just a client-side label.</span>
<a name="l01392"></a>01392 <span class="comment">// This function lets you change it.</span>
<a name="l01393"></a>01393 <span class="comment">//</span>
<a name="l01394"></a>01394 <span class="comment">// Returns success, true or false.</span>
<a name="l01395"></a>01395 <span class="comment">//</span>
<a name="l01396"></a><a class="code" href="class_o_t___a_p_i.html#a62071d84252f0b233071c640b9de67de">01396</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a62071d84252f0b233071c640b9de67de">OT_API::SetAssetType_Name</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp;   ASSET_ID,
<a name="l01397"></a>01397                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       &amp;   STR_NEW_NAME)
<a name="l01398"></a>01398 {
<a name="l01399"></a>01399     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = __FUNCTION__; <span class="comment">//&quot;OT_API::SetAssetType_Name&quot;;</span>
<a name="l01400"></a>01400     <span class="comment">// -----------------------------------------------------</span>
<a name="l01401"></a>01401     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01403"></a>01403     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l01404"></a>01404     <span class="comment">// -----------------------------------------------------</span>
<a name="l01405"></a>01405     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(ASSET_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l01406"></a>01406     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01407"></a>01407     <span class="comment">// By this point, pContract is a good pointer.  (No need to cleanup.)</span>
<a name="l01408"></a>01408     <span class="comment">// -----------------------------------------------------</span>
<a name="l01409"></a>01409     <span class="comment">// Might want to put some more data validation on the name?</span>
<a name="l01410"></a>01410     <span class="keywordflow">if</span> (!STR_NEW_NAME.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01411"></a>01411         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SetAssetType_Name: Bad: name is empty.\n&quot;</span>);
<a name="l01412"></a>01412     <span class="keywordflow">else</span>
<a name="l01413"></a>01413     {
<a name="l01414"></a>01414         pContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(STR_NEW_NAME);
<a name="l01415"></a>01415         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the name is actually stored here.</span>
<a name="l01416"></a>01416     }
<a name="l01417"></a>01417     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 <span class="comment">// The Server&#39;s Name is basically just a client-side label.</span>
<a name="l01423"></a>01423 <span class="comment">// This function lets you change it.</span>
<a name="l01424"></a>01424 <span class="comment">//</span>
<a name="l01425"></a>01425 <span class="comment">// Returns success, true or false.</span>
<a name="l01426"></a>01426 <span class="comment">//</span>
<a name="l01427"></a><a class="code" href="class_o_t___a_p_i.html#a5e063a9ac2d1e9c15eb116948a16fb6e">01427</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a5e063a9ac2d1e9c15eb116948a16fb6e">OT_API::SetServer_Name</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp;   SERVER_ID,
<a name="l01428"></a>01428                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      &amp;   STR_NEW_NAME)
<a name="l01429"></a>01429 {
<a name="l01430"></a>01430     <span class="comment">// -----------------------------------------------------</span>
<a name="l01431"></a>01431     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01432"></a>01432     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01433"></a>01433     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l01434"></a>01434     <span class="comment">// -----------------------------------------------------</span>
<a name="l01435"></a>01435     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l01436"></a>01436     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01437"></a>01437     <span class="comment">// By this point, pContract is a good pointer.  (No need to cleanup.)</span>
<a name="l01438"></a>01438     <span class="comment">// -----------------------------------------------------</span>
<a name="l01439"></a>01439     <span class="comment">// Might want to put some more data validation on the name?</span>
<a name="l01440"></a>01440     <span class="keywordflow">if</span> (!STR_NEW_NAME.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01441"></a>01441         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Bad: name is empty.\n&quot;</span>, __FUNCTION__);
<a name="l01442"></a>01442     <span class="keywordflow">else</span>
<a name="l01443"></a>01443     {
<a name="l01444"></a>01444         pContract-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(STR_NEW_NAME);
<a name="l01445"></a>01445         <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only &#39;cause the name is actually stored here.</span>
<a name="l01446"></a>01446     }
<a name="l01447"></a>01447     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 
<a name="l01452"></a><a class="code" href="class_o_t___a_p_i.html#a1124d87febc45eec06c1c9e8a2cc91da">01452</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a1124d87febc45eec06c1c9e8a2cc91da">OT_API::IsNym_RegisteredAtServer</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01455"></a>01455     <span class="comment">// -----------------------------------------------------</span>
<a name="l01456"></a>01456     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(NYM_ID, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01457"></a>01457     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01458"></a>01458     <span class="comment">// Below this point, pNym is a good ptr, and will be cleaned up automatically.</span>
<a name="l01459"></a>01459     <span class="comment">// ------------------------------------------------------</span>
<a name="l01460"></a>01460     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l01461"></a>01461     <span class="keywordflow">return</span> pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#af5e9078ab475e6cd9c53e4ad2fae0417">IsRegisteredAtServer</a>(strServerID);
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l01466"></a>01466 <span class="comment">/*</span>
<a name="l01467"></a>01467 <span class="comment"> CHANGE MASTER KEY and PASSWORD.</span>
<a name="l01468"></a>01468 <span class="comment"></span>
<a name="l01469"></a>01469 <span class="comment"> Normally your passphrase is used to derive a key, which is used to unlock</span>
<a name="l01470"></a>01470 <span class="comment"> a random number (a symmetric key), which is used as the passphrase to open the</span>
<a name="l01471"></a>01471 <span class="comment"> master key, which is used as the passphrase to any given Nym.</span>
<a name="l01472"></a>01472 <span class="comment"></span>
<a name="l01473"></a>01473 <span class="comment"> Since all the Nyms are encrypted to the master key, and since we can change the</span>
<a name="l01474"></a>01474 <span class="comment"> passphrase on the master key without changing the master key itself, then we don&#39;t</span>
<a name="l01475"></a>01475 <span class="comment"> have to do anything to update all the Nyms, since that part hasn&#39;t changed.</span>
<a name="l01476"></a>01476 <span class="comment"></span>
<a name="l01477"></a>01477 <span class="comment"> But we might want a separate &quot;Change Master Key&quot; function that replaces that key</span>
<a name="l01478"></a>01478 <span class="comment"> itself, in which case we&#39;d HAVE to load up all the Nyms and re-save them.</span>
<a name="l01479"></a>01479 <span class="comment"></span>
<a name="l01480"></a>01480 <span class="comment">*** UPDATE: Seems the easiest thing to do is to just change both the key and passphase</span>
<a name="l01481"></a>01481 <span class="comment"> at the same time here, by loading up all the private nyms, destroying the master key,</span>
<a name="l01482"></a>01482 <span class="comment"> and then saving all the private Nyms. (With master key never actually being &quot;paused.&quot;)</span>
<a name="l01483"></a>01483 <span class="comment"> This will automatically cause it to generate a new master key during the saving process.</span>
<a name="l01484"></a>01484 <span class="comment"> (Make sure to save the wallet also.)</span>
<a name="l01485"></a>01485 <span class="comment"> */</span>
<a name="l01486"></a>01486 
<a name="l01487"></a>01487 
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 <span class="comment">/*</span>
<a name="l01490"></a>01490 <span class="comment"></span>
<a name="l01491"></a>01491 <span class="comment"> // Done:</span>
<a name="l01492"></a>01492 <span class="comment"></span>
<a name="l01493"></a>01493 <span class="comment"> Load up separate copies of all the Nyms.</span>
<a name="l01494"></a>01494 <span class="comment"> (Set them to destruct automatically on exit, no matter what.)</span>
<a name="l01495"></a>01495 <span class="comment"></span>
<a name="l01496"></a>01496 <span class="comment"> Change them to temp PW.</span>
<a name="l01497"></a>01497 <span class="comment"></span>
<a name="l01498"></a>01498 <span class="comment"> Re-generate master.</span>
<a name="l01499"></a>01499 <span class="comment"></span>
<a name="l01500"></a>01500 <span class="comment"> Change them to new master.</span>
<a name="l01501"></a>01501 <span class="comment"></span>
<a name="l01502"></a>01502 <span class="comment"> Save nyms, save wallet.</span>
<a name="l01503"></a>01503 <span class="comment"></span>
<a name="l01504"></a>01504 <span class="comment"> Reload wallet.</span>
<a name="l01505"></a>01505 <span class="comment"></span>
<a name="l01506"></a>01506 <span class="comment"> IF anything fails along the way, we just return. What happens? The temp</span>
<a name="l01507"></a>01507 <span class="comment"> Nyms we converted are destroyed, not saved, and were not the actual wallet</span>
<a name="l01508"></a>01508 <span class="comment"> copies anyway (which are still old.) The master key itself is reverted to</span>
<a name="l01509"></a>01509 <span class="comment"> its former form (I stored a copy of that) and the wallet file itself is</span>
<a name="l01510"></a>01510 <span class="comment"> never overwritten.</span>
<a name="l01511"></a>01511 <span class="comment"> Once we successfully convert everything, we save the Nyms and then re-load</span>
<a name="l01512"></a>01512 <span class="comment"> the wallet (and thus the nyms...) Now the updated Nyms are loaded up in the</span>
<a name="l01513"></a>01513 <span class="comment"> wallet, and the temp ones just destruct when we exit the function. Perfect.</span>
<a name="l01514"></a>01514 <span class="comment"></span>
<a name="l01515"></a>01515 <span class="comment"> */</span>
<a name="l01516"></a>01516 
<a name="l01517"></a>01517 <span class="comment">// WARNING: This function, if successful, saves and re-loads the wallet.</span>
<a name="l01518"></a>01518 <span class="comment">// Therefore if you have any pointers to things inside the wallet, such as</span>
<a name="l01519"></a>01519 <span class="comment">// a pointer to a Nym, that pointer will be bad after you call this function.</span>
<a name="l01520"></a>01520 <span class="comment">// So make sure you grab a fresh pointer in such situations, after calling this.</span>
<a name="l01521"></a>01521 <span class="comment">// (Because the one you had before will crash you.)</span>
<a name="l01522"></a>01522 <span class="comment">//</span>
<a name="l01523"></a><a class="code" href="class_o_t___a_p_i.html#a90f13aec197a306faca8f87d1dd8d1dd">01523</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a90f13aec197a306faca8f87d1dd8d1dd">OT_API::Wallet_ChangePassphrase</a>()
<a name="l01524"></a>01524 {
<a name="l01525"></a>01525     <span class="comment">// -----------------------------------------------------</span>
<a name="l01526"></a>01526     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l01527"></a>01527     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01528"></a>01528     <span class="comment">// -----------------------------------------------------</span>
<a name="l01529"></a>01529     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l01530"></a>01530     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01531"></a>01531     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l01532"></a>01532     <span class="comment">// -----------------------------------------------------</span>
<a name="l01533"></a>01533     <span class="keyword">class </span>ot_change_pw
<a name="l01534"></a>01534     {
<a name="l01535"></a>01535         std::list&lt;OTPseudonym *&gt; * m_plist_nyms; <span class="comment">// We&#39;ll be responsible in this class for cleaning these up.</span>
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="keyword">public</span>:
<a name="l01538"></a>01538         ot_change_pw(std::list&lt;OTPseudonym *&gt; &amp; list_nyms) : m_plist_nyms(&amp;list_nyms) { }
<a name="l01539"></a>01539         ~ot_change_pw()
<a name="l01540"></a>01540         {
<a name="l01541"></a>01541             <span class="keywordflow">if</span> (NULL != m_plist_nyms)
<a name="l01542"></a>01542             {
<a name="l01543"></a>01543                 <span class="keywordflow">while</span> (m_plist_nyms-&gt;size() &gt; 0) <span class="comment">// Here&#39;s the cleanup.</span>
<a name="l01544"></a>01544                 {
<a name="l01545"></a>01545                     std::list&lt;OTPseudonym *&gt;::iterator it = m_plist_nyms-&gt;begin();
<a name="l01546"></a>01546                     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = *it;
<a name="l01547"></a>01547                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01548"></a>01548 
<a name="l01549"></a>01549                     <span class="keyword">delete</span> pNym; pNym = NULL;
<a name="l01550"></a>01550                     m_plist_nyms-&gt;erase(it);
<a name="l01551"></a>01551                 }
<a name="l01552"></a>01552             }
<a name="l01553"></a>01553         }
<a name="l01554"></a>01554     };
<a name="l01555"></a>01555     <span class="comment">// -----------------------------------------------------</span>
<a name="l01556"></a>01556     std::list&lt;OTPseudonym *&gt; list_nyms;  <span class="comment">// Any Nyms on this list will be cleaned up automatically in the ot_change_pw destructor. Thus</span>
<a name="l01557"></a>01557     ot_change_pw the_cleanup(list_nyms); <span class="comment">// we cannot add Nyms here that are also on the Wallet. We load our own copies just for this list.</span>
<a name="l01558"></a>01558     <span class="comment">// -----------------------------------------------------</span>
<a name="l01559"></a>01559     <span class="keywordtype">bool</span> bAtLeastOneNymHasCredentials = <span class="keyword">false</span>;
<a name="l01560"></a>01560     <span class="keywordtype">bool</span> bSuccessLoading              = <span class="keyword">true</span>; <span class="comment">// defaults to true in case there aren&#39;t any Nyms.</span>
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="comment">// Loop through all the private Nyms and get them all loaded up into a list.</span>
<a name="l01563"></a>01563     <span class="comment">//</span>
<a name="l01564"></a>01564     <span class="keyword">const</span> int32_t nNymCount = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad98f3386c700710d76e44580c59c505a">GetNymCount</a>();
<a name="l01565"></a>01565     <span class="comment">// -----------------------------------------------------</span>
<a name="l01566"></a>01566     <span class="keywordflow">for</span> (int32_t iii = 0; iii &lt; nNymCount; ++iii)
<a name="l01567"></a>01567     {
<a name="l01568"></a>01568         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYM_ID;
<a name="l01569"></a>01569         <a class="code" href="class_o_t_string.html">OTString</a>     NYM_NAME;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571         <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotNym = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a146e2339010f1e6b8b9cba252c8d3213">GetNym</a>(iii, NYM_ID, NYM_NAME);
<a name="l01572"></a>01572         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(bGotNym);
<a name="l01573"></a>01573         <span class="comment">// ----------------------</span>
<a name="l01574"></a>01574         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(NYM_ID);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576         <span class="comment">// otherwise it&#39;s a public Nym, so we just skip it.</span>
<a name="l01577"></a>01577         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_pseudonym.html#a9dd185e1a1c2e263e4a2978aefed21c2">OTPseudonym::DoesCertfileExist</a>(strNymID)) <span class="comment">// is there a private key or credential available for this Nym?</span>
<a name="l01578"></a>01578         {   <span class="comment">// In here, we know there&#39;s a private key...</span>
<a name="l01579"></a>01579 
<a name="l01580"></a>01580             <span class="comment">// CALLER responsible to delete!</span>
<a name="l01581"></a>01581             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a38f96bbf12655ca9ced0ebf33a5c3794">LoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span> <span class="comment">/*bChecking*/</span>,  __FUNCTION__); <span class="comment">// This also loads credentials, if there are any.</span>
<a name="l01582"></a>01582 
<a name="l01583"></a>01583             <span class="comment">// We use LoadPrivateNym here instead. (meaning: need to clean them up.)</span>
<a name="l01584"></a>01584             <span class="comment">// Therefore use a nested class here to handle the cleanup.</span>
<a name="l01585"></a>01585             <span class="comment">// This way we aren&#39;t changing the actual Nyms in the wallet until it&#39;s re-loaded.</span>
<a name="l01586"></a>01586             <span class="comment">// Any failure between now and then, and it&#39;s not re-loaded, and none of the Nyms</span>
<a name="l01587"></a>01587             <span class="comment">// were ever changed!</span>
<a name="l01588"></a>01588 
<a name="l01589"></a>01589             <span class="keywordflow">if</span> (NULL == pNym) <span class="comment">// Since we KNOW there&#39;s a private key, yet it failed, therefore the user must have entered the wrong password...</span>
<a name="l01590"></a>01590             {
<a name="l01591"></a>01591                 bSuccessLoading = <span class="keyword">false</span>;
<a name="l01592"></a>01592                 <span class="keywordflow">break</span>;
<a name="l01593"></a>01593             }
<a name="l01594"></a>01594             <span class="comment">// else... (add to list for cleanup, on exit from this function.)</span>
<a name="l01595"></a>01595             list_nyms.push_back(pNym); <span class="comment">// ONLY private Nyms, and they ALL must successfully load and verify.</span>
<a name="l01596"></a>01596 
<a name="l01597"></a>01597             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0)
<a name="l01598"></a>01598                 bAtLeastOneNymHasCredentials = <span class="keyword">true</span>;
<a name="l01599"></a>01599         }
<a name="l01600"></a>01600     }
<a name="l01601"></a>01601     <span class="comment">// ----------------------</span>
<a name="l01602"></a>01602     <span class="keywordflow">if</span> (!bSuccessLoading)
<a name="l01603"></a>01603     {
<a name="l01604"></a>01604         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed to load all the private Nyms. Wrong passphrase? (Aborting operation.)\n&quot;</span>,
<a name="l01605"></a>01605                       __FUNCTION__);
<a name="l01606"></a>01606         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608     <span class="comment">// By this point we KNOW we have successfully loaded up ALL the private Nyms</span>
<a name="l01609"></a>01609     <span class="comment">// for this wallet, and that list_nyms contains a pointer to each one...</span>
<a name="l01610"></a>01610     <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l01611"></a>01611     <span class="comment">// ENCRYPT ALL CREDENTIALS FROM MASTER KEY INTO A TEMP KEY</span>
<a name="l01612"></a>01612     <span class="comment">//</span>
<a name="l01613"></a>01613     <a class="code" href="class_o_t_password.html">OTPassword</a>     theTempPassword; <span class="comment">// Used to store a temp password only. Only for credentialed nyms.</span>
<a name="l01614"></a>01614     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<span class="stringliteral">&quot;Enter existing wallet master passphrase.&quot;</span>);
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <span class="comment">// At this point, for Nyms with credentials, we need to ReEncrypt the Nym&#39;s credentials,</span>
<a name="l01617"></a>01617     <span class="comment">// similar to importing or exporting the Nym from the wallet. Except this time, we have</span>
<a name="l01618"></a>01618     <span class="comment">// to ReEncrypt FROM a wallet-based Nym to a temporary passphrase, then destroy and re-</span>
<a name="l01619"></a>01619     <span class="comment">// create the wallet&#39;s cached master key, then ReEncrypt AGAIN from the temporary passphrase</span>
<a name="l01620"></a>01620     <span class="comment">// and back to the new master passphrase that was just generated.</span>
<a name="l01621"></a>01621     <span class="comment">// Makes sense? It&#39;s the easiest way to do it based on the existing code we have.</span>
<a name="l01622"></a>01622     <span class="comment">//</span>
<a name="l01623"></a>01623     <span class="keywordflow">if</span> (bAtLeastOneNymHasCredentials) <span class="comment">// All the Nyms on our list are private, by this point. And within this block, they have credentials, too.</span>
<a name="l01624"></a>01624     {
<a name="l01625"></a>01625         theTempPassword.<a class="code" href="class_o_t_password.html#a0e4664e731c30f8a7a8f83a2e20f907f">randomizePassword</a>(12); <span class="comment">// the new random PW will be 12 bytes int64_t. (We discard it after this function is done.)</span>
<a name="l01626"></a>01626         <span class="keywordtype">bool</span> bSuccessReEncrypting = <span class="keyword">true</span>;
<a name="l01627"></a>01627         <span class="comment">// ------------------------</span>
<a name="l01628"></a>01628         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::list&lt;OTPseudonym *&gt;, list_nyms)
<a name="l01629"></a>01629         {
<a name="l01630"></a>01630             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = *it;
<a name="l01631"></a>01631             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01632"></a>01632             <span class="comment">// ------------------------</span>
<a name="l01633"></a>01633             <span class="comment">// We know at least one Nym has credentials. Does this one?</span>
<a name="l01634"></a>01634             <span class="comment">//</span>
<a name="l01635"></a>01635             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0) <span class="comment">// If this specific Nym has credentials...</span>
<a name="l01636"></a>01636             {
<a name="l01637"></a>01637                 <span class="comment">// It won&#39;t ask for a passphrase when using the temp password, since it already</span>
<a name="l01638"></a>01638                 <span class="comment">// has the password. So it will only ask for a passphrase when it is NOT using</span>
<a name="l01639"></a>01639                 <span class="comment">// the temp password, e.g. when using the wallet&#39;s cached master key. ABOVE (here)</span>
<a name="l01640"></a>01640                 <span class="comment">// that will be the OLD master key, and BELOW (after the master key is re-created)</span>
<a name="l01641"></a>01641                 <span class="comment">// that will be the NEW master key.</span>
<a name="l01642"></a>01642                 <span class="comment">// That&#39;s why here, it says: &quot;Enter your EXISTING wallet master passphrase.&quot;</span>
<a name="l01643"></a>01643                 <span class="comment">//</span>
<a name="l01644"></a>01644                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bExported = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adf52e65c9002374a7298f17d97be5b57">ReEncryptPrivateCredentials</a>(<span class="keyword">false</span><span class="comment">/* (EXPORTING) bImporting=FALSE */</span>,
<a name="l01645"></a>01645                                                                          &amp;thePWData, &amp;theTempPassword);
<a name="l01646"></a>01646                 <span class="keywordflow">if</span> (!bExported)
<a name="l01647"></a>01647                 {
<a name="l01648"></a>01648                     bSuccessReEncrypting = <span class="keyword">false</span>; <span class="comment">// At least this way if there&#39;s a failure, it&#39;s equally to all the Nyms, and not halfway through.</span>
<a name="l01649"></a>01649                 }
<a name="l01650"></a>01650             }
<a name="l01651"></a>01651         } <span class="comment">//FOR_EACH</span>
<a name="l01652"></a>01652         <span class="comment">// ------------------------</span>
<a name="l01653"></a>01653         <span class="keywordflow">if</span> (!bSuccessReEncrypting) <span class="comment">// FAILURE</span>
<a name="l01654"></a>01654         {
<a name="l01655"></a>01655             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to re-encrypt Nym&#39;s private credentials.\n&quot;</span>, __FUNCTION__);
<a name="l01656"></a>01656             <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Nyms are cleaned up automatically when we return.</span>
<a name="l01657"></a>01657         }
<a name="l01658"></a>01658         <span class="comment">// ------------------------</span>
<a name="l01659"></a>01659     }
<a name="l01660"></a>01660     <span class="comment">// By this point, if there were credentials on any of the Nyms, they are all now converted</span>
<a name="l01661"></a>01661     <span class="comment">// (in RAM, not in local storage) to the temp password, and OUT of the wallet&#39;s master key</span>
<a name="l01662"></a>01662     <span class="comment">// (which we&#39;re about to destroy and re-create.)</span>
<a name="l01663"></a>01663     <span class="comment">// ****************************************************************************</span>
<a name="l01664"></a>01664     <span class="comment">// Destroy the wallet&#39;s cached master key (in Ram, not on disk--yet.)</span>
<a name="l01665"></a>01665     <span class="comment">//</span>
<a name="l01666"></a>01666     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascBackup;
<a name="l01667"></a>01667     <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SerializeTo(ascBackup);  <span class="comment">// Just in case!</span>
<a name="l01668"></a>01668     <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;ResetMasterPassword();   <span class="comment">// Which will force it to be re-created next time someone tries to use it...</span>
<a name="l01669"></a>01669 
<a name="l01670"></a>01670     <span class="comment">// NOTE: Below this point we cannot return without setting the master passphrase BACK.</span>
<a name="l01671"></a>01671     <span class="comment">// -----------------------------------------------------</span>
<a name="l01672"></a>01672     <span class="comment">// GENERATE the wallet&#39;s NEW MASTER KEY.</span>
<a name="l01673"></a>01673     <span class="comment">//</span>
<a name="l01674"></a>01674     <a class="code" href="class_o_t_string.html">OTString</a>  strReason(<span class="stringliteral">&quot;Choose a new passphrase: &quot;</span>);
<a name="l01675"></a>01675 
<a name="l01676"></a>01676     <span class="comment">// This step would be unnecessary if we knew for a fact that at least</span>
<a name="l01677"></a>01677     <span class="comment">// one Nym exists. But in the off-chance that there ARE NO NYMS in the</span>
<a name="l01678"></a>01678     <span class="comment">// wallet, we need to have this here, in order to MAKE SURE that the new</span>
<a name="l01679"></a>01679     <span class="comment">// master key is generated. Otherwise it would never end up actually having</span>
<a name="l01680"></a>01680     <span class="comment">// to generate the thing. (Since, if there are no Nyms to re-save, it would</span>
<a name="l01681"></a>01681     <span class="comment">// never need to actually retrieve the master key, which is what triggers it</span>
<a name="l01682"></a>01682     <span class="comment">// to generate if it&#39;s not already there.) So we just force that step here,</span>
<a name="l01683"></a>01683     <span class="comment">// to make sure it happens, even if there are no Nyms to save below this point.</span>
<a name="l01684"></a>01684     <span class="comment">//</span>
<a name="l01685"></a>01685     <a class="code" href="class_o_t_password.html">OTPassword</a> temp_password;
<a name="l01686"></a>01686     _SharedPtr&lt;OTCachedKey&gt; sharedPtr(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>());
<a name="l01687"></a>01687     <span class="keyword">const</span> <span class="keywordtype">bool</span> bRegenerate = sharedPtr-&gt;GetMasterPassword(sharedPtr, temp_password, strReason.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l01688"></a>01688                                                           <span class="keyword">true</span>); <span class="comment">//bVerifyTwice=false by default.</span>
<a name="l01689"></a>01689     <span class="comment">// ----------------------------------------------------</span>
<a name="l01690"></a>01690     <span class="keywordflow">if</span> (!bRegenerate) <span class="comment">// Failure generating new master key.</span>
<a name="l01691"></a>01691     {
<a name="l01692"></a>01692         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed while trying to regenerate master key, in call: &quot;</span>
<a name="l01693"></a>01693                       <span class="stringliteral">&quot;OTCachedKey::It()-&gt;GetMasterPassword. (Setting it back to the old one.)\n&quot;</span>, __FUNCTION__);
<a name="l01694"></a>01694         <span class="comment">// ------------------------</span>
<a name="l01695"></a>01695         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SerializeFrom(ascBackup))
<a name="l01696"></a>01696             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed while trying to restore master key, in call: &quot;</span>
<a name="l01697"></a>01697                           <span class="stringliteral">&quot;OTCachedKey::It()-&gt;GetMasterPassword. (While setting it back to the old one.)\n&quot;</span>
<a name="l01698"></a>01698                           <span class="stringliteral">&quot;Original value: \n%s\n&quot;</span>, __FUNCTION__, ascBackup.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// todo security: is it risky to have the key displayed in this log?</span>
<a name="l01699"></a>01699         <span class="comment">// ------------------------</span>
<a name="l01700"></a>01700         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01701"></a>01701         <span class="comment">//</span>
<a name="l01702"></a>01702         <span class="comment">// NOTE: Since we loaded our own copies of the Nyms, we haven&#39;t changed the copies in the wallet,</span>
<a name="l01703"></a>01703         <span class="comment">// nor the wallet itself. So we can just return, since our copies of the Nyms will already be cleaned</span>
<a name="l01704"></a>01704         <span class="comment">// up automatically.</span>
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706     <span class="comment">// ----------------------------------------------------</span>
<a name="l01707"></a>01707     <span class="keywordflow">else</span><span class="comment">// SUCCESS creating new master key, so let&#39;s CONVERT AND RE-SAVE ALL</span>
<a name="l01708"></a>01708     {   <span class="comment">// THE NYMS, so they&#39;ll be using it from now on...</span>
<a name="l01709"></a>01709 
<a name="l01710"></a>01710         <span class="comment">// (Master key would normally be generated here, if we hadn&#39;t already forced it above,</span>
<a name="l01711"></a>01711         <span class="comment">// but we did that to make sure it got re-created in the event there are zero nyms.)</span>
<a name="l01712"></a>01712 
<a name="l01713"></a>01713         <span class="comment">// Todo: save them to temp files and only copy over if everything</span>
<a name="l01714"></a>01714         <span class="comment">// else is successful. Same with wallet. Also make backups.</span>
<a name="l01715"></a>01715         <span class="comment">//</span>
<a name="l01716"></a>01716         <span class="keywordtype">bool</span> bSuccessResaving = <span class="keyword">true</span>; <span class="comment">// in case the list is empty, we assume success here.</span>
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(std::list&lt;OTPseudonym *&gt;, list_nyms) <span class="comment">// Let&#39;s save all these Nyms under the new master key.</span>
<a name="l01719"></a>01719         {
<a name="l01720"></a>01720             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = *it;
<a name="l01721"></a>01721             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01722"></a>01722             <span class="comment">// ------------------------</span>
<a name="l01723"></a>01723             <span class="keywordtype">bool</span> bSaved = <span class="keyword">false</span>;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725             <span class="comment">// CREDENTIALS</span>
<a name="l01726"></a>01726             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a6ae670b44bc6728da06141c885e6c7e9">GetMasterCredentialCount</a>() &gt; 0) <span class="comment">// Nym has credentials.</span>
<a name="l01727"></a>01727             {
<a name="l01728"></a>01728                 <span class="comment">// We had converted the Nyms to a temp key above, so now we need to convert</span>
<a name="l01729"></a>01729                 <span class="comment">// from the temp key to the new wallet key. Then we can save them and re-load</span>
<a name="l01730"></a>01730                 <span class="comment">// the wallet.</span>
<a name="l01731"></a>01731                 <span class="comment">//</span>
<a name="l01732"></a>01732                 <span class="comment">// We&#39;re supplying the temp password (from above), and importing the Nyms back</span>
<a name="l01733"></a>01733                 <span class="comment">// from that, back into to the wallet&#39;s new master key. So it will only ask</span>
<a name="l01734"></a>01734                 <span class="comment">// for a passphrase for the wallet, since the other passphrase is already provided.</span>
<a name="l01735"></a>01735                 <span class="comment">// Therefore thePWData is relevant to the wallet only.</span>
<a name="l01736"></a>01736                 <span class="comment">//</span>
<a name="l01737"></a>01737                 <span class="keywordtype">bool</span>  bSavedCredentials = <span class="keyword">false</span>;
<a name="l01738"></a>01738                 <span class="keyword">const</span>
<a name="l01739"></a>01739                 <span class="keywordtype">bool</span>  bImported = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adf52e65c9002374a7298f17d97be5b57">ReEncryptPrivateCredentials</a>(<span class="keyword">true</span><span class="comment">/*bImporting*/</span>,  <span class="comment">// &lt;==== CONVERT FROM TEMP PW TO NEW MASTER KEY.</span>
<a name="l01740"></a>01740                                                                     &amp;thePWData, &amp;theTempPassword);
<a name="l01741"></a>01741                 <span class="comment">// --------------------------------------</span>
<a name="l01742"></a>01742                 <span class="keywordflow">if</span> (bImported) <span class="comment">// Success? Okay, let&#39;s Save those credentials we just imported, to local storage.</span>
<a name="l01743"></a>01743                 {
<a name="l01744"></a>01744                     bSavedCredentials = <span class="keyword">true</span>;
<a name="l01745"></a>01745                     <span class="comment">// --------------------------------------</span>
<a name="l01746"></a>01746                     <a class="code" href="class_o_t_string.html">OTString</a>     strNymID, strCredList, strOutput;
<a name="l01747"></a>01747                     <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> mapCredFiles;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a1775c7aedd0dd25b2faf3f78dcccabe7">GetIdentifier</a>(strNymID);
<a name="l01750"></a>01750                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a508533f6ccb558e21bc205d3463a1aa5">GetPrivateCredentials</a>(strCredList, &amp;mapCredFiles);
<a name="l01751"></a>01751                     <span class="comment">// --------------------------------------</span>
<a name="l01752"></a>01752                     <a class="code" href="class_o_t_string.html">OTString</a> strFilename;
<a name="l01753"></a>01753                     strFilename.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s.cred&quot;</span>, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01754"></a>01754                     <span class="comment">// --------------------------------------</span>
<a name="l01755"></a>01755                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascArmor(strCredList);
<a name="l01756"></a>01756                     <span class="keywordflow">if</span> (ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
<a name="l01757"></a>01757                         ascArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput, <span class="stringliteral">&quot;CREDENTIAL LIST&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
<a name="l01758"></a>01758                         strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01759"></a>01759                     {
<a name="l01760"></a>01760                         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_folders.html#a4e94eac1e796da34baf00556042202f0">OTFolders::Credential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l01761"></a>01761                         {
<a name="l01762"></a>01762                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: After converting credentials to new master key, failure trying to store private &quot;</span>
<a name="l01763"></a>01763                                           <span class="stringliteral">&quot;credential list for Nym: %s\n&quot;</span>, __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01764"></a>01764                             bSavedCredentials = <span class="keyword">false</span>;
<a name="l01765"></a>01765                         }
<a name="l01766"></a>01766                     }
<a name="l01767"></a>01767                     <span class="comment">// ----------------------------------------------------</span>
<a name="l01768"></a>01768                     <span class="comment">// Here we do the actual credentials.</span>
<a name="l01769"></a>01769                     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>, mapCredFiles)
<a name="l01770"></a>01770                     {
<a name="l01771"></a>01771                         std::string str_cred_id  = (*it).first;
<a name="l01772"></a>01772                         <a class="code" href="class_o_t_string.html">OTString</a>    strCredential((*it).second);
<a name="l01773"></a>01773                         <span class="comment">// ------------------------</span>
<a name="l01774"></a>01774                         strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l01775"></a>01775                         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascLoopArmor(strCredential);
<a name="l01776"></a>01776                         <span class="keywordflow">if</span> (ascLoopArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
<a name="l01777"></a>01777                             ascLoopArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput, <span class="stringliteral">&quot;CREDENTIAL&quot;</span>) &amp;&amp; <span class="comment">// bEscaped=false by default.</span>
<a name="l01778"></a>01778                             strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01779"></a>01779                         {
<a name="l01780"></a>01780                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a7ec0a905bba2c1c8ba5b1e873e12eab4">OTDB::StorePlainString</a>(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_folders.html#a4e94eac1e796da34baf00556042202f0">OTFolders::Credential</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_cred_id))
<a name="l01781"></a>01781                             {
<a name="l01782"></a>01782                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: After converting credentials to new master key, failure trying to store private &quot;</span>
<a name="l01783"></a>01783                                               <span class="stringliteral">&quot;credential for Nym: %s\n&quot;</span>, __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01784"></a>01784                                 bSavedCredentials = <span class="keyword">false</span>;
<a name="l01785"></a>01785                             }
<a name="l01786"></a>01786                         }
<a name="l01787"></a>01787                         <span class="comment">// -------------------------</span>
<a name="l01788"></a>01788                     } <span class="comment">// FOR_EACH</span>
<a name="l01789"></a>01789                     <span class="comment">// ----------------------------------------------------</span>
<a name="l01790"></a>01790                 }
<a name="l01791"></a>01791                 <span class="comment">// ------------------------------------------</span>
<a name="l01792"></a>01792                 bSaved = bImported &amp;&amp; bSavedCredentials;
<a name="l01793"></a>01793             } <span class="comment">// If Nym has credentials. (Convert and save them, in the above block.)</span>
<a name="l01794"></a>01794             <span class="comment">// ------------------------------------------</span>
<a name="l01795"></a>01795             <span class="keywordflow">else</span> <span class="comment">// Old-school: the old nyms (from before credentials code) merely need to have their cert saved (here), which process will automatically use the current (new) master key to encrypt the private portion of that cert when saving. So it gets converted and saved all in this one call. For new-style Nyms (with credentials) see the above block instead.</span>
<a name="l01796"></a>01796                 <span class="comment">//</span>
<a name="l01797"></a>01797                 bSaved = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a395ce52dec4e07f04fb66521897c9cf2">Savex509CertAndPrivateKey</a>(<span class="keyword">true</span>, &amp;strReason);
<a name="l01798"></a>01798             <span class="comment">// ------------------------------------------</span>
<a name="l01799"></a>01799             <span class="keywordflow">if</span> (!bSaved) bSuccessResaving = <span class="keyword">false</span>;
<a name="l01800"></a>01800         } <span class="comment">// FOR_EACH (list_nyms)</span>
<a name="l01801"></a>01801         <span class="comment">// -----------------------------------------------------</span>
<a name="l01802"></a>01802         <span class="keywordflow">if</span> (!bSuccessResaving) <span class="comment">// Failed saving all the Nyms after switching their credentials over.</span>
<a name="l01803"></a>01803         {
<a name="l01804"></a>01804             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascBackup2;
<a name="l01805"></a>01805             <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SerializeTo(ascBackup2);  <span class="comment">// Just in case!</span>
<a name="l01806"></a>01806             <span class="comment">// ------------------------</span>
<a name="l01807"></a>01807             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: Failed re-saving Nym (into new Master Key.) It&#39;s possible &quot;</span>
<a name="l01808"></a>01808                           <span class="stringliteral">&quot;some Nyms are already saved on the new key, while others are still stuck &quot;</span>
<a name="l01809"></a>01809                           <span class="stringliteral">&quot;on the old key!! Therefore, asserting now. OLD KEY was:\n%s\n\n NEW KEY is: %s\n&quot;</span>,
<a name="l01810"></a>01810                           __FUNCTION__, ascBackup.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), ascBackup2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// Todo: security: keys are exposed here. Is this log safe?</span>
<a name="l01811"></a>01811             <span class="comment">// ------------------------</span>
<a name="l01812"></a>01812             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT while trying to change wallet&#39;s master key and passphrase.\n&quot;</span>);
<a name="l01813"></a>01813         }
<a name="l01814"></a>01814         <span class="comment">// -----------------------------------------------------</span>
<a name="l01815"></a>01815         <span class="keywordflow">else</span><span class="comment">// SAVE THE WALLET.</span>
<a name="l01816"></a>01816         {
<a name="l01817"></a>01817             <span class="comment">// By this point, we have successfully converted all the Nyms (our local copies of the wallet&#39;s private nyms)</span>
<a name="l01818"></a>01818             <span class="comment">// to the new master key, AND we have successfully saved those Nyms to local storage. Now, if we just save and</span>
<a name="l01819"></a>01819             <span class="comment">// re-load the wallet itself, it should load up using the new master key, and it should load up its own copies</span>
<a name="l01820"></a>01820             <span class="comment">// of those same Nyms again, using that new master key to decrypt them. (Those new copies of those Nyms being</span>
<a name="l01821"></a>01821             <span class="comment">// the ones that we saved to local storage just above, using our local copies.)</span>
<a name="l01822"></a>01822             <span class="comment">//</span>
<a name="l01823"></a>01823             <span class="comment">// With the wallet updated thus, we can simply discard the local copies, which will have outlived their usefulness.</span>
<a name="l01824"></a>01824             <span class="comment">// They will already be destroyed on exit, automatically.</span>
<a name="l01825"></a>01825             <span class="comment">//</span>
<a name="l01826"></a>01826             <span class="keywordtype">bool</span>  bLoaded = <span class="keyword">false</span>;
<a name="l01827"></a>01827             <span class="keyword">const</span>
<a name="l01828"></a>01828             <span class="keywordtype">bool</span>  bSaved  = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l01829"></a>01829             <span class="comment">// ------------------------</span>
<a name="l01830"></a>01830             <span class="keywordflow">if</span> (bSaved) <span class="comment">// Next, re-load it so the Nyms we&#39;ve changed will be loaded up in their new forms. (The nyms local to this function will be destroyed on exit, but they are separate from the nyms in the wallet, which will appear in their new forms upon loading, presuming the Nyms were successfully saved above.)</span>
<a name="l01831"></a>01831                 <span class="comment">//</span>
<a name="l01832"></a>01832                 bLoaded = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a2932e7c8d6b5d7764707e653a3c2f216">LoadWallet</a>();
<a name="l01833"></a>01833             <span class="keywordflow">else</span>
<a name="l01834"></a>01834                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed saving wallet \n&quot;</span>, __FUNCTION__);
<a name="l01835"></a>01835             <span class="comment">// ------------------------</span>
<a name="l01836"></a>01836             <span class="keywordflow">if</span> (!bLoaded)
<a name="l01837"></a>01837             {
<a name="l01838"></a>01838                 <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascBackup2;
<a name="l01839"></a>01839                 <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;SerializeTo(ascBackup2);  <span class="comment">// Just in case!</span>
<a name="l01840"></a>01840                 <span class="comment">// ------------------------</span>
<a name="l01841"></a>01841                 <span class="comment">// Note: if we even got this far, that means we already saved the Nyms under the new master Key,</span>
<a name="l01842"></a>01842                 <span class="comment">// to local storage. Therefore we NEED that new key, if it wasn&#39;t properly saved in the wallet file</span>
<a name="l01843"></a>01843                 <span class="comment">// just now! (And we need to have made a real backup of the wallet before attempting this...todo.)</span>
<a name="l01844"></a>01844                 <span class="comment">// In the meantime, the best thing we can do is just LOG that key here, and hope the server operator</span>
<a name="l01845"></a>01845                 <span class="comment">// still has the log! Log both keys (new and old.)</span>
<a name="l01846"></a>01846                 <span class="comment">// ------------------------</span>
<a name="l01847"></a>01847                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: Failed saving or re-loading Wallet (with new Master Key.) &quot;</span>
<a name="l01848"></a>01848                               <span class="stringliteral">&quot;Asserting now. OLD KEY was:\n%s\n\n NEW KEY is: %s\n&quot;</span>,
<a name="l01849"></a>01849                               __FUNCTION__, ascBackup.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), ascBackup2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// Todo: security: keys are exposed here. Is this log safe?</span>
<a name="l01850"></a>01850                 <span class="comment">// ------------------------</span>
<a name="l01851"></a>01851                 <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;ASSERT while trying to save and re-load wallet with new master key and passphrase.\n&quot;</span>);
<a name="l01852"></a>01852             }
<a name="l01853"></a>01853             <span class="keywordflow">else</span>
<a name="l01854"></a>01854                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\nSuccess changing master passphrase for wallet!\n&quot;</span>);
<a name="l01855"></a>01855             <span class="comment">// ------------------------</span>
<a name="l01856"></a>01856             <span class="keywordflow">return</span> bLoaded;
<a name="l01857"></a>01857         }
<a name="l01858"></a>01858         <span class="comment">// -----------------------------------------------------</span>
<a name="l01859"></a>01859     }
<a name="l01860"></a>01860 }
<a name="l01861"></a>01861 
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 
<a name="l01864"></a><a class="code" href="class_o_t___a_p_i.html#ae78c8768a982b6c2fd700f07e2cd6f79">01864</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ae78c8768a982b6c2fd700f07e2cd6f79">OT_API::Wallet_CanRemoveServer</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID)
<a name="l01865"></a>01865 {
<a name="l01866"></a>01866     <span class="comment">// -----------------------------------------------------</span>
<a name="l01867"></a>01867     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l01868"></a>01868     <span class="comment">// -----------------------------------------------------</span>
<a name="l01869"></a>01869     <span class="keywordflow">if</span> (!bInitialized)          { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__);    <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01870"></a>01870     <span class="keywordflow">if</span> (SERVER_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>())    { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;SERVER_ID&quot;</span>          ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01871"></a>01871     <span class="comment">// -----------------------------------------------------</span>
<a name="l01872"></a>01872     <a class="code" href="class_o_t_string.html">OTString</a> strName;
<a name="l01873"></a>01873     <span class="comment">// ------------------------------------------</span>
<a name="l01874"></a>01874     <span class="keyword">const</span> int32_t nCount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a318b1ae501a4ad2b99ce8ff036546e5e">GetAccountCount</a>();
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="comment">// Loop through all the accounts.</span>
<a name="l01877"></a>01877     <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nCount; i++)
<a name="l01878"></a>01878     {
<a name="l01879"></a>01879         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> accountID;
<a name="l01880"></a>01880 
<a name="l01881"></a>01881         <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(i,accountID,strName);
<a name="l01882"></a>01882         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(accountID,__FUNCTION__);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> purportedServerID(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         <span class="keywordflow">if</span> (SERVER_ID == purportedServerID) {
<a name="l01887"></a>01887             <a class="code" href="class_o_t_string.html">OTString</a> strPurportedServerID(purportedServerID), strSERVER_ID(SERVER_ID);
<a name="l01888"></a>01888             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to remove server contract %s from wallet, because Account %s uses it.\n&quot;</span>,
<a name="l01889"></a>01889                 __FUNCTION__, strSERVER_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strPurportedServerID.Get());
<a name="l01890"></a>01890             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01891"></a>01891         }
<a name="l01892"></a>01892     }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894     <span class="comment">// ------------------------------------------</span>
<a name="l01895"></a>01895     <span class="keyword">const</span> int32_t nNymCount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a267d362ca74da9e01ab8e956da42b386">GetNymCount</a>();
<a name="l01896"></a>01896 
<a name="l01897"></a>01897     <span class="comment">// Loop through all the Nyms. (One might be registered on that server.)</span>
<a name="l01898"></a>01898     <span class="comment">//</span>
<a name="l01899"></a>01899     <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nNymCount; i++)
<a name="l01900"></a>01900     {
<a name="l01901"></a>01901         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> nymID;
<a name="l01902"></a>01902         <span class="keywordtype">bool</span> bGetNym = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(i, nymID, strName);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904         <span class="keywordflow">if</span>(bGetNym)
<a name="l01905"></a>01905         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a1124d87febc45eec06c1c9e8a2cc91da">IsNym_RegisteredAtServer</a>(nymID, SERVER_ID))
<a name="l01906"></a>01906         {
<a name="l01907"></a>01907             <a class="code" href="class_o_t_string.html">OTString</a> strNymID(nymID), strSERVER_ID(SERVER_ID);
<a name="l01908"></a>01908             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to remove server contract %s from wallet, because Nym %s is registered there. (Delete that first...)\n&quot;</span>,
<a name="l01909"></a>01909                 __FUNCTION__, strSERVER_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID.Get());
<a name="l01910"></a>01910             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01911"></a>01911         }
<a name="l01912"></a>01912    }
<a name="l01913"></a>01913     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01914"></a>01914 }
<a name="l01915"></a>01915 <span class="comment">// -----------------------------------------------------</span>
<a name="l01916"></a>01916 
<a name="l01917"></a>01917 <span class="comment">// Can I remove this asset contract from my wallet?</span>
<a name="l01918"></a>01918 <span class="comment">//</span>
<a name="l01919"></a>01919 <span class="comment">// You cannot remove the asset contract from your wallet if there are accounts in there using it.</span>
<a name="l01920"></a>01920 <span class="comment">// This function tells you whether you can remove the asset contract or not.(Whether there are accounts...)</span>
<a name="l01921"></a>01921 <span class="comment">//</span>
<a name="l01922"></a><a class="code" href="class_o_t___a_p_i.html#a1ca73000987bce8e5e326a43ca46cd69">01922</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a1ca73000987bce8e5e326a43ca46cd69">OT_API::Wallet_CanRemoveAssetType</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l01923"></a>01923 {
<a name="l01924"></a>01924     <span class="comment">// -----------------------------------------------------</span>
<a name="l01925"></a>01925     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l01926"></a>01926     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01927"></a>01927 
<a name="l01928"></a>01928     <span class="keywordflow">if</span> (ASSET_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;ASSET_ID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01929"></a>01929     <span class="comment">// -----------------------------------------------------</span>
<a name="l01930"></a>01930     <a class="code" href="class_o_t_string.html">OTString</a> strName;
<a name="l01931"></a>01931     <span class="comment">// ------------------------------------------</span>
<a name="l01932"></a>01932     <span class="keyword">const</span> int32_t nCount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a318b1ae501a4ad2b99ce8ff036546e5e">GetAccountCount</a>();
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     <span class="comment">// Loop through all the accounts.</span>
<a name="l01935"></a>01935     <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nCount; i++)
<a name="l01936"></a>01936     {
<a name="l01937"></a>01937         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> accountID;
<a name="l01938"></a>01938 
<a name="l01939"></a>01939         <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(i,accountID,strName);
<a name="l01940"></a>01940         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(accountID,__FUNCTION__);
<a name="l01941"></a>01941         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theTYPE_ID(pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
<a name="l01942"></a>01942 
<a name="l01943"></a>01943         <span class="keywordflow">if</span> (ASSET_ID == theTYPE_ID)
<a name="l01944"></a>01944         {
<a name="l01945"></a>01945             <a class="code" href="class_o_t_string.html">OTString</a> strASSET_ID(ASSET_ID), strTYPE_ID(theTYPE_ID);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to remove asset contract %s from wallet: Account %s uses it.\n&quot;</span>,
<a name="l01948"></a>01948                 __FUNCTION__,strASSET_ID.Get(), strTYPE_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01949"></a>01949             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01950"></a>01950         }
<a name="l01951"></a>01951     }
<a name="l01952"></a>01952     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01953"></a>01953 }
<a name="l01954"></a>01954 
<a name="l01955"></a>01955 <span class="comment">// -----------------------------------------------------</span>
<a name="l01956"></a>01956 <span class="comment">// Can I remove this Nym from my wallet?</span>
<a name="l01957"></a>01957 <span class="comment">//</span>
<a name="l01958"></a>01958 <span class="comment">// You cannot remove the Nym from your wallet if there are accounts in there using it.</span>
<a name="l01959"></a>01959 <span class="comment">// This function tells you whether you can remove the Nym or not. (Whether there are accounts...)</span>
<a name="l01960"></a>01960 <span class="comment">// It also checks to see if the Nym in question is registered at any servers.</span>
<a name="l01961"></a>01961 <span class="comment">//</span>
<a name="l01962"></a>01962 <span class="comment">// returns OT_BOOL</span>
<a name="l01963"></a>01963 <span class="comment">//</span>
<a name="l01964"></a><a class="code" href="class_o_t___a_p_i.html#a2f3e914453a7b7ad2a03b6a39f3f0fce">01964</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a2f3e914453a7b7ad2a03b6a39f3f0fce">OT_API::Wallet_CanRemoveNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID)
<a name="l01965"></a>01965 {
<a name="l01966"></a>01966     <span class="comment">// -----------------------------------------------------</span>
<a name="l01967"></a>01967     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l01968"></a>01968     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;NYM_ID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l01971"></a>01971     <span class="comment">// -----------------------------------------------------</span>
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <span class="comment">// -----------------------------------------------------</span>
<a name="l01975"></a>01975     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(NYM_ID,__FUNCTION__);
<a name="l01976"></a>01976     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01977"></a>01977     <span class="comment">// ------------------------------------------</span>
<a name="l01978"></a>01978     <span class="comment">// Make sure the Nym doesn&#39;t have any accounts in the wallet.</span>
<a name="l01979"></a>01979     <span class="comment">// (Client must close those before calling this.)</span>
<a name="l01980"></a>01980     <span class="comment">//</span>
<a name="l01981"></a>01981     <span class="keyword">const</span> int32_t nCount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a318b1ae501a4ad2b99ce8ff036546e5e">GetAccountCount</a>();
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <span class="comment">// Loop through all the accounts.</span>
<a name="l01984"></a>01984     <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nCount; i++)
<a name="l01985"></a>01985     {
<a name="l01986"></a>01986         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> accountID;
<a name="l01987"></a>01987         <a class="code" href="class_o_t_string.html">OTString</a> strName;
<a name="l01988"></a>01988 
<a name="l01989"></a>01989         <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(i,accountID,strName);
<a name="l01990"></a>01990         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(accountID,__FUNCTION__);
<a name="l01991"></a>01991         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNYM_ID(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>());
<a name="l01992"></a>01992 
<a name="l01993"></a>01993 
<a name="l01994"></a>01994         <span class="keywordflow">if</span> (theNYM_ID.IsEmpty())
<a name="l01995"></a>01995         {
<a name="l01996"></a>01996             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Bug in OT_API_Wallet_CanRemoveNym / OT_API_GetAccountWallet_NymID\n&quot;</span>, __FUNCTION__);
<a name="l01997"></a>01997             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01998"></a>01998         }
<a name="l01999"></a>01999 
<a name="l02000"></a>02000 
<a name="l02001"></a>02001         <span class="comment">// Looks like the Nym still has some accounts in this wallet.</span>
<a name="l02002"></a>02002         <span class="keywordflow">if</span> (NYM_ID == theNYM_ID)
<a name="l02003"></a>02003         {
<a name="l02004"></a>02004             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Nym cannot be removed because there are still accounts in the wallet for that Nym.\n&quot;</span>, __FUNCTION__);
<a name="l02005"></a>02005             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02006"></a>02006         }
<a name="l02007"></a>02007     }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009     <span class="comment">// ------------------------------------------</span>
<a name="l02010"></a>02010     <span class="comment">// Make sure the Nym isn&#39;t registered at any servers...</span>
<a name="l02011"></a>02011     <span class="comment">// (Client must unregister at those servers before calling this function..)</span>
<a name="l02012"></a>02012     <span class="comment">//</span>
<a name="l02013"></a>02013     <span class="keyword">const</span> int32_t nServerCount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a0fad5fe7f5da3cac88b0794c705b1a9b">GetServerCount</a>();
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="keywordflow">for</span> (int32_t i = 0; i &lt; nServerCount; i++)
<a name="l02016"></a>02016     {
<a name="l02017"></a>02017     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    theID;
<a name="l02018"></a>02018     <a class="code" href="class_o_t_string.html">OTString</a>        strName;
<a name="l02019"></a>02019     <span class="keywordtype">bool</span> bGetServer = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(i, theID, strName);
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     <span class="keywordflow">if</span> (bGetServer)
<a name="l02022"></a>02022     <span class="keywordflow">if</span> (!theID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>())
<a name="l02023"></a>02023         {
<a name="l02024"></a>02024             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(theID);
<a name="l02025"></a>02025 
<a name="l02026"></a>02026             <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#af5e9078ab475e6cd9c53e4ad2fae0417">IsRegisteredAtServer</a>(strServerID))
<a name="l02027"></a>02027             {
<a name="l02028"></a>02028                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Nym cannot be removed because there are still servers in the wallet that the Nym is registered at.\n&quot;</span>, __FUNCTION__);
<a name="l02029"></a>02029                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02030"></a>02030             }
<a name="l02031"></a>02031         }
<a name="l02032"></a>02032     }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034     <span class="comment">// ------------------------------------------</span>
<a name="l02035"></a>02035 
<a name="l02036"></a>02036     <span class="comment">// TODO:  Make sure Nym doesn&#39;t have any cash in any purses...</span>
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 
<a name="l02041"></a>02041 <span class="comment">// -----------------------------------------------------</span>
<a name="l02042"></a>02042 <span class="comment">// Can I remove this Account from my wallet?</span>
<a name="l02043"></a>02043 <span class="comment">//</span>
<a name="l02044"></a>02044 <span class="comment">// You cannot remove the Account from your wallet if there are transactions still open.</span>
<a name="l02045"></a>02045 <span class="comment">// This function tells you whether you can remove the Account or not. (Whether there are transactions...)</span>
<a name="l02046"></a>02046 <span class="comment">// Also, balance must be zero to do this.</span>
<a name="l02047"></a>02047 <span class="comment">//</span>
<a name="l02048"></a>02048 <span class="comment">// returns OT_BOOL</span>
<a name="l02049"></a>02049 <span class="comment">//</span>
<a name="l02050"></a><a class="code" href="class_o_t___a_p_i.html#a5b14775126eb326cfd49ffb1a7d4db32">02050</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a5b14775126eb326cfd49ffb1a7d4db32">OT_API::Wallet_CanRemoveAccount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l02051"></a>02051 {
<a name="l02052"></a>02052     <span class="comment">// -----------------------------------------------------</span>
<a name="l02053"></a>02053     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l02054"></a>02054     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056     <span class="keywordflow">if</span> (ACCOUNT_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;ACCOUNT_ID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02057"></a>02057     <span class="comment">// -----------------------------------------------------</span>
<a name="l02058"></a>02058 
<a name="l02059"></a>02059     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l02060"></a>02060     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAccountID(ACCOUNT_ID);
<a name="l02061"></a>02061 
<a name="l02062"></a>02062     <span class="comment">// -----------------------------------------------------</span>
<a name="l02063"></a>02063     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(ACCOUNT_ID, __FUNCTION__);
<a name="l02064"></a>02064     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02065"></a>02065     <span class="comment">// -----------------------------------------------------</span>
<a name="l02066"></a>02066     <span class="comment">// Balance must be zero in order to close an account!</span>
<a name="l02067"></a>02067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() != 0)
<a name="l02068"></a>02068     {
<a name="l02069"></a>02069         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Account balance MUST be zero in order to close an asset account: %s.\n&quot;</span>, __FUNCTION__, strAccountID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02070"></a>02070         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02071"></a>02071     }
<a name="l02072"></a>02072     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l02073"></a>02073     <span class="keywordtype">bool</span> BOOL_RETURN_VALUE = <span class="keyword">false</span>;
<a name="l02074"></a>02074 
<a name="l02075"></a>02075     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID    = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>();
<a name="l02076"></a>02076     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theUserID      = pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>();
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     <span class="comment">// There is an OT_ASSERT in here for memory failure,</span>
<a name="l02079"></a>02079     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l02080"></a>02080     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#a478f3f32e383e05a203807810bc94940">LoadInbox</a>(theServerID, theUserID, ACCOUNT_ID);
<a name="l02081"></a>02081     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = <a class="code" href="class_o_t_a_p_i___wrap.html#a8867c48885173f01d0f9f08aa83d3587">OTAPI_Wrap::OTAPI</a>()-&gt;<a class="code" href="class_o_t___a_p_i.html#aeaf758c15cb39763d3ac80e7582e5409">LoadOutbox</a>(theServerID, theUserID, ACCOUNT_ID);
<a name="l02082"></a>02082 
<a name="l02083"></a>02083     <span class="comment">// Make sure it gets cleaned up pInbox this goes out of scope.</span>
<a name="l02084"></a>02084     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox); <span class="comment">// I pass the pointer, in case it&#39;s NULL.</span>
<a name="l02085"></a>02085     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox); <span class="comment">// I pass the pointer, in case it&#39;s NULL.</span>
<a name="l02086"></a>02086 
<a name="l02087"></a>02087     <span class="keywordflow">if</span> (NULL == pInbox){
<a name="l02088"></a>02088         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure calling OT_API::LoadInbox.\n Account ID: %s\n&quot;</span>, __FUNCTION__, strAccountID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02089"></a>02089     }
<a name="l02090"></a>02090     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox) {
<a name="l02091"></a>02091         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure calling OT_API::LoadOutbox.\n Account ID: %s\n&quot;</span>,__FUNCTION__ , strAccountID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02092"></a>02092     }
<a name="l02093"></a>02093     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (pInbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &gt; 0) || (pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>() &gt; 0) ) {
<a name="l02094"></a>02094         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: You cannot remove an asset account if there are inbox/outbox items still waiting to be processed.\n&quot;</span>, __FUNCTION__);
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096     <span class="keywordflow">else</span> BOOL_RETURN_VALUE = <span class="keyword">true</span>; <span class="comment">// SUCCESS!</span>
<a name="l02097"></a>02097 
<a name="l02098"></a>02098     <span class="keywordflow">return</span> BOOL_RETURN_VALUE;
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 <span class="comment">// -----------------------------------------------------</span>
<a name="l02103"></a>02103 
<a name="l02104"></a>02104 <span class="comment">// Remove this server contract from my wallet!</span>
<a name="l02105"></a>02105 <span class="comment">//</span>
<a name="l02106"></a>02106 <span class="comment">// Try to remove the server contract from the wallet.</span>
<a name="l02107"></a>02107 <span class="comment">// This will not work if there are any accounts in the wallet for the same server ID.</span>
<a name="l02108"></a>02108 <span class="comment">//</span>
<a name="l02109"></a><a class="code" href="class_o_t___a_p_i.html#af2aefbb08ad7e13fe40400ab1366b6b0">02109</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#af2aefbb08ad7e13fe40400ab1366b6b0">OT_API::Wallet_RemoveServer</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID)
<a name="l02110"></a>02110 {
<a name="l02111"></a>02111     <span class="comment">// -----------------------------------------------------</span>
<a name="l02112"></a>02112     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l02113"></a>02113     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02114"></a>02114 
<a name="l02115"></a>02115     <span class="keywordflow">if</span> (SERVER_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>())            { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;ASSET_ID&quot;</span>           ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02116"></a>02116     <span class="comment">// -----------------------------------------------------</span>
<a name="l02117"></a>02117 
<a name="l02118"></a>02118     <span class="comment">// Make sure there aren&#39;t any dependent accounts..</span>
<a name="l02119"></a>02119     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t___a_p_i.html#ae78c8768a982b6c2fd700f07e2cd6f79">Wallet_CanRemoveServer</a>(SERVER_ID)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02120"></a>02120 
<a name="l02121"></a>02121     <span class="comment">// TODO: the above call proves that there are no accounts laying around</span>
<a name="l02122"></a>02122     <span class="comment">// for this server ID. (No need to worry about &quot;orphaned accounts.&quot;)</span>
<a name="l02123"></a>02123     <span class="comment">//</span>
<a name="l02124"></a>02124     <span class="comment">// However, there may still be Nyms registered at the server! Therefore,</span>
<a name="l02125"></a>02125     <span class="comment">// we need to loop through the Nyms, and make sure none of them has been</span>
<a name="l02126"></a>02126     <span class="comment">// registered at this server ID. If it has, then we need to message the server</span>
<a name="l02127"></a>02127     <span class="comment">// to &quot;deregister&quot; the Nym, which is much cleaner.  Otherwise server&#39;s only</span>
<a name="l02128"></a>02128     <span class="comment">// other alternative is to expire Nyms that have gone unused for some specific</span>
<a name="l02129"></a>02129     <span class="comment">// period of time, presumably those terms are described in the server contract.</span>
<a name="l02130"></a>02130     <span class="comment">//</span>
<a name="l02131"></a>02131     <span class="comment">// -----------------------------------------------------</span>
<a name="l02132"></a>02132 
<a name="l02133"></a>02133     <span class="keywordflow">if</span> (NULL == <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>) {
<a name="l02134"></a>02134         <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s:  No wallet found...\n&quot;</span>,__FUNCTION__);
<a name="l02135"></a>02135         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l02136"></a>02136     }
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <span class="keywordflow">if</span> (<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#ab739c1b18f6dcc6958cfd1ac53f728d8">RemoveServerContract</a>(SERVER_ID))
<a name="l02139"></a>02139     {
<a name="l02140"></a>02140         <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();
<a name="l02141"></a>02141         <a class="code" href="class_o_t_log.html#a607ac911c2ab1fa483168f16dd0e7355">OTLog::sOutput</a>(0, <span class="stringliteral">&quot;%s: Removed server contract from the wallet: %s\n&quot;</span>, __FUNCTION__, SERVER_ID);
<a name="l02142"></a>02142         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02143"></a>02143     }
<a name="l02144"></a>02144     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02145"></a>02145 }
<a name="l02146"></a>02146 
<a name="l02147"></a>02147 <span class="comment">// -----------------------------------------------------</span>
<a name="l02148"></a>02148 
<a name="l02149"></a>02149 <span class="comment">// Remove this asset contract from my wallet!</span>
<a name="l02150"></a>02150 <span class="comment">//</span>
<a name="l02151"></a>02151 <span class="comment">// Try to remove the asset contract from the wallet.</span>
<a name="l02152"></a>02152 <span class="comment">// This will not work if there are any accounts in the wallet for the same asset type ID.</span>
<a name="l02153"></a>02153 <span class="comment">//</span>
<a name="l02154"></a><a class="code" href="class_o_t___a_p_i.html#abfa83caebd9bb2bd22377f7b5f630055">02154</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#abfa83caebd9bb2bd22377f7b5f630055">OT_API::Wallet_RemoveAssetType</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l02155"></a>02155 {
<a name="l02156"></a>02156     <span class="comment">// -----------------------------------------------------</span>
<a name="l02157"></a>02157     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l02158"></a>02158     <span class="keywordflow">if</span> (!bInitialized) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02159"></a>02159 
<a name="l02160"></a>02160     <span class="keywordflow">if</span> (ASSET_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;ASSET_ID&quot;</span> ); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02161"></a>02161     <span class="comment">// -----------------------------------------------------</span>
<a name="l02162"></a>02162 
<a name="l02163"></a>02163     <span class="comment">// Make sure there aren&#39;t any dependent accounts..</span>
<a name="l02164"></a>02164     <span class="keywordflow">if</span> (!<a class="code" href="class_o_t___a_p_i.html#a1ca73000987bce8e5e326a43ca46cd69">Wallet_CanRemoveAssetType</a>(ASSET_ID)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02165"></a>02165 
<a name="l02166"></a>02166 
<a name="l02167"></a>02167     <span class="keywordflow">if</span> (NULL == <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>) {
<a name="l02168"></a>02168         <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: No wallet found...!\n&quot;</span>,__FUNCTION__);
<a name="l02169"></a>02169         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l02170"></a>02170     }
<a name="l02171"></a>02171 
<a name="l02172"></a>02172     <span class="keywordflow">if</span> (<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a> -&gt; RemoveAssetContract(ASSET_ID))
<a name="l02173"></a>02173     {
<a name="l02174"></a>02174         <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a> -&gt; SaveWallet();
<a name="l02175"></a>02175         <a class="code" href="class_o_t_log.html#a607ac911c2ab1fa483168f16dd0e7355">OTLog::sOutput</a>(0, <span class="stringliteral">&quot;%s: Removed asset contract from the wallet: %s\n&quot;</span>,__FUNCTION__, ASSET_ID);
<a name="l02176"></a>02176         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02177"></a>02177     }
<a name="l02178"></a>02178     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02179"></a>02179 }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181 <span class="comment">// -----------------------------------------------------</span>
<a name="l02182"></a>02182 
<a name="l02183"></a>02183 <span class="comment">// Remove this Nym from my wallet!</span>
<a name="l02184"></a>02184 <span class="comment">//</span>
<a name="l02185"></a>02185 <span class="comment">// Try to remove the Nym from the wallet.</span>
<a name="l02186"></a>02186 <span class="comment">// This will not work if there are any nyms in the wallet for the same server ID.</span>
<a name="l02187"></a>02187 <span class="comment">//</span>
<a name="l02188"></a><a class="code" href="class_o_t___a_p_i.html#aed300d9ad2ef3d1e76d423c1e91659c5">02188</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aed300d9ad2ef3d1e76d423c1e91659c5">OT_API::Wallet_RemoveNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID)
<a name="l02189"></a>02189 {
<a name="l02190"></a>02190     <span class="comment">// -----------------------------------------------------</span>
<a name="l02191"></a>02191     <span class="keywordtype">bool</span> bInitialized = <a class="code" href="class_o_t___a_p_i.html#af11b60d083c4a8e1e68a59a0824899d4">IsInitialized</a>();
<a name="l02192"></a>02192     <span class="keywordflow">if</span> (!bInitialized)    { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Not initialized; call OT_API::Init first.\n&quot;</span>,__FUNCTION__);  <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Null: %s passed in!\n&quot;</span>, __FUNCTION__, <span class="stringliteral">&quot;ACCOUNT_ID&quot;</span>); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02195"></a>02195     <span class="comment">// -----------------------------------------------------</span>
<a name="l02196"></a>02196 
<a name="l02197"></a>02197 
<a name="l02198"></a>02198     <span class="comment">// DONE: The below call proves already that there are no accounts laying around</span>
<a name="l02199"></a>02199     <span class="comment">// for this Nym. (No need to worry about &quot;orphaned accounts.&quot;)</span>
<a name="l02200"></a>02200     <span class="comment">//</span>
<a name="l02201"></a>02201     <span class="comment">// DONE (finally):</span>
<a name="l02202"></a>02202     <span class="comment">// However, the Nym might still be registered at various servers, even without asset accounts.</span>
<a name="l02203"></a>02203     <span class="comment">// Therefore, we need to iterate through the server contracts, and if the Nym is registered at</span>
<a name="l02204"></a>02204     <span class="comment">// any of the servers, then &quot;deregister&quot; (before deleting the Nym entirely.) This is much</span>
<a name="l02205"></a>02205     <span class="comment">// cleaner for the server side, who otherwise has to expired unused nyms based on some rule</span>
<a name="l02206"></a>02206     <span class="comment">// presumably to be found in the server contract.</span>
<a name="l02207"></a>02207     <span class="comment">// ------------------------------------------</span>
<a name="l02208"></a>02208     <span class="keywordflow">if</span> (! <a class="code" href="class_o_t___a_p_i.html#a2f3e914453a7b7ad2a03b6a39f3f0fce">Wallet_CanRemoveNym</a>(NYM_ID)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (NULL == <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>)
<a name="l02211"></a>02211     {
<a name="l02212"></a>02212         <a class="code" href="class_o_t_log.html#a8c12a31fb887aa7a3023879a2ff86173">OTLog::sError</a>(<span class="stringliteral">&quot;%s: No wallet found...!\n&quot;</span>,__FUNCTION__);
<a name="l02213"></a>02213         <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l02214"></a>02214     }
<a name="l02215"></a>02215 
<a name="l02216"></a>02216     <span class="keywordflow">if</span> (<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#a7dd1cf4ba4922eacc2c3c81d21dd07dc">RemoveNym</a>(NYM_ID))
<a name="l02217"></a>02217     {
<a name="l02218"></a>02218         <a class="code" href="class_o_t_log.html#a607ac911c2ab1fa483168f16dd0e7355">OTLog::sOutput</a>(0, <span class="stringliteral">&quot;%s: Success erasing Nym from wallet: %s\n&quot;</span>, __FUNCTION__, NYM_ID);
<a name="l02219"></a>02219         <a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a> -&gt; SaveWallet();
<a name="l02220"></a>02220         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02221"></a>02221     }
<a name="l02222"></a>02222     <span class="keywordflow">else</span>
<a name="l02223"></a>02223         <a class="code" href="class_o_t_log.html#a607ac911c2ab1fa483168f16dd0e7355">OTLog::sOutput</a>(0, <span class="stringliteral">&quot;%s: Failure erasing Nym from wallet: %s\n&quot;</span>, __FUNCTION__, NYM_ID);
<a name="l02224"></a>02224 
<a name="l02225"></a>02225     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02226"></a>02226 }
<a name="l02227"></a>02227 
<a name="l02228"></a>02228 <span class="comment">// --------------------------------------------</span>
<a name="l02229"></a>02229 
<a name="l02230"></a>02230 <span class="comment">// OT has the capability to export a Nym (normally stored in several files) as an encoded</span>
<a name="l02231"></a>02231 <span class="comment">// object (in base64-encoded form) and then import it again.</span>
<a name="l02232"></a>02232 <span class="comment">//</span>
<a name="l02233"></a>02233 <span class="comment">// Returns bool on success, and strOutput will contain the exported data.</span>
<a name="l02234"></a>02234 <span class="comment">//</span>
<a name="l02235"></a><a class="code" href="class_o_t___a_p_i.html#abe3cee60ee8f3d8e3660067d481b2dcc">02235</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#abe3cee60ee8f3d8e3660067d481b2dcc">OT_API::Wallet_ExportNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l02236"></a>02236 {
<a name="l02237"></a>02237     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02238"></a>02238     <span class="comment">// -----------------------------------------------------</span>
<a name="l02239"></a>02239     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataLoad(<span class="stringliteral">&quot;Enter wallet master passphrase.&quot;</span>);
<a name="l02240"></a>02240     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataSave(<span class="stringliteral">&quot;Create new passphrase for exported Nym.&quot;</span>);
<a name="l02241"></a>02241     <a class="code" href="class_o_t_string.html">OTString</a> strReasonToSave(thePWDataSave.<a class="code" href="class_o_t_password_data.html#afe04404b46712a5918790c3b4af7dda2">GetDisplayString</a>());
<a name="l02242"></a>02242     <span class="comment">// -----------------------------------------------------</span>
<a name="l02243"></a>02243     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, __FUNCTION__, &amp;thePWDataLoad); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02245"></a>02245     <span class="comment">// -----------------------------------------------------</span>
<a name="l02246"></a>02246     std::string  str_nym_name(pNym-&gt;GetNymName().Get());
<a name="l02247"></a>02247     <span class="comment">// -----------------------------------------------------</span>
<a name="l02248"></a>02248     <a class="code" href="class_o_t_string.html">OTString</a> strID; pNym-&gt;GetIdentifier(strID);
<a name="l02249"></a>02249     std::string  str_nym_id(strID.Get());
<a name="l02250"></a>02250     <span class="comment">// -----------------------------------------------------</span>
<a name="l02251"></a>02251     <span class="comment">// Below this point I can use:</span>
<a name="l02252"></a>02252     <span class="comment">//</span>
<a name="l02253"></a>02253     <span class="comment">// pNym, str_nym_name, and str_nym_id.</span>
<a name="l02254"></a>02254     <span class="comment">//</span>
<a name="l02255"></a>02255     <span class="comment">// I still need the certfile and the nymfile (both in string form.)</span>
<a name="l02256"></a>02256     <span class="comment">// -----------------------------------------------------</span>
<a name="l02257"></a>02257     <span class="comment">//</span>
<a name="l02258"></a>02258     <span class="keyword">const</span> <span class="keywordtype">bool</span> bHasCredentials = (pNym-&gt;GetMasterCredentialCount() &gt; 0);
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCredentials, ascCredList;
<a name="l02261"></a>02261     <a class="code" href="class_o_t_string.html">OTString</a>     strCertfile;
<a name="l02262"></a>02262     <span class="keywordtype">bool</span>         bSavedCert = <span class="keyword">false</span>;
<a name="l02263"></a>02263     <span class="comment">// -----------------------------------------------------</span>
<a name="l02264"></a>02264     <span class="keywordflow">if</span> (!bHasCredentials)
<a name="l02265"></a>02265     {
<a name="l02266"></a>02266         <span class="comment">// *****************************************************************</span>
<a name="l02267"></a>02267         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
<a name="l02268"></a>02268         {
<a name="l02269"></a>02269             <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Pause();
<a name="l02270"></a>02270         }
<a name="l02271"></a>02271         <span class="comment">// -----------------------------------</span>
<a name="l02272"></a>02272         bSavedCert = pNym-&gt;Savex509CertAndPrivateKeyToString(strCertfile, &amp;strReasonToSave);
<a name="l02273"></a>02273         <span class="comment">// -----------------------------------</span>
<a name="l02274"></a>02274         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
<a name="l02275"></a>02275         {
<a name="l02276"></a>02276             <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Unpause();
<a name="l02277"></a>02277         }
<a name="l02278"></a>02278         <span class="comment">// *****************************************************************</span>
<a name="l02279"></a>02279     }
<a name="l02280"></a>02280     <span class="comment">// -----------------------------------------------------</span>
<a name="l02281"></a>02281     <span class="keywordflow">else</span>
<a name="l02282"></a>02282     {
<a name="l02283"></a>02283         <span class="comment">// We don&#39;t have to pause OTCachedKey here like we did above, because</span>
<a name="l02284"></a>02284         <span class="comment">// this already has built-in mechanisms to go around OTCachedKey.</span>
<a name="l02285"></a>02285         <span class="comment">//</span>
<a name="l02286"></a>02286         <span class="keyword">const</span> <span class="keywordtype">bool</span> bReEncrypted = pNym-&gt;ReEncryptPrivateCredentials(<span class="keyword">false</span><span class="comment">/*bImporting*/</span>, &amp;thePWDataSave); <span class="comment">// Handles OTCachedKey already.</span>
<a name="l02287"></a>02287         <span class="comment">// -----------------------------</span>
<a name="l02288"></a>02288         <span class="keywordflow">if</span> (bReEncrypted)
<a name="l02289"></a>02289         {
<a name="l02290"></a>02290             <span class="comment">// -----------------------------</span>
<a name="l02291"></a>02291             <span class="comment">// Create a new OTDB::StringMap object.</span>
<a name="l02292"></a>02292             <span class="comment">//</span>
<a name="l02293"></a>02293             <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
<a name="l02294"></a>02294             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
<a name="l02295"></a>02295             <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
<a name="l02296"></a>02296             <span class="comment">// --------------------------------------------------------------</span>
<a name="l02297"></a>02297             pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
<a name="l02298"></a>02298             theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l02299"></a>02299             pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l02300"></a>02300             <span class="comment">// --------------------------------------------------------------</span>
<a name="l02301"></a>02301             <span class="keywordflow">if</span> (NULL == pMap)
<a name="l02302"></a>02302                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to load or create a STORED_OBJ_STRING_MAP.\n&quot;</span>,
<a name="l02303"></a>02303                               __FUNCTION__);
<a name="l02304"></a>02304             <span class="keywordflow">else</span> <span class="comment">// It instantiated.</span>
<a name="l02305"></a>02305             {    <span class="comment">// -----------------------------------------------</span>
<a name="l02306"></a>02306                 <a class="code" href="class_o_t_string.html">OTString</a>       strCredList;
<a name="l02307"></a>02307                 <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l02308"></a>02308 
<a name="l02309"></a>02309                 pNym-&gt;GetPrivateCredentials(strCredList, &amp;theMap);
<a name="l02310"></a>02310                 <span class="comment">// -----------------------------------------------</span>
<a name="l02311"></a>02311                 <span class="comment">// Serialize the StringMap to a string...</span>
<a name="l02312"></a>02312                 <span class="comment">//</span>
<a name="l02313"></a>02313                 <span class="keywordflow">if</span> (strCredList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theMap.size() &gt; 0)) <span class="comment">// Won&#39;t bother if there are zero credentials somehow.</span>
<a name="l02314"></a>02314                 {
<a name="l02315"></a>02315                     std::string str_Encoded     = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
<a name="l02316"></a>02316                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessEncoding = (str_Encoded.size() &gt; 0);
<a name="l02317"></a>02317                     <span class="keywordflow">if</span> (bSuccessEncoding)
<a name="l02318"></a>02318                     {
<a name="l02319"></a>02319                         ascCredList.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strCredList);   <span class="comment">// &lt;========== Success</span>
<a name="l02320"></a>02320                         ascCredentials.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str());  <span class="comment">// Payload contains credentials list, payload2 contains actual credentials.</span>
<a name="l02321"></a>02321                         bSavedCert = <span class="keyword">true</span>;
<a name="l02322"></a>02322                     }
<a name="l02323"></a>02323                 }
<a name="l02324"></a>02324             }
<a name="l02325"></a>02325         } <span class="comment">// bReEncrypted.</span>
<a name="l02326"></a>02326         <span class="comment">// -----------------------------</span>
<a name="l02327"></a>02327     } <span class="comment">// bHasCredentials==true</span>
<a name="l02328"></a>02328     <span class="comment">// -----------------------------------------------------</span>
<a name="l02329"></a>02329     <span class="keywordflow">if</span> (!bSavedCert)
<a name="l02330"></a>02330     {
<a name="l02331"></a>02331         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while saving Nym&#39;s private cert, or private credentials, to string.\n&quot;</span>
<a name="l02332"></a>02332                       <span class="stringliteral">&quot;Reason I was doing this: \&quot;%s\&quot;\n&quot;</span>, __FUNCTION__, thePWDataSave.<a class="code" href="class_o_t_password_data.html#afe04404b46712a5918790c3b4af7dda2">GetDisplayString</a>());
<a name="l02333"></a>02333         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02334"></a>02334     }
<a name="l02335"></a>02335     <span class="comment">// -----------------------------</span>
<a name="l02336"></a>02336     <a class="code" href="class_o_t_string.html">OTString</a> strNymfile;
<a name="l02337"></a>02337     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSavedNym = pNym-&gt;SavePseudonym(strNymfile);
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     <span class="keywordflow">if</span> (!bSavedNym)
<a name="l02340"></a>02340     {
<a name="l02341"></a>02341         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while calling pNym-&gt;SavePseudonym(strNymfile) (to string)\n&quot;</span>,
<a name="l02342"></a>02342                       __FUNCTION__);
<a name="l02343"></a>02343         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02344"></a>02344     }
<a name="l02345"></a>02345     <span class="comment">// -----------------------------</span>
<a name="l02346"></a>02346     <span class="comment">// Create an OTDB::StringMap object.</span>
<a name="l02347"></a>02347     <span class="comment">//</span>
<a name="l02348"></a>02348     <span class="comment">// Set the name, id, [certfile|credlist credentials], and nymfile onto it.  (Our exported</span>
<a name="l02349"></a>02349     <span class="comment">// Nym appears as an ASCII-armored text to the naked eye, but when loaded up in code it</span>
<a name="l02350"></a>02350     <span class="comment">// appears as a map of strings: name, id, [certfile|credlist credentials], and nymfile.)</span>
<a name="l02351"></a>02351     <span class="comment">//</span>
<a name="l02352"></a>02352     <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * pStorable = NULL;
<a name="l02353"></a>02353     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theAngel;
<a name="l02354"></a>02354     <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = NULL;
<a name="l02355"></a>02355     <span class="comment">// --------------------------------------------------------------</span>
<a name="l02356"></a>02356     pStorable = <a class="code" href="namespace_o_t_d_b.html#a67b35ca5812604fb3e1eae2b659f66ee">OTDB::CreateObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>); <span class="comment">// this asserts already, on failure.</span>
<a name="l02357"></a>02357     theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l02358"></a>02358     pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l02359"></a>02359     <span class="comment">// --------------------------------------------------------------</span>
<a name="l02360"></a>02360     <span class="comment">// It exists.</span>
<a name="l02361"></a>02361     <span class="comment">//</span>
<a name="l02362"></a>02362     <span class="keywordflow">if</span> (NULL == pMap)
<a name="l02363"></a>02363     {
<a name="l02364"></a>02364         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: failed trying to load or create a STORED_OBJ_STRING_MAP.\n&quot;</span>, __FUNCTION__);
<a name="l02365"></a>02365         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02366"></a>02366     }
<a name="l02367"></a>02367     <span class="comment">// -----------------------------------------------</span>
<a name="l02368"></a>02368     <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l02369"></a>02369     <span class="comment">// -----------------------------------------------</span>
<a name="l02370"></a>02370     theMap[<span class="stringliteral">&quot;id&quot;</span>]       = str_nym_id;
<a name="l02371"></a>02371     theMap[<span class="stringliteral">&quot;name&quot;</span>]     = str_nym_name;
<a name="l02372"></a>02372     theMap[<span class="stringliteral">&quot;nymfile&quot;</span>]  = strNymfile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02373"></a>02373 
<a name="l02374"></a>02374     <span class="keywordflow">if</span> (strCertfile.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02375"></a>02375         theMap[<span class="stringliteral">&quot;certfile&quot;</span>] = strCertfile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     <span class="keywordflow">if</span> (ascCredList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02378"></a>02378         theMap[<span class="stringliteral">&quot;credlist&quot;</span>] = ascCredList.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="keywordflow">if</span> (ascCredentials.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02381"></a>02381         theMap[<span class="stringliteral">&quot;credentials&quot;</span>] = ascCredentials.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02382"></a>02382         <span class="comment">// -----------------------------------------------</span>
<a name="l02383"></a>02383     <span class="comment">// Serialize the StringMap to a string...</span>
<a name="l02384"></a>02384     <span class="comment">//</span>
<a name="l02385"></a>02385     std::string str_Encoded = <a class="code" href="namespace_o_t_d_b.html#a3c8a8d4af889b2aa3458aac4365aa784">OTDB::EncodeObject</a>(*pMap);
<a name="l02386"></a>02386     <span class="keywordtype">bool</span> bReturnVal   = (str_Encoded.size() &gt; 0);
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="keywordflow">if</span> (bReturnVal)
<a name="l02389"></a>02389     {
<a name="l02390"></a>02390         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascTemp;
<a name="l02391"></a>02391         ascTemp.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(str_Encoded.c_str());
<a name="l02392"></a>02392         strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l02393"></a>02393         bReturnVal = ascTemp.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput,
<a name="l02394"></a>02394                                                 <span class="stringliteral">&quot;EXPORTED NYM&quot;</span> <span class="comment">// -----BEGIN OT EXPORTED NYM-----</span>
<a name="l02395"></a>02395                                                 ); <span class="comment">// (bool bEscaped=false by default.)</span>
<a name="l02396"></a>02396     }
<a name="l02397"></a>02397 
<a name="l02398"></a>02398     <span class="keywordflow">return</span> bReturnVal;
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401 <span class="comment">// -----------------------------------------------------</span>
<a name="l02402"></a>02402 
<a name="l02403"></a>02403 
<a name="l02404"></a>02404 <span class="comment">// OT has the capability to export a Nym (normally stored in several files) as an encoded</span>
<a name="l02405"></a>02405 <span class="comment">// object (in base64-encoded form) and then import it again.</span>
<a name="l02406"></a>02406 <span class="comment">//</span>
<a name="l02407"></a>02407 <span class="comment">// Returns bool on success, and if pNymID is passed in, will set it to the new NymID.</span>
<a name="l02408"></a>02408 <span class="comment">// Also on failure, if the Nym was already there with that ID, and if pNymID is passed,</span>
<a name="l02409"></a>02409 <span class="comment">// then it will be set to the ID that was already there.</span>
<a name="l02410"></a>02410 <span class="comment">//</span>
<a name="l02411"></a><a class="code" href="class_o_t___a_p_i.html#a77a64ebe7b8942ae50ed25c31834eb7c">02411</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a77a64ebe7b8942ae50ed25c31834eb7c">OT_API::Wallet_ImportNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; FILE_CONTENTS, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pNymID<span class="comment">/*=NULL*/</span>)
<a name="l02412"></a>02412 {
<a name="l02413"></a>02413     <span class="comment">// -----------------------------------------------------</span>
<a name="l02414"></a>02414     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02415"></a>02415     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02416"></a>02416     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l02417"></a>02417     <span class="comment">// -----------------------------------------------------</span>
<a name="l02418"></a>02418     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascArmor;
<a name="l02419"></a>02419     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadedArmor = <a class="code" href="class_o_t_a_s_c_i_i_armor.html#a6b5c0069db88e2c884d213ea64d3bbe4">OTASCIIArmor::LoadFromString</a>(ascArmor, FILE_CONTENTS); <span class="comment">// str_bookend=&quot;-----BEGIN&quot; by default</span>
<a name="l02420"></a>02420     <span class="comment">// -----------------------------------------------------</span>
<a name="l02421"></a>02421     <span class="keywordflow">if</span> (!bLoadedArmor || !ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02422"></a>02422     {
<a name="l02423"></a>02423         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading string into OTASCIIArmor object:\n\n%s\n\n&quot;</span>,
<a name="l02424"></a>02424                       __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02425"></a>02425         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02426"></a>02426     }
<a name="l02427"></a>02427     <span class="comment">// -------------------------------------------------</span>
<a name="l02428"></a>02428     <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascArmor.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02429"></a>02429     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> theStorableAngel(pStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l02430"></a>02430     <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pMap = (NULL == pStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pStorable);
<a name="l02431"></a>02431 
<a name="l02432"></a>02432     <span class="keywordflow">if</span> (NULL == pMap)
<a name="l02433"></a>02433     {
<a name="l02434"></a>02434         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object while trying to import Nym:\n%s\n&quot;</span>,
<a name="l02435"></a>02435                        __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02436"></a>02436         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02437"></a>02437     }
<a name="l02438"></a>02438     <span class="comment">// ----------------------------------------</span>
<a name="l02439"></a>02439     std::map&lt;std::string, std::string&gt; &amp; theMap = pMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l02440"></a>02440     <span class="comment">// ---------------------------------------------------</span>
<a name="l02441"></a>02441     <span class="comment">// By this point, there was definitely a StringMap encoded in the FILE_CONTENTS...</span>
<a name="l02442"></a>02442     <span class="comment">//</span>
<a name="l02443"></a>02443     <span class="comment">// Decode the FILE_CONTENTS into a StringMap object,</span>
<a name="l02444"></a>02444     <span class="comment">// and if success, make sure it contains these values:</span>
<a name="l02445"></a>02445     <span class="comment">//</span>
<a name="l02446"></a>02446     <span class="comment">// id:       The NymID.</span>
<a name="l02447"></a>02447     <span class="comment">// name:     The display name from the wallet.</span>
<a name="l02448"></a>02448     <span class="comment">// certfile: The public / private certfile in openssl format.</span>
<a name="l02449"></a>02449     <span class="comment">// nymfile:  The contents of the nymfile.</span>
<a name="l02450"></a>02450     <span class="comment">//</span>
<a name="l02451"></a>02451     <span class="keywordflow">if</span> (theMap.end() == theMap.find(<span class="stringliteral">&quot;id&quot;</span>)) <span class="comment">// todo hardcoding</span>
<a name="l02452"></a>02452     {
<a name="l02453"></a>02453         <span class="comment">// not found.</span>
<a name="l02454"></a>02454         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find &#39;id&#39; field while trying to import Nym:\n%s\n&quot;</span>,
<a name="l02455"></a>02455                        __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02456"></a>02456         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02457"></a>02457     }
<a name="l02458"></a>02458     <span class="keywordflow">if</span> (theMap.end() == theMap.find(<span class="stringliteral">&quot;name&quot;</span>)) <span class="comment">// todo hardcoding</span>
<a name="l02459"></a>02459     {
<a name="l02460"></a>02460         <span class="comment">// not found.</span>
<a name="l02461"></a>02461         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find &#39;name&#39; field while trying to import Nym:\n%s\n&quot;</span>,
<a name="l02462"></a>02462                        __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02463"></a>02463         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465     <span class="keywordflow">if</span> (theMap.end() == theMap.find(<span class="stringliteral">&quot;nymfile&quot;</span>)) <span class="comment">// todo hardcoding</span>
<a name="l02466"></a>02466     {
<a name="l02467"></a>02467         <span class="comment">// not found.</span>
<a name="l02468"></a>02468         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find &#39;nymfile&#39; field while trying to import Nym:\n%s\n&quot;</span>,
<a name="l02469"></a>02469                        __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02470"></a>02470         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02471"></a>02471     }
<a name="l02472"></a>02472     <span class="comment">// ------------------------------------------</span>
<a name="l02473"></a>02473     <span class="keywordflow">if</span> ((theMap.end() == theMap.find(<span class="stringliteral">&quot;certfile&quot;</span>)) &amp;&amp; <span class="comment">// todo hardcoding</span>
<a name="l02474"></a>02474         (theMap.end() == theMap.find(<span class="stringliteral">&quot;credlist&quot;</span>)))   <span class="comment">// Logic: No certfile AND no credlist? Gotta have one or the other.</span>
<a name="l02475"></a>02475     {
<a name="l02476"></a>02476         <span class="comment">// not found.</span>
<a name="l02477"></a>02477         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find a &#39;certfile&#39; nor a &#39;credlist&#39; field while trying to import Nym:\n%s\n&quot;</span>,
<a name="l02478"></a>02478                        __FUNCTION__, FILE_CONTENTS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02479"></a>02479         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02480"></a>02480     }
<a name="l02481"></a>02481     <span class="comment">// ---------------------------------------------------</span>
<a name="l02482"></a>02482     <span class="comment">// Do various verifications on the values to make sure there&#39;s no funny business.</span>
<a name="l02483"></a>02483     <span class="comment">//</span>
<a name="l02484"></a>02484     <span class="comment">// If Nym with this ID is ALREADY in the wallet, set pNymID and return false.</span>
<a name="l02485"></a>02485     <span class="comment">// -----------------------------------------------------</span>
<a name="l02486"></a>02486     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theNymID  (theMap[<span class="stringliteral">&quot;id&quot;</span>  ].c_str());
<a name="l02487"></a>02487     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     strNymName(theMap[<span class="stringliteral">&quot;name&quot;</span>].c_str());
<a name="l02488"></a>02488 
<a name="l02489"></a>02489     <span class="keywordflow">if</span> (NULL != pNymID)
<a name="l02490"></a>02490         pNymID-&gt;<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(theMap[<span class="stringliteral">&quot;id&quot;</span>].c_str());
<a name="l02491"></a>02491     <span class="comment">// -----------------------------------------------------</span>
<a name="l02492"></a>02492     <span class="keywordflow">if</span> (theNymID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: NYM_ID passed in is empty; returning false&quot;</span>, __FUNCTION__); <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l02493"></a>02493     <span class="comment">// -----------------------------------------------------</span>
<a name="l02494"></a>02494     <span class="comment">// MAKE SURE IT&#39;S NOT ALREADY IN THE WALLET.</span>
<a name="l02495"></a>02495     <span class="comment">//</span>
<a name="l02496"></a>02496     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(theNymID, <span class="keyword">true</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02497"></a>02497 
<a name="l02498"></a>02498     <span class="keywordflow">if</span> (NULL != pNym) <span class="comment">// already there.</span>
<a name="l02499"></a>02499     {
<a name="l02500"></a>02500         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Tried to import a Nym that&#39;s already in wallet: %s\n&quot;</span>,
<a name="l02501"></a>02501                        __FUNCTION__, theMap[<span class="stringliteral">&quot;id&quot;</span>].c_str());
<a name="l02502"></a>02502         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02503"></a>02503     }
<a name="l02504"></a>02504     <span class="comment">// -----------------------------------------------------</span>
<a name="l02505"></a>02505     <span class="comment">// Create a new Nym object.</span>
<a name="l02506"></a>02506     <span class="comment">//</span>
<a name="l02507"></a>02507     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(theNymID);
<a name="l02508"></a>02508     pNym = <span class="keyword">new</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>(theNymID);
<a name="l02509"></a>02509     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l02510"></a>02510     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPseudonym&gt;</a> theAngel(*pNym); <span class="comment">// will be cleaned up automatically.</span>
<a name="l02511"></a>02511 
<a name="l02512"></a>02512     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strNymName);
<a name="l02513"></a>02513 
<a name="l02514"></a>02514     <span class="comment">// *****************************************************************</span>
<a name="l02515"></a>02515 
<a name="l02516"></a>02516     <span class="comment">// The Nym being imported has its own password. We ask for that here,</span>
<a name="l02517"></a>02517     <span class="comment">// so we can preserve it in an OTPassword object and pass it around to</span>
<a name="l02518"></a>02518     <span class="comment">// everyone who needs it.</span>
<a name="l02519"></a>02519     <span class="comment">//</span>
<a name="l02520"></a>02520     <span class="comment">// This way OT doesn&#39;t automatically ask for it a billion times as it</span>
<a name="l02521"></a>02521     <span class="comment">// goes through the process of loading and copying these various keys</span>
<a name="l02522"></a>02522     <span class="comment">// (None of which utilize the wallet&#39;s built-in cached master key, since</span>
<a name="l02523"></a>02523     <span class="comment">// this Nym is being imported and thus is external to the wallet until</span>
<a name="l02524"></a>02524     <span class="comment">// that process is complete.)</span>
<a name="l02525"></a>02525     <span class="comment">//</span>
<a name="l02526"></a>02526     <a class="code" href="class_o_t_string.html">OTString</a> strDisplay(<span class="stringliteral">&quot;Enter passphrase for the Nym being imported.&quot;</span>);
<a name="l02527"></a>02527 
<a name="l02528"></a>02528     <span class="comment">// Circumvents the cached key.</span>
<a name="l02529"></a>02529     <a class="code" href="class_o_t_password.html">OTPassword</a> * pExportPassphrase = <a class="code" href="class_o_t_symmetric_key.html#ae44e319c2200c279a14720cff7c4ae4c">OTSymmetricKey::GetPassphraseFromUser</a>(&amp;strDisplay, <span class="keyword">false</span>); <span class="comment">//bAskTwice is true when exporting (since the export passphrase is being created at that time.) But here during importing, we just ask once, since the passphrase is being used, not created.</span>
<a name="l02530"></a>02530     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPassword&gt;</a> thePasswordAngel(pExportPassphrase);
<a name="l02531"></a>02531 
<a name="l02532"></a>02532     <span class="keywordflow">if</span> (NULL == pExportPassphrase)
<a name="l02533"></a>02533     {
<a name="l02534"></a>02534         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed in GetPassphraseFromUser.\n&quot;</span>, __FUNCTION__);
<a name="l02535"></a>02535         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02536"></a>02536     }
<a name="l02537"></a>02537 
<a name="l02538"></a>02538     <span class="comment">// *****************************************************************</span>
<a name="l02539"></a>02539     <span class="comment">// Pause the master key, since this Nym is coming from outside</span>
<a name="l02540"></a>02540     <span class="comment">// the wallet. We&#39;ll let it load with its own key. (No point using</span>
<a name="l02541"></a>02541     <span class="comment">// the internal wallet master key here, since the Nym is coming from</span>
<a name="l02542"></a>02542     <span class="comment">// outside, and doesn&#39;t use it anyway.)</span>
<a name="l02543"></a>02543     <span class="comment">// This is true regardless of whether we load via the old system or</span>
<a name="l02544"></a>02544     <span class="comment">// the new credentials system.</span>
<a name="l02545"></a>02545     <span class="comment">//</span>
<a name="l02546"></a>02546     <span class="keywordflow">if</span> (!(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused()))
<a name="l02547"></a>02547     {
<a name="l02548"></a>02548         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Pause();   <span class="comment">// BELOW THIS POINT, CACHED MASTER KEY IS DISABLED.</span>
<a name="l02549"></a>02549     }
<a name="l02550"></a>02550     <span class="comment">// *****************************************************************</span>
<a name="l02551"></a>02551     <span class="comment">// Set the credentials or keys on the new Nym object based on the</span>
<a name="l02552"></a>02552     <span class="comment">// certfile from the StringMap.</span>
<a name="l02553"></a>02553     <span class="comment">//</span>
<a name="l02554"></a>02554     <span class="comment">// -------------------------------------------------</span>
<a name="l02555"></a>02555     <span class="keywordtype">bool</span>      bIfNymLoadKeys = <span class="keyword">false</span>;
<a name="l02556"></a>02556     <a class="code" href="class_o_t_string.html">OTString</a>  strReasonToLoad(<span class="stringliteral">&quot;(ImportNym) To import this Nym, what is its passphrase? &quot;</span>);
<a name="l02557"></a>02557     <a class="code" href="class_o_t_string.html">OTString</a>  strReasonToSave(<span class="stringliteral">&quot;(ImportNym) What is your wallet&#39;s master passphrase? &quot;</span>);
<a name="l02558"></a>02558 
<a name="l02559"></a>02559     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataLoad(strReasonToLoad.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02560"></a>02560     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataSave(strReasonToSave.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02561"></a>02561     <span class="comment">// ------------------------------------------------------------</span>
<a name="l02562"></a>02562     mapOfStrings::iterator it_credlist    = theMap.find(<span class="stringliteral">&quot;credlist&quot;</span>);
<a name="l02563"></a>02563     mapOfStrings::iterator it_credentials = theMap.find(<span class="stringliteral">&quot;credentials&quot;</span>);
<a name="l02564"></a>02564     <span class="keywordtype">bool</span> bHasCredentials = <span class="keyword">false</span>;
<a name="l02565"></a>02565     <span class="comment">// ------------------------------------------------------------</span>
<a name="l02566"></a>02566     <span class="comment">// found &quot;credlist&quot;</span>
<a name="l02567"></a>02567     <span class="comment">//</span>
<a name="l02568"></a>02568     <span class="keywordflow">if</span> (theMap.end() != it_credlist)
<a name="l02569"></a>02569     {
<a name="l02570"></a>02570         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCredList;
<a name="l02571"></a>02571         <a class="code" href="class_o_t_string.html">OTString</a>     strCredList;
<a name="l02572"></a>02572         <span class="keywordflow">if</span> (it_credlist-&gt;second.size() &gt; 0)
<a name="l02573"></a>02573         {
<a name="l02574"></a>02574             ascCredList.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(it_credlist-&gt;second.c_str());
<a name="l02575"></a>02575             ascCredList.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strCredList);
<a name="l02576"></a>02576         }
<a name="l02577"></a>02577         <span class="comment">// ----------------------------------------------</span>
<a name="l02578"></a>02578         <span class="comment">// cred list exists, and found &quot;credentials&quot;...</span>
<a name="l02579"></a>02579         <span class="comment">//</span>
<a name="l02580"></a>02580         <span class="keywordflow">if</span> (strCredList.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; (theMap.end() != it_credentials)) <span class="comment">// and found &quot;credentials&quot;</span>
<a name="l02581"></a>02581         {
<a name="l02582"></a>02582             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCredentials;
<a name="l02583"></a>02583             <span class="keywordflow">if</span> (it_credentials-&gt;second.size() &gt; 0)
<a name="l02584"></a>02584             {
<a name="l02585"></a>02585                 ascCredentials.<a class="code" href="class_o_t_string.html#aa5db620fe8e60c849585d741975db991">Set</a>(it_credentials-&gt;second.c_str());
<a name="l02586"></a>02586                 <span class="comment">// -------------------------------------------------</span>
<a name="l02587"></a>02587                 <a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a>  * pPrivateStorable = <a class="code" href="namespace_o_t_d_b.html#a3c1cc3076ede1a1b6d78d1fea7de8cea">OTDB::DecodeObject</a>(<a class="code" href="namespace_o_t_d_b.html#abce432e500285dde333e6f76f6fbde82acc03e85e0f615881a2abe9ca12628330">OTDB::STORED_OBJ_STRING_MAP</a>, ascCredentials.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02588"></a>02588                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTDB::Storable&gt;</a> thePrivStorableAngel(pPrivateStorable); <span class="comment">// It will definitely be cleaned up.</span>
<a name="l02589"></a>02589                 <a class="code" href="class_o_t_d_b_1_1_string_map.html">OTDB::StringMap</a> * pPrivateMap = (NULL == pPrivateStorable) ? NULL : dynamic_cast&lt;OTDB::StringMap *&gt;(pPrivateStorable);
<a name="l02590"></a>02590                 <span class="comment">// -------------------------------------------------</span>
<a name="l02591"></a>02591                 <span class="keywordflow">if</span> (NULL == pPrivateMap)
<a name="l02592"></a>02592                 {
<a name="l02593"></a>02593                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed decoding StringMap object.\n&quot;</span>, __FUNCTION__);
<a name="l02594"></a>02594                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02595"></a>02595                 }
<a name="l02596"></a>02596                 <span class="keywordflow">else</span> <span class="comment">// IF the list saved, then we save the credentials themselves...</span>
<a name="l02597"></a>02597                 {
<a name="l02598"></a>02598                     <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a> &amp; thePrivateMap = pPrivateMap-&gt;<a class="code" href="class_o_t_d_b_1_1_string_map.html#a460f2e551430c65fef4130576985a0ce">the_map</a>;
<a name="l02599"></a>02599                     <span class="comment">// ----------------------------------------</span>
<a name="l02600"></a>02600                     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strCredList,
<a name="l02601"></a>02601                                                       &amp;thePrivateMap,
<a name="l02602"></a>02602                                                       &amp;strReasonToLoad,
<a name="l02603"></a>02603                                                       pExportPassphrase)) <span class="comment">// &lt;===========</span>
<a name="l02604"></a>02604                     {
<a name="l02605"></a>02605                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading nym %s from credential string.\n&quot;</span>,
<a name="l02606"></a>02606                                       __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02607"></a>02607                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02608"></a>02608                     }
<a name="l02609"></a>02609                     <span class="keywordflow">else</span> <span class="comment">// Success</span>
<a name="l02610"></a>02610                     {
<a name="l02611"></a>02611                         bIfNymLoadKeys  = <span class="keyword">true</span>;   <span class="comment">// &lt;============</span>
<a name="l02612"></a>02612                         bHasCredentials = <span class="keyword">true</span>;
<a name="l02613"></a>02613                     }
<a name="l02614"></a>02614                 } <span class="comment">// success decoding StringMap</span>
<a name="l02615"></a>02615             } <span class="comment">// it_credentials.second().size() &gt; 0</span>
<a name="l02616"></a>02616         } <span class="comment">// strCredList.Exists() and it_credentials found.</span>
<a name="l02617"></a>02617     } <span class="comment">// found &quot;credlist&quot;</span>
<a name="l02618"></a>02618     <span class="comment">// ------------------------------------------------------------</span>
<a name="l02619"></a>02619     <span class="comment">// found &quot;certfile&quot;</span>
<a name="l02620"></a>02620     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theMap.end() != theMap.find(<span class="stringliteral">&quot;certfile&quot;</span>))
<a name="l02621"></a>02621     {
<a name="l02622"></a>02622         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strCert(theMap[<span class="stringliteral">&quot;certfile&quot;</span>]);
<a name="l02623"></a>02623         bIfNymLoadKeys = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aa7e06445fd850c8a13cabf2283ca4f01">Loadx509CertAndPrivateKeyFromString</a>(strCert, &amp;thePWDataLoad, pExportPassphrase); <span class="comment">// &lt;============</span>
<a name="l02624"></a>02624     }
<a name="l02625"></a>02625     <span class="comment">// *****************************************************************</span>
<a name="l02626"></a>02626     <span class="comment">// Unpause the OTCachedKey (wallet master key.)</span>
<a name="l02627"></a>02627     <span class="comment">// Now that we&#39;ve loaded up the &quot;outsider&quot; using its own key,</span>
<a name="l02628"></a>02628     <span class="comment">// we now resume normal wallet master key operations so that when</span>
<a name="l02629"></a>02629     <span class="comment">// we save the Nym, it will be saved using the wallet master key.</span>
<a name="l02630"></a>02630     <span class="comment">// (Henceforth, it has been &quot;imported.&quot;)</span>
<a name="l02631"></a>02631     <span class="comment">//</span>
<a name="l02632"></a>02632     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
<a name="l02633"></a>02633     {
<a name="l02634"></a>02634         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Unpause();   <span class="comment">// BELOW THIS POINT, CACHED MASTER KEY IS BACK IN EFFECT. (Disabled above.)</span>
<a name="l02635"></a>02635     }
<a name="l02636"></a>02636     <span class="comment">// *****************************************************************</span>
<a name="l02637"></a>02637     <span class="comment">//</span>
<a name="l02638"></a>02638     <span class="keywordflow">if</span> (bIfNymLoadKeys &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aae8a707c7799efb6944d485be31a7c3e">VerifyPseudonym</a>())
<a name="l02639"></a>02639     {
<a name="l02640"></a>02640         <span class="comment">// Before we go on switching the credentials around, let&#39;s make sure this Nym we&#39;re</span>
<a name="l02641"></a>02641         <span class="comment">// importing isn&#39;t already in the wallet.</span>
<a name="l02642"></a>02642 
<a name="l02643"></a>02643         <span class="comment">// -----------------------------</span>
<a name="l02644"></a>02644         <span class="keywordflow">if</span> ( bHasCredentials &amp;&amp;
<a name="l02645"></a>02645             !pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adf52e65c9002374a7298f17d97be5b57">ReEncryptPrivateCredentials</a>(<span class="keyword">true</span><span class="comment">/*bImporting*/</span>, &amp;thePWDataLoad, pExportPassphrase)) <span class="comment">// Handles OTCachedKey internally, no need for pausing for this call.</span>
<a name="l02646"></a>02646         {
<a name="l02647"></a>02647             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to re-encrypt Nym&#39;s private credentials.\n&quot;</span>, __FUNCTION__);
<a name="l02648"></a>02648             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02649"></a>02649         }
<a name="l02650"></a>02650         <span class="comment">// -----------------------------</span>
<a name="l02651"></a>02651         <span class="comment">// load Nymfile from string</span>
<a name="l02652"></a>02652         <span class="comment">//</span>
<a name="l02653"></a>02653         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymfile(theMap[<span class="stringliteral">&quot;nymfile&quot;</span>]);
<a name="l02654"></a>02654 
<a name="l02655"></a>02655               <span class="keywordtype">bool</span> bConverted = <span class="keyword">false</span>;
<a name="l02656"></a>02656         <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded    = (strNymfile.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a7992e8fbf785eeb2d5158cdf966c7a1b">LoadFromString</a>(strNymfile));
<a name="l02657"></a>02657 <span class="comment">//      const bool bLoaded    = (strNymfile.Exists() &amp;&amp; pNym-&gt;LoadFromString(strNymfile, &amp;thePrivateMap)); // Unnecessary, since pNym has already loaded with this private info, and it will stay loaded even through loading up the nymfile portion, which does not overwrite it. Furthermore, we have since transformed that data, re-encrypting it to a new key, and that&#39;s the important change that we&#39;re trying to save here! Therefore I don&#39;t want to re-introduce this (now old) version of the private info, therefore this is commented out.</span>
<a name="l02658"></a>02658         <span class="comment">// -----------------------------</span>
<a name="l02659"></a>02659         <span class="comment">// If success: Add to Wallet including name.</span>
<a name="l02660"></a>02660         <span class="comment">//</span>
<a name="l02661"></a>02661         <span class="keywordflow">if</span> (bLoaded)
<a name="l02662"></a>02662         {
<a name="l02663"></a>02663             pWallet-&gt;<a class="code" href="class_o_t_wallet.html#acb570de733658a4ad24756dde0f22a34">AddNym</a>(*pNym); <span class="comment">// Insert to wallet&#39;s list of Nyms.</span>
<a name="l02664"></a>02664             theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// Since adding to wallet, no need to cleanup, so we set this back to NULL.</span>
<a name="l02665"></a>02665 
<a name="l02666"></a>02666             <span class="keywordflow">if</span> (!pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a59daeb8ce8f92530c5ddb4fcd1dde7d4">ConvertNymToCachedKey</a>(*pNym)) <span class="comment">// This also calls SaveX509CertAndPrivateKey, FYI. (Or saves credentials, too, whichever is applicable.)</span>
<a name="l02667"></a>02667             {
<a name="l02668"></a>02668                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while calling pWallet-&gt;ConvertNymToCachedKey(*pNym)\n&quot;</span>, __FUNCTION__);
<a name="l02669"></a>02669                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02670"></a>02670             }
<a name="l02671"></a>02671             <span class="keywordflow">else</span>
<a name="l02672"></a>02672                 bConverted = <span class="keyword">true</span>;
<a name="l02673"></a>02673         }
<a name="l02674"></a>02674         <span class="keywordflow">else</span>
<a name="l02675"></a>02675         {
<a name="l02676"></a>02676             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading nymfile from string.\n&quot;</span>, __FUNCTION__);
<a name="l02677"></a>02677             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02678"></a>02678         }
<a name="l02679"></a>02679         <span class="comment">// ***********************************************************</span>
<a name="l02680"></a>02680         <span class="comment">//</span>
<a name="l02681"></a>02681         <span class="keywordflow">if</span> (bLoaded &amp;&amp; bConverted) <span class="comment">// bLoaded is probably superfluous here.</span>
<a name="l02682"></a>02682         {
<a name="l02683"></a>02683             <span class="comment">// ----------------------------</span>
<a name="l02684"></a>02684             <span class="comment">// save the nymfile.</span>
<a name="l02685"></a>02685             <span class="comment">//</span>
<a name="l02686"></a>02686             <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym))
<a name="l02687"></a>02687             {
<a name="l02688"></a>02688                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed calling SaveSignedNymfile.\n&quot;</span>, __FUNCTION__);
<a name="l02689"></a>02689                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02690"></a>02690             }
<a name="l02691"></a>02691             <span class="comment">// ----------------------------</span>
<a name="l02692"></a>02692             <span class="comment">// the conversion process adds values to the wallet, so we must save it after.</span>
<a name="l02693"></a>02693             <span class="keywordflow">if</span> (!pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>())
<a name="l02694"></a>02694             {
<a name="l02695"></a>02695                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Failed to save (updated) wallet.\n&quot;</span>, __FUNCTION__);
<a name="l02696"></a>02696                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02697"></a>02697             }
<a name="l02698"></a>02698 
<a name="l02699"></a>02699             <span class="keywordflow">return</span> <span class="keyword">true</span>;   <span class="comment">// &lt;========= Success!</span>
<a name="l02700"></a>02700         }
<a name="l02701"></a>02701         <span class="comment">// ***********************************************************</span>
<a name="l02702"></a>02702     }
<a name="l02703"></a>02703     <span class="keywordflow">else</span>
<a name="l02704"></a>02704         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading or verifying keys|credentials|pseudonym.\n&quot;</span>, __FUNCTION__);
<a name="l02705"></a>02705     <span class="comment">// ----------------------</span>
<a name="l02706"></a>02706     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02707"></a>02707 }
<a name="l02708"></a>02708 
<a name="l02709"></a>02709 
<a name="l02710"></a>02710 <span class="comment">// In this case, instead of importing a special &quot;OT Nym all-in-one exported&quot; file format,</span>
<a name="l02711"></a>02711 <span class="comment">// we are importing the public/private keys only, from their Cert file contents, and then</span>
<a name="l02712"></a>02712 <span class="comment">// creating a blank Nymfile to go along with it. This is for when people wish to import</span>
<a name="l02713"></a>02713 <span class="comment">// pre-existing keys to create a new Nym.</span>
<a name="l02714"></a>02714 <span class="comment">//</span>
<a name="l02715"></a>02715 <span class="comment">// Returns bool on success, and if pNymID is passed in, will set it to the new NymID.</span>
<a name="l02716"></a>02716 <span class="comment">// Also on failure, if the Nym was already there with that ID, and if pNymID is passed,</span>
<a name="l02717"></a>02717 <span class="comment">// then it will be set to the ID that was already there.</span>
<a name="l02718"></a>02718 <span class="comment">//</span>
<a name="l02719"></a>02719 
<a name="l02720"></a><a class="code" href="class_o_t___a_p_i.html#a52464281f46358635dde59e3b787354e">02720</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a52464281f46358635dde59e3b787354e">OT_API::Wallet_ImportCert</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; DISPLAY_NAME, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; FILE_CONTENTS, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pNymID<span class="comment">/*=NULL*/</span>)
<a name="l02721"></a>02721 {
<a name="l02722"></a>02722     <span class="comment">// -----------------------------------------------------</span>
<a name="l02723"></a>02723     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02724"></a>02724     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02725"></a>02725     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l02726"></a>02726     <span class="comment">// -----------------------------------------------------</span>
<a name="l02727"></a>02727 
<a name="l02728"></a>02728     <span class="comment">// Do various verifications on the values to make sure there&#39;s no funny business.</span>
<a name="l02729"></a>02729     <span class="comment">//</span>
<a name="l02730"></a>02730     <span class="comment">// If Nym with this ID is ALREADY in the wallet, set pNymID and return false.</span>
<a name="l02731"></a>02731     <span class="comment">// -----------------------------------------------------</span>
<a name="l02732"></a>02732     <span class="comment">// Create a new Nym object.</span>
<a name="l02733"></a>02733     <span class="comment">//</span>
<a name="l02734"></a>02734     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = <span class="keyword">new</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>;
<a name="l02735"></a>02735     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l02736"></a>02736     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPseudonym&gt;</a> theAngel(*pNym); <span class="comment">// will be cleaned up automatically.</span>
<a name="l02737"></a>02737 
<a name="l02738"></a>02738     <span class="keywordflow">if</span> (DISPLAY_NAME.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02739"></a>02739        pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(DISPLAY_NAME);
<a name="l02740"></a>02740     <span class="comment">// -----------------------------------------------------</span>
<a name="l02741"></a>02741     <span class="comment">// Pause the master key, since this Nym is coming from outside</span>
<a name="l02742"></a>02742     <span class="comment">// the wallet.</span>
<a name="l02743"></a>02743     <span class="comment">//</span>
<a name="l02744"></a>02744     <span class="keywordflow">if</span> (!(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused()))
<a name="l02745"></a>02745     {
<a name="l02746"></a>02746         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Pause();
<a name="l02747"></a>02747     }
<a name="l02748"></a>02748     <span class="comment">// ----------------------</span>
<a name="l02749"></a>02749     <span class="comment">// Set the public and private keys on the new Nym object based on the</span>
<a name="l02750"></a>02750     <span class="comment">// certfile from the StringMap.</span>
<a name="l02751"></a>02751     <span class="comment">//</span>
<a name="l02752"></a>02752     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a>  thePWData(<span class="stringliteral">&quot;To import this Cert, what is its passphrase? &quot;</span>);
<a name="l02753"></a>02753     <span class="keyword">const</span> <span class="keywordtype">bool</span> bIfNymLoadKeys = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#aa7e06445fd850c8a13cabf2283ca4f01">Loadx509CertAndPrivateKeyFromString</a>(FILE_CONTENTS, &amp;thePWData);
<a name="l02754"></a>02754     <span class="comment">// ----------------------</span>
<a name="l02755"></a>02755     <span class="comment">// Unpause the master key. (This may go above the add to wallet, or it may stay here, with the &quot;convert to master key&quot; below.)</span>
<a name="l02756"></a>02756     <span class="comment">//</span>
<a name="l02757"></a>02757     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
<a name="l02758"></a>02758     {
<a name="l02759"></a>02759         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Unpause();
<a name="l02760"></a>02760     }
<a name="l02761"></a>02761     <span class="comment">// ----------------------</span>
<a name="l02762"></a>02762     <span class="keywordflow">if</span> (bIfNymLoadKeys &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac6c809c283846f8a7a3338a37998ba88">SetIdentifierByPubkey</a>())
<a name="l02763"></a>02763     {
<a name="l02764"></a>02764         <span class="keywordflow">if</span> (NULL != pNymID)
<a name="l02765"></a>02765             *pNymID = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>();
<a name="l02766"></a>02766         <span class="comment">// -----------------------------------------------------</span>
<a name="l02767"></a>02767         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pTempNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>(), <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02768"></a>02768 
<a name="l02769"></a>02769         <span class="keywordflow">if</span> (NULL != pTempNym) <span class="comment">// already there.</span>
<a name="l02770"></a>02770         {
<a name="l02771"></a>02771             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>());
<a name="l02772"></a>02772             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Tried to import the Cert for a Nym that&#39;s already in wallet: %s\n&quot;</span>,
<a name="l02773"></a>02773                            __FUNCTION__, strNymID.Get());
<a name="l02774"></a>02774             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02775"></a>02775         }
<a name="l02776"></a>02776         <span class="comment">// -----------------------------------------------------</span>
<a name="l02777"></a>02777         <span class="comment">// If success: Add to Wallet including name.</span>
<a name="l02778"></a>02778         <span class="comment">//</span>
<a name="l02779"></a>02779         pWallet-&gt;<a class="code" href="class_o_t_wallet.html#acb570de733658a4ad24756dde0f22a34">AddNym</a>(*pNym); <span class="comment">// Insert to wallet&#39;s list of Nyms.</span>
<a name="l02780"></a>02780         theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// In this case, no need to cleanup, so we set this back to NULL.</span>
<a name="l02781"></a>02781 
<a name="l02782"></a>02782         <span class="keyword">const</span> <span class="keywordtype">bool</span> bConverted = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a59daeb8ce8f92530c5ddb4fcd1dde7d4">ConvertNymToCachedKey</a>(*pNym);
<a name="l02783"></a>02783 
<a name="l02784"></a>02784         <span class="keywordflow">if</span> (!bConverted)
<a name="l02785"></a>02785         {
<a name="l02786"></a>02786             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while calling pWallet-&gt;ConvertNymToCachedKey(*pNym)\n&quot;</span>, __FUNCTION__);
<a name="l02787"></a>02787         }
<a name="l02788"></a>02788         <span class="keywordflow">else</span>
<a name="l02789"></a>02789         {
<a name="l02790"></a>02790             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l02791"></a>02791             pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>();  <span class="comment">// the conversion process adds values to the wallet, so we must save it after.</span>
<a name="l02792"></a>02792             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02793"></a>02793         }
<a name="l02794"></a>02794     }
<a name="l02795"></a>02795     <span class="keywordflow">else</span>
<a name="l02796"></a>02796         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading or verifying key from cert string.\n&quot;</span>, __FUNCTION__);
<a name="l02797"></a>02797     <span class="comment">// ----------------------</span>
<a name="l02798"></a>02798     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02799"></a>02799 }
<a name="l02800"></a>02800 
<a name="l02801"></a>02801 
<a name="l02802"></a>02802 
<a name="l02803"></a>02803 <span class="comment">// ----------------------------------------------------</span>
<a name="l02804"></a>02804 
<a name="l02805"></a>02805 
<a name="l02806"></a>02806 
<a name="l02807"></a><a class="code" href="class_o_t___a_p_i.html#afebfabab4241d6aa75ce0e178e248592">02807</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#afebfabab4241d6aa75ce0e178e248592">OT_API::Wallet_ExportCert</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l02808"></a>02808 {
<a name="l02809"></a>02809     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l02810"></a>02810     <span class="comment">// -----------------------------------------------------</span>
<a name="l02811"></a>02811     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataLoad(<span class="stringliteral">&quot;Need Wallet Master passphrase to export any Cert.&quot;</span>);
<a name="l02812"></a>02812     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataSave(<span class="stringliteral">&quot;Create new passphrase for exported Cert.&quot;</span>);
<a name="l02813"></a>02813     <a class="code" href="class_o_t_string.html">OTString</a> strReasonToSave(thePWDataSave.<a class="code" href="class_o_t_password_data.html#afe04404b46712a5918790c3b4af7dda2">GetDisplayString</a>());
<a name="l02814"></a>02814     <span class="comment">// -----------------------------------------------------</span>
<a name="l02815"></a>02815     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, __FUNCTION__, &amp;thePWDataLoad); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l02816"></a>02816     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02817"></a>02817     <span class="comment">// -----------------------------------------------------</span>
<a name="l02818"></a>02818     <span class="comment">// Pause the master key before exporting, since we want to save this Nym</span>
<a name="l02819"></a>02819     <span class="comment">// WITHOUT the master key, which it will no longer have, outside of this</span>
<a name="l02820"></a>02820     <span class="comment">// wallet.</span>
<a name="l02821"></a>02821     <span class="comment">//</span>
<a name="l02822"></a>02822     <span class="keywordflow">if</span> (!(<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused()))
<a name="l02823"></a>02823     {
<a name="l02824"></a>02824         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Pause();
<a name="l02825"></a>02825     }
<a name="l02826"></a>02826     <span class="comment">// ----------------------</span>
<a name="l02827"></a>02827     <a class="code" href="class_o_t_string.html">OTString</a> strCertfile;
<a name="l02828"></a>02828     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSavedCert  = pNym-&gt;Savex509CertAndPrivateKeyToString(strCertfile, &amp;strReasonToSave);
<a name="l02829"></a>02829     <span class="comment">// ----------------------</span>
<a name="l02830"></a>02830     <span class="comment">// Unpause the master key.</span>
<a name="l02831"></a>02831     <span class="comment">//</span>
<a name="l02832"></a>02832     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;isPaused())
<a name="l02833"></a>02833     {
<a name="l02834"></a>02834         <a class="code" href="class_o_t_cached_key.html#a8780b8a3f392b0bc4c11253a797d8b5a">OTCachedKey::It</a>()-&gt;Unpause();
<a name="l02835"></a>02835     }
<a name="l02836"></a>02836     <span class="comment">// ----------------------</span>
<a name="l02837"></a>02837     <span class="keywordflow">if</span> (!bSavedCert)
<a name="l02838"></a>02838     {
<a name="l02839"></a>02839         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while calling pNym-&gt;Savex509CertAndPrivateKeyToString(strCertfile, \&quot;%s\&quot;)\n&quot;</span>,
<a name="l02840"></a>02840                       __FUNCTION__, thePWDataSave.<a class="code" href="class_o_t_password_data.html#afe04404b46712a5918790c3b4af7dda2">GetDisplayString</a>());
<a name="l02841"></a>02841         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02842"></a>02842     }
<a name="l02843"></a>02843     <span class="comment">// -----------------------------</span>
<a name="l02844"></a>02844     <span class="keywordflow">if</span> (strCertfile.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02845"></a>02845     {
<a name="l02846"></a>02846         strOutput.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;%s&quot;</span>, strCertfile.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02847"></a>02847         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02848"></a>02848     }
<a name="l02849"></a>02849     <span class="comment">// -----------------------------</span>
<a name="l02850"></a>02850 
<a name="l02851"></a>02851     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02852"></a>02852 }
<a name="l02853"></a>02853 
<a name="l02854"></a>02854 
<a name="l02855"></a>02855 <span class="comment">//bool  NumList::Peek(int64_t &amp; lPeek) const;</span>
<a name="l02856"></a>02856 <span class="comment">//bool  NumList::Pop();</span>
<a name="l02857"></a>02857 
<a name="l02858"></a>02858 
<a name="l02859"></a><a class="code" href="class_o_t___a_p_i.html#a12f34568b5ed20e3d1744f30e472f454">02859</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a12f34568b5ed20e3d1744f30e472f454">OT_API::NumList_Add</a>(<a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theList, <span class="keyword">const</span> <a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theNewNumbers)
<a name="l02860"></a>02860 {
<a name="l02861"></a>02861     <a class="code" href="class_o_t_num_list.html">OTNumList</a> tempNewList(theList);
<a name="l02862"></a>02862 
<a name="l02863"></a>02863     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = tempNewList.Add(theNewNumbers);
<a name="l02864"></a>02864 
<a name="l02865"></a>02865     <span class="keywordflow">if</span> (bSuccess)
<a name="l02866"></a>02866     {
<a name="l02867"></a>02867         theList.<a class="code" href="class_o_t_num_list.html#ab90b486b8dc6ac66a34724c6da4f7ec5">Release</a>();
<a name="l02868"></a>02868         theList.Add(tempNewList);
<a name="l02869"></a>02869         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02870"></a>02870     }
<a name="l02871"></a>02871     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02872"></a>02872 }
<a name="l02873"></a>02873 
<a name="l02874"></a><a class="code" href="class_o_t___a_p_i.html#a577cd1a86933ded118347ca37f537cee">02874</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a577cd1a86933ded118347ca37f537cee">OT_API::NumList_Remove</a>(<a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theList, <span class="keyword">const</span> <a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theOldNumbers)
<a name="l02875"></a>02875 {
<a name="l02876"></a>02876     <a class="code" href="class_o_t_num_list.html">OTNumList</a>   tempNewList(theList),
<a name="l02877"></a>02877                 tempOldList(theOldNumbers);
<a name="l02878"></a>02878 
<a name="l02879"></a>02879     <span class="keywordflow">while</span> (tempOldList.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>() &gt; 0)
<a name="l02880"></a>02880     {
<a name="l02881"></a>02881         int64_t lPeek=0;
<a name="l02882"></a>02882 
<a name="l02883"></a>02883         <span class="keywordflow">if</span> (!tempOldList.<a class="code" href="class_o_t_num_list.html#afbd8f3863c5c8330c851d30220cea8b9">Peek</a>(lPeek) || !tempOldList.<a class="code" href="class_o_t_num_list.html#a86c3f5ed864c1a6996f05d6430512c3c">Pop</a>())
<a name="l02884"></a>02884             <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l02885"></a>02885 
<a name="l02886"></a>02886         <span class="keywordflow">if</span> (!tempNewList.Remove(lPeek))
<a name="l02887"></a>02887             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02888"></a>02888     }
<a name="l02889"></a>02889 
<a name="l02890"></a>02890     theList.<a class="code" href="class_o_t_num_list.html#ab90b486b8dc6ac66a34724c6da4f7ec5">Release</a>();
<a name="l02891"></a>02891     theList.Add(tempNewList);
<a name="l02892"></a>02892     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02893"></a>02893 }
<a name="l02894"></a>02894 
<a name="l02895"></a>02895 
<a name="l02896"></a>02896 <span class="comment">// Verifies the presence of theQueryNumbers on theList (as a subset)</span>
<a name="l02897"></a>02897 <span class="comment">//</span>
<a name="l02898"></a><a class="code" href="class_o_t___a_p_i.html#ac2bbcfd6aa2d7a7bf0f6a78b4dd2a654">02898</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ac2bbcfd6aa2d7a7bf0f6a78b4dd2a654">OT_API::NumList_VerifyQuery</a>(<a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theList, <span class="keyword">const</span> <a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theQueryNumbers)
<a name="l02899"></a>02899 {
<a name="l02900"></a>02900     <a class="code" href="class_o_t_num_list.html">OTNumList</a> theTempQuery(theQueryNumbers);
<a name="l02901"></a>02901 
<a name="l02902"></a>02902     <span class="keywordflow">while</span> (theTempQuery.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>() &gt; 0)
<a name="l02903"></a>02903     {
<a name="l02904"></a>02904         int64_t lPeek=0;
<a name="l02905"></a>02905 
<a name="l02906"></a>02906         <span class="keywordflow">if</span> (!theTempQuery.<a class="code" href="class_o_t_num_list.html#afbd8f3863c5c8330c851d30220cea8b9">Peek</a>(lPeek) || !theTempQuery.<a class="code" href="class_o_t_num_list.html#a86c3f5ed864c1a6996f05d6430512c3c">Pop</a>())
<a name="l02907"></a>02907             <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l02908"></a>02908 
<a name="l02909"></a>02909         <span class="keywordflow">if</span> (!theList.<a class="code" href="class_o_t_num_list.html#ac9692a20a114672de9e02a18b1cdd5e6">Verify</a>(lPeek))
<a name="l02910"></a>02910             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02911"></a>02911     }
<a name="l02912"></a>02912 
<a name="l02913"></a>02913     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02914"></a>02914 }
<a name="l02915"></a>02915 
<a name="l02916"></a>02916 <span class="comment">// Verifies the COUNT and CONTENT (but not the order) matches EXACTLY.</span>
<a name="l02917"></a>02917 <span class="comment">//</span>
<a name="l02918"></a><a class="code" href="class_o_t___a_p_i.html#a909a6234b5e4dd04059a7e86f7883d1c">02918</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a909a6234b5e4dd04059a7e86f7883d1c">OT_API::NumList_VerifyAll</a>(<a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theList, <span class="keyword">const</span> <a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theQueryNumbers)
<a name="l02919"></a>02919 {
<a name="l02920"></a>02920     <span class="keywordflow">return</span> theList.<a class="code" href="class_o_t_num_list.html#ac9692a20a114672de9e02a18b1cdd5e6">Verify</a>(theQueryNumbers);
<a name="l02921"></a>02921 }
<a name="l02922"></a>02922 
<a name="l02923"></a><a class="code" href="class_o_t___a_p_i.html#ad6a7774af0f1af97fe6c36c396e054a3">02923</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ad6a7774af0f1af97fe6c36c396e054a3">OT_API::NumList_Count</a>(<a class="code" href="class_o_t_num_list.html">OTNumList</a> &amp; theList)
<a name="l02924"></a>02924 {
<a name="l02925"></a>02925     <span class="keywordflow">return</span> theList.<a class="code" href="class_o_t_num_list.html#a5772668ef4da7be4d83eb7c7c90838de">Count</a>();
<a name="l02926"></a>02926 }
<a name="l02927"></a>02927 
<a name="l02928"></a>02928 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02936"></a><a class="code" href="class_o_t___a_p_i.html#a2ff83b1c64286eafdf7af6360e138d6e">02936</a> <span class="comment"></span><a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> <a class="code" href="class_o_t___a_p_i.html#a2ff83b1c64286eafdf7af6360e138d6e">OT_API::GetTime</a>()
<a name="l02937"></a>02937 {
<a name="l02938"></a>02938     <span class="keywordflow">return</span> <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>();
<a name="l02939"></a>02939 }
<a name="l02940"></a>02940 
<a name="l02941"></a>02941 
<a name="l02942"></a>02942 
<a name="l02943"></a>02943 
<a name="l02944"></a>02944 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02957"></a><a class="code" href="class_o_t___a_p_i.html#a8f2b202917e923bfe9eeacd152493401">02957</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a8f2b202917e923bfe9eeacd152493401">OT_API::Encode</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strPlaintext, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput, <span class="keywordtype">bool</span> bLineBreaks<span class="comment">/*=true*/</span>)
<a name="l02958"></a>02958 {
<a name="l02959"></a>02959     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascArmor;
<a name="l02960"></a>02960     <span class="keywordtype">bool</span> bSuccess = ascArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strPlaintext, bLineBreaks); <span class="comment">// encodes.</span>
<a name="l02961"></a>02961 
<a name="l02962"></a>02962     <span class="keywordflow">if</span> (bSuccess)
<a name="l02963"></a>02963     {
<a name="l02964"></a>02964         strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l02965"></a>02965         bSuccess = ascArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput,
<a name="l02966"></a>02966                                                <span class="stringliteral">&quot;ENCODED TEXT&quot;</span> <span class="comment">// -----BEGIN OT ENCODED TEXT-----</span>
<a name="l02967"></a>02967                                                ); <span class="comment">// (bool bEscaped=false by default.)</span>
<a name="l02968"></a>02968     }
<a name="l02969"></a>02969     <span class="keywordflow">return</span> bSuccess;
<a name="l02970"></a>02970 }
<a name="l02971"></a>02971 
<a name="l02972"></a>02972 
<a name="l02973"></a>02973 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l02986"></a><a class="code" href="class_o_t___a_p_i.html#a3c5209f2f8ba1892edb5cf4614cd04a6">02986</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a3c5209f2f8ba1892edb5cf4614cd04a6">OT_API::Decode</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strEncoded, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput, <span class="keywordtype">bool</span> bLineBreaks<span class="comment">/*=true*/</span>)
<a name="l02987"></a>02987 {
<a name="l02988"></a>02988     <span class="comment">// -----------------------------------------------------</span>
<a name="l02989"></a>02989     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascArmor;
<a name="l02990"></a>02990     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadedArmor = <a class="code" href="class_o_t_a_s_c_i_i_armor.html#a6b5c0069db88e2c884d213ea64d3bbe4">OTASCIIArmor::LoadFromString</a>(ascArmor, strEncoded); <span class="comment">// str_bookend=&quot;-----BEGIN&quot; by default</span>
<a name="l02991"></a>02991     <span class="comment">// -----------------------------------------------------</span>
<a name="l02992"></a>02992     <span class="keywordflow">if</span> (!bLoadedArmor || !ascArmor.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02993"></a>02993     {
<a name="l02994"></a>02994         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading string into OTASCIIArmor object:\n\n%s\n\n&quot;</span>,
<a name="l02995"></a>02995                       __FUNCTION__, strEncoded.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02996"></a>02996         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02997"></a>02997     }
<a name="l02998"></a>02998     <span class="comment">// -------------------------------------------------</span>
<a name="l02999"></a>02999     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03000"></a>03000     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = ascArmor.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strOutput, bLineBreaks);
<a name="l03001"></a>03001     <span class="keywordflow">return</span> bSuccess;
<a name="l03002"></a>03002 }
<a name="l03003"></a>03003 
<a name="l03004"></a>03004 
<a name="l03005"></a>03005 
<a name="l03006"></a>03006 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03022"></a><a class="code" href="class_o_t___a_p_i.html#aa0fba0e8b0dbbe6a77bc443a6d99fa06">03022</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aa0fba0e8b0dbbe6a77bc443a6d99fa06">OT_API::Encrypt</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theRecipientNymID, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strPlaintext, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l03023"></a>03023 {
<a name="l03024"></a>03024     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::Encrypt&quot;</span>;
<a name="l03025"></a>03025     <span class="comment">// -----------------------------------------------------</span>
<a name="l03026"></a>03026     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a>);
<a name="l03027"></a>03027     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pRecipientNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">GetOrLoadNym</a>(theRecipientNymID, <span class="keyword">false</span>, szFuncName, &amp;thePWData); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03028"></a>03028     <span class="keywordflow">if</span> (NULL == pRecipientNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03029"></a>03029     <span class="comment">// -----------------------------------------------------</span>
<a name="l03030"></a>03030     <a class="code" href="class_o_t_envelope.html">OTEnvelope</a>      theEnvelope;
<a name="l03031"></a>03031     <span class="keywordtype">bool</span> bSuccess = theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pRecipientNym, strPlaintext);
<a name="l03032"></a>03032 
<a name="l03033"></a>03033     <span class="keywordflow">if</span> (bSuccess)
<a name="l03034"></a>03034     {
<a name="l03035"></a>03035         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascCiphertext(theEnvelope);
<a name="l03036"></a>03036         strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03037"></a>03037 
<a name="l03038"></a>03038         bSuccess = ascCiphertext.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput,
<a name="l03039"></a>03039                                                     <span class="stringliteral">&quot;ENCRYPTED TEXT&quot;</span> <span class="comment">// -----BEGIN OT ENCRYPTED TEXT-----</span>
<a name="l03040"></a>03040                                                     ); <span class="comment">// (bool bEscaped=false by default.)</span>
<a name="l03041"></a>03041     }
<a name="l03042"></a>03042     <span class="keywordflow">return</span> bSuccess;
<a name="l03043"></a>03043 }
<a name="l03044"></a>03044 
<a name="l03045"></a>03045 
<a name="l03046"></a>03046 
<a name="l03047"></a>03047 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03067"></a><a class="code" href="class_o_t___a_p_i.html#a864877a4f56fbbfee46ad8a650a1bb82">03067</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a864877a4f56fbbfee46ad8a650a1bb82">OT_API::Decrypt</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theRecipientNymID, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strCiphertext, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l03068"></a>03068 {
<a name="l03069"></a>03069     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pRecipientNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(theRecipientNymID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03070"></a>03070     <span class="keywordflow">if</span> (NULL == pRecipientNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03071"></a>03071     <span class="comment">// -----------------------------------------------------</span>
<a name="l03072"></a>03072     <a class="code" href="class_o_t_envelope.html">OTEnvelope</a>      theEnvelope;
<a name="l03073"></a>03073     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascCiphertext;
<a name="l03074"></a>03074     <span class="comment">// -----------------------------------------------------</span>
<a name="l03075"></a>03075     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoadedArmor = <a class="code" href="class_o_t_a_s_c_i_i_armor.html#a6b5c0069db88e2c884d213ea64d3bbe4">OTASCIIArmor::LoadFromString</a>(ascCiphertext, strCiphertext); <span class="comment">// str_bookend=&quot;-----BEGIN&quot; by default</span>
<a name="l03076"></a>03076     <span class="comment">// -----------------------------------------------------</span>
<a name="l03077"></a>03077     <span class="keywordflow">if</span> (!bLoadedArmor || !ascCiphertext.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03078"></a>03078     {
<a name="l03079"></a>03079         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure loading string into OTASCIIArmor object:\n\n%s\n\n&quot;</span>,
<a name="l03080"></a>03080                       __FUNCTION__, strCiphertext.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03081"></a>03081         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03082"></a>03082     }
<a name="l03083"></a>03083     <span class="comment">// -------------------------------------------------</span>
<a name="l03084"></a>03084     <span class="keywordflow">if</span> (theEnvelope.<a class="code" href="class_o_t_envelope.html#ad0d76f534bcda708b0298bcf906cb923">SetAsciiArmoredData</a>(ascCiphertext))
<a name="l03085"></a>03085     {
<a name="l03086"></a>03086         strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03087"></a>03087         <span class="keywordflow">return</span> theEnvelope.<a class="code" href="class_o_t_envelope.html#ae2e8fafc4e508ce5d323c089b71c7e7b">Open</a>(*pRecipientNym, strOutput);
<a name="l03088"></a>03088     }
<a name="l03089"></a>03089     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03090"></a>03090 }
<a name="l03091"></a>03091 
<a name="l03092"></a>03092 
<a name="l03093"></a>03093 
<a name="l03094"></a>03094 
<a name="l03095"></a>03095 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03101"></a><a class="code" href="class_o_t___a_p_i.html#a4decdc65f8b0a207a6057b86716e050a">03101</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a4decdc65f8b0a207a6057b86716e050a">OT_API::FlatSign</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp;   theSignerNymID,
<a name="l03102"></a>03102                       <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp;   strInput,
<a name="l03103"></a>03103                       <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp;   strContractType,
<a name="l03104"></a>03104                       <span class="comment">// ---------------------</span>
<a name="l03105"></a>03105                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp;   strOutput)
<a name="l03106"></a>03106 {
<a name="l03107"></a>03107     <span class="comment">// -----------------------------------------------------</span>
<a name="l03108"></a>03108     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(theSignerNymID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03109"></a>03109     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03110"></a>03110     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03111"></a>03111     <span class="comment">// -----------------------------------------------------</span>
<a name="l03112"></a>03112     <span class="keywordflow">if</span> (!strInput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03113"></a>03113     {
<a name="l03114"></a>03114         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Empty contract passed in. (Returning false.)\n&quot;</span>, __FUNCTION__);
<a name="l03115"></a>03115         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03116"></a>03116     }
<a name="l03117"></a>03117     <span class="comment">// ------------------------------------------------------------</span>
<a name="l03118"></a>03118     <span class="keywordflow">if</span> (!strContractType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03119"></a>03119     {
<a name="l03120"></a>03120         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Empty contract type passed in. (Returning false.)\n&quot;</span>, __FUNCTION__);
<a name="l03121"></a>03121         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03122"></a>03122     }
<a name="l03123"></a>03123     <span class="comment">// ------------------------------------------------------------</span>
<a name="l03124"></a>03124     <a class="code" href="class_o_t_string.html">OTString</a> strTemp(strInput);
<a name="l03125"></a>03125     <span class="keywordflow">return</span> <a class="code" href="class_o_t_contract.html#a00af7c67155cdb461866f6e705fde011">OTContract::SignFlatText</a>(strTemp, strContractType, *pNym, strOutput);
<a name="l03126"></a>03126 }
<a name="l03127"></a>03127 
<a name="l03128"></a>03128 
<a name="l03129"></a>03129 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03145"></a><a class="code" href="class_o_t___a_p_i.html#aa354b7ac168afd7cacfcf045241f4771">03145</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aa354b7ac168afd7cacfcf045241f4771">OT_API::SignContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theSignerNymID, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strContract, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l03146"></a>03146 {
<a name="l03147"></a>03147     <span class="comment">// -----------------------------------------------------</span>
<a name="l03148"></a>03148     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(theSignerNymID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03149"></a>03149     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03150"></a>03150     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03151"></a>03151     <span class="comment">// -----------------------------------------------------</span>
<a name="l03152"></a>03152     <span class="keywordflow">if</span> (!strContract.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03153"></a>03153     {
<a name="l03154"></a>03154         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Empty contract passed in. (Returning false.)\n&quot;</span>, __FUNCTION__);
<a name="l03155"></a>03155         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03156"></a>03156     }
<a name="l03157"></a>03157     <span class="comment">// ------------------------------------------------------------</span>
<a name="l03158"></a>03158     <span class="comment">//</span>
<a name="l03159"></a>03159     <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = NULL;
<a name="l03160"></a>03160 
<a name="l03161"></a>03161     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03162"></a>03162         pContract = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strContract);
<a name="l03163"></a>03163 
<a name="l03164"></a>03164     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03165"></a>03165         pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(strContract);
<a name="l03166"></a>03166 
<a name="l03167"></a>03167     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03168"></a>03168         pContract = <a class="code" href="class_o_t_contract.html#a3a4b4d7e43a53027a5e170557b9e7e12">OTContract::InstantiateContract</a>(strContract);
<a name="l03169"></a>03169 
<a name="l03170"></a>03170     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03171"></a>03171     {
<a name="l03172"></a>03172         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: I tried my best. &quot;</span>
<a name="l03173"></a>03173                        <span class="stringliteral">&quot;Unable to instantiate contract passed in:\n\n%s\n\n&quot;</span>,
<a name="l03174"></a>03174                        __FUNCTION__, strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03175"></a>03175         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03176"></a>03176     }
<a name="l03177"></a>03177 
<a name="l03178"></a>03178     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTContract&gt;</a> theAngel(*pContract);
<a name="l03179"></a>03179 
<a name="l03180"></a>03180     <span class="comment">// -----------------------------------------------------</span>
<a name="l03181"></a>03181     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03182"></a>03182     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03183"></a>03183     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03184"></a>03184     <span class="comment">// -----------------------------------------------------</span>
<a name="l03185"></a>03185     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03186"></a>03186     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03187"></a>03187     <span class="comment">// -----------------------------------------------------</span>
<a name="l03188"></a>03188     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03189"></a>03189 }
<a name="l03190"></a>03190 
<a name="l03191"></a>03191 
<a name="l03192"></a>03192 
<a name="l03193"></a>03193 
<a name="l03194"></a>03194 
<a name="l03195"></a>03195 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03210"></a><a class="code" href="class_o_t___a_p_i.html#ae5d31c92f0438b3c64ff5466c4e380e1">03210</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ae5d31c92f0438b3c64ff5466c4e380e1">OT_API::AddSignature</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theSignerNymID, <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strContract, <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l03211"></a>03211 {
<a name="l03212"></a>03212     <span class="comment">// -----------------------------------------------------</span>
<a name="l03213"></a>03213     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(theSignerNymID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03214"></a>03214     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03215"></a>03215     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03216"></a>03216     <span class="comment">// -----------------------------------------------------</span>
<a name="l03217"></a>03217     <span class="keywordflow">if</span> (!strContract.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03218"></a>03218     {
<a name="l03219"></a>03219         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Empty contract passed in. (Returning false.)\n&quot;</span>, __FUNCTION__);
<a name="l03220"></a>03220         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03221"></a>03221     }
<a name="l03222"></a>03222     <span class="comment">// ------------------------------------------------------------</span>
<a name="l03223"></a>03223     <span class="comment">//</span>
<a name="l03224"></a>03224     <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = NULL;
<a name="l03225"></a>03225 
<a name="l03226"></a>03226     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03227"></a>03227         pContract = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strContract);
<a name="l03228"></a>03228 
<a name="l03229"></a>03229     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03230"></a>03230         pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(strContract);
<a name="l03231"></a>03231 
<a name="l03232"></a>03232     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03233"></a>03233         pContract = <a class="code" href="class_o_t_contract.html#a3a4b4d7e43a53027a5e170557b9e7e12">OTContract::InstantiateContract</a>(strContract);
<a name="l03234"></a>03234 
<a name="l03235"></a>03235     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03236"></a>03236     {
<a name="l03237"></a>03237         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: I tried my best. Unable to instantiate contract passed in:\n\n%s\n\n&quot;</span>,
<a name="l03238"></a>03238                        __FUNCTION__, strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03239"></a>03239         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03240"></a>03240     }
<a name="l03241"></a>03241 
<a name="l03242"></a>03242     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTContract&gt;</a> theAngel(*pContract);
<a name="l03243"></a>03243 
<a name="l03244"></a>03244     <span class="comment">// -----------------------------------------------------</span>
<a name="l03245"></a>03245 <span class="comment">//  pContract-&gt;ReleaseSignatures();     // Other than this line, this function is identical to</span>
<a name="l03246"></a>03246                                         <span class="comment">// OT_API::SignContract(). (This one adds signatures without removing existing ones.)</span>
<a name="l03247"></a>03247     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03248"></a>03248     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03249"></a>03249     <span class="comment">// -----------------------------------------------------</span>
<a name="l03250"></a>03250     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03251"></a>03251     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03252"></a>03252     <span class="comment">// -----------------------------------------------------</span>
<a name="l03253"></a>03253     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03254"></a>03254 }
<a name="l03255"></a>03255 
<a name="l03256"></a>03256 
<a name="l03257"></a>03257 
<a name="l03258"></a>03258 
<a name="l03259"></a>03259 
<a name="l03260"></a>03260 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l03270"></a><a class="code" href="class_o_t___a_p_i.html#a1ffc5ff556721c5ab9fee696ea922ec1">03270</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a1ffc5ff556721c5ab9fee696ea922ec1">OT_API::VerifySignature</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strContract,
<a name="l03271"></a>03271                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theSignerNymID,
<a name="l03272"></a>03272                              <a class="code" href="class_o_t_contract.html">OTContract</a>         **ppContract<span class="comment">/*=NULL*/</span>) <span class="comment">// If you use this optional parameter, then YOU are responsible to clean it up.</span>
<a name="l03273"></a>03273 {
<a name="l03274"></a>03274     <span class="comment">// -----------------------------------------------------</span>
<a name="l03275"></a>03275     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a>);
<a name="l03276"></a>03276     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">GetOrLoadNym</a>(theSignerNymID, <span class="keyword">false</span>, __FUNCTION__, &amp;thePWData); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l03277"></a>03277     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03278"></a>03278     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03279"></a>03279     <span class="comment">// -----------------------------------------------------</span>
<a name="l03280"></a>03280     <span class="keywordflow">if</span> (!strContract.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l03281"></a>03281     {
<a name="l03282"></a>03282         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::VerifySignature: Empty contract passed in. (Returning false.)\n&quot;</span>);
<a name="l03283"></a>03283         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03284"></a>03284     }
<a name="l03285"></a>03285     <span class="comment">// ------------------------------------------------------------</span>
<a name="l03286"></a>03286     <span class="comment">//</span>
<a name="l03287"></a>03287     <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = NULL;
<a name="l03288"></a>03288     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTContract&gt;</a> theAngel;
<a name="l03289"></a>03289 
<a name="l03290"></a>03290     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03291"></a>03291         pContract = <a class="code" href="class_o_t_transaction_type.html#a3322a8680cb317a52691b17aa23da79d">OTTransactionType::TransactionFactory</a>(strContract);
<a name="l03292"></a>03292 
<a name="l03293"></a>03293     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03294"></a>03294         pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(strContract);
<a name="l03295"></a>03295 
<a name="l03296"></a>03296     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03297"></a>03297         pContract = <a class="code" href="class_o_t_contract.html#a3a4b4d7e43a53027a5e170557b9e7e12">OTContract::InstantiateContract</a>(strContract);
<a name="l03298"></a>03298 
<a name="l03299"></a>03299     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03300"></a>03300     {
<a name="l03301"></a>03301         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::VerifySignature: I tried my best. Unable to instantiate contract passed in:\n\n%s\n\n&quot;</span>,
<a name="l03302"></a>03302                        strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03303"></a>03303         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03304"></a>03304     }
<a name="l03305"></a>03305     <span class="comment">// -----------------------------------------------------</span>
<a name="l03306"></a>03306     <span class="comment">// Since we created it ourselves using a factory, we can do this:</span>
<a name="l03307"></a>03307 
<a name="l03308"></a>03308     <span class="comment">// -----------------------------------------------------</span>
<a name="l03309"></a>03309     <span class="comment">// The caller wants to take the contract for himself, without us cleaning</span>
<a name="l03310"></a>03310     <span class="comment">// it up in here.</span>
<a name="l03311"></a>03311     <span class="comment">//</span>
<a name="l03312"></a>03312     <span class="keywordflow">if</span> (NULL != ppContract)
<a name="l03313"></a>03313         *ppContract = pContract;
<a name="l03314"></a>03314     <span class="comment">// Else, we will clean it up ourselves...</span>
<a name="l03315"></a>03315     <span class="keywordflow">else</span>
<a name="l03316"></a>03316         theAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pContract);
<a name="l03317"></a>03317     <span class="comment">// -----------------------------------------------------</span>
<a name="l03318"></a>03318 <span class="comment">//  if (false == pContract-&gt;VerifyContractID())</span>
<a name="l03320"></a>03320 <span class="comment"></span><span class="comment">//  {                                           // Therefore it&#39;s only useful for server contracts and asset contracts. Here we can VerifyID and Signature,</span>
<a name="l03321"></a>03321 <span class="comment">//                                              // and that&#39;s good enough for here and most other places, generically speaking.</span>
<a name="l03322"></a>03322 <span class="comment">//      OTLog::vOutput(0, &quot;OT_API::VerifySignature: Unable to verify contract ID for contract passed in. NOTE: If you are experiencing &quot;</span>
<a name="l03323"></a>03323 <span class="comment">//                     &quot;a problem here, CONTACT FELLOW TRAVELER and let him know WHAT KIND OF CONTRACT, and what symptoms you are seeing, &quot;</span>
<a name="l03324"></a>03324 <span class="comment">//                     &quot;versus what you were expecting to see. Contract contents:\n\n%s\n\n&quot;,</span>
<a name="l03325"></a>03325 <span class="comment">//                     strContract.Get());</span>
<a name="l03326"></a>03326 <span class="comment">//      return false;</span>
<a name="l03327"></a>03327 <span class="comment">//  }</span>
<a name="l03328"></a>03328 
<a name="l03329"></a>03329     <span class="comment">// -----------------------------------------------------</span>
<a name="l03330"></a>03330     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym))
<a name="l03331"></a>03331     {
<a name="l03332"></a>03332         <a class="code" href="class_o_t_string.html">OTString</a> strSignerNymID(theSignerNymID);
<a name="l03333"></a>03333         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::VerifySignature: For Nym (%s), unable to verify signature on contract passed in:\n\n%s\n\n&quot;</span>,
<a name="l03334"></a>03334                        strSignerNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strContract.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03335"></a>03335         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03336"></a>03336     }
<a name="l03337"></a>03337     <span class="comment">// -----------------------------------------------------</span>
<a name="l03338"></a>03338 
<a name="l03339"></a>03339     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03340"></a>03340 }
<a name="l03341"></a>03341 
<a name="l03342"></a>03342 
<a name="l03343"></a>03343 <span class="comment">// --------------------------------------------------</span>
<a name="l03344"></a>03344 <span class="comment">// Verify and Retrieve XML Contents.</span>
<a name="l03345"></a>03345 <span class="comment">//</span>
<a name="l03346"></a>03346 <span class="comment">// Pass in a contract and a user ID, and this function will:</span>
<a name="l03347"></a>03347 <span class="comment">// -- Load the contract up and verify it.</span>
<a name="l03348"></a>03348 <span class="comment">// -- Verify the user&#39;s signature on it.</span>
<a name="l03349"></a>03349 <span class="comment">// -- Remove the PGP-style bookends (the signatures, etc)</span>
<a name="l03350"></a>03350 <span class="comment">// -- Output: the XML contents of the contract in string form.</span>
<a name="l03351"></a>03351 <span class="comment">// -- Returns: bool. (success/fail)</span>
<a name="l03352"></a>03352 <span class="comment">//</span>
<a name="l03353"></a><a class="code" href="class_o_t___a_p_i.html#ab941c58200fe040a3d432d54297c9fbe">03353</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ab941c58200fe040a3d432d54297c9fbe" title="Verify and Retrieve XML Contents.">OT_API::VerifyAndRetrieveXMLContents</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp;   strContract,
<a name="l03354"></a>03354                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp;   theSignerNymID,
<a name="l03355"></a>03355                                           <span class="comment">// ---------------------</span>
<a name="l03356"></a>03356                                           <a class="code" href="class_o_t_string.html">OTString</a>              &amp;   strOutput)
<a name="l03357"></a>03357 {
<a name="l03358"></a>03358     <a class="code" href="class_o_t_contract.html">OTContract</a> * pContract = NULL;
<a name="l03359"></a>03359     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a1ffc5ff556721c5ab9fee696ea922ec1">VerifySignature</a>(strContract, theSignerNymID, &amp;pContract);
<a name="l03360"></a>03360     <span class="comment">//</span>
<a name="l03361"></a>03361     <span class="comment">// If pContract is not NULL after the above call, then this Cleanup object</span>
<a name="l03362"></a>03362     <span class="comment">// will clean it up after we leave the scope of this block.</span>
<a name="l03363"></a>03363     <span class="comment">//</span>
<a name="l03364"></a>03364     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTContract&gt;</a> theAngel(pContract);
<a name="l03365"></a>03365     <span class="comment">// -----------------------------------------------------</span>
<a name="l03366"></a>03366     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03367"></a>03367 
<a name="l03368"></a>03368     <span class="keywordflow">if</span> (NULL != pContract) <span class="comment">// pContract will always exist, if we were successful.</span>
<a name="l03369"></a>03369         <span class="keywordflow">return</span> (bSuccess &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput));
<a name="l03370"></a>03370 
<a name="l03371"></a>03371     <span class="keywordflow">return</span> bSuccess; <span class="comment">// In practice this will only happen on failure. (Could have put &quot;return false&quot;.)</span>
<a name="l03372"></a>03372 }
<a name="l03373"></a>03373 
<a name="l03374"></a>03374 
<a name="l03375"></a>03375 
<a name="l03381"></a><a class="code" href="class_o_t___a_p_i.html#a6db6ca5618edfb53c7a8a7bc38e4bd0e">03381</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a6db6ca5618edfb53c7a8a7bc38e4bd0e">OT_API::VerifyAccountReceipt</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l03382"></a>03382                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l03383"></a>03383                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l03384"></a>03384 {
<a name="l03385"></a>03385     <span class="comment">// -----------------------------------------------------</span>
<a name="l03386"></a>03386     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03387"></a>03387     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03388"></a>03388     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03389"></a>03389     <span class="comment">// -----------------------------------------------------</span>
<a name="l03390"></a>03390     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l03391"></a>03391     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03392"></a>03392     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l03393"></a>03393     <span class="comment">// -----------------------------------------------------</span>
<a name="l03394"></a>03394     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = <span class="keyword">const_cast&lt;</span><a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *<span class="keyword">&gt;</span>(pServer-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>());
<a name="l03395"></a>03395     <span class="keywordflow">if</span> (NULL == pServerNym) { <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::VerifyAccountReceipt: should never happen. pServerNym is NULL.\n&quot;</span>); <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l03396"></a>03396     <span class="comment">// -----------------------------------------------------</span>
<a name="l03397"></a>03397     <span class="keywordflow">return</span> <a class="code" href="class_o_t_transaction.html#ae4bcd8edaf9b3cb72b0a68d503af804c">OTTransaction::VerifyBalanceReceipt</a>(*pServerNym,
<a name="l03398"></a>03398                                                *pNym,
<a name="l03399"></a>03399                                                SERVER_ID,
<a name="l03400"></a>03400                                                ACCOUNT_ID);
<a name="l03401"></a>03401 }
<a name="l03402"></a>03402 
<a name="l03403"></a>03403 
<a name="l03404"></a>03404 
<a name="l03405"></a>03405 
<a name="l03406"></a>03406 
<a name="l03407"></a>03407 
<a name="l03408"></a><a class="code" href="class_o_t___a_p_i.html#acdcf4e8ee01eb5684ad276a9f2f96ad6">03408</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#acdcf4e8ee01eb5684ad276a9f2f96ad6">OT_API::Create_SmartContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SIGNER_NYM_ID,<span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03409"></a>03409                                   <span class="comment">// ----------------------------------------</span>
<a name="l03410"></a>03410                                   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      VALID_FROM, <span class="comment">// Default (0 or NULL) == NOW</span>
<a name="l03411"></a>03411                                   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>      VALID_TO,   <span class="comment">// Default (0 or NULL) == no expiry / cancel anytime</span>
<a name="l03412"></a>03412                                   <a class="code" href="class_o_t_string.html">OTString</a> &amp; strOutput)
<a name="l03413"></a>03413 {
<a name="l03414"></a>03414     <span class="comment">// -----------------------------------------------------</span>
<a name="l03415"></a>03415     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03416"></a>03416     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03417"></a>03417     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03418"></a>03418     <span class="comment">// -----------------------------------------------------</span>
<a name="l03419"></a>03419     <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a>();
<a name="l03420"></a>03420     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;OT_API::Create_SmartContract: ASSERT while trying to instantiate blank smart contract.\n&quot;</span>);
<a name="l03421"></a>03421     <span class="comment">// --------------------------------</span>
<a name="l03422"></a>03422     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_cron_item.html#ab6f1e6febdeb0f6042d751503e648107">SetDateRange</a>(VALID_FROM,  VALID_TO))
<a name="l03423"></a>03423     {
<a name="l03424"></a>03424         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::Create_SmartContract: Failed trying to set date range.\n&quot;</span>);
<a name="l03425"></a>03425         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03426"></a>03426     }
<a name="l03427"></a>03427     <span class="comment">// -----------------------------------------------------</span>
<a name="l03428"></a>03428     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03429"></a>03429     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03430"></a>03430     <span class="comment">// -----------------------------------------------------</span>
<a name="l03431"></a>03431     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03432"></a>03432     <span class="comment">// -----------------------------------------------------</span>
<a name="l03433"></a>03433     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03434"></a>03434     <span class="comment">// -----------------------------------------------------</span>
<a name="l03435"></a>03435     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03436"></a>03436 }
<a name="l03437"></a>03437 
<a name="l03438"></a>03438 
<a name="l03439"></a>03439 
<a name="l03440"></a>03440 
<a name="l03441"></a><a class="code" href="class_o_t___a_p_i.html#a357d0c597723cd9b03bb77b8636ec1ca">03441</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a357d0c597723cd9b03bb77b8636ec1ca">OT_API::SmartContract_AddParty</a>(<span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT,     <span class="comment">// The contract, about to have the bylaw added to it.</span>
<a name="l03442"></a>03442                                     <span class="keyword">const</span>   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03443"></a>03443                                     <span class="comment">// ----------------------------------------</span>
<a name="l03444"></a>03444                                     <span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>        &amp; PARTY_NAME,       <span class="comment">// The Party&#39;s NAME as referenced in the smart contract. (And the scripts...)</span>
<a name="l03445"></a>03445                                     <span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>        &amp; AGENT_NAME,       <span class="comment">// An AGENT will be added by default for this party. Need Agent NAME.</span>
<a name="l03446"></a>03446                                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l03447"></a>03447 {
<a name="l03448"></a>03448     <span class="comment">// -----------------------------------------------------</span>
<a name="l03449"></a>03449     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03450"></a>03450     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03451"></a>03451     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03452"></a>03452     <span class="comment">// -----------------------------------------------------</span>
<a name="l03453"></a>03453     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03454"></a>03454     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03455"></a>03455     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03456"></a>03456     {
<a name="l03457"></a>03457         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03458"></a>03458                        __FUNCTION__, THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03459"></a>03459         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03460"></a>03460     }
<a name="l03461"></a>03461     <span class="keywordflow">else</span>
<a name="l03462"></a>03462         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03463"></a>03463     <span class="comment">// -----------------------------------------------------</span>
<a name="l03464"></a>03464     <span class="keyword">const</span> std::string str_party_name(PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_agent_name(AGENT_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03465"></a>03465 
<a name="l03466"></a>03466     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l03467"></a>03467 
<a name="l03468"></a>03468     <span class="keywordflow">if</span> (NULL != pParty)
<a name="l03469"></a>03469     {
<a name="l03470"></a>03470         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Party already exists. \n&quot;</span>, __FUNCTION__);
<a name="l03471"></a>03471         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03472"></a>03472     }
<a name="l03473"></a>03473     <span class="comment">// -------------------------------</span>
<a name="l03474"></a>03474 
<a name="l03475"></a>03475     pParty = <span class="keyword">new</span> <a class="code" href="class_o_t_party.html">OTParty</a>(str_party_name.c_str(), <span class="keyword">true</span> <span class="comment">/*bIsOwnerNym*/</span>,
<a name="l03476"></a>03476                          NULL<span class="comment">/*OwnerID not set until confirm*/</span>, str_agent_name.c_str(),
<a name="l03477"></a>03477                          <span class="keyword">true</span>); <span class="comment">//bCreateAgent=false by default.</span>
<a name="l03478"></a>03478     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l03479"></a>03479 
<a name="l03480"></a>03480     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_scriptable.html#accfde75655f5c49c041ef3a5fbff54e6">AddParty</a>(*pParty)) <span class="comment">// takes ownership.</span>
<a name="l03481"></a>03481     {
<a name="l03482"></a>03482         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed while trying to add party: %s \n&quot;</span>,
<a name="l03483"></a>03483                        __FUNCTION__, PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03484"></a>03484         <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l03485"></a>03485         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03486"></a>03486     }
<a name="l03487"></a>03487     <span class="comment">// ------------------</span>
<a name="l03488"></a>03488     <span class="comment">// Success!</span>
<a name="l03489"></a>03489     <span class="comment">//</span>
<a name="l03490"></a>03490     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03491"></a>03491     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03492"></a>03492     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03493"></a>03493     <span class="comment">// ------------------</span>
<a name="l03494"></a>03494     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03495"></a>03495     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03496"></a>03496     <span class="comment">// ------------------</span>
<a name="l03497"></a>03497     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03498"></a>03498 }
<a name="l03499"></a>03499 
<a name="l03500"></a>03500 
<a name="l03501"></a>03501 
<a name="l03502"></a><a class="code" href="class_o_t___a_p_i.html#a47bbd248e72e8d45609a5365f7fa5187">03502</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a47bbd248e72e8d45609a5365f7fa5187">OT_API::SmartContract_AddAccount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT,     <span class="comment">// The contract, about to have the clause added to it.</span>
<a name="l03503"></a>03503                                       <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03504"></a>03504                                       <span class="comment">// ----------------------------------------</span>
<a name="l03505"></a>03505                                       <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp; PARTY_NAME,       <span class="comment">// The Party&#39;s NAME as referenced in the smart contract. (And the scripts...)</span>
<a name="l03506"></a>03506                                       <span class="comment">// ----------------------------------------</span>
<a name="l03507"></a>03507                                       <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp; ACCT_NAME,        <span class="comment">// The Account&#39;s name as referenced in the smart contract</span>
<a name="l03508"></a>03508                                       <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>        &amp; ASSET_TYPE_ID,    <span class="comment">// Asset Type ID for the Account.</span>
<a name="l03509"></a>03509                                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l03510"></a>03510 {
<a name="l03511"></a>03511     <span class="comment">// -----------------------------------------------------</span>
<a name="l03512"></a>03512     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03513"></a>03513     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03514"></a>03514     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03515"></a>03515     <span class="comment">// -----------------------------------------------------</span>
<a name="l03516"></a>03516     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03517"></a>03517     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03518"></a>03518     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03519"></a>03519     {
<a name="l03520"></a>03520         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddAccount: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03521"></a>03521                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03522"></a>03522         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03523"></a>03523     }
<a name="l03524"></a>03524     <span class="keywordflow">else</span>
<a name="l03525"></a>03525         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03526"></a>03526     <span class="comment">// -----------------------------------------------------</span>
<a name="l03527"></a>03527     <span class="keyword">const</span> std::string str_party_name(PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03528"></a>03528 
<a name="l03529"></a>03529     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l03530"></a>03530 
<a name="l03531"></a>03531     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l03532"></a>03532     {
<a name="l03533"></a>03533         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddAccount: Failure: Party doesn&#39;t exist. \n&quot;</span>);
<a name="l03534"></a>03534         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03535"></a>03535     }
<a name="l03536"></a>03536     <span class="comment">// -------------------------------</span>
<a name="l03537"></a>03537     <span class="keyword">const</span> std::string str_name(ACCT_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_asset_id(ASSET_TYPE_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03538"></a>03538 
<a name="l03539"></a>03539     <span class="keywordflow">if</span> (NULL != pParty-&gt;GetAccount(str_name))
<a name="l03540"></a>03540     {
<a name="l03541"></a>03541         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddAccount: Failed adding: account is already there with that name (%s) on party: %s \n&quot;</span>,
<a name="l03542"></a>03542                        str_name.c_str(), str_party_name.c_str());
<a name="l03543"></a>03543         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03544"></a>03544     }
<a name="l03545"></a>03545     <span class="comment">// ---------------------------------------------</span>
<a name="l03546"></a>03546     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAgentName, strAcctName(str_name.c_str()), strAcctID, strAssetTypeID(str_asset_id.c_str());
<a name="l03547"></a>03547 
<a name="l03548"></a>03548     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;AddAccount(strAgentName, strAcctName, strAcctID, strAssetTypeID, 0))
<a name="l03549"></a>03549     {
<a name="l03550"></a>03550         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddAccount: Failed trying to add account (%s) to party: %s \n&quot;</span>,
<a name="l03551"></a>03551                        str_name.c_str(), str_party_name.c_str());
<a name="l03552"></a>03552         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03553"></a>03553     }
<a name="l03554"></a>03554     <span class="comment">// -------------------------------</span>
<a name="l03555"></a>03555     <span class="comment">// Success!</span>
<a name="l03556"></a>03556     <span class="comment">//</span>
<a name="l03557"></a>03557     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03558"></a>03558     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03559"></a>03559     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03560"></a>03560     <span class="comment">// ------------------</span>
<a name="l03561"></a>03561     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03562"></a>03562     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03563"></a>03563     <span class="comment">// ------------------</span>
<a name="l03564"></a>03564     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03565"></a>03565 }
<a name="l03566"></a>03566 
<a name="l03567"></a>03567 
<a name="l03568"></a>03568 
<a name="l03569"></a>03569 
<a name="l03570"></a><a class="code" href="class_o_t___a_p_i.html#ae9ebf14defb8aa50c6c40a1b20fbe20d">03570</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ae9ebf14defb8aa50c6c40a1b20fbe20d">OT_API::SmartContract_CountNumsNeeded</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; THE_CONTRACT,     <span class="comment">// The contract, about to have the bylaw added to it.</span>
<a name="l03571"></a>03571                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; AGENT_NAME)       <span class="comment">// An AGENT will be added by default for this party. Need Agent NAME.</span>
<a name="l03572"></a>03572 {
<a name="l03573"></a>03573     int32_t nReturnValue = 0;
<a name="l03574"></a>03574     <span class="keyword">const</span> std::string   str_agent_name(AGENT_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03575"></a>03575     <span class="comment">// ----------------------------------------------------</span>
<a name="l03576"></a>03576     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03577"></a>03577     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03578"></a>03578 
<a name="l03579"></a>03579     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03580"></a>03580     {
<a name="l03581"></a>03581         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_CountNumsNeeded: Error loading smart contract. \n&quot;</span>);
<a name="l03582"></a>03582         <span class="keywordflow">return</span> nReturnValue;
<a name="l03583"></a>03583     }
<a name="l03584"></a>03584     <span class="keywordflow">else</span>
<a name="l03585"></a>03585         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03586"></a>03586     <span class="comment">// -----------------------------------------------------</span>
<a name="l03587"></a>03587     <span class="comment">// -- nReturnValue starts as 0.</span>
<a name="l03588"></a>03588     <span class="comment">// -- If agent is authorizing agent for a party, nReturnValue++. (Opening number.)</span>
<a name="l03589"></a>03589     <span class="comment">// -- If agent is authorized agent for any of party&#39;s accts, nReturnValue++ for each. (Closing numbers.)</span>
<a name="l03590"></a>03590     <span class="comment">//</span>
<a name="l03591"></a>03591     <span class="comment">// (Then return the count.)</span>
<a name="l03592"></a>03592 
<a name="l03593"></a>03593     nReturnValue = pContract-&gt;GetCountTransNumsNeededForAgent(str_agent_name);
<a name="l03594"></a>03594     <span class="comment">// ----------------------------------------------------</span>
<a name="l03595"></a>03595     <span class="keywordflow">return</span> nReturnValue;
<a name="l03596"></a>03596 }
<a name="l03597"></a>03597 
<a name="l03598"></a>03598 
<a name="l03599"></a>03599 
<a name="l03600"></a>03600 
<a name="l03601"></a>03601 
<a name="l03602"></a><a class="code" href="class_o_t___a_p_i.html#a10954b356a026ea6729ece4d16b281eb">03602</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a10954b356a026ea6729ece4d16b281eb">OT_API::SmartContract_ConfirmAccount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; THE_CONTRACT,
<a name="l03603"></a>03603                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>&amp; SIGNER_NYM_ID,
<a name="l03604"></a>03604                                           <span class="comment">// -----------------------------</span>
<a name="l03605"></a>03605                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; PARTY_NAME,
<a name="l03606"></a>03606                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; ACCT_NAME,
<a name="l03607"></a>03607                                           <span class="comment">// -----------------------------</span>
<a name="l03608"></a>03608                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; AGENT_NAME,
<a name="l03609"></a>03609                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>    &amp; ACCT_ID,
<a name="l03610"></a>03610                                                 <a class="code" href="class_o_t_string.html">OTString</a>    &amp; strOutput)
<a name="l03611"></a>03611 {
<a name="l03612"></a>03612     <span class="comment">// -----------------------------------------------------</span>
<a name="l03613"></a>03613     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03614"></a>03614     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03615"></a>03615     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03616"></a>03616     <span class="comment">// -----------------------------------------------------</span>
<a name="l03617"></a>03617     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAcctID(ACCT_ID);
<a name="l03618"></a>03618     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(theAcctID, __FUNCTION__);
<a name="l03619"></a>03619     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03620"></a>03620     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03621"></a>03621     <span class="comment">// -----------------------------------------------------</span>
<a name="l03622"></a>03622     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pScriptable = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03623"></a>03623     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03624"></a>03624     <span class="keywordflow">if</span> (NULL == pScriptable)
<a name="l03625"></a>03625     {
<a name="l03626"></a>03626         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03627"></a>03627                        __FUNCTION__, THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03628"></a>03628         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03629"></a>03629     }
<a name="l03630"></a>03630     <span class="keywordflow">else</span>
<a name="l03631"></a>03631         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pScriptable);  <span class="comment">// Auto-cleanup.</span>
<a name="l03632"></a>03632     <span class="comment">// -----------------------------------------------------</span>
<a name="l03633"></a>03633     <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pContract = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pScriptable);
<a name="l03634"></a>03634     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03635"></a>03635     {
<a name="l03636"></a>03636         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure casting to Smart Contract. &quot;</span>
<a name="l03637"></a>03637                        <span class="stringliteral">&quot;Are you SURE it&#39;s a smart contract? Contents:\n&quot;</span>
<a name="l03638"></a>03638                        <span class="stringliteral">&quot;%s\n&quot;</span>, __FUNCTION__, THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03639"></a>03639         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03640"></a>03640     }
<a name="l03641"></a>03641     <span class="comment">// -----------------------------------------------------</span>
<a name="l03642"></a>03642     <span class="keyword">const</span> std::string str_party_name(PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03643"></a>03643     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l03644"></a>03644     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l03645"></a>03645     {
<a name="l03646"></a>03646         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Party doesn&#39;t exist: %s \n&quot;</span>,
<a name="l03647"></a>03647                        __FUNCTION__, PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03648"></a>03648         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03649"></a>03649     }
<a name="l03650"></a>03650     <span class="comment">// ---------------------------------------------</span>
<a name="l03651"></a>03651     <span class="comment">// Make sure there&#39;s not already an account here with the same ID (Server disallows.)</span>
<a name="l03652"></a>03652     <span class="comment">//</span>
<a name="l03653"></a>03653     <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pDupeAcct = pParty-&gt;GetAccountByID(theAcctID);
<a name="l03654"></a>03654     <span class="keywordflow">if</span> (NULL != pDupeAcct) <span class="comment">// It&#39;s already there.</span>
<a name="l03655"></a>03655     {
<a name="l03656"></a>03656         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed, since a duplicate account ID (%s) &quot;</span>
<a name="l03657"></a>03657                        <span class="stringliteral">&quot;was already found on this contract. (Server disallows, sorry.)\n&quot;</span>,
<a name="l03658"></a>03658                         __FUNCTION__, ACCT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03659"></a>03659         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03660"></a>03660     }
<a name="l03661"></a>03661     <span class="comment">// ---------------------------------------------</span>
<a name="l03662"></a>03662     <span class="comment">// Find the account template based on its name, to affix the acct ID to.</span>
<a name="l03663"></a>03663     <span class="comment">//</span>
<a name="l03664"></a>03664     <span class="keyword">const</span> std::string str_name(ACCT_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03665"></a>03665 
<a name="l03666"></a>03666     <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pPartyAcct = pParty-&gt;GetAccount(str_name);
<a name="l03667"></a>03667     <span class="keywordflow">if</span> (NULL == pPartyAcct) <span class="comment">// It&#39;s not already there. (Though it should be...)</span>
<a name="l03668"></a>03668     {
<a name="l03669"></a>03669         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed: No account found on contract with name: %s \n&quot;</span>,
<a name="l03670"></a>03670                         __FUNCTION__, str_name.c_str());
<a name="l03671"></a>03671         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03672"></a>03672     }
<a name="l03673"></a>03673     <span class="comment">// ---------------------------------------------</span>
<a name="l03674"></a>03674     <span class="comment">// the actual asset type ID</span>
<a name="l03675"></a>03675 
<a name="l03676"></a>03676     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  theExpectedAssetTypeID(pPartyAcct-&gt;GetAssetTypeID()); <span class="comment">// The expected asset type ID, converting from a string.</span>
<a name="l03677"></a>03677     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>&amp; theActualAssetTypeID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();    <span class="comment">// the actual asset type ID, already an identifier, from the actual account.</span>
<a name="l03678"></a>03678 
<a name="l03679"></a>03679     <span class="keywordflow">if</span> (theExpectedAssetTypeID != theActualAssetTypeID)
<a name="l03680"></a>03680     {
<a name="l03681"></a>03681         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(theActualAssetTypeID);
<a name="l03682"></a>03682         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed, since the asset type ID of the account (%s) &quot;</span>
<a name="l03683"></a>03683                        <span class="stringliteral">&quot;does not match what was expected (%s) according to this contract.\n&quot;</span>,
<a name="l03684"></a>03684                         __FUNCTION__, strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), pPartyAcct-&gt;GetAssetTypeID().Get());
<a name="l03685"></a>03685         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03686"></a>03686     }
<a name="l03687"></a>03687     <span class="comment">// ---------------------------------------------</span>
<a name="l03688"></a>03688     <span class="comment">// I&#39;m leaving this here for now, since a party can only be a Nym for now anyway (until I code entities.)</span>
<a name="l03689"></a>03689     <span class="comment">// Therefore this account COULD ONLY be owned by that Nym anyway, and thus will pass this test.</span>
<a name="l03690"></a>03690     <span class="comment">// All the above functions aren&#39;t that stringent because they are about designing the smart contract, not</span>
<a name="l03691"></a>03691     <span class="comment">// executing it. But in THIS case, we are actually confirming the thing, and adding our actual account #s</span>
<a name="l03692"></a>03692     <span class="comment">// to it, signing it, etc, so I might as well save the person the hassle of being rejected later because</span>
<a name="l03693"></a>03693     <span class="comment">// he accidentally set it up with the wrong Nym.</span>
<a name="l03694"></a>03694     <span class="comment">//</span>
<a name="l03695"></a>03695     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAccount-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pNym))
<a name="l03696"></a>03696     {
<a name="l03697"></a>03697         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(SIGNER_NYM_ID);
<a name="l03698"></a>03698         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed, since this nym (%s) isn&#39;t the owner of this account (%s).\n&quot;</span>,
<a name="l03699"></a>03699                         __FUNCTION__, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), str_name.c_str());
<a name="l03700"></a>03700         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03701"></a>03701     }
<a name="l03702"></a>03702     <span class="comment">// ---------------------------------------------</span>
<a name="l03703"></a>03703     <span class="comment">// When the first ACCOUNT is confirmed, then at that moment, we know which server</span>
<a name="l03704"></a>03704     <span class="comment">// this smart contract is intended to execute on.</span>
<a name="l03705"></a>03705     <span class="comment">//</span>
<a name="l03706"></a>03706     <span class="comment">// If this is the first account being confirmed, then we will set the server ID</span>
<a name="l03707"></a>03707     <span class="comment">// for the smart contract based on the server ID of this account. Otherwise if this</span>
<a name="l03708"></a>03708     <span class="comment">// is not the first account being confirmed, then we will compare the server ID</span>
<a name="l03709"></a>03709     <span class="comment">// that&#39;s already on the smart contract, to the server ID for this account, and make</span>
<a name="l03710"></a>03710     <span class="comment">// sure they match. (Otherwise we will reject the confirmation.)</span>
<a name="l03711"></a>03711     <span class="comment">//</span>
<a name="l03712"></a>03712     <span class="comment">// Once the contract is activated, the server will verify all the parties and accounts</span>
<a name="l03713"></a>03713     <span class="comment">// anyway. So might as well save ourselves the hassle, if this doesn&#39;t match up now.</span>
<a name="l03714"></a>03714     <span class="comment">//</span>
<a name="l03715"></a>03715     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_smart_contract.html#aa4d0e2f242f874a9a594a31d8af26533">SetServerIDIfEmpty</a>(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>()))
<a name="l03716"></a>03716     {
<a name="l03717"></a>03717         <span class="comment">// todo security: possibly want to verify here that this really is the FIRST</span>
<a name="l03718"></a>03718         <span class="comment">// account being confirmed in this smart contract, or at least the first party.</span>
<a name="l03719"></a>03719         <span class="comment">// Right now we&#39;re just using the server ID being empty as an easy way to find</span>
<a name="l03720"></a>03720         <span class="comment">// out, but technically a party could slip in a &quot;signed version&quot; without setting</span>
<a name="l03721"></a>03721         <span class="comment">// the server ID, and it might slip by here (though it would eventually fail some</span>
<a name="l03722"></a>03722         <span class="comment">// verification.) In the int64_t term we&#39;ll do a more thorough check here, though.</span>
<a name="l03723"></a>03723     }
<a name="l03724"></a>03724     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() != pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>())
<a name="l03725"></a>03725     {
<a name="l03726"></a>03726         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServer1(pContract-&gt;<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>()),
<a name="l03727"></a>03727                        strServer2(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>());
<a name="l03728"></a>03728         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: The smart contract has a different server ID on it already (%s) &quot;</span>
<a name="l03729"></a>03729                        <span class="stringliteral">&quot;than the one that goes with this account (server %s, for account %s)\n&quot;</span>,
<a name="l03730"></a>03730                        __FUNCTION__, strServer1.Get(), strServer2.Get(), ACCT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03731"></a>03731         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03732"></a>03732     }
<a name="l03733"></a>03733     <span class="comment">// ---------------------------------------------</span>
<a name="l03734"></a>03734     <span class="comment">// BY THIS POINT, we know that the account is actually owned by the Nym,</span>
<a name="l03735"></a>03735     <span class="comment">// and we know that it&#39;s got the proper asset type ID that was expected</span>
<a name="l03736"></a>03736     <span class="comment">// according to the smart contract. We also know that the smart contract</span>
<a name="l03737"></a>03737     <span class="comment">// has the same server ID as the account being confirmed.</span>
<a name="l03738"></a>03738     <span class="comment">//</span>
<a name="l03739"></a>03739     pPartyAcct-&gt;SetAcctID(ACCT_ID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03740"></a>03740     pPartyAcct-&gt;SetAgentName(AGENT_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03741"></a>03741     <span class="comment">// -------------------------------</span>
<a name="l03742"></a>03742     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03743"></a>03743     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03744"></a>03744     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03745"></a>03745     <span class="comment">// -------------------------------</span>
<a name="l03746"></a>03746     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03747"></a>03747     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03748"></a>03748     <span class="comment">// -------------------------------</span>
<a name="l03749"></a>03749     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03750"></a>03750 }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752 
<a name="l03753"></a>03753 
<a name="l03754"></a>03754 
<a name="l03755"></a><a class="code" href="class_o_t___a_p_i.html#a3c1974fc1798d311264ff55ef1724dcf">03755</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a3c1974fc1798d311264ff55ef1724dcf">OT_API::SmartContract_ConfirmParty</a>(<span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>    &amp; THE_CONTRACT, <span class="comment">// The smart contract, about to be changed by this function.</span>
<a name="l03756"></a>03756                                         <span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>    &amp; PARTY_NAME,   <span class="comment">// Should already be on the contract. This way we can find it.</span>
<a name="l03757"></a>03757                                         <span class="comment">// ----------------------------------------</span>
<a name="l03758"></a>03758                                         <span class="keyword">const</span>   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>&amp; NYM_ID,       <span class="comment">// Nym ID for the party, the actual owner,</span>
<a name="l03759"></a>03759                                                 <a class="code" href="class_o_t_string.html">OTString</a>    &amp; strOutput)    <span class="comment">// ===&gt; AS WELL AS for the default AGENT of that party. (For now, until I code entities)</span>
<a name="l03760"></a>03760 {
<a name="l03761"></a>03761     <span class="comment">// -----------------------------------------------------</span>
<a name="l03762"></a>03762     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03763"></a>03763     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03764"></a>03764     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03765"></a>03765     <span class="comment">// -----------------------------------------------------</span>
<a name="l03766"></a>03766     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03767"></a>03767     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03768"></a>03768 
<a name="l03769"></a>03769     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03770"></a>03770     {
<a name="l03771"></a>03771         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03772"></a>03772                         __FUNCTION__, THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03773"></a>03773         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03774"></a>03774     }
<a name="l03775"></a>03775     <span class="keywordflow">else</span>
<a name="l03776"></a>03776         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03777"></a>03777     <span class="comment">// -----------------------------------------------------</span>
<a name="l03778"></a>03778     <span class="keyword">const</span> std::string str_party_name(PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03779"></a>03779 
<a name="l03780"></a>03780     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l03781"></a>03781 
<a name="l03782"></a>03782     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l03783"></a>03783     {
<a name="l03784"></a>03784         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Party (%s) doesn&#39;t exist, so how can you confirm it?\n&quot;</span>,
<a name="l03785"></a>03785                         __FUNCTION__, str_party_name.c_str());
<a name="l03786"></a>03786         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03787"></a>03787     }
<a name="l03788"></a>03788     <span class="comment">// -------------------------------</span>
<a name="l03789"></a>03789     <a class="code" href="class_o_t_party.html">OTParty</a> * pNewParty = <span class="keyword">new</span> <a class="code" href="class_o_t_party.html">OTParty</a>(pParty-&gt;GetPartyName(), *pNym, <span class="comment">// party keeps an internal pointer to pNym from here on.</span>
<a name="l03790"></a>03790                                       pParty-&gt;GetAuthorizingAgentName()); <span class="comment">// Party name and agent name must match, in order to replace / activate this party.</span>
<a name="l03791"></a>03791     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNewParty);
<a name="l03792"></a>03792     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;CopyAcctsToConfirmingParty(*pNewParty))
<a name="l03793"></a>03793     {
<a name="l03794"></a>03794         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed while trying to copy accounts, while confirming party: %s \n&quot;</span>,
<a name="l03795"></a>03795                         __FUNCTION__, PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03796"></a>03796         <span class="keyword">delete</span> pNewParty; pNewParty=NULL;
<a name="l03797"></a>03797         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03798"></a>03798     }
<a name="l03799"></a>03799     <span class="comment">// ------------------</span>
<a name="l03800"></a>03800     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a197539281206ac2e950ff0fc4842886b">ConfirmParty</a>(*pNewParty)) <span class="comment">// takes ownership. (Deletes the theoretical version of the party, replaced by our actual version pNewParty.)</span>
<a name="l03801"></a>03801     {
<a name="l03802"></a>03802         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed while trying to confirm party: %s \n&quot;</span>,
<a name="l03803"></a>03803                         __FUNCTION__, PARTY_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03804"></a>03804         <span class="keyword">delete</span> pNewParty; pNewParty=NULL;
<a name="l03805"></a>03805         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03806"></a>03806     }
<a name="l03807"></a>03807     <span class="comment">// ------------------</span>
<a name="l03808"></a>03808     <span class="comment">// ConfirmParty(), unlike most others, actually signs and saves the contract already.</span>
<a name="l03809"></a>03809     <span class="comment">// Therefore, all that&#39;s needed here is to grab it in string form...</span>
<a name="l03810"></a>03810     <span class="comment">// (No need to sign again, it&#39;s just a waste of resource..)</span>
<a name="l03811"></a>03811 <span class="comment">//  pContract-&gt;ReleaseSignatures();</span>
<a name="l03812"></a>03812 <span class="comment">//  pContract-&gt;SignContract(*pNym);</span>
<a name="l03813"></a>03813 <span class="comment">//  pContract-&gt;SaveContract();</span>
<a name="l03814"></a>03814 
<a name="l03815"></a>03815     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03816"></a>03816     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03817"></a>03817     <span class="comment">// ------------------------------</span>
<a name="l03818"></a>03818     <span class="comment">//</span>
<a name="l03819"></a>03819     <span class="comment">// DROP A COPY into the Outpayments box...</span>
<a name="l03820"></a>03820     <span class="comment">//</span>
<a name="l03821"></a>03821     <span class="comment">// (Since we used a transaction number to confirm the party, we</span>
<a name="l03822"></a>03822     <span class="comment">// have to track it until it&#39;s activated or until we cancel it.)</span>
<a name="l03823"></a>03823     <span class="comment">//</span>
<a name="l03824"></a>03824     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInstrument(*pContract);
<a name="l03825"></a>03825     <span class="comment">// ------------------------------</span>
<a name="l03826"></a>03826     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l03827"></a>03827     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l03828"></a>03828 
<a name="l03829"></a>03829     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(NYM_ID);
<a name="l03830"></a>03830 
<a name="l03831"></a>03831     pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outpaymentsMessage&quot;</span>;
<a name="l03832"></a>03832     pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l03833"></a>03833 <span class="comment">//  pMessage-&gt;m_strServerID     = strServerID;</span>
<a name="l03834"></a>03834     pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInstrument);
<a name="l03835"></a>03835 
<a name="l03836"></a>03836     pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l03837"></a>03837     pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03838"></a>03838 
<a name="l03839"></a>03839     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l03840"></a>03840     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l03841"></a>03841     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l03842"></a>03842     <span class="comment">// ------------------------------</span>
<a name="l03843"></a>03843     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03844"></a>03844 }
<a name="l03845"></a>03845 
<a name="l03846"></a>03846 
<a name="l03847"></a>03847 
<a name="l03848"></a>03848 
<a name="l03849"></a><a class="code" href="class_o_t___a_p_i.html#a68be6928764334d775d466f0e4725d72">03849</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a68be6928764334d775d466f0e4725d72">OT_API::SmartContract_AddBylaw</a>(<span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT, <span class="comment">// The contract, about to have the bylaw added to it.</span>
<a name="l03850"></a>03850                                     <span class="keyword">const</span>   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,<span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03851"></a>03851                                     <span class="comment">// ----------------------------------------</span>
<a name="l03852"></a>03852                                     <span class="keyword">const</span>   <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BYLAW_NAME,   <span class="comment">// The Bylaw&#39;s NAME as referenced in the smart contract. (And the scripts...)</span>
<a name="l03853"></a>03853                                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l03854"></a>03854 {
<a name="l03855"></a>03855     <span class="keyword">const</span> <span class="keywordtype">char</span> * BYLAW_LANGUAGE = <span class="stringliteral">&quot;chai&quot;</span>; <span class="comment">// todo hardcoding.</span>
<a name="l03856"></a>03856     <span class="comment">// -----------------------------------------------------</span>
<a name="l03857"></a>03857     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03858"></a>03858     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03859"></a>03859     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03860"></a>03860     <span class="comment">// -----------------------------------------------------</span>
<a name="l03861"></a>03861     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03862"></a>03862     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03863"></a>03863     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03864"></a>03864     {
<a name="l03865"></a>03865         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddBylaw: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03866"></a>03866                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03867"></a>03867         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03868"></a>03868     }
<a name="l03869"></a>03869     <span class="keywordflow">else</span>
<a name="l03870"></a>03870         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03871"></a>03871     <span class="comment">// -----------------------------------------------------</span>
<a name="l03872"></a>03872     <span class="keyword">const</span> std::string str_bylaw_name(BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_language(BYLAW_LANGUAGE);
<a name="l03873"></a>03873 
<a name="l03874"></a>03874     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l03875"></a>03875 
<a name="l03876"></a>03876     <span class="keywordflow">if</span> (NULL != pBylaw)
<a name="l03877"></a>03877     {
<a name="l03878"></a>03878         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddBylaw: Failure: Bylaw already exists: %s \n&quot;</span>,
<a name="l03879"></a>03879                        BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03880"></a>03880         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03881"></a>03881     }
<a name="l03882"></a>03882     <span class="comment">// -------------------------------</span>
<a name="l03883"></a>03883     pBylaw = <span class="keyword">new</span> <a class="code" href="class_o_t_bylaw.html">OTBylaw</a>(str_bylaw_name.c_str(), str_language.c_str());
<a name="l03884"></a>03884     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l03885"></a>03885 
<a name="l03886"></a>03886     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a32d8bccb563ab97e335f457148770c73">AddBylaw</a>(*pBylaw)) <span class="comment">// takes ownership.</span>
<a name="l03887"></a>03887     {
<a name="l03888"></a>03888         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddBylaw: Failed while trying to add bylaw: %s \n&quot;</span>,
<a name="l03889"></a>03889                        BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03890"></a>03890         <span class="keyword">delete</span> pBylaw; pBylaw = NULL;
<a name="l03891"></a>03891         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03892"></a>03892     }
<a name="l03893"></a>03893     <span class="comment">// ------------------</span>
<a name="l03894"></a>03894     <span class="comment">// Success!</span>
<a name="l03895"></a>03895     <span class="comment">//</span>
<a name="l03896"></a>03896     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03897"></a>03897     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03898"></a>03898     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03899"></a>03899     <span class="comment">// ------------------</span>
<a name="l03900"></a>03900     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03901"></a>03901     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03902"></a>03902     <span class="comment">// ------------------</span>
<a name="l03903"></a>03903     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03904"></a>03904 }
<a name="l03905"></a>03905 
<a name="l03906"></a>03906 
<a name="l03907"></a>03907 
<a name="l03908"></a>03908 
<a name="l03909"></a>03909 
<a name="l03910"></a>03910 
<a name="l03911"></a><a class="code" href="class_o_t___a_p_i.html#ae4c6e55f20c7609a2a6b774505483bab">03911</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ae4c6e55f20c7609a2a6b774505483bab">OT_API::SmartContract_AddHook</a>(<span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT, <span class="comment">// The contract, about to have the clause added to it.</span>
<a name="l03912"></a>03912                                    <span class="keyword">const</span>    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03913"></a>03913                                    <span class="comment">// ----------------------------------------</span>
<a name="l03914"></a>03914                                    <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BYLAW_NAME,   <span class="comment">// Should already be on the contract. (This way we can find it.)</span>
<a name="l03915"></a>03915                                    <span class="comment">// ----------------------------------------</span>
<a name="l03916"></a>03916                                    <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; HOOK_NAME,    <span class="comment">// The Hook&#39;s name as referenced in the smart contract. (And the scripts...)</span>
<a name="l03917"></a>03917                                    <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; CLAUSE_NAME,  <span class="comment">// The actual clause that will be triggered by the hook. (You can call this multiple times, and have multiple clauses trigger on the same hook.)</span>
<a name="l03918"></a>03918                                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l03919"></a>03919 {
<a name="l03920"></a>03920     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName     = <span class="stringliteral">&quot;OT_API::SmartContract_AddHook&quot;</span>;
<a name="l03921"></a>03921     <span class="comment">// -----------------------------------------------------</span>
<a name="l03922"></a>03922     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03923"></a>03923     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03924"></a>03924     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03925"></a>03925     <span class="comment">// -----------------------------------------------------</span>
<a name="l03926"></a>03926     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03927"></a>03927     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03928"></a>03928     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03929"></a>03929     {
<a name="l03930"></a>03930         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddHook: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03931"></a>03931                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03932"></a>03932         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03933"></a>03933     }
<a name="l03934"></a>03934     <span class="keywordflow">else</span>
<a name="l03935"></a>03935         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03936"></a>03936     <span class="comment">// -----------------------------------------------------</span>
<a name="l03937"></a>03937     <span class="keyword">const</span> std::string str_bylaw_name(BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03938"></a>03938 
<a name="l03939"></a>03939     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l03940"></a>03940 
<a name="l03941"></a>03941     <span class="keywordflow">if</span> (NULL == pBylaw)
<a name="l03942"></a>03942     {
<a name="l03943"></a>03943         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddHook: Failure: Bylaw doesn&#39;t exist: %s \n&quot;</span>,
<a name="l03944"></a>03944                        str_bylaw_name.c_str());
<a name="l03945"></a>03945         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03946"></a>03946     }
<a name="l03947"></a>03947     <span class="comment">// -------------------------------</span>
<a name="l03948"></a>03948     <span class="keyword">const</span> std::string   str_name(HOOK_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_clause(CLAUSE_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03949"></a>03949 
<a name="l03950"></a>03950     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;AddHook(str_name, str_clause))
<a name="l03951"></a>03951     {
<a name="l03952"></a>03952         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddHook: Failed trying to add hook (%s, clause %s) to bylaw: %s \n&quot;</span>,
<a name="l03953"></a>03953                        str_name.c_str(), str_clause.c_str(), str_bylaw_name.c_str());
<a name="l03954"></a>03954         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03955"></a>03955     }
<a name="l03956"></a>03956     <span class="comment">// -------------------------------</span>
<a name="l03957"></a>03957     <span class="comment">// Success!</span>
<a name="l03958"></a>03958     <span class="comment">//</span>
<a name="l03959"></a>03959     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l03960"></a>03960     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l03961"></a>03961     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l03962"></a>03962     <span class="comment">// ------------------</span>
<a name="l03963"></a>03963     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l03964"></a>03964     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l03965"></a>03965     <span class="comment">// ------------------</span>
<a name="l03966"></a>03966     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03967"></a>03967 }
<a name="l03968"></a>03968 
<a name="l03969"></a>03969 
<a name="l03970"></a>03970 
<a name="l03971"></a>03971 
<a name="l03972"></a><a class="code" href="class_o_t___a_p_i.html#acb0a85ed4e9125dea813ba87e2e9ecf8">03972</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#acb0a85ed4e9125dea813ba87e2e9ecf8">OT_API::SmartContract_AddCallback</a>(<span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT, <span class="comment">// The contract, about to have the clause added to it.</span>
<a name="l03973"></a>03973                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l03974"></a>03974                                        <span class="comment">// ----------------------------------------</span>
<a name="l03975"></a>03975                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BYLAW_NAME,   <span class="comment">// Should already be on the contract. (This way we can find it.)</span>
<a name="l03976"></a>03976                                        <span class="comment">// ----------------------------------------</span>
<a name="l03977"></a>03977                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; CALLBACK_NAME,<span class="comment">// The Callback&#39;s name as referenced in the smart contract. (And the scripts...)</span>
<a name="l03978"></a>03978                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; CLAUSE_NAME,  <span class="comment">// The actual clause that will be triggered by the callback. (Must exist.)</span>
<a name="l03979"></a>03979                                                 <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l03980"></a>03980 {
<a name="l03981"></a>03981     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName     = <span class="stringliteral">&quot;OT_API::SmartContract_AddCallback&quot;</span>;
<a name="l03982"></a>03982     <span class="comment">// -----------------------------------------------------</span>
<a name="l03983"></a>03983     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l03984"></a>03984     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03985"></a>03985     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l03986"></a>03986     <span class="comment">// -----------------------------------------------------</span>
<a name="l03987"></a>03987     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l03988"></a>03988     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l03989"></a>03989     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l03990"></a>03990     {
<a name="l03991"></a>03991         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddCallback: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l03992"></a>03992                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03993"></a>03993         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03994"></a>03994     }
<a name="l03995"></a>03995     <span class="keywordflow">else</span>
<a name="l03996"></a>03996         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l03997"></a>03997     <span class="comment">// -----------------------------------------------------</span>
<a name="l03998"></a>03998     <span class="keyword">const</span> std::string str_bylaw_name(BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03999"></a>03999 
<a name="l04000"></a>04000     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l04001"></a>04001 
<a name="l04002"></a>04002     <span class="keywordflow">if</span> (NULL == pBylaw)
<a name="l04003"></a>04003     {
<a name="l04004"></a>04004         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddCallback: Failure: Bylaw doesn&#39;t exist: %s \n&quot;</span>,
<a name="l04005"></a>04005                        str_bylaw_name.c_str());
<a name="l04006"></a>04006         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04007"></a>04007     }
<a name="l04008"></a>04008     <span class="comment">// -------------------------------</span>
<a name="l04009"></a>04009     <span class="keyword">const</span> std::string   str_name(CALLBACK_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_clause(CLAUSE_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04010"></a>04010 
<a name="l04011"></a>04011     <span class="keywordflow">if</span> (NULL != pBylaw-&gt;GetCallback(str_name))
<a name="l04012"></a>04012     {
<a name="l04013"></a>04013         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddCallback: Failure: Callback (%s) already exists on bylaw: %s \n&quot;</span>,
<a name="l04014"></a>04014                        str_name.c_str(), str_bylaw_name.c_str());
<a name="l04015"></a>04015         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04016"></a>04016     }
<a name="l04017"></a>04017     <span class="comment">// -----------------------------------------------------</span>
<a name="l04018"></a>04018     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;AddCallback(str_name.c_str(), str_clause.c_str()))
<a name="l04019"></a>04019     {
<a name="l04020"></a>04020         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddCallback: Failed trying to add callback (%s, clause %s) to bylaw: %s \n&quot;</span>,
<a name="l04021"></a>04021                        str_name.c_str(), str_clause.c_str(), str_bylaw_name.c_str());
<a name="l04022"></a>04022         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04023"></a>04023     }
<a name="l04024"></a>04024     <span class="comment">// -------------------------------</span>
<a name="l04025"></a>04025     <span class="comment">// Success!</span>
<a name="l04026"></a>04026     <span class="comment">//</span>
<a name="l04027"></a>04027     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04028"></a>04028     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04029"></a>04029     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04030"></a>04030     <span class="comment">// ------------------</span>
<a name="l04031"></a>04031     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l04032"></a>04032     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l04033"></a>04033     <span class="comment">// ------------------</span>
<a name="l04034"></a>04034     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04035"></a>04035 }
<a name="l04036"></a>04036 
<a name="l04037"></a>04037 
<a name="l04038"></a>04038 
<a name="l04039"></a>04039 
<a name="l04040"></a>04040 
<a name="l04041"></a>04041 
<a name="l04042"></a><a class="code" href="class_o_t___a_p_i.html#a495e1b59fcfedf265a853665c7e2f73c">04042</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a495e1b59fcfedf265a853665c7e2f73c">OT_API::SmartContract_AddClause</a>(<span class="keyword">const</span>  <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT, <span class="comment">// The contract, about to have the clause added to it.</span>
<a name="l04043"></a>04043                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l04044"></a>04044                                      <span class="comment">// ----------------------------------------</span>
<a name="l04045"></a>04045                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BYLAW_NAME,   <span class="comment">// Should already be on the contract. (This way we can find it.)</span>
<a name="l04046"></a>04046                                      <span class="comment">// ----------------------------------------</span>
<a name="l04047"></a>04047                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_string.html">OTString</a>        &amp; CLAUSE_NAME,  <span class="comment">// The Clause&#39;s name as referenced in the smart contract. (And the scripts...)</span>
<a name="l04048"></a>04048                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_string.html">OTString</a>        &amp; SOURCE_CODE,  <span class="comment">// The actual source code for the clause.</span>
<a name="l04049"></a>04049                                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l04050"></a>04050 {
<a name="l04051"></a>04051     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName     = <span class="stringliteral">&quot;OT_API::SmartContract_AddClause&quot;</span>;
<a name="l04052"></a>04052     <span class="comment">// -----------------------------------------------------</span>
<a name="l04053"></a>04053     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l04054"></a>04054     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04055"></a>04055     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04056"></a>04056     <span class="comment">// -----------------------------------------------------</span>
<a name="l04057"></a>04057     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l04058"></a>04058     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l04059"></a>04059     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l04060"></a>04060     {
<a name="l04061"></a>04061         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddClause: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l04062"></a>04062                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04063"></a>04063         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04064"></a>04064     }
<a name="l04065"></a>04065     <span class="keywordflow">else</span>
<a name="l04066"></a>04066         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l04067"></a>04067     <span class="comment">// -----------------------------------------------------</span>
<a name="l04068"></a>04068     <span class="keyword">const</span> std::string str_bylaw_name(BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04069"></a>04069 
<a name="l04070"></a>04070     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l04071"></a>04071 
<a name="l04072"></a>04072     <span class="keywordflow">if</span> (NULL == pBylaw)
<a name="l04073"></a>04073     {
<a name="l04074"></a>04074         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddClause: Failure: Bylaw doesn&#39;t exist: %s \n Input contract: \n\n%s\n\n&quot;</span>,
<a name="l04075"></a>04075                        str_bylaw_name.c_str(), THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04076"></a>04076         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04077"></a>04077     }
<a name="l04078"></a>04078     <span class="comment">// -------------------------------</span>
<a name="l04079"></a>04079     <span class="keyword">const</span> std::string str_name(CLAUSE_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_code(SOURCE_CODE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04080"></a>04080 
<a name="l04081"></a>04081     <span class="keywordflow">if</span> (NULL != pBylaw-&gt;GetClause(str_name))
<a name="l04082"></a>04082     {
<a name="l04083"></a>04083         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddClause: Failed adding: clause is already there with that name (%s) on bylaw: %s \n&quot;</span>,
<a name="l04084"></a>04084                        str_name.c_str(), str_bylaw_name.c_str());
<a name="l04085"></a>04085         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04086"></a>04086     }
<a name="l04087"></a>04087     <span class="comment">// ---------------------------------------------</span>
<a name="l04088"></a>04088     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;AddClause(str_name.c_str(), str_code.c_str()))
<a name="l04089"></a>04089     {
<a name="l04090"></a>04090         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddClause: Failed trying to add clause (%s) to bylaw: %s \n&quot;</span>,
<a name="l04091"></a>04091                        str_name.c_str(), str_bylaw_name.c_str());
<a name="l04092"></a>04092         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04093"></a>04093     }
<a name="l04094"></a>04094     <span class="comment">// ------------------</span>
<a name="l04095"></a>04095     <span class="comment">// Success!</span>
<a name="l04096"></a>04096     <span class="comment">//</span>
<a name="l04097"></a>04097     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04098"></a>04098     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04099"></a>04099     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04100"></a>04100     <span class="comment">// ------------------</span>
<a name="l04101"></a>04101     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l04102"></a>04102     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l04103"></a>04103     <span class="comment">// ------------------</span>
<a name="l04104"></a>04104     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04105"></a>04105 }
<a name="l04106"></a>04106 
<a name="l04107"></a>04107 
<a name="l04108"></a>04108 
<a name="l04109"></a>04109 
<a name="l04110"></a>04110 
<a name="l04111"></a><a class="code" href="class_o_t___a_p_i.html#a561b64935144d650a1790b614a593be8">04111</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a561b64935144d650a1790b614a593be8">OT_API::SmartContract_AddVariable</a>(<span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_CONTRACT,     <span class="comment">// The contract, about to have the clause added to it.</span>
<a name="l04112"></a>04112                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SIGNER_NYM_ID,    <span class="comment">// Use any Nym you wish here. (The signing at this point is only to cause a save.)</span>
<a name="l04113"></a>04113                                        <span class="comment">// ----------------------------------------</span>
<a name="l04114"></a>04114                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BYLAW_NAME,       <span class="comment">// Should already be on the contract. (This way we can find it.)</span>
<a name="l04115"></a>04115                                        <span class="comment">// ----------------------------------------</span>
<a name="l04116"></a>04116                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; VAR_NAME,     <span class="comment">// The Variable&#39;s name as referenced in the smart contract. (And the scripts...)</span>
<a name="l04117"></a>04117                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; VAR_ACCESS,   <span class="comment">// &quot;constant&quot;, &quot;persistent&quot;, or &quot;important&quot;.</span>
<a name="l04118"></a>04118                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; VAR_TYPE,     <span class="comment">// &quot;string&quot;, &quot;int64_t&quot;, or &quot;bool&quot;</span>
<a name="l04119"></a>04119                                        <span class="keyword">const</span>    <a class="code" href="class_o_t_string.html">OTString</a>        &amp; VAR_VALUE,    <span class="comment">// Contains a string. If type is int64_t, atol() will be used to convert value to a int64_t. If type is bool, the strings &quot;true&quot; or &quot;false&quot; are expected here in order to convert to a bool.</span>
<a name="l04120"></a>04120                                        <span class="comment">// ----------------------------------------</span>
<a name="l04121"></a>04121                                                 <a class="code" href="class_o_t_string.html">OTString</a>        &amp; strOutput)
<a name="l04122"></a>04122 {
<a name="l04123"></a>04123     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName     = <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable&quot;</span>;
<a name="l04124"></a>04124     <span class="comment">// -----------------------------------------------------</span>
<a name="l04125"></a>04125     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l04126"></a>04126     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04127"></a>04127     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04128"></a>04128     <span class="comment">// -----------------------------------------------------</span>
<a name="l04129"></a>04129     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pContract = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(THE_CONTRACT);
<a name="l04130"></a>04130     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theContractAngel;
<a name="l04131"></a>04131     <span class="keywordflow">if</span> (NULL == pContract)
<a name="l04132"></a>04132     {
<a name="l04133"></a>04133         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable: Error loading smart contract:\n\n%s\n\n&quot;</span>,
<a name="l04134"></a>04134                        THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04135"></a>04135         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04136"></a>04136     }
<a name="l04137"></a>04137     <span class="keywordflow">else</span>
<a name="l04138"></a>04138         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pContract);  <span class="comment">// Auto-cleanup.</span>
<a name="l04139"></a>04139     <span class="comment">// -----------------------------------------------------</span>
<a name="l04140"></a>04140     <span class="keyword">const</span> std::string str_bylaw_name(BYLAW_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04141"></a>04141 
<a name="l04142"></a>04142     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = pContract-&gt;<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l04143"></a>04143 
<a name="l04144"></a>04144     <span class="keywordflow">if</span> (NULL == pBylaw)
<a name="l04145"></a>04145     {
<a name="l04146"></a>04146         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable: Failure: Bylaw doesn&#39;t exist: %s \n&quot;</span>,
<a name="l04147"></a>04147                        str_bylaw_name.c_str());
<a name="l04148"></a>04148         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04149"></a>04149     }
<a name="l04150"></a>04150     <span class="comment">// -------------------------------</span>
<a name="l04151"></a>04151     <span class="keyword">const</span> std::string   str_name(VAR_NAME.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_access(VAR_ACCESS.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()),
<a name="l04152"></a>04152                         str_type(VAR_TYPE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()), str_value(VAR_VALUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04153"></a>04153 
<a name="l04154"></a>04154     <span class="keywordflow">if</span> (NULL != pBylaw-&gt;GetVariable(str_name))
<a name="l04155"></a>04155     {
<a name="l04156"></a>04156         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable: Failure: Variable (%s) already exists on bylaw: %s \n&quot;</span>,
<a name="l04157"></a>04157                        str_name.c_str(), str_bylaw_name.c_str());
<a name="l04158"></a>04158         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04159"></a>04159     }
<a name="l04160"></a>04160     <span class="comment">// -------------------------------</span>
<a name="l04161"></a>04161     <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672">OTVariable::OTVariable_Access</a> theAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a664538cd758878fab6c2e8718b1839fc">OTVariable::Var_Error_Access</a>;
<a name="l04162"></a>04162 
<a name="l04163"></a>04163     <span class="keywordflow">if</span> (str_access.compare(<span class="stringliteral">&quot;constant&quot;</span>) == 0)
<a name="l04164"></a>04164         theAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a3663696326da4cd07edb796beec5c324">OTVariable::Var_Constant</a>;
<a name="l04165"></a>04165     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_access.compare(<span class="stringliteral">&quot;persistent&quot;</span>) == 0)
<a name="l04166"></a>04166         theAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672ad39bbaff07fae07e5d3dece3789fb03c">OTVariable::Var_Persistent</a>;
<a name="l04167"></a>04167     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_access.compare(<span class="stringliteral">&quot;important&quot;</span>) == 0)
<a name="l04168"></a>04168         theAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a087192fa3f7d345cf2eb413a52fdddc4">OTVariable::Var_Important</a>;
<a name="l04169"></a>04169     <span class="comment">// ---------------------</span>
<a name="l04170"></a>04170     <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009">OTVariable::OTVariable_Type</a> theType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ae4992b1094ef990fbe683f43c7b2a2a8">OTVariable::Var_Error_Type</a>;
<a name="l04171"></a>04171 
<a name="l04172"></a>04172     <span class="keywordflow">if</span> (str_type.compare(<span class="stringliteral">&quot;bool&quot;</span>) == 0)
<a name="l04173"></a>04173         theType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a4f6c0ea25b7a5aed16bc7710389e77da">OTVariable::Var_Bool</a>;
<a name="l04174"></a>04174     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_type.compare(<span class="stringliteral">&quot;integer&quot;</span>) == 0)
<a name="l04175"></a>04175         theType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ad6ecaa07337c8641bed85deab47c1a1d">OTVariable::Var_Integer</a>;
<a name="l04176"></a>04176     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_type.compare(<span class="stringliteral">&quot;string&quot;</span>) == 0)
<a name="l04177"></a>04177         theType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a814483713bd6ebb3b01c06378fc60fa7">OTVariable::Var_String</a>;
<a name="l04178"></a>04178     <span class="comment">// ---------------------</span>
<a name="l04179"></a>04179     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ae4992b1094ef990fbe683f43c7b2a2a8">OTVariable::Var_Error_Type</a> == theType) || (<a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a664538cd758878fab6c2e8718b1839fc">OTVariable::Var_Error_Access</a> == theAccess))
<a name="l04180"></a>04180     {
<a name="l04181"></a>04181         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable: Failed due to bad variable type or bad access type. \n&quot;</span>);
<a name="l04182"></a>04182         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04183"></a>04183     }
<a name="l04184"></a>04184     <span class="comment">// ---------------------</span>
<a name="l04185"></a>04185     <span class="keywordtype">bool</span> bAdded = <span class="keyword">false</span>;
<a name="l04186"></a>04186 
<a name="l04187"></a>04187     <span class="keywordflow">switch</span> (theType)
<a name="l04188"></a>04188     {
<a name="l04189"></a>04189         <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a4f6c0ea25b7a5aed16bc7710389e77da">OTVariable::Var_Bool</a>:
<a name="l04190"></a>04190         {
<a name="l04191"></a>04191             <span class="keyword">const</span> <span class="keywordtype">bool</span> bValue = (str_value.compare(<span class="stringliteral">&quot;true&quot;</span>) == 0);
<a name="l04192"></a>04192             bAdded = pBylaw-&gt;AddVariable(str_name, bValue, theAccess);
<a name="l04193"></a>04193         }
<a name="l04194"></a>04194             <span class="keywordflow">break</span>;
<a name="l04195"></a>04195         <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ad6ecaa07337c8641bed85deab47c1a1d">OTVariable::Var_Integer</a>:
<a name="l04196"></a>04196         {
<a name="l04197"></a>04197             <span class="keyword">const</span> int32_t nValue = atoi(str_value.c_str());
<a name="l04198"></a>04198             bAdded = pBylaw-&gt;AddVariable(str_name, nValue, theAccess);
<a name="l04199"></a>04199         }
<a name="l04200"></a>04200             <span class="keywordflow">break</span>;
<a name="l04201"></a>04201         <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a814483713bd6ebb3b01c06378fc60fa7">OTVariable::Var_String</a>:
<a name="l04202"></a>04202             bAdded = pBylaw-&gt;AddVariable(str_name, str_value, theAccess);
<a name="l04203"></a>04203             <span class="keywordflow">break</span>;
<a name="l04204"></a>04204         <span class="keywordflow">default</span>:
<a name="l04205"></a>04205             <span class="comment">// SHOULD NEVER HAPPEN (We already return above, if the variable type isn&#39;t correct.)</span>
<a name="l04206"></a>04206             <a class="code" href="_o_t_assert_8hpp.html#aa86aeed4e57eecded96d5955b5cc23c5">OT_FAIL_MSG</a>(<span class="stringliteral">&quot;Should never happen. You aren&#39;t seeing this.&quot;</span>);
<a name="l04207"></a>04207             <span class="keywordflow">break</span>;
<a name="l04208"></a>04208     }
<a name="l04209"></a>04209 
<a name="l04210"></a>04210     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bAdded)
<a name="l04211"></a>04211     {
<a name="l04212"></a>04212         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::SmartContract_AddVariable: Failed trying to add variable (%s) to bylaw: %s \n&quot;</span>,
<a name="l04213"></a>04213                        str_name.c_str(), str_bylaw_name.c_str());
<a name="l04214"></a>04214         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04215"></a>04215     }
<a name="l04216"></a>04216     <span class="comment">// -------------------------------</span>
<a name="l04217"></a>04217     <span class="comment">// Success!</span>
<a name="l04218"></a>04218     <span class="comment">//</span>
<a name="l04219"></a>04219     pContract-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04220"></a>04220     pContract-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04221"></a>04221     pContract-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04222"></a>04222     <span class="comment">// ------------------</span>
<a name="l04223"></a>04223     strOutput.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l04224"></a>04224     pContract-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strOutput);
<a name="l04225"></a>04225     <span class="comment">// ------------------</span>
<a name="l04226"></a>04226     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04227"></a>04227 }
<a name="l04228"></a>04228 
<a name="l04229"></a>04229 
<a name="l04230"></a>04230 
<a name="l04231"></a>04231 <span class="comment">// -----------------------------------------------------</span>
<a name="l04232"></a>04232 
<a name="l04233"></a>04233 
<a name="l04234"></a>04234 
<a name="l04235"></a>04235 
<a name="l04236"></a>04236 
<a name="l04237"></a>04237 
<a name="l04238"></a>04238 
<a name="l04239"></a>04239 <span class="comment">// The Nym&#39;s Name is basically just a client-side label.</span>
<a name="l04240"></a>04240 <span class="comment">// This function lets you change it.</span>
<a name="l04241"></a>04241 <span class="comment">//</span>
<a name="l04242"></a>04242 <span class="comment">// Returns success, true or false.</span>
<a name="l04243"></a>04243 <span class="comment">//</span>
<a name="l04244"></a><a class="code" href="class_o_t___a_p_i.html#a765251304181ec99fa3874d0fe0a8568">04244</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a765251304181ec99fa3874d0fe0a8568">OT_API::SetNym_Name</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   NYM_ID,
<a name="l04245"></a>04245                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   SIGNER_NYM_ID,
<a name="l04246"></a>04246                          <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp;   NYM_NEW_NAME)
<a name="l04247"></a>04247 {
<a name="l04248"></a>04248     <span class="comment">// -----------------------------------------------------</span>
<a name="l04249"></a>04249     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04250"></a>04250     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04251"></a>04251     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04252"></a>04252     <span class="comment">// -----------------------------------------------------}</span>
<a name="l04253"></a>04253     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pNym        = <a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(NYM_ID, __FUNCTION__);
<a name="l04254"></a>04254     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pSignerNym  = <a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l04255"></a>04255     <span class="keywordflow">if</span> ((NULL == pNym) || (NULL == pSignerNym))  <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04256"></a>04256     <span class="comment">// By this point, pNym and pSignerNym are good pointers.  (No need to cleanup.)</span>
<a name="l04257"></a>04257     <span class="comment">// -----------------------------------------------------}</span>
<a name="l04258"></a>04258     <span class="comment">// Might want to put some more data validation on the name?</span>
<a name="l04259"></a>04259     <span class="keywordflow">if</span> (!NYM_NEW_NAME.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l04260"></a>04260         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SetNym_Name: Empty name (bad).\n&quot;</span>);
<a name="l04261"></a>04261     <span class="keywordflow">else</span>
<a name="l04262"></a>04262     {
<a name="l04263"></a>04263         <a class="code" href="class_o_t_string.html">OTString</a> strOldName(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a42e63697c3c3b1bdb526ee7990a9c0e7">GetNymName</a>()); <span class="comment">// just in case.</span>
<a name="l04264"></a>04264         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(NYM_NEW_NAME);
<a name="l04265"></a>04265         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym))
<a name="l04266"></a>04266         {
<a name="l04267"></a>04267             <span class="keywordtype">bool</span> bSaveWallet = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only cause the nym&#39;s name is stored here, too.</span>
<a name="l04268"></a>04268             <span class="keywordflow">if</span> (!bSaveWallet)
<a name="l04269"></a>04269                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to save wallet.\n&quot;</span>, __FUNCTION__);
<a name="l04270"></a>04270             <span class="keywordflow">return</span> bSaveWallet;
<a name="l04271"></a>04271         }
<a name="l04272"></a>04272         <span class="keywordflow">else</span>
<a name="l04273"></a>04273             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acf835189df80fda4eedc88d4cccdc5f1">SetNymName</a>(strOldName); <span class="comment">// Set it back to the old name if failure.</span>
<a name="l04274"></a>04274     }
<a name="l04275"></a>04275     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04276"></a>04276 }
<a name="l04277"></a>04277 
<a name="l04278"></a>04278 
<a name="l04279"></a>04279 
<a name="l04280"></a>04280 
<a name="l04281"></a>04281 <span class="comment">// The Asset Account&#39;s Name is basically just a client-side label.</span>
<a name="l04282"></a>04282 <span class="comment">// This function lets you change it.</span>
<a name="l04283"></a>04283 <span class="comment">//</span>
<a name="l04284"></a>04284 <span class="comment">// Returns success, true or false.</span>
<a name="l04285"></a>04285 <span class="comment">//</span>
<a name="l04286"></a><a class="code" href="class_o_t___a_p_i.html#aa2213ae9a93b111ca1c774df67818b6b">04286</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aa2213ae9a93b111ca1c774df67818b6b">OT_API::SetAccount_Name</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   ACCT_ID,
<a name="l04287"></a>04287                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   SIGNER_NYM_ID,
<a name="l04288"></a>04288                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp;       ACCT_NEW_NAME)
<a name="l04289"></a>04289 {
<a name="l04290"></a>04290     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::SetAccount_Name&quot;</span>;
<a name="l04291"></a>04291     <span class="comment">// -----------------------------------------------------</span>
<a name="l04292"></a>04292     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName);       <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04293"></a>04293     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04294"></a>04294     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04295"></a>04295     <span class="comment">// -----------------------------------------------------</span>
<a name="l04296"></a>04296     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pSignerNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFuncName);   <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04297"></a>04297     <span class="keywordflow">if</span> (NULL == pSignerNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04298"></a>04298     <span class="comment">// -----------------------------------------------------</span>
<a name="l04299"></a>04299     <a class="code" href="class_o_t_account.html">OTAccount</a> *     pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a263e050929c3f000ce4172dfbc727149">GetAccount</a>(ACCT_ID, szFuncName);       <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04300"></a>04300     <span class="keywordflow">if</span> (NULL == pAccount)   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04301"></a>04301     <span class="comment">// -------------------------------------</span>
<a name="l04302"></a>04302     <span class="keywordflow">if</span> (!ACCT_NEW_NAME.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()) <span class="comment">// Any other validation to do on the name?</span>
<a name="l04303"></a>04303     {
<a name="l04304"></a>04304         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::SetAccount_Name: New name is empty (bad).\n&quot;</span>);
<a name="l04305"></a>04305     }
<a name="l04306"></a>04306     <span class="keywordflow">else</span>
<a name="l04307"></a>04307     {
<a name="l04308"></a>04308         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(2, <span class="stringliteral">&quot;Saving updated account file to disk...\n&quot;</span>);
<a name="l04309"></a>04309         pAccount-&gt;<a class="code" href="class_o_t_contract.html#ae6ad4eed689a88335c8818d7762bbbcb">SetName</a>(ACCT_NEW_NAME);
<a name="l04310"></a>04310         pAccount-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l04311"></a>04311         <span class="keywordflow">if</span> (pAccount-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pSignerNym) &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>() &amp;&amp; pAccount-&gt;<a class="code" href="class_o_t_account.html#adaba3f4ce60f7ac88f883c0543d9ddb0">SaveAccount</a>())
<a name="l04312"></a>04312             <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aa16fe70ac5913e3223f994d7dc8a4831">SaveWallet</a>(); <span class="comment">// Only cause the account&#39;s name is stored here, too.</span>
<a name="l04313"></a>04313         <span class="keywordflow">else</span>
<a name="l04314"></a>04314             <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::SetAccount_Name: Failed doing this:  if (pAccount-&gt;SignContract(*pSignerNym) &quot;</span>
<a name="l04315"></a>04315                          <span class="stringliteral">&quot;&amp;&amp; pAccount-&gt;SaveContract() &amp;&amp; pAccount-&gt;SaveAccount())\n&quot;</span>);
<a name="l04316"></a>04316     }
<a name="l04317"></a>04317     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04318"></a>04318 }
<a name="l04319"></a>04319 
<a name="l04320"></a>04320 
<a name="l04321"></a>04321 <span class="comment">// -----------------------------------------------------</span>
<a name="l04322"></a>04322 
<a name="l04323"></a>04323 
<a name="l04326"></a><a class="code" href="class_o_t___a_p_i.html#a5d793f8c61422481fc3a266ec68c523a">04326</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#a5d793f8c61422481fc3a266ec68c523a">OT_API::LoadPublicNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l04327"></a>04327 {
<a name="l04328"></a>04328     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;}
<a name="l04329"></a>04329 
<a name="l04330"></a>04330 <span class="comment">//  const char * szFunc = (NULL != szFuncName) ? szFuncName : &quot;OT_API::LoadPublicNym&quot;;</span>
<a name="l04331"></a>04331     <span class="comment">// ---------------------------------</span>
<a name="l04332"></a>04332     <span class="comment">// Grab the name, if there is one.</span>
<a name="l04333"></a>04333     <span class="comment">// That way if we have to reload it, we&#39;ll be able to preserve the name.</span>
<a name="l04334"></a>04334     <a class="code" href="class_o_t_string.html">OTString</a>        strName;
<a name="l04335"></a>04335     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strNymID(NYM_ID);
<a name="l04336"></a>04336     <span class="comment">// ---------------------------------</span>
<a name="l04337"></a>04337     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(NYM_ID, szFuncName);    <span class="comment">// This already logs and ASSERTs</span>
<a name="l04338"></a>04338     strName = (NULL != pNym) ? pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a42e63697c3c3b1bdb526ee7990a9c0e7">GetNymName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l04339"></a>04339     <span class="comment">// now strName contains either &quot;&quot; or the Nym&#39;s name from wallet.</span>
<a name="l04340"></a>04340     <span class="comment">// ---------------------------------</span>
<a name="l04341"></a>04341     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#a5d793f8c61422481fc3a266ec68c523a">OTPseudonym::LoadPublicNym</a>(NYM_ID, &amp;strName, szFuncName);
<a name="l04342"></a>04342 }
<a name="l04343"></a>04343 
<a name="l04344"></a>04344 
<a name="l04347"></a><a class="code" href="class_o_t___a_p_i.html#a38f96bbf12655ca9ced0ebf33a5c3794">04347</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#a38f96bbf12655ca9ced0ebf33a5c3794">OT_API::LoadPrivateNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bChecking<span class="comment">/*=false*/</span>,  <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>,
<a name="l04348"></a>04348                                      <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>,
<a name="l04349"></a>04349                                      <a class="code" href="class_o_t_password.html">OTPassword</a>   * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l04350"></a>04350 {
<a name="l04351"></a>04351     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l04352"></a>04352     <span class="comment">// ---------------------------------</span>
<a name="l04353"></a>04353     <span class="comment">// Grab the name, if there is one.</span>
<a name="l04354"></a>04354     <span class="comment">// That way if we have to reload it, we&#39;ll be able to preserve the name.</span>
<a name="l04355"></a>04355     <a class="code" href="class_o_t_string.html">OTString</a>        strName;
<a name="l04356"></a>04356     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strNymID(NYM_ID);
<a name="l04357"></a>04357     <span class="comment">// ---------------------------------</span>
<a name="l04358"></a>04358     <span class="comment">// If the Nym is already in the wallet, we grab the name from the wallet, so we can</span>
<a name="l04359"></a>04359     <span class="comment">// set the same name onto that Nym again when he&#39;s re-loaded.</span>
<a name="l04360"></a>04360     <span class="comment">//</span>
<a name="l04361"></a>04361     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *   pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(NYM_ID, szFuncName);    <span class="comment">// This already logs and ASSERTs</span>
<a name="l04362"></a>04362     strName = (NULL != pNym) ? pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a42e63697c3c3b1bdb526ee7990a9c0e7">GetNymName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l04363"></a>04363     <span class="comment">// now strName contains either &quot;&quot; or the Nym&#39;s name from wallet.</span>
<a name="l04364"></a>04364     <span class="comment">// ---------------------------------</span>
<a name="l04365"></a>04365     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a>);
<a name="l04366"></a>04366     <span class="keywordflow">if</span> (NULL == pPWData)
<a name="l04367"></a>04367         pPWData = &amp;thePWData;
<a name="l04368"></a>04368     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#a38f96bbf12655ca9ced0ebf33a5c3794">OTPseudonym::LoadPrivateNym</a>(NYM_ID, bChecking, &amp;strName, szFuncName, pPWData, pImportPassword); <span class="comment">// CALLER must delete!</span>
<a name="l04369"></a>04369 }
<a name="l04370"></a>04370 
<a name="l04371"></a>04371 
<a name="l04372"></a>04372 
<a name="l04373"></a>04373 
<a name="l04374"></a>04374 <span class="comment">// -----------------------------------------------------</span>
<a name="l04375"></a>04375 
<a name="l04376"></a>04376 
<a name="l04377"></a>04377 <span class="comment">/*</span>
<a name="l04378"></a>04378 <span class="comment"> OT_API_Msg_HarvestTransactionNumbers</span>
<a name="l04379"></a>04379 <span class="comment"></span>
<a name="l04380"></a>04380 <span class="comment"> This function will load up the cron item (which is either a market offer, a payment plan,</span>
<a name="l04381"></a>04381 <span class="comment"> or a SMART CONTRACT.)  UPDATE: this function operates on messages, not cron items.</span>
<a name="l04382"></a>04382 <span class="comment"></span>
<a name="l04383"></a>04383 <span class="comment"> Then it will try to harvest all of the closing transaction numbers for NYM_ID that are</span>
<a name="l04384"></a>04384 <span class="comment"> available to be harvested from THE_CRON_ITEM. (There might be zero #s available for that</span>
<a name="l04385"></a>04385 <span class="comment"> Nym, which is still a success and will return true. False means error.)</span>
<a name="l04386"></a>04386 <span class="comment"></span>
<a name="l04387"></a>04387 <span class="comment"> YOU MIGHT ASK:</span>
<a name="l04388"></a>04388 <span class="comment"></span>
<a name="l04389"></a>04389 <span class="comment"> WHY WOULD I WANT to harvest ONLY the closing numbers for the Nym, and not the OPENING</span>
<a name="l04390"></a>04390 <span class="comment"> numbers as well? The answer is because for this Nym, the opening number might already</span>
<a name="l04391"></a>04391 <span class="comment"> be burned. For example, if Nym just tried to activate a smart contract, and the activation</span>
<a name="l04392"></a>04392 <span class="comment"> FAILED, then maybe the opening number is already gone, even though his closing numbers, on the</span>
<a name="l04393"></a>04393 <span class="comment"> other hand, are still valid for retrieval. (I have to double check this.)</span>
<a name="l04394"></a>04394 <span class="comment"></span>
<a name="l04395"></a>04395 <span class="comment"> HOWEVER, what if the MESSAGE failed, before it even TRIED the transaction? In which case,</span>
<a name="l04396"></a>04396 <span class="comment"> the opening number is still good also, and should be retrieved.</span>
<a name="l04397"></a>04397 <span class="comment"></span>
<a name="l04398"></a>04398 <span class="comment"> Remember, I have to keep signing for my transaction numbers until they are finally closed out.</span>
<a name="l04399"></a>04399 <span class="comment"> They will appear on EVERY balance agreement and transaction statement from here until the end</span>
<a name="l04400"></a>04400 <span class="comment"> of time, whenever I finally close out those numbers. If some of them are still good on a failed</span>
<a name="l04401"></a>04401 <span class="comment"> transaction, then I want to retrieve them so I can use them, and eventually close them out.</span>
<a name="l04402"></a>04402 <span class="comment"></span>
<a name="l04403"></a>04403 <span class="comment"> ==&gt; Whereas, what if I am the PARTY to a smart contract, but I am not the actual ACTIVATOR / ORIGINATOR</span>
<a name="l04404"></a>04404 <span class="comment"> (who activated the smart contract on the server).  Therefore I never sent any transaction to the</span>
<a name="l04405"></a>04405 <span class="comment"> server, and I never burned my opening number. It&#39;s probably still a good #. If my wallet is not a piece</span>
<a name="l04406"></a>04406 <span class="comment"> of shit, then I should have a stored copy of any contract that I signed. If it turns out in the future</span>
<a name="l04407"></a>04407 <span class="comment"> that that contract wasn&#39;t activated, then I can retrieve not only my closing numbers, but my OPENING</span>
<a name="l04408"></a>04408 <span class="comment"> number as well! IN THAT CASE, I would call OT_API_HarvestAllNumbers() instead of OT_API_HarvestClosingNumbers().</span>
<a name="l04409"></a>04409 <span class="comment"></span>
<a name="l04410"></a>04410 <span class="comment"> // -----------------</span>
<a name="l04411"></a>04411 <span class="comment"></span>
<a name="l04412"></a>04412 <span class="comment"> UPDATE: The above logic is now handled automatically in OT_API_HarvestTransactionNumbers.</span>
<a name="l04413"></a>04413 <span class="comment"> Therefore OT_API_HarvestClosingNumbers and OT_API_HarvestAllNumbers have been removed.</span>
<a name="l04414"></a>04414 <span class="comment"></span>
<a name="l04415"></a>04415 <span class="comment"> */</span>
<a name="l04416"></a>04416 
<a name="l04417"></a>04417 <span class="comment">// true == no errors. false == errors.</span>
<a name="l04418"></a>04418 <span class="comment">//</span>
<a name="l04419"></a><a class="code" href="class_o_t___a_p_i.html#af1e69026904ab8b2a6a3a1185801bdf7">04419</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#af1e69026904ab8b2a6a3a1185801bdf7">OT_API::Msg_HarvestTransactionNumbers</a>(      <a class="code" href="class_o_t_message.html">OTMessage</a>      &amp; theMsg,
<a name="l04420"></a>04420                                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID,
<a name="l04421"></a>04421                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>             bHarvestingForRetry,     <span class="comment">// false until positively asserted.</span>
<a name="l04422"></a>04422                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>             bReplyWasSuccess,        <span class="comment">// false until positively asserted.</span>
<a name="l04423"></a>04423                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>             bReplyWasFailure,        <span class="comment">// false until positively asserted.</span>
<a name="l04424"></a>04424                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>             bTransactionWasSuccess,  <span class="comment">// false until positively asserted.</span>
<a name="l04425"></a>04425                                            <span class="keyword">const</span> <span class="keywordtype">bool</span>             bTransactionWasFailure)  <span class="comment">// false until positively asserted.</span>
<a name="l04426"></a>04426 {
<a name="l04427"></a>04427     <span class="comment">// -----------------------------------------------------</span>
<a name="l04428"></a>04428     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l04429"></a>04429     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04430"></a>04430     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04431"></a>04431     <span class="comment">// -----------------------------------------------------</span>
<a name="l04432"></a>04432     <span class="keywordflow">return</span> theMsg.<a class="code" href="class_o_t_message.html#a6331ffbc53709747d82dfb100c3c8f02">HarvestTransactionNumbers</a>(*pNym,
<a name="l04433"></a>04433                                             bHarvestingForRetry,
<a name="l04434"></a>04434                                             bReplyWasSuccess,
<a name="l04435"></a>04435                                             bReplyWasFailure,
<a name="l04436"></a>04436                                             bTransactionWasSuccess,
<a name="l04437"></a>04437                                             bTransactionWasFailure);
<a name="l04438"></a>04438 }
<a name="l04439"></a>04439 
<a name="l04440"></a>04440 
<a name="l04441"></a>04441 
<a name="l04442"></a>04442 
<a name="l04443"></a>04443 
<a name="l04444"></a>04444 
<a name="l04445"></a>04445 
<a name="l04446"></a>04446 
<a name="l04447"></a>04447 
<a name="l04448"></a>04448 <span class="comment">/*</span>
<a name="l04449"></a>04449 <span class="comment"></span>
<a name="l04450"></a>04450 <span class="comment"> ------ TODO: Smart Contracts -----------</span>
<a name="l04451"></a>04451 <span class="comment"></span>
<a name="l04452"></a>04452 <span class="comment"> TODO:  Whenever a party confirms a smart contract (sending it on to the next party) then a copy of</span>
<a name="l04453"></a>04453 <span class="comment"> the smart contract should go into that party&#39;s paymentOutbox. Same thing if the party is the last</span>
<a name="l04454"></a>04454 <span class="comment"> one in the chain, and has activated it on to the server. A copy sits in the paymentOutbox until</span>
<a name="l04455"></a>04455 <span class="comment"> that smart contract is either successfully activated, or FAILS to activate.</span>
<a name="l04456"></a>04456 <span class="comment"></span>
<a name="l04457"></a>04457 <span class="comment"> If a smart contract activates, static OTAgreement::DropServerNoticeToNymbox already sends an</span>
<a name="l04458"></a>04458 <span class="comment"> &#39;acknowledgment&#39; notice to all parties.</span>
<a name="l04459"></a>04459 <span class="comment"></span>
<a name="l04460"></a>04460 <span class="comment"> TODO: If a smart contract fails to activate, it should ALSO send a notice (&#39;rejection&#39;) to</span>
<a name="l04461"></a>04461 <span class="comment"> all parties.</span>
<a name="l04462"></a>04462 <span class="comment"></span>
<a name="l04463"></a>04463 <span class="comment"> TODO: When a party receives a rejection notice in his Nymbox for a certain smart contract,</span>
<a name="l04464"></a>04464 <span class="comment"> he looks up that same smart contract in his paymentOutbox, HARVESTS THE CLOSING NUMBERS, and</span>
<a name="l04465"></a>04465 <span class="comment"> then moves the notice from his paymentOutbox to his recordBox.</span>
<a name="l04466"></a>04466 <span class="comment"></span>
<a name="l04467"></a>04467 <span class="comment"> Until this is added, then clients will go out of sync on rejected smart contracts. (Not the kind</span>
<a name="l04468"></a>04468 <span class="comment"> of out-of-sync where they can&#39;t do any transactions, but rather, the kind where they have certain</span>
<a name="l04469"></a>04469 <span class="comment"> numbers signed out forever but then never use them on anything because their client thinks those</span>
<a name="l04470"></a>04470 <span class="comment"> numbers were already used on a smart contract somewhere, and without the above code they would</span>
<a name="l04471"></a>04471 <span class="comment"> never have clawed back those numbers.)</span>
<a name="l04472"></a>04472 <span class="comment"> */</span>
<a name="l04473"></a>04473 
<a name="l04474"></a>04474 
<a name="l04475"></a>04475 
<a name="l04476"></a>04476 
<a name="l04477"></a>04477 
<a name="l04478"></a>04478 
<a name="l04479"></a>04479 
<a name="l04480"></a>04480 
<a name="l04481"></a><a class="code" href="class_o_t___a_p_i.html#a46beec5e1e260828865c4c03b71930ab">04481</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a46beec5e1e260828865c4c03b71930ab">OT_API::HarvestClosingNumbers</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l04482"></a>04482                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID,
<a name="l04483"></a>04483                                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_CRON_ITEM)
<a name="l04484"></a>04484 {
<a name="l04485"></a>04485     <span class="comment">// -----------------------------------------------------</span>
<a name="l04486"></a>04486     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l04487"></a>04487     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04488"></a>04488     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04489"></a>04489     <span class="comment">// -----------------------------------------------------</span>
<a name="l04490"></a>04490     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(THE_CRON_ITEM);
<a name="l04491"></a>04491     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theContractAngel;
<a name="l04492"></a>04492     <span class="keywordflow">if</span> (NULL == pCronItem)
<a name="l04493"></a>04493     {
<a name="l04494"></a>04494         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading the cron item (a cron item is a smart contract, or &quot;</span>
<a name="l04495"></a>04495                        <span class="stringliteral">&quot;some other recurring transaction such as a market offer, or a payment plan.) Contents:\n\n%s\n\n&quot;</span>,
<a name="l04496"></a>04496                        __FUNCTION__, THE_CRON_ITEM.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04497"></a>04497         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04498"></a>04498     }
<a name="l04499"></a>04499     <span class="keywordflow">else</span>
<a name="l04500"></a>04500         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pCronItem);  <span class="comment">// Auto-cleanup.</span>
<a name="l04501"></a>04501     <span class="comment">// -----------------------------------------------------</span>
<a name="l04502"></a>04502     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// &lt;==== the Nym is actually harvesting the numbers from the Cron Item, and not the other way around.</span>
<a name="l04503"></a>04503     <span class="comment">// -------------------------------</span>
<a name="l04504"></a>04504     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04505"></a>04505 }
<a name="l04506"></a>04506 
<a name="l04507"></a>04507 
<a name="l04508"></a>04508 <span class="comment">// NOTE: usually you will want to call OT_API_HarvestClosingNumbers (above), since the Opening number is usually</span>
<a name="l04509"></a>04509 <span class="comment">// burned up from some failed transaction or whatever. You don&#39;t want to harvest the opening number usually,</span>
<a name="l04510"></a>04510 <span class="comment">// just the closing numbers. (If the opening number is burned up, yet you still harvest it, then your OT wallet</span>
<a name="l04511"></a>04511 <span class="comment">// could end up using that number again on some other transaction, which will obviously then fail since the number</span>
<a name="l04512"></a>04512 <span class="comment">// isn&#39;t good anymore. In fact much of OT&#39;s design is based on minimizing/eliminating any such sync issues.)</span>
<a name="l04513"></a>04513 <span class="comment">// This function is only for those cases where you are sure that the opening transaction # hasn&#39;t been burned yet,</span>
<a name="l04514"></a>04514 <span class="comment">// such as when the message failed and the transaction wasn&#39;t attempted (because it never got that far) or such as</span>
<a name="l04515"></a>04515 <span class="comment">// when the contract simply never got signed or activated by one of the other parties, and so you want to claw ALL your</span>
<a name="l04516"></a>04516 <span class="comment">// #&#39;s back, and since in that case your opening number is still good, you would use the below function to get it back.</span>
<a name="l04517"></a>04517 <span class="comment">//</span>
<a name="l04518"></a><a class="code" href="class_o_t___a_p_i.html#a3455b2ed3c8b4abef30b1eaaafa595ab">04518</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a3455b2ed3c8b4abef30b1eaaafa595ab">OT_API::HarvestAllNumbers</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l04519"></a>04519                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID,
<a name="l04520"></a>04520                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_CRON_ITEM)
<a name="l04521"></a>04521 {
<a name="l04522"></a>04522     <span class="comment">// -----------------------------------------------------</span>
<a name="l04523"></a>04523     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l04524"></a>04524     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04525"></a>04525     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04526"></a>04526     <span class="comment">// -----------------------------------------------------</span>
<a name="l04527"></a>04527     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pCronItem = <a class="code" href="class_o_t_cron_item.html#ad448bfdee05f5a1086d19d9edb2e2518">OTCronItem::NewCronItem</a>(THE_CRON_ITEM);
<a name="l04528"></a>04528     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTCronItem&gt;</a> theContractAngel;
<a name="l04529"></a>04529     <span class="keywordflow">if</span> (NULL == pCronItem)
<a name="l04530"></a>04530     {
<a name="l04531"></a>04531         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading the cron item (a cron item is a smart contract, or &quot;</span>
<a name="l04532"></a>04532                        <span class="stringliteral">&quot;some other recurring transaction such as a market offer, or a payment plan.) &quot;</span>
<a name="l04533"></a>04533                        <span class="stringliteral">&quot;Contents:\n\n%s\n\n&quot;</span>, __FUNCTION__, THE_CRON_ITEM.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l04534"></a>04534         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04535"></a>04535     }
<a name="l04536"></a>04536     <span class="keywordflow">else</span>
<a name="l04537"></a>04537         theContractAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pCronItem);  <span class="comment">// Auto-cleanup.</span>
<a name="l04538"></a>04538     <span class="comment">// -----------------------------------------------------</span>
<a name="l04539"></a>04539     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#ab4adba19339e539c05bba94717c481cc">HarvestOpeningNumber</a> (*pNym); <span class="comment">// &lt;==== the Nym is actually harvesting the numbers from the Cron Item, and not the other way around.</span>
<a name="l04540"></a>04540     pCronItem-&gt;<a class="code" href="class_o_t_cron_item.html#aeeaf2e2f8c54e7eb3e072336d07b2879">HarvestClosingNumbers</a>(*pNym); <span class="comment">// &lt;==== the Nym is actually harvesting the numbers from the Cron Item, and not the other way around.</span>
<a name="l04541"></a>04541     <span class="comment">// -------------------------------</span>
<a name="l04542"></a>04542     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04543"></a>04543 }
<a name="l04544"></a>04544 
<a name="l04545"></a>04545 
<a name="l04546"></a>04546 
<a name="l04547"></a>04547 
<a name="l04548"></a>04548 
<a name="l04549"></a>04549 
<a name="l04550"></a>04550 
<a name="l04551"></a>04551 
<a name="l04552"></a>04552 
<a name="l04556"></a><a class="code" href="class_o_t___a_p_i.html#a0ecd26987ce0a3fd24c04b618bbbb293">04556</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#a0ecd26987ce0a3fd24c04b618bbbb293">OT_API::GetOrLoadPublicNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID, <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>)
<a name="l04557"></a>04557 {
<a name="l04558"></a>04558     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l04559"></a>04559 
<a name="l04560"></a>04560     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04561"></a>04561     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l04562"></a>04562     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04563"></a>04563     <span class="comment">// -----------------------------------------------------</span>
<a name="l04564"></a>04564     <span class="comment">//</span>
<a name="l04565"></a>04565     <span class="comment">// This already logs copiously, including szFuncName...</span>
<a name="l04566"></a>04566     <span class="comment">//</span>
<a name="l04567"></a>04567     <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad8d73d7ddef1194c1c24f173190da9f3">GetOrLoadPublicNym</a>(NYM_ID, szFuncName);
<a name="l04568"></a>04568 }
<a name="l04569"></a>04569 
<a name="l04570"></a>04570 
<a name="l04578"></a><a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">04578</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">OT_API::GetOrLoadPrivateNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID,
<a name="l04579"></a>04579                                           <span class="keyword">const</span> <span class="keywordtype">bool</span> bChecking<span class="comment">/*=false*/</span>,
<a name="l04580"></a>04580                                           <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>,
<a name="l04581"></a>04581                                           <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>,
<a name="l04582"></a>04582                                           <a class="code" href="class_o_t_password.html">OTPassword</a> * pImportPassword<span class="comment">/*=NULL*/</span>)
<a name="l04583"></a>04583 {
<a name="l04584"></a>04584     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l04585"></a>04585 
<a name="l04586"></a>04586     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04587"></a>04587     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l04588"></a>04588     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) <span class="keywordflow">return</span> NULL;
<a name="l04589"></a>04589     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04590"></a>04590     <span class="comment">// -----------------------------------------------------</span>
<a name="l04591"></a>04591     <span class="comment">//</span>
<a name="l04592"></a>04592     <span class="comment">// This already logs copiously, including szFuncName...</span>
<a name="l04593"></a>04593     <span class="comment">//</span>
<a name="l04594"></a>04594     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a>);
<a name="l04595"></a>04595     <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a7ca619a0f6ac4fa8f59efc1a518a297c">GetOrLoadPrivateNym</a>(NYM_ID, bChecking, szFuncName,
<a name="l04596"></a>04596                                         NULL == pPWData ? &amp;thePWData : pPWData,
<a name="l04597"></a>04597                                         pImportPassword);
<a name="l04598"></a>04598 }
<a name="l04599"></a>04599 
<a name="l04600"></a>04600 
<a name="l04609"></a><a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">04609</a> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * <a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">OT_API::GetOrLoadNym</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; NYM_ID,
<a name="l04610"></a>04610                                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bChecking<span class="comment">/*=false*/</span>,
<a name="l04611"></a>04611                                    <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName<span class="comment">/*=NULL*/</span>,
<a name="l04612"></a>04612                                    <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> * pPWData<span class="comment">/*=NULL*/</span>)
<a name="l04613"></a>04613 {
<a name="l04614"></a>04614     <span class="keywordflow">if</span> (NYM_ID.<a class="code" href="class_o_t_data.html#a947528765516223eb03bee7745eb8c07">IsEmpty</a>()) { <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: NYM_ID is empty!&quot;</span>, __FUNCTION__); <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
<a name="l04615"></a>04615 
<a name="l04616"></a>04616     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04617"></a>04617     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l04618"></a>04618     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04619"></a>04619     <span class="comment">// -----------------------------------------------------</span>
<a name="l04620"></a>04620     <span class="comment">//</span>
<a name="l04621"></a>04621     <span class="comment">// This already logs copiously, including szFuncName...</span>
<a name="l04622"></a>04622     <span class="comment">//</span>
<a name="l04623"></a>04623 
<a name="l04624"></a>04624     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(<a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a>);
<a name="l04625"></a>04625 
<a name="l04626"></a>04626     <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a97c9e8ef43e629dfad894e2c5fbc4073">GetOrLoadNym</a>(NYM_ID, bChecking, szFuncName, NULL == pPWData ? &amp;thePWData : pPWData);
<a name="l04627"></a>04627 }
<a name="l04628"></a>04628 
<a name="l04629"></a>04629 
<a name="l04633"></a><a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">04633</a> <a class="code" href="class_o_t_account.html">OTAccount</a> * <a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">OT_API::GetOrLoadAccount</a>(       <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     &amp; theNym,
<a name="l04634"></a>04634                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ACCT_ID,
<a name="l04635"></a>04635                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l04636"></a>04636                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *   szFuncName  <span class="comment">/*=NULL*/</span>)
<a name="l04637"></a>04637 {
<a name="l04638"></a>04638     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetOrLoadAccount (theNym)&quot;</span>;
<a name="l04639"></a>04639     <span class="comment">// -----------------------------------------------------</span>
<a name="l04640"></a>04640     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFunc); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l04641"></a>04641     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l04642"></a>04642     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l04643"></a>04643     <span class="comment">// -----------------------------------------------------</span>
<a name="l04644"></a>04644     <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ad3e876943833406d7819ce4c34b74647">GetOrLoadAccount</a>(theNym, ACCT_ID, SERVER_ID, szFunc); <span class="comment">// This logs plenty.</span>
<a name="l04645"></a>04645 }
<a name="l04646"></a>04646 
<a name="l04647"></a>04647 <span class="comment">// -----------------------------------------------------</span>
<a name="l04648"></a>04648 
<a name="l04652"></a><a class="code" href="class_o_t___a_p_i.html#ac9416e678013333f9d6e1612dcf0ffaa">04652</a> <a class="code" href="class_o_t_account.html">OTAccount</a> * <a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">OT_API::GetOrLoadAccount</a>(<span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; NYM_ID,
<a name="l04653"></a>04653                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ACCT_ID,
<a name="l04654"></a>04654                                      <span class="keyword">const</span>  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l04655"></a>04655                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *   szFuncName  <span class="comment">/*=NULL*/</span>)
<a name="l04656"></a>04656 {
<a name="l04657"></a>04657     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = (NULL != szFuncName) ? szFuncName : <span class="stringliteral">&quot;OT_API::GetOrLoadAccount (NYM_ID)&quot;</span>;
<a name="l04658"></a>04658     <span class="comment">// -----------------------------------------------------</span>
<a name="l04659"></a>04659     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(NYM_ID, <span class="keyword">false</span>, szFunc);
<a name="l04660"></a>04660     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l04661"></a>04661     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04662"></a>04662     <span class="comment">// -----------------------------------------------------</span>
<a name="l04663"></a>04663     <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, szFunc); <span class="comment">// This logs plenty.</span>
<a name="l04664"></a>04664 }
<a name="l04665"></a>04665 
<a name="l04666"></a>04666 <span class="comment">// -----------------------------------------------------</span>
<a name="l04667"></a>04667 
<a name="l04668"></a>04668 
<a name="l04669"></a>04669 <span class="comment">// WRITE CHEQUE</span>
<a name="l04670"></a>04670 <span class="comment">//</span>
<a name="l04671"></a>04671 <span class="comment">// Returns an OTCheque pointer, or NULL.</span>
<a name="l04672"></a>04672 <span class="comment">// (Caller responsible to delete.)</span>
<a name="l04673"></a>04673 <span class="comment">//</span>
<a name="l04674"></a><a class="code" href="class_o_t___a_p_i.html#a504e99bac03c227bbecb79f869a76578">04674</a> <a class="code" href="class_o_t_cheque.html">OTCheque</a> * <a class="code" href="class_o_t___a_p_i.html#a504e99bac03c227bbecb79f869a76578">OT_API::WriteCheque</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l04675"></a>04675                                <span class="keyword">const</span> int64_t         &amp; CHEQUE_AMOUNT,
<a name="l04676"></a>04676                                <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>       &amp; VALID_FROM,
<a name="l04677"></a>04677                                <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>       &amp; VALID_TO,
<a name="l04678"></a>04678                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_ACCT_ID,
<a name="l04679"></a>04679                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_USER_ID,
<a name="l04680"></a>04680                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; CHEQUE_MEMO,
<a name="l04681"></a>04681                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pRECIPIENT_USER_ID<span class="comment">/*=NULL*/</span>)
<a name="l04682"></a>04682 {
<a name="l04683"></a>04683     <span class="comment">// -----------------------------------------------------</span>
<a name="l04684"></a>04684     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SENDER_USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l04685"></a>04685     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l04686"></a>04686     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04687"></a>04687     <span class="comment">// -----------------------------------------------------</span>
<a name="l04688"></a>04688     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, SENDER_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l04689"></a>04689     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> NULL;
<a name="l04690"></a>04690     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04691"></a>04691     <span class="comment">// -----------------------------------------------------</span>
<a name="l04692"></a>04692     <span class="comment">// To write a cheque, we need to burn one of our transaction numbers. (Presumably the wallet</span>
<a name="l04693"></a>04693     <span class="comment">// is also storing a couple of these, since they are needed to perform any transaction.)</span>
<a name="l04694"></a>04694     <span class="comment">//</span>
<a name="l04695"></a>04695     <span class="comment">// I don&#39;t have to contact the server to write a cheque -- as long as I already have a transaction</span>
<a name="l04696"></a>04696     <span class="comment">// number I can use to write it with. (Otherwise I&#39;d have to ask the server to send me one first.)</span>
<a name="l04697"></a>04697     <span class="comment">//</span>
<a name="l04698"></a>04698     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l04699"></a>04699     int64_t lTransactionNumber=0; <span class="comment">// Notice I use the server ID on the ACCOUNT.</span>
<a name="l04700"></a>04700 
<a name="l04701"></a>04701     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lTransactionNumber))
<a name="l04702"></a>04702     {
<a name="l04703"></a>04703         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: User attempted to write a cheque, but had no transaction numbers.\n&quot;</span>,
<a name="l04704"></a>04704                        __FUNCTION__);
<a name="l04705"></a>04705         <span class="keywordflow">return</span> NULL;
<a name="l04706"></a>04706     }
<a name="l04707"></a>04707     <span class="comment">// At this point, I know that lTransactionNumber contains one I can use.</span>
<a name="l04708"></a>04708     <span class="comment">// ------------------------------</span>
<a name="l04709"></a>04709     <a class="code" href="class_o_t_cheque.html">OTCheque</a> * pCheque = <span class="keyword">new</span> <a class="code" href="class_o_t_cheque.html">OTCheque</a>(pAccount-&gt;<a class="code" href="class_o_t_transaction_type.html#a6a6c7517c09f0abacc72c1ec84d937ed">GetRealServerID</a>(),
<a name="l04710"></a>04710                                       pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>());
<a name="l04711"></a>04711     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pCheque, <span class="stringliteral">&quot;OT_API::WriteCheque: Error allocating memory in the OT API.&quot;</span>);
<a name="l04712"></a>04712     <span class="comment">// At this point, I know that pCheque is a good pointer that I either</span>
<a name="l04713"></a>04713     <span class="comment">// have to delete, or return to the caller.</span>
<a name="l04714"></a>04714     <span class="comment">// -----------------------------------------------------</span>
<a name="l04715"></a>04715     <span class="keywordtype">bool</span> bIssueCheque = pCheque-&gt;<a class="code" href="class_o_t_cheque.html#af554e93b31bf218e373bdc8f457d7605">IssueCheque</a>(CHEQUE_AMOUNT,
<a name="l04716"></a>04716                                              lTransactionNumber,
<a name="l04717"></a>04717                                              VALID_FROM, VALID_TO,
<a name="l04718"></a>04718                                              SENDER_ACCT_ID,
<a name="l04719"></a>04719                                              SENDER_USER_ID,
<a name="l04720"></a>04720                                              CHEQUE_MEMO,
<a name="l04721"></a>04721                                              pRECIPIENT_USER_ID);
<a name="l04722"></a>04722     <span class="keywordflow">if</span> (<span class="keyword">false</span> == bIssueCheque)
<a name="l04723"></a>04723     {
<a name="l04724"></a>04724         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure calling OTCheque::IssueCheque().\n&quot;</span>, __FUNCTION__);
<a name="l04725"></a>04725         <span class="keyword">delete</span> pCheque; pCheque = NULL;
<a name="l04726"></a>04726         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l04727"></a>04727         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l04728"></a>04728         <span class="keywordflow">return</span> NULL;
<a name="l04729"></a>04729     }
<a name="l04730"></a>04730     <span class="comment">// ------------------------------</span>
<a name="l04731"></a>04731     pCheque-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l04732"></a>04732     pCheque-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04733"></a>04733     <span class="comment">// ------------------------------</span>
<a name="l04734"></a>04734     <span class="comment">//</span>
<a name="l04735"></a>04735     <span class="comment">// DROP A COPY into the Outpayments box...</span>
<a name="l04736"></a>04736     <span class="comment">//</span>
<a name="l04737"></a>04737     <span class="comment">// (Since we used a transaction number to write the cheque,</span>
<a name="l04738"></a>04738     <span class="comment">// we have to track it until it&#39;s deposited or until we cancel</span>
<a name="l04739"></a>04739     <span class="comment">// it.)</span>
<a name="l04740"></a>04740     <span class="comment">//</span>
<a name="l04741"></a>04741     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInstrument(*pCheque);
<a name="l04742"></a>04742     <span class="comment">// ------------------------------</span>
<a name="l04743"></a>04743     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l04744"></a>04744     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l04745"></a>04745 
<a name="l04746"></a>04746     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(SENDER_USER_ID);
<a name="l04747"></a>04747 
<a name="l04748"></a>04748     pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outpaymentsMessage&quot;</span>;
<a name="l04749"></a>04749     pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l04750"></a>04750 
<a name="l04751"></a>04751     <span class="keywordflow">if</span> (NULL != pRECIPIENT_USER_ID)
<a name="l04752"></a>04752     {
<a name="l04753"></a>04753         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID2(*pRECIPIENT_USER_ID);
<a name="l04754"></a>04754         pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>   = strNymID2;
<a name="l04755"></a>04755     }
<a name="l04756"></a>04756     pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l04757"></a>04757     pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInstrument);
<a name="l04758"></a>04758 
<a name="l04759"></a>04759     pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l04760"></a>04760     pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04761"></a>04761 
<a name="l04762"></a>04762     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l04763"></a>04763     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l04764"></a>04764     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l04765"></a>04765     <span class="comment">// ------------------------------</span>
<a name="l04766"></a>04766     <span class="keywordflow">return</span> pCheque;
<a name="l04767"></a>04767 }
<a name="l04768"></a>04768 
<a name="l04769"></a>04769 
<a name="l04770"></a>04770 
<a name="l04771"></a>04771 
<a name="l04772"></a>04772 
<a name="l04773"></a>04773 
<a name="l04774"></a>04774 
<a name="l04775"></a>04775 
<a name="l04776"></a>04776 
<a name="l04777"></a>04777 <span class="comment">// PROPOSE PAYMENT PLAN  (MERCHANT calls this function)</span>
<a name="l04778"></a>04778 <span class="comment">//</span>
<a name="l04779"></a>04779 <span class="comment">// Returns an OTPaymentPlan pointer, or NULL.</span>
<a name="l04780"></a>04780 <span class="comment">// (Caller responsible to delete.)</span>
<a name="l04781"></a>04781 <span class="comment">//</span>
<a name="l04782"></a>04782 <span class="comment">// The process (finally) is:</span>
<a name="l04783"></a>04783 <span class="comment">//</span>
<a name="l04784"></a>04784 <span class="comment">// 1) Payment plan is written, and signed, by the recipient. (Merchant.)</span>
<a name="l04785"></a>04785 <span class="comment">// 2) He sends it to the sender, who signs it and submits it. (Payer / Customer.)</span>
<a name="l04786"></a>04786 <span class="comment">// 3) The server loads the recipient nym to verify the transaction</span>
<a name="l04787"></a>04787 <span class="comment">//    number. The sender also had to burn a transaction number (to</span>
<a name="l04788"></a>04788 <span class="comment">//    submit it) so now, both have verified trns#s in this way.</span>
<a name="l04789"></a>04789 <span class="comment">//</span>
<a name="l04790"></a>04790 <span class="comment">//----------------------</span>
<a name="l04791"></a>04791 <span class="comment">//</span>
<a name="l04792"></a>04792 <span class="comment">// Payment Plan Delay, and Payment Plan Period, both default to 30 days (if you pass 0.)</span>
<a name="l04793"></a>04793 <span class="comment">// Payment Plan Length, and Payment Plan Max Payments, both default to 0, which means</span>
<a name="l04794"></a>04794 <span class="comment">// no maximum length and no maximum number of payments.</span>
<a name="l04795"></a>04795 <span class="comment">//</span>
<a name="l04796"></a>04796 <span class="comment">// WARNING: the OTPaymentPlan object being returned, contains 2 transaction numbers of the Recipient.</span>
<a name="l04797"></a>04797 <span class="comment">// If you delete that object without actually activating it, make sure you retrieve those transaction</span>
<a name="l04798"></a>04798 <span class="comment">// numbers first, and add them BACK to the Recipient&#39;s Nym!!</span>
<a name="l04799"></a>04799 <span class="comment">//</span>
<a name="l04800"></a>04800 <span class="comment">// Furthermore, recipient should keep a COPY of this proposal after making it,</span>
<a name="l04801"></a>04801 <span class="comment">// so that he can retrieve the transaction numbers from it, for the same reason.</span>
<a name="l04802"></a>04802 <span class="comment">//</span>
<a name="l04803"></a><a class="code" href="class_o_t___a_p_i.html#a5c416b1b8178998dad0f7357498974a3">04803</a> <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> * <a class="code" href="class_o_t___a_p_i.html#a5c416b1b8178998dad0f7357498974a3">OT_API::ProposePaymentPlan</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l04804"></a>04804                                          <span class="comment">// ----------------------------------------</span>
<a name="l04805"></a>04805                                          <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     &amp; VALID_FROM,   <span class="comment">// Default (0) == NOW (It will set it to the current time in seconds since Jan 1970)</span>
<a name="l04806"></a>04806                                          <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     &amp; VALID_TO,     <span class="comment">// Default (0) == no expiry / cancel anytime. Otherwise this is a LENGTH and is ADDED to VALID_FROM</span>
<a name="l04807"></a>04807                                          <span class="comment">// ----------------------------------------</span>
<a name="l04808"></a>04808                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_ACCT_ID,
<a name="l04809"></a>04809                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_USER_ID,
<a name="l04810"></a>04810                                          <span class="comment">// ----------------------------------------</span>
<a name="l04811"></a>04811                                          <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; PLAN_CONSIDERATION, <span class="comment">// Like a memo.</span>
<a name="l04812"></a>04812                                          <span class="comment">// ----------------------------------------</span>
<a name="l04813"></a>04813                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; RECIPIENT_ACCT_ID,
<a name="l04814"></a>04814                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; RECIPIENT_USER_ID,
<a name="l04815"></a>04815                                          <span class="comment">// ----------------------------------------  // If it&#39;s above zero, the initial</span>
<a name="l04816"></a>04816                                          <span class="keyword">const</span> int64_t          &amp; INITIAL_PAYMENT_AMOUNT, <span class="comment">// amount will be processed after</span>
<a name="l04817"></a>04817                                          <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     &amp; INITIAL_PAYMENT_DELAY,  <span class="comment">// delay (seconds from now.)</span>
<a name="l04818"></a>04818                                          <span class="comment">// ----------------------------------------  // AND SEPARATELY FROM THIS...</span>
<a name="l04819"></a>04819                                          <span class="keyword">const</span> int64_t          &amp; PAYMENT_PLAN_AMOUNT,  <span class="comment">// The regular amount charged,</span>
<a name="l04820"></a>04820                                          <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     &amp; PAYMENT_PLAN_DELAY,   <span class="comment">// which begins occuring after delay</span>
<a name="l04821"></a>04821                                          <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     &amp; PAYMENT_PLAN_PERIOD,  <span class="comment">// (seconds from now) and happens</span>
<a name="l04822"></a>04822                                          <span class="comment">// ----------------------------------------// every period, ad infinitum, until</span>
<a name="l04823"></a>04823                                          <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>     PAYMENT_PLAN_LENGTH <span class="comment">/*=0*/</span>,       <span class="comment">// after the length (in seconds)</span>
<a name="l04824"></a>04824                                          int32_t      PAYMENT_PLAN_MAX_PAYMENTS <span class="comment">/*=0*/</span>  <span class="comment">// expires, or after the maximum</span>
<a name="l04825"></a>04825                                          )                                          <span class="comment">// number of payments. These last</span>
<a name="l04826"></a>04826 {                                                                                   <span class="comment">// two arguments are optional.</span>
<a name="l04827"></a>04827     <span class="comment">// -----------------------------------------------------</span>
<a name="l04828"></a>04828     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(RECIPIENT_USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs, ASSERTs, etc.</span>
<a name="l04829"></a>04829     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l04830"></a>04830     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04831"></a>04831     <span class="comment">// -----------------------------------------------------</span>
<a name="l04832"></a>04832     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, RECIPIENT_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l04833"></a>04833     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> NULL;
<a name="l04834"></a>04834     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04835"></a>04835     <span class="comment">// -----------------------------------------------------</span>
<a name="l04836"></a>04836     <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> * pPlan = <span class="keyword">new</span> <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>(SERVER_ID,
<a name="l04837"></a>04837                                               pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>(),
<a name="l04838"></a>04838                                               SENDER_ACCT_ID,
<a name="l04839"></a>04839                                               SENDER_USER_ID,
<a name="l04840"></a>04840                                               RECIPIENT_ACCT_ID,
<a name="l04841"></a>04841                                               RECIPIENT_USER_ID);
<a name="l04842"></a>04842     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pPlan, <span class="stringliteral">&quot;OT_API::ProposePaymentPlan: Error allocating memory in the OT API for new OTPaymentPlan.\n&quot;</span>);
<a name="l04843"></a>04843     <span class="comment">// -----------------------------------------------------</span>
<a name="l04844"></a>04844     <span class="comment">// At this point, I know that pPlan is a good pointer that I either</span>
<a name="l04845"></a>04845     <span class="comment">// have to delete, or return to the caller. CLEANUP WARNING!</span>
<a name="l04846"></a>04846     <span class="comment">// -----------------------------------------------------</span>
<a name="l04847"></a>04847     <span class="keywordtype">bool</span> bSuccessSetProposal =
<a name="l04848"></a>04848             pPlan-&gt;<a class="code" href="class_o_t_agreement.html#ac02afd651c21e1df34c97061c30706fe">SetProposal</a>(*pNym, PLAN_CONSIDERATION, VALID_FROM, VALID_TO);
<a name="l04849"></a>04849     <span class="comment">// ************************************************</span>
<a name="l04850"></a>04850     <span class="comment">// WARNING!!!! SetProposal() burns TWO transaction numbers for RECIPIENT. (*pNym)</span>
<a name="l04851"></a>04851     <span class="comment">// BELOW THIS POINT, if you have an error, then you must retrieve those numbers from</span>
<a name="l04852"></a>04852     <span class="comment">// the plan, and set them BACK on pNym before you return!!!</span>
<a name="l04853"></a>04853     <span class="comment">// ------------------------------------------------</span>
<a name="l04854"></a>04854     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l04855"></a>04855 
<a name="l04856"></a>04856     <span class="keywordflow">if</span> (!bSuccessSetProposal)
<a name="l04857"></a>04857     {
<a name="l04858"></a>04858         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to set the proposal.\n&quot;</span>, __FUNCTION__);
<a name="l04859"></a>04859         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a181efb58949ade53e690f4ebb0f4cfab">HarvestOpeningNumber</a> (*pNym);
<a name="l04860"></a>04860         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(*pNym);
<a name="l04861"></a>04861         <span class="keyword">delete</span> pPlan; pPlan = NULL;
<a name="l04862"></a>04862         <span class="keywordflow">return</span> NULL;
<a name="l04863"></a>04863     }
<a name="l04864"></a>04864     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04865"></a>04865     <span class="keywordtype">bool</span> bSuccessSetInitialPayment  = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to even have this payment.</span>
<a name="l04866"></a>04866     <span class="keywordtype">bool</span> bSuccessSetPaymentPlan     = <span class="keyword">true</span>; <span class="comment">// the default, in case user chooses not to have a payment plan</span>
<a name="l04867"></a>04867     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04868"></a>04868     <span class="keywordflow">if</span> ((INITIAL_PAYMENT_AMOUNT &gt; 0) &amp;&amp; (INITIAL_PAYMENT_DELAY &gt;= <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>))
<a name="l04869"></a>04869     {
<a name="l04870"></a>04870         <span class="comment">// The Initial payment delay is measured in seconds, starting from the &quot;Creation Date&quot;.</span>
<a name="l04871"></a>04871         bSuccessSetInitialPayment = pPlan-&gt;<a class="code" href="class_o_t_payment_plan.html#ae51fed6db87911877df2324e231da710">SetInitialPayment</a>(INITIAL_PAYMENT_AMOUNT, INITIAL_PAYMENT_DELAY);
<a name="l04872"></a>04872     }
<a name="l04873"></a>04873     <span class="keywordflow">if</span> (!bSuccessSetInitialPayment)
<a name="l04874"></a>04874     {
<a name="l04875"></a>04875         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to set the initial payment.\n&quot;</span>, __FUNCTION__);
<a name="l04876"></a>04876         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a181efb58949ade53e690f4ebb0f4cfab">HarvestOpeningNumber</a> (*pNym);
<a name="l04877"></a>04877         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(*pNym);
<a name="l04878"></a>04878         <span class="keyword">delete</span> pPlan; pPlan = NULL;
<a name="l04879"></a>04879         <span class="keywordflow">return</span> NULL;
<a name="l04880"></a>04880     }
<a name="l04881"></a>04881     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04882"></a>04882     <span class="comment">//</span>
<a name="l04883"></a>04883     <span class="comment">//                &quot; 6 minutes   ==      360 Seconds\n&quot;</span>
<a name="l04884"></a>04884     <span class="comment">//                &quot;10 minutes   ==      600 Seconds\n&quot;</span>
<a name="l04885"></a>04885     <span class="comment">//                &quot;1 hour       ==     3600 Seconds\n&quot;</span>
<a name="l04886"></a>04886     <span class="comment">//                &quot;1 day        ==    86400 Seconds\n&quot;</span>
<a name="l04887"></a>04887     <span class="comment">//                &quot;30 days      ==  2592000 Seconds\n&quot;</span>
<a name="l04888"></a>04888     <span class="comment">//                &quot;3 months     ==  7776000 Seconds\n&quot;</span>
<a name="l04889"></a>04889     <span class="comment">//                &quot;6 months     == 15552000 Seconds\n\n&quot;</span>
<a name="l04890"></a>04890     <span class="comment">//</span>
<a name="l04891"></a>04891     <span class="keywordflow">if</span> (PAYMENT_PLAN_AMOUNT &gt; 0) <span class="comment">// If there are regular payments.</span>
<a name="l04892"></a>04892     {
<a name="l04893"></a>04893         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04894"></a>04894         <span class="comment">// The payment plan delay is measured in seconds, starting from the &quot;Creation Date&quot;.</span>
<a name="l04895"></a>04895         <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_DELAY = <a class="code" href="_o_t_common_8hpp.html#af04aead93a0e4b740d061e043c26c601">OT_TIME_MONTH_IN_SECONDS</a>; <span class="comment">// Defaults to 30 days, measured in seconds (if you pass 0.)</span>
<a name="l04896"></a>04896 
<a name="l04897"></a>04897         <span class="keywordflow">if</span> (PAYMENT_PLAN_DELAY &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l04898"></a>04898             PAYMENT_DELAY = PAYMENT_PLAN_DELAY;
<a name="l04899"></a>04899         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04900"></a>04900         <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PAYMENT_PERIOD = <a class="code" href="_o_t_common_8hpp.html#af04aead93a0e4b740d061e043c26c601">OT_TIME_MONTH_IN_SECONDS</a>; <span class="comment">// Defaults to 30 days, measured in seconds (if you pass 0.)</span>
<a name="l04901"></a>04901 
<a name="l04902"></a>04902         <span class="keywordflow">if</span> (PAYMENT_PLAN_PERIOD &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l04903"></a>04903             PAYMENT_PERIOD = PAYMENT_PLAN_PERIOD;
<a name="l04904"></a>04904         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04905"></a>04905         <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    PLAN_LENGTH = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>; <span class="comment">// Defaults to 0 seconds (for no max length).</span>
<a name="l04906"></a>04906 
<a name="l04907"></a>04907         <span class="keywordflow">if</span> (PAYMENT_PLAN_LENGTH &gt; <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>)
<a name="l04908"></a>04908             PLAN_LENGTH = PAYMENT_PLAN_LENGTH;
<a name="l04909"></a>04909         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04910"></a>04910         int32_t nMaxPayments = 0; <span class="comment">// Defaults to 0 maximum payments (for no maximum).</span>
<a name="l04911"></a>04911 
<a name="l04912"></a>04912         <span class="keywordflow">if</span> (PAYMENT_PLAN_MAX_PAYMENTS &gt; 0)
<a name="l04913"></a>04913             nMaxPayments = PAYMENT_PLAN_MAX_PAYMENTS;
<a name="l04914"></a>04914         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l04915"></a>04915         bSuccessSetPaymentPlan = pPlan-&gt;<a class="code" href="class_o_t_payment_plan.html#a14669877c3f817148180d2556d63e839">SetPaymentPlan</a>(PAYMENT_PLAN_AMOUNT,
<a name="l04916"></a>04916                                                        PAYMENT_DELAY, PAYMENT_PERIOD,
<a name="l04917"></a>04917                                                        PLAN_LENGTH, nMaxPayments);
<a name="l04918"></a>04918     }
<a name="l04919"></a>04919     <span class="comment">// -----------------------------------------------</span>
<a name="l04920"></a>04920     <span class="keywordflow">if</span> (!bSuccessSetPaymentPlan)
<a name="l04921"></a>04921     {
<a name="l04922"></a>04922         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to set the payment plan.\n&quot;</span>, __FUNCTION__);
<a name="l04923"></a>04923         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a181efb58949ade53e690f4ebb0f4cfab">HarvestOpeningNumber</a> (*pNym);
<a name="l04924"></a>04924         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(*pNym);
<a name="l04925"></a>04925         <span class="keyword">delete</span> pPlan; pPlan = NULL;
<a name="l04926"></a>04926         <span class="keywordflow">return</span> NULL;
<a name="l04927"></a>04927     }
<a name="l04928"></a>04928     <span class="comment">// ------------------------------------------------</span>
<a name="l04929"></a>04929     pPlan-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym); <span class="comment">// Here we have saved the MERCHANT&#39;s VERSION.</span>
<a name="l04930"></a>04930     pPlan-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();      <span class="comment">// A copy of this will be attached to the CUSTOMER&#39;s version as well.</span>
<a name="l04931"></a>04931     <span class="comment">// ------------------------------</span>
<a name="l04932"></a>04932     <span class="comment">//</span>
<a name="l04933"></a>04933     <span class="comment">// DROP A COPY into the Outpayments box...</span>
<a name="l04934"></a>04934     <span class="comment">//</span>
<a name="l04935"></a>04935     <span class="comment">// (Since we used a transaction number to propose the plan, we</span>
<a name="l04936"></a>04936     <span class="comment">// have to track it until it&#39;s deposited or until we cancel it.)</span>
<a name="l04937"></a>04937     <span class="comment">//</span>
<a name="l04938"></a>04938     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInstrument(*pPlan);
<a name="l04939"></a>04939     <span class="comment">// ------------------------------</span>
<a name="l04940"></a>04940     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l04941"></a>04941     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l04942"></a>04942 
<a name="l04943"></a>04943     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(RECIPIENT_USER_ID), strNymID2(SENDER_USER_ID);
<a name="l04944"></a>04944 
<a name="l04945"></a>04945     pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outpaymentsMessage&quot;</span>;
<a name="l04946"></a>04946     pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l04947"></a>04947     pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
<a name="l04948"></a>04948     pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l04949"></a>04949     pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInstrument);
<a name="l04950"></a>04950 
<a name="l04951"></a>04951     pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l04952"></a>04952     pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l04953"></a>04953 
<a name="l04954"></a>04954     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l04955"></a>04955     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l04956"></a>04956     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l04957"></a>04957     <span class="comment">// ------------------------------</span>
<a name="l04958"></a>04958     <span class="keywordflow">return</span> pPlan;
<a name="l04959"></a>04959 }
<a name="l04960"></a>04960 
<a name="l04961"></a>04961 
<a name="l04962"></a>04962 
<a name="l04963"></a>04963 
<a name="l04964"></a>04964 
<a name="l04965"></a>04965 
<a name="l04966"></a>04966 
<a name="l04967"></a>04967 
<a name="l04968"></a>04968 <span class="comment">// CONFIRM PAYMENT PLAN  (CUSTOMER)</span>
<a name="l04969"></a>04969 <span class="comment">//</span>
<a name="l04970"></a>04970 <span class="comment">// Returns an OTPaymentPlan pointer, or NULL.</span>
<a name="l04971"></a>04971 <span class="comment">// (Caller responsible to delete.)</span>
<a name="l04972"></a>04972 <span class="comment">//</span>
<a name="l04973"></a>04973 <span class="comment">// The process (currently) is:</span>
<a name="l04974"></a>04974 <span class="comment">//</span>
<a name="l04975"></a>04975 <span class="comment">// 1) Payment plan is written, and signed, by the recipient. (Merchant.)</span>
<a name="l04976"></a>04976 <span class="comment">// 2) He sends it to the sender, who signs it and submits it. (Payer / Customer.)</span>
<a name="l04977"></a>04977 <span class="comment">// 3) The server loads the recipient nym to verify the transaction</span>
<a name="l04978"></a>04978 <span class="comment">//    number. The sender also had to burn a transaction number (to</span>
<a name="l04979"></a>04979 <span class="comment">//    submit it) so now, both have verified trns#s in this way.</span>
<a name="l04980"></a>04980 <span class="comment">//</span>
<a name="l04981"></a>04981 <span class="comment">//----------------------</span>
<a name="l04982"></a>04982 <span class="comment">//</span>
<a name="l04983"></a><a class="code" href="class_o_t___a_p_i.html#afe54d89f1f94b05bb2ecaffe9a02e1f4">04983</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#afe54d89f1f94b05bb2ecaffe9a02e1f4">OT_API::ConfirmPaymentPlan</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l04984"></a>04984                                 <span class="comment">// ----------------------------------------</span>
<a name="l04985"></a>04985                                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_USER_ID,
<a name="l04986"></a>04986                                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SENDER_ACCT_ID,
<a name="l04987"></a>04987                                 <span class="comment">// ----------------------------------------</span>
<a name="l04988"></a>04988                                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; RECIPIENT_USER_ID,
<a name="l04989"></a>04989                                 <span class="comment">// ----------------------------------------</span>
<a name="l04990"></a>04990                                 <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> &amp; thePlan)
<a name="l04991"></a>04991 {
<a name="l04992"></a>04992     <span class="comment">// -----------------------------------------------------</span>
<a name="l04993"></a>04993     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SENDER_USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This logs, ASSERTs, etc.</span>
<a name="l04994"></a>04994     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04995"></a>04995     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l04996"></a>04996     <span class="comment">// -----------------------------------------------------</span>
<a name="l04997"></a>04997     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, SENDER_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l04998"></a>04998     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04999"></a>04999     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l05000"></a>05000     <span class="comment">// -----------------------------------------------------</span>
<a name="l05001"></a>05001     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pMerchantNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a5d793f8c61422481fc3a266ec68c523a">LoadPublicNym</a>(RECIPIENT_USER_ID, __FUNCTION__);
<a name="l05002"></a>05002     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPseudonym&gt;</a> theNymAngel(pMerchantNym);
<a name="l05003"></a>05003 
<a name="l05004"></a>05004 <span class="comment">//  if (NULL == pMerchantNym) // We don&#39;t have this Nym in our storage already.</span>
<a name="l05005"></a>05005 <span class="comment">//  {</span>
<a name="l05006"></a>05006 <span class="comment">//      const OTString strRecipNymID(RECIPIENT_USER_ID);</span>
<a name="l05007"></a>05007 <span class="comment">//      OTLog::vOutput(0, &quot;%s: There&#39;s no (Merchant) Nym with the recipient&#39;s NymID in local storage: %s\n&quot;,</span>
<a name="l05008"></a>05008 <span class="comment">//                     __FUNCTION__, strRecipNymID.Get());</span>
<a name="l05009"></a>05009 <span class="comment">//        return false;</span>
<a name="l05010"></a>05010 <span class="comment">//  }</span>
<a name="l05011"></a>05011     <span class="comment">// pMerchantNym is also good, and has an angel. (No need to cleanup.)</span>
<a name="l05012"></a>05012     <span class="comment">//</span>
<a name="l05013"></a>05013     <span class="comment">// *******************************************************</span>
<a name="l05014"></a>05014     <span class="comment">// The &quot;Creation Date&quot; of the agreement is re-set here.</span>
<a name="l05015"></a>05015     <span class="comment">//</span>
<a name="l05016"></a>05016     <span class="keywordtype">bool</span> bConfirmed = thePlan.<a class="code" href="class_o_t_agreement.html#aa58d2054b933bffe9c2b2ca5564b7f49">Confirm</a>(*pNym, pMerchantNym, &amp;RECIPIENT_USER_ID);
<a name="l05017"></a>05017     <span class="comment">//</span>
<a name="l05018"></a>05018     <span class="comment">// WARNING:  The call to &quot;Confirm()&quot; uses TWO transaction numbers from pNym!</span>
<a name="l05019"></a>05019     <span class="comment">// If you don&#39;t end up actually USING this payment plan, then you need to retrieve</span>
<a name="l05020"></a>05020     <span class="comment">// those numbers and Add them back to pNym again.</span>
<a name="l05021"></a>05021     <span class="comment">// A nice client will store a copy of any payment plans until they are closed out, or canceled,</span>
<a name="l05022"></a>05022     <span class="comment">// or whatever.</span>
<a name="l05023"></a>05023     <span class="comment">// ANY FAILURES BELOW THIS POINT need to be smart enough to retrieve those numbers before returning.</span>
<a name="l05024"></a>05024     <span class="comment">//</span>
<a name="l05025"></a>05025     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05026"></a>05026 
<a name="l05027"></a>05027     <span class="keywordflow">if</span> (!bConfirmed)
<a name="l05028"></a>05028     {
<a name="l05029"></a>05029         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to confirm the agreement.\n&quot;</span>, __FUNCTION__);
<a name="l05030"></a>05030         thePlan.<a class="code" href="class_o_t_agreement.html#a181efb58949ade53e690f4ebb0f4cfab">HarvestOpeningNumber</a> (*pNym);
<a name="l05031"></a>05031         thePlan.<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(*pNym);
<a name="l05032"></a>05032         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05033"></a>05033     }
<a name="l05034"></a>05034     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l05035"></a>05035     thePlan.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym); <span class="comment">// Here we have saved the CUSTOMER&#39;s version,</span>
<a name="l05036"></a>05036     thePlan.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();      <span class="comment">// which contains a copy of the merchant&#39;s version.</span>
<a name="l05037"></a>05037     <span class="comment">// ------------------------------</span>
<a name="l05038"></a>05038     <span class="comment">//</span>
<a name="l05039"></a>05039     <span class="comment">// DROP A COPY into the Outpayments box...</span>
<a name="l05040"></a>05040     <span class="comment">//</span>
<a name="l05041"></a>05041     <span class="comment">// (Since we used a transaction number to confirm the plan, we</span>
<a name="l05042"></a>05042     <span class="comment">// have to track it until it&#39;s deposited or until we cancel it.)</span>
<a name="l05043"></a>05043     <span class="comment">//</span>
<a name="l05044"></a>05044     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strInstrument(thePlan);
<a name="l05045"></a>05045     <span class="comment">// ------------------------------</span>
<a name="l05046"></a>05046     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l05047"></a>05047     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l05048"></a>05048 
<a name="l05049"></a>05049     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(SENDER_USER_ID), strNymID2(RECIPIENT_USER_ID);
<a name="l05050"></a>05050 
<a name="l05051"></a>05051     pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outpaymentsMessage&quot;</span>;
<a name="l05052"></a>05052     pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l05053"></a>05053     pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
<a name="l05054"></a>05054     pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l05055"></a>05055     pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strInstrument);
<a name="l05056"></a>05056 
<a name="l05057"></a>05057     pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l05058"></a>05058     pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05059"></a>05059 
<a name="l05060"></a>05060     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l05061"></a>05061     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l05062"></a>05062     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);
<a name="l05063"></a>05063     <span class="comment">// ------------------------------</span>
<a name="l05064"></a>05064     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05065"></a>05065 }
<a name="l05066"></a>05066 
<a name="l05067"></a>05067 
<a name="l05068"></a>05068 
<a name="l05069"></a>05069 <span class="comment">// -----------------------------------------------------</span>
<a name="l05070"></a>05070 
<a name="l05071"></a>05071 
<a name="l05072"></a>05072 
<a name="l05073"></a>05073 
<a name="l05074"></a>05074 <span class="comment">// LOAD PURSE</span>
<a name="l05075"></a>05075 <span class="comment">//</span>
<a name="l05076"></a>05076 <span class="comment">// Returns an OTPurse pointer, or NULL.</span>
<a name="l05077"></a>05077 <span class="comment">//</span>
<a name="l05078"></a>05078 <span class="comment">// (Caller responsible to delete.)</span>
<a name="l05079"></a>05079 <span class="comment">//</span>
<a name="l05080"></a><a class="code" href="class_o_t___a_p_i.html#ae86b6c0831420bcf0ecadc603364d230">05080</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#ae86b6c0831420bcf0ecadc603364d230">OT_API::LoadPurse</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05081"></a>05081                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID,
<a name="l05082"></a>05082                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l05083"></a>05083                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05084"></a>05084 {
<a name="l05085"></a>05085     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05086"></a>05086     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05087"></a>05087     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Loading purse from local storage.&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05088"></a>05088     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData(strReason);
<a name="l05089"></a>05089     <span class="comment">// -----------------------------------</span>
<a name="l05090"></a>05090     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05091"></a>05091     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l05092"></a>05092     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_ID);
<a name="l05093"></a>05093     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05094"></a>05094     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__, &amp;thePWData); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05095"></a>05095     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l05096"></a>05096     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05097"></a>05097     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_ID, USER_ID);
<a name="l05098"></a>05098     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pPurse, <span class="stringliteral">&quot;Error allocating memory in the OT API.&quot;</span>); <span class="comment">// responsible to delete or return pPurse below this point.</span>
<a name="l05099"></a>05099 
<a name="l05100"></a>05100     <span class="keywordflow">if</span> (pPurse-&gt;<a class="code" href="class_o_t_purse.html#a6cda4ea82f97fab7719242c0827846f7">LoadPurse</a>(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l05101"></a>05101     {
<a name="l05102"></a>05102         <span class="keywordflow">if</span> (pPurse-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym)       &amp;&amp;
<a name="l05103"></a>05103             (SERVER_ID == pPurse-&gt;<a class="code" href="class_o_t_purse.html#aa6b026618394154f1a7f80064a5e6c50">GetServerID</a>()) &amp;&amp;
<a name="l05104"></a>05104             (ASSET_ID  == pPurse-&gt;<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a> ()))
<a name="l05105"></a>05105         {
<a name="l05106"></a>05106             <span class="keywordflow">return</span> pPurse;
<a name="l05107"></a>05107         }
<a name="l05108"></a>05108         <span class="keywordflow">else</span>
<a name="l05109"></a>05109             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying purse.\n&quot;</span>, __FUNCTION__);
<a name="l05110"></a>05110     }
<a name="l05111"></a>05111     <span class="keywordflow">else</span>
<a name="l05112"></a>05112         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Failed loading purse.\n&quot;</span>, __FUNCTION__);
<a name="l05113"></a>05113     <span class="comment">// --------------------------------</span>
<a name="l05114"></a>05114     <span class="keyword">delete</span> pPurse;
<a name="l05115"></a>05115     pPurse = NULL;
<a name="l05116"></a>05116 
<a name="l05117"></a>05117     <span class="keywordflow">return</span> NULL;
<a name="l05118"></a>05118 }
<a name="l05119"></a>05119 
<a name="l05120"></a>05120 
<a name="l05121"></a>05121 <span class="comment">// -----------------------------------------------------</span>
<a name="l05122"></a>05122 
<a name="l05123"></a>05123 
<a name="l05124"></a>05124 
<a name="l05125"></a><a class="code" href="class_o_t___a_p_i.html#ac3e808efa2420f7647ee0659de4ed176">05125</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ac3e808efa2420f7647ee0659de4ed176">OT_API::SavePurse</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05126"></a>05126                        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID,
<a name="l05127"></a>05127                        <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l05128"></a>05128                              <a class="code" href="class_o_t_purse.html">OTPurse</a>      &amp; THE_PURSE)
<a name="l05129"></a>05129 {
<a name="l05130"></a>05130     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05131"></a>05131     <span class="comment">// ---------------------------------------------------------</span>
<a name="l05132"></a>05132     <span class="keyword">const</span> <span class="keywordtype">char</span> *szFunc = <span class="stringliteral">&quot;OT_API::SavePurse&quot;</span>;
<a name="l05133"></a>05133     <span class="comment">// ---------------------------------------------------------</span>
<a name="l05134"></a>05134     <span class="keywordflow">if</span> (THE_PURSE.<a class="code" href="class_o_t_purse.html#a3546f66455d223a482a462c083b5713e">IsPasswordProtected</a>())
<a name="l05135"></a>05135     {
<a name="l05136"></a>05136         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: This purse is password-protected (exported) &quot;</span>
<a name="l05137"></a>05137                        <span class="stringliteral">&quot;and cannot be saved inside the wallet without first re-importing it.\n&quot;</span>, szFunc);
<a name="l05138"></a>05138     }
<a name="l05139"></a>05139     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((THE_PURSE.<a class="code" href="class_o_t_purse.html#aa6b026618394154f1a7f80064a5e6c50">GetServerID</a>() != SERVER_ID) ||
<a name="l05140"></a>05140              (THE_PURSE.<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>()  != ASSET_ID))
<a name="l05141"></a>05141     {
<a name="l05142"></a>05142         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Wrong server or asset ID passed in, &quot;</span>
<a name="l05143"></a>05143                        <span class="stringliteral">&quot;considering the purse that was passed.\n&quot;</span>, szFunc);
<a name="l05144"></a>05144     }
<a name="l05145"></a>05145     <span class="keywordflow">else</span>
<a name="l05146"></a>05146     {
<a name="l05147"></a>05147         <span class="comment">// -------------------------------------------------</span>
<a name="l05148"></a>05148         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l05149"></a>05149         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_ID);
<a name="l05150"></a>05150         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l05151"></a>05151         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05152"></a>05152         <span class="keywordflow">if</span> (THE_PURSE.<a class="code" href="class_o_t_purse.html#a40b0557a09d2183149dfc7bbd6145e0d">SavePurse</a>(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l05153"></a>05153             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05154"></a>05154     }
<a name="l05155"></a>05155     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05156"></a>05156     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPurse(THE_PURSE);
<a name="l05157"></a>05157     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed saving purse:\n\n%s\n\n&quot;</span>,
<a name="l05158"></a>05158                    szFunc, strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05159"></a>05159     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05160"></a>05160 }
<a name="l05161"></a>05161 
<a name="l05162"></a>05162 
<a name="l05163"></a>05163 
<a name="l05164"></a>05164 <span class="comment">// -----------------------------------------------------</span>
<a name="l05165"></a>05165 
<a name="l05166"></a>05166 <span class="comment">// Creates a purse owned by a specific Nym. (OWNER_ID.)</span>
<a name="l05167"></a>05167 <span class="comment">//</span>
<a name="l05168"></a>05168 <span class="comment">// Caller is responsible to delete!</span>
<a name="l05169"></a>05169 <span class="comment">//</span>
<a name="l05170"></a><a class="code" href="class_o_t___a_p_i.html#a85b0d012168cd75ed3aaebd08cba2dea">05170</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#a85b0d012168cd75ed3aaebd08cba2dea">OT_API::CreatePurse</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05171"></a>05171                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID,
<a name="l05172"></a>05172                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; OWNER_ID)
<a name="l05173"></a>05173 {
<a name="l05174"></a>05174     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05175"></a>05175     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05176"></a>05176     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_ID, OWNER_ID);
<a name="l05177"></a>05177     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pPurse, <span class="stringliteral">&quot;Error allocating memory in the OT API.&quot;</span>); <span class="comment">// responsible to delete or return pPurse below this point.</span>
<a name="l05178"></a>05178 
<a name="l05179"></a>05179     <span class="keywordflow">return</span> pPurse;
<a name="l05180"></a>05180 }
<a name="l05181"></a>05181 
<a name="l05182"></a>05182 
<a name="l05183"></a>05183 
<a name="l05184"></a>05184 <span class="comment">// -----------------------------------------------------</span>
<a name="l05185"></a>05185 
<a name="l05186"></a>05186 
<a name="l05187"></a>05187 
<a name="l05188"></a>05188 <span class="comment">// This is the same as CreatePurse, except it creates a password-protected purse,</span>
<a name="l05189"></a>05189 <span class="comment">// instead of a Nym-encrypted purse.</span>
<a name="l05190"></a>05190 <span class="comment">//</span>
<a name="l05191"></a>05191 <span class="comment">// Caller is responsible to delete!</span>
<a name="l05192"></a>05192 <span class="comment">//</span>
<a name="l05193"></a><a class="code" href="class_o_t___a_p_i.html#a0f580137479e85f755aadbecc85f84a0">05193</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#a0f580137479e85f755aadbecc85f84a0">OT_API::CreatePurse_Passphrase</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05194"></a>05194                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l05195"></a>05195 {
<a name="l05196"></a>05196     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05197"></a>05197     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05198"></a>05198     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_ID);
<a name="l05199"></a>05199     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pPurse, <span class="stringliteral">&quot;Error allocating memory in the OT API.&quot;</span>); <span class="comment">// responsible to delete or return pPurse below this point.</span>
<a name="l05200"></a>05200     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05201"></a>05201     <span class="keywordflow">if</span> (pPurse-&gt;<a class="code" href="class_o_t_purse.html#a2c89e783f9253e676ff2e25076265ea9">GenerateInternalKey</a>())
<a name="l05202"></a>05202         <span class="keywordflow">return</span> pPurse;
<a name="l05203"></a>05203     <span class="keywordflow">else</span>
<a name="l05204"></a>05204         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::CreatePurse_Passphrase: &quot;</span>
<a name="l05205"></a>05205                      <span class="stringliteral">&quot;pPurse-&gt;GenerateInternalKey() returned false. (Failure.)\n&quot;</span>);
<a name="l05206"></a>05206     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05207"></a>05207     <span class="keyword">delete</span> pPurse; pPurse = NULL;
<a name="l05208"></a>05208     <span class="keywordflow">return</span> NULL;
<a name="l05209"></a>05209 }
<a name="l05210"></a>05210 
<a name="l05211"></a>05211 <span class="comment">// -----------------------------------------------------</span>
<a name="l05212"></a>05212 
<a name="l05213"></a>05213 
<a name="l05214"></a>05214 
<a name="l05215"></a>05215 
<a name="l05216"></a>05216 <span class="comment">// Caller responsible to delete!</span>
<a name="l05217"></a>05217 <span class="comment">//</span>
<a name="l05218"></a>05218 <span class="comment">// This method was added because otherwise its code would be</span>
<a name="l05219"></a>05219 <span class="comment">// duplicated across many of the Purse functions.</span>
<a name="l05220"></a>05220 <span class="comment">//</span>
<a name="l05221"></a><a class="code" href="class_o_t___a_p_i.html#a8f169045c3550424b6b28df54539a183">05221</a> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * <a class="code" href="class_o_t___a_p_i.html#a8f169045c3550424b6b28df54539a183">OT_API::LoadPurseAndOwnerFromString</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID,
<a name="l05222"></a>05222                                                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAssetTypeID,
<a name="l05223"></a>05223                                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strPurse,
<a name="l05224"></a>05224                                                                   <a class="code" href="class_o_t_purse.html">OTPurse</a>      &amp; thePurse, <span class="comment">// output</span>
<a name="l05225"></a>05225                                                                   <a class="code" href="class_o_t_password.html">OTPassword</a>   &amp; thePassword, <span class="comment">// Only used in the case of password-protected purses. Passed in so it won&#39;t go out of scope when pOwner is set to point to it.</span>
<a name="l05226"></a>05226                                                             <span class="keyword">const</span> <span class="keywordtype">bool</span>           bForEncrypting<span class="comment">/*=true*/</span>, <span class="comment">// true==encrypting,false==decrypting. Only relevant if there&#39;s an owner.</span>
<a name="l05227"></a>05227                                                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pOWNER_ID<span class="comment">/*=NULL*/</span>, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise MUST contain the NymID for the Purse owner.</span>
<a name="l05228"></a>05228                                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay1<span class="comment">/*=NULL*/</span>, <span class="comment">// for purses owned by the wallet already</span>
<a name="l05229"></a>05229                                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay2<span class="comment">/*=NULL*/</span>) <span class="comment">// for password-protected purses</span>
<a name="l05230"></a>05230 {
<a name="l05231"></a>05231     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05232"></a>05232     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05233"></a>05233     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc             = __FUNCTION__; <span class="comment">//&quot;LoadPurseAndOwnerFromString&quot;;</span>
<a name="l05234"></a>05234     <span class="comment">// -----------------------------------------------------</span>
<a name="l05235"></a>05235     <span class="keyword">const</span> <span class="keywordtype">bool</span>   bDoesOwnerIDExist  = (NULL != pOWNER_ID); <span class="comment">// If not true, purse MUST be password-protected.</span>
<a name="l05236"></a>05236     <span class="comment">// -----------------------------------------------------</span>
<a name="l05237"></a>05237     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData1((NULL == pstrDisplay1) ?
<a name="l05238"></a>05238                               <span class="stringliteral">&quot;Enter the master passphrase for your wallet. (LoadPurseAndOwnerFromString)&quot;</span> :
<a name="l05239"></a>05239                               pstrDisplay1-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// for purses already owned by the wallet</span>
<a name="l05240"></a>05240     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData2((NULL == pstrDisplay2) ?
<a name="l05241"></a>05241                               <span class="stringliteral">&quot;Enter the passphrase for this purse. (LoadPurseAndOwnerFromString)&quot;</span> :
<a name="l05242"></a>05242                               pstrDisplay2-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()); <span class="comment">// for password-protected purses.</span>
<a name="l05243"></a>05243     <span class="comment">// -----------------------------------------------------</span>
<a name="l05244"></a>05244     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pOwnerNym         =  NULL; <span class="comment">// In the case where there is an owner, this will point to it.</span>
<a name="l05245"></a>05245     <span class="comment">// -----------------------------------------------------</span>
<a name="l05246"></a>05246     <span class="keywordflow">if</span> (bDoesOwnerIDExist)
<a name="l05247"></a>05247     {
<a name="l05248"></a>05248         pOwnerNym = bForEncrypting ? this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">GetOrLoadNym</a>(*pOWNER_ID, <span class="keyword">false</span>, szFunc, &amp;thePWData1) :
<a name="l05249"></a>05249                                      this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(*pOWNER_ID, <span class="keyword">false</span>, szFunc, &amp;thePWData1); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05250"></a>05250         <span class="keywordflow">if</span> (NULL == pOwnerNym) <span class="keywordflow">return</span> NULL;
<a name="l05251"></a>05251     }
<a name="l05252"></a>05252     <span class="comment">// By this point, pOwnerNym may be a good pointer, and on the wallet. (No need to cleanup.)</span>
<a name="l05253"></a>05253     <span class="comment">// Or, it may also be NULL, in the case that the purse is password-protected.</span>
<a name="l05254"></a>05254     <span class="comment">// bDoesOwnerIDExist is an easy way to tell, either way.</span>
<a name="l05255"></a>05255     <span class="comment">// -----------------------------------------------------</span>
<a name="l05256"></a>05256     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOwner = NULL;
<a name="l05257"></a>05257     <span class="comment">// -----------------------------------------------------</span>
<a name="l05258"></a>05258     <span class="keywordflow">if</span> (strPurse.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; thePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPurse))
<a name="l05259"></a>05259     {
<a name="l05260"></a>05260         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymIDIncludedInPurse = thePurse.<a class="code" href="class_o_t_purse.html#aa9fabc0850e503fe1bd507dbe9031915">IsNymIDIncluded</a>();
<a name="l05261"></a>05261         <span class="comment">// --------------------------------------</span>
<a name="l05262"></a>05262         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idPurseNym;
<a name="l05263"></a>05263 
<a name="l05264"></a>05264         <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#aa6b026618394154f1a7f80064a5e6c50">GetServerID</a>() != theServerID)
<a name="l05265"></a>05265             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: ServerID doesn&#39;t match.\n&quot;</span>, szFunc);
<a name="l05266"></a>05266         <span class="comment">// --------------------------------------</span>
<a name="l05267"></a>05267         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>() != theAssetTypeID)
<a name="l05268"></a>05268             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: AssetTypeID doesn&#39;t match.\n&quot;</span>, szFunc);
<a name="l05269"></a>05269         <span class="comment">// --------------------------------------</span>
<a name="l05270"></a>05270         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bNymIDIncludedInPurse &amp;&amp; !thePurse.<a class="code" href="class_o_t_purse.html#acd79fd6aebc25bb41034efc059ac77e6">GetNymID</a>(idPurseNym))
<a name="l05271"></a>05271             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to get the NymID from the &quot;</span>
<a name="l05272"></a>05272                           <span class="stringliteral">&quot;purse (though one WAS apparently present.)\n&quot;</span>, szFunc);
<a name="l05273"></a>05273         <span class="comment">// --------------------------------------</span>
<a name="l05274"></a>05274         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bNymIDIncludedInPurse &amp;&amp; !bDoesOwnerIDExist)
<a name="l05275"></a>05275         {
<a name="l05276"></a>05276             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPurseNymID(idPurseNym);
<a name="l05277"></a>05277             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: The purse is owned by a NymID, but no NymID was passed into &quot;</span>
<a name="l05278"></a>05278                           <span class="stringliteral">&quot;this function.\nNym who owns the purse: %s\n\n&quot;</span>, szFunc, strPurseNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05279"></a>05279         }
<a name="l05280"></a>05280         <span class="comment">// --------------------------------------</span>
<a name="l05281"></a>05281         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bNymIDIncludedInPurse &amp;&amp; !(pOwnerNym-&gt;GetConstID() == idPurseNym))
<a name="l05282"></a>05282         {
<a name="l05283"></a>05283             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strPurseNymID(idPurseNym), strNymActuallyPassed(pOwnerNym-&gt;GetConstID());
<a name="l05284"></a>05284             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: the API call mentions Nym A, but the purse is actually &quot;</span>
<a name="l05285"></a>05285                           <span class="stringliteral">&quot;owned by Nym B.\nNym A: %s\nNym B: %s\n\n&quot;</span>, szFunc, strNymActuallyPassed.Get(),
<a name="l05286"></a>05286                           strPurseNymID.Get());
<a name="l05287"></a>05287         }
<a name="l05288"></a>05288         <span class="comment">// --------------------------------------</span>
<a name="l05289"></a>05289         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bDoesOwnerIDExist &amp;&amp; !thePurse.<a class="code" href="class_o_t_purse.html#a3546f66455d223a482a462c083b5713e">IsPasswordProtected</a>())
<a name="l05290"></a>05290             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: The USER_ID was NULL, which is only allowed &quot;</span>
<a name="l05291"></a>05291                           <span class="stringliteral">&quot;for a password-protected purse. (And this purse is NOT &quot;</span>
<a name="l05292"></a>05292                           <span class="stringliteral">&quot;password-protected.) Please provide a USER_ID.\n&quot;</span>, szFunc);
<a name="l05293"></a>05293         <span class="comment">// --------------------------------------</span>
<a name="l05294"></a>05294         <span class="comment">// By this point, we know the purse loaded up properly, and the server and asset IDs match</span>
<a name="l05295"></a>05295         <span class="comment">// what we expected. We also know that if the purse included a NymID, it matches the USER_ID</span>
<a name="l05296"></a>05296         <span class="comment">// that was passed in. We also know that if a User ID was NOT passed in, that the purse WAS</span>
<a name="l05297"></a>05297         <span class="comment">// definitely a password-protected purse.</span>
<a name="l05298"></a>05298         <span class="comment">//</span>
<a name="l05299"></a>05299         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#a3546f66455d223a482a462c083b5713e">IsPasswordProtected</a>())  <span class="comment">// Purse is encrypted based on its own built-in symmetric key.</span>
<a name="l05300"></a>05300         {
<a name="l05301"></a>05301             <a class="code" href="class_o_t_symmetric_key.html">OTSymmetricKey</a> * pSymmetricKey = thePurse.<a class="code" href="class_o_t_purse.html#a33b82e7e9104846933b51d939c5d5f67">GetInternalKey</a>();
<a name="l05302"></a>05302             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSymmetricKey);
<a name="l05303"></a>05303             <span class="comment">// -------------------------</span>
<a name="l05304"></a>05304             <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotPassphrase = thePurse.<a class="code" href="class_o_t_purse.html#a0407a9c4d90472e8d79fb57edfae032a">GetPassphrase</a>(thePassword, thePWData2.GetDisplayString());
<a name="l05305"></a>05305 
<a name="l05306"></a>05306             <span class="keywordflow">if</span> (!bGotPassphrase)
<a name="l05307"></a>05307                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Authentication failed, or otherwise failed &quot;</span>
<a name="l05308"></a>05308                                <span class="stringliteral">&quot;retrieving secret from user.\n&quot;</span>, szFunc);
<a name="l05309"></a>05309             <span class="comment">// -------------------------</span>
<a name="l05310"></a>05310             <span class="comment">// Below this point, we know thePassword is good, and we know pSymmetricKey is good.</span>
<a name="l05311"></a>05311             <span class="comment">// Therefore...</span>
<a name="l05312"></a>05312             <span class="comment">//</span>
<a name="l05313"></a>05313             <span class="keywordflow">else</span>
<a name="l05314"></a>05314             {
<a name="l05315"></a>05315                 pOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pSymmetricKey, thePassword,
<a name="l05316"></a>05316                                                    pstrDisplay2); <span class="comment">// Can&#39;t put &amp;strReason here. (It goes out of scope.)</span>
<a name="l05317"></a>05317                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOwner);
<a name="l05318"></a>05318             }
<a name="l05319"></a>05319         }
<a name="l05320"></a>05320         <span class="comment">// --------------------------------------</span>
<a name="l05321"></a>05321         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bDoesOwnerIDExist)                <span class="comment">// Purse is encrypted based on Nym.</span>
<a name="l05322"></a>05322         {
<a name="l05323"></a>05323             pOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pOwnerNym, pstrDisplay1); <span class="comment">// Can&#39;t put &amp;strReason here. (It goes out of scope.)</span>
<a name="l05324"></a>05324             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOwner);
<a name="l05325"></a>05325         }
<a name="l05326"></a>05326         <span class="comment">// --------------------------------------</span>
<a name="l05327"></a>05327         <span class="keywordflow">else</span>
<a name="l05328"></a>05328             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: The purse is not password-protected, but rather, is locked by a Nym. &quot;</span>
<a name="l05329"></a>05329                           <span class="stringliteral">&quot;However, no USER_ID was passed in! Please supply a USER_ID in order &quot;</span>
<a name="l05330"></a>05330                           <span class="stringliteral">&quot;to open this purse.\n&quot;</span>, szFunc);
<a name="l05331"></a>05331         <span class="comment">// ************************************************************************************</span>
<a name="l05332"></a>05332         <span class="comment">// (By this point, pOwner is all set up and ready to go.)</span>
<a name="l05333"></a>05333     }
<a name="l05334"></a>05334     <span class="keywordflow">else</span>
<a name="l05335"></a>05335         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure loading purse from string:\n%s\n&quot;</span>,
<a name="l05336"></a>05336                        szFunc, strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05337"></a>05337     <span class="comment">// ----------------</span>
<a name="l05338"></a>05338     <span class="keywordflow">return</span> pOwner;
<a name="l05339"></a>05339 }
<a name="l05340"></a>05340 
<a name="l05341"></a>05341 
<a name="l05342"></a>05342 <span class="comment">// NOTE: This function is identical to the one above it, except</span>
<a name="l05343"></a>05343 <span class="comment">// that one has to verify that the Nym IDs match, whereas this one</span>
<a name="l05344"></a>05344 <span class="comment">// takes the NymID from the purse, if one is there, and makes it</span>
<a name="l05345"></a>05345 <span class="comment">// authoritative. If no NymID is listed on the purse (but it&#39;s NOT</span>
<a name="l05346"></a>05346 <span class="comment">// password protected, i.e. there IS a Nym, it&#39;s just not listed)</span>
<a name="l05347"></a>05347 <span class="comment">// then pOWNER_ID is the one it will try.</span>
<a name="l05348"></a>05348 <span class="comment">//</span>
<a name="l05349"></a>05349 <span class="comment">// Caller must delete.</span>
<a name="l05350"></a>05350 <span class="comment">//</span>
<a name="l05351"></a><a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">05351</a> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * <a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">OT_API::LoadPurseAndOwnerForMerge</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strPurse,
<a name="l05352"></a>05352                                                                 <a class="code" href="class_o_t_purse.html">OTPurse</a>      &amp; thePurse, <span class="comment">// output</span>
<a name="l05353"></a>05353                                                                 <a class="code" href="class_o_t_password.html">OTPassword</a>   &amp; thePassword, <span class="comment">// Only used in the case of password-protected purses. Passed in so it won&#39;t go out of scope when pOwner is set to point to it.</span>
<a name="l05354"></a>05354                                                           <span class="keyword">const</span> <span class="keywordtype">bool</span>           bCanBePublic<span class="comment">/*=false*/</span>, <span class="comment">// true==private nym isn&#39;t mandatory. false==private nym IS mandatory. (Only relevant if there&#39;s an owner.)</span>
<a name="l05355"></a>05355                                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pOWNER_ID<span class="comment">/*=NULL*/</span>, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise if it&#39;s Nym-protected, the purse will have a NymID on it already. If not (it&#39;s optional), then pOWNER_ID is the ID it will try next, before failing.</span>
<a name="l05356"></a>05356                                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05357"></a>05357 {
<a name="l05358"></a>05358     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05359"></a>05359     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05360"></a>05360     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = __FUNCTION__; <span class="comment">//&quot;LoadPurseAndOwnerForMerge&quot;;</span>
<a name="l05361"></a>05361     <span class="comment">// -----------------------------------------------------</span>
<a name="l05362"></a>05362     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWData((NULL == pstrDisplay) ? <a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05363"></a>05363     <span class="comment">// -----------------------------------</span>
<a name="l05364"></a>05364     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOwner = NULL;
<a name="l05365"></a>05365     <span class="comment">// -----------------------------------------------------</span>
<a name="l05366"></a>05366     <span class="keywordflow">if</span> (strPurse.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; thePurse.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strPurse))
<a name="l05367"></a>05367     {
<a name="l05368"></a>05368         <span class="comment">// --------------------------------------</span>
<a name="l05369"></a>05369         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> idPurseNym;
<a name="l05370"></a>05370 
<a name="l05371"></a>05371         <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#aa9fabc0850e503fe1bd507dbe9031915">IsNymIDIncluded</a>() &amp;&amp; !thePurse.<a class="code" href="class_o_t_purse.html#acd79fd6aebc25bb41034efc059ac77e6">GetNymID</a>(idPurseNym))
<a name="l05372"></a>05372             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to get the NymID from the &quot;</span>
<a name="l05373"></a>05373                           <span class="stringliteral">&quot;purse (though one WAS apparently present.)\n&quot;</span>, szFunc);
<a name="l05374"></a>05374         <span class="comment">// --------------------------------------</span>
<a name="l05375"></a>05375         <span class="comment">// Purse is encrypted based on Nym.</span>
<a name="l05376"></a>05376         <span class="comment">//</span>
<a name="l05377"></a>05377         <span class="comment">// If the purse includes a NymID, then we&#39;ll use it. (If we can&#39;t use that specific one, then we have failed.)</span>
<a name="l05378"></a>05378         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#aa9fabc0850e503fe1bd507dbe9031915">IsNymIDIncluded</a>() ||
<a name="l05379"></a>05379                  <span class="comment">// Else if the purse does NOT include a NymID (but also is NOT password protected, meaning a Nym still exists, but just isn&#39;t named) then we&#39;ll use pOWNER_ID passed in. If that&#39;s NULL, or we fail to find the Nym with it, then we have failed.</span>
<a name="l05380"></a>05380                  ( !thePurse.<a class="code" href="class_o_t_purse.html#aa9fabc0850e503fe1bd507dbe9031915">IsNymIDIncluded</a>() &amp;&amp; !thePurse.<a class="code" href="class_o_t_purse.html#a3546f66455d223a482a462c083b5713e">IsPasswordProtected</a>() ) <span class="comment">// &amp;&amp; (NULL != pOWNER_ID)) // checked inside the block.</span>
<a name="l05381"></a>05381                  )
<a name="l05382"></a>05382         {
<a name="l05383"></a>05383             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pActualOwnerID = thePurse.<a class="code" href="class_o_t_purse.html#aa9fabc0850e503fe1bd507dbe9031915">IsNymIDIncluded</a>() ? &amp;idPurseNym : pOWNER_ID;
<a name="l05384"></a>05384 
<a name="l05385"></a>05385             <span class="keywordflow">if</span> (NULL == pActualOwnerID)
<a name="l05386"></a>05386             {
<a name="l05387"></a>05387                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: The purse is encrypted to a specific Nym (not a passphrase) &quot;</span>
<a name="l05388"></a>05388                               <span class="stringliteral">&quot;but that Nym is not specified in the purse, nor was it passed into this &quot;</span>
<a name="l05389"></a>05389                               <span class="stringliteral">&quot;function. (Failure. Unable to access purse.)\n&quot;</span>, szFunc);
<a name="l05390"></a>05390                 <span class="keywordflow">return</span> NULL;
<a name="l05391"></a>05391             }
<a name="l05392"></a>05392             <span class="comment">// ---------------------------------------------------</span>
<a name="l05393"></a>05393             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pOwnerNym = bCanBePublic ? this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">GetOrLoadNym</a>       (*pActualOwnerID, <span class="keyword">false</span>, szFunc, &amp;thePWData) :
<a name="l05394"></a>05394                                                      this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(*pActualOwnerID, <span class="keyword">false</span>, szFunc, &amp;thePWData); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05395"></a>05395             <span class="keywordflow">if</span> (NULL == pOwnerNym)
<a name="l05396"></a>05396             {
<a name="l05397"></a>05397                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAttemptedID(*pActualOwnerID);
<a name="l05398"></a>05398                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: The purse is encrypted to a specific NymID (not a passphrase) which was &quot;</span>
<a name="l05399"></a>05399                               <span class="stringliteral">&quot;either specified inside the purse, or wasn&#39;t specified so we guessed the user ID. &quot;</span>
<a name="l05400"></a>05400                               <span class="stringliteral">&quot;Either way, we then failed loading that Nym: %s\n&quot;</span>
<a name="l05401"></a>05401                               <span class="stringliteral">&quot;(Failure. Unable to access purse.)\n&quot;</span>, szFunc, strAttemptedID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05402"></a>05402                 <span class="keywordflow">return</span> NULL;
<a name="l05403"></a>05403             }
<a name="l05404"></a>05404             <span class="comment">// ---------------------------------------------------</span>
<a name="l05405"></a>05405             <span class="comment">// We found the Nym. If it was the Nym listed in the purse, then it&#39;s almost certainly the right one.</span>
<a name="l05406"></a>05406             <span class="comment">// Else if it was the Nym we guessed, it could be right and it could be wrong. We won&#39;t find out in that</span>
<a name="l05407"></a>05407             <span class="comment">// case, until we actually try to use it for decrypting tokens on the purse (and then we&#39;ll fail at that</span>
<a name="l05408"></a>05408             <span class="comment">// time, if it&#39;s the wrong Nym.)</span>
<a name="l05409"></a>05409             <span class="comment">//</span>
<a name="l05410"></a>05410             pOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pOwnerNym, pstrDisplay); <span class="comment">// Can&#39;t put &amp;strReason here. (It goes out of scope.)</span>
<a name="l05411"></a>05411             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOwner);
<a name="l05412"></a>05412         }
<a name="l05413"></a>05413         <span class="comment">// --------------------------------------</span>
<a name="l05414"></a>05414         <span class="comment">// Else if purse IS password protected, then use its internal key.</span>
<a name="l05415"></a>05415         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thePurse.<a class="code" href="class_o_t_purse.html#a3546f66455d223a482a462c083b5713e">IsPasswordProtected</a>())  <span class="comment">// Purse is encrypted based on its own built-in symmetric key.</span>
<a name="l05416"></a>05416         {
<a name="l05417"></a>05417             <a class="code" href="class_o_t_symmetric_key.html">OTSymmetricKey</a> * pSymmetricKey = thePurse.<a class="code" href="class_o_t_purse.html#a33b82e7e9104846933b51d939c5d5f67">GetInternalKey</a>();
<a name="l05418"></a>05418             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pSymmetricKey);
<a name="l05419"></a>05419             <span class="comment">// -------------------------</span>
<a name="l05420"></a>05420             <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotPassphrase = thePurse.<a class="code" href="class_o_t_purse.html#a0407a9c4d90472e8d79fb57edfae032a">GetPassphrase</a>(thePassword, thePWData.GetDisplayString());
<a name="l05421"></a>05421 
<a name="l05422"></a>05422             <span class="keywordflow">if</span> (!bGotPassphrase)
<a name="l05423"></a>05423                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Authentication failed, or otherwise failed &quot;</span>
<a name="l05424"></a>05424                                <span class="stringliteral">&quot;retrieving secret from user.\n&quot;</span>, szFunc);
<a name="l05425"></a>05425             <span class="comment">// -------------------------</span>
<a name="l05426"></a>05426             <span class="comment">// Below this point, we know thePassword is good, and we know pSymmetricKey is good.</span>
<a name="l05427"></a>05427             <span class="comment">// Therefore...</span>
<a name="l05428"></a>05428             <span class="comment">//</span>
<a name="l05429"></a>05429             <span class="keywordflow">else</span>
<a name="l05430"></a>05430             {
<a name="l05431"></a>05431                 pOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pSymmetricKey, thePassword,
<a name="l05432"></a>05432                                                    pstrDisplay); <span class="comment">// Can&#39;t put &amp;strReason here. (It goes out of scope.)</span>
<a name="l05433"></a>05433                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOwner);
<a name="l05434"></a>05434             }
<a name="l05435"></a>05435         }
<a name="l05436"></a>05436         <span class="comment">// --------------------------------------</span>
<a name="l05437"></a>05437         <span class="keywordflow">else</span>
<a name="l05438"></a>05438             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed: Somehow this purse is not password-protected, nor is it &quot;</span>
<a name="l05439"></a>05439                           <span class="stringliteral">&quot;Nym-protected. (This error should never actually happen.)\n&quot;</span>, szFunc);
<a name="l05440"></a>05440         <span class="comment">// ************************************************************************************</span>
<a name="l05441"></a>05441         <span class="comment">// (By this point, pOwner is all set up and ready to go.)</span>
<a name="l05442"></a>05442     }
<a name="l05443"></a>05443     <span class="keywordflow">else</span>
<a name="l05444"></a>05444         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure loading purse from string:\n%s\n&quot;</span>,
<a name="l05445"></a>05445                        szFunc, strPurse.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05446"></a>05446     <span class="comment">// ----------------</span>
<a name="l05447"></a>05447     <span class="keywordflow">return</span> pOwner;
<a name="l05448"></a>05448 }
<a name="l05449"></a>05449 
<a name="l05450"></a>05450 
<a name="l05451"></a>05451 
<a name="l05452"></a>05452 
<a name="l05453"></a>05453 
<a name="l05465"></a><a class="code" href="class_o_t___a_p_i.html#ac4922a16395e2da553cf4f0bd0fdaf62">05465</a> <a class="code" href="class_o_t_token.html">OTToken</a> * <a class="code" href="class_o_t___a_p_i.html#ac4922a16395e2da553cf4f0bd0fdaf62">OT_API::Purse_Peek</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05466"></a>05466                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05467"></a>05467                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PURSE,
<a name="l05468"></a>05468                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pOWNER_ID<span class="comment">/*=NULL*/</span>, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise MUST contain the NymID for the Purse owner (necessary to decrypt the token.)</span>
<a name="l05469"></a>05469                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05470"></a>05470 {
<a name="l05471"></a>05471     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05472"></a>05472     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05473"></a>05473     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::Purse_Peek&quot;</span>;
<a name="l05474"></a>05474     <span class="comment">// -----------------------------------</span>
<a name="l05475"></a>05475     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason1((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter your master passphrase for your wallet. (Purse_Peek)&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05476"></a>05476     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason2((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter the passphrase for this purse. (Purse_Peek)&quot;</span>          : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05477"></a>05477 <span class="comment">//  OTPasswordData thePWData(strReason);</span>
<a name="l05478"></a>05478     <span class="comment">// -----------------------------------</span>
<a name="l05479"></a>05479     <a class="code" href="class_o_t_purse.html">OTPurse</a>    thePurse(SERVER_ID, ASSET_TYPE_ID);
<a name="l05480"></a>05480     <a class="code" href="class_o_t_password.html">OTPassword</a> thePassword; <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05481"></a>05481     <span class="comment">// -----------------------------------------------------</span>
<a name="l05482"></a>05482     <span class="comment">// What&#39;s going on here?</span>
<a name="l05483"></a>05483     <span class="comment">// A purse can be encrypted by a private key (controlled by a Nym) or by a symmetric</span>
<a name="l05484"></a>05484     <span class="comment">// key (embedded inside the purse along with a corresponding master key.) The below</span>
<a name="l05485"></a>05485     <span class="comment">// function is what actually loads up thePurse from string (THE_PURSE) and this call</span>
<a name="l05486"></a>05486     <span class="comment">// also returns pOwner, which is a pointer to a special wrapper class (which you must</span>
<a name="l05487"></a>05487     <span class="comment">// delete, when you&#39;re done with it) which contains a pointer EITHER to the owner Nym</span>
<a name="l05488"></a>05488     <span class="comment">// for that purse, OR to the &quot;owner&quot; symmetric key for that purse.</span>
<a name="l05489"></a>05489     <span class="comment">//</span>
<a name="l05490"></a>05490     <span class="comment">// This way, any subsequent purse operations can use pOwner, regardless of whether there</span>
<a name="l05491"></a>05491     <span class="comment">// is actually a Nym inside, or a symmetric key. (None of the purse operations will care,</span>
<a name="l05492"></a>05492     <span class="comment">// since they can use pOwner either way.)</span>
<a name="l05493"></a>05493     <span class="comment">//</span>
<a name="l05494"></a>05494     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a8f169045c3550424b6b28df54539a183">LoadPurseAndOwnerFromString</a>(SERVER_ID, ASSET_TYPE_ID,
<a name="l05495"></a>05495                                                                        THE_PURSE, thePurse, thePassword,
<a name="l05496"></a>05496                                                                        <span class="keyword">false</span>, <span class="comment">// bForEncrypting=true by default. (Peek needs to decrypt.)</span>
<a name="l05497"></a>05497                                                                        pOWNER_ID,
<a name="l05498"></a>05498                                                                        &amp;strReason1, &amp;strReason2);
<a name="l05499"></a>05499     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOwnerAngel(pOwner);
<a name="l05500"></a>05500     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05501"></a>05501     <span class="keywordflow">if</span> (NULL == pOwner) <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05502"></a>05502     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05503"></a>05503     <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = NULL;
<a name="l05504"></a>05504 
<a name="l05505"></a>05505     <span class="keywordflow">if</span> (thePurse.IsEmpty())
<a name="l05506"></a>05506         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed attempt to peek; purse is empty.\n&quot;</span>, szFunc);
<a name="l05507"></a>05507     <span class="keywordflow">else</span>
<a name="l05508"></a>05508     {
<a name="l05509"></a>05509         pToken = thePurse.Peek(*pOwner);
<a name="l05510"></a>05510 
<a name="l05511"></a>05511         <span class="keywordflow">if</span> (NULL == pToken)
<a name="l05512"></a>05512             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed peeking a token from a &quot;</span>
<a name="l05513"></a>05513                            <span class="stringliteral">&quot;purse that supposedly had tokens on it...\n&quot;</span>, szFunc);
<a name="l05514"></a>05514     }
<a name="l05515"></a>05515     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05516"></a>05516     <span class="keywordflow">return</span> pToken;
<a name="l05517"></a>05517 }
<a name="l05518"></a>05518 
<a name="l05519"></a>05519 
<a name="l05520"></a>05520 
<a name="l05521"></a>05521 
<a name="l05522"></a>05522 
<a name="l05523"></a>05523 <span class="comment">// -----------------------------------------------------</span>
<a name="l05524"></a>05524 
<a name="l05525"></a>05525 
<a name="l05542"></a><a class="code" href="class_o_t___a_p_i.html#a71b132b76b09ced31829d59348aa6a08">05542</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#a71b132b76b09ced31829d59348aa6a08">OT_API::Purse_Pop</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05543"></a>05543                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05544"></a>05544                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PURSE,
<a name="l05545"></a>05545                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pOWNER_ID<span class="comment">/*=NULL*/</span>, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise MUST contain the NymID for the Purse owner (necessary to decrypt the token.)</span>
<a name="l05546"></a>05546                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05547"></a>05547 {
<a name="l05548"></a>05548     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05549"></a>05549     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05550"></a>05550     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason1((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter your master passphrase for your wallet. (Purse_Pop)&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05551"></a>05551     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason2((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter the passphrase for this purse. (Purse_Pop)&quot;</span>          : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05552"></a>05552 <span class="comment">//  OTPasswordData thePWData(strReason);</span>
<a name="l05553"></a>05553     <span class="comment">// -----------------------------------</span>
<a name="l05554"></a>05554     <a class="code" href="class_o_t_purse.html">OTPurse</a>    * pPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID);
<a name="l05555"></a>05555     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPurse);
<a name="l05556"></a>05556     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> thePurseAngel(pPurse); <span class="comment">// We&#39;ll unset this in success case, so it doesn&#39;t delete the purse we&#39;re returning.</span>
<a name="l05557"></a>05557     <span class="comment">// -----------------------------------------------------</span>
<a name="l05558"></a>05558     <a class="code" href="class_o_t_password.html">OTPassword</a> thePassword; <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05559"></a>05559     <span class="comment">// -----------------------------------------------------</span>
<a name="l05560"></a>05560     <span class="comment">// What&#39;s going on here?</span>
<a name="l05561"></a>05561     <span class="comment">// A purse can be encrypted by a private key (controlled by a Nym) or by a symmetric</span>
<a name="l05562"></a>05562     <span class="comment">// key (embedded inside the purse along with a corresponding master key.) The below</span>
<a name="l05563"></a>05563     <span class="comment">// function is what actually loads up pPurse from string (THE_PURSE) and this call</span>
<a name="l05564"></a>05564     <span class="comment">// also returns pOwner, which is a pointer to a special wrapper class (which you must</span>
<a name="l05565"></a>05565     <span class="comment">// delete, when you&#39;re done with it) which contains a pointer EITHER to the owner Nym</span>
<a name="l05566"></a>05566     <span class="comment">// for that purse, OR to the &quot;owner&quot; symmetric key for that purse.</span>
<a name="l05567"></a>05567     <span class="comment">//</span>
<a name="l05568"></a>05568     <span class="comment">// This way, any subsequent purse operations can use pOwner, regardless of whether there</span>
<a name="l05569"></a>05569     <span class="comment">// is actually a Nym inside, or a symmetric key. (None of the purse operations will care,</span>
<a name="l05570"></a>05570     <span class="comment">// since they can use pOwner either way.)</span>
<a name="l05571"></a>05571     <span class="comment">//</span>
<a name="l05572"></a>05572     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a8f169045c3550424b6b28df54539a183">LoadPurseAndOwnerFromString</a>(SERVER_ID, ASSET_TYPE_ID,
<a name="l05573"></a>05573                                                                        THE_PURSE, *pPurse, thePassword,
<a name="l05574"></a>05574                                                                        <span class="keyword">false</span>, <span class="comment">//bForEncrypting=true by default, but Pop needs to decrypt.</span>
<a name="l05575"></a>05575                                                                        pOWNER_ID,
<a name="l05576"></a>05576                                                                        &amp;strReason1, &amp;strReason2);
<a name="l05577"></a>05577     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOwnerAngel(pOwner);
<a name="l05578"></a>05578     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05579"></a>05579     <span class="keywordflow">if</span> (NULL == pOwner) <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05580"></a>05580     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05581"></a>05581     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pReturnPurse = NULL;
<a name="l05582"></a>05582 
<a name="l05583"></a>05583     <span class="keywordflow">if</span> (pPurse-&gt;IsEmpty())
<a name="l05584"></a>05584         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed attempt to pop; purse is empty.\n&quot;</span>, __FUNCTION__);
<a name="l05585"></a>05585     <span class="keywordflow">else</span>
<a name="l05586"></a>05586     {
<a name="l05587"></a>05587         <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = pPurse-&gt;Pop(*pOwner);
<a name="l05588"></a>05588         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l05589"></a>05589 
<a name="l05590"></a>05590         <span class="keywordflow">if</span> (NULL == pToken)
<a name="l05591"></a>05591             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed popping a token from a &quot;</span>
<a name="l05592"></a>05592                            <span class="stringliteral">&quot;purse that supposedly had tokens on it...\n&quot;</span>, __FUNCTION__);
<a name="l05593"></a>05593         <span class="keywordflow">else</span>
<a name="l05594"></a>05594         {
<a name="l05595"></a>05595             pReturnPurse = pPurse;
<a name="l05596"></a>05596             thePurseAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// We don&#39;t clean up the purse in the case where we&#39;re returning it.</span>
<a name="l05597"></a>05597         }
<a name="l05598"></a>05598     }
<a name="l05599"></a>05599     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05600"></a>05600     <span class="keywordflow">return</span> pReturnPurse;
<a name="l05601"></a>05601 
<a name="l05602"></a>05602     <span class="comment">// NOTE: Caller must release/sign/save pReturnPurse, once this returns, in order to effect the change.</span>
<a name="l05603"></a>05603 }
<a name="l05604"></a>05604 
<a name="l05605"></a>05605 
<a name="l05606"></a>05606 <span class="comment">// -----------------------------------------------------</span>
<a name="l05607"></a>05607 
<a name="l05608"></a>05608 
<a name="l05609"></a>05609 <span class="comment">// Caller must delete.</span>
<a name="l05610"></a><a class="code" href="class_o_t___a_p_i.html#adc667ad801925aaddd138f0dd7d0770e">05610</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#adc667ad801925aaddd138f0dd7d0770e">OT_API::Purse_Empty</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05611"></a>05611                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05612"></a>05612                               <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PURSE,
<a name="l05613"></a>05613                               <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05614"></a>05614 {
<a name="l05615"></a>05615     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05616"></a>05616     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05617"></a>05617     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Making an empty copy of a cash purse.&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05618"></a>05618 <span class="comment">//  OTPasswordData thePWData(strReason);</span>
<a name="l05619"></a>05619     <span class="comment">// -----------------------------------</span>
<a name="l05620"></a>05620     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse = <a class="code" href="class_o_t_purse.html#ac6779fce5508f7d2dc2e02c22595d7e0">OTPurse::PurseFactory</a>(THE_PURSE, SERVER_ID, ASSET_TYPE_ID);
<a name="l05621"></a>05621 
<a name="l05622"></a>05622     <span class="keywordflow">if</span> (NULL == pPurse)
<a name="l05623"></a>05623     {
<a name="l05624"></a>05624         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: THE_PURSE is an empty string. Please pass a &quot;</span>
<a name="l05625"></a>05625                        <span class="stringliteral">&quot;real purse when calling this function.\n&quot;</span>, __FUNCTION__);
<a name="l05626"></a>05626         <span class="keywordflow">return</span> NULL;
<a name="l05627"></a>05627     }
<a name="l05628"></a>05628     <span class="comment">// -----------------------------------------------------</span>
<a name="l05629"></a>05629     pPurse-&gt;ReleaseTokens();
<a name="l05630"></a>05630     <span class="comment">// NOTE: Caller must release/sign/save pReturnPurse, once this returns, in order to effect the change.</span>
<a name="l05631"></a>05631     <span class="keywordflow">return</span> pPurse;
<a name="l05632"></a>05632 }
<a name="l05633"></a>05633 
<a name="l05634"></a>05634 
<a name="l05635"></a>05635 
<a name="l05636"></a>05636 <span class="comment">// -----------------------------------------------------</span>
<a name="l05637"></a>05637 
<a name="l05649"></a><a class="code" href="class_o_t___a_p_i.html#a480eef589ef3fd1f416930540e46082f">05649</a> <a class="code" href="class_o_t_purse.html">OTPurse</a> * <a class="code" href="class_o_t___a_p_i.html#a480eef589ef3fd1f416930540e46082f">OT_API::Purse_Push</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05650"></a>05650                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05651"></a>05651                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PURSE,
<a name="l05652"></a>05652                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_TOKEN,
<a name="l05653"></a>05653                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> * pOWNER_ID<span class="comment">/*=NULL*/</span>, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise MUST contain the NymID for the Purse owner (necessary to encrypt the token.)</span>
<a name="l05654"></a>05654                              <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05655"></a>05655 {
<a name="l05656"></a>05656     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05657"></a>05657     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05658"></a>05658     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason1((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter your master passphrase for your wallet. (Purse_Push)&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05659"></a>05659     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strReason2((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter the passphrase for this purse. (Purse_Push)&quot;</span>          : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05660"></a>05660 <span class="comment">//  OTPasswordData thePWData(strReason);</span>
<a name="l05661"></a>05661     <span class="comment">// -----------------------------------</span>
<a name="l05662"></a>05662     <span class="keywordflow">if</span> (!THE_PURSE.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05663"></a>05663     {
<a name="l05664"></a>05664         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Purse does not exist.\n&quot;</span>, __FUNCTION__);
<a name="l05665"></a>05665         <span class="keywordflow">return</span> NULL;
<a name="l05666"></a>05666     }
<a name="l05667"></a>05667     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!THE_TOKEN.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l05668"></a>05668     {
<a name="l05669"></a>05669         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Token does not exist.\n&quot;</span>, __FUNCTION__);
<a name="l05670"></a>05670         <span class="keywordflow">return</span> NULL;
<a name="l05671"></a>05671     }
<a name="l05672"></a>05672     <span class="comment">// -----------------------------------</span>
<a name="l05673"></a>05673     <a class="code" href="class_o_t_string.html">OTString</a> strToken(THE_TOKEN);
<a name="l05674"></a>05674     <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ac758de04ed60991098005a7ac9578d71">OTToken::TokenFactory</a>(strToken, SERVER_ID, ASSET_TYPE_ID);
<a name="l05675"></a>05675     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l05676"></a>05676 
<a name="l05677"></a>05677     <span class="keywordflow">if</span> (NULL == pToken) <span class="comment">// TokenFactory instantiates AND loads from string.</span>
<a name="l05678"></a>05678     {
<a name="l05679"></a>05679         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to instantiate or load token from string:\n\n%s\n\n&quot;</span>,
<a name="l05680"></a>05680                        __FUNCTION__, THE_TOKEN.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05681"></a>05681         <span class="keywordflow">return</span> NULL;
<a name="l05682"></a>05682     }
<a name="l05683"></a>05683     <span class="comment">// -----------------------------------</span>
<a name="l05684"></a>05684     <a class="code" href="class_o_t_purse.html">OTPurse</a>    * pPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID);
<a name="l05685"></a>05685     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPurse);
<a name="l05686"></a>05686     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> thePurseAngel(pPurse); <span class="comment">// We&#39;ll unset this in success case, so it doesn&#39;t delete the purse we&#39;re returning.</span>
<a name="l05687"></a>05687     <span class="comment">// -----------------------------------------------------</span>
<a name="l05688"></a>05688     <a class="code" href="class_o_t_password.html">OTPassword</a> thePassword; <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05689"></a>05689     <span class="comment">// -----------------------------------------------------</span>
<a name="l05690"></a>05690     <span class="comment">// What&#39;s going on here?</span>
<a name="l05691"></a>05691     <span class="comment">// A purse can be encrypted by a private key (controlled by a Nym) or by a symmetric</span>
<a name="l05692"></a>05692     <span class="comment">// key (embedded inside the purse along with a corresponding master key.) The below</span>
<a name="l05693"></a>05693     <span class="comment">// function is what actually loads up pPurse from string (THE_PURSE) and this call</span>
<a name="l05694"></a>05694     <span class="comment">// also returns pOwner, which is a pointer to a special wrapper class (which you must</span>
<a name="l05695"></a>05695     <span class="comment">// delete, when you&#39;re done with it) which contains a pointer EITHER to the owner Nym</span>
<a name="l05696"></a>05696     <span class="comment">// for that purse, OR to the &quot;owner&quot; symmetric key for that purse.</span>
<a name="l05697"></a>05697     <span class="comment">//</span>
<a name="l05698"></a>05698     <span class="comment">// This way, any subsequent purse operations can use pOwner, regardless of whether there</span>
<a name="l05699"></a>05699     <span class="comment">// is actually a Nym inside, or a symmetric key. (None of the purse operations will care,</span>
<a name="l05700"></a>05700     <span class="comment">// since they can use pOwner either way.)</span>
<a name="l05701"></a>05701     <span class="comment">//</span>
<a name="l05702"></a>05702     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a8f169045c3550424b6b28df54539a183">LoadPurseAndOwnerFromString</a>(SERVER_ID, ASSET_TYPE_ID,
<a name="l05703"></a>05703                                                                        THE_PURSE, *pPurse, thePassword,
<a name="l05704"></a>05704                                                                        <span class="keyword">true</span>, <span class="comment">//bForEncrypting=true by default.</span>
<a name="l05705"></a>05705                                                                        pOWNER_ID,
<a name="l05706"></a>05706                                                                        &amp;strReason1, &amp;strReason2);
<a name="l05707"></a>05707     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOwnerAngel(pOwner);
<a name="l05708"></a>05708     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05709"></a>05709     <span class="keywordflow">if</span> (NULL == pOwner) <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05710"></a>05710     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05711"></a>05711     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pReturnPurse = NULL;
<a name="l05712"></a>05712 
<a name="l05713"></a>05713     <span class="keyword">const</span> <span class="keywordtype">bool</span> bPushed = pPurse-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pOwner, *pToken);
<a name="l05714"></a>05714 
<a name="l05715"></a>05715     <span class="keywordflow">if</span> (!bPushed)
<a name="l05716"></a>05716         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed pushing a token onto a purse.\n&quot;</span>, __FUNCTION__);
<a name="l05717"></a>05717     <span class="keywordflow">else</span>
<a name="l05718"></a>05718     {
<a name="l05719"></a>05719         pReturnPurse = pPurse;
<a name="l05720"></a>05720         thePurseAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// We don&#39;t clean up the purse in the case where we&#39;re returning it.</span>
<a name="l05721"></a>05721     }
<a name="l05722"></a>05722     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05723"></a>05723     <span class="keywordflow">return</span> pReturnPurse;
<a name="l05724"></a>05724 
<a name="l05725"></a>05725     <span class="comment">// NOTE: Caller must release/sign/save pReturnPurse, once this returns, in order to effect the change.</span>
<a name="l05726"></a>05726 }
<a name="l05727"></a>05727 
<a name="l05728"></a>05728 
<a name="l05729"></a>05729 <span class="comment">// -----------------------------------------------------</span>
<a name="l05730"></a>05730 
<a name="l05731"></a>05731 
<a name="l05732"></a>05732 
<a name="l05733"></a><a class="code" href="class_o_t___a_p_i.html#a4b5282e8670208c395d3ab98a9a2a315">05733</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a4b5282e8670208c395d3ab98a9a2a315">OT_API::Wallet_ImportPurse</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05734"></a>05734                                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05735"></a>05735                                 <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SIGNER_ID, <span class="comment">// We must know the SIGNER_ID in order to know which &quot;old purse&quot; to load and merge into. The New Purse may have a different one, but its ownership will be re-assigned in that case, as part of the merging process, to SIGNER_ID. Otherwise the New Purse might be symmetrically encrypted (instead of using a Nym) in which case again, its ownership will be re-assigned from that key, to SIGNER_ID, as part of the merging process.</span>
<a name="l05736"></a>05736                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PURSE,
<a name="l05737"></a>05737                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05738"></a>05738 {
<a name="l05739"></a>05739     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05740"></a>05740     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05741"></a>05741     <a class="code" href="class_o_t_string.html">OTString</a> strPurseReason ((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter passphrase for purse being imported.&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05742"></a>05742     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataWallet((NULL == pstrDisplay) ? <a class="code" href="_o_t_callback_8hpp.html#aec99f1909896090ab9b64ce848f50c6a">OT_PW_DISPLAY</a> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05743"></a>05743     <span class="comment">// -----------------------------------</span>
<a name="l05744"></a>05744     <a class="code" href="class_o_t_password.html">OTPassword</a> thePassword; <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05745"></a>05745     <span class="comment">// -----------------------------------------------------</span>
<a name="l05746"></a>05746     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_ID, <span class="keyword">false</span>, __FUNCTION__, &amp;thePWDataWallet); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05747"></a>05747     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05748"></a>05748     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l05749"></a>05749     <span class="comment">// -----------------------------------------------------</span>
<a name="l05750"></a>05750     <a class="code" href="class_o_t_purse.html">OTPurse</a>    * pNewPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID);
<a name="l05751"></a>05751     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNewPurse);
<a name="l05752"></a>05752     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> theNewPurseAngel(pNewPurse);
<a name="l05753"></a>05753     <span class="comment">// -----------------------------------------------------</span>
<a name="l05754"></a>05754     <span class="comment">// What&#39;s going on here?</span>
<a name="l05755"></a>05755     <span class="comment">// A purse can be encrypted by a private key (controlled by a Nym) or by a symmetric</span>
<a name="l05756"></a>05756     <span class="comment">// key (embedded inside the purse along with a corresponding master key.) The below</span>
<a name="l05757"></a>05757     <span class="comment">// function is what actually loads up pPurse from string (THE_PURSE) and this call</span>
<a name="l05758"></a>05758     <span class="comment">// also returns pOwner, which is a pointer to a special wrapper class (which you must</span>
<a name="l05759"></a>05759     <span class="comment">// delete, when you&#39;re done with it) which contains a pointer EITHER to the owner Nym</span>
<a name="l05760"></a>05760     <span class="comment">// for that purse, OR to the &quot;owner&quot; symmetric key for that purse.</span>
<a name="l05761"></a>05761     <span class="comment">//</span>
<a name="l05762"></a>05762     <span class="comment">// This way, any subsequent purse operations can use pOwner, regardless of whether there</span>
<a name="l05763"></a>05763     <span class="comment">// is actually a Nym inside, or a symmetric key. (None of the purse operations will care,</span>
<a name="l05764"></a>05764     <span class="comment">// since they can use pOwner either way.)</span>
<a name="l05765"></a>05765     <span class="comment">//</span>
<a name="l05766"></a>05766     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pNewOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">LoadPurseAndOwnerForMerge</a>(THE_PURSE, *pNewPurse, thePassword,
<a name="l05767"></a>05767                                                                         <span class="keyword">false</span>, <span class="comment">//bCanBePublic=false by default. (Private Nym must be loaded, if a nym is the owner.)</span>
<a name="l05768"></a>05768                                                                         &amp;SIGNER_ID, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise if it&#39;s Nym-protected, the purse will have a NymID on it already, which is what LoadPurseAndOwnerForMerge will try first. If not (it&#39;s optional), then SIGNER_ID is the ID it will try next, before failing altogether.</span>
<a name="l05769"></a>05769                                                                         &amp;strPurseReason);
<a name="l05770"></a>05770     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOwnerAngel(pNewOwner);
<a name="l05771"></a>05771     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05772"></a>05772     <span class="keywordflow">if</span> (NULL == pNewOwner) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05773"></a>05773     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05774"></a>05774     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pOldPurse = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ae86b6c0831420bcf0ecadc603364d230">LoadPurse</a>(SERVER_ID, ASSET_TYPE_ID, SIGNER_ID);
<a name="l05775"></a>05775     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> theOldPurseAngel(pOldPurse);
<a name="l05776"></a>05776 
<a name="l05777"></a>05777     <span class="keywordflow">if</span> (NULL == pOldPurse) <span class="comment">// apparently there&#39;s not already a purse of this type, let&#39;s create it.</span>
<a name="l05778"></a>05778     {
<a name="l05779"></a>05779         pOldPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID, SIGNER_ID);
<a name="l05780"></a>05780         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOldPurse);
<a name="l05781"></a>05781         <span class="comment">// ---------------------------------------</span>
<a name="l05782"></a>05782         theOldPurseAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pOldPurse);
<a name="l05783"></a>05783     }
<a name="l05784"></a>05784     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pOldPurse-&gt;<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym))
<a name="l05785"></a>05785     {
<a name="l05786"></a>05786         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed to verify signature on old purse. (Very strange...)\n&quot;</span>, __FUNCTION__);
<a name="l05787"></a>05787         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05788"></a>05788     }
<a name="l05789"></a>05789     <span class="comment">// -----------------------------------------------------</span>
<a name="l05790"></a>05790     <span class="comment">// By this point, the old purse has either been loaded, or created.</span>
<a name="l05791"></a>05791     <span class="comment">// Let&#39;s make sure the server and asset ID match between the purses,</span>
<a name="l05792"></a>05792     <span class="comment">// since they are now actually loaded up.</span>
<a name="l05793"></a>05793     <span class="comment">//</span>
<a name="l05794"></a>05794     <span class="keywordflow">if</span> (pOldPurse-&gt;<a class="code" href="class_o_t_purse.html#aa6b026618394154f1a7f80064a5e6c50">GetServerID</a>() != pNewPurse-&gt;<a class="code" href="class_o_t_purse.html#aa6b026618394154f1a7f80064a5e6c50">GetServerID</a>())
<a name="l05795"></a>05795     {
<a name="l05796"></a>05796         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: ServerIDs don&#39;t match between these two purses.\n&quot;</span>, __FUNCTION__);
<a name="l05797"></a>05797         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05798"></a>05798     }
<a name="l05799"></a>05799     <span class="comment">// -----------------------------------------------------------</span>
<a name="l05800"></a>05800     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pOldPurse-&gt;<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>() != pNewPurse-&gt;<a class="code" href="class_o_t_purse.html#af87e5b076d8d738e6b32e56cc49737c1">GetAssetID</a>())
<a name="l05801"></a>05801     {
<a name="l05802"></a>05802         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: AssetIDs don&#39;t match between these two purses.\n&quot;</span>, __FUNCTION__);
<a name="l05803"></a>05803         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05804"></a>05804     }
<a name="l05805"></a>05805     <span class="comment">// -----------------------------------------------------</span>
<a name="l05806"></a>05806     <span class="comment">//</span>
<a name="l05807"></a>05807     <span class="comment">// By this point, I have two owners, and two purses.</span>
<a name="l05808"></a>05808     <span class="comment">//</span>
<a name="l05809"></a>05809     <span class="comment">// NOTE: if I want to pass in a custom display string here, pNym could be replaced with</span>
<a name="l05810"></a>05810     <span class="comment">// pOldOwner (an OTNym_or_SymmetricKey instance) which can contain that string.</span>
<a name="l05811"></a>05811     <span class="comment">// (I&#39;m referring to the string that contains the &quot;reason&quot; why the passphrase needs to</span>
<a name="l05812"></a>05812     <span class="comment">// be entered, so it can be shown to the user on the passphrase dialog.)</span>
<a name="l05813"></a>05813     <span class="comment">//</span>
<a name="l05814"></a>05814     <span class="keywordflow">if</span> (pOldPurse-&gt;<a class="code" href="class_o_t_purse.html#aaabdf20e412ce34bade7a3c280973355">Merge</a>(*pNym, <span class="comment">// signer</span>
<a name="l05815"></a>05815                          *pNym, <span class="comment">// old owner (must be private, if a nym.)</span>
<a name="l05816"></a>05816                          *pNewOwner, <span class="comment">// new owner (must be private, if a nym.)</span>
<a name="l05817"></a>05817                          *pNewPurse)) <span class="comment">// new purse (being merged into old.)</span>
<a name="l05818"></a>05818     {
<a name="l05819"></a>05819         pOldPurse-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l05820"></a>05820         pOldPurse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l05821"></a>05821         pOldPurse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05822"></a>05822         <span class="comment">// -------------------------------------------------</span>
<a name="l05823"></a>05823         <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_o_t___a_p_i.html#ac3e808efa2420f7647ee0659de4ed176">SavePurse</a>(SERVER_ID, ASSET_TYPE_ID, SIGNER_ID, *pOldPurse);
<a name="l05824"></a>05824     }
<a name="l05825"></a>05825     <span class="keywordflow">else</span> <span class="comment">// Failed merge.</span>
<a name="l05826"></a>05826     {
<a name="l05827"></a>05827         <a class="code" href="class_o_t_string.html">OTString</a>   strNymID1, strNymID2;
<a name="l05828"></a>05828         pNym-&gt;     GetIdentifier(strNymID1);
<a name="l05829"></a>05829         pNewOwner-&gt;<a class="code" href="class_o_t_nym__or___symmetric_key.html#a9a401c9d880a03cfbcb5dd2ed4813c86">GetIdentifier</a>(strNymID2);
<a name="l05830"></a>05830         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: (OldNymID: %s.) (New Owner ID: %s.) Failure merging new &quot;</span>
<a name="l05831"></a>05831                        <span class="stringliteral">&quot;purse:\n\n%s\n\n&quot;</span>, __FUNCTION__, strNymID1.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strNymID2.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l05832"></a>05832                        THE_PURSE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05833"></a>05833     }
<a name="l05834"></a>05834     <span class="comment">// -----------------------------------------------------</span>
<a name="l05835"></a>05835     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l05836"></a>05836 }
<a name="l05837"></a>05837 
<a name="l05838"></a>05838 
<a name="l05839"></a>05839 
<a name="l05840"></a>05840 <span class="comment">// -----------------------------------------------------</span>
<a name="l05841"></a>05841 
<a name="l05842"></a>05842 
<a name="l05843"></a>05843 
<a name="l05844"></a>05844 <span class="comment">// ALLOW the caller to pass a symmetric key here, instead of either Nym ID.</span>
<a name="l05845"></a>05845 <span class="comment">// We&#39;ll load it up and use it instead of a Nym. Update: make that a purse.</span>
<a name="l05846"></a>05846 <span class="comment">// These tokens already belong to specific purses, so just pass the purse here</span>
<a name="l05847"></a>05847 <span class="comment">//</span>
<a name="l05848"></a>05848 <span class="comment">// Done: Also, add a key cache with a timeout (similar to Master Key) where we can stash</span>
<a name="l05849"></a>05849 <span class="comment">// any already-loaded symmetric keys, and a thread wipes them out later. That way</span>
<a name="l05850"></a>05850 <span class="comment">// even if we have to load the key each time this func is called, we still avoid the</span>
<a name="l05851"></a>05851 <span class="comment">// user having to enter the passphrase more than once per timeout period.</span>
<a name="l05852"></a>05852 <span class="comment">//</span>
<a name="l05853"></a>05853 <span class="comment">// Done also: allow a &quot;Signer ID&quot; to be passed in here, since either owner could potentially</span>
<a name="l05854"></a>05854 <span class="comment">// now be a symmetric key.</span>
<a name="l05855"></a>05855 <span class="comment">//</span>
<a name="l05856"></a>05856 <span class="comment">// Caller must delete!</span>
<a name="l05857"></a>05857 <span class="comment">//</span>
<a name="l05858"></a><a class="code" href="class_o_t___a_p_i.html#a7183d283456ab1e13c01f88b71062828">05858</a> <a class="code" href="class_o_t_token.html">OTToken</a> * <a class="code" href="class_o_t___a_p_i.html#a7183d283456ab1e13c01f88b71062828">OT_API::Token_ChangeOwner</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l05859"></a>05859                                     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l05860"></a>05860                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_TOKEN,
<a name="l05861"></a>05861                                     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SIGNER_NYM_ID,
<a name="l05862"></a>05862                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; OLD_OWNER, <span class="comment">// Pass a NymID here, or a purse.</span>
<a name="l05863"></a>05863                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; NEW_OWNER, <span class="comment">// Pass a NymID here, or a purse.</span>
<a name="l05864"></a>05864                                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     * pstrDisplay<span class="comment">/*=NULL*/</span>)
<a name="l05865"></a>05865 {
<a name="l05866"></a>05866     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l05867"></a>05867     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05868"></a>05868     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::Token_ChangeOwner&quot;</span>;
<a name="l05869"></a>05869     <span class="comment">// -----------------------------------------------------</span>
<a name="l05870"></a>05870     <a class="code" href="class_o_t_string.html">OTString</a> strWalletReason((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter your wallet&#39;s master passphrase. (Token_ChangeOwner.)&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05871"></a>05871     <a class="code" href="class_o_t_string.html">OTString</a> strPurseReason ((NULL == pstrDisplay) ? <span class="stringliteral">&quot;Enter the passphrase for this purse. (Token_ChangeOwner.)&quot;</span> : pstrDisplay-&gt;<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l05872"></a>05872     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataWallet(strWalletReason);
<a name="l05873"></a>05873     <span class="comment">// -----------------------------------------------------</span>
<a name="l05874"></a>05874     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(SIGNER_NYM_ID, <span class="keyword">false</span>, szFunc, &amp;thePWDataWallet); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05875"></a>05875     <span class="keywordflow">if</span> (NULL == pSignerNym) <span class="keywordflow">return</span> NULL;
<a name="l05876"></a>05876     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l05877"></a>05877     <span class="comment">// -----------------------------------------------------</span>
<a name="l05878"></a>05878     <span class="comment">// ALL THE COMPLEXITY YOU SEE BELOW is mainly just about handling OLD_OWNER</span>
<a name="l05879"></a>05879     <span class="comment">// and NEW_OWNER each as either a NymID or as a Purse (containing a symmetric key and</span>
<a name="l05880"></a>05880     <span class="comment">// a corresponding master key.)</span>
<a name="l05881"></a>05881     <span class="comment">// -----------------------------------------------------</span>
<a name="l05882"></a>05882     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> oldOwnerNymID, newOwnerNymID; <span class="comment">// if either owner is a Nym, the ID goes here.</span>
<a name="l05883"></a>05883     <span class="comment">// ------------------------------</span>
<a name="l05884"></a>05884     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pOldPurse = NULL;                <span class="comment">// if the old owner is a Purse (symmetric+master key), the entire purse is loaded.</span>
<a name="l05885"></a>05885     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> theOldPurseAngel;
<a name="l05886"></a>05886     <a class="code" href="class_o_t_password.html">OTPassword</a> theOldPassword;      <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05887"></a>05887     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *           pOldNym   = NULL;
<a name="l05888"></a>05888     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pOldOwner = NULL;
<a name="l05889"></a>05889     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOldOwnerAngel;
<a name="l05890"></a>05890     <span class="comment">// ------------------------------</span>
<a name="l05891"></a>05891     <a class="code" href="class_o_t_purse.html">OTPurse</a> * pNewPurse = NULL;                <span class="comment">// if the new owner is a Purse (symmetric+master key), the entire purse is loaded.</span>
<a name="l05892"></a>05892     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPurse&gt;</a> theNewPurseAngel;
<a name="l05893"></a>05893     <a class="code" href="class_o_t_password.html">OTPassword</a> theNewPassword;      <span class="comment">// Only used in the case of password-protected purses.</span>
<a name="l05894"></a>05894     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> *           pNewNym   = NULL;
<a name="l05895"></a>05895     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pNewOwner = NULL;
<a name="l05896"></a>05896     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theNewOwnerAngel;
<a name="l05897"></a>05897     <span class="comment">// ------------------------------</span>
<a name="l05898"></a>05898     <span class="keyword">const</span> <span class="keywordtype">bool</span> bOldOwnerIsPurse = OLD_OWNER.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;PURSE&quot;</span>);
<a name="l05899"></a>05899     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNewOwnerIsPurse = NEW_OWNER.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;PURSE&quot;</span>);
<a name="l05900"></a>05900     <span class="comment">// ********************************************************************************</span>
<a name="l05901"></a>05901     <span class="keywordflow">if</span> (!bOldOwnerIsPurse) <span class="comment">// The old owner is a NYM (public/private keys.)</span>
<a name="l05902"></a>05902     {
<a name="l05903"></a>05903         oldOwnerNymID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(OLD_OWNER);
<a name="l05904"></a>05904         <span class="comment">// -----------------------------------------------------</span>
<a name="l05905"></a>05905                                 pOldNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(oldOwnerNymID, <span class="keyword">false</span>, szFunc, &amp;thePWDataWallet); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05906"></a>05906 <span class="comment">//      if (NULL == pOldNym)    pOldNym = this-&gt;GetOrLoadPublicNym(oldOwnerNymID, szFunc); // must be private, in order to decrypt the old token.</span>
<a name="l05907"></a>05907         <span class="keywordflow">if</span> (NULL == pOldNym)    <span class="keywordflow">return</span> NULL;
<a name="l05908"></a>05908         <span class="comment">// -----------------------------------------------------</span>
<a name="l05909"></a>05909         pOldOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pOldNym, &amp;strWalletReason);
<a name="l05910"></a>05910         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOldOwner);
<a name="l05911"></a>05911         theOldOwnerAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOldOwner);
<a name="l05912"></a>05912     }
<a name="l05913"></a>05913     <span class="comment">// -----------------------------------------------------</span>
<a name="l05914"></a>05914     <span class="keywordflow">else</span>                  <span class="comment">// The old owner is a PURSE (Symmetric/master keys, internal to that purse.)</span>
<a name="l05915"></a>05915     {
<a name="l05916"></a>05916         pOldPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID);
<a name="l05917"></a>05917         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOldPurse);
<a name="l05918"></a>05918         theOldPurseAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOldPurse);
<a name="l05919"></a>05919         <span class="comment">// -----------------------------------------------------</span>
<a name="l05920"></a>05920         pOldOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">LoadPurseAndOwnerForMerge</a>(OLD_OWNER, *pOldPurse, theOldPassword,
<a name="l05921"></a>05921                                                     <span class="keyword">false</span>, <span class="comment">//bCanBePublic=false by default. In this case, it definitely must be private.</span>
<a name="l05922"></a>05922                                                     &amp;SIGNER_NYM_ID, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise if it&#39;s Nym-protected, the purse will have a NymID on it already, which is what LoadPurseAndOwnerForMerge will try first. If not (it&#39;s optional), then SIGNER_NYM_ID is the ID it will try next, before failing altogether. ADDITIONAL NOTE: We don&#39;t expect the purse to ever be Nym-based since in this function, we pass a purse in order to pass the symmetric and master keys. Otherwise if this token&#39;s owner was already a Nym, then we would have passed a NymID in here, instead of a purse, in the first place.</span>
<a name="l05923"></a>05923                                                     &amp;strPurseReason);
<a name="l05924"></a>05924         theOldOwnerAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pOldOwner);
<a name="l05925"></a>05925         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05926"></a>05926         <span class="keywordflow">if</span> (NULL == pOldOwner) <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05927"></a>05927         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05928"></a>05928     }
<a name="l05929"></a>05929     <span class="comment">// ********************************************************************************</span>
<a name="l05930"></a>05930     <span class="keywordflow">if</span> (!bNewOwnerIsPurse) <span class="comment">// The new owner is a NYM</span>
<a name="l05931"></a>05931     {
<a name="l05932"></a>05932         newOwnerNymID.<a class="code" href="class_o_t_identifier.html#ae29aa1245d3831a207aabc9b8a493bfc">SetString</a>(NEW_OWNER);
<a name="l05933"></a>05933         <span class="comment">// -----------------------------------------------------</span>
<a name="l05934"></a>05934         pNewNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa09f3af30f4bc451d56c6948d536922f">GetOrLoadNym</a>(newOwnerNymID, <span class="keyword">false</span>, szFunc, &amp;thePWDataWallet); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l05935"></a>05935         <span class="keywordflow">if</span> (NULL == pNewNym)    <span class="keywordflow">return</span> NULL;
<a name="l05936"></a>05936         <span class="comment">// -----------------------------------------------------</span>
<a name="l05937"></a>05937         pNewOwner = <span class="keyword">new</span> <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a>(*pNewNym, &amp;strWalletReason);
<a name="l05938"></a>05938         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNewOwner);
<a name="l05939"></a>05939         theNewOwnerAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pNewOwner);
<a name="l05940"></a>05940     }
<a name="l05941"></a>05941     <span class="comment">// -----------------------------------------------------</span>
<a name="l05942"></a>05942     <span class="keywordflow">else</span>                   <span class="comment">// The new owner is a PURSE</span>
<a name="l05943"></a>05943     {
<a name="l05944"></a>05944         pNewPurse = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, ASSET_TYPE_ID);
<a name="l05945"></a>05945         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNewPurse);
<a name="l05946"></a>05946         theNewPurseAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pNewPurse);
<a name="l05947"></a>05947         <span class="comment">// -----------------------------------------------------</span>
<a name="l05948"></a>05948         pNewOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">LoadPurseAndOwnerForMerge</a>(NEW_OWNER, *pNewPurse, theNewPassword,
<a name="l05949"></a>05949                                                     <span class="keyword">true</span>, <span class="comment">//bCanBePublic=false by default, but set TRUE here, since you SHOULD be able to re-assign ownership of a token to someone else, without having to load their PRIVATE key (which you don&#39;t have.) Sort of irrelevant here actually, since this block is for purses only...</span>
<a name="l05950"></a>05950                                                     &amp;SIGNER_NYM_ID, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise if it&#39;s Nym-protected, the purse will have a NymID on it already, which is what LoadPurseAndOwnerForMerge will try first. If not (it&#39;s optional), then SIGNER_NYM_ID is the ID it will try next, before failing altogether. ADDITIONAL NOTE: We don&#39;t expect the purse to ever be Nym-based since in this function, we pass a purse in order to pass the symmetric and master keys. Otherwise if this token&#39;s owner was already a Nym, then we would have passed a NymID in here, instead of a purse, in the first place.</span>
<a name="l05951"></a>05951                                                     &amp;strPurseReason);
<a name="l05952"></a>05952         theNewOwnerAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pNewOwner);
<a name="l05953"></a>05953         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05954"></a>05954         <span class="keywordflow">if</span> (NULL == pNewOwner) <span class="keywordflow">return</span> NULL; <span class="comment">// This already logs, no need for more logs.</span>
<a name="l05955"></a>05955         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05956"></a>05956     }
<a name="l05957"></a>05957     <span class="comment">// ********************************************************************************</span>
<a name="l05958"></a>05958     <span class="comment">//</span>
<a name="l05959"></a>05959     <span class="comment">// (By this point, pOldOwner and pNewOwner should both be good to go.)</span>
<a name="l05960"></a>05960     <span class="comment">//</span>
<a name="l05961"></a>05961     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l05962"></a>05962     <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ac758de04ed60991098005a7ac9578d71">OTToken::TokenFactory</a>(THE_TOKEN, SERVER_ID, ASSET_TYPE_ID);
<a name="l05963"></a>05963     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l05964"></a>05964     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);
<a name="l05965"></a>05965     <span class="comment">// -----------------------------------------------------</span>
<a name="l05966"></a>05966     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(*pOldOwner,  <span class="comment">// must be private, if a Nym.</span>
<a name="l05967"></a>05967                                            *pNewOwner)) <span class="comment">// can be public, if a Nym.</span>
<a name="l05968"></a>05968     {
<a name="l05969"></a>05969         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error re-assigning ownership of token.\n&quot;</span>,
<a name="l05970"></a>05970                       szFunc);
<a name="l05971"></a>05971     }
<a name="l05972"></a>05972     <span class="keywordflow">else</span>
<a name="l05973"></a>05973     {
<a name="l05974"></a>05974         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: Success re-assigning ownership of token.\n&quot;</span>,
<a name="l05975"></a>05975                        szFunc);
<a name="l05976"></a>05976 
<a name="l05977"></a>05977         pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l05978"></a>05978         pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pSignerNym);
<a name="l05979"></a>05979         pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l05980"></a>05980 
<a name="l05981"></a>05981         theTokenAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// so pToken doesn&#39;t get deleted, since we&#39;re returning it here.</span>
<a name="l05982"></a>05982         <span class="keywordflow">return</span> pToken;
<a name="l05983"></a>05983     }
<a name="l05984"></a>05984 
<a name="l05985"></a>05985     <span class="keywordflow">return</span> NULL;
<a name="l05986"></a>05986 }
<a name="l05987"></a>05987 
<a name="l05988"></a>05988 
<a name="l05989"></a>05989 
<a name="l05990"></a>05990 
<a name="l05991"></a>05991 
<a name="l05992"></a>05992 <span class="comment">// -----------------------------------------------------</span>
<a name="l05993"></a>05993 
<a name="l05994"></a>05994 
<a name="l05995"></a>05995 <span class="comment">// LOAD Mint</span>
<a name="l05996"></a>05996 <span class="comment">//</span>
<a name="l05997"></a>05997 <span class="comment">// Returns an OTMint pointer, or NULL.</span>
<a name="l05998"></a>05998 <span class="comment">// (Caller responsible to delete.)</span>
<a name="l05999"></a>05999 <span class="comment">//</span>
<a name="l06000"></a><a class="code" href="class_o_t___a_p_i.html#a7ed4ec7967a76d735047e5bae1574bf5">06000</a> <a class="code" href="class_o_t_mint.html">OTMint</a> * <a class="code" href="class_o_t___a_p_i.html#a7ed4ec7967a76d735047e5bae1574bf5">OT_API::LoadMint</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06001"></a>06001                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l06002"></a>06002 {
<a name="l06003"></a>06003     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OT_API::LoadMint&quot;</span>;
<a name="l06004"></a>06004     <span class="comment">// -----------------------------------------------------</span>
<a name="l06005"></a>06005     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l06006"></a>06006     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_ID);
<a name="l06007"></a>06007     <span class="comment">// -------------------------------------------------------------</span>
<a name="l06008"></a>06008     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>    * pServerContract   = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFunc);
<a name="l06009"></a>06009     <span class="keywordflow">if</span> (NULL == pServerContract) <span class="keywordflow">return</span> NULL;
<a name="l06010"></a>06010     <span class="comment">// -------------------------------------------------------------</span>
<a name="l06011"></a>06011     <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>   * pServerNym        = pServerContract-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l06012"></a>06012     <span class="keywordflow">if</span> (NULL == pServerNym)
<a name="l06013"></a>06013     {
<a name="l06014"></a>06014         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to get contract public Nym for ServerID: %s \n&quot;</span>,
<a name="l06015"></a>06015                       szFunc, strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06016"></a>06016         <span class="keywordflow">return</span> NULL;
<a name="l06017"></a>06017     }
<a name="l06018"></a>06018     <span class="comment">// -------------------------------------------------------------</span>
<a name="l06019"></a>06019     <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strAssetTypeID);
<a name="l06020"></a>06020     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pMint, <span class="stringliteral">&quot;OT_API::LoadMint: Error allocating memory in the OT API&quot;</span>);
<a name="l06021"></a>06021     <span class="comment">// responsible to delete or return pMint below this point.</span>
<a name="l06022"></a>06022     <span class="comment">// -------------------------------------------------------------</span>
<a name="l06023"></a>06023     <span class="keywordflow">if</span> (!pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>() || !pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>(*pServerNym))
<a name="l06024"></a>06024     {
<a name="l06025"></a>06025         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to load or verify Mintfile : %s%s%s%s%s\n&quot;</span>, szFunc,
<a name="l06026"></a>06026                        <a class="code" href="class_o_t_folders.html#a821d8437b66e62cca2782da52777f299">OTFolders::Mint</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l06027"></a>06027                        <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06028"></a>06028         <span class="keyword">delete</span> pMint; pMint = NULL;
<a name="l06029"></a>06029         <span class="keywordflow">return</span> NULL;
<a name="l06030"></a>06030     }
<a name="l06031"></a>06031     <span class="comment">// -------------------------------------------------------------</span>
<a name="l06032"></a>06032     <span class="keywordflow">return</span> pMint;
<a name="l06033"></a>06033 }
<a name="l06034"></a>06034 
<a name="l06035"></a>06035 
<a name="l06036"></a>06036 
<a name="l06037"></a>06037 <span class="comment">// LOAD SERVER CONTRACT (from local storage)</span>
<a name="l06038"></a>06038 <span class="comment">//</span>
<a name="l06039"></a>06039 <span class="comment">// Caller is responsible to delete.</span>
<a name="l06040"></a>06040 <span class="comment">//</span>
<a name="l06041"></a><a class="code" href="class_o_t___a_p_i.html#adeed94c645c2e2330e536520b9fa5664">06041</a> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * <a class="code" href="class_o_t___a_p_i.html#adeed94c645c2e2330e536520b9fa5664">OT_API::LoadServerContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID)
<a name="l06042"></a>06042 {
<a name="l06043"></a>06043     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l06044"></a>06044     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l06045"></a>06045     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l06046"></a>06046 
<a name="l06047"></a>06047     <a class="code" href="class_o_t_string.html">OTString</a> strFoldername  = <a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l06048"></a>06048     <a class="code" href="class_o_t_string.html">OTString</a> strFilename    = strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l06049"></a>06049     <span class="comment">// ------------------------------------------------------------------</span>
<a name="l06050"></a>06050     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFoldername.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l06051"></a>06051     {
<a name="l06052"></a>06052         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::LoadServerContract: File does not exist: %s%s%s\n&quot;</span>,
<a name="l06053"></a>06053                       strFoldername.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06054"></a>06054         <span class="keywordflow">return</span> NULL;
<a name="l06055"></a>06055     }
<a name="l06056"></a>06056     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l06057"></a>06057     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>(strServerID, strFoldername,
<a name="l06058"></a>06058                                                         strFilename, strServerID);
<a name="l06059"></a>06059     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;Error allocating memory for Server &quot;</span>
<a name="l06060"></a>06060                   <span class="stringliteral">&quot;Contract in OT_API::LoadServerContract\n&quot;</span>);
<a name="l06061"></a>06061 
<a name="l06062"></a>06062     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>() &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
<a name="l06063"></a>06063         <span class="keywordflow">return</span> pContract;
<a name="l06064"></a>06064     <span class="keywordflow">else</span>
<a name="l06065"></a>06065         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::LoadServerContract: Unable to load or verify server contract. (Maybe it&#39;s just not there, and needs to &quot;</span>
<a name="l06066"></a>06066                        <span class="stringliteral">&quot;be downloaded.) Server ID: %s\n&quot;</span>, strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06067"></a>06067     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l06068"></a>06068     <span class="keyword">delete</span> pContract;
<a name="l06069"></a>06069     pContract = NULL;
<a name="l06070"></a>06070 
<a name="l06071"></a>06071     <span class="keywordflow">return</span> NULL;
<a name="l06072"></a>06072 }
<a name="l06073"></a>06073 
<a name="l06074"></a>06074 
<a name="l06075"></a>06075 <span class="comment">// LOAD ASSET CONTRACT (from local storage)</span>
<a name="l06076"></a>06076 <span class="comment">//</span>
<a name="l06077"></a>06077 <span class="comment">// Caller is responsible to delete.</span>
<a name="l06078"></a>06078 <span class="comment">//</span>
<a name="l06079"></a><a class="code" href="class_o_t___a_p_i.html#a9e0c39f51b0c700bfeb378d7ab868724">06079</a> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * <a class="code" href="class_o_t___a_p_i.html#a9e0c39f51b0c700bfeb378d7ab868724">OT_API::LoadAssetContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l06080"></a>06080 {
<a name="l06081"></a>06081     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l06082"></a>06082     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l06083"></a>06083     <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_ID);
<a name="l06084"></a>06084 
<a name="l06085"></a>06085     <a class="code" href="class_o_t_string.html">OTString</a> strFoldername  = <a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l06086"></a>06086     <a class="code" href="class_o_t_string.html">OTString</a> strFilename    = strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l06087"></a>06087     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l06088"></a>06088     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(strFoldername.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l06089"></a>06089     {
<a name="l06090"></a>06090         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::LoadAssetContract: File does not exist: %s%s%s\n&quot;</span>,
<a name="l06091"></a>06091                       strFoldername.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strFilename.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06092"></a>06092         <span class="keywordflow">return</span> NULL;
<a name="l06093"></a>06093     }
<a name="l06094"></a>06094     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l06095"></a>06095     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(strAssetTypeID, strFoldername,
<a name="l06096"></a>06096                                                       strFilename, strAssetTypeID);
<a name="l06097"></a>06097     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pContract, <span class="stringliteral">&quot;Error allocating memory for Asset &quot;</span>
<a name="l06098"></a>06098                   <span class="stringliteral">&quot;Contract in OT_API::LoadAssetContract\n&quot;</span>);
<a name="l06099"></a>06099 
<a name="l06100"></a>06100     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_contract.html#a1432a5e924d021a9dc39320d3b8e7b90">LoadContract</a>() &amp;&amp; pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
<a name="l06101"></a>06101         <span class="keywordflow">return</span> pContract;
<a name="l06102"></a>06102     <span class="keywordflow">else</span>
<a name="l06103"></a>06103         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::LoadAssetContract: Unable to load or verify asset contract (Maybe it&#39;s just not there, and needs to &quot;</span>
<a name="l06104"></a>06104                        <span class="stringliteral">&quot;be downloaded.) Asset ID: %s\n&quot;</span>, strAssetTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06105"></a>06105     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l06106"></a>06106     <span class="keyword">delete</span> pContract;
<a name="l06107"></a>06107     pContract = NULL;
<a name="l06108"></a>06108 
<a name="l06109"></a>06109     <span class="keywordflow">return</span> NULL;
<a name="l06110"></a>06110 }
<a name="l06111"></a>06111 
<a name="l06112"></a>06112 
<a name="l06113"></a>06113 
<a name="l06114"></a>06114 <span class="comment">// LOAD ASSET ACCOUNT</span>
<a name="l06115"></a>06115 <span class="comment">//</span>
<a name="l06116"></a>06116 <span class="comment">// Caller is NOT responsible to delete -- I add it to the wallet!</span>
<a name="l06117"></a>06117 <span class="comment">//</span>
<a name="l06118"></a>06118 <span class="comment">// We don&#39;t care if this asset account is already loaded in the wallet.</span>
<a name="l06119"></a>06119 <span class="comment">// Presumably, the user has just downloaded the latest copy of the account</span>
<a name="l06120"></a>06120 <span class="comment">// from the server, and the one in the wallet is old, so now this function</span>
<a name="l06121"></a>06121 <span class="comment">// is being called to load the new one from storage and update the wallet.</span>
<a name="l06122"></a>06122 <span class="comment">//</span>
<a name="l06123"></a>06123 <span class="comment">// See also: OT_API::GetOrLoadAccount()</span>
<a name="l06124"></a>06124 <span class="comment">//</span>
<a name="l06125"></a><a class="code" href="class_o_t___a_p_i.html#ad8538f636eb127ddcb4ca4a72ec7cc88">06125</a> <a class="code" href="class_o_t_account.html">OTAccount</a> * <a class="code" href="class_o_t___a_p_i.html#ad8538f636eb127ddcb4ca4a72ec7cc88">OT_API::LoadAssetAccount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06126"></a>06126                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06127"></a>06127                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06128"></a>06128 {
<a name="l06129"></a>06129     <span class="comment">// -----------------------------------------------------</span>
<a name="l06130"></a>06130     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(__FUNCTION__); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l06131"></a>06131     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> NULL;
<a name="l06132"></a>06132     <span class="comment">// By this point, pWallet is a good pointer.  (No need to cleanup.)</span>
<a name="l06133"></a>06133     <span class="comment">// -----------------------------------------------------</span>
<a name="l06134"></a>06134     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06135"></a>06135     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06136"></a>06136     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06137"></a>06137     <span class="comment">// -----------------------------------------------------</span>
<a name="l06138"></a>06138     <span class="keywordflow">return</span> pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ab7a6c57d91a0c93be57afe78c56e86a7">LoadAccount</a>(*pNym, ACCOUNT_ID, SERVER_ID, __FUNCTION__);
<a name="l06139"></a>06139 }
<a name="l06140"></a>06140 
<a name="l06141"></a>06141 
<a name="l06142"></a>06142 <span class="comment">// ---------------------------------------------------</span>
<a name="l06143"></a>06143 
<a name="l06144"></a>06144 <span class="comment">// LOAD NYMBOX</span>
<a name="l06145"></a>06145 <span class="comment">//</span>
<a name="l06146"></a>06146 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06147"></a>06147 <span class="comment">//</span>
<a name="l06148"></a><a class="code" href="class_o_t___a_p_i.html#a407abef5bd443ce7f68e399f76252fd3">06148</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a407abef5bd443ce7f68e399f76252fd3">OT_API::LoadNymbox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06149"></a>06149                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06150"></a>06150 {
<a name="l06151"></a>06151     <span class="comment">// -----------------------------------------------------</span>
<a name="l06152"></a>06152     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06153"></a>06153     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06154"></a>06154     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06155"></a>06155     <span class="comment">// -----------------------------------------------------</span>
<a name="l06156"></a>06156     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>);
<a name="l06157"></a>06157     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadNymbox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06158"></a>06158     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06159"></a>06159     <span class="comment">// ------------------------------------------------------</span>
<a name="l06160"></a>06160     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
<a name="l06161"></a>06161         <span class="keywordflow">return</span> pLedger;
<a name="l06162"></a>06162     <span class="keywordflow">else</span>
<a name="l06163"></a>06163     {
<a name="l06164"></a>06164         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l06165"></a>06165         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::LoadNymbox: Unable to load or verify nymbox: %s\n&quot;</span>,
<a name="l06166"></a>06166                        strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06167"></a>06167         <span class="keyword">delete</span> pLedger;
<a name="l06168"></a>06168         pLedger = NULL;
<a name="l06169"></a>06169     }
<a name="l06170"></a>06170     <span class="keywordflow">return</span>  NULL;
<a name="l06171"></a>06171 }
<a name="l06172"></a>06172 
<a name="l06173"></a>06173 <span class="comment">// LOAD NYMBOX NO VERIFY</span>
<a name="l06174"></a>06174 <span class="comment">// (VerifyAccount, for ledgers, loads all the Box Receipts. You may not want this.</span>
<a name="l06175"></a>06175 <span class="comment">// For example, you may be loading this ledger precisely so you can iterate through</span>
<a name="l06176"></a>06176 <span class="comment">// its receipts and download them from the server, so they will all load up on a</span>
<a name="l06177"></a>06177 <span class="comment">// subsequent verify.)</span>
<a name="l06178"></a>06178 <span class="comment">//</span>
<a name="l06179"></a>06179 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06180"></a>06180 <span class="comment">//</span>
<a name="l06181"></a><a class="code" href="class_o_t___a_p_i.html#a5d73d9af141c79478e431d81b3ac641d">06181</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a5d73d9af141c79478e431d81b3ac641d">OT_API::LoadNymboxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06182"></a>06182                                       <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06183"></a>06183 {
<a name="l06184"></a>06184     <span class="comment">// -----------------------------------------------------</span>
<a name="l06185"></a>06185     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06186"></a>06186     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06187"></a>06187     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06188"></a>06188     <span class="comment">// -----------------------------------------------------</span>
<a name="l06189"></a>06189     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a>);
<a name="l06190"></a>06190     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadNymboxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06191"></a>06191     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06192"></a>06192     <span class="comment">// ------------------------------------------------------</span>
<a name="l06193"></a>06193     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>()) <span class="comment">// The Verify would go here.</span>
<a name="l06194"></a>06194         <span class="keywordflow">return</span> pLedger;
<a name="l06195"></a>06195     <span class="keywordflow">else</span>
<a name="l06196"></a>06196     {
<a name="l06197"></a>06197         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l06198"></a>06198         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::LoadNymboxNoVerify: Unable to load nymbox: %s\n&quot;</span>,
<a name="l06199"></a>06199                        strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06200"></a>06200         <span class="keyword">delete</span> pLedger;
<a name="l06201"></a>06201         pLedger = NULL;
<a name="l06202"></a>06202     }
<a name="l06203"></a>06203     <span class="keywordflow">return</span>  NULL;
<a name="l06204"></a>06204 }
<a name="l06205"></a>06205 
<a name="l06206"></a>06206 
<a name="l06207"></a>06207 
<a name="l06208"></a>06208 <span class="comment">// LOAD INBOX</span>
<a name="l06209"></a>06209 <span class="comment">//</span>
<a name="l06210"></a>06210 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06211"></a>06211 <span class="comment">//</span>
<a name="l06212"></a><a class="code" href="class_o_t___a_p_i.html#a478f3f32e383e05a203807810bc94940">06212</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a478f3f32e383e05a203807810bc94940">OT_API::LoadInbox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06213"></a>06213                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06214"></a>06214                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06215"></a>06215 {
<a name="l06216"></a>06216     <span class="comment">// -----------------------------------------------------</span>
<a name="l06217"></a>06217     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06218"></a>06218     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06219"></a>06219     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06220"></a>06220     <span class="comment">// -----------------------------------------------------</span>
<a name="l06221"></a>06221     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>);
<a name="l06222"></a>06222     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadInbox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06223"></a>06223 
<a name="l06224"></a>06224     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06225"></a>06225     <span class="comment">// ------------------------------------------------------</span>
<a name="l06226"></a>06226     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
<a name="l06227"></a>06227         <span class="keywordflow">return</span> pLedger;
<a name="l06228"></a>06228     <span class="keywordflow">else</span>
<a name="l06229"></a>06229     {
<a name="l06230"></a>06230         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06231"></a>06231         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::LoadInbox: Unable to load or verify inbox: %s\n For user: %s\n&quot;</span>,
<a name="l06232"></a>06232                        strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.Get());
<a name="l06233"></a>06233         <span class="keyword">delete</span> pLedger;
<a name="l06234"></a>06234         pLedger = NULL;
<a name="l06235"></a>06235     }
<a name="l06236"></a>06236     <span class="keywordflow">return</span>  NULL;
<a name="l06237"></a>06237 }
<a name="l06238"></a>06238 
<a name="l06239"></a>06239 
<a name="l06240"></a>06240 <span class="comment">// LOAD INBOX NO VERIFY</span>
<a name="l06241"></a>06241 <span class="comment">//</span>
<a name="l06242"></a>06242 <span class="comment">// (VerifyAccount, for ledgers, loads all the Box Receipts. You may not want this.</span>
<a name="l06243"></a>06243 <span class="comment">// For example, you may be loading this ledger precisely so you can iterate through</span>
<a name="l06244"></a>06244 <span class="comment">// its receipts and download them from the server, so they will all load up on a</span>
<a name="l06245"></a>06245 <span class="comment">// subsequent verify.)</span>
<a name="l06246"></a>06246 <span class="comment">//</span>
<a name="l06247"></a>06247 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06248"></a>06248 <span class="comment">//</span>
<a name="l06249"></a><a class="code" href="class_o_t___a_p_i.html#a11a9479b4875de4377232237d3521690">06249</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a11a9479b4875de4377232237d3521690">OT_API::LoadInboxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06250"></a>06250                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06251"></a>06251                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06252"></a>06252 {
<a name="l06253"></a>06253     <span class="comment">// -----------------------------------------------------</span>
<a name="l06254"></a>06254     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06255"></a>06255     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06256"></a>06256     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06257"></a>06257     <span class="comment">// -----------------------------------------------------</span>
<a name="l06258"></a>06258     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa7bd594902e6c775ef4f356897fb36006">OTLedger::inbox</a>);
<a name="l06259"></a>06259     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadInboxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06260"></a>06260 
<a name="l06261"></a>06261     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06262"></a>06262     <span class="comment">// ------------------------------------------------------</span>
<a name="l06263"></a>06263     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>()) <span class="comment">// The Verify would go here.</span>
<a name="l06264"></a>06264         <span class="keywordflow">return</span> pLedger;
<a name="l06265"></a>06265     <span class="keywordflow">else</span>
<a name="l06266"></a>06266     {
<a name="l06267"></a>06267         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06268"></a>06268         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::LoadInboxNoVerify: Unable to load inbox: %s\n For user: %s\n&quot;</span>,
<a name="l06269"></a>06269                        strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.Get());
<a name="l06270"></a>06270         <span class="keyword">delete</span> pLedger;
<a name="l06271"></a>06271         pLedger = NULL;
<a name="l06272"></a>06272     }
<a name="l06273"></a>06273     <span class="keywordflow">return</span>  NULL;
<a name="l06274"></a>06274 }
<a name="l06275"></a>06275 
<a name="l06276"></a>06276 
<a name="l06277"></a>06277 <span class="comment">// LOAD OUTBOX</span>
<a name="l06278"></a>06278 <span class="comment">//</span>
<a name="l06279"></a>06279 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06280"></a>06280 <span class="comment">//</span>
<a name="l06281"></a><a class="code" href="class_o_t___a_p_i.html#aeaf758c15cb39763d3ac80e7582e5409">06281</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#aeaf758c15cb39763d3ac80e7582e5409">OT_API::LoadOutbox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06282"></a>06282                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06283"></a>06283                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06284"></a>06284 {
<a name="l06285"></a>06285     <span class="comment">// -----------------------------------------------------</span>
<a name="l06286"></a>06286     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06287"></a>06287     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06288"></a>06288     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06289"></a>06289     <span class="comment">// -----------------------------------------------------</span>
<a name="l06290"></a>06290     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>);
<a name="l06291"></a>06291     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadOutbox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06292"></a>06292 
<a name="l06293"></a>06293     <span class="comment">// Beyond this point, I know that pLedger is loaded and will need to be deleted or returned.</span>
<a name="l06294"></a>06294     <span class="comment">// ------------------------------------------------------</span>
<a name="l06295"></a>06295 
<a name="l06296"></a>06296     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
<a name="l06297"></a>06297         <span class="keywordflow">return</span> pLedger;
<a name="l06298"></a>06298     <span class="keywordflow">else</span>
<a name="l06299"></a>06299     {
<a name="l06300"></a>06300         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06301"></a>06301 
<a name="l06302"></a>06302         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::LoadOutbox: Unable to load or verify outbox: %s\n For user: %s\n&quot;</span>,
<a name="l06303"></a>06303                        strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.Get());
<a name="l06304"></a>06304 
<a name="l06305"></a>06305         <span class="keyword">delete</span> pLedger;
<a name="l06306"></a>06306         pLedger = NULL;
<a name="l06307"></a>06307     }
<a name="l06308"></a>06308     <span class="keywordflow">return</span>  NULL;
<a name="l06309"></a>06309 }
<a name="l06310"></a>06310 
<a name="l06311"></a>06311 
<a name="l06312"></a>06312 
<a name="l06313"></a>06313 <span class="comment">// LOAD OUTBOX NO VERIFY</span>
<a name="l06314"></a>06314 <span class="comment">//</span>
<a name="l06315"></a>06315 <span class="comment">// (VerifyAccount, for ledgers, loads all the Box Receipts. You may not want this.</span>
<a name="l06316"></a>06316 <span class="comment">// For example, you may be loading this ledger precisely so you can iterate through</span>
<a name="l06317"></a>06317 <span class="comment">// its receipts and download them from the server, so they will all load up on a</span>
<a name="l06318"></a>06318 <span class="comment">// subsequent verify.)</span>
<a name="l06319"></a>06319 <span class="comment">//</span>
<a name="l06320"></a>06320 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06321"></a>06321 <span class="comment">//</span>
<a name="l06322"></a><a class="code" href="class_o_t___a_p_i.html#af4b4a5ef255263fbda9958082d393875">06322</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#af4b4a5ef255263fbda9958082d393875">OT_API::LoadOutboxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06323"></a>06323                                       <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06324"></a>06324                                       <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06325"></a>06325 {
<a name="l06326"></a>06326     <span class="comment">// -----------------------------------------------------</span>
<a name="l06327"></a>06327     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06328"></a>06328     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06329"></a>06329     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06330"></a>06330     <span class="comment">// -----------------------------------------------------</span>
<a name="l06331"></a>06331     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaa0150c89048bba5eedf6a0919603d4e4">OTLedger::outbox</a>);
<a name="l06332"></a>06332     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadOutboxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06333"></a>06333 
<a name="l06334"></a>06334     <span class="comment">// Beyond this point, I know that pLedger is loaded and will need to be deleted or returned.</span>
<a name="l06335"></a>06335     <span class="comment">// ------------------------------------------------------</span>
<a name="l06336"></a>06336 
<a name="l06337"></a>06337     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>()) <span class="comment">// The Verify would go here.</span>
<a name="l06338"></a>06338         <span class="keywordflow">return</span> pLedger;
<a name="l06339"></a>06339     <span class="keywordflow">else</span>
<a name="l06340"></a>06340     {
<a name="l06341"></a>06341         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06342"></a>06342         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::LoadOutboxNoVerify: Unable to load outbox: %s\n For user: %s\n&quot;</span>,
<a name="l06343"></a>06343                        strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strUserID.Get());
<a name="l06344"></a>06344 
<a name="l06345"></a>06345         <span class="keyword">delete</span> pLedger;
<a name="l06346"></a>06346         pLedger = NULL;
<a name="l06347"></a>06347     }
<a name="l06348"></a>06348     <span class="keywordflow">return</span>  NULL;
<a name="l06349"></a>06349 }
<a name="l06350"></a>06350 
<a name="l06351"></a>06351 
<a name="l06352"></a>06352 
<a name="l06353"></a>06353 <span class="comment">// ***************************************************************************</span>
<a name="l06354"></a>06354 
<a name="l06355"></a>06355 
<a name="l06356"></a>06356 
<a name="l06357"></a><a class="code" href="class_o_t___a_p_i.html#a5077987cf25f441923c88cb51b3d940a">06357</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a5077987cf25f441923c88cb51b3d940a">OT_API::LoadPaymentInbox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06358"></a>06358                                     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06359"></a>06359 {
<a name="l06360"></a>06360     <span class="comment">// -----------------------------------------------------</span>
<a name="l06361"></a>06361     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06362"></a>06362     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06363"></a>06363     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06364"></a>06364     <span class="comment">// -----------------------------------------------------</span>
<a name="l06365"></a>06365     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
<a name="l06366"></a>06366     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadPaymentInbox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06367"></a>06367     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06368"></a>06368     <span class="comment">// ------------------------------------------------------</span>
<a name="l06369"></a>06369     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a2089e14094b2047e668bc50e2d5d3eb2">LoadPaymentInbox</a>() &amp;&amp; pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym))
<a name="l06370"></a>06370         <span class="keywordflow">return</span> pLedger;
<a name="l06371"></a>06371     <span class="keywordflow">else</span>
<a name="l06372"></a>06372     {
<a name="l06373"></a>06373         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
<a name="l06374"></a>06374         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s / %s\n&quot;</span>,
<a name="l06375"></a>06375                        __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06376"></a>06376         <span class="keyword">delete</span> pLedger;
<a name="l06377"></a>06377         pLedger = NULL;
<a name="l06378"></a>06378     }
<a name="l06379"></a>06379     <span class="keywordflow">return</span>  NULL;
<a name="l06380"></a>06380 }
<a name="l06381"></a>06381 
<a name="l06382"></a>06382 <span class="comment">// -----------------------------------------------------</span>
<a name="l06383"></a>06383 
<a name="l06384"></a><a class="code" href="class_o_t___a_p_i.html#a8e02cb186854f0b325c4c55da69f2e55">06384</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a8e02cb186854f0b325c4c55da69f2e55">OT_API::LoadPaymentInboxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06385"></a>06385                                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06386"></a>06386 {
<a name="l06387"></a>06387     <span class="comment">// -----------------------------------------------------</span>
<a name="l06388"></a>06388     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06389"></a>06389     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06390"></a>06390     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06391"></a>06391     <span class="comment">// -----------------------------------------------------</span>
<a name="l06392"></a>06392     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aaf8b0cad55e051e014a4f9ebee8dd2984">OTLedger::paymentInbox</a>);
<a name="l06393"></a>06393     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadPaymentInboxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06394"></a>06394     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06395"></a>06395     <span class="comment">// ------------------------------------------------------</span>
<a name="l06396"></a>06396     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a2089e14094b2047e668bc50e2d5d3eb2">LoadPaymentInbox</a>()) <span class="comment">// The Verify would have gone here.</span>
<a name="l06397"></a>06397         <span class="keywordflow">return</span> pLedger;
<a name="l06398"></a>06398     <span class="keywordflow">else</span>
<a name="l06399"></a>06399     {
<a name="l06400"></a>06400         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(USER_ID);
<a name="l06401"></a>06401         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s / %s\n&quot;</span>,
<a name="l06402"></a>06402                        __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06403"></a>06403         <span class="keyword">delete</span> pLedger;
<a name="l06404"></a>06404         pLedger = NULL;
<a name="l06405"></a>06405     }
<a name="l06406"></a>06406     <span class="keywordflow">return</span>  NULL;
<a name="l06407"></a>06407 }
<a name="l06408"></a>06408 
<a name="l06409"></a>06409 <span class="comment">// -----------------------------------------------------</span>
<a name="l06410"></a>06410 
<a name="l06411"></a>06411 <span class="comment">// Caller IS responsible to delete</span>
<a name="l06412"></a>06412 <span class="comment">//</span>
<a name="l06413"></a><a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">06413</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">OT_API::LoadRecordBox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06414"></a>06414                                  <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06415"></a>06415                                  <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06416"></a>06416 {
<a name="l06417"></a>06417     <span class="comment">// -----------------------------------------------------</span>
<a name="l06418"></a>06418     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06419"></a>06419     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06420"></a>06420 
<a name="l06421"></a>06421     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06422"></a>06422     <span class="comment">// -----------------------------------------------------</span>
<a name="l06423"></a>06423     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>);
<a name="l06424"></a>06424     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadRecordBox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06425"></a>06425     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06426"></a>06426     <span class="comment">// ------------------------------------------------------</span>
<a name="l06427"></a>06427     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#ad283d675ba07160bddde117386b872a6">LoadRecordBox</a>();
<a name="l06428"></a>06428 
<a name="l06429"></a>06429     <span class="keywordtype">bool</span> bVerified = <span class="keyword">false</span>;
<a name="l06430"></a>06430 
<a name="l06431"></a>06431     <span class="keywordflow">if</span> (bLoaded)
<a name="l06432"></a>06432         bVerified = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym);
<a name="l06433"></a>06433 
<a name="l06434"></a>06434     <span class="keywordflow">if</span> (bLoaded &amp;&amp; bVerified)
<a name="l06435"></a>06435         <span class="keywordflow">return</span> pLedger;
<a name="l06436"></a>06436     <span class="keywordflow">else</span>
<a name="l06437"></a>06437     {
<a name="l06438"></a>06438         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06439"></a>06439         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s / %s\n&quot;</span>,
<a name="l06440"></a>06440                        __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06441"></a>06441         <span class="keyword">delete</span> pLedger;
<a name="l06442"></a>06442         pLedger = NULL;
<a name="l06443"></a>06443     }
<a name="l06444"></a>06444     <span class="keywordflow">return</span>  NULL;
<a name="l06445"></a>06445 }
<a name="l06446"></a>06446 
<a name="l06447"></a>06447 <span class="comment">// -----------------------------------------------------</span>
<a name="l06448"></a>06448 
<a name="l06449"></a><a class="code" href="class_o_t___a_p_i.html#a8c288f48dcdc98a6ae02c03e6452c438">06449</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a8c288f48dcdc98a6ae02c03e6452c438">OT_API::LoadRecordBoxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06450"></a>06450                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06451"></a>06451                                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l06452"></a>06452 {
<a name="l06453"></a>06453     <span class="comment">// -----------------------------------------------------</span>
<a name="l06454"></a>06454     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06455"></a>06455     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06456"></a>06456     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06457"></a>06457     <span class="comment">// -----------------------------------------------------</span>
<a name="l06458"></a>06458     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>);
<a name="l06459"></a>06459     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadRecordBoxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06460"></a>06460     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06461"></a>06461     <span class="comment">// ------------------------------------------------------</span>
<a name="l06462"></a>06462     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#ad283d675ba07160bddde117386b872a6">LoadRecordBox</a>()) <span class="comment">// The Verify would have gone here.</span>
<a name="l06463"></a>06463         <span class="keywordflow">return</span> pLedger;
<a name="l06464"></a>06464     <span class="keywordflow">else</span>
<a name="l06465"></a>06465     {
<a name="l06466"></a>06466         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l06467"></a>06467         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s / %s\n&quot;</span>,
<a name="l06468"></a>06468                        __FUNCTION__, strUserID.Get(), strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06469"></a>06469         <span class="keyword">delete</span> pLedger;
<a name="l06470"></a>06470         pLedger = NULL;
<a name="l06471"></a>06471     }
<a name="l06472"></a>06472     <span class="keywordflow">return</span>  NULL;
<a name="l06473"></a>06473 }
<a name="l06474"></a>06474 
<a name="l06475"></a>06475 <span class="comment">// -----------------------------------------------------</span>
<a name="l06476"></a>06476 
<a name="l06477"></a>06477 <span class="comment">// Caller IS responsible to delete.</span>
<a name="l06478"></a>06478 
<a name="l06479"></a><a class="code" href="class_o_t___a_p_i.html#ae3d6ecd9fabfea445d35fd7307008856">06479</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#ae3d6ecd9fabfea445d35fd7307008856">OT_API::LoadExpiredBox</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06480"></a>06480                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06481"></a>06481 {
<a name="l06482"></a>06482     <span class="comment">// -----------------------------------------------------</span>
<a name="l06483"></a>06483     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06484"></a>06484     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06485"></a>06485 
<a name="l06486"></a>06486     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06487"></a>06487     <span class="comment">// -----------------------------------------------------</span>
<a name="l06488"></a>06488     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>);
<a name="l06489"></a>06489     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadExpiredBox: Error allocating memory in the OT API.&quot;</span>);
<a name="l06490"></a>06490     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06491"></a>06491     <span class="comment">// ------------------------------------------------------</span>
<a name="l06492"></a>06492     <span class="keyword">const</span> <span class="keywordtype">bool</span> bLoaded = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a752b0776eed42abe1a48754d288bd79e">LoadExpiredBox</a>();
<a name="l06493"></a>06493 
<a name="l06494"></a>06494     <span class="keywordtype">bool</span> bVerified = <span class="keyword">false</span>;
<a name="l06495"></a>06495 
<a name="l06496"></a>06496     <span class="keywordflow">if</span> (bLoaded)
<a name="l06497"></a>06497         bVerified = pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym);
<a name="l06498"></a>06498 
<a name="l06499"></a>06499     <span class="keywordflow">if</span> (bLoaded &amp;&amp; bVerified)
<a name="l06500"></a>06500         <span class="keywordflow">return</span> pLedger;
<a name="l06501"></a>06501     <span class="keywordflow">else</span>
<a name="l06502"></a>06502     {
<a name="l06503"></a>06503         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l06504"></a>06504         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s\n&quot;</span>,
<a name="l06505"></a>06505                        __FUNCTION__, strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06506"></a>06506         <span class="keyword">delete</span> pLedger;
<a name="l06507"></a>06507         pLedger = NULL;
<a name="l06508"></a>06508     }
<a name="l06509"></a>06509     <span class="keywordflow">return</span>  NULL;
<a name="l06510"></a>06510 }
<a name="l06511"></a>06511 
<a name="l06512"></a>06512 
<a name="l06513"></a>06513 <span class="comment">// -----------------------------------------------------</span>
<a name="l06514"></a>06514 
<a name="l06515"></a>06515 
<a name="l06516"></a><a class="code" href="class_o_t___a_p_i.html#a7b9a649113879b83befa1d7acc00b79d">06516</a> <a class="code" href="class_o_t_ledger.html">OTLedger</a> * <a class="code" href="class_o_t___a_p_i.html#a7b9a649113879b83befa1d7acc00b79d">OT_API::LoadExpiredBoxNoVerify</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06517"></a>06517                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l06518"></a>06518 {
<a name="l06519"></a>06519     <span class="comment">// -----------------------------------------------------</span>
<a name="l06520"></a>06520     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06521"></a>06521     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l06522"></a>06522     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06523"></a>06523     <span class="comment">// -----------------------------------------------------</span>
<a name="l06524"></a>06524     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pLedger = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>);
<a name="l06525"></a>06525     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pLedger, <span class="stringliteral">&quot;OT_API::LoadExpiredBoxNoVerify: Error allocating memory in the OT API.&quot;</span>);
<a name="l06526"></a>06526     <span class="comment">// Beyond this point, I know that pLedger will need to be deleted or returned.</span>
<a name="l06527"></a>06527     <span class="comment">// ------------------------------------------------------</span>
<a name="l06528"></a>06528     <span class="keywordflow">if</span> (pLedger-&gt;<a class="code" href="class_o_t_ledger.html#a752b0776eed42abe1a48754d288bd79e">LoadExpiredBox</a>()) <span class="comment">// The Verify would have gone here.</span>
<a name="l06529"></a>06529         <span class="keywordflow">return</span> pLedger;
<a name="l06530"></a>06530     <span class="keywordflow">else</span>
<a name="l06531"></a>06531     {
<a name="l06532"></a>06532         <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l06533"></a>06533         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Unable to load or verify: %s\n&quot;</span>,
<a name="l06534"></a>06534                        __FUNCTION__, strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l06535"></a>06535         <span class="keyword">delete</span> pLedger;
<a name="l06536"></a>06536         pLedger = NULL;
<a name="l06537"></a>06537     }
<a name="l06538"></a>06538     <span class="keywordflow">return</span>  NULL;
<a name="l06539"></a>06539 }
<a name="l06540"></a>06540 
<a name="l06541"></a>06541 <span class="comment">// -----------------------------------------------------</span>
<a name="l06542"></a>06542 
<a name="l06543"></a>06543 
<a name="l06544"></a><a class="code" href="class_o_t___a_p_i.html#a742952a02e0d947156e8687933602725">06544</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a742952a02e0d947156e8687933602725">OT_API::ClearExpired</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06545"></a>06545                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06546"></a>06546                           <span class="keyword">const</span> int32_t        nIndex,
<a name="l06547"></a>06547                           <span class="keyword">const</span> <span class="keywordtype">bool</span>           bClearAll<span class="comment">/*=false*/</span>) <span class="comment">// if true, nIndex is ignored.</span>
<a name="l06548"></a>06548 {
<a name="l06549"></a>06549     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06550"></a>06550     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06551"></a>06551     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06552"></a>06552     <span class="comment">// -----------------------------------------------------</span>
<a name="l06553"></a>06553     <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pExpiredBox = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ae3d6ecd9fabfea445d35fd7307008856">LoadExpiredBox</a>(SERVER_ID, USER_ID);
<a name="l06554"></a>06554     <span class="comment">// -----------------------------------------------------</span>
<a name="l06555"></a>06555     <span class="keywordflow">if</span> (NULL == pExpiredBox)
<a name="l06556"></a>06556     {
<a name="l06557"></a>06557         pExpiredBox = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>, <span class="keyword">true</span>);
<a name="l06558"></a>06558 
<a name="l06559"></a>06559         <span class="keywordflow">if</span> (NULL == pExpiredBox)
<a name="l06560"></a>06560         {
<a name="l06561"></a>06561             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load or create expired box (and thus unable to do anything with it.)\n&quot;</span>,
<a name="l06562"></a>06562                           __FUNCTION__);
<a name="l06563"></a>06563             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06564"></a>06564         }
<a name="l06565"></a>06565     }
<a name="l06566"></a>06566     <span class="comment">// -----------------------------------------------------</span>
<a name="l06567"></a>06567     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theExpiredBoxAngel (pExpiredBox);
<a name="l06568"></a>06568     <span class="comment">// -----------------------------------------------------</span>
<a name="l06569"></a>06569     <span class="keywordflow">if</span> (bClearAll)
<a name="l06570"></a>06570     {
<a name="l06571"></a>06571         pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>();
<a name="l06572"></a>06572         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l06573"></a>06573         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l06574"></a>06574         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06575"></a>06575         pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#ace1cb1337e94d794243bbe163eb88813">SaveExpiredBox</a>();
<a name="l06576"></a>06576         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06577"></a>06577     }
<a name="l06578"></a>06578     <span class="comment">// -----------------------------------------</span>
<a name="l06579"></a>06579     <span class="comment">// Okay, it&#39;s not &quot;clear all&quot; but &quot;clear at index&quot; ...</span>
<a name="l06580"></a>06580     <span class="comment">//</span>
<a name="l06581"></a>06581     <span class="keyword">const</span> int32_t nTransCount  = pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>();
<a name="l06582"></a>06582 
<a name="l06583"></a>06583     <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= nTransCount))
<a name="l06584"></a>06584     {
<a name="l06585"></a>06585         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Index out of bounds (highest allowed index for this expired box is %d.)\n&quot;</span>,
<a name="l06586"></a>06586                        __FUNCTION__, nTransCount-1);
<a name="l06587"></a>06587         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06588"></a>06588     }
<a name="l06589"></a>06589     <span class="comment">// -----------------------------------------</span>
<a name="l06590"></a>06590     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(nIndex);
<a name="l06591"></a>06591     <span class="keywordtype">bool</span> bRemoved = <span class="keyword">false</span>;
<a name="l06592"></a>06592 
<a name="l06593"></a>06593     <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l06594"></a>06594     {
<a name="l06595"></a>06595         <span class="keyword">const</span> int64_t lTransactionNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l06596"></a>06596 
<a name="l06597"></a>06597         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#aea09d3dd8bf2fc5630ce87184fc937c1">DeleteBoxReceipt</a>(lTransactionNum))
<a name="l06598"></a>06598         {
<a name="l06599"></a>06599             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
<a name="l06600"></a>06600                           <span class="stringliteral">&quot;from a expired box: %ld\n&quot;</span>, __FUNCTION__, lTransactionNum);
<a name="l06601"></a>06601         }
<a name="l06602"></a>06602         <span class="comment">// -----------------------------------------------------</span>
<a name="l06603"></a>06603         bRemoved = pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lTransactionNum);
<a name="l06604"></a>06604     }
<a name="l06605"></a>06605     <span class="comment">// -----------------------------------------</span>
<a name="l06606"></a>06606     <span class="keywordflow">if</span> (bRemoved)
<a name="l06607"></a>06607     {
<a name="l06608"></a>06608         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l06609"></a>06609         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l06610"></a>06610         pExpiredBox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l06611"></a>06611         pExpiredBox-&gt;<a class="code" href="class_o_t_ledger.html#ace1cb1337e94d794243bbe163eb88813">SaveExpiredBox</a>();
<a name="l06612"></a>06612         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06613"></a>06613     }
<a name="l06614"></a>06614     <span class="keywordflow">else</span>
<a name="l06615"></a>06615     {
<a name="l06616"></a>06616         <span class="keyword">const</span> int32_t nTemp = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(nIndex);
<a name="l06617"></a>06617         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to clear an expired record from the expired box at index: %d\n&quot;</span>,
<a name="l06618"></a>06618                        __FUNCTION__, nTemp);        
<a name="l06619"></a>06619     }
<a name="l06620"></a>06620     <span class="comment">// -----------------------------------------</span>
<a name="l06621"></a>06621     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06622"></a>06622 }
<a name="l06623"></a>06623 
<a name="l06624"></a>06624 <span class="comment">// -----------------------------------------------------</span>
<a name="l06625"></a>06625 
<a name="l06626"></a>06626 <span class="comment">// From OTAPI.cpp:</span>
<a name="l06627"></a>06627 <span class="comment">//</span>
<a name="l06628"></a>06628 <span class="comment">//int32_t               OT_API_GetNym_OutpaymentsCount(const char * NYM_ID);</span>
<a name="l06629"></a>06629 <span class="comment">//</span>
<a name="l06630"></a>06630 <span class="comment">//const char *  OT_API_GetNym_OutpaymentsContentsByIndex(const char * NYM_ID, int32_t nIndex); /// returns the message itself</span>
<a name="l06631"></a>06631 <span class="comment">//</span>
<a name="l06632"></a>06632 <span class="comment">//const char *  OT_API_GetNym_OutpaymentsRecipientIDByIndex(const char * NYM_ID, int32_t nIndex); /// returns the NymID of the recipient.</span>
<a name="l06633"></a>06633 <span class="comment">//const char *  OT_API_GetNym_OutpaymentsServerIDByIndex(const char * NYM_ID, int32_t nIndex); /// returns the ServerID where the message came from.</span>
<a name="l06634"></a>06634 <span class="comment">//</span>
<a name="l06635"></a>06635 <span class="comment">//int32_t               OT_API_Nym_RemoveOutpaymentsByIndex(const char * NYM_ID, int32_t nIndex); /// actually returns OT_BOOL, (1 or 0.)</span>
<a name="l06636"></a>06636 <span class="comment">//int32_t               OT_API_Nym_VerifyOutpaymentsByIndex(const char * NYM_ID, int32_t nIndex); /// actually returns OT_BOOL. OT_TRUE if signature verifies. (Sender Nym MUST be in my wallet for this to work.)</span>
<a name="l06637"></a>06637 
<a name="l06638"></a>06638 
<a name="l06639"></a>06639 
<a name="l06640"></a>06640 <span class="comment">// If you write a cheque, a copy should go in outpayments box.</span>
<a name="l06641"></a>06641 <span class="comment">// If you SEND a cheque, a copy should go in your outpayments box. (Perhaps just replacing the first one.)</span>
<a name="l06642"></a>06642 <span class="comment">// Once that cheque is CASHED, the copy should be removed from the outpayments. (Copied to record box.)</span>
<a name="l06643"></a>06643 <span class="comment">//</span>
<a name="l06644"></a>06644 <span class="comment">// If the cheque is discarded by sender, it can be moved in the same fashion. But the critical difference</span>
<a name="l06645"></a>06645 <span class="comment">// is, the recipient MIGHT still have a copy of it, and thus MIGHT still run it through, unless you take</span>
<a name="l06646"></a>06646 <span class="comment">// that discarded number and use it on another server transaction or cancel it somehow. Normally you&#39;d just</span>
<a name="l06647"></a>06647 <span class="comment">// harvest the number for some other transaction (which the &quot;discard cheque&quot; function actually does) but if</span>
<a name="l06648"></a>06648 <span class="comment">// I think about it, that cheque can still come through, meanwhile I&#39;m thinking the transaction # is available</span>
<a name="l06649"></a>06649 <span class="comment">// still to be attached to some other cheque (at least as far as my wallet can tell, if I&#39;ve harvested the number</span>
<a name="l06650"></a>06650 <span class="comment">// by this point.) My wallet will think the server is trying to screw me somehow, since it apparently hasn&#39;t</span>
<a name="l06651"></a>06651 <span class="comment">// even USED that number yet on a subsequent transaction, yet here&#39;s the server claiming it&#39;s already used and</span>
<a name="l06652"></a>06652 <span class="comment">// funds were deducted!</span>
<a name="l06653"></a>06653 <span class="comment">// Therefore we MUST (todo) add the functionality to cancel a transaction number!</span>
<a name="l06654"></a>06654 <span class="comment">// TODO: Need a server message for canceling a transaction.</span>
<a name="l06655"></a>06655 <span class="comment">// IF there are no receipts in your inbox or outbox regarding a transaction #,</span>
<a name="l06656"></a>06656 <span class="comment">// then you can cancel it. (Hmm re-think: Is that possible? What if I have a</span>
<a name="l06657"></a>06657 <span class="comment">// transaction # out there on a smart contract somewhere -- that someone ELSE</span>
<a name="l06658"></a>06658 <span class="comment">// activated? Then how would I find it? Perhaps server-side Nym needs to track</span>
<a name="l06659"></a>06659 <span class="comment">// that...)</span>
<a name="l06660"></a>06660 <span class="comment">//</span>
<a name="l06661"></a>06661 <span class="comment">// Really, if a cheque receipt comes through, and we accept it out of the inbox, then the &quot;SUCCESS&quot;</span>
<a name="l06662"></a>06662 <span class="comment">// reply for that processInbox is where we need to remove the corresponding outpayments entry and move</span>
<a name="l06663"></a>06663 <span class="comment">// it to the record box.</span>
<a name="l06664"></a>06664 <span class="comment">//</span>
<a name="l06665"></a>06665 <span class="comment">// Similarly, if a cheque is canceled (transaction # is canceled) then we should receive a &quot;SUCCESS&quot; reply</span>
<a name="l06666"></a>06666 <span class="comment">// (to that cancel transaction) and again, remove the corresponding outpayments entry and move it to the</span>
<a name="l06667"></a>06667 <span class="comment">// record box.</span>
<a name="l06668"></a>06668 <span class="comment">//</span>
<a name="l06669"></a>06669 <span class="comment">//</span>
<a name="l06670"></a>06670 <span class="comment">/*</span>
<a name="l06671"></a>06671 <span class="comment"> - In my Payments Inbox, there could be a cheque or invoice. Either way, when I deposit the cheque or</span>
<a name="l06672"></a>06672 <span class="comment"> pay the invoice, the chequeReceipt goes back to the signer&#39;s asset account&#39;s inbox.</span>
<a name="l06673"></a>06673 <span class="comment"> - When he accepts the chequeReceipt (during a processInbox) and WHEN HE GETS THE &quot;SUCCESS&quot; REPLY to that</span>
<a name="l06674"></a>06674 <span class="comment"> processInbox, is when the chequeReceipt should be moved from his inbox to his record box. It MUST be</span>
<a name="l06675"></a>06675 <span class="comment"> done then, inside OT, because the next time he downloads the inbox from the server, that chequeReceipt</span>
<a name="l06676"></a>06676 <span class="comment"> won&#39;t be in there anymore! It&#39;ll be too late to pass it on to the records.</span>
<a name="l06677"></a>06677 <span class="comment"> - Whereas I, being the recipient of his cheque, had it in my **payments inbox,** and thus upon receipt</span>
<a name="l06678"></a>06678 <span class="comment"> of a successful server-reply to my deposit transaction, need to move it from my payments inbox to my</span>
<a name="l06679"></a>06679 <span class="comment"> record box. (The record box will eventually be a callback so that client software can take over that</span>
<a name="l06680"></a>06680 <span class="comment"> functionality, which is outside the scope of OT. The actual CALL to store in the record box, however</span>
<a name="l06681"></a>06681 <span class="comment"> should occur inside OT.)</span>
<a name="l06682"></a>06682 <span class="comment"> - For now, I&#39;m using the below API call, so it&#39;s available inside the scripts. This is &quot;good enough&quot;</span>
<a name="l06683"></a>06683 <span class="comment"> for now, just to get the payments inbox/outbox working for the scripts. But in the int64_t term, I&#39;ll need</span>
<a name="l06684"></a>06684 <span class="comment"> to add the hooks directly into OT as described just above. (It&#39;ll be necessary in order to get the record</span>
<a name="l06685"></a>06685 <span class="comment"> box working.)</span>
<a name="l06686"></a>06686 <span class="comment"> - Since I&#39;m only worried about Payments Inbox for now, and since I&#39;ll be calling the below function</span>
<a name="l06687"></a>06687 <span class="comment"> directly from inside the scripts, how will this work? Incoming cheque or invoice will be in the payments</span>
<a name="l06688"></a>06688 <span class="comment"> inbox, and will need to be moved to recordBox (below call) when the script receives a success reply to</span>
<a name="l06689"></a>06689 <span class="comment"> the depositing/paying of that cheque/invoice.</span>
<a name="l06690"></a>06690 <span class="comment"> - Whereas outoing cheque/invoice is in the Outpayments box, (fundamentally more similar to the outmail</span>
<a name="l06691"></a>06691 <span class="comment"> box than to the payments inbox.) If the cheque/invoice is cashed/paid by the endorsee, **I** will receive</span>
<a name="l06692"></a>06692 <span class="comment"> the chequeReceipt, in MY asset account inbox, and when I accept it during a processInbox transaction,</span>
<a name="l06693"></a>06693 <span class="comment"> the SUCCESS REPLY from the server for that processInbox is where I should actually process that chequeReceipt</span>
<a name="l06694"></a>06694 <span class="comment"> and, if it appears in the outpayments box, move it at that time to the record box. The problem is, I can NOT</span>
<a name="l06695"></a>06695 <span class="comment"> do this much inside the script. To do this part, I thus HAVE to go into OT itself as I just described.</span>
<a name="l06696"></a>06696 <span class="comment"> - Fuck!</span>
<a name="l06697"></a>06697 <span class="comment"> - Therefore I might as well comment this out, since this simply isn&#39;t going to work.</span>
<a name="l06698"></a>06698 <span class="comment"></span>
<a name="l06699"></a>06699 <span class="comment"></span>
<a name="l06700"></a>06700 <span class="comment"></span>
<a name="l06701"></a>06701 <span class="comment"> - Updated plan:</span>
<a name="l06702"></a>06702 <span class="comment">   1. DONE: Inside OT, when processing successful server reply to processInbox request, if a chequeReceipt</span>
<a name="l06703"></a>06703 <span class="comment">      was processed out successfully, and if that cheque is found inside the outpayments, then</span>
<a name="l06704"></a>06704 <span class="comment">      move it at that time to the record box.</span>
<a name="l06705"></a>06705 <span class="comment">   2. DONE: Inside OT, when processing successful server reply to depositCheque request, if that cheque is</span>
<a name="l06706"></a>06706 <span class="comment">      found inside the Payments Inbox, move it to the record box.</span>
<a name="l06707"></a>06707 <span class="comment">   3. As for cash:</span>
<a name="l06708"></a>06708 <span class="comment">        If I SENT cash, it will be in my outpayments box. But that&#39;s wrong. Because I can</span>
<a name="l06709"></a>06709 <span class="comment">      never see if the guy cashed it or not. Therefore it should go straight to the record box, when</span>
<a name="l06710"></a>06710 <span class="comment">      sent. AND it needs to be encrypted to MY key, not his -- so need to generate BOTH versions, when</span>
<a name="l06711"></a>06711 <span class="comment">      exporting the purse to him in the FIRST PLACE. Then my version goes straight into my record box and</span>
<a name="l06712"></a>06712 <span class="comment">      I can delete it at my leisure. (If he comes running the next day saying &quot;I lost it!!&quot; I can still</span>
<a name="l06713"></a>06713 <span class="comment">      recover it. But once he deposits it, then the cash will be no good and I might as well archive it</span>
<a name="l06714"></a>06714 <span class="comment">      or destroy it, or whatever I choose to do with my personal records.)</span>
<a name="l06715"></a>06715 <span class="comment">        If I RECEIVED cash, it will be in my payments inbox, and then when I deposit it, and when I process</span>
<a name="l06716"></a>06716 <span class="comment">      the SUCCESSFUL server REPLY to my depositCash request, it should be moved to my record Box.</span>
<a name="l06717"></a>06717 <span class="comment">   4. How about vouchers? If I deposit a voucher, then the &quot;original sender&quot; should get some sort of</span>
<a name="l06718"></a>06718 <span class="comment">      notice. This means attaching his ID to the voucher--which should be optional--and then dropping an</span>
<a name="l06719"></a>06719 <span class="comment">      &quot;FYI&quot; notice to him when it gets deposited. It can&#39;t be a normal chequeReceipt because that&#39;s used</span>
<a name="l06720"></a>06720 <span class="comment">      to verify the balance agreement against a balance change, whereas a &quot;voucher receipt&quot; wouldn&#39;t represent</span>
<a name="l06721"></a>06721 <span class="comment">      a balance change at all, since the balance was already changed when you originally bought the voucher.</span>
<a name="l06722"></a>06722 <span class="comment">      Instead it would probably be sent to your Nymbox but it COULD NOT BE PROVEN that it was, since OT currently</span>
<a name="l06723"></a>06723 <span class="comment">      can&#39;t prove NOTICE!! Nevertheless, in the meantime, OT Server should still drop a notice in the Nymbox</span>
<a name="l06724"></a>06724 <span class="comment">      of the original sender which is basically a &quot;voucher receipt&quot; (containing the voucher but interpreted</span>
<a name="l06725"></a>06725 <span class="comment">      as a receipt and not as a payment instrument.)</span>
<a name="l06726"></a>06726 <span class="comment">        How about this===&gt; when such a receipt is received, instead of moving it to the payments inbox like</span>
<a name="l06727"></a>06727 <span class="comment">      we would with invoices/cheques/purses we&#39;ll just move it straight to the record box instead.</span>
<a name="l06728"></a>06728 <span class="comment"></span>
<a name="l06729"></a>06729 <span class="comment"> All of the above needs to happen inside OT, since there are many places where it&#39;s the only appropriate</span>
<a name="l06730"></a>06730 <span class="comment"> place to take the necessary action. (Script cannot.)</span>
<a name="l06731"></a>06731 <span class="comment"></span>
<a name="l06732"></a>06732 <span class="comment"> */</span>
<a name="l06733"></a>06733 
<a name="l06734"></a>06734 
<a name="l06735"></a>06735 <span class="comment">// So far I haven&#39;t needed this yet, since sent and received payments already handle moving</span>
<a name="l06736"></a>06736 <span class="comment">// payments-inbox receipts to the record box, and moving outpayments instruments to the</span>
<a name="l06737"></a>06737 <span class="comment">// record box (built into OT.) But finally a case occured: the instrument is expired, so OT</span>
<a name="l06738"></a>06738 <span class="comment">// will never move it, since OT can never deposit it, in the case of incoming payments, and</span>
<a name="l06739"></a>06739 <span class="comment">// in the case of outgoing payments, clearly the recipient never deposited it, or I would have</span>
<a name="l06740"></a>06740 <span class="comment">// gotten a receipt by now and it would have already been cleared out of my outpayments box.</span>
<a name="l06741"></a>06741 <span class="comment">// Since neither of those cases will ever happen, for an expired instrument, then how in the heck</span>
<a name="l06742"></a>06742 <span class="comment">// do I get that damned instrument out of my outpayments / payments inbox, and moved over to</span>
<a name="l06743"></a>06743 <span class="comment">// the record box so the client software can deal with it? Answer: this API call: OT_API::RecordPayment</span>
<a name="l06744"></a>06744 <span class="comment">//</span>
<a name="l06745"></a>06745 <span class="comment">// ONE MORE THING: Let&#39;s say I sent a cheque and it expired. The recipient never cashed it.</span>
<a name="l06746"></a>06746 <span class="comment">// At this point, I am SAFE to harvest the transaction number(s) back off of the cheque. After</span>
<a name="l06747"></a>06747 <span class="comment">// all, it was never cashed, right? And since it&#39;s now expired, it never WILL be cashed, right?</span>
<a name="l06748"></a>06748 <span class="comment">// Therefore I NEED to harvest the transaction number back from the expired instrument, so I can</span>
<a name="l06749"></a>06749 <span class="comment">// use it again in the future and eventually get it closed out.</span>
<a name="l06750"></a>06750 <span class="comment">//</span>
<a name="l06751"></a>06751 <span class="comment">// UPDATE: This should now also work for smart contracts and payment plans.</span>
<a name="l06752"></a>06752 <span class="comment">//</span>
<a name="l06753"></a><a class="code" href="class_o_t___a_p_i.html#ad96c4b1b56f797482b7383072b9037db">06753</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#ad96c4b1b56f797482b7383072b9037db">OT_API::RecordPayment</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l06754"></a>06754                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l06755"></a>06755                            <span class="keywordtype">bool</span>    bIsInbox, <span class="comment">// true == payments inbox. false == outpayments box.</span>
<a name="l06756"></a>06756                            int32_t nIndex,   <span class="comment">// removes payment instrument (from payments inbox or outpayments box) and moves to record box.</span>
<a name="l06757"></a>06757                            <span class="keywordtype">bool</span>  bSaveCopy)
<a name="l06758"></a>06758 {
<a name="l06759"></a>06759     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l06760"></a>06760     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06761"></a>06761     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l06762"></a>06762     <span class="comment">// -----------------------------------------------------</span>
<a name="l06763"></a>06763     <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pRecordBox  = NULL;
<a name="l06764"></a>06764     <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pExpiredBox = NULL;
<a name="l06765"></a>06765     <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pActualBox  = NULL; <span class="comment">// This points to either pRecordBox or pExpiredBox.</span>
<a name="l06766"></a>06766     <span class="comment">// -----------------------------------------------------</span>
<a name="l06767"></a>06767     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRecordBoxAngel;
<a name="l06768"></a>06768     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theExpiredBoxAngel;
<a name="l06769"></a>06769     <span class="comment">// -----------------------------------------------------</span>
<a name="l06770"></a>06770     <span class="keywordflow">if</span> (bSaveCopy)
<a name="l06771"></a>06771     {
<a name="l06772"></a>06772         pRecordBox  = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">LoadRecordBox</a> (SERVER_ID, USER_ID, USER_ID);
<a name="l06773"></a>06773         pExpiredBox = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ae3d6ecd9fabfea445d35fd7307008856">LoadExpiredBox</a>(SERVER_ID, USER_ID);
<a name="l06774"></a>06774         <span class="comment">// -----------------------------------------------------</span>
<a name="l06775"></a>06775         theRecordBoxAngel .<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pRecordBox);
<a name="l06776"></a>06776         theExpiredBoxAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pExpiredBox);
<a name="l06777"></a>06777         <span class="comment">// -----------------------------------------------------</span>
<a name="l06778"></a>06778         <span class="keywordflow">if</span> (NULL == pRecordBox)
<a name="l06779"></a>06779         {
<a name="l06780"></a>06780             pRecordBox = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>);
<a name="l06781"></a>06781             <span class="keywordflow">if</span> (NULL  == pRecordBox)
<a name="l06782"></a>06782             {
<a name="l06783"></a>06783                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load or create record box (and thus unable to do anything with it.)\n&quot;</span>,
<a name="l06784"></a>06784                               __FUNCTION__);
<a name="l06785"></a>06785                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06786"></a>06786             }
<a name="l06787"></a>06787             theRecordBoxAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pRecordBox);
<a name="l06788"></a>06788         }
<a name="l06789"></a>06789         <span class="comment">// -----------------------------------------------------</span>
<a name="l06790"></a>06790         <span class="keywordflow">if</span> (NULL == pExpiredBox)
<a name="l06791"></a>06791         {
<a name="l06792"></a>06792             pExpiredBox = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, USER_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa500bad2900b83847f7cc16b8cc26817a">OTLedger::expiredBox</a>, <span class="keyword">true</span>);
<a name="l06793"></a>06793             <span class="keywordflow">if</span> (NULL   == pExpiredBox)
<a name="l06794"></a>06794             {
<a name="l06795"></a>06795                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load or create expired box (and thus unable to do anything with it.)\n&quot;</span>,
<a name="l06796"></a>06796                               __FUNCTION__);
<a name="l06797"></a>06797                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06798"></a>06798             }
<a name="l06799"></a>06799             theExpiredBoxAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pExpiredBox);
<a name="l06800"></a>06800         }
<a name="l06801"></a>06801     }
<a name="l06802"></a>06802     <span class="comment">// -----------------------------------------------------</span>
<a name="l06803"></a>06803     pActualBox  = pRecordBox;
<a name="l06804"></a>06804     <span class="comment">// -----------------------------------------------------</span>
<a name="l06805"></a>06805     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pPaymentInbox  = NULL;
<a name="l06806"></a>06806     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> thePaymentBoxAngel;
<a name="l06807"></a>06807 
<a name="l06808"></a>06808     <span class="keywordtype">bool</span> bIsExpired = <span class="keyword">false</span>;
<a name="l06809"></a>06809 
<a name="l06810"></a>06810     <span class="comment">//first block:</span>
<a name="l06811"></a>06811     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = NULL;
<a name="l06812"></a>06812     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel;
<a name="l06813"></a>06813 
<a name="l06814"></a>06814     <span class="comment">//second block:</span>
<a name="l06815"></a>06815     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = NULL;
<a name="l06816"></a>06816     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theMessageAngel;
<a name="l06817"></a>06817 
<a name="l06818"></a>06818     <span class="keywordtype">bool</span> bRemoved = <span class="keyword">false</span>, bNeedToSaveTheNym = <span class="keyword">false</span>;
<a name="l06819"></a>06819 
<a name="l06820"></a>06820     <span class="keywordflow">if</span> (bIsInbox)
<a name="l06821"></a>06821     {
<a name="l06822"></a>06822         pPaymentInbox = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a5077987cf25f441923c88cb51b3d940a">LoadPaymentInbox</a>(SERVER_ID, USER_ID);
<a name="l06823"></a>06823         <span class="comment">// -----------------------------------------------------</span>
<a name="l06824"></a>06824         thePaymentBoxAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pPaymentInbox);
<a name="l06825"></a>06825         <span class="comment">// -----------------------------------------------------</span>
<a name="l06826"></a>06826         <span class="keywordflow">if</span> (NULL == pPaymentInbox)
<a name="l06827"></a>06827         {
<a name="l06828"></a>06828             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load payment inbox (and thus unable to do anything with it.)\n&quot;</span>,
<a name="l06829"></a>06829                           __FUNCTION__);
<a name="l06830"></a>06830             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06831"></a>06831         }
<a name="l06832"></a>06832         <span class="comment">// -----------------------------------------------------</span>
<a name="l06833"></a>06833         <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>()))
<a name="l06834"></a>06834         {
<a name="l06835"></a>06835             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find transaction in payment inbox based on index %d. (Out of bounds.)\n&quot;</span>,
<a name="l06836"></a>06836                           __FUNCTION__, nIndex);
<a name="l06837"></a>06837             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06838"></a>06838         }
<a name="l06839"></a>06839         <span class="comment">// ---------------------</span>
<a name="l06840"></a>06840         pTransaction = pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(nIndex);
<a name="l06841"></a>06841 
<a name="l06842"></a>06842         <span class="keywordflow">if</span> (NULL == pTransaction)
<a name="l06843"></a>06843         {
<a name="l06844"></a>06844             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find transaction in payment inbox based on index %d.\n&quot;</span>,
<a name="l06845"></a>06845                           __FUNCTION__, nIndex);
<a name="l06846"></a>06846             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06847"></a>06847         }
<a name="l06848"></a>06848         <span class="comment">// -----------------------------------------------------</span>
<a name="l06849"></a>06849         <a class="code" href="class_o_t_payment.html">OTPayment</a> * pPayment  = pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#a114a4d31098807d6cb873a7343a407ae">GetInstrument</a>(*pNym, nIndex);
<a name="l06850"></a>06850         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPayment&gt;</a> thePaymentAngel(pPayment);
<a name="l06851"></a>06851         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPayment);
<a name="l06852"></a>06852 
<a name="l06853"></a>06853         pPayment-&gt;<a class="code" href="class_o_t_payment.html#a1949cd91091734be36e607c3a2877822">IsExpired</a>(bIsExpired);
<a name="l06854"></a>06854 
<a name="l06855"></a>06855         <span class="keywordflow">if</span> (bIsExpired)
<a name="l06856"></a>06856             pActualBox = pExpiredBox;
<a name="l06857"></a>06857         <span class="comment">// -----------------------------------------------------</span>
<a name="l06858"></a>06858         <span class="comment">// Remove it from the payments inbox...</span>
<a name="l06859"></a>06859         <span class="comment">//</span>
<a name="l06860"></a>06860         <span class="keyword">const</span> int64_t lTransactionNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l06861"></a>06861 
<a name="l06862"></a>06862         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#aea09d3dd8bf2fc5630ce87184fc937c1">DeleteBoxReceipt</a>(lTransactionNum))
<a name="l06863"></a>06863         {
<a name="l06864"></a>06864             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
<a name="l06865"></a>06865                           <span class="stringliteral">&quot;from the payment inbox: %ld\n&quot;</span>, __FUNCTION__, lTransactionNum);
<a name="l06866"></a>06866         }
<a name="l06867"></a>06867         <span class="comment">// -----------------------------------------------------</span>
<a name="l06868"></a>06868         bRemoved = pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lTransactionNum, <span class="keyword">false</span>); <span class="comment">// bDeleteIt=true by default. We pass false since we are moving it to another box. Note that we still need to save pPaymentInbox somewhere below, assuming it&#39;s all successful.</span>
<a name="l06869"></a>06869         theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pTransaction); <span class="comment">// If below we put pTransaction onto the Record Box, then we have to set this to NULL.</span>
<a name="l06870"></a>06870 
<a name="l06871"></a>06871         <span class="comment">// NOTE: pTransaction is still good, below this point, and will be cleaned up automatically</span>
<a name="l06872"></a>06872         <span class="comment">// whenever we exit this function.</span>
<a name="l06873"></a>06873 
<a name="l06874"></a>06874         <span class="comment">// Anything else?</span>
<a name="l06875"></a>06875         <span class="comment">// Note: no need to harvest transaction number for incoming payments.</span>
<a name="l06876"></a>06876         <span class="comment">// But for outgoing (see below) then harvesting becomes an issue.</span>
<a name="l06877"></a>06877 
<a name="l06878"></a>06878     }
<a name="l06879"></a>06879     <span class="keywordflow">else</span> <span class="comment">// Outpayments box (which is not stored in an OTLedger like payments inbox, but rather, is stored similarly to outmail.)</span>
<a name="l06880"></a>06880     {
<a name="l06881"></a>06881         <span class="comment">// -----------------------------------------------------</span>
<a name="l06882"></a>06882         <span class="comment">//</span>
<a name="l06883"></a>06883         <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66289f0575ef0b91cb5fefa4483f0d3e" title="return the number of payments items available for this Nym.">GetOutpaymentsCount</a>()))
<a name="l06884"></a>06884         {
<a name="l06885"></a>06885             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment in outpayment box based on index %d. (Out of bounds.)\n&quot;</span>,
<a name="l06886"></a>06886                           __FUNCTION__, nIndex);
<a name="l06887"></a>06887             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06888"></a>06888         }
<a name="l06889"></a>06889         <span class="comment">// ---------------------</span>
<a name="l06890"></a>06890         pMessage = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#acb808e89943f1f2d0009825a3fbcb34f">GetOutpaymentsByIndex</a>(nIndex);
<a name="l06891"></a>06891 
<a name="l06892"></a>06892         <span class="keywordflow">if</span> (NULL == pMessage)
<a name="l06893"></a>06893         {
<a name="l06894"></a>06894             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment message in outpayment box based on index %d.\n&quot;</span>,
<a name="l06895"></a>06895                           __FUNCTION__, nIndex);
<a name="l06896"></a>06896             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06897"></a>06897         }
<a name="l06898"></a>06898         <span class="comment">// ---------------------</span>
<a name="l06899"></a>06899         <a class="code" href="class_o_t_string.html">OTString</a> strInstrument;
<a name="l06900"></a>06900         <span class="keywordflow">if</span> (!pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ab39b6cae69c14149716e5ce7a6f0bb0f">GetString</a>(strInstrument))
<a name="l06901"></a>06901         {
<a name="l06902"></a>06902             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to find payment instrument in outpayment message at index %d.\n&quot;</span>,
<a name="l06903"></a>06903                           __FUNCTION__, nIndex);
<a name="l06904"></a>06904             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06905"></a>06905         }
<a name="l06906"></a>06906         <span class="comment">// ---------------------</span>
<a name="l06907"></a>06907         <a class="code" href="class_o_t_payment.html">OTPayment</a>  thePayment(strInstrument);
<a name="l06908"></a>06908         int64_t       lPaymentOpeningNum = 0;
<a name="l06909"></a>06909         int64_t       lPaymentTransNum   = 0;
<a name="l06910"></a>06910 
<a name="l06911"></a>06911         <span class="keywordflow">if</span> (thePayment.<a class="code" href="class_o_t_payment.html#a7f95ab568d481ecc7d38689c80caba84">IsValid</a>() &amp;&amp; thePayment.<a class="code" href="class_o_t_payment.html#a1ee95406f9d221ae4a57783422d52156">SetTempValues</a>())
<a name="l06912"></a>06912         {
<a name="l06913"></a>06913             <span class="comment">// EXPIRED?</span>
<a name="l06914"></a>06914             <span class="comment">//</span>
<a name="l06915"></a>06915             thePayment.<a class="code" href="class_o_t_payment.html#a1949cd91091734be36e607c3a2877822">IsExpired</a>(bIsExpired);
<a name="l06916"></a>06916 
<a name="l06917"></a>06917             <span class="keywordflow">if</span> (bIsExpired)
<a name="l06918"></a>06918                 pActualBox = pExpiredBox;
<a name="l06919"></a>06919             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l06920"></a>06920             <span class="comment">// Anything but a purse?</span>
<a name="l06921"></a>06921             <span class="comment">//</span>
<a name="l06922"></a>06922             <span class="keywordflow">if</span> (thePayment.<a class="code" href="class_o_t_payment.html#a4a6c103790c2fc759136079db0e65434">GetOpeningNum</a>(lPaymentOpeningNum, USER_ID)) <span class="comment">// cheques, invoices, vouchers, smart contracts, payment plans.</span>
<a name="l06923"></a>06923             {
<a name="l06924"></a>06924                 <span class="comment">// We we-grab the transaction number at this time. That way if it&#39;s a transaction num that</span>
<a name="l06925"></a>06925                 <span class="comment">// belongs to some other Nym (and is different than our own opening number) then we will</span>
<a name="l06926"></a>06926                 <span class="comment">// get the different number here.</span>
<a name="l06927"></a>06927                 <span class="comment">//</span>
<a name="l06928"></a>06928                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == thePayment.<a class="code" href="class_o_t_payment.html#a02ffc34caf84cf6e9f88910b6354fbd8">GetTransactionNum</a>(lPaymentTransNum))
<a name="l06929"></a>06929                 {
<a name="l06930"></a>06930                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Should never happen! &quot;</span>
<a name="l06931"></a>06931                                   <span class="stringliteral">&quot;Failed to get transaction num from payment RIGHT AFTER succeeded getting opening num.\n&quot;</span>,
<a name="l06932"></a>06932                                   __FUNCTION__);
<a name="l06933"></a>06933                 }
<a name="l06934"></a>06934                 <span class="comment">// ----------------------------------------------------------</span>
<a name="l06935"></a>06935                 <span class="comment">// However, if it IS a different number, in the case of smart contracts and payment plans,</span>
<a name="l06936"></a>06936                 <span class="comment">// we then change it BACK to the opening number again. Read the next comment for details why.</span>
<a name="l06937"></a>06937                 <span class="comment">//</span>
<a name="l06938"></a>06938                 <span class="keywordtype">bool</span> bIsRecurring = <span class="keyword">false</span>;
<a name="l06939"></a>06939 
<a name="l06940"></a>06940                 <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0a78fc70e3c86977fdac8bb86f5df8fee2">OTPayment::PAYMENT_PLAN</a>   == thePayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>()) ||
<a name="l06941"></a>06941                     (<a class="code" href="class_o_t_payment.html#aff3d9ae26dc36bc91037fe53db0d55d0ac5f087c87496d75a8a50790118d057f1">OTPayment::SMART_CONTRACT</a> == thePayment.<a class="code" href="class_o_t_payment.html#a750b001a080812918d7c68bbc85c3ff3">GetType</a>()))
<a name="l06942"></a>06942                 {
<a name="l06943"></a>06943                     bIsRecurring     = <span class="keyword">true</span>;
<a name="l06944"></a>06944                     lPaymentTransNum = lPaymentOpeningNum;
<a name="l06945"></a>06945                     <span class="comment">// We do this because the ACTUAL transaction number on a smart contract or payment plan</span>
<a name="l06946"></a>06946                     <span class="comment">// might be different that THIS Nym&#39;s opening number (it might be some other Nym&#39;s opening</span>
<a name="l06947"></a>06947                     <span class="comment">// number.) But even if that&#39;s the case, we still want to harvest THIS Nym&#39;s opening number,</span>
<a name="l06948"></a>06948                     <span class="comment">// not the other Nym&#39;s opening number. So for these instruments, we set the &quot;transaction number&quot;</span>
<a name="l06949"></a>06949                     <span class="comment">// to be THIS Nym&#39;s opening number. (Versus just saying, &quot;Oh the trans number is for some other</span>
<a name="l06950"></a>06950                     <span class="comment">// Nym, so just ignore this&quot; which would cause us to not harvest the numbers for THIS Nym that</span>
<a name="l06951"></a>06951                     <span class="comment">// we probably SHOULD be harvesting.</span>
<a name="l06952"></a>06952                 }
<a name="l06953"></a>06953 
<a name="l06954"></a>06954                 <span class="comment">// See what account the payment instrument is drawn from.</span>
<a name="l06955"></a>06955                 <span class="comment">// Is it mine?</span>
<a name="l06956"></a>06956                 <span class="comment">// If so, load up the inbox and see if there are any related receipts inside.</span>
<a name="l06957"></a>06957                 <span class="comment">// If so, do NOT harvest the transaction numbers from the instrument.</span>
<a name="l06958"></a>06958                 <span class="comment">// Otherwise, harvest them. (The instrument hasn&#39;t been redeemed yet.)</span>
<a name="l06959"></a>06959                 <span class="comment">// Also, use the transaction number on the instrument to see if it&#39;s signed out to me.</span>
<a name="l06960"></a>06960                 <span class="comment">//</span>
<a name="l06961"></a>06961                 <span class="comment">// Hmm: If the instrument is definitely expired, and there&#39;s definitely nothing in the asset</span>
<a name="l06962"></a>06962                 <span class="comment">// accountinbox, then I can DEFINITELY harvest it back.</span>
<a name="l06963"></a>06963                 <span class="comment">//</span>
<a name="l06964"></a>06964                 <span class="comment">// But if the instrument is definitely NOT expired, and the transaction # IS signed out to ME,</span>
<a name="l06965"></a>06965                 <span class="comment">// then I can&#39;t just harvest the numbers, since the original recipient could still come through</span>
<a name="l06966"></a>06966                 <span class="comment">// and deposit that cheque. So in this case, I would HAVE to cancel the transaction, and then</span>
<a name="l06967"></a>06967                 <span class="comment">// such cancellation would automatically harvest while processing the successful server reply.</span>
<a name="l06968"></a>06968                 <span class="comment">//</span>
<a name="l06969"></a>06969                 <span class="comment">// Therefore make sure not to move the instrument here, unless it&#39;s definitely expired.</span>
<a name="l06970"></a>06970                 <span class="comment">// Whereas if it&#39;s not expired, then the API must cancel it with the server, and can&#39;t simply</span>
<a name="l06971"></a>06971                 <span class="comment">// come in here and move/harvest it. So this function can only be for expired transactions or</span>
<a name="l06972"></a>06972                 <span class="comment">// those where the transaction number is no longer issued. (And in cases where it&#39;s expired but</span>
<a name="l06973"></a>06973                 <span class="comment">// STILL issued, then it definitely DOES need to harvest.)</span>
<a name="l06974"></a>06974                 <span class="comment">//</span>
<a name="l06975"></a>06975 
<a name="l06976"></a>06976                 <span class="keywordtype">bool</span> bShouldHarvestPayment     = <span class="keyword">false</span>;
<a name="l06977"></a>06977                 <span class="keywordtype">bool</span> bNeedToLoadAssetAcctInbox = <span class="keyword">false</span>;
<a name="l06978"></a>06978                 <span class="keywordtype">bool</span> bIsIssued                 = <span class="keyword">false</span>;
<a name="l06979"></a>06979                 <span class="comment">// ----------------------</span>
<a name="l06980"></a>06980                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theSenderUserID, theSenderAcctID;
<a name="l06981"></a>06981 
<a name="l06982"></a>06982                 <span class="keywordtype">bool</span> bPaymentSenderIsNym  = <span class="keyword">false</span>;
<a name="l06983"></a>06983                 <span class="keywordtype">bool</span> bFromAcctIsAvailable = <span class="keyword">false</span>;
<a name="l06984"></a>06984                 <span class="comment">// ----------------------</span>
<a name="l06985"></a>06985                 <span class="keywordflow">if</span> (thePayment.<a class="code" href="class_o_t_payment.html#a459ef3429d35343f1ede5b34ed76c01a">IsVoucher</a>())
<a name="l06986"></a>06986                 {
<a name="l06987"></a>06987                     bPaymentSenderIsNym  = (thePayment.<a class="code" href="class_o_t_payment.html#aa1ba92e3012a6c5a847fdab8957eaa48">GetRemitterUserID</a>(theSenderUserID) &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5ec9340b8d1d0fcd32f754ea63f9915a">CompareID</a>(theSenderUserID));
<a name="l06988"></a>06988                     bFromAcctIsAvailable =  thePayment.<a class="code" href="class_o_t_payment.html#a846843bfb3ae2c69d82c1c7189f2ab12">GetRemitterAcctID</a>(theSenderAcctID);
<a name="l06989"></a>06989                 }
<a name="l06990"></a>06990                 <span class="keywordflow">else</span>
<a name="l06991"></a>06991                 {
<a name="l06992"></a>06992                     bPaymentSenderIsNym  = (thePayment.<a class="code" href="class_o_t_payment.html#a0df0b7637d7a74e10008aa349e148abd">GetSenderUserID</a>(theSenderUserID) &amp;&amp; pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5ec9340b8d1d0fcd32f754ea63f9915a">CompareID</a>(theSenderUserID));
<a name="l06993"></a>06993                     bFromAcctIsAvailable =  thePayment.<a class="code" href="class_o_t_payment.html#a866c7dee565216660a9a9c95bfd49aa4">GetSenderAcctID</a>(theSenderAcctID);
<a name="l06994"></a>06994                 }
<a name="l06995"></a>06995                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l06996"></a>06996                 <span class="keywordflow">if</span> (bPaymentSenderIsNym ||  <span class="comment">// true for cheques as well as vouchers. (We grab the remitter above, for vouchers.)</span>
<a name="l06997"></a>06997                     bIsRecurring)           <span class="comment">// false for cheques/vouchers; true for payment plans and smart contracts.</span>
<a name="l06998"></a>06998                 {
<a name="l06999"></a>06999                     <span class="comment">// NOTE: With bPaymentSenderIsNym, we know pNym owns the transaction number on the cheque.</span>
<a name="l07000"></a>07000                     <span class="comment">// NOTE: with bIsRecurring, we know pNym is one of the parties of the smart contract.</span>
<a name="l07001"></a>07001                     <span class="comment">//       (Since we found an opening number for pNym on it.)</span>
<a name="l07002"></a>07002 
<a name="l07003"></a>07003                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l07004"></a>07004 
<a name="l07005"></a>07005                     <span class="comment">// If the transaction # isn&#39;t signed out to me, then there&#39;s no need to check the inbox</span>
<a name="l07006"></a>07006                     <span class="comment">// for any receipts, since those would have to have been already closed out, in order for</span>
<a name="l07007"></a>07007                     <span class="comment">// the number not to be signed out to me anymore.</span>
<a name="l07008"></a>07008                     <span class="comment">//</span>
<a name="l07009"></a>07009                     <span class="comment">// Therefore let&#39;s check that first, before bothering to load the inbox.</span>
<a name="l07010"></a>07010                     <span class="comment">//</span>
<a name="l07011"></a>07011                     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ac05ddbd6036b5304b7215251d1b7c9b0">VerifyTentativeNum</a>(strServerID, lPaymentTransNum))   <span class="comment">// If I&#39;m in the middle of trying to sign it out...</span>
<a name="l07012"></a>07012                     {
<a name="l07013"></a>07013                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Why on earth is this transaction number (%ld) on an outgoing payment instrument, if it&#39;s still on my &#39;Tentative&#39; list? If I haven&#39;t even signed out that number, how did I send an instrument to someone else with that number on it?\n&quot;</span>, __FUNCTION__, lPaymentTransNum);
<a name="l07014"></a>07014                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07015"></a>07015                     }
<a name="l07016"></a>07016                     <span class="comment">// ---------------------------</span>
<a name="l07017"></a>07017                     bIsIssued = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lPaymentTransNum);
<a name="l07018"></a>07018 
<a name="l07019"></a>07019                     <span class="comment">// If pNym is the sender AND the payment instrument IS expired.</span>
<a name="l07020"></a>07020                     <span class="comment">//</span>
<a name="l07021"></a>07021                     <span class="keywordflow">if</span> (bIsExpired)
<a name="l07022"></a>07022                     {
<a name="l07023"></a>07023                         <span class="keywordflow">if</span> (bIsIssued)  <span class="comment">// ...and if this number is still signed out to pNym...</span>
<a name="l07024"></a>07024                         {
<a name="l07025"></a>07025                             <span class="comment">// If the instrument is definitely expired, and its number is still issued to pNym, and</span>
<a name="l07026"></a>07026                             <span class="comment">// there&#39;s definitely no related chequeReceipts in the asset acocunt inbox, then I</span>
<a name="l07027"></a>07027                             <span class="comment">// can DEFINITELY harvest it back. After all, it hasn&#39;t been used, and since it&#39;s</span>
<a name="l07028"></a>07028                             <span class="comment">// expired, now it CAN&#39;T be used. So might as well harvest the number back, since we&#39;ve</span>
<a name="l07029"></a>07029                             <span class="comment">// established that it&#39;s still signed out.</span>
<a name="l07030"></a>07030                             <span class="comment">//</span>
<a name="l07031"></a>07031                             <span class="comment">// You might ask, but what if there IS a chequeReceipt in the asset account inbox? How</span>
<a name="l07032"></a>07032                             <span class="comment">// does that change things? The answer is, because the transaction # might still be signed</span>
<a name="l07033"></a>07033                             <span class="comment">// out to me, even in a case where the payment instrument is expired, but a chequeReceipt</span>
<a name="l07034"></a>07034                             <span class="comment">// still IS present! How so? Simple: I sent him the cheque, he cashed it. It&#39;s in my outpayments</span>
<a name="l07035"></a>07035                             <span class="comment">// still, because his chequeReceipt is in my inbox still, and hasn&#39;t been processed out.</span>
<a name="l07036"></a>07036                             <span class="comment">// Meanwhile I wait a few weeks, and then the instrument, meanwhile, expires. It&#39;s already</span>
<a name="l07037"></a>07037                             <span class="comment">// been processed, so it doesn&#39;t matter that it&#39;s expired. But nonetheless, according to the</span>
<a name="l07038"></a>07038                             <span class="comment">// dates affixed to it, it IS expired, and the receipt IS present. So this is clearly a</span>
<a name="l07039"></a>07039                             <span class="comment">// realistic and legitimate case for our logic to take into account. When this happens, we</span>
<a name="l07040"></a>07040                             <span class="comment">// should NOT harvest the transaction # back when recording the payment, because that number</span>
<a name="l07041"></a>07041                             <span class="comment">// has been used already!</span>
<a name="l07042"></a>07042                             <span class="comment">//</span>
<a name="l07043"></a>07043                             <span class="comment">// That, in a nutshell, is why we have to load the inbox and see if that receipt&#39;s there,</span>
<a name="l07044"></a>07044                             <span class="comment">// to MAKE SURE whether the instrument was negotiated already, before it expired, even though</span>
<a name="l07045"></a>07045                             <span class="comment">// I haven&#39;t accepted the receipt and closed out the transaction # yet, because it impacts</span>
<a name="l07046"></a>07046                             <span class="comment">// our decision of whether or not to harvest back the number.</span>
<a name="l07047"></a>07047                             <span class="comment">//</span>
<a name="l07048"></a>07048                             <span class="comment">// The below two statements are interpreted based on this logic (see comment for each.)</span>
<a name="l07049"></a>07049                             <span class="comment">//</span>
<a name="l07050"></a>07050                             bShouldHarvestPayment     = <span class="keyword">true</span>;  <span class="comment">// If NO chequeReceipt/paymentReceipt/finalReceipt in inbox, definitely SHOULD harvest back the trans # (since the cheque&#39;s expired and could never otherwise be closed out)...</span>
<a name="l07051"></a>07051                             bNeedToLoadAssetAcctInbox = <span class="keyword">true</span>;  <span class="comment">// ...But if chequeReceipt/paymentReceipt/finalReceipt IS in inbox, definitely should NOT harvest back the # (since it&#39;s already been used.)</span>
<a name="l07052"></a>07052                             <span class="comment">//</span>
<a name="l07053"></a>07053                             <span class="comment">// =====&gt; Therefore bNeedToLoadAssetAcctInbox is a caveat, which OVERRIDES bShouldHarvestPayment. &lt;=====</span>
<a name="l07054"></a>07054                         }
<a name="l07055"></a>07055                         <span class="keywordflow">else</span> <span class="comment">// pNym is sender, payment instrument IS expired, and most importantly: the transaction # is no longer signed out</span>
<a name="l07056"></a>07056                         {    <span class="comment">// to pNym. Normally the closing of the # (by accepting whatever its related receipt was) should have already</span>
<a name="l07057"></a>07057                              <span class="comment">// removed the outpayment, so we are cleared here to go ahead and remove it.</span>
<a name="l07058"></a>07058                              <span class="comment">//</span>
<a name="l07059"></a>07059                             bShouldHarvestPayment     = <span class="keyword">false</span>; <span class="comment">// The # isn&#39;t signed out anymore, so we don&#39;t want to harvest it (which would cause the wallet to try and use it again -- but we don&#39;t want that, since we can&#39;t be using numnbers that aren&#39;t even signed out to us!)</span>
<a name="l07060"></a>07060                             bNeedToLoadAssetAcctInbox = <span class="keyword">false</span>; <span class="comment">// No need to check the inbox since the # isn&#39;t even signed out anymore. Even if some related receipt was in the inbox (for some non-cheque instrument, say) we&#39;d still never need to harvest it back for re-use, since it&#39;s not even signed out to us anymore, and we can only use numbers that are signed out to us.</span>
<a name="l07061"></a>07061                         }
<a name="l07062"></a>07062                     } <span class="comment">// if bIsExpired.</span>
<a name="l07063"></a>07063                     <span class="comment">// ------------------------------------------------------------------------------------------------</span>
<a name="l07064"></a>07064                     <span class="keywordflow">else</span> <span class="comment">// Not expired. pNym is the sender but the payment instrument is NOT expired.</span>
<a name="l07065"></a>07065                     {
<a name="l07066"></a>07066                         <span class="comment">// Remember that the transaction number is still signed out to me until I accept that</span>
<a name="l07067"></a>07067                         <span class="comment">// chequeReceipt. So whether the receipt is there or not, the # will still be signed</span>
<a name="l07068"></a>07068                         <span class="comment">// out to me. But if there&#39;s no receipt yet in my inbox, that means the cheque hasn&#39;t</span>
<a name="l07069"></a>07069                         <span class="comment">// been cashed yet. And THAT means I still have time to cancel it. I can&#39;t just discard</span>
<a name="l07070"></a>07070                         <span class="comment">// the payment instrument, since its trans# would still need to be harvested if it&#39;s not</span>
<a name="l07071"></a>07071                         <span class="comment">// being cancelled (so as to get it closed out on some other instrument, presumably), but</span>
<a name="l07072"></a>07072                         <span class="comment">// I can&#39;t just harvest a number when there&#39;s some instrument still floating around out</span>
<a name="l07073"></a>07073                         <span class="comment">// there, with that same number already on it! I HAVE to cancel it.</span>
<a name="l07074"></a>07074                         <span class="comment">//</span>
<a name="l07075"></a>07075                         <span class="comment">// If I discard it without harvesting, and if the recipient never cashes it, then that</span>
<a name="l07076"></a>07076                         <span class="comment">// transaction # will end up signed out to me FOREVER (bad thing.) So I would have to</span>
<a name="l07077"></a>07077                         <span class="comment">// cancel it first, in order to discard it. The server&#39;s success reply to my cancel</span>
<a name="l07078"></a>07078                         <span class="comment">// would be the proper time to discard the old outpayment. Until I see that, how do I know</span>
<a name="l07079"></a>07079                         <span class="comment">// if I won&#39;t need it in the future, for harvesting back?</span>
<a name="l07080"></a>07080                         <span class="comment">//</span>
<a name="l07081"></a>07081                         <span class="keywordflow">if</span> (bIsIssued)  <span class="comment">// If this number is still signed out to pNym...</span>
<a name="l07082"></a>07082                         {
<a name="l07083"></a>07083                             <span class="comment">// If the instrument is definitely NOT expired, and the transaction # definitely IS issued to ME,</span>
<a name="l07084"></a>07084                             <span class="comment">// then I can&#39;t just harvest the numbers, since the original recipient could still come through</span>
<a name="l07085"></a>07085                             <span class="comment">// and deposit that cheque.  So in this case, I would HAVE to cancel the transaction first, and then</span>
<a name="l07086"></a>07086                             <span class="comment">// such cancellation could sign a new transaction statement with that # removed from my list of</span>
<a name="l07087"></a>07087                             <span class="comment">// &quot;signed out&quot; numbers. Only then am I safe from the cheque being cashed by the recipient,</span>
<a name="l07088"></a>07088                             <span class="comment">// and only then could I even think about harvesting the number back--that itself being unnecessary,</span>
<a name="l07089"></a>07089                             <span class="comment">// since the transaction # would then be cancelled/closed and thus would eliminate any need of</span>
<a name="l07090"></a>07090                             <span class="comment">// harvesting it (since now I will never use it.)</span>
<a name="l07091"></a>07091                             <span class="comment">//</span>
<a name="l07092"></a>07092                             <span class="comment">// Also, if I DON&#39;T cancel it, then I don&#39;t want to remove it from the outpayments box, because</span>
<a name="l07093"></a>07093                             <span class="comment">// it will be removed automatically whenever the cheque is eventually cashed, and until/unless that</span>
<a name="l07094"></a>07094                             <span class="comment">// happens, I need to keep it around for potential harvesting or cancellation. Therefore I can&#39;t</span>
<a name="l07095"></a>07095                             <span class="comment">// discard the instrument either--I need to keep it in the outpayments box for now, in case it&#39;s</span>
<a name="l07096"></a>07096                             <span class="comment">// needed later.</span>
<a name="l07097"></a>07097                             <span class="comment">//</span>
<a name="l07098"></a>07098                             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: This outpayment isn&#39;t expired yet, and the transaction number (%ld) is still signed out. &quot;</span>
<a name="l07099"></a>07099                                            <span class="stringliteral">&quot;(Skipping moving it to record box -- it will be moved automatically once you cancel the transaction &quot;</span>
<a name="l07100"></a>07100                                            <span class="stringliteral">&quot;or the recipient deposits it.)\n&quot;</span>, __FUNCTION__, lPaymentTransNum);
<a name="l07101"></a>07101                             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07102"></a>07102                         }
<a name="l07103"></a>07103                         <span class="keywordflow">else</span> <span class="comment">// The payment is NOT expired yet, but most importantly, its transaction # is NOT signed out to pNym anymore.</span>
<a name="l07104"></a>07104                         {    <span class="comment">// Normally the closing of the # (by accepting whatever its related receipt was) should have already</span>
<a name="l07105"></a>07105                              <span class="comment">// removed the outpayment by now, so we are cleared here to go ahead and remove it.</span>
<a name="l07106"></a>07106                              <span class="comment">//</span>
<a name="l07107"></a>07107                             bShouldHarvestPayment     = <span class="keyword">false</span>; <span class="comment">// The # isn&#39;t signed out anymore, so we don&#39;t want to harvest it (which would cause the wallet to try and use it again.)</span>
<a name="l07108"></a>07108                             bNeedToLoadAssetAcctInbox = <span class="keyword">false</span>; <span class="comment">// No need to check the inbox since the # isn&#39;t even signed out anymore and we&#39;re certainly not interested in harvesting it if it&#39;s not even signed out to us.</span>
<a name="l07109"></a>07109                         }
<a name="l07110"></a>07110                     } <span class="comment">// !bIsExpired</span>
<a name="l07111"></a>07111                 } <span class="comment">// sender is pNym</span>
<a name="l07112"></a>07112                 <span class="comment">// -----------------------------------------------------------</span>
<a name="l07113"></a>07113 
<a name="l07114"></a>07114 
<a name="l07115"></a>07115                 <span class="comment">// TODO: Add OPTIONAL field to OTPurse: &quot;Remitter&quot;.</span>
<a name="l07116"></a>07116                 <span class="comment">// This way the sender has the OPTION to attach his ID &quot;for the record&quot; even though</span>
<a name="l07117"></a>07117                 <span class="comment">// a cash transaction HAS NO &quot;SENDER.&quot;</span>
<a name="l07118"></a>07118                 <span class="comment">//</span>
<a name="l07119"></a>07119                 <span class="comment">// This would make it convenient for a purse to, for example, create a second copy</span>
<a name="l07120"></a>07120                 <span class="comment">// of the cash, encrypted to the remitter&#39;s public key. This is important, since the</span>
<a name="l07121"></a>07121                 <span class="comment">// if the remitter has the cash in his outpayment&#39;s box, he will want a way to recover</span>
<a name="l07122"></a>07122                 <span class="comment">// it if his friend returns and says, &quot;I lost that USB key! Do you still have that cash?!?&quot;</span>
<a name="l07123"></a>07123                 <span class="comment">//</span>
<a name="l07124"></a>07124                 <span class="comment">// In fact we may want to use the field for that purpose, WHETHER OR NOT the final sent</span>
<a name="l07125"></a>07125                 <span class="comment">// instrument actually includes the remitter&#39;s ID.</span>
<a name="l07126"></a>07126 
<a name="l07127"></a>07127                 <span class="comment">// -----------------------------------------------------------</span>
<a name="l07128"></a>07128                 <span class="comment">// If the SenderUserID on this instrument isn&#39;t Nym&#39;s ID (as in the case of vouchers),</span>
<a name="l07129"></a>07129                 <span class="comment">// or isn&#39;t even there (as in the case of cash) then why is it in Nym&#39;s payment outbox?</span>
<a name="l07130"></a>07130                 <span class="comment">// Well, maybe the recipient of your voucher, lost it. You still need to be able to</span>
<a name="l07131"></a>07131                 <span class="comment">// get another copy for him, or get it refunded (if you are listed as the remitter...)</span>
<a name="l07132"></a>07132                 <span class="comment">// Therefore you keep it in your outpayments box &quot;just in case.&quot; In the case of cash,</span>
<a name="l07133"></a>07133                 <span class="comment">// the same could be true.</span>
<a name="l07134"></a>07134                 <span class="comment">//</span>
<a name="l07135"></a>07135                 <span class="comment">// In a way it doesn&#39;t matter, since eventually those instruments will expire and then</span>
<a name="l07136"></a>07136                 <span class="comment">// they will be swept into the record box with everything else (probably by this function.)</span>
<a name="l07137"></a>07137                 <span class="comment">//</span>
<a name="l07138"></a>07138                 <span class="comment">// But what if the instruments never expire? Say a voucher with a very very int64_t expiration</span>
<a name="l07139"></a>07139                 <span class="comment">// date? It&#39;s still going to sit there, stuck in your outpayments box, even though the</span>
<a name="l07140"></a>07140                 <span class="comment">// recipient have have cashed it int64_t, int64_t ago! The only way to get rid of it is to have</span>
<a name="l07141"></a>07141                 <span class="comment">// the server send you a notice when it&#39;s cashed, which is only possible if your ID is</span>
<a name="l07142"></a>07142                 <span class="comment">// listed as the remitter. (Otherwise the server wouldn&#39;t know who to send the notice to.)</span>
<a name="l07143"></a>07143                 <span class="comment">//</span>
<a name="l07144"></a>07144                 <span class="comment">// Further, there&#39;s no PROVING whether the server sent you notice for anything -- whether</span>
<a name="l07145"></a>07145                 <span class="comment">// you are listed as the remitter or not, the server could choose to LIE and just NOT TELL</span>
<a name="l07146"></a>07146                 <span class="comment">// YOU that the voucher was cashed. How would you know the difference? Thus &quot;Notice&quot; is</span>
<a name="l07147"></a>07147                 <span class="comment">// an important problem, peripheral to OT. Balances are safe from any change without a</span>
<a name="l07148"></a>07148                 <span class="comment">// proper signed and authorized receipt--that is a powerful strength of OT--but notice</span>
<a name="l07149"></a>07149                 <span class="comment">// cannot be proven.</span>
<a name="l07150"></a>07150                 <span class="comment">//</span>
<a name="l07151"></a>07151                 <span class="comment">// If the remitter has no way to prove that the recipient actually deposited the cheque,</span>
<a name="l07152"></a>07152                 <span class="comment">// (even though most servers will of course provide this, they cannot PROVE that they</span>
<a name="l07153"></a>07153                 <span class="comment">// provided it) then what good is the instrument to the remitter? What good is such a</span>
<a name="l07154"></a>07154                 <span class="comment">// cashier&#39;s cheque? Well, the voucher is still in my outpayments, so I can see the transaction</span>
<a name="l07155"></a>07155                 <span class="comment">// number on it, and then I should be able to query the server and see which transaction</span>
<a name="l07156"></a>07156                 <span class="comment">// numbers are signed out to it. In which case a simple server message (available to all</span>
<a name="l07157"></a>07157                 <span class="comment">// users) will return the numbers signed out to the server and thus I can see whether or</span>
<a name="l07158"></a>07158                 <span class="comment">// not the number on the voucher is still valid. If it&#39;s not, the server reply to that</span>
<a name="l07159"></a>07159                 <span class="comment">// message would be the appropriate place to move the outpayment to the record box.</span>
<a name="l07160"></a>07160                 <span class="comment">//</span>
<a name="l07161"></a>07161                 <span class="comment">// What if we don&#39;t want to have these transaction numbers signed out to the server at all?</span>
<a name="l07162"></a>07162                 <span class="comment">// Maybe we use numbers signed out to the users instead. Then when the voucher is cashed,</span>
<a name="l07163"></a>07163                 <span class="comment">// instead of checking the server&#39;s list of issued transaction numbers to see if the voucher</span>
<a name="l07164"></a>07164                 <span class="comment">// is valid, we would be checking the remitter&#39;s list instead. And thus whenever the voucher</span>
<a name="l07165"></a>07165                 <span class="comment">// is cashed, we would have to drop a voucherReceipt in the REMITTER&#39;s inbox (and nymbox)</span>
<a name="l07166"></a>07166                 <span class="comment">// so he would know to discard the transaction number.</span>
<a name="l07167"></a>07167                 <span class="comment">//</span>
<a name="l07168"></a>07168                 <span class="comment">// This would require adding the voucherReceipt, and would restrict the use of vouchers to</span>
<a name="l07169"></a>07169                 <span class="comment">// those people who have an asset account (though that&#39;s currently the only people who can</span>
<a name="l07170"></a>07170                 <span class="comment">// use them now anyway, since vouchers are withdrawn from accounts) but it would eliminate</span>
<a name="l07171"></a>07171                 <span class="comment">// the need for the server nym to store all the transaction numbers for all the open vouchers,</span>
<a name="l07172"></a>07172                 <span class="comment">// and it would also eliminate the problem of &quot;no notice&quot; for the remitters of vouchers.</span>
<a name="l07173"></a>07173                 <span class="comment">// They&#39;d be guaranteed, in fact, to get notice, since the voucherReceipt is what removes</span>
<a name="l07174"></a>07174                 <span class="comment">// the transaction number from the user&#39;s list of signed-out transaction numbers (and thus</span>
<a name="l07175"></a>07175                 <span class="comment">// prevents anyone from spending the voucher twice, which the server wants to avoid at all</span>
<a name="l07176"></a>07176                 <span class="comment">// costs.) Thus if the server wants to avoid having a voucher spent twice, then it needs to</span>
<a name="l07177"></a>07177                 <span class="comment">// get that transaction number off of my list of numbers, and it can&#39;t do that without putting</span>
<a name="l07178"></a>07178                 <span class="comment">// a receipt in my inbox to justify the removal of the number. Otherwise my receipt verifications</span>
<a name="l07179"></a>07179                 <span class="comment">// will start failing and I&#39;ll be unable to do any new transactions, and then the server will</span>
<a name="l07180"></a>07180                 <span class="comment">// have to explain why it removed a transaction number from my list, even though it still was</span>
<a name="l07181"></a>07181                 <span class="comment">// on my list during the last transaction statement, and even though there&#39;s no new receipt in</span>
<a name="l07182"></a>07182                 <span class="comment">// my inbox to justify removing it.</span>
<a name="l07183"></a>07183                 <span class="comment">//</span>
<a name="l07184"></a>07184                 <span class="comment">// Conclusion, DONE: vouchers WITH a remitter acct, should store the remitter&#39;s user AND acct IDs,</span>
<a name="l07185"></a>07185                 <span class="comment">// and should use a transaction # that&#39;s signed out to the remitter (instead of the server) and</span>
<a name="l07186"></a>07186                 <span class="comment">// should drop a voucherReceipt in the remitter&#39;s asset account inbox when they are cashed.</span>
<a name="l07187"></a>07187                 <span class="comment">// These vouchers are guaranteed to provide notice to the remitter.</span>
<a name="l07188"></a>07188                 <span class="comment">//</span>
<a name="l07189"></a>07189                 <span class="comment">// Whereas vouchers WITHOUT a remitter acct should store the remitter&#39;s user ID (or not), but should</span>
<a name="l07190"></a>07190                 <span class="comment">// NOT store the remitter&#39;s acct ID, and should use a transaction # that&#39;s signed out to the server,</span>
<a name="l07191"></a>07191                 <span class="comment">// and should drop a notice in the Nymbox of the remitter IF his user ID is available, but it should</span>
<a name="l07192"></a>07192                 <span class="comment">// be understood that such notice is a favor the server is doing, and not something that&#39;s PROVABLE</span>
<a name="l07193"></a>07193                 <span class="comment">// as in the case of the vouchers in the above paragraph.</span>
<a name="l07194"></a>07194                 <span class="comment">//</span>
<a name="l07195"></a>07195                 <span class="comment">// This is similar to smart contracts, which can only be activated by a party who has an</span>
<a name="l07196"></a>07196                 <span class="comment">// asset account, so he has somewhere to receive the finalReceipt for that contract. (And thus</span>
<a name="l07197"></a>07197                 <span class="comment">// close out the transcation number he used to open it...)</span>
<a name="l07198"></a>07198                 <span class="comment">//</span>
<a name="l07199"></a>07199                 <span class="comment">// Perhaps we&#39;ll just offer both types of vouchers, and just let users choose which they are willing</span>
<a name="l07200"></a>07200                 <span class="comment">// to pay for, and which trade-off is most palatable to them (having to have an asset account to</span>
<a name="l07201"></a>07201                 <span class="comment">// get notice, or instead verifying the voucher&#39;s spent status based on some publicly-available</span>
<a name="l07202"></a>07202                 <span class="comment">// listing of the transaction #&#39;s currently signed out to the server.)</span>
<a name="l07203"></a>07203                 <span class="comment">//</span>
<a name="l07204"></a>07204                 <span class="comment">// In the case of having transaction #&#39;s signed out to the server, perhaps the server&#39;s internal storage</span>
<a name="l07205"></a>07205                 <span class="comment">// of these should be paired each with the NymID of the owner nym for that number, just so no one</span>
<a name="l07206"></a>07206                 <span class="comment">// would ever have any incentive to try and use one of those numbers on some instrument somehow, and</span>
<a name="l07207"></a>07207                 <span class="comment">// also so that the server wouldn&#39;t necessarily have to post the entire list of numbers, but just</span>
<a name="l07208"></a>07208                 <span class="comment">// rather give you the ones that are relevant to you (although the entire list may have to be posted</span>
<a name="l07209"></a>07209                 <span class="comment">// in some public way in any case, for notice reasons.)</span>
<a name="l07210"></a>07210                 <span class="comment">//</span>
<a name="l07211"></a>07211                 <span class="comment">// By this point, you may be wondering, but what does all this have to do with the function</span>
<a name="l07212"></a>07212                 <span class="comment">// we&#39;re in now? Well... in the below block, with a voucher, pNym would NOT be the sender.</span>
<a name="l07213"></a>07213                 <span class="comment">// The voucher would still be drawn off a server account. But nevertheless, pNym might still be</span>
<a name="l07214"></a>07214                 <span class="comment">// the owner of the transaction # for that voucher (assuming I change OT around to use the above</span>
<a name="l07215"></a>07215                 <span class="comment">// system, which I will have to do if I want provable notice for vouchers.) And if pNym is the</span>
<a name="l07216"></a>07216                 <span class="comment">// owner of that number, then he will want the option later of refunding it or re-issuing it,</span>
<a name="l07217"></a>07217                 <span class="comment">// and he will have to possibly load up his inbox to make sure there&#39;s no voucherReceipt in it,</span>
<a name="l07218"></a>07218                 <span class="comment">// etc. So for now, the vouchers will be handled by the below code, but in the future, they might</span>
<a name="l07219"></a>07219                 <span class="comment">// be moved to the above code.</span>
<a name="l07220"></a>07220                 <span class="comment">//</span>
<a name="l07221"></a>07221                 <span class="comment">//</span>
<a name="l07222"></a>07222                 <span class="keywordflow">else</span> <span class="comment">// pNym is not the sender.</span>
<a name="l07223"></a>07223                 {
<a name="l07224"></a>07224                     <span class="comment">// pNym isn&#39;t even the &quot;sender&quot; (although he is) but since it&#39;s cash or voucher,</span>
<a name="l07225"></a>07225                     <span class="comment">// he&#39;s not waiting on any transaction number to close out or be harvested.</span>
<a name="l07226"></a>07226                     <span class="comment">// (In the case of cash, in fact, we might as well just put it straight in the records</span>
<a name="l07227"></a>07227                     <span class="comment">// and bypass the outpayments box entirely.) But this function can sweep it into there</span>
<a name="l07228"></a>07228                     <span class="comment">// all in due time anyway, once it expires, so it seems harmless to leave it there before</span>
<a name="l07229"></a>07229                     <span class="comment">// then. Plus, that way we always know which tokens are still potentially exchangeable,</span>
<a name="l07230"></a>07230                     <span class="comment">// for cases where the recipient never cashed them.</span>
<a name="l07231"></a>07231                     <span class="comment">//</span>
<a name="l07232"></a>07232                     <span class="keywordflow">if</span> (bIsExpired)
<a name="l07233"></a>07233                     {
<a name="l07234"></a>07234                         <span class="comment">// pNym is NOT the sender AND the payment instrument IS expired.</span>
<a name="l07235"></a>07235                         <span class="comment">// Therefore, say in the case of sent vouchers and sent cash, there</span>
<a name="l07236"></a>07236                         <span class="comment">// may have been some legitimate reason for keeping them in outpayments</span>
<a name="l07237"></a>07237                         <span class="comment">// up until this point, but now that the instrument is expired, might as</span>
<a name="l07238"></a>07238                         <span class="comment">// well get it out of the outpayments box and move it to the record box.</span>
<a name="l07239"></a>07239                         <span class="comment">// Let the client software do its own historical archiving.</span>
<a name="l07240"></a>07240                         <span class="comment">//</span>
<a name="l07241"></a>07241                         bShouldHarvestPayment     = <span class="keyword">false</span>; <span class="comment">// The # isn&#39;t signed out to pNym, so we don&#39;t want to harvest it (which would cause the wallet to try and use it even though it&#39;s signed out to someone else -- bad.)</span>
<a name="l07242"></a>07242                         bNeedToLoadAssetAcctInbox = <span class="keyword">false</span>; <span class="comment">// No need to check the inbox since the # isn&#39;t even signed out to pNym and we&#39;re certainly not interested in harvesting it if it&#39;s not even signed out to us. (Thus no reason to check the inbox.)</span>
<a name="l07243"></a>07243                     }
<a name="l07244"></a>07244                     <span class="keywordflow">else</span> <span class="comment">// pNym is NOT the sender and the payment instrument is NOT expired.</span>
<a name="l07245"></a>07245                     {
<a name="l07246"></a>07246                         <span class="comment">// For example, for a sent voucher that has not expired yet.</span>
<a name="l07247"></a>07247                         <span class="comment">// Those we&#39;ll keep here for now, until some server notice is</span>
<a name="l07248"></a>07248                         <span class="comment">// received, or the instrument expires. What if we need to re-issue</span>
<a name="l07249"></a>07249                         <span class="comment">// the cheque to the recipient who lost it? Or what if we want to</span>
<a name="l07250"></a>07250                         <span class="comment">// cancel it before he tries to cash it? Since it&#39;s not expired yet,</span>
<a name="l07251"></a>07251                         <span class="comment">// it&#39;s wise to keep a copy in the outpayments box for now.</span>
<a name="l07252"></a>07252                         <span class="comment">//</span>
<a name="l07253"></a>07253                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: This outpayment isn&#39;t expired yet. (Skipping moving it to record box -- it &quot;</span>
<a name="l07254"></a>07254                                        <span class="stringliteral">&quot;will be moved automatically once it expires--and maybe sooner, if I code voucherReceipts. &quot;</span>
<a name="l07255"></a>07255                                        <span class="stringliteral">&quot;See giant comment just above this log.)\n&quot;</span>, __FUNCTION__, lPaymentTransNum);
<a name="l07256"></a>07256                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07257"></a>07257                     }
<a name="l07258"></a>07258                 }
<a name="l07259"></a>07259                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07260"></a>07260                 <span class="comment">//</span>
<a name="l07261"></a>07261                 <span class="keywordtype">bool</span>              bFoundReceiptInInbox  = <span class="keyword">false</span>;
<a name="l07262"></a>07262                 <span class="keywordtype">bool</span>              bIsSmartContract      = <span class="keyword">false</span>;
<a name="l07263"></a>07263                 <a class="code" href="class_o_t_trackable.html">OTTrackable</a>     * pTrackable            = NULL;
<a name="l07264"></a>07264                 <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> * pSmartContract        = NULL;
<a name="l07265"></a>07265                 <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   * pPlan                 = NULL;
<a name="l07266"></a>07266                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTrackable&gt;</a> theTrackableAngel;
<a name="l07267"></a>07267                 <span class="comment">//</span>
<a name="l07268"></a>07268                 <span class="comment">// In certain cases (logic above) it is determined that we have to load the</span>
<a name="l07269"></a>07269                 <span class="comment">// asset account inbox and make sure there aren&#39;t any chequeReceipts there,</span>
<a name="l07270"></a>07270                 <span class="comment">// before we go ahead and harvest any transaction numbers.</span>
<a name="l07271"></a>07271                 <span class="comment">//</span>
<a name="l07272"></a>07272                 <span class="keywordflow">if</span> (bNeedToLoadAssetAcctInbox &amp;&amp; (bFromAcctIsAvailable || bIsRecurring))
<a name="l07273"></a>07273                 {
<a name="l07274"></a>07274                     <span class="keywordflow">if</span> (bIsRecurring)
<a name="l07275"></a>07275                     {
<a name="l07276"></a>07276                         pTrackable = thePayment.<a class="code" href="class_o_t_payment.html#a3425627e011f9430eb9396f741f41a98">Instantiate</a>();
<a name="l07277"></a>07277                         <span class="keywordflow">if</span> ( NULL  == pTrackable )
<a name="l07278"></a>07278                         {
<a name="l07279"></a>07279                             <a class="code" href="class_o_t_string.html">OTString</a> strPaymentContents;
<a name="l07280"></a>07280                             thePayment.<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strPaymentContents);
<a name="l07281"></a>07281                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed instantiating OTPayment containing:\n%s\n&quot;</span>,
<a name="l07282"></a>07282                                           __FUNCTION__, strPaymentContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07283"></a>07283                             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07284"></a>07284                         } <span class="comment">// BELOW THIS POINT, MUST DELETE pTrackable!</span>
<a name="l07285"></a>07285                         theTrackableAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pTrackable); <span class="comment">// (This automates the DELETION.)</span>
<a name="l07286"></a>07286                         <span class="comment">// ----------------------------</span>
<a name="l07287"></a>07287                         pSmartContract = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> *<span class="keyword">&gt;</span>(pTrackable);
<a name="l07288"></a>07288                         pPlan          = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a> *<span class="keyword">&gt;</span>  (pTrackable);
<a name="l07289"></a>07289                         <span class="comment">// ----------------------------</span>
<a name="l07290"></a>07290                         <span class="keywordflow">if</span> (NULL != pSmartContract)
<a name="l07291"></a>07291                         {
<a name="l07292"></a>07292                             bIsSmartContract = <span class="keyword">true</span>; <span class="comment">// In this case we have to loop through all the accounts on the smart contract...</span>
<a name="l07293"></a>07293                         }
<a name="l07294"></a>07294                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pPlan)
<a name="l07295"></a>07295                         {
<a name="l07296"></a>07296                             <span class="comment">// Payment plan is a funny case.</span>
<a name="l07297"></a>07297                             <span class="comment">// The merchant (RECIPIENT aka payee) creates the payment plan, and then he SENDS</span>
<a name="l07298"></a>07298                             <span class="comment">// it to the customer (SENDER aka payer). From there, the customer ACTIVATES it on</span>
<a name="l07299"></a>07299                             <span class="comment">// the server. BOTH could potentially have it in their outpayments box. In one case.</span>
<a name="l07300"></a>07300                             <span class="comment">// the Nym is the &quot;sender&quot; and in another case, he&#39;s the &quot;recipient.&quot;</span>
<a name="l07301"></a>07301                             <span class="comment">// (So we need to figure out which, and set the account accordingly.)</span>
<a name="l07302"></a>07302                             <span class="comment">//</span>
<a name="l07303"></a>07303                             <span class="keywordflow">if</span> (USER_ID == pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>())
<a name="l07304"></a>07304                                 theSenderAcctID = pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a66300d99a12d32b6825e7e11dfca8614">GetRecipientAcctID</a>();
<a name="l07305"></a>07305                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (USER_ID == pPlan-&gt;<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>())
<a name="l07306"></a>07306                                 theSenderAcctID = pPlan-&gt;<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>();
<a name="l07307"></a>07307                             <span class="keywordflow">else</span>
<a name="l07308"></a>07308                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: ERROR: Should never happen: USER_ID didn&#39;t match this payment plan for sender OR recipient. &quot;</span>
<a name="l07309"></a>07309                                               <span class="stringliteral">&quot;(Expected one or the other.)\n&quot;</span>, __FUNCTION__);
<a name="l07310"></a>07310                         }
<a name="l07311"></a>07311                     }
<a name="l07312"></a>07312                     <span class="comment">// ----------------------------------------</span>
<a name="l07313"></a>07313                     <span class="keywordflow">if</span> (bIsSmartContract) <span class="comment">// In this case we have to loop through all the accounts on the smart contract... We have to</span>
<a name="l07314"></a>07314                     {                     <span class="comment">// check the inbox on each, to make sure there aren&#39;t any related paymentReceipts or final receipts.</span>
<a name="l07315"></a>07315                         <span class="keyword">const</span> int32_t nPartyCount = pSmartContract-&gt;<a class="code" href="class_o_t_scriptable.html#a862b70e3515a874a4fed101ad4af1a50">GetPartyCount</a>();
<a name="l07316"></a>07316 
<a name="l07317"></a>07317                         <span class="keywordflow">for</span> (int32_t nCurrentParty = 0; nCurrentParty &lt; nPartyCount; ++nCurrentParty)
<a name="l07318"></a>07318                         {
<a name="l07319"></a>07319                             <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = pSmartContract-&gt;<a class="code" href="class_o_t_scriptable.html#a4be857ffbe603f75f1dc5550ed4c20e9">GetPartyByIndex</a>(nCurrentParty);
<a name="l07320"></a>07320                             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l07321"></a>07321                             <span class="keywordflow">if</span> (NULL != pParty)
<a name="l07322"></a>07322                             {
<a name="l07323"></a>07323                                 <span class="keyword">const</span> int32_t nAcctCount = pParty-&gt;<a class="code" href="class_o_t_party.html#a0b130989d275386c980ed34d587e5e87">GetAccountCount</a>();
<a name="l07324"></a>07324 
<a name="l07325"></a>07325                                 <span class="keywordflow">for</span> (int32_t nCurrentAcct = 0; nCurrentAcct &lt; nAcctCount; ++nCurrentAcct)
<a name="l07326"></a>07326                                 {
<a name="l07327"></a>07327                                     <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pPartyAcct = pParty-&gt;<a class="code" href="class_o_t_party.html#ad085e6ba37a006e0f8cf7e100a9b59eb">GetAccountByIndex</a>(nCurrentAcct);
<a name="l07328"></a>07328                                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPartyAcct);
<a name="l07329"></a>07329                                     <span class="keywordflow">if</span> (NULL != pPartyAcct)
<a name="l07330"></a>07330                                     {
<a name="l07331"></a>07331                                         <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent = pPartyAcct-&gt;<a class="code" href="class_o_t_party_account.html#ad8c523b08a478e4071bb2b3ca85749b1">GetAuthorizedAgent</a>();
<a name="l07332"></a>07332 
<a name="l07333"></a>07333                                         <span class="comment">// If pNym is a signer for pPartyAcct, then we need to check pPartyAcct&#39;s inbox</span>
<a name="l07334"></a>07334                                         <span class="comment">// to make sure there aren&#39;t any paymentReceipts or finalReceipts lingering in there...</span>
<a name="l07335"></a>07335                                         <span class="comment">//</span>
<a name="l07336"></a>07336                                         <span class="keywordflow">if</span> (pAgent-&gt;<a class="code" href="class_o_t_agent.html#a2039e8ad981abeecabf0a3aa412a3a9f">IsValidSigner</a>(*pNym))
<a name="l07337"></a>07337                                         {
<a name="l07338"></a>07338                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; strAcctID = pPartyAcct-&gt;<a class="code" href="class_o_t_party_account.html#aa5e4e0cc77853d08b3708017fe694876">GetAcctID</a>();
<a name="l07339"></a>07339                                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   theAcctID(strAcctID);
<a name="l07340"></a>07340 
<a name="l07341"></a>07341                                             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theSenderInbox(USER_ID, theAcctID, SERVER_ID);
<a name="l07342"></a>07342 
<a name="l07343"></a>07343                                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessLoadingSenderInbox = (theSenderInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>() &amp;&amp; theSenderInbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym));
<a name="l07344"></a>07344                                             <span class="comment">// --------------------------------------------------------------------</span>
<a name="l07345"></a>07345                                             <span class="keywordflow">if</span> (bSuccessLoadingSenderInbox)
<a name="l07346"></a>07346                                             {
<a name="l07347"></a>07347                                                 <span class="comment">// Loop through the inbox and see if there are any receipts for lPaymentTransNum inside.</span>
<a name="l07348"></a>07348                                                 <span class="comment">//</span>
<a name="l07349"></a>07349                                                 <span class="keywordflow">if</span> (theSenderInbox.<a class="code" href="class_o_t_ledger.html#a4107700057144e2cc8719bbf1771e614">GetPaymentReceipt</a>(lPaymentTransNum) || theSenderInbox.<a class="code" href="class_o_t_ledger.html#ab4a37c7036b68bf5e4496848bddb1953">GetFinalReceipt</a>(lPaymentTransNum))
<a name="l07350"></a>07350                                                 {
<a name="l07351"></a>07351                                                     bFoundReceiptInInbox = <span class="keyword">true</span>;
<a name="l07352"></a>07352                                                     <span class="keywordflow">break</span>;
<a name="l07353"></a>07353                                                 }
<a name="l07354"></a>07354                                                 <span class="comment">// else we didn&#39;t find a receipt in the asset account inbox, which means we are safe to harvest.</span>
<a name="l07355"></a>07355                                             }
<a name="l07356"></a>07356                                             <span class="comment">//else unable to load inbox. Maybe it&#39;s empty, never been used before. i.e. it doesn&#39;t even exist.</span>
<a name="l07357"></a>07357                                         } <span class="comment">// pNym is valid signer for agent</span>
<a name="l07358"></a>07358                                     } <span class="comment">// NULL != pPartyAccount</span>
<a name="l07359"></a>07359                                 } <span class="comment">// loop party accounts.</span>
<a name="l07360"></a>07360 
<a name="l07361"></a>07361                                 <span class="keywordflow">if</span> (bFoundReceiptInInbox)
<a name="l07362"></a>07362                                     <span class="keywordflow">break</span>;
<a name="l07363"></a>07363                             }
<a name="l07364"></a>07364                         } <span class="comment">// loop parties</span>
<a name="l07365"></a>07365                     } <span class="comment">// smart contract</span>
<a name="l07366"></a>07366                     <span class="keywordflow">else</span> <span class="comment">// not a smart contract. (It&#39;s a payment plan or a cheque, most likely.)</span>
<a name="l07367"></a>07367                     {
<a name="l07368"></a>07368                         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theSenderInbox(USER_ID, theSenderAcctID, SERVER_ID);
<a name="l07369"></a>07369 
<a name="l07370"></a>07370                         <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccessLoadingSenderInbox = (theSenderInbox.<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>() &amp;&amp; theSenderInbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(*pNym));
<a name="l07371"></a>07371                         <span class="comment">// --------------------------------------------------------------------</span>
<a name="l07372"></a>07372                         <span class="keywordflow">if</span> (bSuccessLoadingSenderInbox)
<a name="l07373"></a>07373                         {
<a name="l07374"></a>07374                             <span class="comment">// Loop through the inbox and see if there are any receipts for lPaymentTransNum inside.</span>
<a name="l07375"></a>07375                             <span class="comment">// Technically this would have to be a chequeReceipt, or possibly a voucherReceipt if I add</span>
<a name="l07376"></a>07376                             <span class="comment">// that (see giant comment above.)</span>
<a name="l07377"></a>07377                             <span class="comment">//</span>
<a name="l07378"></a>07378                             <span class="comment">// There are other instrument types but only a cheque, at this point, would be in my outpayments</span>
<a name="l07379"></a>07379                             <span class="comment">// box AND could have a receipt in my asset account inbox. So let&#39;s see if there&#39;s a chequeReceipt</span>
<a name="l07380"></a>07380                             <span class="comment">// in there that corresponds to lPaymentTransNum...</span>
<a name="l07381"></a>07381                             <span class="comment">//</span>
<a name="l07382"></a>07382                             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pChequeReceipt = theSenderInbox.<a class="code" href="class_o_t_ledger.html#ac364836ff42d8a8d873050b86a72c7d9">GetChequeReceipt</a>(lPaymentTransNum); <span class="comment">// cheque</span>
<a name="l07383"></a>07383 
<a name="l07384"></a>07384                             <span class="keywordflow">if</span> (NULL != pChequeReceipt)
<a name="l07385"></a>07385                             {
<a name="l07386"></a>07386                                 bFoundReceiptInInbox = <span class="keyword">true</span>;
<a name="l07387"></a>07387                             }
<a name="l07388"></a>07388                             <span class="comment">// No cheque receipt? Ok let&#39;s see if there&#39;s a paymentReceipt or finalReceipt (for a payment plan...)</span>
<a name="l07389"></a>07389                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theSenderInbox.<a class="code" href="class_o_t_ledger.html#a4107700057144e2cc8719bbf1771e614">GetPaymentReceipt</a>(lPaymentTransNum) ||
<a name="l07390"></a>07390                                      theSenderInbox.<a class="code" href="class_o_t_ledger.html#ab4a37c7036b68bf5e4496848bddb1953">GetFinalReceipt</a>  (lPaymentTransNum)) <span class="comment">// payment plan.</span>
<a name="l07391"></a>07391                             {
<a name="l07392"></a>07392                                 bFoundReceiptInInbox = <span class="keyword">true</span>;
<a name="l07393"></a>07393                             }
<a name="l07394"></a>07394                             <span class="comment">// else we didn&#39;t find a receipt in the asset account inbox, which means we are safe to harvest.</span>
<a name="l07395"></a>07395                         }
<a name="l07396"></a>07396                         <span class="comment">//else unable to load inbox. Maybe it&#39;s empty, never been used before. i.e. it doesn&#39;t even exist.</span>
<a name="l07397"></a>07397                     } <span class="comment">// not a smart contract</span>
<a name="l07398"></a>07398                 } <span class="comment">// if (bNeedToLoadAssetAcctInbox &amp;&amp; (bFromAcctIsAvailable || bIsRecurring))</span>
<a name="l07399"></a>07399                 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07400"></a>07400                 <span class="comment">// If we should harvest the transaction numbers,</span>
<a name="l07401"></a>07401                 <span class="comment">// AND if we don&#39;t need to double-check that against the asset inbox to make sure the receipt&#39;s not there,</span>
<a name="l07402"></a>07402                 <span class="comment">// (or if we do, that it was a successful double-check and the receipt indeed is not there.)</span>
<a name="l07403"></a>07403                 <span class="comment">//</span>
<a name="l07404"></a>07404                 <span class="keywordflow">if</span> (  bShouldHarvestPayment &amp;&amp;
<a name="l07405"></a>07405                     ((!bNeedToLoadAssetAcctInbox) || (bNeedToLoadAssetAcctInbox &amp;&amp; !bFoundReceiptInInbox)))
<a name="l07406"></a>07406                 {
<a name="l07407"></a>07407                     <span class="comment">// Harvest the transaction number(s).</span>
<a name="l07408"></a>07408                     <span class="comment">//</span>
<a name="l07409"></a>07409                     <span class="keywordflow">if</span> (NULL != pSmartContract)
<a name="l07410"></a>07410                     {
<a name="l07411"></a>07411                         pSmartContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a6eaf2a458eb665dae9e25f026db27f8f">HarvestOpeningNumber</a> (*pNym);
<a name="l07412"></a>07412                         pSmartContract-&gt;<a class="code" href="class_o_t_smart_contract.html#a40befd7381c6c5e68e7d1042c9a7f2d3">HarvestClosingNumbers</a>(*pNym);
<a name="l07413"></a>07413                     }
<a name="l07414"></a>07414                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL != pPlan)
<a name="l07415"></a>07415                     {
<a name="l07416"></a>07416                         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a181efb58949ade53e690f4ebb0f4cfab">HarvestOpeningNumber</a> (*pNym);
<a name="l07417"></a>07417                         pPlan-&gt;<a class="code" href="class_o_t_agreement.html#a098b7e9e0bd808bd1e40863d5404f243">HarvestClosingNumbers</a>(*pNym);
<a name="l07418"></a>07418                     }
<a name="l07419"></a>07419                     <span class="keywordflow">else</span>
<a name="l07420"></a>07420                     {
<a name="l07421"></a>07421                         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a29c787987f96abc9de8f3b268596a79e">ClawbackTransactionNumber</a>(SERVER_ID, lPaymentTransNum, <span class="keyword">false</span>); <span class="comment">//bSave=false</span>
<a name="l07422"></a>07422                     }
<a name="l07423"></a>07423 
<a name="l07424"></a>07424                     bNeedToSaveTheNym = <span class="keyword">true</span>;
<a name="l07425"></a>07425 
<a name="l07426"></a>07426                     <span class="comment">// Note, food for thought: IF the receipt had popped into your asset inbox on the server</span>
<a name="l07427"></a>07427                     <span class="comment">// side, since the last time you downloaded your inbox, then you could be making the wrong</span>
<a name="l07428"></a>07428                     <span class="comment">// decision here, and harvesting a number that&#39;s already spent. (You just didn&#39;t know it yet.)</span>
<a name="l07429"></a>07429                     <span class="comment">//</span>
<a name="l07430"></a>07430                     <span class="comment">// What happens in that case, when I download the inbox again? A new receipt is there, and a</span>
<a name="l07431"></a>07431                     <span class="comment">// transaction # is used, which I thought was still available for use? (Since I harvested it?)</span>
<a name="l07432"></a>07432                     <span class="comment">// The appearance of the receipt in the inbox, as long as properly formed and signed by me,</span>
<a name="l07433"></a>07433                     <span class="comment">// should be enough information for the client side to adjust its records, because if it</span>
<a name="l07434"></a>07434                     <span class="comment">// doesn&#39;t anticipate this possibility, then it will be forced to resync entirely, which I want</span>
<a name="l07435"></a>07435                     <span class="comment">// to avoid in all cases period.</span>
<a name="l07436"></a>07436                     <span class="comment">//</span>
<a name="l07437"></a>07437                     <span class="comment">// In this block, we clawed back the number because if there&#39;s no chequeReceipt in the inbox,</span>
<a name="l07438"></a>07438                     <span class="comment">// then that means the cheque has never been used, since if I had closed the chequeReceipt out</span>
<a name="l07439"></a>07439                     <span class="comment">// already, then the transaction number on that cheque would already have been closed out at</span>
<a name="l07440"></a>07440                     <span class="comment">// that time.</span>
<a name="l07441"></a>07441                     <span class="comment">// We only clawback for expired instruments, where the transaction # is still outstanding</span>
<a name="l07442"></a>07442                     <span class="comment">// and where no receipt is present in the asset acct inbox. If the instrument is not expired,</span>
<a name="l07443"></a>07443                     <span class="comment">// then you must cancel it properly. And if the cheque receipt is in the inbox, then you must</span>
<a name="l07444"></a>07444                     <span class="comment">// close it properly.</span>
<a name="l07445"></a>07445                 }
<a name="l07446"></a>07446             } <span class="comment">// if (thePayment.GetTransactionNum(lPaymentTransNum))</span>
<a name="l07447"></a>07447             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07448"></a>07448             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bSaveCopy &amp;&amp; (NULL != pActualBox) &amp;&amp; thePayment.<a class="code" href="class_o_t_payment.html#aec4f77470b159c3afd1cc4e3dffe464d">IsPurse</a>())
<a name="l07449"></a>07449             {
<a name="l07450"></a>07450                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pActualBox);
<a name="l07451"></a>07451 
<a name="l07452"></a>07452                 <span class="comment">// A purse has no transaction number on itself, and if it&#39;s in the outpayment box,</span>
<a name="l07453"></a>07453                 <span class="comment">// it has no transaction number from its ledger, either! It&#39;s numberless. So what</span>
<a name="l07454"></a>07454                 <span class="comment">// we do for now is, we use the expiration timestamp for the purse to create its</span>
<a name="l07455"></a>07455                 <span class="comment">// &quot;transaction number&quot; (we also add a billion to it, and then increment it until</span>
<a name="l07456"></a>07456                 <span class="comment">// we are sure it&#39;s unused in the box already) for the new receipt we&#39;re inserting</span>
<a name="l07457"></a>07457                 <span class="comment">// for this purse into the record box. (Otherwise we&#39;d have to skip this part and</span>
<a name="l07458"></a>07458                 <span class="comment">// we wouldn&#39;t save a record of the purse at all.)</span>
<a name="l07459"></a>07459                 <span class="comment">//</span>
<a name="l07460"></a>07460                 <span class="comment">// ALSO NOTE that people shouldn&#39;t really be discarding the purse anyway from the outpayment</span>
<a name="l07461"></a>07461                 <span class="comment">// box, since it will ALREADY disappear once it expires. (Presumably you&#39;d want the option to</span>
<a name="l07462"></a>07462                 <span class="comment">// recover it, at any time prior to that point...) But we still must consider that people sent</span>
<a name="l07463"></a>07463                 <span class="comment">// cash and they just want it erased, so...</span>
<a name="l07464"></a>07464                 <span class="comment">//</span>
<a name="l07465"></a>07465                 <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> tValidTo = <a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a>;
<a name="l07466"></a>07466 
<a name="l07467"></a>07467                 <span class="keywordflow">if</span> (thePayment.<a class="code" href="class_o_t_payment.html#a11dbba988d5da835179885043b4c3979">GetValidTo</a>(tValidTo))
<a name="l07468"></a>07468                 {
<a name="l07469"></a>07469                     lPaymentTransNum = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(tValidTo) + 1000000000; <span class="comment">// todo hardcoded. (But should be harmless since this is record box.)</span>
<a name="l07470"></a>07470 
<a name="l07471"></a>07471                     <span class="comment">// Since we&#39;re using a made-up transaction number here, let&#39;s</span>
<a name="l07472"></a>07472                     <span class="comment">// make sure it&#39;s not already being used. If it is, we&#39;ll</span>
<a name="l07473"></a>07473                     <span class="comment">// increment it until nothing is found.</span>
<a name="l07474"></a>07474                     <span class="comment">//</span>
<a name="l07475"></a>07475                     <span class="keywordflow">while</span> (NULL != pActualBox-&gt;<a class="code" href="class_o_t_ledger.html#a89dedbb3be7bd6869ad5e345fd14fb20">GetTransaction</a>(lPaymentTransNum))
<a name="l07476"></a>07476                         ++lPaymentTransNum;
<a name="l07477"></a>07477                 }
<a name="l07478"></a>07478                 <span class="keywordflow">else</span>
<a name="l07479"></a>07479                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to get &#39;valid to&#39; from purse.\n&quot;</span>, __FUNCTION__);
<a name="l07480"></a>07480             }
<a name="l07481"></a>07481             <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07482"></a>07482             <span class="comment">// Create the notice to put in the Record Box.</span>
<a name="l07483"></a>07483             <span class="comment">//</span>
<a name="l07484"></a>07484             <span class="keywordflow">if</span> (bSaveCopy &amp;&amp; (NULL != pActualBox) &amp;&amp; (lPaymentTransNum &gt; 0))
<a name="l07485"></a>07485             {
<a name="l07486"></a>07486                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pActualBox);
<a name="l07487"></a>07487 
<a name="l07488"></a>07488                 <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pNewTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pActualBox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a34ed13120f604fbf41954473bfd896da">OTTransaction::notice</a>, lPaymentTransNum);
<a name="l07489"></a>07489 
<a name="l07490"></a>07490                 <span class="keywordflow">if</span> (NULL != pNewTransaction) <span class="comment">// The above has an OT_ASSERT within, but I just like to check my pointers.</span>
<a name="l07491"></a>07491                 {
<a name="l07492"></a>07492                     pNewTransaction-&gt;   SetReferenceToNum(lPaymentTransNum); <span class="comment">// referencing myself here. We&#39;ll see how it works out.</span>
<a name="l07493"></a>07493                     pNewTransaction-&gt;   SetReferenceString(strInstrument); <span class="comment">// the cheque, invoice, etc that used to be in the outpayments box.</span>
<a name="l07494"></a>07494 
<a name="l07495"></a>07495                     pNewTransaction-&gt;   <a class="code" href="class_o_t___a_p_i.html#aa354b7ac168afd7cacfcf045241f4771">SignContract</a>(*pNym);
<a name="l07496"></a>07496                     pNewTransaction-&gt;   SaveContract();
<a name="l07497"></a>07497                     <span class="comment">// -----------------------------------------</span>
<a name="l07498"></a>07498                     pTransaction = pNewTransaction;
<a name="l07499"></a>07499 
<a name="l07500"></a>07500                     theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pTransaction);
<a name="l07501"></a>07501                 }
<a name="l07502"></a>07502                 <span class="keywordflow">else</span> <span class="comment">// should never happen</span>
<a name="l07503"></a>07503                 {
<a name="l07504"></a>07504                     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strUserID(USER_ID);
<a name="l07505"></a>07505                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed while trying to generate transaction in order to &quot;</span>
<a name="l07506"></a>07506                                   <span class="stringliteral">&quot;add a new transaction (for a payment instrument from the outpayments box) &quot;</span>
<a name="l07507"></a>07507                                   <span class="stringliteral">&quot;to Record Box: %s\n&quot;</span>, __FUNCTION__, strUserID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07508"></a>07508                 }
<a name="l07509"></a>07509             }
<a name="l07510"></a>07510         } <span class="comment">//if (thePayment.IsValid() &amp;&amp; thePayment.SetTempValues())</span>
<a name="l07511"></a>07511         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l07512"></a>07512         <span class="comment">//</span>
<a name="l07513"></a>07513         <span class="comment">// Now we actually remove the message from the outpayments...</span>
<a name="l07514"></a>07514         <span class="comment">//</span>
<a name="l07515"></a>07515         bRemoved = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(nIndex, <span class="keyword">false</span>); <span class="comment">// bDeleteIt=true by default</span>
<a name="l07516"></a>07516         theMessageAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(pMessage); <span class="comment">// Since we chose to keep pMessage alive after removing it from the outpayments, we set the angel here to make sure it gets cleaned up later whenever we return out of this godforsaken function.</span>
<a name="l07517"></a>07517 
<a name="l07518"></a>07518         <span class="comment">// Anything else?</span>
<a name="l07519"></a>07519     } <span class="comment">// outpayments box.</span>
<a name="l07520"></a>07520     <span class="comment">// ***********************************************************</span>
<a name="l07521"></a>07521     <span class="comment">//</span>
<a name="l07522"></a>07522     <span class="comment">// Okay by this point, whether the payment was in the payments inbox, or</span>
<a name="l07523"></a>07523     <span class="comment">// whether it was in the outpayments box, either way, it has now been removed</span>
<a name="l07524"></a>07524     <span class="comment">// from that box. (Otherwise we would have returned already by this point.)</span>
<a name="l07525"></a>07525     <span class="comment">//</span>
<a name="l07526"></a>07526     <span class="comment">// It&#39;s still safer to explicitly check bRemoved, just in case.</span>
<a name="l07527"></a>07527     <span class="comment">//</span>
<a name="l07528"></a>07528     <span class="keywordflow">if</span> (bRemoved)
<a name="l07529"></a>07529     {
<a name="l07530"></a>07530         <span class="comment">// -----------------------------------------------------</span>
<a name="l07531"></a>07531         <span class="keywordflow">if</span> (bSaveCopy &amp;&amp; (NULL != pActualBox) &amp;&amp; (NULL != pTransaction))
<a name="l07532"></a>07532         {
<a name="l07533"></a>07533             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pActualBox);
<a name="l07534"></a>07534 
<a name="l07535"></a>07535             <span class="keyword">const</span> <span class="keywordtype">bool</span> bAdded = pActualBox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l07536"></a>07536 
<a name="l07537"></a>07537             <span class="keywordflow">if</span> (!bAdded)
<a name="l07538"></a>07538             {
<a name="l07539"></a>07539                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to add transaction %ld to record box (after tentatively removing &quot;</span>
<a name="l07540"></a>07540                               <span class="stringliteral">&quot;from payment %s, an action that is now canceled.)\n&quot;</span>, __FUNCTION__,
<a name="l07541"></a>07541                               pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>(), bIsInbox ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>);
<a name="l07542"></a>07542                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07543"></a>07543             }
<a name="l07544"></a>07544             <span class="keywordflow">else</span>
<a name="l07545"></a>07545                 theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// If successfully added to the record box, then no need anymore to clean it up ourselves.</span>
<a name="l07546"></a>07546 
<a name="l07547"></a>07547             pActualBox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l07548"></a>07548             pActualBox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l07549"></a>07549             pActualBox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07550"></a>07550             <span class="comment">// -------------------------------</span>
<a name="l07551"></a>07551             <span class="keywordflow">if</span> (bIsExpired)
<a name="l07552"></a>07552                 pActualBox-&gt;<a class="code" href="class_o_t_ledger.html#ace1cb1337e94d794243bbe163eb88813">SaveExpiredBox</a>(); <span class="comment">// todo log failure.</span>
<a name="l07553"></a>07553             <span class="keywordflow">else</span>
<a name="l07554"></a>07554                 pActualBox-&gt;<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>(); <span class="comment">// todo log failure.</span>
<a name="l07555"></a>07555 
<a name="l07556"></a>07556             <span class="comment">// Any inbox/nymbox/outbox ledger will only itself contain</span>
<a name="l07557"></a>07557             <span class="comment">// abbreviated versions of the receipts, including their hashes.</span>
<a name="l07558"></a>07558             <span class="comment">//</span>
<a name="l07559"></a>07559             <span class="comment">// The rest is stored separately, in the box receipt, which is created</span>
<a name="l07560"></a>07560             <span class="comment">// whenever a receipt is added to a box, and deleted after a receipt</span>
<a name="l07561"></a>07561             <span class="comment">// is removed from a box.</span>
<a name="l07562"></a>07562             <span class="comment">//</span>
<a name="l07563"></a>07563             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a2f991feb7c6178ffabefc7fef312d26e">SaveBoxReceipt</a>(*pActualBox); <span class="comment">// todo: log failure</span>
<a name="l07564"></a>07564         }
<a name="l07565"></a>07565         <span class="comment">// -----------------------------------------------------</span>
<a name="l07566"></a>07566         <span class="keywordflow">if</span> (bIsInbox)
<a name="l07567"></a>07567         {
<a name="l07568"></a>07568             pPaymentInbox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l07569"></a>07569             pPaymentInbox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l07570"></a>07570             pPaymentInbox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07571"></a>07571             <span class="comment">// -----------------------------------------------------</span>
<a name="l07572"></a>07572             <span class="keyword">const</span> <span class="keywordtype">bool</span> bSavedInbox = pPaymentInbox-&gt;<a class="code" href="class_o_t_ledger.html#ab6f6af26a690d49f61ec7ffcc557a302">SavePaymentInbox</a>(); <span class="comment">// todo: log failure</span>
<a name="l07573"></a>07573             <span class="keywordflow">if</span> (!bSavedInbox) <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;/n%s: Unable to Save PaymentInbox./n&quot;</span>,__FUNCTION__);
<a name="l07574"></a>07574         }
<a name="l07575"></a>07575         <span class="keywordflow">else</span> <span class="comment">// outbox</span>
<a name="l07576"></a>07576         {
<a name="l07577"></a>07577             <span class="comment">// Outpayments are currently stored in the Nymfile.</span>
<a name="l07578"></a>07578             <span class="comment">//</span>
<a name="l07579"></a>07579             bNeedToSaveTheNym = <span class="keyword">true</span>;
<a name="l07580"></a>07580         }
<a name="l07581"></a>07581         <span class="comment">// -----------------------------------------------------</span>
<a name="l07582"></a>07582         <span class="keywordflow">if</span> (bNeedToSaveTheNym)
<a name="l07583"></a>07583         {
<a name="l07584"></a>07584             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l07585"></a>07585         }
<a name="l07586"></a>07586         <span class="comment">// -----------------------------------------------------</span>
<a name="l07587"></a>07587     }
<a name="l07588"></a>07588     <span class="keywordflow">else</span>
<a name="l07589"></a>07589     {
<a name="l07590"></a>07590         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to remove from payment %s based on index %d.\n&quot;</span>,
<a name="l07591"></a>07591                       __FUNCTION__, bIsInbox ? <span class="stringliteral">&quot;inbox&quot;</span> : <span class="stringliteral">&quot;outbox&quot;</span>, nIndex);
<a name="l07592"></a>07592         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07593"></a>07593     }
<a name="l07594"></a>07594     <span class="comment">// -----------------------------------------------------</span>
<a name="l07595"></a>07595     <span class="comment">//</span>
<a name="l07596"></a>07596     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07597"></a>07597 }
<a name="l07598"></a>07598 
<a name="l07599"></a>07599 
<a name="l07600"></a>07600 
<a name="l07601"></a>07601 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07602"></a>07602 
<a name="l07603"></a>07603 
<a name="l07604"></a>07604 
<a name="l07605"></a><a class="code" href="class_o_t___a_p_i.html#a71244607da4b28d1b33ab623ec9a2a1e">07605</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a71244607da4b28d1b33ab623ec9a2a1e">OT_API::ClearRecord</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l07606"></a>07606                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l07607"></a>07607                          <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID, <span class="comment">// USER_ID can be passed here as well.</span>
<a name="l07608"></a>07608                          <span class="keyword">const</span> int32_t        nIndex,
<a name="l07609"></a>07609                          <span class="keyword">const</span> <span class="keywordtype">bool</span>           bClearAll<span class="comment">/*=false*/</span>) <span class="comment">// if true, nIndex is ignored.</span>
<a name="l07610"></a>07610 {
<a name="l07611"></a>07611     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l07612"></a>07612     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07613"></a>07613     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l07614"></a>07614     <span class="comment">// -----------------------------------------------------</span>
<a name="l07615"></a>07615     <a class="code" href="class_o_t_ledger.html">OTLedger</a>  * pRecordBox = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a318f160f9a43ac68afcf415ff51ae267">LoadRecordBox</a> (SERVER_ID, USER_ID, ACCOUNT_ID);
<a name="l07616"></a>07616     <span class="comment">// -----------------------------------------------------</span>
<a name="l07617"></a>07617     <span class="keywordflow">if</span> (NULL == pRecordBox)
<a name="l07618"></a>07618     {
<a name="l07619"></a>07619         pRecordBox = <a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">OTLedger::GenerateLedger</a>(USER_ID, ACCOUNT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae650dd1b5a89523bace1c54c06897922">OTLedger::recordBox</a>, <span class="keyword">true</span>);
<a name="l07620"></a>07620 
<a name="l07621"></a>07621         <span class="keywordflow">if</span> (NULL == pRecordBox)
<a name="l07622"></a>07622         {
<a name="l07623"></a>07623             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to load or create record box (and thus unable to do anything with it.)\n&quot;</span>,
<a name="l07624"></a>07624                           __FUNCTION__);
<a name="l07625"></a>07625             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07626"></a>07626         }
<a name="l07627"></a>07627     }
<a name="l07628"></a>07628     <span class="comment">// -----------------------------------------------------</span>
<a name="l07629"></a>07629     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theRecordBoxAngel (pRecordBox);
<a name="l07630"></a>07630     <span class="comment">// -----------------------------------------------------</span>
<a name="l07631"></a>07631     <span class="keywordflow">if</span> (bClearAll)
<a name="l07632"></a>07632     {
<a name="l07633"></a>07633         pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#ade9cb07bcb99f244712fe948291fbb6c">ReleaseTransactions</a>();
<a name="l07634"></a>07634         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l07635"></a>07635         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l07636"></a>07636         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07637"></a>07637         pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>();
<a name="l07638"></a>07638         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07639"></a>07639     }
<a name="l07640"></a>07640     <span class="comment">// -----------------------------------------</span>
<a name="l07641"></a>07641     <span class="comment">// Okay, it&#39;s not &quot;clear all&quot; but &quot;clear at index&quot; ...</span>
<a name="l07642"></a>07642     <span class="comment">//</span>
<a name="l07643"></a>07643     <span class="keyword">const</span> int32_t nTransCount  = pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>();
<a name="l07644"></a>07644 
<a name="l07645"></a>07645     <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= nTransCount))
<a name="l07646"></a>07646     {
<a name="l07647"></a>07647         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Index out of bounds (highest allowed index for this record box is %d.)\n&quot;</span>,
<a name="l07648"></a>07648                        __FUNCTION__, nTransCount-1);
<a name="l07649"></a>07649         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07650"></a>07650     }
<a name="l07651"></a>07651     <span class="comment">// -----------------------------------------</span>
<a name="l07652"></a>07652     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#a5ede5441f84527b2717662fa465e526c">GetTransactionByIndex</a>(nIndex);
<a name="l07653"></a>07653     <span class="keywordtype">bool</span> bRemoved = <span class="keyword">false</span>;
<a name="l07654"></a>07654 
<a name="l07655"></a>07655     <span class="keywordflow">if</span> (NULL != pTransaction)
<a name="l07656"></a>07656     {
<a name="l07657"></a>07657         <span class="keyword">const</span> int64_t lTransactionNum = pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>();
<a name="l07658"></a>07658 
<a name="l07659"></a>07659         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#aea09d3dd8bf2fc5630ce87184fc937c1">DeleteBoxReceipt</a>(lTransactionNum))
<a name="l07660"></a>07660         {
<a name="l07661"></a>07661             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed trying to delete the box receipt for a transaction being removed &quot;</span>
<a name="l07662"></a>07662                           <span class="stringliteral">&quot;from a record box: %ld\n&quot;</span>, __FUNCTION__, lTransactionNum);
<a name="l07663"></a>07663         }
<a name="l07664"></a>07664         <span class="comment">// -----------------------------------------------------</span>
<a name="l07665"></a>07665         bRemoved = pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#acfb903f9b389367653d22b10df900978">RemoveTransaction</a>(lTransactionNum);
<a name="l07666"></a>07666     }
<a name="l07667"></a>07667     <span class="comment">// -----------------------------------------</span>
<a name="l07668"></a>07668     <span class="keywordflow">if</span> (bRemoved)
<a name="l07669"></a>07669     {
<a name="l07670"></a>07670         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l07671"></a>07671         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l07672"></a>07672         pRecordBox-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l07673"></a>07673         pRecordBox-&gt;<a class="code" href="class_o_t_ledger.html#aff379f9b12cebb1132bca402396f1a8a">SaveRecordBox</a>();
<a name="l07674"></a>07674         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07675"></a>07675     }
<a name="l07676"></a>07676     <span class="keywordflow">else</span>
<a name="l07677"></a>07677     {
<a name="l07678"></a>07678         <span class="keyword">const</span> int32_t nTemp = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(nIndex);
<a name="l07679"></a>07679         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to clear a record from the record box at index: %d\n&quot;</span>,
<a name="l07680"></a>07680                        __FUNCTION__, nTemp);        
<a name="l07681"></a>07681     }
<a name="l07682"></a>07682     <span class="comment">// -----------------------------------------</span>
<a name="l07683"></a>07683     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07684"></a>07684 }
<a name="l07685"></a>07685 
<a name="l07686"></a>07686 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07687"></a>07687 
<a name="l07688"></a>07688 
<a name="l07689"></a>07689 
<a name="l07690"></a>07690 <span class="comment">// This function assumes you have already downloaded the latest copy of your Nymbox,</span>
<a name="l07691"></a>07691 <span class="comment">// and that you have already retrieved theMessageNym from the @createUserAccount</span>
<a name="l07692"></a>07692 <span class="comment">// message, with both objects being loaded and passed as arguments here, ready to go.</span>
<a name="l07693"></a>07693 <span class="comment">//</span>
<a name="l07694"></a><a class="code" href="class_o_t___a_p_i.html#a8257fd4d11d7a54cc633edb5224d55f4">07694</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a8257fd4d11d7a54cc633edb5224d55f4">OT_API::ResyncNymWithServer</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym, <a class="code" href="class_o_t_ledger.html">OTLedger</a> &amp; theNymbox, <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theMessageNym)
<a name="l07695"></a>07695 {
<a name="l07696"></a>07696     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized, <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07697"></a>07697     <span class="comment">// -----------------------------------------------------</span>
<a name="l07698"></a>07698     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aae7427339a1b7566f46fb6d60c66bbfae">OTLedger::nymbox</a> != theNymbox.<a class="code" href="class_o_t_ledger.html#a28fd8abcda98128b8610c825d73e0f55">GetType</a>())
<a name="l07699"></a>07699     {
<a name="l07700"></a>07700         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::ResyncNymWithServer: Error: Expected a Nymbox, but you passed in a %s.\n&quot;</span>,
<a name="l07701"></a>07701                       theNymbox.<a class="code" href="class_o_t_ledger.html#a12f028ac95367cc8e48ad2636565c3a2">GetTypeString</a>());
<a name="l07702"></a>07702         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07703"></a>07703     }
<a name="l07704"></a>07704     <span class="comment">// -----------------------------------------------------</span>
<a name="l07705"></a>07705     <span class="keywordflow">if</span> (<span class="keyword">false</span> == theNym.<a class="code" href="class_o_t_pseudonym.html#a5ec9340b8d1d0fcd32f754ea63f9915a">CompareID</a>(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>()))
<a name="l07706"></a>07706     {
<a name="l07707"></a>07707         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> id1(theNym.<a class="code" href="class_o_t_pseudonym.html#a8167f1e2d532ab18227c5c170922c611">GetConstID</a>()), id2(theNymbox.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>());
<a name="l07708"></a>07708         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::ResyncNymWithServer: Error: NymID of Nym (%s) doesn&#39;t match NymID on (supposedly) his own Nymbox (%s).\n&quot;</span>,
<a name="l07709"></a>07709                       id1.Get(), id2.Get());
<a name="l07710"></a>07710         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07711"></a>07711     }
<a name="l07712"></a>07712     <span class="comment">// -----------------------------------------------------</span>
<a name="l07713"></a>07713 <span class="comment">//  if (false == theNym.CompareID(theMessageNym))</span>
<a name="l07714"></a>07714 <span class="comment">//  {</span>
<a name="l07715"></a>07715 <span class="comment">//      const OTString id1(theNym.GetConstID()), id2(theMessageNym.GetConstID());</span>
<a name="l07716"></a>07716 <span class="comment">//      OTLog::vError(&quot;OT_API::ResyncNymWithServer: Error: NymID of Nym (%s) doesn&#39;t match NymID on (supposedly) his server-side doppelganger (%s).\n&quot;,</span>
<a name="l07717"></a>07717 <span class="comment">//                    id1.Get(), id2.Get());</span>
<a name="l07718"></a>07718 <span class="comment">//      return false;</span>
<a name="l07719"></a>07719 <span class="comment">//  }</span>
<a name="l07720"></a>07720     <span class="comment">// *****************************************************</span>
<a name="l07721"></a>07721 
<a name="l07722"></a>07722     <span class="keywordflow">return</span> theNym.<a class="code" href="class_o_t_pseudonym.html#a4524f90e444b02c8c2c9e4a2cb61f103">ResyncWithServer</a>(theNymbox, theMessageNym);
<a name="l07723"></a>07723 }
<a name="l07724"></a>07724 
<a name="l07725"></a>07725 
<a name="l07726"></a>07726 
<a name="l07727"></a>07727 
<a name="l07728"></a>07728 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l07729"></a>07729 
<a name="l07730"></a>07730 
<a name="l07731"></a>07731 <span class="comment">// INCOMING SERVER REPLIES</span>
<a name="l07732"></a>07732 
<a name="l07733"></a>07733 
<a name="l07734"></a>07734 <span class="comment">// YOU are responsible to delete the OTMessage object, once</span>
<a name="l07735"></a>07735 <span class="comment">// you receive the pointer that comes back from this function.</span>
<a name="l07736"></a>07736 <span class="comment">// (It also might return NULL, if there are none there.)</span>
<a name="l07737"></a>07737 <span class="comment">//</span>
<a name="l07738"></a><a class="code" href="class_o_t___a_p_i.html#a04aee43cd2310d2da162f14c771e26cb">07738</a> <a class="code" href="class_o_t_message.html">OTMessage</a> * <a class="code" href="class_o_t___a_p_i.html#a04aee43cd2310d2da162f14c771e26cb">OT_API::PopMessageBuffer</a>(<span class="keyword">const</span> int64_t         &amp;   lRequestNumber,
<a name="l07739"></a>07739                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   SERVER_ID,
<a name="l07740"></a>07740                                      <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   USER_ID)
<a name="l07741"></a>07741 {
<a name="l07742"></a>07742     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( (m_bInitialized &amp;&amp; (<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> != NULL)) , <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07743"></a>07743     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( lRequestNumber &gt; 0, <span class="stringliteral">&quot;OT_API::PopMessageBuffer: lRequestNumber is less than 1.&quot;</span>);
<a name="l07744"></a>07744 
<a name="l07745"></a>07745     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l07746"></a>07746 
<a name="l07747"></a>07747     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36e39a99ff4495af7c8766da81d7b29b">GetMessageBuffer</a>().<a class="code" href="class_o_t_message_buffer.html#a4e9d4622eafbb0ea7111a70ee6cea5f7">Pop</a>(lRequestNumber, strServerID, strNymID); <span class="comment">// deletes</span>
<a name="l07748"></a>07748 }
<a name="l07749"></a>07749 
<a name="l07750"></a>07750 
<a name="l07751"></a>07751 
<a name="l07752"></a><a class="code" href="class_o_t___a_p_i.html#ae9f593a90e408ab34e92c25a4428bf8b">07752</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t___a_p_i.html#ae9f593a90e408ab34e92c25a4428bf8b">OT_API::FlushMessageBuffer</a>()
<a name="l07753"></a>07753 {
<a name="l07754"></a>07754     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized &amp;&amp; (<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> != NULL), <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07755"></a>07755 
<a name="l07756"></a>07756     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36e39a99ff4495af7c8766da81d7b29b">GetMessageBuffer</a>().<a class="code" href="class_o_t_message_buffer.html#ad65d140e16982e60267bdb06b6479678">Clear</a>();
<a name="l07757"></a>07757 }
<a name="l07758"></a>07758 
<a name="l07759"></a>07759 
<a name="l07760"></a>07760 
<a name="l07761"></a>07761 
<a name="l07762"></a>07762 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l07763"></a>07763 
<a name="l07764"></a>07764 
<a name="l07765"></a>07765 <span class="comment">// OUTOING MESSSAGES</span>
<a name="l07766"></a>07766 
<a name="l07767"></a>07767 <span class="comment">// NOTE: Currently it just stores ALL sent messages, if they were sent (as far as it</span>
<a name="l07768"></a>07768 <span class="comment">// can tell.) But the idea for the future is to have messages marked as &quot;important&quot;</span>
<a name="l07769"></a>07769 <span class="comment">// and for &quot;only those&quot; to actually be saved here. (Those important msgs are the ones</span>
<a name="l07770"></a>07770 <span class="comment">// that we need to track for purposes of harvesting transaction numbers.)</span>
<a name="l07771"></a>07771 
<a name="l07772"></a>07772 <span class="comment">// Do NOT delete the message that is returned here.</span>
<a name="l07773"></a>07773 <span class="comment">// Use the &quot;Remove&quot; call if you want to remove it.</span>
<a name="l07774"></a>07774 <span class="comment">//</span>
<a name="l07775"></a>07775 
<a name="l07776"></a><a class="code" href="class_o_t___a_p_i.html#a23edd3f777f72244fa6281911d431e08">07776</a> <a class="code" href="class_o_t_message.html">OTMessage</a> * <a class="code" href="class_o_t___a_p_i.html#a23edd3f777f72244fa6281911d431e08">OT_API::GetSentMessage</a>(<span class="keyword">const</span> int64_t         &amp; lRequestNumber,
<a name="l07777"></a>07777                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l07778"></a>07778                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l07779"></a>07779 {
<a name="l07780"></a>07780     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( (m_bInitialized &amp;&amp; (<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> != NULL)) , <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07781"></a>07781     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>( lRequestNumber &gt; 0, <span class="stringliteral">&quot;OT_API::GetSentMessage: lRequestNumber is less than 1.&quot;</span>);
<a name="l07782"></a>07782 
<a name="l07783"></a>07783     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l07784"></a>07784 
<a name="l07785"></a>07785     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#ad60d6fcacb284e4ab9a3acde35bfc796">GetSentMessage</a>(lRequestNumber, strServerID, strNymID); <span class="comment">// doesn&#39;t delete.</span>
<a name="l07786"></a>07786 }
<a name="l07787"></a>07787 
<a name="l07788"></a>07788 
<a name="l07789"></a><a class="code" href="class_o_t___a_p_i.html#a5ee70b9309b55c10ade9e0bf240c66a2">07789</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a5ee70b9309b55c10ade9e0bf240c66a2">OT_API::RemoveSentMessage</a>(<span class="keyword">const</span> int64_t         &amp; lRequestNumber,
<a name="l07790"></a>07790                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l07791"></a>07791                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l07792"></a>07792 {
<a name="l07793"></a>07793     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized &amp;&amp; (<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> != NULL), <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07794"></a>07794     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(lRequestNumber &gt; 0, <span class="stringliteral">&quot;OT_API::RemoveSentMessage: lRequestNumber is less than 1.&quot;</span>);
<a name="l07795"></a>07795 
<a name="l07796"></a>07796     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l07797"></a>07797 
<a name="l07798"></a>07798     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#aefe611bcb8fab3e6fe763bfb98ccf86a">RemoveSentMessage</a>(lRequestNumber, strServerID, strNymID); <span class="comment">// deletes.</span>
<a name="l07799"></a>07799 }
<a name="l07800"></a>07800 
<a name="l07801"></a>07801 
<a name="l07802"></a>07802 
<a name="l07803"></a>07803 <span class="comment">//  Basically, the sent messages queue must store</span>
<a name="l07804"></a>07804 <span class="comment">// messages (by request number) until we know for SURE whether we have a success, a failure,</span>
<a name="l07805"></a>07805 <span class="comment">// or a lost/rejected message. That is, until we DOWNLOAD the Nymbox, and thus know for SURE</span>
<a name="l07806"></a>07806 <span class="comment">// that a response to a given message is there...or not. Why do we care? For making this</span>
<a name="l07807"></a>07807 <span class="comment">// choice:</span>
<a name="l07808"></a>07808 <span class="comment">//</span>
<a name="l07809"></a>07809 <span class="comment">// Messages that DO have a reply are therefore already &quot;in the system&quot; and will be handled</span>
<a name="l07810"></a>07810 <span class="comment">// normally--they can be ignored and flushed from the &quot;sent messages&quot; queue. Whereas messages</span>
<a name="l07811"></a>07811 <span class="comment">// that do NOT have a reply in the Nymbox (yet are still in the &quot;sent messages&quot; queue) can be</span>
<a name="l07812"></a>07812 <span class="comment">// assumed safely to have been rejected at &quot;message level&quot; (before any transaction could</span>
<a name="l07813"></a>07813 <span class="comment">// have processed) and the reply must have been dropped on the network, OR the server never</span>
<a name="l07814"></a>07814 <span class="comment">// even received the message in the first place. EITHER WAY the trans #s can be harvested</span>
<a name="l07815"></a>07815 <span class="comment">// accordingly and then removed from the sent buffer. In a perfect world (read: iteration 2)</span>
<a name="l07816"></a>07816 <span class="comment">// these sent messages will be serialized somehow along with the Nym, and not just stored in</span>
<a name="l07817"></a>07817 <span class="comment">// RAM like this version does.</span>
<a name="l07818"></a>07818 <span class="comment">//</span>
<a name="l07819"></a>07819 <span class="comment">// Therefore this function will be called only after @getNymbox (in OTClient), where each</span>
<a name="l07820"></a>07820 <span class="comment">// replyNotice in the Nymbox will be removed from the sent messages individually, and then</span>
<a name="l07821"></a>07821 <span class="comment">// the rest of the sent messages can be flushed</span>
<a name="l07822"></a>07822 <span class="comment">//</span>
<a name="l07823"></a>07823 <span class="comment">//</span>
<a name="l07824"></a>07824 <span class="comment">// -----------------------------------------------------------</span>
<a name="l07825"></a>07825 <span class="comment">// OT_API::FlushSentMessages</span>
<a name="l07826"></a>07826 <span class="comment">//</span>
<a name="l07827"></a>07827 <span class="comment">// Make sure to call this directly after a successful @getNymbox.</span>
<a name="l07828"></a>07828 <span class="comment">// (And ONLY at that time.)</span>
<a name="l07829"></a>07829 <span class="comment">//</span>
<a name="l07830"></a>07830 <span class="comment">// This empties the buffer of sent messages.</span>
<a name="l07831"></a>07831 <span class="comment">// (Harvesting any transaction numbers that are still there.)</span>
<a name="l07832"></a>07832 <span class="comment">//</span>
<a name="l07833"></a>07833 <span class="comment">// NOTE: You normally ONLY call this immediately after receiving</span>
<a name="l07834"></a>07834 <span class="comment">// a successful @getNymbox. It&#39;s only then that you can see which</span>
<a name="l07835"></a>07835 <span class="comment">// messages a server actually received or not -- which transactions</span>
<a name="l07836"></a>07836 <span class="comment">// it processed (success or fail) vs which transactions did NOT</span>
<a name="l07837"></a>07837 <span class="comment">// process (and thus did NOT leave any success/fail receipt in the</span>
<a name="l07838"></a>07838 <span class="comment">// nymbox.)</span>
<a name="l07839"></a>07839 <span class="comment">//</span>
<a name="l07840"></a>07840 <span class="comment">// I COULD have just flushed myself IN the @getNymbox code (where</span>
<a name="l07841"></a>07841 <span class="comment">// the reply is processed.) But then the developer using the OT API</span>
<a name="l07842"></a>07842 <span class="comment">// would never have the opportunity to see whether a message was</span>
<a name="l07843"></a>07843 <span class="comment">// replied to, and harvest it for himself (say, just before attempting</span>
<a name="l07844"></a>07844 <span class="comment">// a re-try, which I plan to do in the high-level Java API, which is</span>
<a name="l07845"></a>07845 <span class="comment">// why I&#39;m coding it this way.)</span>
<a name="l07846"></a>07846 <span class="comment">//</span>
<a name="l07847"></a>07847 <span class="comment">// This way, he can do that if he wishes, THEN call this function,</span>
<a name="l07848"></a>07848 <span class="comment">// and harvesting will still occur properly, and he will also thus have</span>
<a name="l07849"></a>07849 <span class="comment">// his chance to check for his own replies to harvest before then.</span>
<a name="l07850"></a>07850 <span class="comment">// This all depends on the developer using the API being smart enough</span>
<a name="l07851"></a>07851 <span class="comment">// to call this function after a successful @getNymbox!</span>
<a name="l07852"></a>07852 <span class="comment">//</span>
<a name="l07853"></a><a class="code" href="class_o_t___a_p_i.html#a9a02cca439067abd875c78ca7f732011">07853</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t___a_p_i.html#a9a02cca439067abd875c78ca7f732011">OT_API::FlushSentMessages</a>(<span class="keyword">const</span> <span class="keywordtype">bool</span> bHarvestingForRetry,
<a name="l07854"></a>07854                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l07855"></a>07855                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l07856"></a>07856                                      <a class="code" href="class_o_t_ledger.html">OTLedger</a>     &amp; THE_NYMBOX)
<a name="l07857"></a>07857 {
<a name="l07858"></a>07858     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(m_bInitialized &amp;&amp; (<a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a> != NULL), <span class="stringliteral">&quot;Not initialized; call OT_API::Init first.&quot;</span>);
<a name="l07859"></a>07859     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l07860"></a>07860     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::FlushSentMessages&quot;</span>;
<a name="l07861"></a>07861     <span class="comment">// -----------------------------------------------------</span>
<a name="l07862"></a>07862     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a08144e29a333dd0e1087c4655e6981ee">GetNym</a>(USER_ID, szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l07863"></a>07863     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span>;
<a name="l07864"></a>07864     <span class="comment">// Below this point, pNym is a good ptr, and will be cleaned up automatically.</span>
<a name="l07865"></a>07865     <span class="comment">// -----------------------------------------------------</span>
<a name="l07866"></a>07866     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l07867"></a>07867     <span class="comment">// -----------------------------------------------------</span>
<a name="l07868"></a>07868     <span class="keywordflow">if</span> ((THE_NYMBOX.<a class="code" href="class_o_t_transaction_type.html#a845d76c16f6f5f3f4bc9ac04393ca3c0">GetUserID</a>()            != USER_ID) ||
<a name="l07869"></a>07869         (THE_NYMBOX.<a class="code" href="class_o_t_transaction_type.html#a59fc08d52ef5bc0ea546da7a56e86fa5">GetPurportedServerID</a>() != SERVER_ID))
<a name="l07870"></a>07870     {
<a name="l07871"></a>07871         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strLedger(THE_NYMBOX);
<a name="l07872"></a>07872         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure, Bad input data: UserID (%s) or ServerID (%s) failed to match Nymbox:\n\n%s\n\n&quot;</span>,
<a name="l07873"></a>07873                       szFuncName, strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strServerID.Get(), strLedger.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l07874"></a>07874         <span class="keywordflow">return</span>;
<a name="l07875"></a>07875     }
<a name="l07876"></a>07876     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l07877"></a>07877     <span class="comment">// Iterate through the nymbox receipts.</span>
<a name="l07878"></a>07878     <span class="comment">// If ANY of them is a REPLY NOTICE, then see if the SENT MESSAGE for that SAME</span>
<a name="l07879"></a>07879     <span class="comment">// request number is in the sent queue.</span>
<a name="l07880"></a>07880     <span class="comment">// If it IS, REMOVE IT from the sent queue. (Since Nymbox clearly already contains</span>
<a name="l07881"></a>07881     <span class="comment">// a reply to it, no need to queue it anymore.)</span>
<a name="l07882"></a>07882     <span class="comment">// At the end of this loop, then FLUSH the sent queue. We KNOW only important</span>
<a name="l07883"></a>07883     <span class="comment">// (nymbox related) messages should be queued there, and once we see the latest Nymbox,</span>
<a name="l07884"></a>07884     <span class="comment">// then we KNOW which ones to remove before flushing.</span>
<a name="l07885"></a>07885     <span class="comment">//</span>
<a name="l07886"></a>07886     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_ledger_8hpp.html#a1823ddf57c0de6495aa8ec5da7f1b8f7">mapOfTransactions</a>, THE_NYMBOX.<a class="code" href="class_o_t_ledger.html#aa71b6540e2948a36e3c7d3e7d14547a5">GetTransactionMap</a>())
<a name="l07887"></a>07887     {
<a name="l07888"></a>07888         <span class="keyword">const</span> <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = (*it).second;
<a name="l07889"></a>07889         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pTransaction);
<a name="l07890"></a>07890         <span class="comment">// --------------------------------</span>
<a name="l07891"></a>07891 
<a name="l07892"></a>07892         <span class="keywordflow">if</span> (<a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acae27254bdf46d3581a3ab1038566d7c">OTTransaction::replyNotice</a> == pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#ac964dfd1e704c02358a6641f030ead38">GetType</a>())
<a name="l07893"></a>07893         {
<a name="l07894"></a>07894             <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#ad60d6fcacb284e4ab9a3acde35bfc796">GetSentMessage</a>(*pTransaction);
<a name="l07895"></a>07895 
<a name="l07896"></a>07896             <span class="keywordflow">if</span> (NULL != pMessage) <span class="comment">// It WAS there in my sent buffer!</span>
<a name="l07897"></a>07897             {
<a name="l07898"></a>07898                 <span class="comment">// Since it IS in my Nymbox already as a replyNotice,</span>
<a name="l07899"></a>07899                 <span class="comment">// therefore I&#39;m safe to erase it from my sent queue.</span>
<a name="l07900"></a>07900                 <span class="comment">//</span>
<a name="l07901"></a>07901                 <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#aefe611bcb8fab3e6fe763bfb98ccf86a">RemoveSentMessage</a>(*pTransaction);
<a name="l07902"></a>07902             }
<a name="l07903"></a>07903             <span class="comment">// else do nothing, must have already removed it.</span>
<a name="l07904"></a>07904         }
<a name="l07905"></a>07905     }
<a name="l07906"></a>07906     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l07907"></a>07907     <span class="comment">// Now that we&#39;ve REMOVED the sent messages that already have a reply</span>
<a name="l07908"></a>07908     <span class="comment">// in the Nymbox (and thus CLEARLY do not need harvesting...)</span>
<a name="l07909"></a>07909     <span class="comment">//</span>
<a name="l07910"></a>07910     <span class="comment">// Clear all &quot;sent message&quot; cached messages for this server and NymID.</span>
<a name="l07911"></a>07911     <span class="comment">// (And harvest their transaction numbers back, since we know for a fact</span>
<a name="l07912"></a>07912     <span class="comment">// the server hasn&#39;t replied to them (the reply would be in the Nymbox, which</span>
<a name="l07913"></a>07913     <span class="comment">// we just got.)</span>
<a name="l07914"></a>07914     <span class="comment">//</span>
<a name="l07915"></a>07915     <span class="comment">// UPDATE: We will have to rely on the Developer using the OT API to call</span>
<a name="l07916"></a>07916     <span class="comment">// OT_API_FlushSentMessages IMMEDIATELY after calling getNymbox and receiving</span>
<a name="l07917"></a>07917     <span class="comment">// a successful reply. Why? Because that&#39;s the only way to give him the chance</span>
<a name="l07918"></a>07918     <span class="comment">// to see if certain replies are there or not (before they get removed.) That way</span>
<a name="l07919"></a>07919     <span class="comment">// he can do his own harvesting, do a re-try, etc and then finally when he is done</span>
<a name="l07920"></a>07920     <span class="comment">// with that, do the flush.</span>
<a name="l07921"></a>07921     <span class="comment">//</span>
<a name="l07922"></a>07922     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a86b6fe9628f0b065e7f35dd68c02b3e6">GetMessageOutbuffer</a>().<a class="code" href="class_o_t_message_outbuffer.html#a4e5414cfda971df494246ac2bf35c70c">Clear</a>(&amp;strServerID, &amp;strNymID, pNym, &amp;bHarvestingForRetry); <span class="comment">// FYI: This HARVESTS any sent messages that need harvesting, before flushing them all.</span>
<a name="l07923"></a>07923 }
<a name="l07924"></a>07924 
<a name="l07925"></a>07925 <span class="comment">// -----------------------------------------------------------------</span>
<a name="l07926"></a>07926 
<a name="l07927"></a>07927 
<a name="l07928"></a>07928 
<a name="l07929"></a><a class="code" href="class_o_t___a_p_i.html#a76e14d4a7826d39f55e0dcac022a8474">07929</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a76e14d4a7826d39f55e0dcac022a8474">OT_API::HaveAlreadySeenReply</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID, <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID, <span class="keyword">const</span> int64_t &amp; lRequestNumber)
<a name="l07930"></a>07930 {
<a name="l07931"></a>07931     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::HaveAlreadySeenReply&quot;</span>;
<a name="l07932"></a>07932     <span class="comment">// -----------------------------------------------------</span>
<a name="l07933"></a>07933     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l07934"></a>07934     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07935"></a>07935     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l07936"></a>07936     <span class="comment">// -----------------------------------------------------</span>
<a name="l07937"></a>07937 
<a name="l07938"></a>07938     <span class="comment">// &quot;Client verifies it has already seen a server reply.&quot;</span>
<a name="l07939"></a>07939 <span class="comment">//  bool OTPseudonym:::VerifyAcknowledgedNum(const OTString &amp; strServerID, const int64_t &amp; lRequestNum);</span>
<a name="l07940"></a>07940     <span class="comment">//</span>
<a name="l07941"></a>07941     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l07942"></a>07942     <span class="keywordflow">return</span> pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a11fd56ffbcef5fcebbd259bdb1bd7c8e">VerifyAcknowledgedNum</a>(strServerID, lRequestNumber);
<a name="l07943"></a>07943 }
<a name="l07944"></a>07944 
<a name="l07945"></a>07945 
<a name="l07946"></a>07946 
<a name="l07947"></a>07947 
<a name="l07948"></a>07948 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l07949"></a>07949 
<a name="l07950"></a>07950 
<a name="l07951"></a>07951 
<a name="l07952"></a>07952 <span class="comment">// --------------------------------------------------------------</span>
<a name="l07953"></a>07953 <span class="comment">// IS BASKET CURRENCY ?</span>
<a name="l07954"></a>07954 <span class="comment">//</span>
<a name="l07955"></a>07955 <span class="comment">// Tells you whether or not a given asset type is actually a basket currency.</span>
<a name="l07956"></a>07956 <span class="comment">//</span>
<a name="l07957"></a><a class="code" href="class_o_t___a_p_i.html#a1513a6077de1cdcd818ac9f480481ed8">07957</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a1513a6077de1cdcd818ac9f480481ed8">OT_API::IsBasketCurrency</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID) <span class="comment">// returns true or false.</span>
<a name="l07958"></a>07958 {
<a name="l07959"></a>07959     <span class="comment">// -----------------------------------------------------</span>
<a name="l07960"></a>07960     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l07961"></a>07961     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l07962"></a>07962     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, __FUNCTION__);
<a name="l07963"></a>07963     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07964"></a>07964     <span class="comment">// No need to cleanup pContract.</span>
<a name="l07965"></a>07965     <span class="comment">// -----------------------------------------------------</span>
<a name="l07966"></a>07966     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l07967"></a>07967     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l07968"></a>07968 
<a name="l07969"></a>07969     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l07970"></a>07970     <span class="comment">// Can&#39;t never be too sure...</span>
<a name="l07971"></a>07971     <span class="comment">//</span>
<a name="l07972"></a>07972     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l07973"></a>07973     {
<a name="l07974"></a>07974         <span class="keywordflow">if</span> (theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>() &gt; 0)
<a name="l07975"></a>07975             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07976"></a>07976     }
<a name="l07977"></a>07977 
<a name="l07978"></a>07978     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07979"></a>07979 }
<a name="l07980"></a>07980 
<a name="l07981"></a>07981 
<a name="l07982"></a>07982 
<a name="l07983"></a>07983 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l07984"></a>07984 <span class="comment">// Get Basket Count (of member currency types.)</span>
<a name="l07985"></a>07985 <span class="comment">//</span>
<a name="l07986"></a>07986 <span class="comment">// Returns the number of asset types that make up this basket.</span>
<a name="l07987"></a>07987 <span class="comment">// (Or zero.)</span>
<a name="l07988"></a>07988 <span class="comment">//</span>
<a name="l07989"></a><a class="code" href="class_o_t___a_p_i.html#af4747b3de4902f3217ab050bb041bc66">07989</a> int32_t <a class="code" href="class_o_t___a_p_i.html#af4747b3de4902f3217ab050bb041bc66">OT_API::GetBasketMemberCount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID)
<a name="l07990"></a>07990 {
<a name="l07991"></a>07991     <span class="comment">// -----------------------------------------------------</span>
<a name="l07992"></a>07992     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l07993"></a>07993     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l07994"></a>07994     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, __FUNCTION__);
<a name="l07995"></a>07995     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> 0;
<a name="l07996"></a>07996     <span class="comment">// No need to cleanup pContract.</span>
<a name="l07997"></a>07997     <span class="comment">// -----------------------------------------------------</span>
<a name="l07998"></a>07998     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l07999"></a>07999     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l08000"></a>08000 
<a name="l08001"></a>08001     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l08002"></a>08002     <span class="comment">// Can&#39;t never be too sure...</span>
<a name="l08003"></a>08003     <span class="comment">//</span>
<a name="l08004"></a>08004     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l08005"></a>08005         <span class="keywordflow">return</span> theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>();
<a name="l08006"></a>08006 
<a name="l08007"></a>08007     <span class="keywordflow">return</span> 0;
<a name="l08008"></a>08008 }
<a name="l08009"></a>08009 
<a name="l08010"></a>08010 
<a name="l08011"></a>08011 
<a name="l08012"></a>08012 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l08013"></a>08013 <span class="comment">// Get Basket Member Asset Type</span>
<a name="l08014"></a>08014 <span class="comment">//</span>
<a name="l08015"></a>08015 <span class="comment">// Returns one of the asset types that make up this basket,</span>
<a name="l08016"></a>08016 <span class="comment">// by index, and true.</span>
<a name="l08017"></a>08017 <span class="comment">// (Or false.)</span>
<a name="l08018"></a>08018 <span class="comment">//</span>
<a name="l08019"></a><a class="code" href="class_o_t___a_p_i.html#aa51bdf044a89177e8bb1e0387e28a24a">08019</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#aa51bdf044a89177e8bb1e0387e28a24a">OT_API::GetBasketMemberType</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID,
<a name="l08020"></a>08020                                  <span class="keyword">const</span> int32_t nIndex,
<a name="l08021"></a>08021                                  <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theOutputMemberType)
<a name="l08022"></a>08022 {
<a name="l08023"></a>08023     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::GetBasketMemberType&quot;</span>;
<a name="l08024"></a>08024     <span class="comment">// -----------------------------------------------------</span>
<a name="l08025"></a>08025     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l08026"></a>08026     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l08027"></a>08027     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, szFuncName);
<a name="l08028"></a>08028     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08029"></a>08029     <span class="comment">// No need to cleanup pContract.</span>
<a name="l08030"></a>08030     <span class="comment">// -----------------------------------------------------</span>
<a name="l08031"></a>08031     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l08032"></a>08032     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l08033"></a>08033 
<a name="l08034"></a>08034     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l08035"></a>08035     <span class="comment">// Can&#39;t never be too sure.</span>
<a name="l08036"></a>08036     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l08037"></a>08037     {
<a name="l08038"></a>08038         <span class="keywordflow">if</span> ((nIndex &gt;= theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>()) || (nIndex &lt; 0))
<a name="l08039"></a>08039         {
<a name="l08040"></a>08040             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::GetBasketMemberType: Index out of bounds: %d\n&quot;</span>, nIndex);
<a name="l08041"></a>08041             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08042"></a>08042         }
<a name="l08043"></a>08043 
<a name="l08044"></a>08044         <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(nIndex);
<a name="l08045"></a>08045         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Bad index in OT_API::GetBasketMemberType&quot;</span>);
<a name="l08046"></a>08046 
<a name="l08047"></a>08047         theOutputMemberType = pItem-&gt;<a class="code" href="class_basket_item.html#a303fdc62c0271fc0d7ccaed05b1658cb">SUB_CONTRACT_ID</a>;
<a name="l08048"></a>08048 
<a name="l08049"></a>08049         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l08050"></a>08050     }
<a name="l08051"></a>08051     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08052"></a>08052 }
<a name="l08053"></a>08053 
<a name="l08054"></a>08054 
<a name="l08055"></a>08055 
<a name="l08056"></a>08056 
<a name="l08057"></a>08057 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l08058"></a>08058 <span class="comment">// Get Basket Member Minimum Transfer Amount</span>
<a name="l08059"></a>08059 <span class="comment">//</span>
<a name="l08060"></a>08060 <span class="comment">// Returns the minimum transfer amount for one of the asset types that</span>
<a name="l08061"></a>08061 <span class="comment">// makes up this basket, by index.</span>
<a name="l08062"></a>08062 <span class="comment">// (Or 0.)</span>
<a name="l08063"></a>08063 <span class="comment">//</span>
<a name="l08064"></a><a class="code" href="class_o_t___a_p_i.html#af5ceba4f208230dc9b077b37423e289f">08064</a> int64_t <a class="code" href="class_o_t___a_p_i.html#af5ceba4f208230dc9b077b37423e289f">OT_API::GetBasketMemberMinimumTransferAmount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID,
<a name="l08065"></a>08065                                                   <span class="keyword">const</span> int32_t nIndex)
<a name="l08066"></a>08066 {
<a name="l08067"></a>08067     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::GetBasketMemberMinimumTransferAmount&quot;</span>;
<a name="l08068"></a>08068     <span class="comment">// -----------------------------------------------------</span>
<a name="l08069"></a>08069     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l08070"></a>08070     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l08071"></a>08071     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, szFuncName);
<a name="l08072"></a>08072     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> 0;
<a name="l08073"></a>08073     <span class="comment">// No need to cleanup pContract.</span>
<a name="l08074"></a>08074     <span class="comment">// -----------------------------------------------------</span>
<a name="l08075"></a>08075     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l08076"></a>08076     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l08077"></a>08077 
<a name="l08078"></a>08078     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l08079"></a>08079     <span class="comment">// Can&#39;t never be too sure.</span>
<a name="l08080"></a>08080     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l08081"></a>08081     {
<a name="l08082"></a>08082         <span class="keywordflow">if</span> ((nIndex &gt;= theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>()) || (nIndex &lt; 0))
<a name="l08083"></a>08083         {
<a name="l08084"></a>08084             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::GetBasketMemberMinimumTransferAmount: Index out of bounds: %d\n&quot;</span>, nIndex);
<a name="l08085"></a>08085             <span class="keywordflow">return</span> 0;
<a name="l08086"></a>08086         }
<a name="l08087"></a>08087 
<a name="l08088"></a>08088         <a class="code" href="class_basket_item.html">BasketItem</a> * pItem = theBasket.<a class="code" href="class_o_t_basket.html#ae2fb9c4b001c2208bbe5b61cdd174da9">At</a>(nIndex);
<a name="l08089"></a>08089 
<a name="l08090"></a>08090         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Bad index in OT_API::GetBasketMemberMinimumTransferAmount.&quot;</span>);
<a name="l08091"></a>08091 
<a name="l08092"></a>08092         <span class="keywordflow">return</span> pItem-&gt;<a class="code" href="class_basket_item.html#a7a1360eb91fa3bced17ed6d097669c9a">lMinimumTransferAmount</a>;;
<a name="l08093"></a>08093     }
<a name="l08094"></a>08094     <span class="keywordflow">else</span>
<a name="l08095"></a>08095         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::GetBasketMemberMinimumTransferAmount: Failed loading basket info from basket asset contract.\n&quot;</span>);
<a name="l08096"></a>08096 
<a name="l08097"></a>08097     <span class="keywordflow">return</span> 0;
<a name="l08098"></a>08098 }
<a name="l08099"></a>08099 
<a name="l08100"></a>08100 
<a name="l08101"></a>08101 
<a name="l08102"></a>08102 <span class="comment">// --------------------------------------------------------------------</span>
<a name="l08103"></a>08103 <span class="comment">// Get Basket Minimum Transfer Amount</span>
<a name="l08104"></a>08104 <span class="comment">//</span>
<a name="l08105"></a>08105 <span class="comment">// Returns the minimum transfer amount for the basket.</span>
<a name="l08106"></a>08106 <span class="comment">// (Or 0.)</span>
<a name="l08107"></a>08107 <span class="comment">//</span>
<a name="l08108"></a><a class="code" href="class_o_t___a_p_i.html#aba4eb1e71d36b4ca4f077a90e3220ed5">08108</a> int64_t <a class="code" href="class_o_t___a_p_i.html#aba4eb1e71d36b4ca4f077a90e3220ed5">OT_API::GetBasketMinimumTransferAmount</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID)
<a name="l08109"></a>08109 {
<a name="l08110"></a>08110     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::GetBasketMinimumTransferAmount&quot;</span>;
<a name="l08111"></a>08111     <span class="comment">// -----------------------------------------------------</span>
<a name="l08112"></a>08112     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l08113"></a>08113     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l08114"></a>08114     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, szFuncName);
<a name="l08115"></a>08115     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> 0;
<a name="l08116"></a>08116     <span class="comment">// No need to cleanup pContract.</span>
<a name="l08117"></a>08117     <span class="comment">// -----------------------------------------------------</span>
<a name="l08118"></a>08118     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l08119"></a>08119     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l08120"></a>08120 
<a name="l08121"></a>08121     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l08122"></a>08122     <span class="comment">// Can&#39;t never be too sure.</span>
<a name="l08123"></a>08123     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l08124"></a>08124         <span class="keywordflow">return</span> theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>();
<a name="l08125"></a>08125 
<a name="l08126"></a>08126     <span class="keywordflow">return</span> 0;
<a name="l08127"></a>08127 }
<a name="l08128"></a>08128 
<a name="l08129"></a>08129 
<a name="l08130"></a>08130 
<a name="l08131"></a>08131 
<a name="l08132"></a>08132 
<a name="l08133"></a>08133 <span class="comment">// --------------------------------------------------------</span>
<a name="l08134"></a>08134 <span class="comment">// GENERATE BASKET CREATION REQUEST</span>
<a name="l08135"></a>08135 <span class="comment">//</span>
<a name="l08136"></a>08136 <span class="comment">// Creates a new request (for generating a new Basket type).</span>
<a name="l08137"></a>08137 <span class="comment">// (Each currency in this request will be added with</span>
<a name="l08138"></a>08138 <span class="comment">// subsequent calls to OT_API::GenerateBasketItem()).</span>
<a name="l08139"></a>08139 <span class="comment">//</span>
<a name="l08140"></a>08140 <span class="comment">// (Caller is responsible to delete.)</span>
<a name="l08141"></a>08141 <span class="comment">//</span>
<a name="l08142"></a><a class="code" href="class_o_t___a_p_i.html#acd596ba47ce7c6e3f1035d91e6fdfbac">08142</a> <a class="code" href="class_o_t_basket.html">OTBasket</a> * <a class="code" href="class_o_t___a_p_i.html#acd596ba47ce7c6e3f1035d91e6fdfbac">OT_API::GenerateBasketCreation</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l08143"></a>08143                                           <span class="keyword">const</span> int64_t MINIMUM_TRANSFER) <span class="comment">// Must be above zero. If &lt;= 0, defaults to 10.</span>
<a name="l08144"></a>08144 {
<a name="l08145"></a>08145     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::GenerateBasketCreation&quot;</span>;
<a name="l08146"></a>08146     <span class="comment">// -----------------------------------------------------</span>
<a name="l08147"></a>08147     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l08148"></a>08148     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l08149"></a>08149     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08150"></a>08150     <span class="comment">// -----------------------------------------------------</span>
<a name="l08151"></a>08151     int64_t lMinimumTransferAmount = 10;
<a name="l08152"></a>08152 
<a name="l08153"></a>08153     <span class="keywordflow">if</span> (MINIMUM_TRANSFER &gt; 0)
<a name="l08154"></a>08154         lMinimumTransferAmount = MINIMUM_TRANSFER;
<a name="l08155"></a>08155     <span class="comment">// -----------------------------------------------------</span>
<a name="l08156"></a>08156     <a class="code" href="class_o_t_basket.html">OTBasket</a> * pBasket = <span class="keyword">new</span> <a class="code" href="class_o_t_basket.html">OTBasket</a>(0, lMinimumTransferAmount);
<a name="l08157"></a>08157     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pBasket, <span class="stringliteral">&quot;OT_API::GenerateBasketCreation: Error allocating memory in the OT API&quot;</span>);
<a name="l08158"></a>08158 
<a name="l08159"></a>08159     pBasket-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08160"></a>08160     pBasket-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08161"></a>08161 
<a name="l08162"></a>08162     <span class="keywordflow">return</span> pBasket;
<a name="l08163"></a>08163 }
<a name="l08164"></a>08164 
<a name="l08165"></a>08165 
<a name="l08166"></a>08166 <span class="comment">// --------------------------------------------------------</span>
<a name="l08167"></a>08167 <span class="comment">// ADD BASKET CREATION ITEM</span>
<a name="l08168"></a>08168 <span class="comment">//</span>
<a name="l08169"></a>08169 <span class="comment">// Used for creating a request to generate a new basket currency.</span>
<a name="l08170"></a><a class="code" href="class_o_t___a_p_i.html#a27cfd793ce09044f9364bee6e0bff7ad">08170</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a27cfd793ce09044f9364bee6e0bff7ad">OT_API::AddBasketCreationItem</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID, <span class="comment">// for signature.</span>
<a name="l08171"></a>08171                                    <a class="code" href="class_o_t_basket.html">OTBasket</a> &amp; theBasket,
<a name="l08172"></a>08172                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l08173"></a>08173                                    <span class="keyword">const</span> int64_t MINIMUM_TRANSFER)
<a name="l08174"></a>08174 {
<a name="l08175"></a>08175     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::AddBasketCreationItem&quot;</span>;
<a name="l08176"></a>08176     <span class="comment">// -----------------------------------------------------</span>
<a name="l08177"></a>08177     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l08178"></a>08178     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08179"></a>08179     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08180"></a>08180     <span class="comment">// -----------------------------------------------------</span>
<a name="l08181"></a>08181     <span class="comment">// There is an OT_ASSERT_MSG in here for memory failure,</span>
<a name="l08182"></a>08182     <span class="comment">// but it still might return NULL if various verification fails.</span>
<a name="l08183"></a>08183     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(ASSET_TYPE_ID, szFuncName);
<a name="l08184"></a>08184     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08185"></a>08185     <span class="comment">// No need to cleanup pContract.</span>
<a name="l08186"></a>08186     <span class="comment">// -----------------------------------------------------</span>
<a name="l08187"></a>08187 
<a name="l08188"></a>08188     theBasket.<a class="code" href="class_o_t_basket.html#ae0a4fc1320ad66dd613b70cbc8e6a32b">AddSubContract</a>(ASSET_TYPE_ID, MINIMUM_TRANSFER);
<a name="l08189"></a>08189 
<a name="l08190"></a>08190     theBasket.<a class="code" href="class_o_t_basket.html#ac42324cfcc230857969c398d2c3e61c4">IncrementSubCount</a>();
<a name="l08191"></a>08191 
<a name="l08192"></a>08192     theBasket.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08193"></a>08193     theBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08194"></a>08194     theBasket.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08195"></a>08195 
<a name="l08196"></a>08196     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l08197"></a>08197 }
<a name="l08198"></a>08198 
<a name="l08199"></a>08199 
<a name="l08200"></a>08200 
<a name="l08201"></a>08201 
<a name="l08202"></a>08202 
<a name="l08203"></a>08203 <span class="comment">// -----------------------------------------------------</span>
<a name="l08204"></a>08204 <span class="comment">// ISSUE BASKET CREATION REQUEST (to server.)</span>
<a name="l08205"></a>08205 <span class="comment">//</span>
<a name="l08206"></a><a class="code" href="class_o_t___a_p_i.html#ab691e0c2f1b8728b31babf07d958168a">08206</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ab691e0c2f1b8728b31babf07d958168a">OT_API::issueBasket</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l08207"></a>08207                          <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID,
<a name="l08208"></a>08208                          <a class="code" href="class_o_t_string.html">OTString</a>       &amp; BASKET_INFO)
<a name="l08209"></a>08209 {
<a name="l08210"></a>08210     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::issueBasket&quot;</span>;
<a name="l08211"></a>08211     <span class="comment">// -----------------------------------------------------</span>
<a name="l08212"></a>08212     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l08213"></a>08213     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l08214"></a>08214     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08215"></a>08215     <span class="comment">// -----------------------------------------------------</span>
<a name="l08216"></a>08216     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>    * pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName);
<a name="l08217"></a>08217     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l08218"></a>08218     <span class="comment">// -------------------------------------------------------------</span>
<a name="l08219"></a>08219     <span class="comment">// AT SOME POINT, BASKET_INFO has been populated with the relevant data. (see test client for example.)</span>
<a name="l08220"></a>08220     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l08221"></a>08221 
<a name="l08222"></a>08222     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l08223"></a>08223     int64_t lRequestNumber = 0;
<a name="l08224"></a>08224 
<a name="l08225"></a>08225     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08226"></a>08226     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08227"></a>08227     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08228"></a>08228     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08229"></a>08229 
<a name="l08230"></a>08230     <span class="comment">// (1) Set up member variables</span>
<a name="l08231"></a>08231     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueBasket&quot;</span>;
<a name="l08232"></a>08232     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08233"></a>08233     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08234"></a>08234     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08235"></a>08235 
<a name="l08236"></a>08236     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(BASKET_INFO);
<a name="l08237"></a>08237 
<a name="l08238"></a>08238     <span class="comment">// (2) Sign the Message</span>
<a name="l08239"></a>08239     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l08240"></a>08240 
<a name="l08241"></a>08241     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08242"></a>08242     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08243"></a>08243 
<a name="l08244"></a>08244     <span class="comment">// (Send it)</span>
<a name="l08245"></a>08245     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l08246"></a>08246     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l08247"></a>08247 
<a name="l08248"></a>08248     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l08249"></a>08249 }
<a name="l08250"></a>08250 
<a name="l08251"></a>08251 
<a name="l08252"></a>08252 
<a name="l08253"></a>08253 
<a name="l08254"></a>08254 <span class="comment">// ---------------------------------------------------------------</span>
<a name="l08255"></a>08255 <span class="comment">// GENERATE BASKET EXCHANGE REQUEST</span>
<a name="l08256"></a>08256 <span class="comment">//</span>
<a name="l08257"></a>08257 <span class="comment">// Creates a new request (for exchanging funds in/out of a Basket).</span>
<a name="l08258"></a>08258 <span class="comment">// (Each currency in this request will be added with</span>
<a name="l08259"></a>08259 <span class="comment">// subsequent calls to OT_API::GenerateBasketItem()).</span>
<a name="l08260"></a>08260 <span class="comment">//</span>
<a name="l08261"></a>08261 <span class="comment">// (Caller is responsible to delete.)</span>
<a name="l08262"></a>08262 <span class="comment">//</span>
<a name="l08263"></a><a class="code" href="class_o_t___a_p_i.html#a25e69e50ec485944c6031a5a9511e570">08263</a> <a class="code" href="class_o_t_basket.html">OTBasket</a> * <a class="code" href="class_o_t___a_p_i.html#a25e69e50ec485944c6031a5a9511e570">OT_API::GenerateBasketExchange</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l08264"></a>08264                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l08265"></a>08265                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_TYPE_ID,
<a name="l08266"></a>08266                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_ACCT_ID,
<a name="l08267"></a>08267                                           <span class="keyword">const</span> int32_t TRANSFER_MULTIPLE)  <span class="comment">// 1            2            3</span>
<a name="l08268"></a>08268 {                                                                       <span class="comment">// 5=2,3,4  OR  10=4,6,8  OR 15=6,9,12</span>
<a name="l08269"></a>08269     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::GenerateBasketExchange&quot;</span>;
<a name="l08270"></a>08270     <span class="comment">// -----------------------------------------------------</span>
<a name="l08271"></a>08271     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l08272"></a>08272     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> NULL;
<a name="l08273"></a>08273     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08274"></a>08274     <span class="comment">// -----------------------------------------------------</span>
<a name="l08275"></a>08275     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_TYPE_ID, szFuncName);
<a name="l08276"></a>08276     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> NULL;
<a name="l08277"></a>08277     <span class="comment">// By this point, pContract is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08278"></a>08278     <span class="comment">// -----------------------------------------------------</span>
<a name="l08279"></a>08279     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, BASKET_ASSET_ACCT_ID, SERVER_ID, szFuncName);
<a name="l08280"></a>08280     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> NULL;
<a name="l08281"></a>08281     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08282"></a>08282     <span class="comment">// -----------------------------------------------------</span>
<a name="l08283"></a>08283     <span class="keywordflow">if</span> (BASKET_ASSET_TYPE_ID != pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
<a name="l08284"></a>08284     {
<a name="l08285"></a>08285         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAcctID(BASKET_ASSET_ACCT_ID), strAcctTypeID(BASKET_ASSET_TYPE_ID);
<a name="l08286"></a>08286         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::GenerateBasketExchange: Wrong asset type ID on account %s (expected type to be %s)\n&quot;</span>,
<a name="l08287"></a>08287                        strAcctID.Get(), strAcctTypeID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08288"></a>08288         <span class="keywordflow">return</span> NULL;
<a name="l08289"></a>08289     }
<a name="l08290"></a>08290     <span class="comment">// By this point, I know that everything checks out. Signature and Account ID.</span>
<a name="l08291"></a>08291     <span class="comment">// pAccount is good, and no need to clean it up.</span>
<a name="l08292"></a>08292     <span class="comment">// -----------------------------------------------------</span>
<a name="l08293"></a>08293     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l08294"></a>08294 
<a name="l08295"></a>08295     int32_t nTransferMultiple = 1;
<a name="l08296"></a>08296 
<a name="l08297"></a>08297     <span class="keywordflow">if</span> (TRANSFER_MULTIPLE &gt; 0)
<a name="l08298"></a>08298         nTransferMultiple = TRANSFER_MULTIPLE;
<a name="l08299"></a>08299     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l08300"></a>08300 
<a name="l08301"></a>08301     <span class="comment">// Next load the OTBasket object out of that contract.</span>
<a name="l08302"></a>08302     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket;
<a name="l08303"></a>08303     <a class="code" href="class_o_t_basket.html">OTBasket</a> * pRequestBasket = NULL;
<a name="l08304"></a>08304 
<a name="l08305"></a>08305     <span class="comment">// todo perhaps verify the basket here, even though I already verified the asset contract itself...</span>
<a name="l08306"></a>08306     <span class="comment">// Can&#39;t never be too sure.</span>
<a name="l08307"></a>08307     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()))
<a name="l08308"></a>08308     {
<a name="l08309"></a>08309         <span class="comment">// We need a transaction number just to send this thing. Plus, we need a number for</span>
<a name="l08310"></a>08310         <span class="comment">// each sub-account to the basket, as well as the basket&#39;s main account.</span>
<a name="l08311"></a>08311         <span class="comment">// That is: 1 + theBasket.Count() + 1</span>
<a name="l08312"></a>08312         <span class="comment">//</span>
<a name="l08313"></a>08313         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &lt; (2 + theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>()))
<a name="l08314"></a>08314         {
<a name="l08315"></a>08315             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::GenerateBasketExchange: you don&#39;t have enough transaction numbers to perform the exchange.\n&quot;</span>);
<a name="l08316"></a>08316         }
<a name="l08317"></a>08317         <span class="keywordflow">else</span>
<a name="l08318"></a>08318         {
<a name="l08319"></a>08319             pRequestBasket = <span class="keyword">new</span> <a class="code" href="class_o_t_basket.html">OTBasket</a>(theBasket.<a class="code" href="class_o_t_basket.html#a8234fefd66082303036b655db2f3311d">Count</a>(), theBasket.<a class="code" href="class_o_t_basket.html#a06047122ac95a121a90a34ea5cebb4b4">GetMinimumTransfer</a>());
<a name="l08320"></a>08320             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pRequestBasket, <span class="stringliteral">&quot;OT_API::GenerateBasketExchange: Error allocating memory in the OT API&quot;</span>);
<a name="l08321"></a>08321 
<a name="l08322"></a>08322             pRequestBasket-&gt;<a class="code" href="class_o_t_basket.html#a5096e84f09a66198309f5cffb959c594">SetTransferMultiple</a>(nTransferMultiple); <span class="comment">// This stays in this function.</span>
<a name="l08323"></a>08323 
<a name="l08324"></a>08324             <span class="comment">// Make sure the server knows where to put my new basket currency funds,</span>
<a name="l08325"></a>08325             <span class="comment">// once the exchange is done.</span>
<a name="l08326"></a>08326             pRequestBasket-&gt;<a class="code" href="class_o_t_basket.html#a9e03d1f4702fb061b315a4d96666850d">SetRequestAccountID</a>(BASKET_ASSET_ACCT_ID); <span class="comment">// This stays too</span>
<a name="l08327"></a>08327 
<a name="l08328"></a>08328             <span class="comment">// Export the OTBasket object into a string, add it as</span>
<a name="l08329"></a>08329             <span class="comment">// a payload on my request, and send to server.</span>
<a name="l08330"></a>08330             pRequestBasket-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08331"></a>08331             pRequestBasket-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08332"></a>08332         } <span class="comment">// *pNym apparently has enough transaction numbers to exchange the basket.</span>
<a name="l08333"></a>08333         <span class="comment">// ----------------------------------------------------------------</span>
<a name="l08334"></a>08334     }
<a name="l08335"></a>08335     <span class="keywordflow">else</span>
<a name="l08336"></a>08336     {
<a name="l08337"></a>08337         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::GenerateBasketExchange: Error loading &quot;</span>
<a name="l08338"></a>08338                       <span class="stringliteral">&quot;basket info from asset contract. &quot;</span>
<a name="l08339"></a>08339                       <span class="stringliteral">&quot;Are you SURE this is a basket currency?\n&quot;</span>);
<a name="l08340"></a>08340         <span class="keywordflow">return</span> NULL;
<a name="l08341"></a>08341     }
<a name="l08342"></a>08342     <span class="keywordflow">return</span> pRequestBasket;
<a name="l08343"></a>08343 }
<a name="l08344"></a>08344 
<a name="l08345"></a>08345 
<a name="l08346"></a>08346 
<a name="l08347"></a>08347 
<a name="l08348"></a>08348 
<a name="l08349"></a>08349 
<a name="l08350"></a>08350 
<a name="l08351"></a>08351 <span class="comment">// --------------------------------------------------------</span>
<a name="l08352"></a>08352 <span class="comment">// ADD BASKET EXCHANGE ITEM</span>
<a name="l08353"></a>08353 <span class="comment">//</span>
<a name="l08354"></a><a class="code" href="class_o_t___a_p_i.html#a9257737bcd43f36e8426b5d5bfb67a7b">08354</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a9257737bcd43f36e8426b5d5bfb67a7b">OT_API::AddBasketExchangeItem</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l08355"></a>08355                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l08356"></a>08356                                    <a class="code" href="class_o_t_basket.html">OTBasket</a> &amp; theBasket,
<a name="l08357"></a>08357                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID,
<a name="l08358"></a>08358                                    <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ACCT_ID)
<a name="l08359"></a>08359 {
<a name="l08360"></a>08360     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::AddBasketExchangeItem&quot;</span>;
<a name="l08361"></a>08361     <span class="comment">// -----------------------------------------------------</span>
<a name="l08362"></a>08362     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l08363"></a>08363     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08364"></a>08364     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08365"></a>08365     <span class="comment">// -----------------------------------------------------</span>
<a name="l08366"></a>08366     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(ASSET_TYPE_ID, szFuncName);
<a name="l08367"></a>08367     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08368"></a>08368     <span class="comment">// By this point, pContract is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08369"></a>08369     <span class="comment">// -----------------------------------------------------</span>
<a name="l08370"></a>08370     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ASSET_ACCT_ID, SERVER_ID, szFuncName);
<a name="l08371"></a>08371     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08372"></a>08372     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08373"></a>08373     <span class="comment">// -----------------------------------------------------</span>
<a name="l08374"></a>08374     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &lt; 1)
<a name="l08375"></a>08375     {
<a name="l08376"></a>08376         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::AddBasketExchangeItem: you need at least one transaction number to add this exchange item.\n&quot;</span>);
<a name="l08377"></a>08377         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08378"></a>08378     }
<a name="l08379"></a>08379     <span class="comment">// -----------------------------------------------------</span>
<a name="l08380"></a>08380     <span class="keywordflow">if</span> (ASSET_TYPE_ID != pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>())
<a name="l08381"></a>08381     {
<a name="l08382"></a>08382         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID(ASSET_TYPE_ID), strAcctID(ASSET_ACCT_ID);
<a name="l08383"></a>08383         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::AddBasketExchangeItem: Wrong asset type ID on account %s (expected to find asset type %s)\n&quot;</span>,
<a name="l08384"></a>08384                        strAcctID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strAssetTypeID.Get());
<a name="l08385"></a>08385         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08386"></a>08386     }
<a name="l08387"></a>08387     <span class="comment">// By this point, I know that everything checks out. Signature and Account ID.</span>
<a name="l08388"></a>08388     <span class="comment">// pAccount is good, and no need to clean it up.</span>
<a name="l08389"></a>08389     <span class="comment">// ----------------------------------------------------</span>
<a name="l08390"></a>08390     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l08391"></a>08391 
<a name="l08392"></a>08392     int64_t lSubClosingTransactionNo = 0; <span class="comment">// For the basketReceipt (closing transaction num) for the sub account.</span>
<a name="l08393"></a>08393 
<a name="l08394"></a>08394     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lSubClosingTransactionNo)) <span class="comment">// this saves</span>
<a name="l08395"></a>08395     <span class="comment">// ---------------------------------------------------</span>
<a name="l08396"></a>08396     {
<a name="l08397"></a>08397         theBasket.<a class="code" href="class_o_t_basket.html#a040522b77565e6349a11ec127089c904">AddRequestSubContract</a>(ASSET_TYPE_ID, ASSET_ACCT_ID, lSubClosingTransactionNo);
<a name="l08398"></a>08398 
<a name="l08399"></a>08399         theBasket.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08400"></a>08400         theBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08401"></a>08401         theBasket.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08402"></a>08402 
<a name="l08403"></a>08403         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l08404"></a>08404     }
<a name="l08405"></a>08405     <span class="keywordflow">else</span>
<a name="l08406"></a>08406         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::AddBasketExchangeItem: Failed getting next transaction number. \n&quot;</span>);
<a name="l08407"></a>08407 
<a name="l08408"></a>08408     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08409"></a>08409 }
<a name="l08410"></a>08410 
<a name="l08411"></a>08411 <span class="comment">// ------------------------------------------------------</span>
<a name="l08412"></a>08412 
<a name="l08413"></a>08413 
<a name="l08414"></a>08414 
<a name="l08415"></a>08415 
<a name="l08416"></a>08416 
<a name="l08417"></a>08417 <span class="comment">// TODO!  Either stop getting the next transaction numbers above, and do it all in a big</span>
<a name="l08418"></a>08418 <span class="comment">// loop in the next function below, OR, provide a way to harvest those numbers back again</span>
<a name="l08419"></a>08419 <span class="comment">// in the event of error (ugh.)</span>
<a name="l08420"></a>08420 <span class="comment">//</span>
<a name="l08421"></a>08421 
<a name="l08422"></a>08422 <span class="comment">// TODO: It was a mistake to only drop Nymbox notices for successful messages.</span>
<a name="l08423"></a>08423 <span class="comment">// If the client misses a failure message, the client will then fail to claw back</span>
<a name="l08424"></a>08424 <span class="comment">// his transaction numbers from that failure. For transactions, at least, failure</span>
<a name="l08425"></a>08425 <span class="comment">// notices should also be dropped.</span>
<a name="l08426"></a>08426 
<a name="l08427"></a>08427 <span class="comment">// BUT perhaps we can avoid many failure notices, by nipping things in the bud. For</span>
<a name="l08428"></a>08428 <span class="comment">// example, if the NymboxHash is wrong, we can reject transactions before even the</span>
<a name="l08429"></a>08429 <span class="comment">// opening number is burned (similar to rejecting messages based on bad request #.)</span>
<a name="l08430"></a>08430 <span class="comment">// This &quot;message level&quot; rejection allows the client to claw-back or re-try, without</span>
<a name="l08431"></a>08431 <span class="comment">// the pain of having burned SOME numbers while others are still good (and then</span>
<a name="l08432"></a>08432 <span class="comment">// having to reconcile that mess to get back into sync.)</span>
<a name="l08433"></a>08433 
<a name="l08434"></a>08434 
<a name="l08435"></a>08435 <span class="comment">// Some notes on TRANSACTION NUMBERS:</span>
<a name="l08436"></a>08436 <span class="comment">/*</span>
<a name="l08437"></a>08437 <span class="comment"> 1. You must BURN a number even to ATTEMPT a transaction.</span>
<a name="l08438"></a>08438 <span class="comment"></span>
<a name="l08439"></a>08439 <span class="comment"> 2. However, remember that OT has messages, and those messages contain transactions.</span>
<a name="l08440"></a>08440 <span class="comment">    A message might fail due to out-of-sync request number, meaning it was cut off</span>
<a name="l08441"></a>08441 <span class="comment">    before even having a chance to call the NotarizeTransactions code.</span>
<a name="l08442"></a>08442 <span class="comment"></span>
<a name="l08443"></a>08443 <span class="comment"> 3. If the message failed, that means the transaction has not yet even been tried, so</span>
<a name="l08444"></a>08444 <span class="comment">    the number on it is still good. (You can re-send the message.)</span>
<a name="l08445"></a>08445 <span class="comment"></span>
<a name="l08446"></a>08446 <span class="comment"> 4. But if the message succeeded, then the transaction itself requires 2 steps:</span>
<a name="l08447"></a>08447 <span class="comment">    the balance agreement, and the transaction itself.</span>
<a name="l08448"></a>08448 <span class="comment"></span>
<a name="l08449"></a>08449 <span class="comment"> 5. If the balance agreement or transaction fails, then the primary transaction # has been burned.</span>
<a name="l08450"></a>08450 <span class="comment">    BUT there may be OTHER transaction numbers that are STILL good. The closing numbers, etc.</span>
<a name="l08451"></a>08451 <span class="comment"></span>
<a name="l08452"></a>08452 <span class="comment"> 6. The OTHER numbers are only burned if the transaction is a SUCCESS.</span>
<a name="l08453"></a>08453 <span class="comment"></span>
<a name="l08454"></a>08454 <span class="comment"></span>
<a name="l08455"></a>08455 <span class="comment"> Therefore:</span>
<a name="l08456"></a>08456 <span class="comment"> -- If the message fails, we can re-sync and re-try. All trans #s are still good.</span>
<a name="l08457"></a>08457 <span class="comment"> -- If the message succeeds, but balance agreement fails, or the transaction fails,</span>
<a name="l08458"></a>08458 <span class="comment">    then the primary transaction # is burned, but any additional numbers are still good.</span>
<a name="l08459"></a>08459 <span class="comment"> -- If the transaction itself succeeds, then ALL numbers are burned.</span>
<a name="l08460"></a>08460 <span class="comment"></span>
<a name="l08461"></a>08461 <span class="comment"> OT Client, if the MESSAGE was a failure, MUST re-send it, or claw back the numbers, since</span>
<a name="l08462"></a>08462 <span class="comment"> they are all still good, even the primary #. (This is only if an EXPLICIT message failure</span>
<a name="l08463"></a>08463 <span class="comment"> is received. A null reply could mean it was SUCCESSFUL but we just didn&#39;t SEE that success</span>
<a name="l08464"></a>08464 <span class="comment"> because we never got the reply! In that case, we do NOT want to re-try, nor do we want to</span>
<a name="l08465"></a>08465 <span class="comment"> claw the numbers back.)</span>
<a name="l08466"></a>08466 <span class="comment"></span>
<a name="l08467"></a>08467 <span class="comment"> Thus OT client, as long as the MESSAGE was a success, can operate based on the assumption</span>
<a name="l08468"></a>08468 <span class="comment"> that the primary transaction number IS burned, whether the transaction itself was successful</span>
<a name="l08469"></a>08469 <span class="comment"> or not.</span>
<a name="l08470"></a>08470 <span class="comment"></span>
<a name="l08471"></a>08471 <span class="comment"> OT client also assumes the other numbers are burned as well, UNLESS IT RECEIVES A FAILURE REPLY.</span>
<a name="l08472"></a>08472 <span class="comment"> If an explicit transaction failure is received, then OT client can CLAW BACK all of the transaction</span>
<a name="l08473"></a>08473 <span class="comment"> numbers EXCEPT the primary one.</span>
<a name="l08474"></a>08474 <span class="comment"></span>
<a name="l08475"></a>08475 <span class="comment"> OT MUST SEE THE FAILURE MESSAGES -- AT LEAST FOR TRANSACTIONS!</span>
<a name="l08476"></a>08476 <span class="comment"> What if:</span>
<a name="l08477"></a>08477 <span class="comment"></span>
<a name="l08478"></a>08478 <span class="comment"> What if I try a TRANSACTION, and fail to receive the server reply?</span>
<a name="l08479"></a>08479 <span class="comment"> Potentialities:</span>
<a name="l08480"></a>08480 <span class="comment"></span>
<a name="l08481"></a>08481 <span class="comment"> 1. Message was a failure. (No numbers are burned.)</span>
<a name="l08482"></a>08482 <span class="comment"> 2. Message was success but balance agreement was a failure.</span>
<a name="l08483"></a>08483 <span class="comment">    (The opening # was burned, but the others are still good.)</span>
<a name="l08484"></a>08484 <span class="comment"> 3. Message and balance agreement were both success, but transaction itself failed.</span>
<a name="l08485"></a>08485 <span class="comment">    (The opening # was burned, but the others are still good.)</span>
<a name="l08486"></a>08486 <span class="comment"> 4. Message, balance agreement, and transaction were all a success.</span>
<a name="l08487"></a>08487 <span class="comment">    (ALL transaction #s on the message are burned.)</span>
<a name="l08488"></a>08488 <span class="comment"></span>
<a name="l08489"></a>08489 <span class="comment"></span>
<a name="l08490"></a>08490 <span class="comment"> Currently:</span>
<a name="l08491"></a>08491 <span class="comment"> 1. If I don&#39;t receive this failure message, then I resend, which would basically work since the numbers are all still good.</span>
<a name="l08492"></a>08492 <span class="comment">    BUT IN THE CASE OF EXCHANGE BASKET, IT FUCKING GRABS A NEW NUMBER EACH CALL!  So when OTAPI_Func retries, it grabs a new one each time.</span>
<a name="l08493"></a>08493 <span class="comment">    (Instead of just using the ones that are still good.)</span>
<a name="l08494"></a>08494 <span class="comment"></span>
<a name="l08495"></a>08495 <span class="comment"> 2. If I miss this success reply, or treat the null as a failure, then I will end up re-trying a transaction</span>
<a name="l08496"></a>08496 <span class="comment">    that has no prayer of working, since its opening # is already burned. I&#39;ll also fail to claw back my numbers, which are mostly still good.</span>
<a name="l08497"></a>08497 <span class="comment"></span>
<a name="l08498"></a>08498 <span class="comment"> 3. If I miss this success reply, or treat the null as a failure, then I will end up re-trying a transaction</span>
<a name="l08499"></a>08499 <span class="comment">    that has no prayer of working, since its opening # is already burned. I&#39;ll also fail to claw back my numbers, which are mostly still good.</span>
<a name="l08500"></a>08500 <span class="comment"></span>
<a name="l08501"></a>08501 <span class="comment"> 4. If I miss this success reply, the numbers are all burned on both sides, but I don&#39;t KNOW that, and though I correctly believe the numbers</span>
<a name="l08502"></a>08502 <span class="comment">    are all burned, I also end up CONTINUING to re-try the message, which fails every time, since it was already a success and the numbers are</span>
<a name="l08503"></a>08503 <span class="comment">    all burned already.</span>
<a name="l08504"></a>08504 <span class="comment"> ----------------------------------</span>
<a name="l08505"></a>08505 <span class="comment"></span>
<a name="l08506"></a>08506 <span class="comment"> Therefore, the new solutions...</span>
<a name="l08507"></a>08507 <span class="comment"></span>
<a name="l08508"></a>08508 <span class="comment"></span>
<a name="l08509"></a>08509 <span class="comment"></span>
<a name="l08510"></a>08510 <span class="comment"> --------------------------------------------------</span>
<a name="l08511"></a>08511 <span class="comment"></span>
<a name="l08512"></a>08512 <span class="comment"></span>
<a name="l08513"></a>08513 <span class="comment"></span>
<a name="l08514"></a>08514 <span class="comment"></span>
<a name="l08515"></a>08515 <span class="comment"> */</span>
<a name="l08516"></a>08516 
<a name="l08517"></a>08517 
<a name="l08518"></a>08518 
<a name="l08519"></a>08519 <span class="comment">// -----------------------------------------------------</span>
<a name="l08520"></a>08520 <span class="comment">// EXCHANGE (into or out of) BASKET (request to server.)</span>
<a name="l08521"></a>08521 <span class="comment">//</span>
<a name="l08522"></a><a class="code" href="class_o_t___a_p_i.html#aac6fa94e53c2fd89cd398965282be272">08522</a> int32_t <a class="code" href="class_o_t___a_p_i.html#aac6fa94e53c2fd89cd398965282be272">OT_API::exchangeBasket</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l08523"></a>08523                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; USER_ID,
<a name="l08524"></a>08524                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; BASKET_ASSET_ID,
<a name="l08525"></a>08525                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; BASKET_INFO,
<a name="l08526"></a>08526                             <span class="comment">// ----------------------------------------</span>
<a name="l08527"></a>08527                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bExchangeInOrOut <span class="comment">// exchanging in == true, out == false.</span>
<a name="l08528"></a>08528                             <span class="comment">// ----------------------------------------</span>
<a name="l08529"></a>08529                             )
<a name="l08530"></a>08530 {
<a name="l08531"></a>08531     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::exchangeBasket&quot;</span>;
<a name="l08532"></a>08532     <span class="comment">// -----------------------------------------------------</span>
<a name="l08533"></a>08533     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l08534"></a>08534     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l08535"></a>08535     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08536"></a>08536     <span class="comment">// -----------------------------------------------------</span>
<a name="l08537"></a>08537     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l08538"></a>08538     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l08539"></a>08539     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l08540"></a>08540     <span class="comment">// -----------------------------------------------------</span>
<a name="l08541"></a>08541     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(BASKET_ASSET_ID, szFuncName);
<a name="l08542"></a>08542     <span class="keywordflow">if</span> (NULL == pContract) <span class="keywordflow">return</span> (-1);
<a name="l08543"></a>08543     <span class="comment">// By this point, pContract is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08544"></a>08544     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l08545"></a>08545     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strUserID(USER_ID);
<a name="l08546"></a>08546 
<a name="l08547"></a>08547     <span class="comment">// Next load the OTBasket object out of that contract, and load the RequestBasket object that was passed in.</span>
<a name="l08548"></a>08548     <a class="code" href="class_o_t_basket.html">OTBasket</a> theBasket, theRequestBasket;
<a name="l08549"></a>08549 
<a name="l08550"></a>08550     <span class="keywordflow">if</span> (pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>().<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()  &amp;&amp; theBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(pContract-&gt;<a class="code" href="class_o_t_asset_contract.html#ac30a534d3a53b5e4e8998a4dd1f325a9">GetBasketInfo</a>()) &amp;&amp;
<a name="l08551"></a>08551         BASKET_INFO.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()                 &amp;&amp; theRequestBasket.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(BASKET_INFO))
<a name="l08552"></a>08552     {
<a name="l08553"></a>08553         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; BASKET_ASSET_ACCT_ID(theRequestBasket.<a class="code" href="class_o_t_basket.html#ab555be54ac5511072afefe94ee15105a">GetRequestAccountID</a>());
<a name="l08554"></a>08554         <span class="comment">// -------------------------------------------------------------------------</span>
<a name="l08555"></a>08555         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, BASKET_ASSET_ACCT_ID, SERVER_ID, szFuncName);
<a name="l08556"></a>08556         <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l08557"></a>08557 
<a name="l08558"></a>08558         <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08559"></a>08559         <span class="comment">// -----------------------------------------------------</span>
<a name="l08560"></a>08560         <span class="comment">// We need a transaction number just to send this thing. Plus, we need a number for</span>
<a name="l08561"></a>08561         <span class="comment">// each sub-account to the basket, as well as the basket&#39;s main account.</span>
<a name="l08562"></a>08562         <span class="comment">// That is: 1 + theBasket.Count() + 1</span>
<a name="l08563"></a>08563         <span class="comment">// Total of 2, since theBasket.Count() worth of numbers were already added in the</span>
<a name="l08564"></a>08564         <span class="comment">// calls to OT_API::AddBasketExchangeItem.</span>
<a name="l08565"></a>08565 
<a name="l08566"></a>08566         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID) &lt; 2)
<a name="l08567"></a>08567         {
<a name="l08568"></a>08568             <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::exchangeBasket: you don&#39;t have enough transaction numbers to perform the exchange.\n&quot;</span>);
<a name="l08569"></a>08569         }
<a name="l08570"></a>08570         <span class="keywordflow">else</span>
<a name="l08571"></a>08571         {
<a name="l08572"></a>08572             int64_t lStoredTransactionNumber=0;
<a name="l08573"></a>08573             <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber); <span class="comment">// this saves</span>
<a name="l08574"></a>08574 
<a name="l08575"></a>08575             <span class="keywordflow">if</span> (bGotTransNum)
<a name="l08576"></a>08576             {
<a name="l08577"></a>08577                 <span class="comment">// ----------------------------------------------------</span>
<a name="l08578"></a>08578                 <span class="comment">// LOAD the INBOX for the MAIN ACCOUNT</span>
<a name="l08579"></a>08579                 <span class="comment">//</span>
<a name="l08580"></a>08580                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#a383560406c46ae01bc5992c4928b45b6">LoadInbox</a>(*pNym);
<a name="l08581"></a>08581                 <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_ledger.html#afa28a4e35a57fa01a8062b608102ddf4">LoadOutbox</a>(*pNym);
<a name="l08582"></a>08582 
<a name="l08583"></a>08583                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l08584"></a>08584                 <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l08585"></a>08585 
<a name="l08586"></a>08586                 <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l08587"></a>08587                 {
<a name="l08588"></a>08588                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::exchangeBasket: Failed loading inbox!\n&quot;</span>);
<a name="l08589"></a>08589 
<a name="l08590"></a>08590                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08591"></a>08591                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08592"></a>08592                 }
<a name="l08593"></a>08593                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l08594"></a>08594                 {
<a name="l08595"></a>08595                     <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::exchangeBasket: Failed loading outbox!\n&quot;</span>);
<a name="l08596"></a>08596 
<a name="l08597"></a>08597                     <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l08598"></a>08598                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l08599"></a>08599                 }
<a name="l08600"></a>08600                 <span class="comment">// Set up the Request Basket! ------------------------------</span>
<a name="l08601"></a>08601                 <span class="keywordflow">else</span>
<a name="l08602"></a>08602                 {
<a name="l08603"></a>08603                     <span class="comment">// Create a transaction</span>
<a name="l08604"></a>08604                     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction =
<a name="l08605"></a>08605                         <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, BASKET_ASSET_ACCT_ID, SERVER_ID,
<a name="l08606"></a>08606                                                             <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b518796457aa29ef96cccc2c861726a">OTTransaction::exchangeBasket</a>, lStoredTransactionNumber);
<a name="l08607"></a>08607 
<a name="l08608"></a>08608                     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l08609"></a>08609                     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a1332f32813f158436fd58abdddec855c">OTItem::exchangeBasket</a>);
<a name="l08610"></a>08610 
<a name="l08611"></a>08611                     <span class="comment">// This pItem is where the Basket Info will be stored. (So it ends up on receipts...)</span>
<a name="l08612"></a>08612                     pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l08613"></a>08613 
<a name="l08614"></a>08614                     <span class="comment">// --------------------------------------------------</span>
<a name="l08615"></a>08615                     <span class="comment">// NOTE: I&#39;m not checking this call for success...</span>
<a name="l08616"></a>08616                     <span class="comment">// But, I DID check the count beforehand, and I know there are enough numbers.</span>
<a name="l08617"></a>08617                     <span class="comment">//</span>
<a name="l08618"></a>08618                     int64_t lClosingTransactionNo = 0; <span class="comment">// for Main Basket Acct on the Request Basket.</span>
<a name="l08619"></a>08619                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lClosingTransactionNo)); <span class="comment">// this saves</span>
<a name="l08620"></a>08620 
<a name="l08621"></a>08621                     <span class="comment">// This goes in the final API call.</span>
<a name="l08622"></a>08622                     theRequestBasket.<a class="code" href="class_o_t_basket.html#aa7bc47e877c208f308f7fc476728cee8">SetClosingNum</a>(lClosingTransactionNo); <span class="comment">// For the basketReceipt (Closing Transaction Num) for main account.</span>
<a name="l08623"></a>08623                     <span class="comment">// -----------------------------------------------------------</span>
<a name="l08624"></a>08624 
<a name="l08625"></a>08625                     <span class="comment">// This goes in the final API call.</span>
<a name="l08626"></a>08626                     theRequestBasket.<a class="code" href="class_o_t_basket.html#a75757d74f9e52043611a7ac6bedcb362">SetExchangingIn</a>(bExchangeInOrOut);
<a name="l08627"></a>08627 
<a name="l08628"></a>08628                     <span class="comment">// -----------------------------------------------------------</span>
<a name="l08629"></a>08629                     theRequestBasket.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08630"></a>08630                     theRequestBasket.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08631"></a>08631                     theRequestBasket.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08632"></a>08632 
<a name="l08633"></a>08633                     <span class="comment">// Export the OTBasket object into a string, add it as</span>
<a name="l08634"></a>08634                     <span class="comment">// a payload on my request, and send to server.</span>
<a name="l08635"></a>08635                     <a class="code" href="class_o_t_string.html">OTString</a> strBasketInfo;
<a name="l08636"></a>08636                     theRequestBasket.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strBasketInfo);
<a name="l08637"></a>08637 
<a name="l08638"></a>08638                     <span class="comment">//***********************************************************************</span>
<a name="l08639"></a>08639 
<a name="l08640"></a>08640                     pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strBasketInfo);
<a name="l08641"></a>08641 
<a name="l08642"></a>08642                     <span class="comment">// sign the item. save it.</span>
<a name="l08643"></a>08643                     <span class="comment">//</span>
<a name="l08644"></a>08644                     pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08645"></a>08645                     pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08646"></a>08646 
<a name="l08647"></a>08647                     <span class="comment">//***********************************************************************</span>
<a name="l08648"></a>08648 
<a name="l08649"></a>08649                     <span class="comment">// ---------------------------------------------</span>
<a name="l08650"></a>08650                     <span class="comment">// BALANCE AGREEMENT!</span>
<a name="l08651"></a>08651                     <span class="comment">//</span>
<a name="l08652"></a>08652                     <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l08653"></a>08653                     <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(0, <span class="comment">// Change in balance is 0. (The accounts will all be changed,</span>
<a name="l08654"></a>08654                             *pTransaction, *pNym, *pAccount, *pOutbox);         <span class="comment">// but basketReceipts will be used to account for it.)</span>
<a name="l08655"></a>08655 
<a name="l08656"></a>08656                     <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l08657"></a>08657                         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l08658"></a>08658                     <span class="comment">// ---------------------------------------------</span>
<a name="l08659"></a>08659 
<a name="l08660"></a>08660                     <span class="comment">// sign the transaction</span>
<a name="l08661"></a>08661                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08662"></a>08662                     pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08663"></a>08663 
<a name="l08664"></a>08664                     <span class="comment">// set up the ledger</span>
<a name="l08665"></a>08665                     <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, BASKET_ASSET_ACCT_ID, SERVER_ID);
<a name="l08666"></a>08666                     theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(BASKET_ASSET_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l08667"></a>08667                     theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l08668"></a>08668 
<a name="l08669"></a>08669                     <span class="comment">// sign the ledger</span>
<a name="l08670"></a>08670                     theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08671"></a>08671                     theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08672"></a>08672 
<a name="l08673"></a>08673                     <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l08674"></a>08674                     <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l08675"></a>08675                     <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l08676"></a>08676 
<a name="l08677"></a>08677                     <span class="comment">// Encoding...</span>
<a name="l08678"></a>08678                     ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l08679"></a>08679 
<a name="l08680"></a>08680                     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l08681"></a>08681 
<a name="l08682"></a>08682                     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08683"></a>08683                     int64_t lRequestNumber=0;
<a name="l08684"></a>08684                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08685"></a>08685                     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08686"></a>08686                     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08687"></a>08687 
<a name="l08688"></a>08688                     <span class="comment">// (1) Set up member variables</span>
<a name="l08689"></a>08689                     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l08690"></a>08690                     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strUserID;
<a name="l08691"></a>08691                     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08692"></a>08692                     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08693"></a>08693 
<a name="l08694"></a>08694                     BASKET_ASSET_ACCT_ID.GetString(theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l08695"></a>08695                     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l08696"></a>08696 
<a name="l08697"></a>08697                     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l08698"></a>08698                     <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l08699"></a>08699                     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l08700"></a>08700                     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l08701"></a>08701 
<a name="l08702"></a>08702                     <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l08703"></a>08703                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l08704"></a>08704                                       str_server.c_str());
<a name="l08705"></a>08705 
<a name="l08706"></a>08706                     <span class="comment">// (2) Sign the Message</span>
<a name="l08707"></a>08707                     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l08708"></a>08708 
<a name="l08709"></a>08709                     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l08710"></a>08710                     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08711"></a>08711 
<a name="l08712"></a>08712                     <span class="comment">// (Send it)</span>
<a name="l08713"></a>08713                     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l08714"></a>08714                     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l08715"></a>08715 
<a name="l08716"></a>08716                     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l08717"></a>08717                 } <span class="comment">// Inbox loaded.</span>
<a name="l08718"></a>08718             } <span class="comment">// successfully got first transaction number.</span>
<a name="l08719"></a>08719         }
<a name="l08720"></a>08720     }
<a name="l08721"></a>08721 
<a name="l08722"></a>08722     <span class="keywordflow">return</span> (-1);
<a name="l08723"></a>08723 }
<a name="l08724"></a>08724 
<a name="l08725"></a>08725 
<a name="l08726"></a>08726 
<a name="l08727"></a>08727 
<a name="l08728"></a>08728 
<a name="l08729"></a><a class="code" href="class_o_t___a_p_i.html#afd2344eb8007c310ada18aaafa70eb67">08729</a> int32_t <a class="code" href="class_o_t___a_p_i.html#afd2344eb8007c310ada18aaafa70eb67">OT_API::getTransactionNumber</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l08730"></a>08730                                   <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l08731"></a>08731 {
<a name="l08732"></a>08732     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getTransactionNumber&quot;</span>;
<a name="l08733"></a>08733     <span class="comment">// -----------------------------------------------------</span>
<a name="l08734"></a>08734     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l08735"></a>08735     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l08736"></a>08736     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08737"></a>08737     <span class="comment">// -----------------------------------------------------</span>
<a name="l08738"></a>08738     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l08739"></a>08739     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l08740"></a>08740     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l08741"></a>08741     <span class="comment">// -----------------------------------------------------</span>
<a name="l08742"></a>08742 
<a name="l08743"></a>08743     <span class="keyword">const</span> int32_t nCount    = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(SERVER_ID);
<a name="l08744"></a>08744     <span class="keyword">const</span> int32_t nMaxCount = 50; <span class="comment">// todo no hardcoding. (max transaction nums allowed out at a single time.)</span>
<a name="l08745"></a>08745 
<a name="l08746"></a>08746     <span class="keywordflow">if</span> (nCount &gt; nMaxCount)
<a name="l08747"></a>08747     {
<a name="l08748"></a>08748         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::getTransactionNumber: Failure: That Nym already has &quot;</span>
<a name="l08749"></a>08749                       <span class="stringliteral">&quot;more than %d transaction numbers signed out. (Use those first.)\n&quot;</span>, nMaxCount);
<a name="l08750"></a>08750         <span class="keywordflow">return</span> 0; <span class="comment">// Java code needs to know that no msg went out, BUT it&#39;s because we already have TOO</span>
<a name="l08751"></a>08751         <span class="comment">// MANY numbers (i.e. &quot;a good reason.&quot;) This means &quot;process your Nymbox and grab your intermediary</span>
<a name="l08752"></a>08752         <span class="comment">// files, and try again!&quot; So, we return 0 to indicate this.</span>
<a name="l08753"></a>08753         <span class="comment">//</span>
<a name="l08754"></a>08754 <span class="comment">//      return (-1);</span>
<a name="l08755"></a>08755     }
<a name="l08756"></a>08756     <span class="comment">// -----------------------------------------------------</span>
<a name="l08757"></a>08757     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l08758"></a>08758 
<a name="l08759"></a>08759     int32_t nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afd0f3ab4babfe3e62c93e6af743c3645">OTClient::getTransactionNum</a>, theMessage,
<a name="l08760"></a>08760                                                      *pNym, *pServer,
<a name="l08761"></a>08761                                                      NULL); <span class="comment">// NULL pAccount on this command.</span>
<a name="l08762"></a>08762     <span class="keywordflow">if</span> (0 &lt; nReturnValue) 
<a name="l08763"></a>08763     {               
<a name="l08764"></a>08764         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l08765"></a>08765         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l08766"></a>08766 
<a name="l08767"></a>08767         <span class="keywordflow">return</span> nReturnValue;
<a name="l08768"></a>08768     }
<a name="l08769"></a>08769     <span class="keywordflow">else</span>
<a name="l08770"></a>08770         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::getTransactionNumber: Error processing getTransactionNumber command. Return value: %d\n&quot;</span>,
<a name="l08771"></a>08771                       nReturnValue);
<a name="l08772"></a>08772 
<a name="l08773"></a>08773     <span class="keywordflow">return</span> (-1);
<a name="l08774"></a>08774 }
<a name="l08775"></a>08775 
<a name="l08776"></a>08776 
<a name="l08777"></a>08777 
<a name="l08778"></a>08778 
<a name="l08779"></a>08779 
<a name="l08780"></a><a class="code" href="class_o_t___a_p_i.html#a598ad655514570fcbcc615709251c7e4">08780</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a598ad655514570fcbcc615709251c7e4">OT_API::notarizeWithdrawal</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l08781"></a>08781                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l08782"></a>08782                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCT_ID,
<a name="l08783"></a>08783                                <span class="keyword">const</span> int64_t        &amp; AMOUNT)
<a name="l08784"></a>08784 {
<a name="l08785"></a>08785     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::notarizeWithdrawal&quot;</span>;
<a name="l08786"></a>08786     <span class="comment">// -----------------------------------------------------</span>
<a name="l08787"></a>08787     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l08788"></a>08788     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> (-1);
<a name="l08789"></a>08789     <span class="comment">// -----------------------------------------------------</span>
<a name="l08790"></a>08790     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l08791"></a>08791     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l08792"></a>08792     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08793"></a>08793     <span class="comment">// -----------------------------------------------------</span>
<a name="l08794"></a>08794     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l08795"></a>08795     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l08796"></a>08796     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l08797"></a>08797     <span class="comment">// -----------------------------------------------------</span>
<a name="l08798"></a>08798     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, szFuncName);
<a name="l08799"></a>08799     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l08800"></a>08800     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l08801"></a>08801     <span class="comment">// -----------------------------------------------------</span>
<a name="l08802"></a>08802     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    CONTRACT_ID;
<a name="l08803"></a>08803     <a class="code" href="class_o_t_string.html">OTString</a>        strContractID, strServerID(SERVER_ID);
<a name="l08804"></a>08804     <span class="comment">// -----------------------------------------------------</span>
<a name="l08805"></a>08805     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l08806"></a>08806     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l08807"></a>08807     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l08808"></a>08808     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="namespace_o_t_d_b.html#a73e39a590dfb64f63065821c6bbcd4c6">OTDB::Exists</a>(<a class="code" href="class_o_t_folders.html#a821d8437b66e62cca2782da52777f299">OTFolders::Mint</a>().Get(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strContractID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l08809"></a>08809     {
<a name="l08810"></a>08810         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OT_API::notarizeWithdrawal: File does not exist: %s%s%s%s%s\n&quot;</span>,
<a name="l08811"></a>08811             <a class="code" href="class_o_t_folders.html#a821d8437b66e62cca2782da52777f299">OTFolders::Mint</a>().Get(), <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l08812"></a>08812             <a class="code" href="class_o_t_log.html#a42d3c91ff84ecae0690e34efb4619a77">OTLog::PathSeparator</a>(), strContractID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08813"></a>08813         <span class="keywordflow">return</span> -1;
<a name="l08814"></a>08814     }
<a name="l08815"></a>08815     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l08816"></a>08816     <a class="code" href="class_o_t_mint.html">OTMint</a> * pMint = <a class="code" href="class_o_t_mint.html#a2a0ecb9351ac2ce303e1b20ae523aabb">OTMint::MintFactory</a>(strServerID, strContractID); <span class="comment">// &lt;=================</span>
<a name="l08817"></a>08817     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMint&gt;</a> theMintAngel(pMint);
<a name="l08818"></a>08818     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMint);
<a name="l08819"></a>08819     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l08820"></a>08820     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l08821"></a>08821 
<a name="l08822"></a>08822     int64_t lRequestNumber = 0;
<a name="l08823"></a>08823 
<a name="l08824"></a>08824     <span class="keyword">const</span>   int64_t lTotalAmount    = AMOUNT;
<a name="l08825"></a>08825     int64_t lAmount     = lTotalAmount;
<a name="l08826"></a>08826 
<a name="l08827"></a>08827     <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID), strFromAcct(ACCT_ID);
<a name="l08828"></a>08828 
<a name="l08829"></a>08829     int64_t lStoredTransactionNumber=0;
<a name="l08830"></a>08830     <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;
<a name="l08831"></a>08831     <span class="comment">// ---------------------------------------------</span>
<a name="l08832"></a>08832     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l08833"></a>08833     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l08834"></a>08834 
<a name="l08835"></a>08835     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l08836"></a>08836     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l08837"></a>08837 
<a name="l08838"></a>08838     <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l08839"></a>08839     {
<a name="l08840"></a>08840         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Failed loading inbox!\n&quot;</span>, __FUNCTION__);
<a name="l08841"></a>08841         <span class="keywordflow">return</span> (-1);
<a name="l08842"></a>08842     }
<a name="l08843"></a>08843     <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l08844"></a>08844     {
<a name="l08845"></a>08845         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Failed loading outbox!\n&quot;</span>, __FUNCTION__);
<a name="l08846"></a>08846         <span class="keywordflow">return</span> (-1);
<a name="l08847"></a>08847     }
<a name="l08848"></a>08848 
<a name="l08849"></a>08849     bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber);
<a name="l08850"></a>08850     <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l08851"></a>08851     {
<a name="l08852"></a>08852         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Next Transaction Number Available: Suggest requesting the server for a new one.\n&quot;</span>, __FUNCTION__);
<a name="l08853"></a>08853         <span class="keywordflow">return</span> (-1);
<a name="l08854"></a>08854     }
<a name="l08855"></a>08855 
<a name="l08856"></a>08856     <span class="comment">// Create a transaction</span>
<a name="l08857"></a>08857     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction =
<a name="l08858"></a>08858         <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(USER_ID, ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lStoredTransactionNumber);
<a name="l08859"></a>08859 
<a name="l08860"></a>08860     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l08861"></a>08861     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a91dfa211f934207df229263a14672789">OTItem::withdrawal</a>);
<a name="l08862"></a>08862     pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalAmount);
<a name="l08863"></a>08863 
<a name="l08864"></a>08864     <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Gimme cash!&quot;</span>);  <span class="comment">// TODO: Note is unnecessary for cash withdrawal. Research uses / risks.</span>
<a name="l08865"></a>08865     pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l08866"></a>08866     <span class="comment">// -------------------------------------</span>
<a name="l08867"></a>08867     <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = pServer-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l08868"></a>08868 
<a name="l08869"></a>08869     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_USER_ID(*pServerNym);
<a name="l08870"></a>08870     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l08871"></a>08871     <span class="keywordflow">if</span> ((NULL != pServerNym) &amp;&amp;
<a name="l08872"></a>08872         pMint-&gt;<a class="code" href="class_o_t_mint.html#a221bc0417a368635c5f66db83d221272">LoadMint</a>() &amp;&amp;
<a name="l08873"></a>08873         pMint-&gt;<a class="code" href="class_o_t_mint.html#a0cb5f67b42a1cab07a75c9cf21970a90">VerifyMint</a>((<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>&amp;)*pServerNym))
<a name="l08874"></a>08874     {
<a name="l08875"></a>08875         <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurse        = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID, SERVER_USER_ID);
<a name="l08876"></a>08876         <a class="code" href="class_o_t_purse.html">OTPurse</a> * pPurseMyCopy  = <span class="keyword">new</span> <a class="code" href="class_o_t_purse.html">OTPurse</a>(SERVER_ID, CONTRACT_ID, USER_ID);
<a name="l08877"></a>08877 
<a name="l08878"></a>08878         <span class="comment">// Create all the necessary tokens for the withdrawal amount.</span>
<a name="l08879"></a>08879         <span class="comment">// Push copies of each token into a purse to be sent to the server,</span>
<a name="l08880"></a>08880         <span class="comment">// as well as a purse to be kept for unblinding when we receive the</span>
<a name="l08881"></a>08881         <span class="comment">// server response.  (Coin private unblinding keys are not sent to</span>
<a name="l08882"></a>08882         <span class="comment">// the server, obviously.)</span>
<a name="l08883"></a>08883         int64_t lTokenAmount = 0;
<a name="l08884"></a>08884         <span class="keywordflow">while</span> ((lTokenAmount = pMint-&gt;<a class="code" href="class_o_t_mint.html#a623b821ad01b8c0ce2568b6d84102c35">GetLargestDenomination</a>(lAmount)) &gt; 0 )
<a name="l08885"></a>08885         {
<a name="l08886"></a>08886             lAmount -= lTokenAmount;
<a name="l08887"></a>08887 
<a name="l08888"></a>08888             <span class="comment">// Create the relevant token request with same server/asset ID as the purse.</span>
<a name="l08889"></a>08889             <span class="comment">// the purse does NOT own the token at this point. The token&#39;s constructor</span>
<a name="l08890"></a>08890             <span class="comment">// just uses it to copy some IDs, since they must match.</span>
<a name="l08891"></a>08891             <span class="comment">//</span>
<a name="l08892"></a>08892             <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = <a class="code" href="class_o_t_token.html#ad661596f621b1b697f1e8328cdbc3683">OTToken::InstantiateAndGenerateTokenRequest</a>(*pPurse, *pNym, *pMint, lTokenAmount);
<a name="l08893"></a>08893             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTToken&gt;</a> theTokenAngel(pToken);
<a name="l08894"></a>08894             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pToken);
<a name="l08895"></a>08895 
<a name="l08896"></a>08896             <span class="comment">// Sign it and save it.</span>
<a name="l08897"></a>08897             pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08898"></a>08898             pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08899"></a>08899 
<a name="l08900"></a>08900             <span class="comment">// Now the proto-token is generated, let&#39;s add it to a purse</span>
<a name="l08901"></a>08901             <span class="comment">// By pushing *pToken into pPurse with *pServerNym, I encrypt it to pServerNym.</span>
<a name="l08902"></a>08902             <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
<a name="l08903"></a>08903             pPurse-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pServerNym, *pToken);
<a name="l08904"></a>08904 
<a name="l08905"></a>08905             <span class="comment">// I&#39;m saving my own copy of all this, encrypted to my nym</span>
<a name="l08906"></a>08906             <span class="comment">// instead of the server&#39;s, so I can get to my private coin data.</span>
<a name="l08907"></a>08907             <span class="comment">// The server&#39;s copy of pToken is already Pushed, so I can re-use</span>
<a name="l08908"></a>08908             <span class="comment">// the variable now for my own purse.</span>
<a name="l08909"></a>08909             pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l08910"></a>08910             pToken-&gt;<a class="code" href="class_o_t_token.html#a8666afcdee1f4cb0b45e278d7196d6db">SetSavePrivateKeys</a>(); <span class="comment">// This time it will save the private keys when I sign it</span>
<a name="l08911"></a>08911             pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08912"></a>08912             pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08913"></a>08913 
<a name="l08914"></a>08914             pPurseMyCopy-&gt;<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(*pNym, *pToken);<span class="comment">// Now my copy of the purse has a version of the token,</span>
<a name="l08915"></a>08915         }
<a name="l08916"></a>08916         <span class="comment">// --------------------------------</span>
<a name="l08917"></a>08917         <span class="comment">// Save the purse into a string...</span>
<a name="l08918"></a>08918         <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
<a name="l08919"></a>08919         pPurse-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08920"></a>08920         pPurse-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08921"></a>08921         pPurse-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);
<a name="l08922"></a>08922 
<a name="l08923"></a>08923         <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
<a name="l08924"></a>08924         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>
<a name="l08925"></a>08925         <span class="comment">// --------------------------------------</span>
<a name="l08926"></a>08926         pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);      <span class="comment">// encrypted to me instead of the server, and including</span>
<a name="l08927"></a>08927         pPurseMyCopy-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();           <span class="comment">// the private keys for unblinding the server response.</span>
<a name="l08928"></a>08928         <span class="comment">// This thing is neat and tidy. The wallet can just save it as an ascii-armored string as a</span>
<a name="l08929"></a>08929         <span class="comment">// purse field inside the wallet file.  It doesn&#39;t do that for now (TODO) but it easily could.</span>
<a name="l08930"></a>08930         <span class="comment">// --------------------------------------</span>
<a name="l08931"></a>08931         <span class="comment">// Add the purse to the wallet</span>
<a name="l08932"></a>08932         <span class="comment">// (We will need it to look up the private coin info for unblinding the token,</span>
<a name="l08933"></a>08933         <span class="comment">//  when the response comes from the server.)</span>
<a name="l08934"></a>08934         pWallet-&gt;<a class="code" href="class_o_t_wallet.html#a098029976b57c592f220ae6bf0cc3822">AddPendingWithdrawal</a>(*pPurseMyCopy);
<a name="l08935"></a>08935 
<a name="l08936"></a>08936         <span class="keyword">delete</span> pPurse;
<a name="l08937"></a>08937         pPurse          = NULL; <span class="comment">// We&#39;re done with this one.</span>
<a name="l08938"></a>08938         pPurseMyCopy    = NULL; <span class="comment">// The wallet owns my copy now and will handle cleaning it up.</span>
<a name="l08939"></a>08939 
<a name="l08940"></a>08940         <span class="comment">// --------------------------------------</span>
<a name="l08941"></a>08941         <span class="comment">// sign the item</span>
<a name="l08942"></a>08942         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08943"></a>08943         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08944"></a>08944 
<a name="l08945"></a>08945         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l08946"></a>08946         <span class="comment">// ---------------------------------------------</span>
<a name="l08947"></a>08947         <span class="comment">// BALANCE AGREEMENT</span>
<a name="l08948"></a>08948 
<a name="l08949"></a>08949         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l08950"></a>08950         <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalAmount*(-1), *pTransaction, *pNym, *pAccount, *pOutbox);
<a name="l08951"></a>08951 
<a name="l08952"></a>08952         <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l08953"></a>08953             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l08954"></a>08954         <span class="comment">// ---------------------------------------------</span>
<a name="l08955"></a>08955 
<a name="l08956"></a>08956         <span class="comment">// sign the transaction</span>
<a name="l08957"></a>08957         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08958"></a>08958         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08959"></a>08959 
<a name="l08960"></a>08960         <span class="comment">// set up the ledger</span>
<a name="l08961"></a>08961         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_ID, SERVER_ID);
<a name="l08962"></a>08962         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l08963"></a>08963         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l08964"></a>08964 
<a name="l08965"></a>08965         <span class="comment">// sign the ledger</span>
<a name="l08966"></a>08966         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l08967"></a>08967         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l08968"></a>08968 
<a name="l08969"></a>08969         <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l08970"></a>08970         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l08971"></a>08971         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger; <span class="comment">// I can&#39;t pass strLedger into this constructor because I want to encode it</span>
<a name="l08972"></a>08972 
<a name="l08973"></a>08973         <span class="comment">// Encoding...</span>
<a name="l08974"></a>08974         ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l08975"></a>08975         <span class="comment">// -----------------------------------------------------</span>
<a name="l08976"></a>08976         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l08977"></a>08977         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l08978"></a>08978         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l08979"></a>08979         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l08980"></a>08980 
<a name="l08981"></a>08981         <span class="comment">// (1) Set up member variables</span>
<a name="l08982"></a>08982         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l08983"></a>08983         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l08984"></a>08984         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l08985"></a>08985         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l08986"></a>08986 
<a name="l08987"></a>08987         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l08988"></a>08988         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l08989"></a>08989 
<a name="l08990"></a>08990         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l08991"></a>08991         <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l08992"></a>08992         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l08993"></a>08993         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l08994"></a>08994 
<a name="l08995"></a>08995         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l08996"></a>08996             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l08997"></a>08997             str_server.c_str());
<a name="l08998"></a>08998 
<a name="l08999"></a>08999         <span class="comment">// (2) Sign the Message</span>
<a name="l09000"></a>09000         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l09001"></a>09001 
<a name="l09002"></a>09002         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09003"></a>09003         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09004"></a>09004 
<a name="l09005"></a>09005         <span class="comment">// (Send it)</span>
<a name="l09006"></a>09006         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, m_pTransportCallback);
<a name="l09007"></a>09007         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l09008"></a>09008 
<a name="l09009"></a>09009         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l09010"></a>09010     }
<a name="l09011"></a>09011     <span class="keywordflow">else</span>
<a name="l09012"></a>09012     {
<a name="l09013"></a>09013         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09014"></a>09014         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09015"></a>09015     }
<a name="l09016"></a>09016 
<a name="l09017"></a>09017     <span class="keywordflow">return</span> (-1);
<a name="l09018"></a>09018 }
<a name="l09019"></a>09019 
<a name="l09020"></a>09020 
<a name="l09021"></a>09021 
<a name="l09022"></a>09022 
<a name="l09023"></a><a class="code" href="class_o_t___a_p_i.html#a02e42976ba8ca2b4a667c97c94199780">09023</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a02e42976ba8ca2b4a667c97c94199780">OT_API::notarizeDeposit</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l09024"></a>09024                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; USER_ID,
<a name="l09025"></a>09025                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ACCT_ID,
<a name="l09026"></a>09026                             <a class="code" href="class_o_t_string.html">OTString</a>        &amp; THE_PURSE)
<a name="l09027"></a>09027 {
<a name="l09028"></a>09028     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::notarizeDeposit&quot;</span>;
<a name="l09029"></a>09029     <span class="comment">// -----------------------------------------------------</span>
<a name="l09030"></a>09030     <a class="code" href="class_o_t_string.html">OTString</a> strPurseReason        (<span class="stringliteral">&quot;Depositing a cash purse. Enter passphrase for the purse.&quot;</span>);
<a name="l09031"></a>09031     <a class="code" href="class_o_t_password_data.html">OTPasswordData</a> thePWDataWallet (<span class="stringliteral">&quot;Depositing a cash purse. Enter master passphrase for wallet.&quot;</span>);
<a name="l09032"></a>09032     <span class="comment">// -----------------------------------------------------</span>
<a name="l09033"></a>09033     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName, &amp;thePWDataWallet); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l09034"></a>09034     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l09035"></a>09035     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09036"></a>09036     <span class="comment">// -----------------------------------------------------</span>
<a name="l09037"></a>09037     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09038"></a>09038     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l09039"></a>09039     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l09040"></a>09040     <span class="comment">// -----------------------------------------------------</span>
<a name="l09041"></a>09041     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, szFuncName);
<a name="l09042"></a>09042     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l09043"></a>09043     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09044"></a>09044     <span class="comment">// -----------------------------------------------------</span>
<a name="l09045"></a>09045     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    CONTRACT_ID;
<a name="l09046"></a>09046     <a class="code" href="class_o_t_string.html">OTString</a>        strContractID;
<a name="l09047"></a>09047 
<a name="l09048"></a>09048     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09049"></a>09049     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09050"></a>09050     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09051"></a>09051     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l09052"></a>09052     int64_t lRequestNumber = 0;
<a name="l09053"></a>09053 
<a name="l09054"></a>09054     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strFromAcct(ACCT_ID);
<a name="l09055"></a>09055 
<a name="l09056"></a>09056     <span class="keyword">const</span> <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pServerNym = pServer-&gt;<a class="code" href="class_o_t_contract.html#affb6a11ee52ad13fd6e1e1ef6e4bbdc1">GetContractPublicNym</a>();
<a name="l09057"></a>09057     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SERVER_USER_ID(*pServerNym);
<a name="l09058"></a>09058     <span class="comment">// ------------------------------------------------</span>
<a name="l09059"></a>09059     <a class="code" href="class_o_t_purse.html">OTPurse</a> thePurse(SERVER_ID, CONTRACT_ID, SERVER_USER_ID);
<a name="l09060"></a>09060 
<a name="l09061"></a>09061     int64_t lStoredTransactionNumber=0;
<a name="l09062"></a>09062     <span class="keywordtype">bool</span> bGotTransNum = <span class="keyword">false</span>;
<a name="l09063"></a>09063     <span class="comment">// ---------------------------------------------</span>
<a name="l09064"></a>09064     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l09065"></a>09065     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l09066"></a>09066 
<a name="l09067"></a>09067     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l09068"></a>09068     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09069"></a>09069 
<a name="l09070"></a>09070     <span class="keywordflow">if</span> (NULL == pInbox){
<a name="l09071"></a>09071         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Failed loading inbox!\n&quot;</span>, __FUNCTION__);
<a name="l09072"></a>09072         <span class="keywordflow">return</span> (-1);
<a name="l09073"></a>09073     }
<a name="l09074"></a>09074     <span class="keywordflow">if</span> (NULL == pOutbox){
<a name="l09075"></a>09075         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error: Failed loading outbox!\n&quot;</span>, __FUNCTION__);
<a name="l09076"></a>09076         <span class="keywordflow">return</span> (-1);
<a name="l09077"></a>09077     }
<a name="l09078"></a>09078 
<a name="l09079"></a>09079     bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber);
<a name="l09080"></a>09080     <span class="keywordflow">if</span> (!bGotTransNum){
<a name="l09081"></a>09081         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Next Transaction Number Available: Suggest requesting the server for a new one.\n&quot;</span>, __FUNCTION__);
<a name="l09082"></a>09082         <span class="keywordflow">return</span> (-1);
<a name="l09083"></a>09083     }
<a name="l09084"></a>09084 
<a name="l09085"></a>09085     <span class="keywordflow">if</span> (NULL == pServerNym) <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>;
<a name="l09086"></a>09086 
<a name="l09087"></a>09087     <span class="comment">// -----------------------------------------</span>
<a name="l09088"></a>09088     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">false</span>;
<a name="l09089"></a>09089 
<a name="l09090"></a>09090     <span class="comment">// Create a transaction</span>
<a name="l09091"></a>09091     <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_ID, SERVER_ID,
<a name="l09092"></a>09092         <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>, lStoredTransactionNumber);
<a name="l09093"></a>09093     <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09094"></a>09094     <a class="code" href="class_o_t_item.html">OTItem</a> * pItem  = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1afd6e878bfcdf2d554b0c814d5da084d1">OTItem::deposit</a>);
<a name="l09095"></a>09095 
<a name="l09096"></a>09096     <span class="comment">// -----------------------------------------------------</span>
<a name="l09097"></a>09097     <span class="comment">// What&#39;s going on here?</span>
<a name="l09098"></a>09098     <span class="comment">// A purse can be encrypted by a private key (controlled by a Nym) or by a symmetric</span>
<a name="l09099"></a>09099     <span class="comment">// key (embedded inside the purse along with a corresponding master key.) The below</span>
<a name="l09100"></a>09100     <span class="comment">// function is what actually loads up pPurse from string (THE_PURSE) and this call</span>
<a name="l09101"></a>09101     <span class="comment">// also returns pOwner, which is a pointer to a special wrapper class (which you must</span>
<a name="l09102"></a>09102     <span class="comment">// delete, when you&#39;re done with it) which contains a pointer EITHER to the owner Nym</span>
<a name="l09103"></a>09103     <span class="comment">// for that purse, OR to the &quot;owner&quot; symmetric key for that purse.</span>
<a name="l09104"></a>09104     <span class="comment">//</span>
<a name="l09105"></a>09105     <span class="comment">// This way, any subsequent purse operations can use pOwner, regardless of whether there</span>
<a name="l09106"></a>09106     <span class="comment">// is actually a Nym inside, or a symmetric key. (None of the purse operations will care,</span>
<a name="l09107"></a>09107     <span class="comment">// since they can use pOwner either way.)</span>
<a name="l09108"></a>09108     <span class="comment">//</span>
<a name="l09109"></a>09109     <a class="code" href="class_o_t_password.html">OTPassword</a>  thePassword;
<a name="l09110"></a>09110     <a class="code" href="class_o_t_purse.html">OTPurse</a>     theSourcePurse(thePurse);
<a name="l09111"></a>09111 
<a name="l09112"></a>09112     <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> * pPurseOwner = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a7b06c8e03c43b3b45d74333b16a5f1b7">LoadPurseAndOwnerForMerge</a>(THE_PURSE, theSourcePurse, thePassword,
<a name="l09113"></a>09113         <span class="keyword">false</span>, <span class="comment">//bCanBePublic=false by default. MUST be private, if a nym.</span>
<a name="l09114"></a>09114         &amp;USER_ID, <span class="comment">// This can be NULL, **IF** purse is password-protected. (It&#39;s just ignored in that case.) Otherwise if it&#39;s Nym-protected, the purse will have a NymID on it already, which is what LoadPurseAndOwnerForMerge will try first. If not (it&#39;s optional), then USER_ID is the ID it will try next, before failing altogether.</span>
<a name="l09115"></a>09115         &amp;strPurseReason);
<a name="l09116"></a>09116     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTNym_or_SymmetricKey&gt;</a> theOwnerAngel(pPurseOwner);
<a name="l09117"></a>09117     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09118"></a>09118     <span class="keywordflow">if</span> (NULL != pPurseOwner)
<a name="l09119"></a>09119     {
<a name="l09120"></a>09120         <a class="code" href="class_o_t_nym__or___symmetric_key.html">OTNym_or_SymmetricKey</a> theServerNymAsOwner(*pServerNym);
<a name="l09121"></a>09121 
<a name="l09122"></a>09122         <span class="keywordflow">while</span> (!theSourcePurse.<a class="code" href="class_o_t_purse.html#ad8e03aa9b3d80b7e3bc927db699cafe5">IsEmpty</a>())
<a name="l09123"></a>09123         {
<a name="l09124"></a>09124             <a class="code" href="class_o_t_token.html">OTToken</a> * pToken = theSourcePurse.<a class="code" href="class_o_t_purse.html#a84b70b093c79a796815d9a42c8d3bd74">Pop</a>(*pPurseOwner);
<a name="l09125"></a>09125 
<a name="l09126"></a>09126             <span class="keywordflow">if</span> (NULL != pToken)
<a name="l09127"></a>09127             {
<a name="l09128"></a>09128                 <span class="comment">// TODO need 2-recipient envelopes. My request to the server is encrypted to the server&#39;s nym,</span>
<a name="l09129"></a>09129                 <span class="comment">// but it should be encrypted to my Nym also, so both have access to decrypt it.</span>
<a name="l09130"></a>09130 
<a name="l09131"></a>09131                 <span class="comment">// Now the token is ready, let&#39;s add it to a purse</span>
<a name="l09132"></a>09132                 <span class="comment">// By pushing theToken into thePurse with *pServerNym, I encrypt it to pServerNym.</span>
<a name="l09133"></a>09133                 <span class="comment">// So now only the server Nym can decrypt that token and pop it out of that purse.</span>
<a name="l09134"></a>09134                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pToken-&gt;<a class="code" href="class_o_t_token.html#aa661b16971fbca2e3b4a1c3452e4c030">ReassignOwnership</a>(*pPurseOwner,         <span class="comment">// must be private, if a nym.</span>
<a name="l09135"></a>09135                     theServerNymAsOwner)) <span class="comment">// can be public, if a nym.</span>
<a name="l09136"></a>09136                 {
<a name="l09137"></a>09137                     <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::notarizeDeposit: Error re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l09138"></a>09138                     <span class="keyword">delete</span> pToken; pToken = NULL;
<a name="l09139"></a>09139                     bSuccess = <span class="keyword">false</span>;
<a name="l09140"></a>09140                     <span class="keywordflow">break</span>;
<a name="l09141"></a>09141                 }
<a name="l09142"></a>09142                 <span class="keywordflow">else</span>
<a name="l09143"></a>09143                 {
<a name="l09144"></a>09144                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;OT_API::notarizeDeposit: Success re-assigning ownership of token (to server.)\n&quot;</span>);
<a name="l09145"></a>09145 
<a name="l09146"></a>09146                     bSuccess = <span class="keyword">true</span>;
<a name="l09147"></a>09147 
<a name="l09148"></a>09148                     pToken-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l09149"></a>09149                     pToken-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09150"></a>09150                     pToken-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09151"></a>09151 
<a name="l09152"></a>09152                     thePurse.<a class="code" href="class_o_t_purse.html#a1494538d965842e3fa3d1b9ac2b6dd25">Push</a>(theServerNymAsOwner, *pToken);
<a name="l09153"></a>09153 
<a name="l09154"></a>09154                     int64_t lTemp = pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>();
<a name="l09155"></a>09155                     pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTemp += pToken-&gt;<a class="code" href="class_o_t_token.html#a4e17470c475313139d1ed975e6c26b5a">GetDenomination</a>());
<a name="l09156"></a>09156                 }
<a name="l09157"></a>09157                 <span class="keyword">delete</span> pToken;
<a name="l09158"></a>09158                 pToken = NULL;
<a name="l09159"></a>09159             }
<a name="l09160"></a>09160             <span class="keywordflow">else</span>
<a name="l09161"></a>09161             {
<a name="l09162"></a>09162                 <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error loading token from purse.\n&quot;</span>);
<a name="l09163"></a>09163                 <span class="keywordflow">break</span>;
<a name="l09164"></a>09164             }
<a name="l09165"></a>09165         } <span class="comment">// while</span>
<a name="l09166"></a>09166     }
<a name="l09167"></a>09167     <span class="comment">// ---------------------------------------------</span>
<a name="l09168"></a>09168     <span class="keywordflow">if</span> (bSuccess)
<a name="l09169"></a>09169     {
<a name="l09170"></a>09170         <span class="comment">// Save the purse into a string...</span>
<a name="l09171"></a>09171         <a class="code" href="class_o_t_string.html">OTString</a> strPurse;
<a name="l09172"></a>09172         thePurse.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09173"></a>09173         thePurse.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09174"></a>09174         thePurse.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strPurse);
<a name="l09175"></a>09175 
<a name="l09176"></a>09176         <span class="comment">// Add the purse string as the attachment on the transaction item.</span>
<a name="l09177"></a>09177         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPurse); <span class="comment">// The purse is contained in the reference string.</span>
<a name="l09178"></a>09178 
<a name="l09179"></a>09179         <span class="comment">// sign the item</span>
<a name="l09180"></a>09180         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09181"></a>09181         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09182"></a>09182 
<a name="l09183"></a>09183         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l09184"></a>09184         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09185"></a>09185 
<a name="l09186"></a>09186         <span class="comment">// ---------------------------------------------</span>
<a name="l09187"></a>09187         <span class="comment">// BALANCE AGREEMENT</span>
<a name="l09188"></a>09188         <span class="comment">//</span>
<a name="l09189"></a>09189         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l09190"></a>09190         <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(pItem-&gt;<a class="code" href="class_o_t_item.html#a8b3464bd470097e2a668e576106064f6">GetAmount</a>(), *pTransaction, *pNym, *pAccount, *pOutbox);
<a name="l09191"></a>09191 
<a name="l09192"></a>09192         <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l09193"></a>09193             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09194"></a>09194         <span class="comment">// ---------------------------------------------</span>
<a name="l09195"></a>09195 
<a name="l09196"></a>09196         <span class="comment">// sign the transaction</span>
<a name="l09197"></a>09197         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09198"></a>09198         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09199"></a>09199 
<a name="l09200"></a>09200         <span class="comment">// set up the ledger</span>
<a name="l09201"></a>09201         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_ID, SERVER_ID);
<a name="l09202"></a>09202         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09203"></a>09203         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l09204"></a>09204 
<a name="l09205"></a>09205         <span class="comment">// sign the ledger</span>
<a name="l09206"></a>09206         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09207"></a>09207         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09208"></a>09208 
<a name="l09209"></a>09209         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l09210"></a>09210         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09211"></a>09211         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l09212"></a>09212 
<a name="l09213"></a>09213         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09214"></a>09214         pNym-&gt;GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l09215"></a>09215         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09216"></a>09216         pNym-&gt;IncrementRequestNum(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09217"></a>09217 
<a name="l09218"></a>09218         <span class="comment">// (1) Set up member variables</span>
<a name="l09219"></a>09219         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09220"></a>09220         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09221"></a>09221         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09222"></a>09222         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09223"></a>09223 
<a name="l09224"></a>09224         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l09225"></a>09225         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09226"></a>09226 
<a name="l09227"></a>09227         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09228"></a>09228         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l09229"></a>09229         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l09230"></a>09230         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09231"></a>09231 
<a name="l09232"></a>09232         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l09233"></a>09233             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09234"></a>09234             str_server.c_str());
<a name="l09235"></a>09235 
<a name="l09236"></a>09236         <span class="comment">// (2) Sign the Message</span>
<a name="l09237"></a>09237         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l09238"></a>09238 
<a name="l09239"></a>09239         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09240"></a>09240         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09241"></a>09241 
<a name="l09242"></a>09242         <span class="comment">// (Send it)</span>
<a name="l09243"></a>09243         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l09244"></a>09244         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);   
<a name="l09245"></a>09245 
<a name="l09246"></a>09246         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l09247"></a>09247 
<a name="l09248"></a>09248     } <span class="comment">// bSuccess</span>
<a name="l09249"></a>09249     <span class="keywordflow">else</span>
<a name="l09250"></a>09250     {
<a name="l09251"></a>09251         <span class="keyword">delete</span> pItem;       pItem = NULL;
<a name="l09252"></a>09252         <span class="keyword">delete</span> pTransaction;pTransaction = NULL;
<a name="l09253"></a>09253 
<a name="l09254"></a>09254         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09255"></a>09255         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09256"></a>09256     }
<a name="l09257"></a>09257 
<a name="l09258"></a>09258     <span class="keywordflow">return</span> (-1);
<a name="l09259"></a>09259 }
<a name="l09260"></a>09260 
<a name="l09261"></a>09261 
<a name="l09262"></a>09262 
<a name="l09263"></a>09263 <span class="comment">// Let&#39;s pretend you are paying a dollar dividend for Pepsi shares...</span>
<a name="l09264"></a>09264 <span class="comment">// Therefore ACCT_ID needs to be a dollar account, and SHARES_ASSET_ID needs</span>
<a name="l09265"></a>09265 <span class="comment">// to be the Pepsi asset type ID. (NOT the dollar asset type ID...)</span>
<a name="l09266"></a>09266 <span class="comment">//</span>
<a name="l09267"></a><a class="code" href="class_o_t___a_p_i.html#a867538fd96d36fc772d94cffef2e8d47">09267</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a867538fd96d36fc772d94cffef2e8d47">OT_API::payDividend</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l09268"></a>09268                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ISSUER_USER_ID,           <span class="comment">// must be issuer of SHARES_ASSET_TYPE_ID</span>
<a name="l09269"></a>09269                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; DIVIDEND_FROM_ACCT_ID,    <span class="comment">// if dollars paid for pepsi shares, then this is the issuer&#39;s dollars account.</span>
<a name="l09270"></a>09270                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SHARES_ASSET_TYPE_ID,     <span class="comment">// if dollars paid for pepsi shares, then this is the pepsi shares asset type id.</span>
<a name="l09271"></a>09271                         <a class="code" href="class_o_t_string.html">OTString</a>        &amp; DIVIDEND_MEMO,            <span class="comment">// a message attached to the payout request.</span>
<a name="l09272"></a>09272                         <span class="keyword">const</span> int64_t       &amp; AMOUNT_PER_SHARE) <span class="comment">// number of dollars to be paid out PER SHARE (multiplied by total number of shares issued.)</span>
<a name="l09273"></a>09273 {
<a name="l09274"></a>09274     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::payDividend&quot;</span>;
<a name="l09275"></a>09275     <span class="comment">// -----------------------------------------------------</span>
<a name="l09276"></a>09276     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(ISSUER_USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l09277"></a>09277     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l09278"></a>09278     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09279"></a>09279     <span class="comment">// -----------------------------------------------------</span>
<a name="l09280"></a>09280     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09281"></a>09281     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l09282"></a>09282     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l09283"></a>09283     <span class="comment">// -----------------------------------------------------</span>
<a name="l09284"></a>09284     <a class="code" href="class_o_t_account.html">OTAccount</a> * pDividendSourceAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, DIVIDEND_FROM_ACCT_ID, SERVER_ID, szFuncName);
<a name="l09285"></a>09285     <span class="keywordflow">if</span> (NULL == pDividendSourceAccount) <span class="keywordflow">return</span> (-1);
<a name="l09286"></a>09286     <span class="comment">// By this point, pDividendSourceAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09287"></a>09287     <span class="comment">// -----------------------------------------------------</span>
<a name="l09288"></a>09288     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pSharesContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(SHARES_ASSET_TYPE_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09289"></a>09289     <span class="keywordflow">if</span> (NULL == pSharesContract) <span class="keywordflow">return</span> (-1);
<a name="l09290"></a>09290     <span class="comment">// By this point, pSharesContract is a good pointer.  (No need to cleanup.)</span>
<a name="l09291"></a>09291     <span class="comment">// -----------------------------------------------------</span>
<a name="l09292"></a>09292     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = <a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName); <span class="comment">// This logs and ASSERTs already.</span>
<a name="l09293"></a>09293     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> (-1);
<a name="l09294"></a>09294     <span class="comment">// -----------------------------------------------------</span>
<a name="l09295"></a>09295     <a class="code" href="class_o_t_account.html">OTAccount</a> * pSharesIssuerAcct = pWallet-&gt;<a class="code" href="class_o_t_wallet.html#ae4cd7fef3caaf5dec83530ecabbdddb8">GetIssuerAccount</a>(SHARES_ASSET_TYPE_ID);
<a name="l09296"></a>09296 
<a name="l09297"></a>09297     <span class="keywordflow">if</span> (NULL == pSharesIssuerAcct)
<a name="l09298"></a>09298     {
<a name="l09299"></a>09299         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Unable to find issuer account for the shares asset type. &quot;</span>
<a name="l09300"></a>09300                       <span class="stringliteral">&quot;Are you sure you&#39;re the issuer?\n&quot;</span>, szFuncName);
<a name="l09301"></a>09301         <span class="keywordflow">return</span> (-1);
<a name="l09302"></a>09302     }
<a name="l09303"></a>09303     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> SHARES_ISSUER_ACCT_ID(*pSharesIssuerAcct);
<a name="l09304"></a>09304     <span class="comment">// -----------------------------------------------------</span>
<a name="l09305"></a>09305     <span class="keywordflow">if</span> (!pDividendSourceAccount-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pNym))
<a name="l09306"></a>09306     {
<a name="l09307"></a>09307         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Nym doesn&#39;t verify as owner of the source account for the dividend payout.\n&quot;</span>,
<a name="l09308"></a>09308                       szFuncName);
<a name="l09309"></a>09309         <span class="keywordflow">return</span> (-1);
<a name="l09310"></a>09310     }
<a name="l09311"></a>09311     <span class="comment">// -----------------------------------------------------</span>
<a name="l09312"></a>09312     <span class="keywordflow">if</span> (!pSharesIssuerAcct-&gt;<a class="code" href="class_o_t_account.html#a73c89c2d411eb7b88326baf87802f238">VerifyOwner</a>(*pNym))
<a name="l09313"></a>09313     {
<a name="l09314"></a>09314         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Nym doesn&#39;t verify as owner of issuer account for the shares &quot;</span>
<a name="l09315"></a>09315                       <span class="stringliteral">&quot;(the shares we&#39;re paying the dividend on...)\n&quot;</span>,
<a name="l09316"></a>09316                       szFuncName);
<a name="l09317"></a>09317         <span class="keywordflow">return</span> (-1);
<a name="l09318"></a>09318     }
<a name="l09319"></a>09319     <span class="comment">// -----------------------------------------------------</span>
<a name="l09320"></a>09320     <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(pSharesIssuerAcct-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt;= 0, <span class="stringliteral">&quot;Assert (strange): issuer account should never have a higher-than-zero balance.\n&quot;</span>);
<a name="l09321"></a>09321 
<a name="l09322"></a>09322     <span class="keywordflow">if</span> (0 == pSharesIssuerAcct-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>())
<a name="l09323"></a>09323     {
<a name="l09324"></a>09324         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: There are no shares issued for that asset type. &quot;</span>
<a name="l09325"></a>09325                       <span class="stringliteral">&quot;(Therefore you cannot pay any dividend...)\n&quot;</span>, szFuncName);
<a name="l09326"></a>09326         <span class="keywordflow">return</span> (-1);
<a name="l09327"></a>09327     }
<a name="l09328"></a>09328     <span class="comment">// -----------------------------------------------------</span>
<a name="l09329"></a>09329     <span class="keyword">const</span> int64_t lAmountPerShare      = AMOUNT_PER_SHARE;
<a name="l09330"></a>09330 
<a name="l09331"></a>09331     <span class="keywordflow">if</span> (lAmountPerShare &lt;= 0)
<a name="l09332"></a>09332     {
<a name="l09333"></a>09333         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: The amount per share must be larger than zero.\n&quot;</span>, szFuncName);
<a name="l09334"></a>09334         <span class="keywordflow">return</span> (-1);
<a name="l09335"></a>09335     }
<a name="l09336"></a>09336     <span class="comment">// -----------------------------------------------------</span>
<a name="l09337"></a>09337     <span class="comment">// If there are 100,000 Pepsi shares, then the Pepsi issuer acct will have -100,000 balance.</span>
<a name="l09338"></a>09338     <span class="comment">// Therefore we multiply by -1, resulting in 100,000. Then we multiple that by the amount to be</span>
<a name="l09339"></a>09339     <span class="comment">// paid per share, let&#39;s say $5, resulting in a lTotalCostOfDividend of $500,000 that must be</span>
<a name="l09340"></a>09340     <span class="comment">// available in the dollar account (in order to successfully pay this dividend.)</span>
<a name="l09341"></a>09341     <span class="comment">//</span>
<a name="l09342"></a>09342     <span class="keyword">const</span> int64_t lTotalCostOfDividend = ((-1) * pSharesIssuerAcct-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>()) * lAmountPerShare;
<a name="l09343"></a>09343     <span class="comment">// -----------------------------------------------------</span>
<a name="l09344"></a>09344     <span class="comment">// Let&#39;s make sure we have enough money in the dividend source account, to pay the total cost..</span>
<a name="l09345"></a>09345     <span class="comment">//</span>
<a name="l09346"></a>09346     <span class="keywordflow">if</span> (pDividendSourceAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>() &lt; lTotalCostOfDividend)
<a name="l09347"></a>09347     {
<a name="l09348"></a>09348         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: There&#39;s not enough (%ld) in the source account, to cover &quot;</span>
<a name="l09349"></a>09349                       <span class="stringliteral">&quot;the total cost of the dividend (%ld.)\n&quot;</span>, szFuncName, pDividendSourceAccount-&gt;<a class="code" href="class_o_t_account.html#a77fbaae9496caec7cd899721971a89c0">GetBalance</a>(),
<a name="l09350"></a>09350                       lTotalCostOfDividend);
<a name="l09351"></a>09351         <span class="keywordflow">return</span> (-1);
<a name="l09352"></a>09352     }
<a name="l09353"></a>09353     <span class="comment">// -----------------------------------------------------</span>
<a name="l09354"></a>09354     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l09355"></a>09355 
<a name="l09356"></a>09356     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(ISSUER_USER_ID), strFromAcct(DIVIDEND_FROM_ACCT_ID);
<a name="l09357"></a>09357 
<a name="l09358"></a>09358     int64_t lStoredTransactionNumber=0;
<a name="l09359"></a>09359     <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber);
<a name="l09360"></a>09360 
<a name="l09361"></a>09361     <span class="keywordflow">if</span> (bGotTransNum)
<a name="l09362"></a>09362     {
<a name="l09363"></a>09363         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09364"></a>09364         <span class="comment">// Expiration (ignored by server -- it sets its own for its vouchers.)</span>
<a name="l09365"></a>09365         <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
<a name="l09366"></a>09366         <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>)); <span class="comment">// 6 months.</span>
<a name="l09367"></a>09367         <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09368"></a>09368         <span class="comment">// The server only uses the amount and asset type from this cheque when it</span>
<a name="l09369"></a>09369         <span class="comment">// constructs the actual voucher (to the dividend payee.) And remember there</span>
<a name="l09370"></a>09370         <span class="comment">// might be a hundred shareholders, so the server would create a hundred</span>
<a name="l09371"></a>09371         <span class="comment">// vouchers in that case.</span>
<a name="l09372"></a>09372         <span class="comment">//</span>
<a name="l09373"></a>09373         <a class="code" href="class_o_t_cheque.html">OTCheque</a> theRequestVoucher(SERVER_ID, SHARES_ASSET_TYPE_ID); <span class="comment">// &lt;====== Server needs this (SHARES_ASSET_TYPE_ID)</span>
<a name="l09374"></a>09374 
<a name="l09375"></a>09375         <span class="keywordtype">bool</span> bIssueCheque = theRequestVoucher.<a class="code" href="class_o_t_cheque.html#af554e93b31bf218e373bdc8f457d7605">IssueCheque</a>(lAmountPerShare, <span class="comment">// &lt;====== Server needs this (lAmountPerShare.)</span>
<a name="l09376"></a>09376                                                           lStoredTransactionNumber, <span class="comment">// server actually ignores this and supplies its own transaction number for any vouchers.</span>
<a name="l09377"></a>09377                                                           VALID_FROM, VALID_TO, SHARES_ISSUER_ACCT_ID, ISSUER_USER_ID, DIVIDEND_MEMO);
<a name="l09378"></a>09378 
<a name="l09379"></a>09379         <span class="comment">/*</span>
<a name="l09380"></a>09380 <span class="comment">         NOTE: The above cheque isn&#39;t actually USED for anything, except as a vehicle to send additional</span>
<a name="l09381"></a>09381 <span class="comment">         data to the server. For example, the server will need to know the asset type ID for the shares.</span>
<a name="l09382"></a>09382 <span class="comment">         It gets that information from this voucher&#39;s asset type ID. It will also need to know the amount-</span>
<a name="l09383"></a>09383 <span class="comment">         per-share, which is also on this voucher, as its amount. The voucher code already does a similar</span>
<a name="l09384"></a>09384 <span class="comment">         thing, and this code already copied the voucher code since they were so similar, so we&#39;re just</span>
<a name="l09385"></a>09385 <span class="comment">         using the same mechanism here. It&#39;s consistent.</span>
<a name="l09386"></a>09386 <span class="comment">         On the server side, we&#39;ll also need to know the issuer account ID for the shares asset type, so</span>
<a name="l09387"></a>09387 <span class="comment">         we set that as the &quot;from&quot; account on the request voucher (again, just as a way of transmitting it.)</span>
<a name="l09388"></a>09388 <span class="comment">         */</span>
<a name="l09389"></a>09389         <span class="comment">// --------------------------------------------------</span>
<a name="l09390"></a>09390         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pDividendSourceAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l09391"></a>09391         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pDividendSourceAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l09392"></a>09392 
<a name="l09393"></a>09393         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel (pInbox );
<a name="l09394"></a>09394         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09395"></a>09395 
<a name="l09396"></a>09396         <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l09397"></a>09397         {
<a name="l09398"></a>09398             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed loading inbox for acct %s\n&quot;</span>, szFuncName, strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09399"></a>09399 
<a name="l09400"></a>09400             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09401"></a>09401             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09402"></a>09402         }
<a name="l09403"></a>09403         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l09404"></a>09404         {
<a name="l09405"></a>09405             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed loading outbox for acct %s\n&quot;</span>, szFuncName, strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09406"></a>09406 
<a name="l09407"></a>09407             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09408"></a>09408             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09409"></a>09409         }
<a name="l09410"></a>09410         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bIssueCheque)
<a name="l09411"></a>09411         {
<a name="l09412"></a>09412             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09413"></a>09413             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09414"></a>09414         }
<a name="l09415"></a>09415         <span class="keywordflow">else</span>
<a name="l09416"></a>09416         {
<a name="l09417"></a>09417             <span class="comment">// Create a transaction</span>
<a name="l09418"></a>09418             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (ISSUER_USER_ID, DIVIDEND_FROM_ACCT_ID, SERVER_ID,
<a name="l09419"></a>09419                                                                                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a1db39a50ac27161d9be40db72bf2dcf4">OTTransaction::payDividend</a>, lStoredTransactionNumber);
<a name="l09420"></a>09420             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09421"></a>09421             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a76baae22af2df636d404516ecf5ea06a">OTItem::payDividend</a>);
<a name="l09422"></a>09422             pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lTotalCostOfDividend); <span class="comment">// &lt;=== Notice, while the CHEQUE is for lAmountPerShare, the item&#39;s AMOUNT is set to lTotalCostOfDividend.</span>
<a name="l09423"></a>09423             <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot;Pay Dividend: &quot;</span>);     <span class="comment">// The server just needs both of those, so that&#39;s how we send them (Similar to the voucher code.)</span>
<a name="l09424"></a>09424             pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l09425"></a>09425 
<a name="l09426"></a>09426             <span class="comment">// Add the voucher request string as the attachment on the transaction item.</span>
<a name="l09427"></a>09427             theRequestVoucher.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09428"></a>09428             theRequestVoucher.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09429"></a>09429             <a class="code" href="class_o_t_string.html">OTString</a> strVoucher(theRequestVoucher);
<a name="l09430"></a>09430             pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strVoucher); <span class="comment">// The voucher request is contained in the reference string.</span>
<a name="l09431"></a>09431 
<a name="l09432"></a>09432             <span class="comment">// sign the item</span>
<a name="l09433"></a>09433             pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09434"></a>09434             pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09435"></a>09435 
<a name="l09436"></a>09436             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09437"></a>09437             <span class="comment">// ---------------------------------------------</span>
<a name="l09438"></a>09438             <span class="comment">// BALANCE AGREEMENT</span>
<a name="l09439"></a>09439             <span class="comment">//</span>
<a name="l09440"></a>09440             <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
<a name="l09441"></a>09441             <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lTotalCostOfDividend*(-1), *pTransaction, *pNym, *pDividendSourceAccount, *pOutbox);
<a name="l09442"></a>09442 
<a name="l09443"></a>09443             <span class="comment">// Notice the balance agreement is made for the &quot;total cost of the dividend&quot;, which we calculated as the issuer&#39;s</span>
<a name="l09444"></a>09444             <span class="comment">// account balance, times -1, times the amount per share. So for 100,000 shares of Pepsi, at a dividend payout of</span>
<a name="l09445"></a>09445             <span class="comment">// $2 per share, then $200,000 must be removed from my dollar account, in order to cover it. Therefore I sign a</span>
<a name="l09446"></a>09446             <span class="comment">// balance agreement for $200,000. The server removes it all at once, and then iterates through a loop, sending</span>
<a name="l09447"></a>09447             <span class="comment">// vouchers to people. If any fail, or there is any left over, then vouchers are sent back to pNym again, containing</span>
<a name="l09448"></a>09448             <span class="comment">// the difference.</span>
<a name="l09449"></a>09449             <span class="comment">// todo failsafe: We can&#39;t just loop, int64_t-term, and send a voucher at the end. What if it crashes halfway through</span>
<a name="l09450"></a>09450             <span class="comment">// the loop? It seems that the dividend payout still needs to be &quot;REGISTERED&quot; somewhere until successfully completed.</span>
<a name="l09451"></a>09451             <span class="comment">// (And therefore, that this concept must be repeated throughout OT for other transactions, not just this example.)</span>
<a name="l09452"></a>09452             <span class="comment">// This is already done with Cron, but just thinking about how to best do it for &quot;single action&quot; transactions.</span>
<a name="l09453"></a>09453 
<a name="l09454"></a>09454             <span class="keywordflow">if</span> (NULL != pBalanceItem)
<a name="l09455"></a>09455                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09456"></a>09456             <span class="comment">// ---------------------------------------------</span>
<a name="l09457"></a>09457             <span class="comment">// sign the transaction</span>
<a name="l09458"></a>09458             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09459"></a>09459             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09460"></a>09460 
<a name="l09461"></a>09461             <span class="comment">// set up the ledger</span>
<a name="l09462"></a>09462             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(ISSUER_USER_ID, DIVIDEND_FROM_ACCT_ID, SERVER_ID);
<a name="l09463"></a>09463             theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(DIVIDEND_FROM_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09464"></a>09464             theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l09465"></a>09465 
<a name="l09466"></a>09466             <span class="comment">// sign the ledger</span>
<a name="l09467"></a>09467             theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09468"></a>09468             theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09469"></a>09469 
<a name="l09470"></a>09470             <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l09471"></a>09471             <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09472"></a>09472             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l09473"></a>09473 
<a name="l09474"></a>09474             int64_t lRequestNumber = 0;
<a name="l09475"></a>09475 
<a name="l09476"></a>09476             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09477"></a>09477             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09478"></a>09478             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09479"></a>09479             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09480"></a>09480 
<a name="l09481"></a>09481             <span class="comment">// (1) Set up member variables</span>
<a name="l09482"></a>09482             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09483"></a>09483             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09484"></a>09484             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09485"></a>09485             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09486"></a>09486 
<a name="l09487"></a>09487             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l09488"></a>09488             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09489"></a>09489 
<a name="l09490"></a>09490             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09491"></a>09491             <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l09492"></a>09492             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09493"></a>09493             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09494"></a>09494 
<a name="l09495"></a>09495             <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l09496"></a>09496                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09497"></a>09497                               szFuncName, str_server.c_str());
<a name="l09498"></a>09498 
<a name="l09499"></a>09499             <span class="comment">// (2) Sign the Message</span>
<a name="l09500"></a>09500             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l09501"></a>09501 
<a name="l09502"></a>09502             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09503"></a>09503             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09504"></a>09504 
<a name="l09505"></a>09505             <span class="comment">// (Send it)</span>
<a name="l09506"></a>09506             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback); 
<a name="l09507"></a>09507             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l09508"></a>09508 
<a name="l09509"></a>09509             <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l09510"></a>09510         }
<a name="l09511"></a>09511     }
<a name="l09512"></a>09512     <span class="keywordflow">else</span>
<a name="l09513"></a>09513         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: No Transaction Numbers were available. &quot;</span>
<a name="l09514"></a>09514                        <span class="stringliteral">&quot;Suggest requesting the server for a new one.\n&quot;</span>, szFuncName);
<a name="l09515"></a>09515 
<a name="l09516"></a>09516     <span class="keywordflow">return</span> (-1);
<a name="l09517"></a>09517 }
<a name="l09518"></a>09518 
<a name="l09519"></a>09519 
<a name="l09520"></a>09520 
<a name="l09521"></a>09521 
<a name="l09522"></a>09522 
<a name="l09523"></a>09523 
<a name="l09524"></a>09524 
<a name="l09525"></a><a class="code" href="class_o_t___a_p_i.html#a7157cd6bf562305e24867b9521188a3c">09525</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a7157cd6bf562305e24867b9521188a3c">OT_API::withdrawVoucher</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l09526"></a>09526                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID,
<a name="l09527"></a>09527                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; ACCT_ID,
<a name="l09528"></a>09528                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; RECIPIENT_USER_ID,
<a name="l09529"></a>09529                              <a class="code" href="class_o_t_string.html">OTString</a>       &amp; CHEQUE_MEMO,
<a name="l09530"></a>09530                              <span class="keyword">const</span> int64_t      &amp; AMOUNT)
<a name="l09531"></a>09531 {
<a name="l09532"></a>09532     <span class="comment">// -----------------------------------------------------</span>
<a name="l09533"></a>09533     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l09534"></a>09534     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l09535"></a>09535     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09536"></a>09536     <span class="comment">// -----------------------------------------------------</span>
<a name="l09537"></a>09537     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09538"></a>09538     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l09539"></a>09539     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l09540"></a>09540     <span class="comment">// -----------------------------------------------------</span>
<a name="l09541"></a>09541     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l09542"></a>09542     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l09543"></a>09543     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09544"></a>09544     <span class="comment">// -----------------------------------------------------</span>
<a name="l09545"></a>09545     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    CONTRACT_ID;
<a name="l09546"></a>09546     <a class="code" href="class_o_t_string.html">OTString</a>        strContractID;
<a name="l09547"></a>09547 
<a name="l09548"></a>09548     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09549"></a>09549     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09550"></a>09550     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09551"></a>09551     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l09552"></a>09552 
<a name="l09553"></a>09553     <span class="keyword">const</span> int64_t lAmount = AMOUNT;
<a name="l09554"></a>09554 
<a name="l09555"></a>09555     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strFromAcct(ACCT_ID);
<a name="l09556"></a>09556 
<a name="l09557"></a>09557     int64_t lWithdrawTransNum = 0,
<a name="l09558"></a>09558          lVoucherTransNum  = 0;
<a name="l09559"></a>09559 
<a name="l09560"></a>09560     <span class="keywordtype">bool</span> bGotTransNum1 = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lWithdrawTransNum);
<a name="l09561"></a>09561     <span class="keywordtype">bool</span> bGotTransNum2 = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lVoucherTransNum);
<a name="l09562"></a>09562 
<a name="l09563"></a>09563     <span class="keywordflow">if</span> (!bGotTransNum1 || !bGotTransNum2)
<a name="l09564"></a>09564     {
<a name="l09565"></a>09565         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Not enough Transaction Numbers were available. &quot;</span>
<a name="l09566"></a>09566                        <span class="stringliteral">&quot;(Suggest requesting the server for more.)\n&quot;</span>, __FUNCTION__);
<a name="l09567"></a>09567 
<a name="l09568"></a>09568         <span class="keywordflow">if</span> (bGotTransNum1)
<a name="l09569"></a>09569             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09570"></a>09570         <span class="keywordflow">if</span> (bGotTransNum2)
<a name="l09571"></a>09571             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09572"></a>09572 
<a name="l09573"></a>09573         <span class="keywordflow">return</span> (-1);
<a name="l09574"></a>09574     }
<a name="l09575"></a>09575     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09576"></a>09576     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strChequeMemo(CHEQUE_MEMO);
<a name="l09577"></a>09577     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strRecipientUserID(RECIPIENT_USER_ID);
<a name="l09578"></a>09578     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09579"></a>09579     <span class="comment">// Expiration (ignored by server -- it sets its own for its vouchers.)</span>
<a name="l09580"></a>09580     <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_FROM  = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>(); <span class="comment">// This time is set to TODAY NOW</span>
<a name="l09581"></a>09581     <span class="keyword">const</span>   <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>    VALID_TO = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM, <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#ad650525921666babad17624b1a25dbcd">OT_TIME_SIX_MONTHS_IN_SECONDS</a>)); <span class="comment">// 6 months.</span>
<a name="l09582"></a>09582     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09583"></a>09583     <span class="comment">// The server only uses the memo, amount, and recipient from this cheque when it</span>
<a name="l09584"></a>09584     <span class="comment">// constructs the actual voucher.</span>
<a name="l09585"></a>09585     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theRequestVoucher(SERVER_ID, CONTRACT_ID);
<a name="l09586"></a>09586     <span class="keywordtype">bool</span> bIssueCheque = theRequestVoucher.<a class="code" href="class_o_t_cheque.html#af554e93b31bf218e373bdc8f457d7605">IssueCheque</a>(lAmount, lVoucherTransNum,
<a name="l09587"></a>09587                                                       VALID_FROM, VALID_TO, ACCT_ID, USER_ID, strChequeMemo,
<a name="l09588"></a>09588                                                       (strRecipientUserID.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2) ? &amp;(RECIPIENT_USER_ID) : NULL);
<a name="l09589"></a>09589     <span class="comment">// --------------------------------------------------</span>
<a name="l09590"></a>09590     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l09591"></a>09591     <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l09592"></a>09592 
<a name="l09593"></a>09593     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l09594"></a>09594     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09595"></a>09595     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09596"></a>09596     <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l09597"></a>09597     {
<a name="l09598"></a>09598         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::%s: Failed loading inbox for acct %s\n&quot;</span>,
<a name="l09599"></a>09599                        __FUNCTION__, strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09600"></a>09600 
<a name="l09601"></a>09601         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09602"></a>09602         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09603"></a>09603         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09604"></a>09604     }
<a name="l09605"></a>09605     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l09606"></a>09606     {
<a name="l09607"></a>09607         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::%s: Failed loading outbox for acct %s\n&quot;</span>,
<a name="l09608"></a>09608                        __FUNCTION__, strFromAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09609"></a>09609 
<a name="l09610"></a>09610         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09611"></a>09611         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09612"></a>09612         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09613"></a>09613     }
<a name="l09614"></a>09614     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bIssueCheque)
<a name="l09615"></a>09615     {
<a name="l09616"></a>09616         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09617"></a>09617         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lWithdrawTransNum, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09618"></a>09618         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lVoucherTransNum,  <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09619"></a>09619     }
<a name="l09620"></a>09620     <span class="comment">// -----------------------------------------------------------------------</span>
<a name="l09621"></a>09621     <span class="keywordflow">else</span>
<a name="l09622"></a>09622     {
<a name="l09623"></a>09623         <span class="comment">// Create a transaction</span>
<a name="l09624"></a>09624         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_ID, SERVER_ID,
<a name="l09625"></a>09625                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a9c490e1b2edddb81720905a14479d0e7">OTTransaction::withdrawal</a>, lWithdrawTransNum);
<a name="l09626"></a>09626         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09627"></a>09627         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a044b299744ed5d88b526470c0a3bbcf4">OTItem::withdrawVoucher</a>);
<a name="l09628"></a>09628         pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lAmount);
<a name="l09629"></a>09629         <a class="code" href="class_o_t_string.html">OTString</a> strNote(<span class="stringliteral">&quot; &quot;</span>);
<a name="l09630"></a>09630         pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l09631"></a>09631 
<a name="l09632"></a>09632         <span class="comment">// Add the voucher request string as the attachment on the transaction item.</span>
<a name="l09633"></a>09633         theRequestVoucher.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09634"></a>09634         theRequestVoucher.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09635"></a>09635         <a class="code" href="class_o_t_string.html">OTString</a> strVoucher(theRequestVoucher);
<a name="l09636"></a>09636         <span class="comment">// ---------------------------------------------</span>
<a name="l09637"></a>09637         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strVoucher); <span class="comment">// The voucher request is contained in the reference string.</span>
<a name="l09638"></a>09638 
<a name="l09639"></a>09639         <span class="comment">// sign the item</span>
<a name="l09640"></a>09640         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09641"></a>09641         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09642"></a>09642 
<a name="l09643"></a>09643         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09644"></a>09644         <span class="comment">// ---------------------------------------------</span>
<a name="l09645"></a>09645         <span class="comment">// BALANCE AGREEMENT</span>
<a name="l09646"></a>09646         <span class="comment">//</span>
<a name="l09647"></a>09647         <span class="comment">// The item is signed and saved within this call as well. No need to do that again.</span>
<a name="l09648"></a>09648         <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lAmount*(-1), *pTransaction, *pNym, *pAccount, *pOutbox);
<a name="l09649"></a>09649 
<a name="l09650"></a>09650         <span class="keywordflow">if</span> (NULL != pBalanceItem)
<a name="l09651"></a>09651             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l09652"></a>09652         <span class="comment">// ---------------------------------------------</span>
<a name="l09653"></a>09653         <span class="comment">// sign the transaction</span>
<a name="l09654"></a>09654         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09655"></a>09655         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09656"></a>09656 
<a name="l09657"></a>09657         <span class="comment">// set up the ledger</span>
<a name="l09658"></a>09658         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_ID, SERVER_ID);
<a name="l09659"></a>09659         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l09660"></a>09660         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l09661"></a>09661 
<a name="l09662"></a>09662         <span class="comment">// sign the ledger</span>
<a name="l09663"></a>09663         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09664"></a>09664         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09665"></a>09665 
<a name="l09666"></a>09666         <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l09667"></a>09667         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l09668"></a>09668         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l09669"></a>09669 
<a name="l09670"></a>09670         int64_t lRequestNumber = 0;
<a name="l09671"></a>09671 
<a name="l09672"></a>09672         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l09673"></a>09673         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l09674"></a>09674         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l09675"></a>09675         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l09676"></a>09676 
<a name="l09677"></a>09677         <span class="comment">// (1) Set up member variables</span>
<a name="l09678"></a>09678         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l09679"></a>09679         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l09680"></a>09680         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l09681"></a>09681         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l09682"></a>09682 
<a name="l09683"></a>09683         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l09684"></a>09684         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l09685"></a>09685 
<a name="l09686"></a>09686         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l09687"></a>09687         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l09688"></a>09688         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l09689"></a>09689         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l09690"></a>09690 
<a name="l09691"></a>09691         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l09692"></a>09692             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l09693"></a>09693                           __FUNCTION__, str_server.c_str());
<a name="l09694"></a>09694 
<a name="l09695"></a>09695         <span class="comment">// (2) Sign the Message</span>
<a name="l09696"></a>09696         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l09697"></a>09697 
<a name="l09698"></a>09698         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l09699"></a>09699         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09700"></a>09700 
<a name="l09701"></a>09701         <span class="comment">// (Send it)</span>
<a name="l09702"></a>09702         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l09703"></a>09703         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l09704"></a>09704 
<a name="l09705"></a>09705         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l09706"></a>09706     }
<a name="l09707"></a>09707 
<a name="l09708"></a>09708     <span class="keywordflow">return</span> (-1);
<a name="l09709"></a>09709 }
<a name="l09710"></a>09710 
<a name="l09711"></a>09711 
<a name="l09712"></a>09712 
<a name="l09713"></a>09713 
<a name="l09714"></a>09714 
<a name="l09715"></a>09715 
<a name="l09716"></a>09716 
<a name="l09717"></a>09717 
<a name="l09718"></a>09718 
<a name="l09719"></a>09719 
<a name="l09720"></a>09720 
<a name="l09721"></a>09721 
<a name="l09722"></a>09722 <span class="comment">// ------------------------------------------------------------------------</span>
<a name="l09723"></a>09723 <span class="comment">//</span>
<a name="l09724"></a>09724 <span class="comment">// DISCARD CHEQUE (recover the transaction number for re-use, so the cheque</span>
<a name="l09725"></a>09725 <span class="comment">// can be discarded.)</span>
<a name="l09726"></a>09726 <span class="comment">//</span>
<a name="l09727"></a>09727 <span class="comment">// NOTE: this function is only for cheques that haven&#39;t been sent to anyone.</span>
<a name="l09728"></a>09728 <span class="comment">// Once a cheque has been sent to someone, more is necessary to cancel the</span>
<a name="l09729"></a>09729 <span class="comment">// cheque -- you must recover the transaction number on the server side,</span>
<a name="l09730"></a>09730 <span class="comment">// not just on the client side. (So if someone tries to deposit it, the cheque</span>
<a name="l09731"></a>09731 <span class="comment">// is no good since the transaction number is already closed out.)</span>
<a name="l09732"></a>09732 <span class="comment">//</span>
<a name="l09733"></a>09733 <span class="comment">// Hmm -- but the cheque goes into the outbox as soon as it&#39;s written. Plus,</span>
<a name="l09734"></a>09734 <span class="comment">// just because I didn&#39;t send the cheque through OT, doesn&#39;t mean I didn&#39;t send</span>
<a name="l09735"></a>09735 <span class="comment">// him a copy in the email. So I really need to close out the number either</span>
<a name="l09736"></a>09736 <span class="comment">// way. I think the easiest way to do this is to alter the NotarizeDepositCheque</span>
<a name="l09737"></a>09737 <span class="comment">// (on server side) so that if you deposit a cheque back into the same account</span>
<a name="l09738"></a>09738 <span class="comment">// it&#39;s drawn on, that it cancels the cheque and closes out the transaction</span>
<a name="l09739"></a>09739 <span class="comment">// number. So &quot;cheque cancellation&quot; will just be handled by the deposit function.</span>
<a name="l09740"></a>09740 <span class="comment">//</span>
<a name="l09741"></a>09741 <span class="comment">// Therefore this &quot;discard cheque&quot; function will probably only be used internally</span>
<a name="l09742"></a>09742 <span class="comment">// by the high-level API, for certain special harvesting cases where the cheque</span>
<a name="l09743"></a>09743 <span class="comment">// hasn&#39;t possibly been sent or used anywhere when it&#39;s discarded.</span>
<a name="l09744"></a>09744 <span class="comment">//</span>
<a name="l09745"></a>09745 <span class="comment">// Voucher update: now that the remitter&#39;s transaction number is used on vouchers,</span>
<a name="l09746"></a>09746 <span class="comment">// you would think that we would have to retrofit this function to support vouchers</span>
<a name="l09747"></a>09747 <span class="comment">// as well. However, that&#39;s not the case. The reason is because vouchers must be</span>
<a name="l09748"></a>09748 <span class="comment">// withdrawn at the server, which means creating a voucher automatically implies</span>
<a name="l09749"></a>09749 <span class="comment">// that the server has already marked the transaction number as &quot;in use.&quot;</span>
<a name="l09750"></a>09750 <span class="comment">// BUT ACTUALLY I&#39;M WRONG ABOUT THAT! The server doesn&#39;t mark it as &quot;in use&quot; until</span>
<a name="l09751"></a>09751 <span class="comment">// it&#39;s DEPOSITED -- and then marks it as &quot;closed&quot; once the voucherReceipt is</span>
<a name="l09752"></a>09752 <span class="comment">// processed. That might seem strange -- the server issues a voucher, drawn on</span>
<a name="l09753"></a>09753 <span class="comment">// its own account, without marking its transaction number as &quot;in use&quot; ? Reason is,</span>
<a name="l09754"></a>09754 <span class="comment">// the instrument still cannot actually be used without depositing it, at which time</span>
<a name="l09755"></a>09755 <span class="comment">// the transaction number WILL be marked as &quot;in use.&quot; Until then, you could recover</span>
<a name="l09756"></a>09756 <span class="comment">// the number and use it somewhere else instead. But why the hell would you do that?</span>
<a name="l09757"></a>09757 <span class="comment">// Because once you do that, you can no longer use it with the voucher, which means</span>
<a name="l09758"></a>09758 <span class="comment">// you can no longer recover any of the money that you sent to the server, when you</span>
<a name="l09759"></a>09759 <span class="comment">// purchased that voucher in the first place. Therefore you would NEVER want to just</span>
<a name="l09760"></a>09760 <span class="comment">// &quot;discard&quot; a voucher like you might with a cheque -- that voucher cost you money!</span>
<a name="l09761"></a>09761 <span class="comment">// Basically you would DEFINITELY want to REFUND that voucher and get that money BACK,</span>
<a name="l09762"></a>09762 <span class="comment">// and not merely re-use the number on it. Therefore vouchers will never just be</span>
<a name="l09763"></a>09763 <span class="comment">// &quot;discarded&quot; but rather, stored in the outpayment box and REFUNDED if necessary.</span>
<a name="l09764"></a>09764 <span class="comment">// (Therefore we won&#39;t be retrofitting this function for vouchers.)</span>
<a name="l09765"></a>09765 <span class="comment">//</span>
<a name="l09766"></a><a class="code" href="class_o_t___a_p_i.html#a8e1fde16ebe39537f28c737844d09d1f">09766</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#a8e1fde16ebe39537f28c737844d09d1f">OT_API::DiscardCheque</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l09767"></a>09767                            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l09768"></a>09768                            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCT_ID,
<a name="l09769"></a>09769                            <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_CHEQUE)
<a name="l09770"></a>09770 {
<a name="l09771"></a>09771     <span class="comment">// -----------------------------------------------------</span>
<a name="l09772"></a>09772     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l09773"></a>09773     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09774"></a>09774     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09775"></a>09775     <span class="comment">// -----------------------------------------------------</span>
<a name="l09776"></a>09776     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09777"></a>09777     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09778"></a>09778     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l09779"></a>09779     <span class="comment">// -----------------------------------------------------</span>
<a name="l09780"></a>09780     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l09781"></a>09781     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09782"></a>09782     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09783"></a>09783     <span class="comment">// -----------------------------------------------------</span>
<a name="l09784"></a>09784     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    CONTRACT_ID;
<a name="l09785"></a>09785     <a class="code" href="class_o_t_string.html">OTString</a>        strContractID;
<a name="l09786"></a>09786 
<a name="l09787"></a>09787     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09788"></a>09788     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09789"></a>09789     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09790"></a>09790     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l09791"></a>09791     <span class="comment">//  (No need to cleanup.)  pServer and pAccount are also good.</span>
<a name="l09792"></a>09792     <span class="comment">//</span>
<a name="l09793"></a>09793     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09794"></a>09794     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l09795"></a>09795 
<a name="l09796"></a>09796     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(SERVER_ID, CONTRACT_ID);
<a name="l09797"></a>09797 
<a name="l09798"></a>09798     <span class="keywordflow">if</span> (!theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(THE_CHEQUE))
<a name="l09799"></a>09799     {
<a name="l09800"></a>09800         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to load cheque from string. Sorry. Cheque contents:\n\n%s\n\n&quot;</span>,
<a name="l09801"></a>09801                        __FUNCTION__, THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09802"></a>09802         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09803"></a>09803     }
<a name="l09804"></a>09804     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((theCheque.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>()     == SERVER_ID)   &amp;&amp;
<a name="l09805"></a>09805              (theCheque.<a class="code" href="class_o_t_instrument.html#a1f6c7b528680d84dcb998d473bdd99a6">GetAssetID</a>()      == CONTRACT_ID) &amp;&amp;
<a name="l09806"></a>09806              (theCheque.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() == USER_ID)     &amp;&amp;
<a name="l09807"></a>09807              (theCheque.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>() == ACCT_ID))
<a name="l09808"></a>09808     {
<a name="l09809"></a>09809         <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>())) <span class="comment">// we only &quot;add it back&quot; if it was really there in the first place.</span>
<a name="l09810"></a>09810         {
<a name="l09811"></a>09811             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>(), <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09812"></a>09812             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09813"></a>09813         }
<a name="l09814"></a>09814         <span class="keywordflow">else</span> <span class="comment">// No point adding it back as available to use, if pNym doesn&#39;t even have it signed out!</span>
<a name="l09815"></a>09815         {
<a name="l09816"></a>09816             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed attempt to claw back a transaction number that wasn&#39;t signed &quot;</span>
<a name="l09817"></a>09817                            <span class="stringliteral">&quot;out to pNym in the first place. Cheque contents:\n\n%s\n\n&quot;</span>, __FUNCTION__, THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09818"></a>09818             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09819"></a>09819         }
<a name="l09820"></a>09820     } <span class="comment">// bSuccess</span>
<a name="l09821"></a>09821     <span class="keywordflow">else</span>
<a name="l09822"></a>09822         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to verify cheque&#39;s server ID, asset type ID, user ID, or acct ID. &quot;</span>
<a name="l09823"></a>09823                        <span class="stringliteral">&quot;Sorry. Cheque contents:\n\n%s\n\n&quot;</span>, __FUNCTION__, THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09824"></a>09824     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09825"></a>09825 }
<a name="l09826"></a>09826 
<a name="l09827"></a>09827 
<a name="l09828"></a>09828 
<a name="l09829"></a>09829 
<a name="l09830"></a>09830 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l09831"></a>09831 <span class="comment">// DEPOSIT CHEQUE</span>
<a name="l09832"></a>09832 <span class="comment">//</span>
<a name="l09833"></a>09833 <span class="comment">// NOTE: If THE_CHEQUE is drawn on the account denoted by ACCT_ID (meaning</span>
<a name="l09834"></a>09834 <span class="comment">// it&#39;s being deposited back into the same account that originally wrote</span>
<a name="l09835"></a>09835 <span class="comment">// the cheque) this means the original cheque writer is CANCELLING the</span>
<a name="l09836"></a>09836 <span class="comment">// cheque, to prevent the recipient from depositing it.</span>
<a name="l09837"></a>09837 
<a name="l09838"></a><a class="code" href="class_o_t___a_p_i.html#a1216782dbd78afbf72e269e81c936c6b">09838</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a1216782dbd78afbf72e269e81c936c6b">OT_API::depositCheque</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; SERVER_ID,
<a name="l09839"></a>09839                           <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; USER_ID,
<a name="l09840"></a>09840                           <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; ACCT_ID,
<a name="l09841"></a>09841                           <a class="code" href="class_o_t_string.html">OTString</a>      &amp; THE_CHEQUE)
<a name="l09842"></a>09842 {
<a name="l09843"></a>09843     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// These copiously log, and ASSERT.</span>
<a name="l09844"></a>09844     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l09845"></a>09845     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09846"></a>09846     <span class="comment">// -----------------------------------------------------</span>
<a name="l09847"></a>09847     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l09848"></a>09848     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l09849"></a>09849     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l09850"></a>09850     <span class="comment">// -----------------------------------------------------</span>
<a name="l09851"></a>09851     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l09852"></a>09852     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l09853"></a>09853     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l09854"></a>09854     <span class="comment">// -----------------------------------------------------</span>
<a name="l09855"></a>09855     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> CONTRACT_ID;
<a name="l09856"></a>09856     <a class="code" href="class_o_t_string.html">OTString</a>     strContractID;
<a name="l09857"></a>09857     CONTRACT_ID = pAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l09858"></a>09858     CONTRACT_ID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(strContractID);
<a name="l09859"></a>09859     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l09860"></a>09860     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l09861"></a>09861     int64_t lRequestNumber = 0;
<a name="l09862"></a>09862 
<a name="l09863"></a>09863     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strDepositAcct(ACCT_ID);
<a name="l09864"></a>09864 
<a name="l09865"></a>09865     <a class="code" href="class_o_t_cheque.html">OTCheque</a> theCheque(SERVER_ID, CONTRACT_ID);
<a name="l09866"></a>09866 
<a name="l09867"></a>09867     int64_t lStoredTransactionNumber=0;
<a name="l09868"></a>09868     <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber);
<a name="l09869"></a>09869 
<a name="l09870"></a>09870     <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l09871"></a>09871         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: No transaction numbers were available. &quot;</span>
<a name="l09872"></a>09872                        <span class="stringliteral">&quot;Try requesting the server for a new one.\n&quot;</span>, __FUNCTION__);
<a name="l09873"></a>09873     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theCheque.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(THE_CHEQUE))
<a name="l09874"></a>09874     {
<a name="l09875"></a>09875         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to load cheque from string. Sorry. Contents:\n\n%s\n\n&quot;</span>,
<a name="l09876"></a>09876                        __FUNCTION__, THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09877"></a>09877         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09878"></a>09878         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09879"></a>09879     }
<a name="l09880"></a>09880     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theCheque.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>() != SERVER_ID)
<a name="l09881"></a>09881     {
<a name="l09882"></a>09882         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strChequeServerID(theCheque.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>());
<a name="l09883"></a>09883         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: ServerID on cheque (%s) doesn&#39;t match serverID where it&#39;s being deposited to (%s).&quot;</span>,
<a name="l09884"></a>09884                        __FUNCTION__, strChequeServerID.Get(), strServerID.Get());
<a name="l09885"></a>09885         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09886"></a>09886         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09887"></a>09887     }
<a name="l09888"></a>09888     <span class="keywordflow">else</span>
<a name="l09889"></a>09889     {
<a name="l09890"></a>09890         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l09891"></a>09891         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l09892"></a>09892 
<a name="l09893"></a>09893         <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l09894"></a>09894         {
<a name="l09895"></a>09895             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed loading inbox for acct %s\n&quot;</span>, __FUNCTION__, strDepositAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09896"></a>09896             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09897"></a>09897             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09898"></a>09898             <span class="keywordflow">return</span> -1;
<a name="l09899"></a>09899         }
<a name="l09900"></a>09900         <span class="comment">// -----------------------------------------------------------------------------------</span>
<a name="l09901"></a>09901         <span class="comment">// If bCancellingCheque==true, we&#39;re actually cancelling the cheque by &quot;depositing&quot;</span>
<a name="l09902"></a>09902         <span class="comment">// it back into the same account it&#39;s drawn on.</span>
<a name="l09903"></a>09903         <span class="comment">//</span>
<a name="l09904"></a>09904         <span class="keywordtype">bool</span> bCancellingCheque = <span class="keyword">false</span>;
<a name="l09905"></a>09905 
<a name="l09906"></a>09906         <span class="keywordflow">if</span> (theCheque.<a class="code" href="class_o_t_cheque.html#ace0bed9152fe95a16e257bb48bf76d6f">HasRemitter</a>())
<a name="l09907"></a>09907             bCancellingCheque = ( (theCheque.<a class="code" href="class_o_t_cheque.html#a749bbaa8f7d864a16b95eaf9a8d5b684">GetRemitterAcctID</a>() == ACCT_ID) &amp;&amp;
<a name="l09908"></a>09908                                   (theCheque.<a class="code" href="class_o_t_cheque.html#ac58c338fc0a151ed12eaa9e86a9c1329">GetRemitterUserID</a>() == USER_ID));
<a name="l09909"></a>09909         <span class="keywordflow">else</span>
<a name="l09910"></a>09910         {
<a name="l09911"></a>09911             bCancellingCheque = ( (theCheque.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>() == ACCT_ID) &amp;&amp;
<a name="l09912"></a>09912                                   (theCheque.<a class="code" href="class_o_t_trackable.html#aaf5d36407abeeb35eea54f7acb0c3148">GetSenderUserID</a>() == USER_ID));
<a name="l09913"></a>09913             <span class="keywordflow">if</span> (bCancellingCheque)
<a name="l09914"></a>09914                 bCancellingCheque = theCheque.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym);
<a name="l09915"></a>09915         }
<a name="l09916"></a>09916         <span class="comment">// -----------------------------------------------------------------------------------</span>
<a name="l09917"></a>09917         <span class="keywordflow">if</span> (bCancellingCheque) <span class="comment">// By this point he&#39;s definitely TRYING to cancel the cheque.</span>
<a name="l09918"></a>09918         {
<a name="l09919"></a>09919             bCancellingCheque = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l09920"></a>09920 
<a name="l09921"></a>09921             <span class="comment">// If we TRIED to cancel the cheque (being in this block...) yet the signature fails</span>
<a name="l09922"></a>09922             <span class="comment">// to verify, or the transaction number isn&#39;t even issued, then our attempt to cancel</span>
<a name="l09923"></a>09923             <span class="comment">// the cheque is going to fail.</span>
<a name="l09924"></a>09924             <span class="keywordflow">if</span> (!bCancellingCheque)
<a name="l09925"></a>09925             {
<a name="l09926"></a>09926                 <span class="comment">// This is the &quot;tried and failed&quot; block.</span>
<a name="l09927"></a>09927                 <span class="comment">//</span>
<a name="l09928"></a>09928                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Cannot cancel this cheque. Either the signature fails to verify,\n&quot;</span>
<a name="l09929"></a>09929                                <span class="stringliteral">&quot;or the transaction number is already closed out. (Failure.) Cheque contents:\n\n%s\n\n&quot;</span>,
<a name="l09930"></a>09930                                __FUNCTION__, THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09931"></a>09931 
<a name="l09932"></a>09932                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09933"></a>09933                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09934"></a>09934                 <span class="keywordflow">return</span> (-1);
<a name="l09935"></a>09935             }
<a name="l09936"></a>09936             <span class="comment">// Else we succeeded in verifying signature and issued num.</span>
<a name="l09937"></a>09937             <span class="comment">// -----------------------------------------------------</span>
<a name="l09938"></a>09938             <span class="comment">// Let&#39;s just make sure there isn&#39;t a chequeReceipt or voucherReceipt</span>
<a name="l09939"></a>09939             <span class="comment">// already sitting in the inbox, for this same cheque.</span>
<a name="l09940"></a>09940             <span class="comment">//</span>
<a name="l09941"></a>09941             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pChequeReceipt = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#ac364836ff42d8a8d873050b86a72c7d9">GetChequeReceipt</a>(theCheque.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l09942"></a>09942 
<a name="l09943"></a>09943             <span class="keywordflow">if</span> (NULL != pChequeReceipt) <span class="comment">// Hmm looks like there&#39;s ALREADY a chequeReceipt in the inbox (so we can&#39;t cancel it.)</span>
<a name="l09944"></a>09944             {
<a name="l09945"></a>09945                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Cannot cancel this cheque. There is already a %s for it in the inbox. &quot;</span>
<a name="l09946"></a>09946                                <span class="stringliteral">&quot;(Failure.) Cheque contents:\n\n%s\n\n&quot;</span>, __FUNCTION__,
<a name="l09947"></a>09947                                theCheque.<a class="code" href="class_o_t_cheque.html#ace0bed9152fe95a16e257bb48bf76d6f">HasRemitter</a>() ? <span class="stringliteral">&quot;voucherReceipt&quot;</span> : <span class="stringliteral">&quot;chequeReceipt&quot;</span>,
<a name="l09948"></a>09948                                THE_CHEQUE.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09949"></a>09949                 <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09950"></a>09950                 pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l09951"></a>09951                 <span class="keywordflow">return</span> (-1);
<a name="l09952"></a>09952             }
<a name="l09953"></a>09953         }
<a name="l09954"></a>09954         <span class="comment">// ------------------------------------------</span>
<a name="l09955"></a>09955         <span class="comment">// By this point, we&#39;re either NOT cancelling the cheque, or if we are, we&#39;ve already</span>
<a name="l09956"></a>09956         <span class="comment">// verified the signature and transaction number on the cheque. (AND we&#39;ve already</span>
<a name="l09957"></a>09957         <span class="comment">// verified that there aren&#39;t any chequeReceipts for this cheque, in the inbox.)</span>
<a name="l09958"></a>09958         <span class="comment">//</span>
<a name="l09959"></a>09959         <span class="keywordflow">if</span> (bCancellingCheque &amp;&amp; !theCheque.<a class="code" href="class_o_t_cheque.html#ace0bed9152fe95a16e257bb48bf76d6f">HasRemitter</a>())
<a name="l09960"></a>09960         {
<a name="l09961"></a>09961             theCheque.<a class="code" href="class_o_t_cheque.html#a2e79713d1c441f07e892ecb2c506d61b">CancelCheque</a>(); <span class="comment">// Sets the amount to zero.</span>
<a name="l09962"></a>09962             <span class="comment">// ---------------------------------</span>
<a name="l09963"></a>09963             theCheque.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>(); <span class="comment">// Usually when you deposit a cheque, it&#39;s signed by someone else.</span>
<a name="l09964"></a>09964             theCheque.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym); <span class="comment">// But if we are CANCELING a cheque, that means we wrote that cheque</span>
<a name="l09965"></a>09965             theCheque.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();      <span class="comment">// originally, so we are the original signer.</span>
<a name="l09966"></a>09966         } <span class="comment">// cancelling cheque</span>
<a name="l09967"></a>09967         <span class="comment">// ------------------------------------</span>
<a name="l09968"></a>09968         <span class="comment">// Create a transaction</span>
<a name="l09969"></a>09969         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_ID, SERVER_ID,
<a name="l09970"></a>09970                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8ac4cf1c0cdeac5cb3636c34b4682ad228">OTTransaction::deposit</a>,
<a name="l09971"></a>09971                                                                            lStoredTransactionNumber);
<a name="l09972"></a>09972         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTTransaction&gt;</a> theTransactionAngel(pTransaction);
<a name="l09973"></a>09973 
<a name="l09974"></a>09974         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l09975"></a>09975         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ac98fe1ea932d3c87f450a216e6a26bec">OTItem::depositCheque</a>);
<a name="l09976"></a>09976 
<a name="l09977"></a>09977         <a class="code" href="class_o_t_string.html">OTString</a> strNote(bCancellingCheque ? <span class="stringliteral">&quot;Cancel this cheque, please!&quot;</span> : <span class="stringliteral">&quot;Deposit this cheque, please!&quot;</span>); <span class="comment">// todo</span>
<a name="l09978"></a>09978         pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(strNote);
<a name="l09979"></a>09979 
<a name="l09980"></a>09980         <a class="code" href="class_o_t_string.html">OTString</a> strCheque(theCheque);  <span class="comment">// &lt;===== THE CHEQUE</span>
<a name="l09981"></a>09981 
<a name="l09982"></a>09982         <span class="comment">// Add the cheque string as the attachment on the transaction item.</span>
<a name="l09983"></a>09983         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strCheque); <span class="comment">// The cheque is contained in the reference string.</span>
<a name="l09984"></a>09984 
<a name="l09985"></a>09985         <span class="comment">// sign the item</span>
<a name="l09986"></a>09986         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l09987"></a>09987         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l09988"></a>09988 
<a name="l09989"></a>09989         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l09990"></a>09990         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l09991"></a>09991         <span class="comment">// ---------------------------------------------</span>
<a name="l09992"></a>09992         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l09993"></a>09993         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l09994"></a>09994 
<a name="l09995"></a>09995         <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l09996"></a>09996         {
<a name="l09997"></a>09997             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::depositCheque: Failed loading outbox for acct %s\n&quot;</span>, strDepositAcct.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l09998"></a>09998             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l09999"></a>09999             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l10000"></a>10000         }
<a name="l10001"></a>10001         <span class="keywordflow">else</span>
<a name="l10002"></a>10002         {
<a name="l10003"></a>10003             <span class="comment">// BALANCE AGREEMENT</span>
<a name="l10004"></a>10004             <span class="comment">// ---------------------------------------------</span>
<a name="l10005"></a>10005             <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that twice.</span>
<a name="l10006"></a>10006             <span class="comment">//</span>
<a name="l10007"></a>10007             <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(theCheque.<a class="code" href="class_o_t_cheque.html#a84e570d654f20e69f64f0037b96b7c7e">GetAmount</a>(), *pTransaction, *pNym, *pAccount, *pOutbox);
<a name="l10008"></a>10008 
<a name="l10009"></a>10009             <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l10010"></a>10010                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l10011"></a>10011             <span class="comment">// else log</span>
<a name="l10012"></a>10012             <span class="comment">// ---------------------------------------------</span>
<a name="l10013"></a>10013             <span class="comment">// sign the transaction</span>
<a name="l10014"></a>10014             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10015"></a>10015             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10016"></a>10016 
<a name="l10017"></a>10017             <span class="comment">// set up the ledger</span>
<a name="l10018"></a>10018             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_ID, SERVER_ID);
<a name="l10019"></a>10019             theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l10020"></a>10020             theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l10021"></a>10021             theTransactionAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL); <span class="comment">// No more need to cleanup pTransaction.</span>
<a name="l10022"></a>10022 
<a name="l10023"></a>10023             <span class="comment">// sign the ledger</span>
<a name="l10024"></a>10024             theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10025"></a>10025             theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10026"></a>10026 
<a name="l10027"></a>10027             <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l10028"></a>10028             <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l10029"></a>10029             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l10030"></a>10030 
<a name="l10031"></a>10031             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10032"></a>10032             pNym-&gt;GetCurrentRequestNum(strServerID, lRequestNumber);
<a name="l10033"></a>10033             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10034"></a>10034             pNym-&gt;IncrementRequestNum(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10035"></a>10035 
<a name="l10036"></a>10036             <span class="comment">// (1) Set up member variables</span>
<a name="l10037"></a>10037             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l10038"></a>10038             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10039"></a>10039             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10040"></a>10040             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10041"></a>10041 
<a name="l10042"></a>10042             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strDepositAcct;
<a name="l10043"></a>10043             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l10044"></a>10044 
<a name="l10045"></a>10045             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10046"></a>10046             <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l10047"></a>10047             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;GetNymboxHash(str_server, NYMBOX_HASH);
<a name="l10048"></a>10048             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10049"></a>10049 
<a name="l10050"></a>10050             <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l10051"></a>10051                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10052"></a>10052                               str_server.c_str());
<a name="l10053"></a>10053 
<a name="l10054"></a>10054             <span class="comment">// (2) Sign the Message</span>
<a name="l10055"></a>10055             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l10056"></a>10056 
<a name="l10057"></a>10057             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10058"></a>10058             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10059"></a>10059 
<a name="l10060"></a>10060             <span class="comment">// (Send it)</span>
<a name="l10061"></a>10061             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l10062"></a>10062             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l10063"></a>10063 
<a name="l10064"></a>10064             <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l10065"></a>10065         }
<a name="l10066"></a>10066     } <span class="comment">// bSuccess</span>
<a name="l10067"></a>10067 
<a name="l10068"></a>10068     <span class="keywordflow">return</span> -1;
<a name="l10069"></a>10069 }
<a name="l10070"></a>10070 
<a name="l10071"></a>10071 
<a name="l10072"></a>10072 
<a name="l10073"></a>10073 
<a name="l10074"></a>10074 
<a name="l10075"></a>10075 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l10076"></a>10076 <span class="comment">// DEPOSIT PAYMENT PLAN</span>
<a name="l10077"></a>10077 <span class="comment">//</span>
<a name="l10078"></a>10078 <span class="comment">// The Recipient Creates the Payment Plan using ProposePaymentPlan.</span>
<a name="l10079"></a>10079 <span class="comment">// Then the sender Confirms it using ConfirmPaymentPlan.</span>
<a name="l10080"></a>10080 <span class="comment">// Both of the above steps involve attaching transaction numbers to</span>
<a name="l10081"></a>10081 <span class="comment">// the payment plan and signing copies of it.</span>
<a name="l10082"></a>10082 <span class="comment">// This function here is the final step, where the payment plan</span>
<a name="l10083"></a>10083 <span class="comment">// contract is now being deposited by the customer (who is also</span>
<a name="l10084"></a>10084 <span class="comment">// the sender), in a message to the server.</span>
<a name="l10085"></a>10085 <span class="comment">//</span>
<a name="l10086"></a><a class="code" href="class_o_t___a_p_i.html#a4b11c8f60024b34f43c9a9132fe8ac65">10086</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a4b11c8f60024b34f43c9a9132fe8ac65">OT_API::depositPaymentPlan</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l10087"></a>10087                                <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l10088"></a>10088                                <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_PAYMENT_PLAN)
<a name="l10089"></a>10089 {
<a name="l10090"></a>10090     <span class="comment">// -----------------------------------------------------</span>
<a name="l10091"></a>10091     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10092"></a>10092     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l10093"></a>10093     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l10094"></a>10094     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l10095"></a>10095     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10096"></a>10096     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l10097"></a>10097     <span class="comment">// By this point, pNym is a good pointer.  (No need to cleanup.)</span>
<a name="l10098"></a>10098     <span class="comment">// -----------------------------------------------------------------</span>
<a name="l10099"></a>10099     <a class="code" href="class_o_t_payment_plan.html">OTPaymentPlan</a>   thePlan;
<a name="l10100"></a>10100     <a class="code" href="class_o_t_message.html">OTMessage</a>       theMessage;
<a name="l10101"></a>10101     int64_t         lRequestNumber = 0;
<a name="l10102"></a>10102 
<a name="l10103"></a>10103     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l10104"></a>10104 
<a name="l10105"></a>10105     <span class="keywordflow">if</span> (thePlan.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(THE_PAYMENT_PLAN) &amp;&amp;
<a name="l10106"></a>10106         thePlan.<a class="code" href="class_o_t_contract.html#a38f51d593b6dfc8a75d1c5a535965392">VerifySignature</a>(*pNym))
<a name="l10107"></a>10107     {
<a name="l10108"></a>10108         <span class="keyword">const</span> <span class="keywordtype">bool</span> bCancelling = (thePlan.<a class="code" href="class_o_t_agreement.html#a87e9b6e7028af7ddfebaee86925e8e7b">GetRecipientUserID</a>() == USER_ID);
<a name="l10109"></a>10109 
<a name="l10110"></a>10110         <span class="keywordflow">if</span> (bCancelling)
<a name="l10111"></a>10111         {
<a name="l10112"></a>10112             <span class="keywordflow">if</span> (thePlan.<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>())
<a name="l10113"></a>10113             {
<a name="l10114"></a>10114                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: attempted to cancel (pre-emptively, before activation) a payment plan &quot;</span>
<a name="l10115"></a>10115                               <span class="stringliteral">&quot;that was already set as canceled.\n&quot;</span>, __FUNCTION__);
<a name="l10116"></a>10116                 <span class="keywordflow">return</span> (-1);
<a name="l10117"></a>10117             }
<a name="l10118"></a>10118             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!thePlan.<a class="code" href="class_o_t_cron_item.html#ad5f37660feb3396c382a5ec5987981c7">CancelBeforeActivation</a>(*pNym)) <span class="comment">// releases signatures, signs, saves.</span>
<a name="l10119"></a>10119             {
<a name="l10120"></a>10120                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: attempted to cancel (pre-emptively, before activation) a payment plan, &quot;</span>
<a name="l10121"></a>10121                               <span class="stringliteral">&quot;but the attempt somehow failed.\n&quot;</span>, __FUNCTION__);
<a name="l10122"></a>10122                 <span class="keywordflow">return</span> (-1);
<a name="l10123"></a>10123             }
<a name="l10124"></a>10124         }
<a name="l10125"></a>10125 
<a name="l10126"></a>10126         <span class="comment">// The logic for DEPOSITOR_ACCT_ID comes about because normally the sender is the one</span>
<a name="l10127"></a>10127         <span class="comment">// who activates the payment plan. BUT the recipient might ALSO activate it as a way</span>
<a name="l10128"></a>10128         <span class="comment">// of CANCELLING it. So we check to see if the recipient user is the same as USER_ID.</span>
<a name="l10129"></a>10129         <span class="comment">// If so, then we use the RECIPIENT account here (it&#39;s being cancelled.) Otherwise,</span>
<a name="l10130"></a>10130         <span class="comment">// we use the sender account ID here as normal (it&#39;s being activated.)</span>
<a name="l10131"></a>10131         <span class="comment">//</span>
<a name="l10132"></a>10132         <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  DEPOSITOR_ACCT_ID(bCancelling ? thePlan.<a class="code" href="class_o_t_agreement.html#a66300d99a12d32b6825e7e11dfca8614">GetRecipientAcctID</a>() : thePlan.<a class="code" href="class_o_t_trackable.html#a3149b0da54958e8da4cf15d26f47711f">GetSenderAcctID</a>());
<a name="l10133"></a>10133         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>      strDepositAcct(DEPOSITOR_ACCT_ID);
<a name="l10134"></a>10134         <span class="comment">// -----------------------------------------------------</span>
<a name="l10135"></a>10135         <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, DEPOSITOR_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l10136"></a>10136         <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l10137"></a>10137         <span class="comment">// By this point, pAccount is a good pointer and in the wallet.</span>
<a name="l10138"></a>10138         <span class="comment">// (No need to cleanup.) I also know it has the right Server ID</span>
<a name="l10139"></a>10139         <span class="comment">// and that the Nym owns it, and has signed it, etc.</span>
<a name="l10140"></a>10140         <span class="comment">// -----------------------------------------------------</span>
<a name="l10141"></a>10141         <span class="comment">// If the depositor is the recipient, then it&#39;s not properly confirmed yet, and he&#39;s</span>
<a name="l10142"></a>10142         <span class="comment">// actually cancelling it here. The transaction number on the plan will still be set to 0.</span>
<a name="l10143"></a>10143         <span class="comment">// Therefore he needs to use a fresh transaction number to perform this action.</span>
<a name="l10144"></a>10144         <span class="comment">// Otherwise, if the depositor is the sender (as should normally be) then the plan is</span>
<a name="l10145"></a>10145         <span class="comment">// actually being activated, and has already been properly confirmed, and will thus</span>
<a name="l10146"></a>10146         <span class="comment">// already have its own transaction number set on it.</span>
<a name="l10147"></a>10147         <span class="comment">//</span>
<a name="l10148"></a>10148         <span class="keyword">const</span> int64_t lTransactionNum = thePlan.<a class="code" href="class_o_t_agreement.html#a809937fd06b26ff5791094592be68b0d">GetOpeningNumber</a>(USER_ID);
<a name="l10149"></a>10149         <span class="comment">// ---------------------------------------------</span>
<a name="l10150"></a>10150         <span class="comment">// Create a transaction</span>
<a name="l10151"></a>10151         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, DEPOSITOR_ACCT_ID, SERVER_ID,
<a name="l10152"></a>10152                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a7b7b233a1f4438ee26116ba1bda92cb0">OTTransaction::paymentPlan</a>, lTransactionNum);
<a name="l10153"></a>10153         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l10154"></a>10154         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a38a11345dca4c5dad62a270f100ea16f">OTItem::paymentPlan</a>);
<a name="l10155"></a>10155 
<a name="l10156"></a>10156         <a class="code" href="class_o_t_string.html">OTString</a> strPlan(thePlan);
<a name="l10157"></a>10157 
<a name="l10158"></a>10158         <span class="comment">// Add the payment plan string as the attachment on the transaction item.</span>
<a name="l10159"></a>10159         pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strPlan); <span class="comment">// The payment plan is contained in the reference string.</span>
<a name="l10160"></a>10160 
<a name="l10161"></a>10161         <span class="comment">// sign the item</span>
<a name="l10162"></a>10162         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10163"></a>10163         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10164"></a>10164 
<a name="l10165"></a>10165         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l10166"></a>10166         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l10167"></a>10167 
<a name="l10168"></a>10168         <span class="comment">// ---------------------------------------------</span>
<a name="l10169"></a>10169         <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l10170"></a>10170 
<a name="l10171"></a>10171         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l10172"></a>10172         <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l10173"></a>10173 
<a name="l10174"></a>10174         <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l10175"></a>10175             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l10176"></a>10176         <span class="comment">// ---------------------------------------------</span>
<a name="l10177"></a>10177         <span class="comment">// sign the transaction</span>
<a name="l10178"></a>10178         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10179"></a>10179         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10180"></a>10180 
<a name="l10181"></a>10181         <span class="comment">// set up the ledger</span>
<a name="l10182"></a>10182         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, DEPOSITOR_ACCT_ID, SERVER_ID);
<a name="l10183"></a>10183         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(DEPOSITOR_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l10184"></a>10184         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l10185"></a>10185 
<a name="l10186"></a>10186         <span class="comment">// sign the ledger</span>
<a name="l10187"></a>10187         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10188"></a>10188         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10189"></a>10189 
<a name="l10190"></a>10190         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l10191"></a>10191         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l10192"></a>10192         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l10193"></a>10193 
<a name="l10194"></a>10194         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10195"></a>10195         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l10196"></a>10196         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10197"></a>10197         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10198"></a>10198 
<a name="l10199"></a>10199         <span class="comment">// (1) Set up member variables</span>
<a name="l10200"></a>10200         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l10201"></a>10201         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10202"></a>10202         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10203"></a>10203         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10204"></a>10204 
<a name="l10205"></a>10205         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strDepositAcct;
<a name="l10206"></a>10206         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l10207"></a>10207 
<a name="l10208"></a>10208         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10209"></a>10209         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l10210"></a>10210         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l10211"></a>10211         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10212"></a>10212 
<a name="l10213"></a>10213         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l10214"></a>10214             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10215"></a>10215                           str_server.c_str());
<a name="l10216"></a>10216 
<a name="l10217"></a>10217         <span class="comment">// (2) Sign the Message</span>
<a name="l10218"></a>10218         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l10219"></a>10219 
<a name="l10220"></a>10220         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10221"></a>10221         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10222"></a>10222 
<a name="l10223"></a>10223         <span class="comment">// (Send it)</span>
<a name="l10224"></a>10224         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l10225"></a>10225         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);   
<a name="l10226"></a>10226 
<a name="l10227"></a>10227         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l10228"></a>10228     } <span class="comment">// thePlan.LoadContractFromString()</span>
<a name="l10229"></a>10229     <span class="keywordflow">else</span>
<a name="l10230"></a>10230     {
<a name="l10231"></a>10231         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;Unable to load payment plan from string, or verify it. Sorry.\n&quot;</span>);
<a name="l10232"></a>10232     }
<a name="l10233"></a>10233 
<a name="l10234"></a>10234     <span class="keywordflow">return</span> (-1);
<a name="l10235"></a>10235 }
<a name="l10236"></a>10236 
<a name="l10237"></a>10237 
<a name="l10238"></a>10238 
<a name="l10239"></a>10239 <span class="comment">// If a smart contract is already running on a specific server, and the Nym in question (USER_ID)</span>
<a name="l10240"></a>10240 <span class="comment">// is an authorized agent for that smart contract, then he can trigger clauses. All he needs is</span>
<a name="l10241"></a>10241 <span class="comment">// the transaction ID for the smart contract, and the name of the clause.</span>
<a name="l10242"></a>10242 <span class="comment">//</span>
<a name="l10243"></a><a class="code" href="class_o_t___a_p_i.html#a0bf5890924481ffbf89bc2a6fb529b04">10243</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a0bf5890924481ffbf89bc2a6fb529b04">OT_API::triggerClause</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l10244"></a>10244                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID,
<a name="l10245"></a>10245                            <span class="keyword">const</span> int64_t            &amp; lTransactionNum,
<a name="l10246"></a>10246                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       &amp; strClauseName,
<a name="l10247"></a>10247                            <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>       * pStrParam<span class="comment">/*=NULL*/</span>)
<a name="l10248"></a>10248 {
<a name="l10249"></a>10249     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::triggerClause&quot;</span>;
<a name="l10250"></a>10250     <span class="comment">// -----------------------------------------------------</span>
<a name="l10251"></a>10251     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10252"></a>10252     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l10253"></a>10253     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l10254"></a>10254     <span class="comment">//  (No need to cleanup.)</span>
<a name="l10255"></a>10255     <span class="comment">// -----------------------------------------------------</span>
<a name="l10256"></a>10256     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10257"></a>10257     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l10258"></a>10258     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l10259"></a>10259     <span class="comment">// -----------------------------------------------------</span>
<a name="l10260"></a>10260     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l10261"></a>10261     int64_t lRequestNumber = 0;
<a name="l10262"></a>10262 
<a name="l10263"></a>10263     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l10264"></a>10264 
<a name="l10265"></a>10265     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10266"></a>10266     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l10267"></a>10267     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10268"></a>10268     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10269"></a>10269 
<a name="l10270"></a>10270     <span class="comment">// (1) set up member variables</span>
<a name="l10271"></a>10271     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;triggerClause&quot;</span>;
<a name="l10272"></a>10272     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10273"></a>10273     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10274"></a>10274     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10275"></a>10275 
<a name="l10276"></a>10276     theMessage.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>    = lTransactionNum;
<a name="l10277"></a>10277     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strClauseName;
<a name="l10278"></a>10278 
<a name="l10279"></a>10279     <span class="comment">// Optional string parameter. Available as &quot;param_string&quot;</span>
<a name="l10280"></a>10280     <span class="comment">// inside the script.</span>
<a name="l10281"></a>10281     <span class="comment">//</span>
<a name="l10282"></a>10282     <span class="keywordflow">if</span> ((NULL != pStrParam) &amp;&amp; (pStrParam-&gt;<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()))
<a name="l10283"></a>10283         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(*pStrParam); <span class="comment">// &lt;===</span>
<a name="l10284"></a>10284 
<a name="l10285"></a>10285     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10286"></a>10286     <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l10287"></a>10287     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l10288"></a>10288     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10289"></a>10289 
<a name="l10290"></a>10290     <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l10291"></a>10291         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10292"></a>10292                       str_server.c_str());
<a name="l10293"></a>10293 
<a name="l10294"></a>10294     <span class="comment">// (2) Sign the Message</span>
<a name="l10295"></a>10295     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l10296"></a>10296 
<a name="l10297"></a>10297     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10298"></a>10298     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10299"></a>10299 
<a name="l10300"></a>10300     <span class="comment">// (Send it)</span>
<a name="l10301"></a>10301     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l10302"></a>10302     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l10303"></a>10303 
<a name="l10304"></a>10304     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l10305"></a>10305 }
<a name="l10306"></a>10306 
<a name="l10307"></a>10307 
<a name="l10308"></a>10308 
<a name="l10309"></a><a class="code" href="class_o_t___a_p_i.html#ab1022d7f5baf3dadf907e1cf1f5adc08">10309</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ab1022d7f5baf3dadf907e1cf1f5adc08">OT_API::activateSmartContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l10310"></a>10310                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l10311"></a>10311                                   <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>     &amp; THE_SMART_CONTRACT)
<a name="l10312"></a>10312 {
<a name="l10313"></a>10313     <span class="keywordtype">bool</span> bCancelling = <span class="keyword">false</span>;
<a name="l10314"></a>10314     <span class="comment">// -----------------------------------------------------</span>
<a name="l10315"></a>10315     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10316"></a>10316     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l10317"></a>10317     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l10318"></a>10318     <span class="comment">//  (No need to cleanup.)</span>
<a name="l10319"></a>10319     <span class="comment">// -----------------------------------------------------</span>
<a name="l10320"></a>10320     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10321"></a>10321     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l10322"></a>10322     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l10323"></a>10323     <span class="comment">// -----------------------------------------------------</span>
<a name="l10324"></a>10324     <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a> theContract(SERVER_ID);
<a name="l10325"></a>10325     <a class="code" href="class_o_t_message.html">OTMessage</a>       theMessage;
<a name="l10326"></a>10326     int64_t            lRequestNumber = 0;
<a name="l10327"></a>10327     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l10328"></a>10328 
<a name="l10329"></a>10329     <span class="keywordflow">if</span> (theContract.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(THE_SMART_CONTRACT))
<a name="l10330"></a>10330     {
<a name="l10331"></a>10331         <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent = NULL;
<a name="l10332"></a>10332         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = theContract.<a class="code" href="class_o_t_scriptable.html#a08ff87b0f54ed3139bfcfb362a757778">FindPartyBasedOnNymAsAuthAgent</a>(*pNym, &amp;pAgent);
<a name="l10333"></a>10333         <span class="keywordflow">if</span> (NULL == pParty)
<a name="l10334"></a>10334         {
<a name="l10335"></a>10335             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: USER_ID *IS* a valid Nym, but that Nym is not the authorizing agent for any &quot;</span>
<a name="l10336"></a>10336                            <span class="stringliteral">&quot;of the parties on this contract. Try calling ConfirmParty() first.\n&quot;</span>, __FUNCTION__);
<a name="l10337"></a>10337             <span class="keywordflow">return</span> (-1);
<a name="l10338"></a>10338         }
<a name="l10339"></a>10339         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAgent);
<a name="l10340"></a>10340         <span class="comment">//</span>
<a name="l10341"></a>10341         <span class="comment">// BELOW THIS POINT, pAgent and pParty are both valid, and no need to clean them up.</span>
<a name="l10342"></a>10342         <span class="comment">// ----------------------------------</span>
<a name="l10343"></a>10343         <span class="comment">// Note: Usually, payment plan or market offer will load up the Nym and accounts,</span>
<a name="l10344"></a>10344         <span class="comment">// and verify ownership, etc.</span>
<a name="l10345"></a>10345         <span class="comment">// But in this case, the Nym who actually activates the smart contract is merely</span>
<a name="l10346"></a>10346         <span class="comment">// the authorizing agent for a single party, where there may be a dozen parties listed</span>
<a name="l10347"></a>10347         <span class="comment">// on the actual contract.</span>
<a name="l10348"></a>10348         <span class="comment">//</span>
<a name="l10349"></a>10349         <span class="comment">// It would be unreasonable to expect a party to have EVERY nym and EVERY account</span>
<a name="l10350"></a>10350         <span class="comment">// to the entire contract. As long as the Nym is legitimately the authorizing agent</span>
<a name="l10351"></a>10351         <span class="comment">// for one of the parties, then we allow him to send the activation message to the server.</span>
<a name="l10352"></a>10352         <span class="comment">//</span>
<a name="l10353"></a>10353         <span class="comment">// (Let the server sort out the trouble of loading all the nyms, loading all the accounts,</span>
<a name="l10354"></a>10354         <span class="comment">// verifying all the asset type IDs, verifying all the agent names, making sure there</span>
<a name="l10355"></a>10355         <span class="comment">// are no stashes already created, ETC ETC.)</span>
<a name="l10356"></a>10356         <span class="comment">//</span>
<a name="l10357"></a>10357         <span class="comment">// ONE THING I should verify, is that all of the parties are confirmed. I mean, it&#39;s not</span>
<a name="l10358"></a>10358         <span class="comment">// even worth the bother to send the damn thing until then, right? And the Server ID.</span>
<a name="l10359"></a>10359         <span class="comment">//</span>
<a name="l10360"></a>10360 
<a name="l10361"></a>10361         <span class="comment">// -----------------------------------------------------------</span>
<a name="l10362"></a>10362         <span class="keywordflow">if</span> (<span class="keyword">false</span> == theContract.<a class="code" href="class_o_t_scriptable.html#a559702a7d59f37881a892129b911d330">AllPartiesHaveSupposedlyConfirmed</a>()) <span class="comment">// all parties are NOT confirmed.</span>
<a name="l10363"></a>10363         {
<a name="l10364"></a>10364 <span class="comment">//          OTLog::vOutput(0, &quot;%s: Failed. EACH PARTY to this smart contract needs to CONFIRM IT FIRST, before one of them &quot;</span>
<a name="l10365"></a>10365 <span class="comment">//                           &quot;then activates it at the server. (But THIS smart contract has NOT yet been confirmed, at least, &quot;</span>
<a name="l10366"></a>10366 <span class="comment">//                           &quot;not by all of its parties.)\n&quot;, __FUNCTION__);</span>
<a name="l10367"></a>10367 <span class="comment">//          return -1;</span>
<a name="l10368"></a>10368 
<a name="l10369"></a>10369             <span class="comment">// UPDATE: This is now how we will trigger the &quot;cancel smart contract&quot; functionality, which can</span>
<a name="l10370"></a>10370             <span class="comment">// only be performed BEFORE the contract has been activated.</span>
<a name="l10371"></a>10371 
<a name="l10372"></a>10372             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Not all parties to smart contract are confirmed. Treating this as a request for cancelation...\n&quot;</span>);
<a name="l10373"></a>10373 
<a name="l10374"></a>10374             bCancelling = <span class="keyword">true</span>;
<a name="l10375"></a>10375             <span class="comment">// ----------------------------</span>
<a name="l10376"></a>10376             <span class="keywordflow">if</span> (theContract.<a class="code" href="class_o_t_cron_item.html#a78f165173c66d8de46fc0a1aebeee629">IsCanceled</a>())
<a name="l10377"></a>10377             {
<a name="l10378"></a>10378                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: attempted to cancel (pre-emptively, before activation) a smart contract &quot;</span>
<a name="l10379"></a>10379                               <span class="stringliteral">&quot;that was already set as canceled.\n&quot;</span>, __FUNCTION__);
<a name="l10380"></a>10380                 <span class="keywordflow">return</span> (-1);
<a name="l10381"></a>10381             }
<a name="l10382"></a>10382             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!theContract.<a class="code" href="class_o_t_cron_item.html#ad5f37660feb3396c382a5ec5987981c7">CancelBeforeActivation</a>(*pNym)) <span class="comment">// sets as canceler, releases signatures, signs, saves.</span>
<a name="l10383"></a>10383             {
<a name="l10384"></a>10384                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: attempted to cancel (pre-emptively, before activation) a smart contract, &quot;</span>
<a name="l10385"></a>10385                               <span class="stringliteral">&quot;but the attempt somehow failed.\n&quot;</span>, __FUNCTION__);
<a name="l10386"></a>10386                 <span class="keywordflow">return</span> (-1);
<a name="l10387"></a>10387             }
<a name="l10388"></a>10388         }
<a name="l10389"></a>10389         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10390"></a>10390         <span class="keywordflow">if</span> (SERVER_ID != theContract.<a class="code" href="class_o_t_instrument.html#a878dd8998f7b131b85c082575e255375">GetServerID</a>())
<a name="l10391"></a>10391         {
<a name="l10392"></a>10392             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. The server ID passed in doesn&#39;t match the one on the contract itself.\n&quot;</span>, __FUNCTION__);
<a name="l10393"></a>10393             <span class="keywordflow">return</span> -1;
<a name="l10394"></a>10394         }
<a name="l10395"></a>10395         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10396"></a>10396         <span class="keywordflow">if</span> (!(pParty-&gt;<a class="code" href="class_o_t_party.html#a0b130989d275386c980ed34d587e5e87">GetAccountCount</a>() &gt; 0))
<a name="l10397"></a>10397         {
<a name="l10398"></a>10398             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. The activating Nym must not only be the authorizing agent for one of the parties, &quot;</span>
<a name="l10399"></a>10399                             <span class="stringliteral">&quot;but must also be the authorized agent for one of that party&#39;s asset accounts. That party must have &quot;</span>
<a name="l10400"></a>10400                            <span class="stringliteral">&quot;at least one asset account &quot;</span>
<a name="l10401"></a>10401                             <span class="stringliteral">&quot;for this reason. (See code comment below this message, in the code.)\n&quot;</span>, __FUNCTION__);
<a name="l10402"></a>10402             <span class="keywordflow">return</span> -1;
<a name="l10403"></a>10403         }
<a name="l10404"></a>10404         <span class="comment">// *************************************************************************************</span>
<a name="l10405"></a>10405         <span class="comment">//</span>
<a name="l10406"></a>10406         <span class="comment">// REQUIREMENT:  The ACTIVATOR aka the Originator Nym (the party who activates the smart</span>
<a name="l10407"></a>10407         <span class="comment">// contract on the server) must have at least one asset account as part of the smart contract,</span>
<a name="l10408"></a>10408         <span class="comment">// for which the authorizing agent for that party is also the authorized agent for that account.</span>
<a name="l10409"></a>10409         <span class="comment">// This is in order to make sure that the smart contracts will work with the existing infrastructure,</span>
<a name="l10410"></a>10410         <span class="comment">// so that functions like &quot;GetOpeningNumber()&quot; and &quot;GetClosingNumber()&quot; will continue to work the way</span>
<a name="l10411"></a>10411         <span class="comment">// they are expected to, and so that there is always at least ONE closing transaction number supplied</span>
<a name="l10412"></a>10412         <span class="comment">// for the smart contract (at least ONE finalReceipt will actually have to be signed for once it is</span>
<a name="l10413"></a>10413         <span class="comment">// deactivated) and so we can know who the owner of that account, and what acct # it will be.</span>
<a name="l10414"></a>10414         <span class="comment">//</span>
<a name="l10415"></a>10415         <span class="comment">// This is also a requirement because the existing infrastructure uses the transaction system for</span>
<a name="l10416"></a>10416         <span class="comment">// activating cron items. It was simply not anticipated in the past that cron items, based on valid</span>
<a name="l10417"></a>10417         <span class="comment">// transactions, wouldn&#39;t also therefore be associated with at least one asset account. In fact,</span>
<a name="l10418"></a>10418         <span class="comment">// the original difference between transactions (vs normal messages) was that transactions dealt</span>
<a name="l10419"></a>10419         <span class="comment">// with asset accounts, whereas normal messages did not. (Such as, &quot;checkUser&quot; or &quot;getRequest&quot;.)</span>
<a name="l10420"></a>10420         <span class="comment">//</span>
<a name="l10421"></a>10421         <span class="comment">// A big piece of this is the BALANCE AGREEMENT. Obviously it wasn&#39;t anticipated that &quot;balance</span>
<a name="l10422"></a>10422         <span class="comment">// agreements&quot; would ever be needed for transactions, yet asset accounts wouldn&#39;t be. So the below</span>
<a name="l10423"></a>10423         <span class="comment">// TRANSACTION STATEMENT, for example, expects an asset account, as does the verification code</span>
<a name="l10424"></a>10424         <span class="comment">// associated with it. Even transaction statements were originally made for situations where the balance</span>
<a name="l10425"></a>10425         <span class="comment">// wasn&#39;t actually changing, (and so a balance agreement wasn&#39;t needed), but where a signature on</span>
<a name="l10426"></a>10426         <span class="comment">// the transaction numbers was still necessary, since one had to be burned in order to prove that</span>
<a name="l10427"></a>10427         <span class="comment">// the instrument was valid.</span>
<a name="l10428"></a>10428         <span class="comment">//</span>
<a name="l10429"></a>10429         <span class="comment">// Unfortunately, transaction statements still expected an asset account to at least EXIST, since</span>
<a name="l10430"></a>10430         <span class="comment">// they involved market offers (which do not immediately change the balance) or payment plans</span>
<a name="l10431"></a>10431         <span class="comment">// (which also do not immediately change the balance.) Yet the account&#39;s ID was still at least</span>
<a name="l10432"></a>10432         <span class="comment">// present in the receipt, and a transaction # was still used.</span>
<a name="l10433"></a>10433         <span class="comment">//</span>
<a name="l10434"></a>10434         <span class="comment">// In the case of smart contracts, I will probably someday lift this restriction (that the activating</span>
<a name="l10435"></a>10435         <span class="comment">// nym must also be the authorized agent on one of the asset accounts on the smart contract). But I</span>
<a name="l10436"></a>10436         <span class="comment">// will have to go over all the plumbing first and deal with that. In the meantime:</span>
<a name="l10437"></a>10437         <span class="comment">//</span>
<a name="l10438"></a>10438         <span class="comment">// --- THE ACTIVATING NYM *MUST* ALSO BE THE AUTHORIZED AGENT</span>
<a name="l10439"></a>10439         <span class="comment">//     FOR AT LEAST ONE ASSET ACCOUNT, FOR THAT PARTY. ---</span>
<a name="l10440"></a>10440         <span class="comment">//</span>
<a name="l10441"></a>10441         <span class="comment">// *************************************************************************************</span>
<a name="l10442"></a>10442 
<a name="l10443"></a>10443         <span class="keyword">const</span> std::string str_agent_name(pAgent-&gt;<a class="code" href="class_o_t_agent.html#a123d27f05e46977ecdbe0b83de3c119d">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10444"></a>10444         <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pAcct = pParty-&gt;<a class="code" href="class_o_t_party.html#a6cdea442a9b09e5b8f3fdfedba4ae767">GetAccountByAgent</a>(str_agent_name);
<a name="l10445"></a>10445 
<a name="l10446"></a>10446         <span class="keywordflow">if</span> (NULL == pAcct)
<a name="l10447"></a>10447         {
<a name="l10448"></a>10448             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. The activating Nym must not only be the authorizing agent for one of the parties, &quot;</span>
<a name="l10449"></a>10449                            <span class="stringliteral">&quot;but must also be the authorized agent for one of that party&#39;s asset accounts. That party must have &quot;</span>
<a name="l10450"></a>10450                            <span class="stringliteral">&quot;at least one asset account &quot;</span>
<a name="l10451"></a>10451                            <span class="stringliteral">&quot;for this reason. (See code comment above this message, in the code.)\n&quot;</span>,__FUNCTION__);
<a name="l10452"></a>10452             <span class="keywordflow">return</span> -1;
<a name="l10453"></a>10453         }
<a name="l10454"></a>10454         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10455"></a>10455         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strAcctID = pAcct-&gt;GetAcctID();
<a name="l10456"></a>10456 
<a name="l10457"></a>10457         <span class="keywordflow">if</span> (!strAcctID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l10458"></a>10458         {
<a name="l10459"></a>10459             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. The Account ID is blank for asset acct (%s) for party (%s). Did you confirm &quot;</span>
<a name="l10460"></a>10460                            <span class="stringliteral">&quot;this account, before trying to activate this contract?\n&quot;</span>, __FUNCTION__,
<a name="l10461"></a>10461                            pAcct-&gt;GetName().Get(), pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l10462"></a>10462             <span class="keywordflow">return</span> -1;
<a name="l10463"></a>10463         }
<a name="l10464"></a>10464         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> theAcctID(strAcctID);
<a name="l10465"></a>10465         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10466"></a>10466         <span class="keyword">const</span> int64_t   lOpeningTransNo = pParty-&gt;<a class="code" href="class_o_t_party.html#aa11f990dfe9743dd1d8e34af8bfd693a">GetOpeningTransNo</a>();
<a name="l10467"></a>10467         <span class="keyword">const</span> int64_t   lClosingTransNo = pAcct-&gt; GetClosingTransNo();
<a name="l10468"></a>10468 
<a name="l10469"></a>10469         <span class="keywordflow">if</span> ((lOpeningTransNo &lt;= 0) || (lClosingTransNo &lt;= 0))
<a name="l10470"></a>10470         {
<a name="l10471"></a>10471             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. Opening Transaction # (%ld) or Closing # (%ld) were invalid &quot;</span>
<a name="l10472"></a>10472                            <span class="stringliteral">&quot;for asset acct (%s) for party (%s). Did you confirm this account and party, &quot;</span>
<a name="l10473"></a>10473                            <span class="stringliteral">&quot;before trying to activate this contract?\n&quot;</span>,
<a name="l10474"></a>10474                            __FUNCTION__, lOpeningTransNo, lClosingTransNo, pAcct-&gt;GetName().Get(),
<a name="l10475"></a>10475                            pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l10476"></a>10476             <span class="keywordflow">return</span> -1;
<a name="l10477"></a>10477         }
<a name="l10478"></a>10478         <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lOpeningTransNo))
<a name="l10479"></a>10479         {
<a name="l10480"></a>10480             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. Opening Transaction # (%ld) wasn&#39;t valid/issued to this Nym, &quot;</span>
<a name="l10481"></a>10481                            <span class="stringliteral">&quot;for asset acct (%s) for party (%s) on server (%s). Did you confirm this account and party, &quot;</span>
<a name="l10482"></a>10482                            <span class="stringliteral">&quot;before trying to activate this contract?\n&quot;</span>,
<a name="l10483"></a>10483                            __FUNCTION__, lOpeningTransNo, pAcct-&gt;GetName().Get(), pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str(),
<a name="l10484"></a>10484                            strServerID.Get());
<a name="l10485"></a>10485             <span class="keywordflow">return</span> -1;
<a name="l10486"></a>10486         }
<a name="l10487"></a>10487         <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a66cf3b97f1769f9d422bad8787a6c1a0">VerifyIssuedNum</a>(strServerID, lClosingTransNo))
<a name="l10488"></a>10488         {
<a name="l10489"></a>10489             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed. Closing Transaction # (%ld) wasn&#39;t issued to this Nym, &quot;</span>
<a name="l10490"></a>10490                            <span class="stringliteral">&quot;for asset acct (%s) for party (%s). Did you confirm this account and party, &quot;</span>
<a name="l10491"></a>10491                            <span class="stringliteral">&quot;before trying to activate this contract?\n&quot;</span>,
<a name="l10492"></a>10492                            __FUNCTION__, lClosingTransNo, pAcct-&gt;GetName().Get(), pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l10493"></a>10493             <span class="keywordflow">return</span> -1;
<a name="l10494"></a>10494         }
<a name="l10495"></a>10495         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10496"></a>10496         <span class="comment">// These numbers (the opening and closing transaction #s) were already available on</span>
<a name="l10497"></a>10497         <span class="comment">// the smart contract -- specifically an opening number is stored for each party,</span>
<a name="l10498"></a>10498         <span class="comment">// taken from the authorizing agent for that party, and a closing number is stored for</span>
<a name="l10499"></a>10499         <span class="comment">// each asset account, taken from the authorized agent for that asset account.</span>
<a name="l10500"></a>10500         <span class="comment">//</span>
<a name="l10501"></a>10501         <span class="comment">// Now we set the appropriate opening/closing number onto the smart contract, in the way</span>
<a name="l10502"></a>10502         <span class="comment">// of the existing CronItem system, so that it will work properly within that infrastructure.</span>
<a name="l10503"></a>10503         <span class="comment">// (This is what makes the activating Nym slightly different / more than the other authorizing</span>
<a name="l10504"></a>10504         <span class="comment">// agent nyms for each party to the contract. Not only does it have opening/closing numbers</span>
<a name="l10505"></a>10505         <span class="comment">// on its party like all the others, but its numbers are also those used for the cron item itself.)</span>
<a name="l10506"></a>10506         <span class="comment">//</span>
<a name="l10507"></a>10507         theContract.<a class="code" href="class_o_t_smart_contract.html#afd41dba13f15554183828bd79f0cbb3f">PrepareToActivate</a>(lOpeningTransNo, lClosingTransNo, USER_ID, theAcctID);
<a name="l10508"></a>10508         <span class="comment">// This call changes the contract slightly, so it must be re-signed (in order to save changes.)</span>
<a name="l10509"></a>10509         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10510"></a>10510         theContract.<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l10511"></a>10511 
<a name="l10512"></a>10512         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAgent-&gt;<a class="code" href="class_o_t_agent.html#a0749f394cfbabd6a64942bbf53af0e7b">SignContract</a>(theContract)) <span class="comment">// RE-SIGN HERE.</span>
<a name="l10513"></a>10513         {
<a name="l10514"></a>10514             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed re-signing contract, after calling PrepareToActivate().\n&quot;</span>, __FUNCTION__);
<a name="l10515"></a>10515             <span class="keywordflow">return</span> -1;
<a name="l10516"></a>10516         }
<a name="l10517"></a>10517 
<a name="l10518"></a>10518         theContract.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10519"></a>10519         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strContract(theContract); <span class="comment">// Grab a string version of the latest signed contract.</span>
<a name="l10520"></a>10520         <span class="comment">// ----------------------------------------------------------</span>
<a name="l10521"></a>10521         <span class="comment">// Create a transaction</span>
<a name="l10522"></a>10522         <span class="comment">//</span>
<a name="l10523"></a>10523         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID,
<a name="l10524"></a>10524                                                                            theAcctID,
<a name="l10525"></a>10525                                                                            SERVER_ID,
<a name="l10526"></a>10526                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a42b743fb9d9a40ac2a77499f9d87bde0">OTTransaction::smartContract</a>,
<a name="l10527"></a>10527                                                                            theContract.<a class="code" href="class_o_t_trackable.html#a2594d320e3b24f3210bd38a08de66a70">GetTransactionNum</a>());
<a name="l10528"></a>10528 
<a name="l10529"></a>10529         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l10530"></a>10530         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1adb560811f0265d344fac45c9333bc25d">OTItem::smartContract</a>);
<a name="l10531"></a>10531 
<a name="l10532"></a>10532         <span class="comment">// Add the smart contract string as the attachment on the transaction item.</span>
<a name="l10533"></a>10533         pItem-&gt;SetAttachment(strContract);
<a name="l10534"></a>10534 
<a name="l10535"></a>10535         <span class="comment">// sign the item</span>
<a name="l10536"></a>10536         pItem-&gt;SignContract(*pNym);
<a name="l10537"></a>10537         pItem-&gt;SaveContract();
<a name="l10538"></a>10538 
<a name="l10539"></a>10539         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l10540"></a>10540         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l10541"></a>10541         <span class="comment">// ---------------------------------------------</span>
<a name="l10542"></a>10542         <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l10543"></a>10543 
<a name="l10544"></a>10544         <span class="comment">// pStatementItem is signed and saved within this call. No need to do that again.</span>
<a name="l10545"></a>10545         <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l10546"></a>10546 
<a name="l10547"></a>10547         <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// Will never be NULL. Will assert above before it gets here.</span>
<a name="l10548"></a>10548             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l10549"></a>10549         <span class="comment">// ---------------------------------------------</span>
<a name="l10550"></a>10550         <span class="comment">// sign the transaction</span>
<a name="l10551"></a>10551         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10552"></a>10552         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10553"></a>10553         <span class="comment">// ---------------------------------------------</span>
<a name="l10554"></a>10554         <span class="comment">// set up the ledger</span>
<a name="l10555"></a>10555         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, theAcctID, SERVER_ID);
<a name="l10556"></a>10556 
<a name="l10557"></a>10557         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(theAcctID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l10558"></a>10558         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l10559"></a>10559         <span class="comment">// ---------------------------------------------</span>
<a name="l10560"></a>10560         <span class="comment">// sign the ledger</span>
<a name="l10561"></a>10561         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10562"></a>10562         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10563"></a>10563         <span class="comment">// ---------------------------------------------</span>
<a name="l10564"></a>10564         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l10565"></a>10565         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l10566"></a>10566         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l10567"></a>10567         <span class="comment">// ---------------------------------------------</span>
<a name="l10568"></a>10568         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10569"></a>10569         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l10570"></a>10570         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10571"></a>10571         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10572"></a>10572         <span class="comment">// ---------------------------------------------</span>
<a name="l10573"></a>10573         <span class="comment">// (1) Set up member variables</span>
<a name="l10574"></a>10574         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l10575"></a>10575         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10576"></a>10576         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10577"></a>10577         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10578"></a>10578         <span class="comment">// ---------------------------------------------</span>
<a name="l10579"></a>10579         theAcctID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>);
<a name="l10580"></a>10580         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l10581"></a>10581         <span class="comment">// ---------------------------------------------</span>
<a name="l10582"></a>10582         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10583"></a>10583         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l10584"></a>10584         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l10585"></a>10585         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10586"></a>10586         <span class="comment">// ---------------------------------------------</span>
<a name="l10587"></a>10587         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l10588"></a>10588             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10589"></a>10589                           __FUNCTION__, str_server.c_str());
<a name="l10590"></a>10590         <span class="comment">// ---------------------------------------------</span>
<a name="l10591"></a>10591         <span class="comment">// (2) Sign the Message</span>
<a name="l10592"></a>10592         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l10593"></a>10593 
<a name="l10594"></a>10594         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10595"></a>10595         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10596"></a>10596 
<a name="l10597"></a>10597         <span class="comment">// (Send it)</span>
<a name="l10598"></a>10598         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l10599"></a>10599         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l10600"></a>10600         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l10601"></a>10601 
<a name="l10602"></a>10602     } <span class="comment">// theContract.LoadContractFromString()</span>
<a name="l10603"></a>10603     <span class="keywordflow">else</span>
<a name="l10604"></a>10604         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to load smart contract from string:\n\n%s\n\n&quot;</span>,
<a name="l10605"></a>10605                        __FUNCTION__, THE_SMART_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l10606"></a>10606 
<a name="l10607"></a>10607     <span class="keywordflow">return</span> (-1);
<a name="l10608"></a>10608 }
<a name="l10609"></a>10609 
<a name="l10610"></a>10610 
<a name="l10611"></a>10611 <span class="comment">// Done: make a new transaction (and item) type for smart contract. (for a cron item.)</span>
<a name="l10612"></a>10612 
<a name="l10613"></a>10613 
<a name="l10614"></a>10614 <span class="comment">// Done: Add an API call that allows the coder to harvest transaction numbers from Cron Items.</span>
<a name="l10615"></a>10615 <span class="comment">// This will be used on the client side, I believe, and not server side (not in smart contracts.)</span>
<a name="l10616"></a>10616 <span class="comment">//</span>
<a name="l10617"></a>10617 
<a name="l10618"></a>10618 
<a name="l10619"></a>10619 <span class="comment">// Done: Make a copy of CancelCronItem(), and use it to make an EXECUTE CLAUSE message</span>
<a name="l10620"></a>10620 <span class="comment">// for Nyms to trigger existing smart contracts!!!!!!!!!</span>
<a name="l10621"></a>10621 <span class="comment">// WAIT: Except it DOESN&#39;T have to be a transaction! Because as long as the Nym is a valid</span>
<a name="l10622"></a>10622 <span class="comment">// party, and the action occurs, it will ALREADY drop receipts into the appropriate boxes!</span>
<a name="l10623"></a>10623 <span class="comment">// But wait... How do we know that the Nym REALLY triggered that clause, if there&#39;s not</span>
<a name="l10624"></a>10624 <span class="comment">// a transaction # burned? It doesn&#39;t matter: the purpose of transaction #s is to make sure</span>
<a name="l10625"></a>10625 <span class="comment">// that CHANGES in BALANCE are signed off on, by leaving the # open, and putting a receipt</span>
<a name="l10626"></a>10626 <span class="comment">// in the inbox. But if Nym really is a party to this smart contract (which will be verified</span>
<a name="l10627"></a>10627 <span class="comment">// in any case), then he DOES have transaction #s open already, and if any balances change,</span>
<a name="l10628"></a>10628 <span class="comment">// receipts will be dropped into the appropriate inboxes already containing those transaction</span>
<a name="l10629"></a>10629 <span class="comment">// #s. (As well as containing his original signed copy of the cron item, AND as well as</span>
<a name="l10630"></a>10630 <span class="comment">// containing the latest message, with his signature and request number on it, which triggered</span>
<a name="l10631"></a>10631 <span class="comment">// the clause to be called.)  Furthermore, if the clause is triggered multiple times, then</span>
<a name="l10632"></a>10632 <span class="comment">// there must be multiple receipts, and each one should feature a NEW instance of the triggering,</span>
<a name="l10633"></a>10633 <span class="comment">// WITH a valid signature on it, and WITH a NEW REQUEST NUMBER ON IT. Without this, none of</span>
<a name="l10634"></a>10634 <span class="comment">// the balances could change anyway.</span>
<a name="l10635"></a>10635 <span class="comment">// Therefore I conclude that the &quot;trigger a clause&quot; message does NOT have to be a transaction,</span>
<a name="l10636"></a>10636 <span class="comment">// but only needs to be a message  :-)</span>
<a name="l10637"></a>10637 <span class="comment">//</span>
<a name="l10638"></a>10638 <span class="comment">// Done: the &quot;trigger clause&quot; message!</span>
<a name="l10639"></a>10639 
<a name="l10640"></a>10640 
<a name="l10641"></a>10641 
<a name="l10642"></a>10642 <span class="comment">// DONE: Change this into a TRANSACTION!</span>
<a name="l10643"></a>10643 <span class="comment">// (So there can be a transaction statement, since canceling a cron</span>
<a name="l10644"></a>10644 <span class="comment">// item removes a transaction number from your issued list.)</span>
<a name="l10649"></a><a class="code" href="class_o_t___a_p_i.html#ade192b1b17ef3814b79e76afe7badb8a">10649</a> <span class="comment"></span>int32_t <a class="code" href="class_o_t___a_p_i.html#ade192b1b17ef3814b79e76afe7badb8a">OT_API::cancelCronItem</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l10650"></a>10650                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l10651"></a>10651                             <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ACCT_ID,
<a name="l10652"></a>10652                             <span class="keyword">const</span> int64_t &amp; lTransactionNum) <span class="comment">// so the server can lookup the offer in Cron.</span>
<a name="l10653"></a>10653 {
<a name="l10654"></a>10654     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::cancelCronItem&quot;</span>;
<a name="l10655"></a>10655     <span class="comment">// -----------------------------------------------------</span>
<a name="l10656"></a>10656     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10657"></a>10657     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l10658"></a>10658     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l10659"></a>10659     <span class="comment">//  (No need to cleanup.)</span>
<a name="l10660"></a>10660     <span class="comment">// -----------------------------------------------------</span>
<a name="l10661"></a>10661     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10662"></a>10662     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l10663"></a>10663     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l10664"></a>10664     <span class="comment">// -----------------------------------------------------</span>
<a name="l10665"></a>10665     <a class="code" href="class_o_t_message.html">OTMessage</a>   theMessage;
<a name="l10666"></a>10666 
<a name="l10667"></a>10667     int64_t lRequestNumber = 0;
<a name="l10668"></a>10668 
<a name="l10669"></a>10669     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l10670"></a>10670 
<a name="l10671"></a>10671     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(strServerID) &lt; 1)
<a name="l10672"></a>10672     {
<a name="l10673"></a>10673         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::cancelCronItem: At least 1 Transaction Number is necessary to cancel any cron item. &quot;</span>
<a name="l10674"></a>10674                       <span class="stringliteral">&quot;Try requesting the server for more numbers (you are low.)\n&quot;</span>);
<a name="l10675"></a>10675         <span class="keywordflow">return</span> (-1);
<a name="l10676"></a>10676     }
<a name="l10677"></a>10677     <span class="comment">// ------------------------------------</span>
<a name="l10678"></a>10678     int64_t lStoredTransactionNumber=0;
<a name="l10679"></a>10679     <span class="keywordtype">bool</span> bGotTransNum   = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=false</span>
<a name="l10680"></a>10680 
<a name="l10681"></a>10681     <span class="keywordflow">if</span> (!bGotTransNum)
<a name="l10682"></a>10682         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::cancelCronItem: Supposedly there was a transaction number available, but the call\n&quot;</span>
<a name="l10683"></a>10683                      <span class="stringliteral">&quot;still failed.\n&quot;</span>);
<a name="l10684"></a>10684     <span class="keywordflow">else</span>
<a name="l10685"></a>10685     {
<a name="l10686"></a>10686         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10687"></a>10687         <a class="code" href="class_o_t_string.html">OTString</a> str_ASSET_ACCT_ID(ASSET_ACCT_ID);
<a name="l10688"></a>10688 
<a name="l10689"></a>10689         <span class="comment">// Create a transaction</span>
<a name="l10690"></a>10690         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ASSET_ACCT_ID, SERVER_ID,
<a name="l10691"></a>10691                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8a30587bf83cb273ffd6a72008d2545ca5">OTTransaction::cancelCronItem</a>, lStoredTransactionNumber);
<a name="l10692"></a>10692         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l10693"></a>10693         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a5db1c9a56286c66937eb57d460f2eb01">OTItem::cancelCronItem</a>);
<a name="l10694"></a>10694         <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;Error allocating memory in the OT API&quot;</span>);
<a name="l10695"></a>10695 
<a name="l10696"></a>10696         pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lTransactionNum);          <span class="comment">// This transaction is being sent in order to cancel another transaction.</span>
<a name="l10697"></a>10697         pTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(lTransactionNum);   <span class="comment">// This is where we clearly show which one is actually being cancelled.</span>
<a name="l10698"></a>10698 
<a name="l10699"></a>10699         <span class="comment">// sign the item</span>
<a name="l10700"></a>10700         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10701"></a>10701         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10702"></a>10702 
<a name="l10703"></a>10703         <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l10704"></a>10704         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l10705"></a>10705         <span class="comment">// ---------------------------------------------</span>
<a name="l10706"></a>10706         <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l10707"></a>10707 
<a name="l10708"></a>10708         <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l10709"></a>10709         <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l10710"></a>10710 
<a name="l10711"></a>10711         <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l10712"></a>10712             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l10713"></a>10713         <span class="comment">// ---------------------------------------------</span>
<a name="l10714"></a>10714         <span class="comment">// sign the transaction</span>
<a name="l10715"></a>10715         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10716"></a>10716         pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10717"></a>10717 
<a name="l10718"></a>10718         <span class="comment">// set up the ledger</span>
<a name="l10719"></a>10719         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ASSET_ACCT_ID, SERVER_ID);
<a name="l10720"></a>10720         theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ASSET_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l10721"></a>10721         theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l10722"></a>10722 
<a name="l10723"></a>10723         <span class="comment">// sign the ledger</span>
<a name="l10724"></a>10724         theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10725"></a>10725         theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10726"></a>10726 
<a name="l10727"></a>10727         <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l10728"></a>10728         <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l10729"></a>10729         <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l10730"></a>10730 
<a name="l10731"></a>10731         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l10732"></a>10732         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l10733"></a>10733         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l10734"></a>10734         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l10735"></a>10735 
<a name="l10736"></a>10736         <span class="comment">// (1) Set up member variables</span>
<a name="l10737"></a>10737         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l10738"></a>10738         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l10739"></a>10739         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l10740"></a>10740         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l10741"></a>10741 
<a name="l10742"></a>10742         theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_ASSET_ACCT_ID;
<a name="l10743"></a>10743         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l10744"></a>10744 
<a name="l10745"></a>10745         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l10746"></a>10746         <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l10747"></a>10747         <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l10748"></a>10748         NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l10749"></a>10749 
<a name="l10750"></a>10750         <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l10751"></a>10751             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l10752"></a>10752                           str_server.c_str());
<a name="l10753"></a>10753 
<a name="l10754"></a>10754         <span class="comment">// (2) Sign the Message</span>
<a name="l10755"></a>10755         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l10756"></a>10756 
<a name="l10757"></a>10757         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l10758"></a>10758         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10759"></a>10759 
<a name="l10760"></a>10760         <span class="comment">// (Send it)</span>
<a name="l10761"></a>10761         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l10762"></a>10762         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l10763"></a>10763 
<a name="l10764"></a>10764         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l10765"></a>10765     } <span class="comment">// got transaction number.</span>
<a name="l10766"></a>10766 
<a name="l10767"></a>10767     <span class="keywordflow">return</span> (-1);
<a name="l10768"></a>10768 }
<a name="l10769"></a>10769 
<a name="l10770"></a>10770 
<a name="l10771"></a>10771 
<a name="l10772"></a>10772 
<a name="l10773"></a>10773 
<a name="l10774"></a>10774 <span class="comment">// ----------------------------------------------------------------</span>
<a name="l10775"></a>10775 <span class="comment">// ISSUE MARKET OFFER</span>
<a name="l10776"></a>10776 <span class="comment">//</span>
<a name="l10777"></a>10777 <span class="comment">//</span>
<a name="l10778"></a><a class="code" href="class_o_t___a_p_i.html#acadf476636347f6d2e748a3ac517c7c8">10778</a> int32_t <a class="code" href="class_o_t___a_p_i.html#acadf476636347f6d2e748a3ac517c7c8">OT_API::issueMarketOffer</a>( <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l10779"></a>10779                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; USER_ID,
<a name="l10780"></a>10780                               <span class="comment">// -------------------------------------------</span>
<a name="l10781"></a>10781                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ASSET_ACCT_ID,
<a name="l10782"></a>10782                               <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; CURRENCY_ACCT_ID,
<a name="l10783"></a>10783                               <span class="comment">// -------------------------------------------</span>
<a name="l10784"></a>10784                               <span class="keyword">const</span> int64_t         &amp; MARKET_SCALE, <span class="comment">// Defaults to minimum of 1. Market granularity.</span>
<a name="l10785"></a>10785                               <span class="keyword">const</span> int64_t         &amp; MINIMUM_INCREMENT, <span class="comment">// This will be multiplied by the Scale. Min 1.</span>
<a name="l10786"></a>10786                               <span class="keyword">const</span> int64_t         &amp; TOTAL_ASSETS_ON_OFFER, <span class="comment">// Total assets available for sale or purchase. Will be multiplied by minimum increment.</span>
<a name="l10787"></a>10787                               <span class="keyword">const</span> int64_t         &amp; PRICE_LIMIT,    <span class="comment">// Per Minimum Increment...</span>
<a name="l10788"></a>10788                               <span class="keyword">const</span> <span class="keywordtype">bool</span>              bBuyingOrSelling, <span class="comment">//  BUYING == false, SELLING == true.</span>
<a name="l10789"></a>10789                               <span class="comment">// -------------------------------------------</span>
<a name="l10790"></a>10790                               <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>            tLifespanInSeconds<span class="comment">/*=86400*/</span>, <span class="comment">// 86400 == 1 day.</span>
<a name="l10791"></a>10791                               <span class="comment">// -------------------------------------------</span>
<a name="l10792"></a>10792                               <span class="keyword">const</span> <span class="keywordtype">char</span>              STOP_SIGN<span class="comment">/*=0*/</span>,               <span class="comment">// For stop orders, set to &#39;&lt;&#39; or &#39;&gt;&#39;</span>
<a name="l10793"></a>10793                               <span class="keyword">const</span> int64_t              ACTIVATION_PRICE<span class="comment">/*=0*/</span>)        <span class="comment">// For stop orders, this is threshhold price.</span>
<a name="l10794"></a>10794 {
<a name="l10795"></a>10795     <span class="comment">// -----------------------------------------------------</span>
<a name="l10796"></a>10796     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10797"></a>10797     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l10798"></a>10798     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l10799"></a>10799     <span class="comment">// -----------------------------------------------------</span>
<a name="l10800"></a>10800     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l10801"></a>10801     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l10802"></a>10802     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l10803"></a>10803     <span class="comment">// -----------------------------------------------------</span>
<a name="l10804"></a>10804     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAssetAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ASSET_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l10805"></a>10805     <span class="keywordflow">if</span> (NULL == pAssetAccount) <span class="keywordflow">return</span> (-1);
<a name="l10806"></a>10806     <span class="comment">// By this point, pAssetAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l10807"></a>10807     <span class="comment">// -----------------------------------------------------</span>
<a name="l10808"></a>10808     <a class="code" href="class_o_t_account.html">OTAccount</a> * pCurrencyAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, CURRENCY_ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l10809"></a>10809     <span class="keywordflow">if</span> (NULL == pCurrencyAccount) <span class="keywordflow">return</span> (-1);
<a name="l10810"></a>10810     <span class="comment">// By this point, pCurrencyAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l10811"></a>10811     <span class="comment">// -----------------------------------------------------</span>
<a name="l10812"></a>10812     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_TYPE_ID     = pAssetAccount   -&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l10813"></a>10813     <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; CURRENCY_TYPE_ID  = pCurrencyAccount-&gt;<a class="code" href="class_o_t_account.html#a3b933b8c929e071a68ec4a29ad5797d6">GetAssetTypeID</a>();
<a name="l10814"></a>10814     <span class="comment">// ------------------------------------</span>
<a name="l10815"></a>10815     <span class="keywordflow">if</span> (ASSET_TYPE_ID == CURRENCY_TYPE_ID)
<a name="l10816"></a>10816     {
<a name="l10817"></a>10817         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The asset account and currency account cannot have the same asset type ID. (You can&#39;t, for &quot;</span>
<a name="l10818"></a>10818                        <span class="stringliteral">&quot;example, trade dollars against other dollars. Why bother trading them in the first place?)\n&quot;</span>,
<a name="l10819"></a>10819                        __FUNCTION__);
<a name="l10820"></a>10820         <span class="keywordflow">return</span> (-1);
<a name="l10821"></a>10821     }
<a name="l10822"></a>10822     <span class="comment">// -----------------------------------------------------</span>
<a name="l10823"></a>10823     <a class="code" href="class_o_t_message.html">OTMessage</a>       theMessage;
<a name="l10824"></a>10824     int64_t            lRequestNumber = 0;
<a name="l10825"></a>10825     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strServerID(SERVER_ID),
<a name="l10826"></a>10826                     strNymID   (USER_ID);
<a name="l10827"></a>10827     <span class="comment">// -----------------------------------------------------</span>
<a name="l10828"></a>10828     <span class="keywordflow">if</span> (pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#adee7eef0a51e8e94522c43ac898c2308">GetTransactionNumCount</a>(strServerID) &lt; 3)
<a name="l10829"></a>10829     {
<a name="l10830"></a>10830         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: At least 3 Transaction Numbers are necessary to issue a market offer. &quot;</span>
<a name="l10831"></a>10831                        <span class="stringliteral">&quot;Try requesting the server for more (you are low.)\n&quot;</span>, __FUNCTION__);
<a name="l10832"></a>10832         <span class="keywordflow">return</span> (-1);
<a name="l10833"></a>10833     }
<a name="l10834"></a>10834     <span class="comment">// ------------------------------------</span>
<a name="l10835"></a>10835     int64_t lStoredTransactionNumber=0, lAssetAcctClosingNo=0, lCurrencyAcctClosingNo=0;
<a name="l10836"></a>10836     <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>);   <span class="comment">// bSave=false</span>
<a name="l10837"></a>10837     <span class="keywordtype">bool</span> bGotAssetClosingNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lAssetAcctClosingNo, <span class="keyword">false</span>); <span class="comment">// bSave=false -- (true by default, FYI.)</span>
<a name="l10838"></a>10838     <span class="keywordtype">bool</span> bGotCurrencyClosingNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lCurrencyAcctClosingNo, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l10839"></a>10839     <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10840"></a>10840     <span class="keywordflow">if</span> (!bGotTransNum || !bGotAssetClosingNum || !bGotCurrencyClosingNum)
<a name="l10841"></a>10841     {
<a name="l10842"></a>10842         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Supposedly there were 3 transaction numbers available, but the call(s)\n&quot;</span>
<a name="l10843"></a>10843                       <span class="stringliteral">&quot;still failed. (Re-adding back to Nym, and failing out of this function.)\n&quot;</span>,
<a name="l10844"></a>10844                       __FUNCTION__);
<a name="l10845"></a>10845         <span class="comment">// ------------------------------------</span>
<a name="l10846"></a>10846         <span class="keywordflow">if</span> (bGotTransNum)           pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
<a name="l10847"></a>10847         <span class="keywordflow">if</span> (bGotAssetClosingNum)    pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lAssetAcctClosingNo,      <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
<a name="l10848"></a>10848         <span class="keywordflow">if</span> (bGotCurrencyClosingNum) pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lCurrencyAcctClosingNo,   <span class="keyword">false</span>); <span class="comment">// bSave=true</span>
<a name="l10849"></a>10849         <span class="comment">// ------------------------------------</span>
<a name="l10850"></a>10850         <span class="keywordflow">if</span> (bGotTransNum || bGotAssetClosingNum || bGotCurrencyClosingNum)
<a name="l10851"></a>10851             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pNym);
<a name="l10852"></a>10852     }
<a name="l10853"></a>10853     <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10854"></a>10854     <span class="keywordflow">else</span>
<a name="l10855"></a>10855     {
<a name="l10856"></a>10856         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_FROM = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a2ff83b1c64286eafdf7af6360e138d6e">GetTime</a>();      <span class="comment">// defaults to RIGHT NOW aka OT_API_GetTime() if set to 0 anyway.</span>
<a name="l10857"></a>10857         <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a> VALID_TO   = <a class="code" href="_o_t_common_8hpp.html#a38e4e4253c3dd158ea40e6312586e6c9">OTTimeAddTimeInterval</a>(VALID_FROM,          <span class="comment">// defaults to 24 hours (a &quot;Day Order&quot;) aka OT_API_GetTime() + 86,400</span>
<a name="l10858"></a>10858                                                             <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(<a class="code" href="_o_t_common_8hpp.html#af4ca9fa2c7c290d647dd18de0a9ac25f">OT_TIME_ZERO</a> == tLifespanInSeconds ? <a class="code" href="_o_t_common_8hpp.html#ae431139997436f8522341a67e64d0d32">OT_TIME_DAY_IN_SECONDS</a> : tLifespanInSeconds));
<a name="l10859"></a>10859         <span class="comment">// ------------------------------------</span>
<a name="l10860"></a>10860         int64_t lTotalAssetsOnOffer = 1,
<a name="l10861"></a>10861                 lMinimumIncrement   = 1,
<a name="l10862"></a>10862                 lPriceLimit         = 0,  <span class="comment">// your price limit, per scale of assets.</span>
<a name="l10863"></a>10863                 lMarketScale        = 1,
<a name="l10864"></a>10864                 lActivationPrice    = 0;
<a name="l10865"></a>10865         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10866"></a>10866         <span class="keywordflow">if</span> (TOTAL_ASSETS_ON_OFFER &gt; 0) lTotalAssetsOnOffer = TOTAL_ASSETS_ON_OFFER; <span class="comment">// otherwise, defaults to 1.</span>
<a name="l10867"></a>10867         <span class="keywordflow">if</span> (MARKET_SCALE          &gt; 0) lMarketScale        = MARKET_SCALE;          <span class="comment">// otherwise, defaults to 1.</span>
<a name="l10868"></a>10868         <span class="keywordflow">if</span> (MINIMUM_INCREMENT     &gt; 0) lMinimumIncrement   = MINIMUM_INCREMENT;     <span class="comment">// otherwise, defaults to 1.</span>
<a name="l10869"></a>10869         <span class="keywordflow">if</span> (PRICE_LIMIT           &gt; 0) lPriceLimit         = PRICE_LIMIT;           <span class="comment">// otherwise, defaults to 0. (0 Being a market order.)</span>
<a name="l10870"></a>10870         <span class="comment">// ------------------------------------</span>
<a name="l10871"></a>10871         <span class="keywordtype">char</span> cStopSign        = 0;
<a name="l10872"></a>10872 
<a name="l10873"></a>10873         <span class="keywordflow">if</span> (
<a name="l10874"></a>10874             (ACTIVATION_PRICE &gt; 0) &amp;&amp;
<a name="l10875"></a>10875             ((<span class="charliteral">&#39;&lt;&#39;</span> == STOP_SIGN) || (<span class="charliteral">&#39;&gt;&#39;</span> == STOP_SIGN))
<a name="l10876"></a>10876         )
<a name="l10877"></a>10877         {
<a name="l10878"></a>10878             cStopSign        = STOP_SIGN;
<a name="l10879"></a>10879             lActivationPrice = ACTIVATION_PRICE;
<a name="l10880"></a>10880         }
<a name="l10881"></a>10881         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10882"></a>10882         lMinimumIncrement   *= lMarketScale;       <span class="comment">// minimum increment is PER SCALE.</span>
<a name="l10883"></a>10883 <span class="comment">//      lTotalAssetsOnOffer *= lMinimumIncrement;  // This was a bug. (Left as a warning.)</span>
<a name="l10884"></a>10884         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10885"></a>10885 
<a name="l10886"></a>10886         <a class="code" href="class_o_t_string.html">OTString</a> strOfferType(<span class="stringliteral">&quot;market order&quot;</span>);
<a name="l10887"></a>10887 
<a name="l10888"></a>10888         <span class="keywordflow">if</span> (lPriceLimit &gt; 0)
<a name="l10889"></a>10889             strOfferType = <span class="stringliteral">&quot;limit order&quot;</span>;
<a name="l10890"></a>10890 
<a name="l10891"></a>10891         <span class="keywordflow">if</span> (0 != cStopSign)
<a name="l10892"></a>10892         {
<a name="l10893"></a>10893             <span class="keywordflow">if</span> (lPriceLimit &gt; 0)
<a name="l10894"></a>10894                 strOfferType.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;stop limit order, at threshhold: %c%ld&quot;</span>, cStopSign, lActivationPrice);
<a name="l10895"></a>10895             <span class="keywordflow">else</span>
<a name="l10896"></a>10896                 strOfferType.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;stop order, at threshhold: %c%ld&quot;</span>, cStopSign, lActivationPrice);
<a name="l10897"></a>10897         }
<a name="l10898"></a>10898 
<a name="l10899"></a>10899         <a class="code" href="class_o_t_string.html">OTString</a> strPrice(<span class="stringliteral">&quot;&quot;</span>);
<a name="l10900"></a>10900 
<a name="l10901"></a>10901         <span class="keywordflow">if</span> (lPriceLimit &gt; 0)
<a name="l10902"></a>10902             strPrice.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;Price: %ld\n&quot;</span>, lPriceLimit);
<a name="l10903"></a>10903 
<a name="l10904"></a>10904         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;Placing market offer %ld, type: %s, %s\n&quot;</span>
<a name="l10905"></a>10905                        <span class="stringliteral">&quot;%s&quot;</span>
<a name="l10906"></a>10906                        <span class="stringliteral">&quot;Assets for sale/purchase: %ld\n&quot;</span>
<a name="l10907"></a>10907                        <span class="stringliteral">&quot;In minimum increments of: %ld\n&quot;</span>
<a name="l10908"></a>10908                        <span class="stringliteral">&quot;At market of scale: %ld\n&quot;</span>
<a name="l10909"></a>10909                        <span class="stringliteral">&quot;Valid From: %ld  To: %ld\n&quot;</span>,
<a name="l10910"></a>10910                        lStoredTransactionNumber,
<a name="l10911"></a>10911                        bBuyingOrSelling ? <span class="stringliteral">&quot;selling&quot;</span> : <span class="stringliteral">&quot;buying&quot;</span>, strOfferType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l10912"></a>10912                        strPrice.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l10913"></a>10913                        lTotalAssetsOnOffer,
<a name="l10914"></a>10914                        lMinimumIncrement,
<a name="l10915"></a>10915                        lMarketScale,
<a name="l10916"></a>10916                        <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(VALID_FROM),
<a name="l10917"></a>10917                        <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(VALID_TO)
<a name="l10918"></a>10918                        );
<a name="l10919"></a>10919 
<a name="l10920"></a>10920         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10921"></a>10921         <a class="code" href="class_o_t_offer.html">OTOffer</a> theOffer(SERVER_ID, ASSET_TYPE_ID, CURRENCY_TYPE_ID, lMarketScale);
<a name="l10922"></a>10922         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10923"></a>10923         <a class="code" href="class_o_t_trade.html">OTTrade</a> theTrade(SERVER_ID,
<a name="l10924"></a>10924                          ASSET_TYPE_ID, ASSET_ACCT_ID,
<a name="l10925"></a>10925                          USER_ID,
<a name="l10926"></a>10926                          CURRENCY_TYPE_ID, CURRENCY_ACCT_ID);
<a name="l10927"></a>10927         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10928"></a>10928         <span class="comment">// MAKE OFFER...</span>
<a name="l10929"></a>10929         <span class="comment">//</span>
<a name="l10930"></a>10930         <span class="keywordtype">bool</span> bCreateOffer = theOffer.MakeOffer(bBuyingOrSelling,    <span class="comment">// True == SELLING, False == BUYING</span>
<a name="l10931"></a>10931                                                lPriceLimit,         <span class="comment">// Per Minimum Increment...</span>
<a name="l10932"></a>10932                                                lTotalAssetsOnOffer, <span class="comment">// Total assets available for sale or purchase.</span>
<a name="l10933"></a>10933                                                lMinimumIncrement,   <span class="comment">// The minimum increment that must be bought or sold for each transaction</span>
<a name="l10934"></a>10934                                                lStoredTransactionNumber, <span class="comment">// Transaction number matches on transaction, item, offer, and trade.</span>
<a name="l10935"></a>10935                                                VALID_FROM,  <span class="comment">// defaults to RIGHT NOW aka OT_API_GetTime()</span>
<a name="l10936"></a>10936                                                VALID_TO);   <span class="comment">// defaults to 24 hours (a &quot;Day Order&quot;) aka OT_API_GetTime() + 86,400</span>
<a name="l10937"></a>10937         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10938"></a>10938         <span class="comment">// ISSUE TRADE.</span>
<a name="l10939"></a>10939         <span class="keywordtype">bool</span> bIssueTrade = <span class="keyword">false</span>;
<a name="l10940"></a>10940 
<a name="l10941"></a>10941         <span class="keywordflow">if</span> (bCreateOffer)
<a name="l10942"></a>10942         {
<a name="l10943"></a>10943             bCreateOffer =  theOffer.SignContract(*pNym);
<a name="l10944"></a>10944             <span class="keywordflow">if</span> (bCreateOffer)
<a name="l10945"></a>10945             {
<a name="l10946"></a>10946                 bCreateOffer = theOffer.SaveContract();
<a name="l10947"></a>10947                 <span class="keywordflow">if</span> (bCreateOffer)
<a name="l10948"></a>10948                 {
<a name="l10949"></a>10949                     bIssueTrade = theTrade.<a class="code" href="class_o_t_trade.html#a64013127ededb1a9729aeb07ea9cadb7">IssueTrade</a>(theOffer, cStopSign, lActivationPrice); <span class="comment">// &lt;==== ISSUE TRADE &lt;=====</span>
<a name="l10950"></a>10950                     <span class="comment">// ******************************************************************************</span>
<a name="l10951"></a>10951                     <span class="comment">// This is new: the closing transaction number is now used for CLOSING recurring</span>
<a name="l10952"></a>10952                     <span class="comment">// cron items, like market offers and payment plans. It&#39;s also useful for baskets.</span>
<a name="l10953"></a>10953                     <span class="comment">// Since this is a market offer, it needs a closing number (for later cancellation</span>
<a name="l10954"></a>10954                     <span class="comment">// or expiration.)</span>
<a name="l10955"></a>10955                     <span class="comment">// lAssetAcctClosingNo=0, lCurrencyAcctClosingNo=0;</span>
<a name="l10956"></a>10956                     <span class="comment">//</span>
<a name="l10957"></a>10957                     theTrade.<a class="code" href="class_o_t_cron_item.html#a310153e4e82ec7fbc887e93c4d12220d">AddClosingTransactionNo</a>(lAssetAcctClosingNo);
<a name="l10958"></a>10958                     theTrade.<a class="code" href="class_o_t_cron_item.html#a310153e4e82ec7fbc887e93c4d12220d">AddClosingTransactionNo</a>(lCurrencyAcctClosingNo);
<a name="l10959"></a>10959 
<a name="l10960"></a>10960                     <span class="keywordflow">if</span> (bIssueTrade)
<a name="l10961"></a>10961                     {
<a name="l10962"></a>10962                         bIssueTrade =   theTrade.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10963"></a>10963                         <span class="keywordflow">if</span> (bIssueTrade)
<a name="l10964"></a>10964                             bIssueTrade = theTrade.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10965"></a>10965                     } <span class="comment">// if ( bIssueTrade )</span>
<a name="l10966"></a>10966                 }
<a name="l10967"></a>10967             }
<a name="l10968"></a>10968         } <span class="comment">// if ( bCreateOffer )</span>
<a name="l10969"></a>10969         <span class="comment">// -------------------------------------------------------------------</span>
<a name="l10970"></a>10970         <span class="keywordflow">if</span> (bCreateOffer &amp;&amp; bIssueTrade)
<a name="l10971"></a>10971         {
<a name="l10972"></a>10972             <a class="code" href="class_o_t_string.html">OTString</a> str_ASSET_ACCT_ID(ASSET_ACCT_ID);
<a name="l10973"></a>10973 
<a name="l10974"></a>10974             <span class="comment">// Create a transaction</span>
<a name="l10975"></a>10975             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ASSET_ACCT_ID, SERVER_ID,
<a name="l10976"></a>10976                                                                                <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8acdd69363d8b62cadbfc6a8369a669bc0">OTTransaction::marketOffer</a>, lStoredTransactionNumber);
<a name="l10977"></a>10977 
<a name="l10978"></a>10978             <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l10979"></a>10979             <a class="code" href="class_o_t_item.html">OTItem</a> * pItem = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1ae973afad2dc8a8349e8889304b20e73b">OTItem::marketOffer</a>,
<a name="l10980"></a>10980                                                                (<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> *)(&amp;CURRENCY_ACCT_ID));
<a name="l10981"></a>10981             <span class="comment">// the &quot;To&quot; account (normally used for a TRANSFER transaction) is used here</span>
<a name="l10982"></a>10982             <span class="comment">// storing the Currency Acct ID. The Server will expect the Trade object bundled</span>
<a name="l10983"></a>10983             <span class="comment">// within this item to have an Asset Acct ID and &quot;Currency&quot; Acct ID that match</span>
<a name="l10984"></a>10984             <span class="comment">// those on this Item. Otherwise it will reject the offer.</span>
<a name="l10985"></a>10985             <span class="comment">//</span>
<a name="l10986"></a>10986             <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != pItem, <span class="stringliteral">&quot;OT_API::issueMarketOffer: Error allocating memory in the OT API&quot;</span>);
<a name="l10987"></a>10987 
<a name="l10988"></a>10988             <a class="code" href="class_o_t_string.html">OTString</a> strTrade;
<a name="l10989"></a>10989             theTrade.<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strTrade);
<a name="l10990"></a>10990 
<a name="l10991"></a>10991             <span class="comment">// Add the trade string as the attachment on the transaction item.</span>
<a name="l10992"></a>10992             pItem-&gt;<a class="code" href="class_o_t_item.html#a6e5e9b0c04cb1eca8acaec5b0be1d641">SetAttachment</a>(strTrade); <span class="comment">// The trade is contained in the attachment string. (The offer is within the trade.)</span>
<a name="l10993"></a>10993 
<a name="l10994"></a>10994             <span class="comment">// sign the item</span>
<a name="l10995"></a>10995             pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l10996"></a>10996             pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l10997"></a>10997 
<a name="l10998"></a>10998             <span class="comment">// the Transaction &quot;owns&quot; the item now and will handle cleaning it up.</span>
<a name="l10999"></a>10999             pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l11000"></a>11000             <span class="comment">// ---------------------------------------------</span>
<a name="l11001"></a>11001             <span class="comment">// TRANSACTION AGREEMENT</span>
<a name="l11002"></a>11002 
<a name="l11003"></a>11003             <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that again.</span>
<a name="l11004"></a>11004             <a class="code" href="class_o_t_item.html">OTItem</a> * pStatementItem = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#ab592ef450504c5af83b84d8a15ef02ea">GenerateTransactionStatement</a>(*pTransaction);
<a name="l11005"></a>11005 
<a name="l11006"></a>11006             <span class="keywordflow">if</span> (NULL != pStatementItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l11007"></a>11007                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pStatementItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l11008"></a>11008             <span class="comment">// ---------------------------------------------</span>
<a name="l11009"></a>11009             <span class="comment">// sign the transaction</span>
<a name="l11010"></a>11010             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l11011"></a>11011             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11012"></a>11012 
<a name="l11013"></a>11013             <span class="comment">// set up the ledger</span>
<a name="l11014"></a>11014             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ASSET_ACCT_ID, SERVER_ID);
<a name="l11015"></a>11015             theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ASSET_ACCT_ID, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l11016"></a>11016             theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction); <span class="comment">// now the ledger &quot;owns&quot; and will handle cleaning up the transaction.</span>
<a name="l11017"></a>11017 
<a name="l11018"></a>11018             <span class="comment">// sign the ledger</span>
<a name="l11019"></a>11019             theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l11020"></a>11020             theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11021"></a>11021 
<a name="l11022"></a>11022             <span class="comment">// extract the ledger in ascii-armored form... encoding...</span>
<a name="l11023"></a>11023             <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l11024"></a>11024             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger(strLedger);
<a name="l11025"></a>11025 
<a name="l11026"></a>11026             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11027"></a>11027             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11028"></a>11028             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11029"></a>11029             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11030"></a>11030 
<a name="l11031"></a>11031             <span class="comment">// (1) Set up member variables</span>
<a name="l11032"></a>11032             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l11033"></a>11033             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11034"></a>11034             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11035"></a>11035             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11036"></a>11036 
<a name="l11037"></a>11037             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = str_ASSET_ACCT_ID;
<a name="l11038"></a>11038             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l11039"></a>11039 
<a name="l11040"></a>11040             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l11041"></a>11041             <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l11042"></a>11042             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l11043"></a>11043             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l11044"></a>11044 
<a name="l11045"></a>11045             <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l11046"></a>11046                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l11047"></a>11047                               __FUNCTION__, str_server.c_str());
<a name="l11048"></a>11048 
<a name="l11049"></a>11049             <span class="comment">// (2) Sign the Message</span>
<a name="l11050"></a>11050             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11051"></a>11051 
<a name="l11052"></a>11052             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11053"></a>11053             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11054"></a>11054 
<a name="l11055"></a>11055             <span class="comment">// (Send it)</span>
<a name="l11056"></a>11056             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11057"></a>11057             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11058"></a>11058 
<a name="l11059"></a>11059             <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11060"></a>11060 
<a name="l11061"></a>11061         } <span class="comment">// if (bCreateOffer &amp;&amp; bIssueTrade)</span>
<a name="l11062"></a>11062         <span class="keywordflow">else</span>
<a name="l11063"></a>11063         {
<a name="l11064"></a>11064             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to create offer or issue trade. Sorry.\n&quot;</span>,
<a name="l11065"></a>11065                            __FUNCTION__);
<a name="l11066"></a>11066 
<a name="l11067"></a>11067             <span class="comment">// IF FAILED, add the transaction number (and closing number)</span>
<a name="l11068"></a>11068             <span class="comment">// BACK to the list of available numbers.</span>
<a name="l11069"></a>11069             <span class="comment">//</span>
<a name="l11070"></a>11070             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber,   <span class="keyword">false</span>); <span class="comment">// bSave defaults to true</span>
<a name="l11071"></a>11071             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lAssetAcctClosingNo,        <span class="keyword">false</span>);
<a name="l11072"></a>11072             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lCurrencyAcctClosingNo,     <span class="keyword">true</span> ); <span class="comment">// bSave=true (No sense saving thrice in a row.)</span>
<a name="l11073"></a>11073         }
<a name="l11074"></a>11074     } <span class="comment">// got transaction number.</span>
<a name="l11075"></a>11075 
<a name="l11076"></a>11076     <span class="keywordflow">return</span> (-1);
<a name="l11077"></a>11077 }
<a name="l11078"></a>11078 
<a name="l11079"></a>11079 
<a name="l11080"></a>11080 
<a name="l11081"></a>11081 <span class="comment">// -----------------------------------</span>
<a name="l11090"></a><a class="code" href="class_o_t___a_p_i.html#a86ffb271aec1f5cdb211f3f1403cc910">11090</a> <span class="comment"></span>int32_t <a class="code" href="class_o_t___a_p_i.html#a86ffb271aec1f5cdb211f3f1403cc910">OT_API::getMarketList</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l11091"></a>11091 {
<a name="l11092"></a>11092     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getMarketList&quot;</span>;
<a name="l11093"></a>11093     <span class="comment">// -----------------------------------------------------</span>
<a name="l11094"></a>11094     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11095"></a>11095     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11096"></a>11096     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11097"></a>11097     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11098"></a>11098     <span class="comment">// -----------------------------------------------------</span>
<a name="l11099"></a>11099     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11100"></a>11100     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11101"></a>11101     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11102"></a>11102     <span class="comment">// -----------------------------------------------------</span>
<a name="l11103"></a>11103     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11104"></a>11104 
<a name="l11105"></a>11105     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l11106"></a>11106     <span class="comment">// -----------------------------------------------------</span>
<a name="l11107"></a>11107     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11108"></a>11108     int64_t lRequestNumber = 0;
<a name="l11109"></a>11109     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11110"></a>11110     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11111"></a>11111     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11112"></a>11112 
<a name="l11113"></a>11113     <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l11114"></a>11114 
<a name="l11115"></a>11115     <span class="comment">// (1) Set up member variables</span>
<a name="l11116"></a>11116     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMarketList&quot;</span>;
<a name="l11117"></a>11117     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11118"></a>11118     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11119"></a>11119     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11120"></a>11120 
<a name="l11121"></a>11121     <span class="comment">// (2) Sign the Message</span>
<a name="l11122"></a>11122     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11123"></a>11123 
<a name="l11124"></a>11124     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11125"></a>11125     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11126"></a>11126 
<a name="l11127"></a>11127     <span class="comment">// (Send it)</span>
<a name="l11128"></a>11128     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11129"></a>11129     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11130"></a>11130 
<a name="l11131"></a>11131     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11132"></a>11132 }
<a name="l11133"></a>11133 
<a name="l11134"></a>11134 
<a name="l11135"></a>11135 
<a name="l11136"></a>11136 
<a name="l11137"></a>11137 <span class="comment">// -----------------------------------------------------</span>
<a name="l11143"></a><a class="code" href="class_o_t___a_p_i.html#a32bf905befe6a9450b9293ed75ee1e3a">11143</a> <span class="comment"></span>int32_t <a class="code" href="class_o_t___a_p_i.html#a32bf905befe6a9450b9293ed75ee1e3a">OT_API::getMarketOffers</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11144"></a>11144                              <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; MARKET_ID, <span class="keyword">const</span> int64_t &amp; lDepth)
<a name="l11145"></a>11145 {
<a name="l11146"></a>11146     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getMarketOffers&quot;</span>;
<a name="l11147"></a>11147     <span class="comment">// -----------------------------------------------------</span>
<a name="l11148"></a>11148     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11149"></a>11149     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11150"></a>11150     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11151"></a>11151     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11152"></a>11152     <span class="comment">// -----------------------------------------------------</span>
<a name="l11153"></a>11153     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11154"></a>11154     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11155"></a>11155     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11156"></a>11156     <span class="comment">// -----------------------------------------------------</span>
<a name="l11157"></a>11157     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11158"></a>11158 
<a name="l11159"></a>11159     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strMarketID(MARKET_ID);
<a name="l11160"></a>11160 
<a name="l11161"></a>11161     <span class="comment">// -----------------------------------------------------</span>
<a name="l11162"></a>11162     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11163"></a>11163     int64_t lRequestNumber = 0;
<a name="l11164"></a>11164     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11165"></a>11165     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11166"></a>11166     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11167"></a>11167 
<a name="l11168"></a>11168     <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l11169"></a>11169     <span class="comment">// (1) Set up member variables</span>
<a name="l11170"></a>11170     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMarketOffers&quot;</span>;
<a name="l11171"></a>11171     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11172"></a>11172     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11173"></a>11173     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11174"></a>11174 
<a name="l11175"></a>11175     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strMarketID;
<a name="l11176"></a>11176     theMessage.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>             = lDepth;
<a name="l11177"></a>11177 
<a name="l11178"></a>11178     <span class="comment">// (2) Sign the Message</span>
<a name="l11179"></a>11179     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11180"></a>11180 
<a name="l11181"></a>11181     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11182"></a>11182     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11183"></a>11183 
<a name="l11184"></a>11184     <span class="comment">// (Send it)</span>
<a name="l11185"></a>11185     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11186"></a>11186     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11187"></a>11187 
<a name="l11188"></a>11188     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11189"></a>11189 }
<a name="l11190"></a>11190 
<a name="l11201"></a><a class="code" href="class_o_t___a_p_i.html#ad4046209a1d0cb1792b23f71834a294e">11201</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ad4046209a1d0cb1792b23f71834a294e">OT_API::getMarketRecentTrades</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11202"></a>11202                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11203"></a>11203                                   <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; MARKET_ID)
<a name="l11204"></a>11204 {
<a name="l11205"></a>11205     <span class="comment">// -----------------------------------------------------</span>
<a name="l11206"></a>11206     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11207"></a>11207     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11208"></a>11208     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11209"></a>11209     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11210"></a>11210     <span class="comment">// -----------------------------------------------------</span>
<a name="l11211"></a>11211     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11212"></a>11212     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11213"></a>11213     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11214"></a>11214     <span class="comment">// -----------------------------------------------------</span>
<a name="l11215"></a>11215     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11216"></a>11216 
<a name="l11217"></a>11217     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strMarketID(MARKET_ID);
<a name="l11218"></a>11218     <span class="comment">// -----------------------------------------------------</span>
<a name="l11219"></a>11219     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11220"></a>11220     int64_t lRequestNumber = 0;
<a name="l11221"></a>11221     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11222"></a>11222     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11223"></a>11223     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11224"></a>11224 
<a name="l11225"></a>11225     <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l11226"></a>11226     <span class="comment">// (1) Set up member variables</span>
<a name="l11227"></a>11227     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMarketRecentTrades&quot;</span>;
<a name="l11228"></a>11228     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11229"></a>11229     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11230"></a>11230     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11231"></a>11231 
<a name="l11232"></a>11232     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strMarketID;
<a name="l11233"></a>11233 
<a name="l11234"></a>11234     <span class="comment">// (2) Sign the Message</span>
<a name="l11235"></a>11235     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11236"></a>11236 
<a name="l11237"></a>11237     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11238"></a>11238     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11239"></a>11239 
<a name="l11240"></a>11240     <span class="comment">// (Send it)</span>
<a name="l11241"></a>11241     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11242"></a>11242     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11243"></a>11243 
<a name="l11244"></a>11244     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11245"></a>11245 }
<a name="l11246"></a>11246 
<a name="l11247"></a>11247 
<a name="l11248"></a>11248 
<a name="l11256"></a><a class="code" href="class_o_t___a_p_i.html#a1e508b83332ea7707f74c91622105ea8">11256</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a1e508b83332ea7707f74c91622105ea8">OT_API::getNym_MarketOffers</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID, <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l11257"></a>11257 {
<a name="l11258"></a>11258     <span class="comment">// -----------------------------------------------------</span>
<a name="l11259"></a>11259     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11260"></a>11260     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11261"></a>11261     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11262"></a>11262     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11263"></a>11263     <span class="comment">// -----------------------------------------------------</span>
<a name="l11264"></a>11264     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11265"></a>11265     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11266"></a>11266     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11267"></a>11267     <span class="comment">// -----------------------------------------------------</span>
<a name="l11268"></a>11268     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11269"></a>11269 
<a name="l11270"></a>11270     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l11271"></a>11271 
<a name="l11272"></a>11272     <span class="comment">// -----------------------------------------------------</span>
<a name="l11273"></a>11273     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11274"></a>11274     int64_t lRequestNumber = 0;
<a name="l11275"></a>11275     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11276"></a>11276     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11277"></a>11277     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11278"></a>11278 
<a name="l11279"></a>11279     <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l11280"></a>11280 
<a name="l11281"></a>11281     <span class="comment">// (1) Set up member variables</span>
<a name="l11282"></a>11282     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getNym_MarketOffers&quot;</span>;
<a name="l11283"></a>11283     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11284"></a>11284     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11285"></a>11285     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11286"></a>11286 
<a name="l11287"></a>11287     <span class="comment">// (2) Sign the Message</span>
<a name="l11288"></a>11288     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11289"></a>11289 
<a name="l11290"></a>11290     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11291"></a>11291     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11292"></a>11292 
<a name="l11293"></a>11293     <span class="comment">// (Send it)</span>
<a name="l11294"></a>11294     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11295"></a>11295     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11296"></a>11296 
<a name="l11297"></a>11297     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11298"></a>11298 }
<a name="l11299"></a>11299 
<a name="l11300"></a>11300 
<a name="l11301"></a>11301 <span class="comment">// ===============================================================</span>
<a name="l11302"></a>11302 
<a name="l11303"></a>11303 
<a name="l11304"></a>11304 
<a name="l11305"></a>11305 
<a name="l11306"></a><a class="code" href="class_o_t___a_p_i.html#a10d6c5c156dfe6cf66860c3aa62e5fc0">11306</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a10d6c5c156dfe6cf66860c3aa62e5fc0">OT_API::notarizeTransfer</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; SERVER_ID,
<a name="l11307"></a>11307                               <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; USER_ID,
<a name="l11308"></a>11308                               <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; ACCT_FROM,
<a name="l11309"></a>11309                               <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; ACCT_TO,
<a name="l11310"></a>11310                               <span class="keyword">const</span> int64_t &amp; AMOUNT,
<a name="l11311"></a>11311                               <a class="code" href="class_o_t_string.html">OTString</a>      &amp; NOTE)
<a name="l11312"></a>11312 {
<a name="l11313"></a>11313     <span class="comment">// -----------------------------------------------------</span>
<a name="l11314"></a>11314     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l11315"></a>11315     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11316"></a>11316     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11317"></a>11317     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11318"></a>11318     <span class="comment">// -----------------------------------------------------</span>
<a name="l11319"></a>11319     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11320"></a>11320     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11321"></a>11321     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11322"></a>11322     <span class="comment">// -----------------------------------------------------</span>
<a name="l11323"></a>11323     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_FROM, SERVER_ID, __FUNCTION__);
<a name="l11324"></a>11324     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l11325"></a>11325     <span class="comment">// By this point, pAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l11326"></a>11326     <span class="comment">// -----------------------------------------------------</span>
<a name="l11327"></a>11327     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11328"></a>11328 
<a name="l11329"></a>11329     int64_t lRequestNumber = 0;
<a name="l11330"></a>11330     <span class="keyword">const</span> int64_t lAmount = AMOUNT;
<a name="l11331"></a>11331 
<a name="l11332"></a>11332     <a class="code" href="class_o_t_string.html">OTString</a>    strServerID(SERVER_ID), strNymID(USER_ID),
<a name="l11333"></a>11333                 strFromAcct(ACCT_FROM), strToAcct(ACCT_TO);
<a name="l11334"></a>11334 
<a name="l11335"></a>11335     int64_t lStoredTransactionNumber=0;
<a name="l11336"></a>11336     <span class="keywordtype">bool</span> bGotTransNum = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a82c5ec5457947738c807bffd581181ac">GetNextTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber);
<a name="l11337"></a>11337 
<a name="l11338"></a>11338     <span class="keywordflow">if</span> (bGotTransNum)
<a name="l11339"></a>11339     {
<a name="l11340"></a>11340         <span class="comment">// Create a transaction</span>
<a name="l11341"></a>11341         <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pTransaction = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a> (USER_ID, ACCT_FROM,
<a name="l11342"></a>11342                                                                            SERVER_ID,
<a name="l11343"></a>11343                                                                            <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8af50841ed6e2bd9586ae8f6d79ee3b67d">OTTransaction::transfer</a>,
<a name="l11344"></a>11344                                                                            lStoredTransactionNumber);
<a name="l11345"></a>11345 
<a name="l11346"></a>11346         <span class="comment">// set up the transaction item (each transaction may have multiple items...)</span>
<a name="l11347"></a>11347         <a class="code" href="class_o_t_item.html">OTItem</a> * pItem      = <a class="code" href="class_o_t_item.html#a2376ee56b6c536a63a59e2bfebada0b3">OTItem::CreateItemFromTransaction</a>(*pTransaction, <a class="code" href="class_o_t_item.html#a03db091faaab100aadc455f4ebe2c5d1a4b8c3e5db0f93a82b46a3d7dda75a835">OTItem::transfer</a>, &amp;ACCT_TO);
<a name="l11348"></a>11348         pItem-&gt;<a class="code" href="class_o_t_item.html#a81d53d2910a45fdbb11d92ae680519fb">SetAmount</a>(lAmount);
<a name="l11349"></a>11349 
<a name="l11350"></a>11350         <span class="comment">// The user can include a note here for the recipient.</span>
<a name="l11351"></a>11351         <span class="keywordflow">if</span> (NOTE.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; NOTE.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &gt; 2)
<a name="l11352"></a>11352         {
<a name="l11353"></a>11353             pItem-&gt;<a class="code" href="class_o_t_item.html#ac0a3c73f3c09f2fdbd83a381898360df">SetNote</a>(NOTE);
<a name="l11354"></a>11354         }
<a name="l11355"></a>11355 
<a name="l11356"></a>11356         <span class="comment">// sign the item</span>
<a name="l11357"></a>11357         pItem-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l11358"></a>11358         pItem-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11359"></a>11359 
<a name="l11360"></a>11360         pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pItem); <span class="comment">// the Transaction&#39;s destructor will cleanup the item. It &quot;owns&quot; it now.</span>
<a name="l11361"></a>11361         <span class="comment">// --------------------------------------------------</span>
<a name="l11362"></a>11362         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pInbox   = pAccount-&gt;<a class="code" href="class_o_t_account.html#a9d961058556c3a8381b082d3a0b5f7e7">LoadInbox</a>(*pNym);
<a name="l11363"></a>11363         <a class="code" href="class_o_t_ledger.html">OTLedger</a> * pOutbox  = pAccount-&gt;<a class="code" href="class_o_t_account.html#a5a00679ce53bc6744dc4ec09c2915b3a">LoadOutbox</a>(*pNym);
<a name="l11364"></a>11364 
<a name="l11365"></a>11365         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theInboxAngel(pInbox);
<a name="l11366"></a>11366         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTLedger&gt;</a> theOutboxAngel(pOutbox);
<a name="l11367"></a>11367 
<a name="l11368"></a>11368         <span class="keywordflow">if</span> (NULL == pInbox)
<a name="l11369"></a>11369         {
<a name="l11370"></a>11370             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::notarizeTransfer: Failed loading inbox for acct: %s\n&quot;</span>, strFromAcct.Get());
<a name="l11371"></a>11371             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l11372"></a>11372             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l11373"></a>11373         }
<a name="l11374"></a>11374         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == pOutbox)
<a name="l11375"></a>11375         {
<a name="l11376"></a>11376             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::notarizeTransfer: Failed loading outbox for acct: %s\n&quot;</span>, strFromAcct.Get());
<a name="l11377"></a>11377             <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l11378"></a>11378             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2771ea8cf77d2ac05d942e149c2bc3e6">AddTransactionNum</a>(*pNym, strServerID, lStoredTransactionNumber, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l11379"></a>11379         }
<a name="l11380"></a>11380         <span class="keywordflow">else</span>
<a name="l11381"></a>11381         {
<a name="l11382"></a>11382             <span class="comment">// Need to setup a dummy outbox transaction (to mimic the one that will be on the server side when this pending transaction is actually put into the real outbox.)</span>
<a name="l11383"></a>11383             <span class="comment">// When the server adds its own, and then compares the two, they should both show the same pending transaction, in order for this balance agreement to be valid..</span>
<a name="l11384"></a>11384             <span class="comment">// Otherwise the server would have to refuse it for being inaccurate (server can&#39;t sign something inaccurate!) So I throw a dummy on there before generating balance statement.</span>
<a name="l11385"></a>11385             <span class="comment">//</span>
<a name="l11386"></a>11386             <a class="code" href="class_o_t_transaction.html">OTTransaction</a> * pOutboxTransaction  = <a class="code" href="class_o_t_transaction.html#a5bfc7ce34aa67cf9dad96e661e118020">OTTransaction::GenerateTransaction</a>(*pOutbox, <a class="code" href="class_o_t_transaction.html#af6b54636f1000e09f19d1c7a7886e1f8addbed2a5d0af9bf58ff0694f587b4e08">OTTransaction::pending</a>,
<a name="l11387"></a>11387                                                                                      1<span class="comment">/*todo pick some number that everyone agrees doesn&#39;t matter, like 1. The referring-to is the important</span>
<a name="l11388"></a>11388 <span class="comment">                                                                                       number in this case, and perhaps server should update this value too before signing and returning.*/</span>); <span class="comment">// todo use a constant instead of &#39;1&#39;</span>
<a name="l11389"></a>11389             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pOutboxTransaction); <span class="comment">// for now.</span>
<a name="l11390"></a>11390 
<a name="l11391"></a>11391             <a class="code" href="class_o_t_string.html">OTString</a> strItem(*pItem);
<a name="l11392"></a>11392             pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#a9dd50265579347d2e8fa3ea36ca66320">SetReferenceString</a>(strItem); <span class="comment">// So the GenerateBalanceStatement function below can get the other info off this item (like amount, etc)</span>
<a name="l11393"></a>11393             pOutboxTransaction-&gt;<a class="code" href="class_o_t_transaction_type.html#ab0f87cd43699c20eddd70b5970c092d1">SetReferenceToNum</a>(pItem-&gt;<a class="code" href="class_o_t_transaction_type.html#aa204b21b7f498389f746742c1d2007fa">GetTransactionNum</a>());
<a name="l11394"></a>11394 
<a name="l11395"></a>11395 <span class="comment">//          pOutboxTransaction-&gt;SignContract(*pNym);    // Unnecessary to sign/save, since this is just a dummy data for verification purposes, and isn&#39;t being</span>
<a name="l11396"></a>11396 <span class="comment">//          pOutboxTransaction-&gt;SaveContract();         // serialized anywhere. (I download the actual outbox from server, and verify against last signed receipt.)</span>
<a name="l11397"></a>11397 
<a name="l11398"></a>11398             pOutbox-&gt;<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pOutboxTransaction);  <span class="comment">// no need to cleanup pOutboxTransaction since pOutbox will handle it now.</span>
<a name="l11399"></a>11399             <span class="comment">// ---------------------------------------------</span>
<a name="l11400"></a>11400             <span class="comment">// BALANCE AGREEMENT</span>
<a name="l11401"></a>11401 
<a name="l11402"></a>11402             <span class="comment">// pBalanceItem is signed and saved within this call. No need to do that twice.</span>
<a name="l11403"></a>11403             <span class="comment">//</span>
<a name="l11404"></a>11404             <a class="code" href="class_o_t_item.html">OTItem</a> * pBalanceItem = pInbox-&gt;<a class="code" href="class_o_t_ledger.html#acd3bbb77d181318d69bbf61b5aeca7fb">GenerateBalanceStatement</a>(lAmount*(-1), *pTransaction, *pNym, *pAccount, *pOutbox);
<a name="l11405"></a>11405 
<a name="l11406"></a>11406             <span class="keywordflow">if</span> (NULL != pBalanceItem) <span class="comment">// will never be NULL. Will assert above before it gets here.</span>
<a name="l11407"></a>11407                 pTransaction-&gt;<a class="code" href="class_o_t_transaction.html#a5abc071b7eeddc40ea151cccd011e4d6">AddItem</a>(*pBalanceItem); <span class="comment">// Better not be NULL... message will fail... But better check anyway.</span>
<a name="l11408"></a>11408             <span class="comment">// ---------------------------------------------</span>
<a name="l11409"></a>11409             <span class="comment">// sign the transaction</span>
<a name="l11410"></a>11410             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l11411"></a>11411             pTransaction-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11412"></a>11412 
<a name="l11413"></a>11413             <span class="comment">// set up the ledger</span>
<a name="l11414"></a>11414             <a class="code" href="class_o_t_ledger.html">OTLedger</a> theLedger(USER_ID, ACCT_FROM, SERVER_ID);
<a name="l11415"></a>11415             theLedger.<a class="code" href="class_o_t_ledger.html#ae255257ef1a25233ca772d81ab730643">GenerateLedger</a>(ACCT_FROM, SERVER_ID, <a class="code" href="class_o_t_ledger.html#ac03f2514d0c6ae00147c5d53bf19591aa78e88da32ff989182e4eead9926e7916">OTLedger::message</a>); <span class="comment">// bGenerateLedger defaults to false, which is correct.</span>
<a name="l11416"></a>11416             theLedger.<a class="code" href="class_o_t_ledger.html#a6befecfc9199e90d459f3c89f2f0dc14">AddTransaction</a>(*pTransaction);
<a name="l11417"></a>11417 
<a name="l11418"></a>11418             <span class="comment">// sign the ledger</span>
<a name="l11419"></a>11419             theLedger.<a class="code" href="class_o_t_contract.html#abd60037fe655ee8cae9a3ece5d1e2ea6">SignContract</a>(*pNym);
<a name="l11420"></a>11420             theLedger.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11421"></a>11421 
<a name="l11422"></a>11422             <span class="comment">// extract the ledger in ascii-armored form</span>
<a name="l11423"></a>11423             <a class="code" href="class_o_t_string.html">OTString</a>        strLedger(theLedger);
<a name="l11424"></a>11424             <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a>    ascLedger;
<a name="l11425"></a>11425 
<a name="l11426"></a>11426             <span class="comment">// Encoding...</span>
<a name="l11427"></a>11427             ascLedger.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strLedger);
<a name="l11428"></a>11428             <span class="comment">// ---------------------------------------------</span>
<a name="l11429"></a>11429             <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11430"></a>11430             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11431"></a>11431             theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11432"></a>11432             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11433"></a>11433 
<a name="l11434"></a>11434             <span class="comment">// (1) Set up member variables</span>
<a name="l11435"></a>11435             theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;notarizeTransactions&quot;</span>;
<a name="l11436"></a>11436             theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11437"></a>11437             theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11438"></a>11438             theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11439"></a>11439 
<a name="l11440"></a>11440             theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strFromAcct;
<a name="l11441"></a>11441             theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ascLedger;
<a name="l11442"></a>11442 
<a name="l11443"></a>11443             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l11444"></a>11444             <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l11445"></a>11445             <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l11446"></a>11446             NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l11447"></a>11447 
<a name="l11448"></a>11448             <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l11449"></a>11449                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l11450"></a>11450                               str_server.c_str());
<a name="l11451"></a>11451 
<a name="l11452"></a>11452             <span class="comment">// (2) Sign the Message</span>
<a name="l11453"></a>11453             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11454"></a>11454 
<a name="l11455"></a>11455             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11456"></a>11456             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11457"></a>11457 
<a name="l11458"></a>11458             <span class="comment">// (Send it)</span>
<a name="l11459"></a>11459             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11460"></a>11460             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11461"></a>11461 
<a name="l11462"></a>11462             <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11463"></a>11463         }
<a name="l11464"></a>11464     }
<a name="l11465"></a>11465     <span class="keywordflow">else</span>
<a name="l11466"></a>11466         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;No transaction numbers were available. Suggest requesting the server for one.\n&quot;</span>);
<a name="l11467"></a>11467 
<a name="l11468"></a>11468         <span class="comment">// IF FAILED, ADD TRANSACTION NUMBER BACK TO LIST OF AVAILABLE NUMBERS.</span>
<a name="l11469"></a>11469 <span class="comment">//      pNym-&gt;AddTransactionNum(*pNym, strServerID, lStoredTransactionNumber, true); // bSave=true</span>
<a name="l11470"></a>11470         <span class="comment">// Duh! No need to re-add a transaction num when the error is that there weren&#39;t any transaction numbers...</span>
<a name="l11471"></a>11471 
<a name="l11472"></a>11472     <span class="keywordflow">return</span> -1;
<a name="l11473"></a>11473 }
<a name="l11474"></a>11474 
<a name="l11475"></a>11475 
<a name="l11476"></a>11476 
<a name="l11477"></a>11477 
<a name="l11478"></a>11478 
<a name="l11479"></a><a class="code" href="class_o_t___a_p_i.html#a2536b41070f3a165345ae598381ddfdd">11479</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a2536b41070f3a165345ae598381ddfdd">OT_API::getNymbox</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11480"></a>11480                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l11481"></a>11481 {
<a name="l11482"></a>11482     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getNymbox&quot;</span>;
<a name="l11483"></a>11483     <span class="comment">// -----------------------------------------------------</span>
<a name="l11484"></a>11484     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11485"></a>11485     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11486"></a>11486     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11487"></a>11487     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11488"></a>11488     <span class="comment">// -----------------------------------------------------</span>
<a name="l11489"></a>11489     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11490"></a>11490     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11491"></a>11491     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11492"></a>11492     <span class="comment">// -----------------------------------------------------</span>
<a name="l11493"></a>11493     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11494"></a>11494     int64_t lRequestNumber = 0;
<a name="l11495"></a>11495 
<a name="l11496"></a>11496     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l11497"></a>11497 
<a name="l11498"></a>11498     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11499"></a>11499     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11500"></a>11500     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11501"></a>11501     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11502"></a>11502 
<a name="l11503"></a>11503     <span class="comment">// (1) set up member variables</span>
<a name="l11504"></a>11504     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getNymbox&quot;</span>;
<a name="l11505"></a>11505     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11506"></a>11506     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11507"></a>11507     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11508"></a>11508 
<a name="l11509"></a>11509     <span class="comment">// (2) Sign the Message</span>
<a name="l11510"></a>11510     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11511"></a>11511 
<a name="l11512"></a>11512     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11513"></a>11513     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11514"></a>11514 
<a name="l11515"></a>11515     <span class="comment">// (Send it)</span>
<a name="l11516"></a>11516     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11517"></a>11517     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11518"></a>11518 
<a name="l11519"></a>11519     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11520"></a>11520 }
<a name="l11521"></a>11521 
<a name="l11522"></a>11522 
<a name="l11523"></a>11523 <span class="comment">// NOTE: Deprecated. Replaced by getAccountFiles.</span>
<a name="l11524"></a><a class="code" href="class_o_t___a_p_i.html#a8bc5ab412574867dd506207e311d0fa2">11524</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a8bc5ab412574867dd506207e311d0fa2">OT_API::getInbox</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11525"></a>11525                      <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11526"></a>11526                      <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCT_ID)
<a name="l11527"></a>11527 {
<a name="l11528"></a>11528     <span class="comment">// -----------------------------------------------------</span>
<a name="l11529"></a>11529     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l11530"></a>11530     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11531"></a>11531     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11532"></a>11532     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11533"></a>11533     <span class="comment">// -----------------------------------------------------</span>
<a name="l11534"></a>11534     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11535"></a>11535     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11536"></a>11536     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11537"></a>11537     <span class="comment">// -----------------------------------------------------</span>
<a name="l11538"></a>11538     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l11539"></a>11539     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l11540"></a>11540     <span class="comment">// By this point, pAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l11541"></a>11541     <span class="comment">// -----------------------------------------------------</span>
<a name="l11542"></a>11542     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11543"></a>11543     int64_t lRequestNumber = 0;
<a name="l11544"></a>11544 
<a name="l11545"></a>11545     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCT_ID);
<a name="l11546"></a>11546 
<a name="l11547"></a>11547     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11548"></a>11548     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11549"></a>11549     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11550"></a>11550     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11551"></a>11551 
<a name="l11552"></a>11552     <span class="comment">// (1) set up member variables</span>
<a name="l11553"></a>11553     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getInbox&quot;</span>;
<a name="l11554"></a>11554     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11555"></a>11555     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11556"></a>11556     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11557"></a>11557 
<a name="l11558"></a>11558     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l11559"></a>11559 
<a name="l11560"></a>11560     <span class="comment">// (2) Sign the Message</span>
<a name="l11561"></a>11561     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11562"></a>11562 
<a name="l11563"></a>11563     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11564"></a>11564     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11565"></a>11565 
<a name="l11566"></a>11566     <span class="comment">// (Send it)</span>
<a name="l11567"></a>11567     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11568"></a>11568     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11569"></a>11569 
<a name="l11570"></a>11570     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11571"></a>11571 }
<a name="l11572"></a>11572 
<a name="l11573"></a>11573 
<a name="l11574"></a>11574 
<a name="l11575"></a>11575 <span class="comment">// NOTE: Deprecated. Replaced by getAccountFiles.</span>
<a name="l11576"></a><a class="code" href="class_o_t___a_p_i.html#afca788fa27e0d4988a5c09586fe23237">11576</a> int32_t <a class="code" href="class_o_t___a_p_i.html#afca788fa27e0d4988a5c09586fe23237">OT_API::getOutbox</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11577"></a>11577                       <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11578"></a>11578                       <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCT_ID)
<a name="l11579"></a>11579 {
<a name="l11580"></a>11580     <span class="comment">// -----------------------------------------------------</span>
<a name="l11581"></a>11581     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__);
<a name="l11582"></a>11582     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11583"></a>11583     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11584"></a>11584     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11585"></a>11585     <span class="comment">// -----------------------------------------------------</span>
<a name="l11586"></a>11586     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11587"></a>11587     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11588"></a>11588     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11589"></a>11589     <span class="comment">// -----------------------------------------------------</span>
<a name="l11590"></a>11590     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l11591"></a>11591     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l11592"></a>11592     <span class="comment">// By this point, pAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l11593"></a>11593     <span class="comment">// -----------------------------------------------------</span>
<a name="l11594"></a>11594     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11595"></a>11595     int64_t lRequestNumber = 0;
<a name="l11596"></a>11596 
<a name="l11597"></a>11597     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCT_ID);
<a name="l11598"></a>11598 
<a name="l11599"></a>11599     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11600"></a>11600     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11601"></a>11601     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11602"></a>11602     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11603"></a>11603 
<a name="l11604"></a>11604     <span class="comment">// (1) set up member variables</span>
<a name="l11605"></a>11605     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getOutbox&quot;</span>;
<a name="l11606"></a>11606     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11607"></a>11607     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11608"></a>11608     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11609"></a>11609 
<a name="l11610"></a>11610     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l11611"></a>11611 
<a name="l11612"></a>11612     <span class="comment">// (2) Sign the Message</span>
<a name="l11613"></a>11613     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11614"></a>11614 
<a name="l11615"></a>11615     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11616"></a>11616     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11617"></a>11617 
<a name="l11618"></a>11618     <span class="comment">// (Send it)</span>
<a name="l11619"></a>11619     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11620"></a>11620     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11621"></a>11621 
<a name="l11622"></a>11622     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11623"></a>11623 }
<a name="l11624"></a>11624 
<a name="l11625"></a>11625 
<a name="l11626"></a>11626 
<a name="l11627"></a>11627 
<a name="l11628"></a>11628 <span class="comment">// Returns:</span>
<a name="l11629"></a>11629 <span class="comment">// -1 if error.</span>
<a name="l11630"></a>11630 <span class="comment">//  0 if Nymbox is empty.</span>
<a name="l11631"></a>11631 <span class="comment">//  1 or more: Count of items in Nymbox before processing.</span>
<a name="l11632"></a>11632 <span class="comment">//  UPDATE: This now returns the request number of the message sent, if success.</span>
<a name="l11633"></a>11633 <span class="comment">//</span>
<a name="l11634"></a><a class="code" href="class_o_t___a_p_i.html#aafe1988e1f3029dc633666816ccee743">11634</a> int32_t <a class="code" href="class_o_t___a_p_i.html#aafe1988e1f3029dc633666816ccee743">OT_API::processNymbox</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; SERVER_ID,
<a name="l11635"></a>11635                           <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; USER_ID)
<a name="l11636"></a>11636 {
<a name="l11637"></a>11637     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::processNymbox&quot;</span>;
<a name="l11638"></a>11638     <span class="comment">// -----------------------------------------------------</span>
<a name="l11639"></a>11639     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11640"></a>11640     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11641"></a>11641     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11642"></a>11642     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11643"></a>11643     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNymID(USER_ID);
<a name="l11644"></a>11644     <span class="comment">// -----------------------------------------------------</span>
<a name="l11645"></a>11645     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11646"></a>11646     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11647"></a>11647     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11648"></a>11648     <span class="comment">// -----------------------------------------------------</span>
<a name="l11649"></a>11649     <a class="code" href="class_o_t_message.html">OTMessage</a>   theMessage;
<a name="l11650"></a>11650     <span class="keywordtype">bool</span>        bSuccess        = <span class="keyword">false</span>;
<a name="l11651"></a>11651     int32_t         nReceiptCount   = (-1);
<a name="l11652"></a>11652     int32_t         nRequestNum     = (-1);
<a name="l11653"></a>11653     <span class="keywordtype">bool</span>        bIsEmpty        = <span class="keyword">true</span>;
<a name="l11654"></a>11654 
<a name="l11655"></a>11655     {
<a name="l11656"></a>11656         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>         &amp; theNym    = *pNym;
<a name="l11657"></a>11657         <a class="code" href="class_o_t_server_contract.html">OTServerContract</a>    &amp; theServer = *pServer;
<a name="l11658"></a>11658 
<a name="l11659"></a>11659         <span class="comment">// Load up the appropriate Nymbox...</span>
<a name="l11660"></a>11660         <a class="code" href="class_o_t_ledger.html">OTLedger</a> theNymbox (USER_ID, USER_ID, SERVER_ID);
<a name="l11661"></a>11661 
<a name="l11662"></a>11662         <span class="keywordtype">bool</span>    bLoadedNymbox   = theNymbox.<a class="code" href="class_o_t_ledger.html#aa77a7e498b3866d054b3c58fb6c8e7d7">LoadNymbox</a>();
<a name="l11663"></a>11663         <span class="keywordtype">bool</span>    bVerifiedNymbox = bLoadedNymbox ? theNymbox.<a class="code" href="class_o_t_ledger.html#a3511c200c6eaa50c6cf249c8995fcb7e">VerifyAccount</a>(theNym) : <span class="keyword">false</span>;
<a name="l11664"></a>11664 
<a name="l11665"></a>11665         <span class="keywordflow">if</span> (<span class="keyword">false</span> == bLoadedNymbox)
<a name="l11666"></a>11666             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::processNymbox: Failed loading Nymbox: %s \n&quot;</span>,
<a name="l11667"></a>11667                            strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11668"></a>11668         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == bVerifiedNymbox)
<a name="l11669"></a>11669             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::processNymbox: Failed verifying Nymbox: %s \n&quot;</span>,
<a name="l11670"></a>11670                            strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11671"></a>11671         <span class="comment">// --------------------------------------</span>
<a name="l11672"></a>11672         <span class="keywordflow">else</span>
<a name="l11673"></a>11673         {
<a name="l11674"></a>11674             nReceiptCount   = theNymbox.<a class="code" href="class_o_t_ledger.html#a963473034789aca7bab8ddb4b089a3ff">GetTransactionCount</a>();
<a name="l11675"></a>11675             bIsEmpty        = (nReceiptCount &lt; 1);
<a name="l11676"></a>11676 
<a name="l11677"></a>11677             <span class="comment">// -----------------</span>
<a name="l11678"></a>11678             <span class="keywordflow">if</span> (!bIsEmpty)
<a name="l11679"></a>11679                 bSuccess = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba6f91239e6035d1c426d0d00e7537e">AcceptEntireNymbox</a>(theNymbox, SERVER_ID, theServer, theNym, theMessage);
<a name="l11680"></a>11680             <span class="comment">// -----------------</span>
<a name="l11681"></a>11681 
<a name="l11682"></a>11682             <span class="keywordflow">if</span> (!bSuccess)
<a name="l11683"></a>11683             {
<a name="l11684"></a>11684                 <span class="keywordflow">if</span> (bIsEmpty)
<a name="l11685"></a>11685                 {
<a name="l11686"></a>11686                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;OT_API::processNymbox: Nymbox (%s) is empty (so, skipping processNymbox.)\n&quot;</span>,
<a name="l11687"></a>11687                                    strNymID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11688"></a>11688                     nRequestNum   = 0;
<a name="l11689"></a>11689                     nReceiptCount = 0; <span class="comment">//redundant.</span>
<a name="l11690"></a>11690                 }
<a name="l11691"></a>11691                 <span class="keywordflow">else</span>
<a name="l11692"></a>11692                 {
<a name="l11693"></a>11693                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OT_API::processNymbox: Failed trying to accept the entire Nymbox. (And no, it&#39;s not empty.)\n&quot;</span>);
<a name="l11694"></a>11694                     nReceiptCount = (-1);
<a name="l11695"></a>11695                 }
<a name="l11696"></a>11696             }
<a name="l11697"></a>11697             <span class="keywordflow">else</span>    <span class="comment">// Success!</span>
<a name="l11698"></a>11698             {
<a name="l11699"></a>11699                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l11700"></a>11700                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID);
<a name="l11701"></a>11701                 <span class="keyword">const</span> std::string str_server(strServerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11702"></a>11702                 <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = theNym.<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l11703"></a>11703                 NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l11704"></a>11704 
<a name="l11705"></a>11705                 <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l11706"></a>11706                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l11707"></a>11707                                   str_server.c_str());
<a name="l11708"></a>11708 
<a name="l11709"></a>11709                 <span class="comment">// (2) Sign the Message</span>
<a name="l11710"></a>11710                 theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theNym);
<a name="l11711"></a>11711 
<a name="l11712"></a>11712                 <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11713"></a>11713                 theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11714"></a>11714             }
<a name="l11715"></a>11715         }
<a name="l11716"></a>11716         <span class="comment">// --------------------------------------</span>
<a name="l11717"></a>11717     }
<a name="l11718"></a>11718 
<a name="l11719"></a>11719     <span class="keywordflow">if</span> (bSuccess)
<a name="l11720"></a>11720     {
<a name="l11721"></a>11721         <span class="comment">// Instead of the receipt count, in the case of success sending, we return the</span>
<a name="l11722"></a>11722         <span class="comment">// actual request number for the message that was sent.</span>
<a name="l11723"></a>11723         <span class="comment">// (Otherwise 0 means Nymbox was empty, and -1 means there was an error.)</span>
<a name="l11724"></a>11724         <span class="comment">//</span>
<a name="l11725"></a>11725         nRequestNum = atoi(theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11726"></a>11726         
<a name="l11727"></a>11727         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11728"></a>11728         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11729"></a>11729 
<a name="l11730"></a>11730         <span class="keywordflow">return</span> nRequestNum;
<a name="l11731"></a>11731     }
<a name="l11732"></a>11732     <span class="comment">// if successful, ..., else if not successful--and wasn&#39;t empty--then error.</span>
<a name="l11733"></a>11733     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bIsEmpty)
<a name="l11734"></a>11734         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error performing processNymbox command in OT_API::processNymbox\n&quot;</span>);
<a name="l11735"></a>11735 
<a name="l11736"></a>11736     <span class="keywordflow">return</span> nReceiptCount;
<a name="l11737"></a>11737 }
<a name="l11738"></a>11738 
<a name="l11739"></a>11739 
<a name="l11740"></a>11740 
<a name="l11741"></a>11741 
<a name="l11742"></a><a class="code" href="class_o_t___a_p_i.html#a937dc63294d4d989c0f691b6f12287df">11742</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a937dc63294d4d989c0f691b6f12287df">OT_API::processInbox</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; SERVER_ID,
<a name="l11743"></a>11743                           <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; USER_ID,
<a name="l11744"></a>11744                           <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; ACCT_ID,
<a name="l11745"></a>11745                           <a class="code" href="class_o_t_string.html">OTString</a>      &amp; ACCT_LEDGER)
<a name="l11746"></a>11746 {
<a name="l11747"></a>11747     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::processInbox&quot;</span>;
<a name="l11748"></a>11748     <span class="comment">// -----------------------------------------------------</span>
<a name="l11749"></a>11749     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11750"></a>11750     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11751"></a>11751     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11752"></a>11752     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11753"></a>11753     <span class="comment">// -----------------------------------------------------</span>
<a name="l11754"></a>11754     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11755"></a>11755     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11756"></a>11756     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11757"></a>11757     <span class="comment">// -----------------------------------------------------</span>
<a name="l11758"></a>11758     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, szFuncName);
<a name="l11759"></a>11759     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l11760"></a>11760     <span class="comment">// By this point, pAccount is a good pointer.  (No need to cleanup.)</span>
<a name="l11761"></a>11761     <span class="comment">// -----------------------------------------------------</span>
<a name="l11762"></a>11762     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11763"></a>11763     int64_t lRequestNumber = 0;
<a name="l11764"></a>11764 
<a name="l11765"></a>11765     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCT_ID);
<a name="l11766"></a>11766 
<a name="l11767"></a>11767     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11768"></a>11768     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11769"></a>11769     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11770"></a>11770     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11771"></a>11771 
<a name="l11772"></a>11772     <span class="comment">// (1) set up member variables</span>
<a name="l11773"></a>11773     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;processInbox&quot;</span>;
<a name="l11774"></a>11774     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11775"></a>11775     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11776"></a>11776     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11777"></a>11777 
<a name="l11778"></a>11778     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l11779"></a>11779 
<a name="l11780"></a>11780     <span class="comment">// Presumably ACCT_LEDGER was already set up before this function was called...</span>
<a name="l11781"></a>11781     <span class="comment">// See test client for example of it being done.</span>
<a name="l11782"></a>11782     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(ACCT_LEDGER);
<a name="l11783"></a>11783 
<a name="l11784"></a>11784     <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> NYMBOX_HASH;
<a name="l11785"></a>11785     <span class="keyword">const</span> std::string str_server(strServerID.Get());
<a name="l11786"></a>11786     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNymboxHash = pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a461ac5959e5f91add57549be10d82e36">GetNymboxHash</a>(str_server, NYMBOX_HASH);
<a name="l11787"></a>11787     NYMBOX_HASH.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a3038ccc70302742da4df4c3af1093b78">m_strNymboxHash</a>);
<a name="l11788"></a>11788 
<a name="l11789"></a>11789     <span class="keywordflow">if</span> (!bNymboxHash)
<a name="l11790"></a>11790         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;Failed getting NymboxHash from Nym for server: %s\n&quot;</span>,
<a name="l11791"></a>11791                       str_server.c_str());
<a name="l11792"></a>11792 
<a name="l11793"></a>11793     <span class="comment">// (2) Sign the Message</span>
<a name="l11794"></a>11794     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11795"></a>11795 
<a name="l11796"></a>11796     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11797"></a>11797     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11798"></a>11798 
<a name="l11799"></a>11799     <span class="comment">// (Send it)</span>
<a name="l11800"></a>11800     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11801"></a>11801     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11802"></a>11802 
<a name="l11803"></a>11803     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11804"></a>11804 }
<a name="l11805"></a>11805 
<a name="l11806"></a>11806 
<a name="l11807"></a>11807 
<a name="l11808"></a><a class="code" href="class_o_t___a_p_i.html#a8ab12884841613694afed4593e780e5a">11808</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a8ab12884841613694afed4593e780e5a">OT_API::issueAssetType</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   SERVER_ID,
<a name="l11809"></a>11809                            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   USER_ID,
<a name="l11810"></a>11810                            <a class="code" href="class_o_t_string.html">OTString</a>     &amp;   THE_CONTRACT)
<a name="l11811"></a>11811 {
<a name="l11812"></a>11812     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::issueAssetType&quot;</span>;
<a name="l11813"></a>11813     <span class="comment">// -----------------------------------------------------</span>
<a name="l11814"></a>11814     <a class="code" href="class_o_t_wallet.html">OTWallet</a> * pWallet = this-&gt;<a class="code" href="class_o_t___a_p_i.html#af759173aae6f4592c3d6ef1f6a9aa4ff">GetWallet</a>(szFuncName);
<a name="l11815"></a>11815     <span class="keywordflow">if</span> (NULL == pWallet) <span class="keywordflow">return</span> (-1);
<a name="l11816"></a>11816     <span class="comment">// -----------------------------------------------------</span>
<a name="l11817"></a>11817     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11818"></a>11818     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11819"></a>11819     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11820"></a>11820     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11821"></a>11821     <span class="comment">// -----------------------------------------------------</span>
<a name="l11822"></a>11822     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11823"></a>11823     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11824"></a>11824     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11825"></a>11825     <span class="comment">// -----------------------------------------------------</span>
<a name="l11826"></a>11826 <span class="comment">//  OTLog::vError(&quot;OT_API::issueAssetType: About to trim this contract:  **BEGIN:%s***END\n\n&quot;,</span>
<a name="l11827"></a>11827 <span class="comment">//               THE_CONTRACT.Get());</span>
<a name="l11828"></a>11828 
<a name="l11829"></a>11829     std::string str_Trim(THE_CONTRACT.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l11830"></a>11830     std::string str_Trim2 = <a class="code" href="class_o_t_string.html#afe7626d0687eab81200a1af1539faed9">OTString::trim</a>(str_Trim);
<a name="l11831"></a>11831     <a class="code" href="class_o_t_string.html">OTString</a> strTrimContract(str_Trim2.c_str());
<a name="l11832"></a>11832     <span class="comment">// -----------------------------------------------------</span>
<a name="l11833"></a>11833     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> theAssetContract;
<a name="l11834"></a>11834 
<a name="l11835"></a>11835     <span class="keywordflow">if</span> (!theAssetContract.LoadContractFromString(strTrimContract))
<a name="l11836"></a>11836     {
<a name="l11837"></a>11837         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to load asset contract from string:\n\n%s\n\n&quot;</span>,
<a name="l11838"></a>11838                        szFuncName, strTrimContract.Get());
<a name="l11839"></a>11839     }
<a name="l11840"></a>11840     <span class="keywordflow">else</span>
<a name="l11841"></a>11841     {
<a name="l11842"></a>11842         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    newID;
<a name="l11843"></a>11843         theAssetContract.CalculateContractID(newID);
<a name="l11844"></a>11844         theAssetContract.SetIdentifier(newID); <span class="comment">// probably unnecessary</span>
<a name="l11845"></a>11845         <span class="comment">// -----------------------</span>
<a name="l11846"></a>11846         <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11847"></a>11847         int64_t lRequestNumber = 0;
<a name="l11848"></a>11848 
<a name="l11849"></a>11849         <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l11850"></a>11850 
<a name="l11851"></a>11851         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11852"></a>11852         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11853"></a>11853         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11854"></a>11854         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11855"></a>11855 
<a name="l11856"></a>11856         <span class="comment">// (1) set up member variables</span>
<a name="l11857"></a>11857         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;issueAssetType&quot;</span>;
<a name="l11858"></a>11858         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11859"></a>11859         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11860"></a>11860         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11861"></a>11861 
<a name="l11862"></a>11862         newID.<a class="code" href="class_o_t_identifier.html#a4bccb30446b4b515d9d6016b86b260bb">GetString</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
<a name="l11863"></a>11863         <a class="code" href="class_o_t_string.html">OTString</a> strAssetContract(theAssetContract);
<a name="l11864"></a>11864         theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(strAssetContract);
<a name="l11865"></a>11865 
<a name="l11866"></a>11866         <span class="comment">// (2) Sign the Message</span>
<a name="l11867"></a>11867         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11868"></a>11868 
<a name="l11869"></a>11869         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11870"></a>11870         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11871"></a>11871         <span class="comment">// ------------------------------------</span>
<a name="l11872"></a>11872         <span class="comment">// Save the contract to local storage and add to wallet.</span>
<a name="l11873"></a>11873         <span class="comment">//</span>
<a name="l11874"></a>11874         <a class="code" href="class_o_t_string.html">OTString</a> strFilename;   <span class="comment">// In this case the filename isn&#39;t actually used, since SaveToContractFolder will</span>
<a name="l11875"></a>11875         <span class="comment">// handle setting up the filename and overwrite it anyway. But I still prefer to set it</span>
<a name="l11876"></a>11876         <span class="comment">// up correctly, rather than pass a blank. I&#39;m just funny like that.</span>
<a name="l11877"></a>11877         strFilename = theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l11878"></a>11878 
<a name="l11879"></a>11879         <a class="code" href="class_o_t_string.html">OTString</a> strFoldername(<a class="code" href="class_o_t_folders.html#ac8ac28307d688d0defee0fd7734be027">OTFolders::Contract</a>().Get());
<a name="l11880"></a>11880 
<a name="l11881"></a>11881         <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> * pContract = <span class="keyword">new</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a>(theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>, strFoldername,
<a name="l11882"></a>11882                                                           strFilename, theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>);
<a name="l11883"></a>11883         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pContract);
<a name="l11884"></a>11884 
<a name="l11885"></a>11885         <span class="comment">// Check the server signature on the contract here. (Perhaps the message is good enough?</span>
<a name="l11886"></a>11886         <span class="comment">// After all, the message IS signed by the server and contains the Account.</span>
<a name="l11887"></a>11887 <span class="comment">//      if (pContract-&gt;LoadContract() &amp;&amp; pContract-&gt;VerifyContract())</span>
<a name="l11888"></a>11888         <span class="keywordflow">if</span> (!pContract-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strTrimContract))
<a name="l11889"></a>11889         {
<a name="l11890"></a>11890             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed(2) trying to load asset contract from string:\n\n%s\n\n&quot;</span>,
<a name="l11891"></a>11891                            szFuncName, strTrimContract.Get());
<a name="l11892"></a>11892         }
<a name="l11893"></a>11893         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pContract-&gt;<a class="code" href="class_o_t_contract.html#aa707f03da51449ef0cd1a466cbc0f13c">VerifyContract</a>())
<a name="l11894"></a>11894         {
<a name="l11895"></a>11895             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed verifying asset contract:\n\n%s\n\n&quot;</span>,
<a name="l11896"></a>11896                            szFuncName, strTrimContract.Get());
<a name="l11897"></a>11897         }
<a name="l11898"></a>11898         <span class="keywordflow">else</span>
<a name="l11899"></a>11899         {
<a name="l11900"></a>11900             <span class="comment">// Next make sure the wallet has this contract on its list...</span>
<a name="l11901"></a>11901             pWallet-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(*pContract); <span class="comment">// this saves both the contract and the wallet.</span>
<a name="l11902"></a>11902             pContract = NULL; <span class="comment">// Success. The wallet &quot;owns&quot; it now, no need to clean it up.</span>
<a name="l11903"></a>11903         }
<a name="l11904"></a>11904         <span class="comment">// ------------------------------------------------</span>
<a name="l11905"></a>11905         <span class="comment">// cleanup</span>
<a name="l11906"></a>11906         <span class="keywordflow">if</span> (pContract)
<a name="l11907"></a>11907         {
<a name="l11908"></a>11908             <span class="keyword">delete</span> pContract;
<a name="l11909"></a>11909             pContract = NULL;
<a name="l11910"></a>11910         }
<a name="l11911"></a>11911         <span class="comment">// ----------------------------</span>
<a name="l11912"></a>11912 
<a name="l11913"></a>11913         <span class="comment">// (Send it)</span>
<a name="l11914"></a>11914         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11915"></a>11915         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11916"></a>11916 
<a name="l11917"></a>11917         <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11918"></a>11918     }
<a name="l11919"></a>11919 
<a name="l11920"></a>11920     <span class="keywordflow">return</span> -1;
<a name="l11921"></a>11921 }
<a name="l11922"></a>11922 
<a name="l11923"></a>11923 
<a name="l11924"></a>11924 
<a name="l11925"></a><a class="code" href="class_o_t___a_p_i.html#a5edd49c564ada6fb519882ad7a60bd8e">11925</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a5edd49c564ada6fb519882ad7a60bd8e">OT_API::getContract</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11926"></a>11926                          <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11927"></a>11927                          <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l11928"></a>11928 {
<a name="l11929"></a>11929     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getContract&quot;</span>;
<a name="l11930"></a>11930     <span class="comment">// -----------------------------------------------------</span>
<a name="l11931"></a>11931     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11932"></a>11932     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11933"></a>11933     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11934"></a>11934     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11935"></a>11935     <span class="comment">// -----------------------------------------------------</span>
<a name="l11936"></a>11936     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11937"></a>11937     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11938"></a>11938     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11939"></a>11939     <span class="comment">// -----------------------------------------------------</span>
<a name="l11940"></a>11940     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11941"></a>11941     int64_t lRequestNumber = 0;
<a name="l11942"></a>11942 
<a name="l11943"></a>11943     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAssetTypeID(ASSET_ID);
<a name="l11944"></a>11944 
<a name="l11945"></a>11945     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l11946"></a>11946     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l11947"></a>11947     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l11948"></a>11948     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l11949"></a>11949 
<a name="l11950"></a>11950     <span class="comment">// (1) set up member variables</span>
<a name="l11951"></a>11951     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getContract&quot;</span>;
<a name="l11952"></a>11952     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l11953"></a>11953     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l11954"></a>11954     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l11955"></a>11955 
<a name="l11956"></a>11956     theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetTypeID;
<a name="l11957"></a>11957 
<a name="l11958"></a>11958     <span class="comment">// (2) Sign the Message</span>
<a name="l11959"></a>11959     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l11960"></a>11960 
<a name="l11961"></a>11961     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l11962"></a>11962     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l11963"></a>11963 
<a name="l11964"></a>11964     <span class="comment">// (Send it)</span>
<a name="l11965"></a>11965     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l11966"></a>11966     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l11967"></a>11967 
<a name="l11968"></a>11968     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l11969"></a>11969 }
<a name="l11970"></a>11970 
<a name="l11971"></a>11971 
<a name="l11972"></a>11972 
<a name="l11973"></a>11973 
<a name="l11974"></a>11974 
<a name="l11975"></a>11975 
<a name="l11976"></a><a class="code" href="class_o_t___a_p_i.html#ab8904b6f61d9c3c03acc6d5723458d86">11976</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ab8904b6f61d9c3c03acc6d5723458d86">OT_API::getMint</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l11977"></a>11977                      <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l11978"></a>11978                      <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l11979"></a>11979 {
<a name="l11980"></a>11980     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getMint&quot;</span>;
<a name="l11981"></a>11981     <span class="comment">// -----------------------------------------------------</span>
<a name="l11982"></a>11982     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l11983"></a>11983     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l11984"></a>11984     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l11985"></a>11985     <span class="comment">//  (No need to cleanup.)</span>
<a name="l11986"></a>11986     <span class="comment">// -----------------------------------------------------</span>
<a name="l11987"></a>11987     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11988"></a>11988     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l11989"></a>11989     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l11990"></a>11990     <span class="comment">// -----------------------------------------------------</span>
<a name="l11991"></a>11991     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> *   pAssetContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(ASSET_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l11992"></a>11992     <span class="keywordflow">if</span> (NULL == pAssetContract) <span class="keywordflow">return</span> (-1);
<a name="l11993"></a>11993     <span class="comment">// By this point, pAssetContract is a good pointer.  (No need to cleanup.)</span>
<a name="l11994"></a>11994     <span class="comment">// -----------------------------------------------------</span>
<a name="l11995"></a>11995     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l11996"></a>11996     int64_t lRequestNumber = 0;
<a name="l11997"></a>11997 
<a name="l11998"></a>11998     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAssetTypeID(ASSET_ID);
<a name="l11999"></a>11999 
<a name="l12000"></a>12000     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12001"></a>12001     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12002"></a>12002     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12003"></a>12003     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12004"></a>12004 
<a name="l12005"></a>12005     <span class="comment">// (1) set up member variables</span>
<a name="l12006"></a>12006     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getMint&quot;</span>;
<a name="l12007"></a>12007     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12008"></a>12008     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12009"></a>12009     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12010"></a>12010 
<a name="l12011"></a>12011     theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetTypeID;
<a name="l12012"></a>12012 
<a name="l12013"></a>12013     <span class="comment">// (2) Sign the Message</span>
<a name="l12014"></a>12014     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12015"></a>12015 
<a name="l12016"></a>12016     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12017"></a>12017     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12018"></a>12018 
<a name="l12019"></a>12019     <span class="comment">// (Send it)</span>
<a name="l12020"></a>12020     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12021"></a>12021     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12022"></a>12022 
<a name="l12023"></a>12023     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12024"></a>12024 }
<a name="l12025"></a>12025 
<a name="l12026"></a>12026 
<a name="l12027"></a>12027 
<a name="l12028"></a>12028 <span class="comment">// Sends a list of asset IDs to the server, which replies with a list of the actual receipts</span>
<a name="l12029"></a>12029 <span class="comment">// with the issuer&#39;s signature on them, from when the currency was issued.</span>
<a name="l12030"></a>12030 <span class="comment">//</span>
<a name="l12031"></a>12031 <span class="comment">// So you can tell for sure whether or not they are actually issued on that server.</span>
<a name="l12032"></a>12032 <span class="comment">//</span>
<a name="l12033"></a>12033 <span class="comment">// Map input: key is asset type ID, and value is blank (server reply puts issuer&#39;s receipts</span>
<a name="l12034"></a>12034 <span class="comment">// in that spot.)</span>
<a name="l12035"></a>12035 <span class="comment">//</span>
<a name="l12036"></a><a class="code" href="class_o_t___a_p_i.html#ab1188ffba89c5ab70a5924effb4f0477">12036</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ab1188ffba89c5ab70a5924effb4f0477">OT_API::queryAssetTypes</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12037"></a>12037                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12038"></a>12038                              <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> &amp; ENCODED_MAP)
<a name="l12039"></a>12039 {
<a name="l12040"></a>12040     <span class="comment">/*</span>
<a name="l12041"></a>12041 <span class="comment">     // Java code will create a StringMap object:</span>
<a name="l12042"></a>12042 <span class="comment"></span>
<a name="l12043"></a>12043 <span class="comment">        String strEncodedObj(&quot;&quot;); // output will go here.</span>
<a name="l12044"></a>12044 <span class="comment">        StringMap stringMap = null; // we are about to create this object</span>
<a name="l12045"></a>12045 <span class="comment"></span>
<a name="l12046"></a>12046 <span class="comment">        Storable storable = otapi.CreateObject(StoredObjectType.STORED_OBJ_STRING_MAP);</span>
<a name="l12047"></a>12047 <span class="comment"></span>
<a name="l12048"></a>12048 <span class="comment">        if (storable != null)</span>
<a name="l12049"></a>12049 <span class="comment">        {</span>
<a name="l12050"></a>12050 <span class="comment">            stringMap = StringMap.ot_dynamic_cast(storable);</span>
<a name="l12051"></a>12051 <span class="comment">            if (stringMap != null)</span>
<a name="l12052"></a>12052 <span class="comment">            {</span>
<a name="l12053"></a>12053 <span class="comment">                // ADD ALL THE ASSET IDs HERE (To the string map, so you</span>
<a name="l12054"></a>12054 <span class="comment">                // can ask the server about them...)</span>
<a name="l12055"></a>12055 <span class="comment">                //</span>
<a name="l12056"></a>12056 <span class="comment">                for_each(the asset IDs you want to query the server about)</span>
<a name="l12057"></a>12057 <span class="comment">                {</span>
<a name="l12058"></a>12058 <span class="comment">                    stringMap.SetValue(ASSET_TYPE_ID, &quot;exists&quot;);</span>
<a name="l12059"></a>12059 <span class="comment">                }</span>
<a name="l12060"></a>12060 <span class="comment"></span>
<a name="l12061"></a>12061 <span class="comment">                strEncodedObj = otapi.EncodeObject(stringMap);</span>
<a name="l12062"></a>12062 <span class="comment">            }</span>
<a name="l12063"></a>12063 <span class="comment">        }</span>
<a name="l12064"></a>12064 <span class="comment"></span>
<a name="l12065"></a>12065 <span class="comment">        if (null == strEncodedObj)</span>
<a name="l12066"></a>12066 <span class="comment">            Error;</span>
<a name="l12067"></a>12067 <span class="comment">     ----------------------------------------------------------------------</span>
<a name="l12068"></a>12068 <span class="comment"></span>
<a name="l12069"></a>12069 <span class="comment">        Then send the server message:</span>
<a name="l12070"></a>12070 <span class="comment"></span>
<a name="l12071"></a>12071 <span class="comment">     var theRequest := OTAPI_Func(ot_Msg.QUERY_ASSET_TYPES, SERVER_ID, NYM_ID, strEncodedObj);</span>
<a name="l12072"></a>12072 <span class="comment">     var    strResponse = theRequest.SendRequest(theRequest, &quot;QUERY_ASSET_TYPES&quot;);</span>
<a name="l12073"></a>12073 <span class="comment"></span>
<a name="l12074"></a>12074 <span class="comment">     String strReplyMap = null;</span>
<a name="l12075"></a>12075 <span class="comment"></span>
<a name="l12076"></a>12076 <span class="comment">     // When the server reply comes back, get the payload from it:</span>
<a name="l12077"></a>12077 <span class="comment">     //</span>
<a name="l12078"></a>12078 <span class="comment">     if (strResponse != null)</span>
<a name="l12079"></a>12079 <span class="comment">        strReplyMap = OT_API_Message_GetPayload(strReply);</span>
<a name="l12080"></a>12080 <span class="comment">     ----------------------------------------------------------------------</span>
<a name="l12081"></a>12081 <span class="comment"></span>
<a name="l12082"></a>12082 <span class="comment">        //  Pass the payload (the StringMap from the server&#39;s reply) to otapi.DecodeObject:</span>
<a name="l12083"></a>12083 <span class="comment">        //</span>
<a name="l12084"></a>12084 <span class="comment">        if (strReplyMap != null)</span>
<a name="l12085"></a>12085 <span class="comment">        {</span>
<a name="l12086"></a>12086 <span class="comment">            StringMap stringMap = null;</span>
<a name="l12087"></a>12087 <span class="comment">            Storable storable = otapi.DecodeObject(StoredObjectType.STORED_OBJ_STRING_MAP, strReplyMap);</span>
<a name="l12088"></a>12088 <span class="comment">            if (storable != null)</span>
<a name="l12089"></a>12089 <span class="comment">            {</span>
<a name="l12090"></a>12090 <span class="comment">                stringMap = StringMap.ot_dynamic_cast(storable);</span>
<a name="l12091"></a>12091 <span class="comment">                if (stringMap != null)</span>
<a name="l12092"></a>12092 <span class="comment">                {</span>
<a name="l12093"></a>12093 <span class="comment">                    // Loop through string map. For each asset ID key, the value will</span>
<a name="l12094"></a>12094 <span class="comment">                    // say either &quot;true&quot; or &quot;false&quot;.</span>
<a name="l12095"></a>12095 <span class="comment">                    //</span>
<a name="l12096"></a>12096 <span class="comment">                    for_each(stringMap)</span>
<a name="l12097"></a>12097 <span class="comment">                    {</span>
<a name="l12098"></a>12098 <span class="comment">                        strValue = stringMap.GetValue(ASSET_TYPE_ID);</span>
<a name="l12099"></a>12099 <span class="comment"></span>
<a name="l12100"></a>12100 <span class="comment">                        if (strValue.compare(&quot;true&quot;) == 0)</span>
<a name="l12101"></a>12101 <span class="comment">                        {</span>
<a name="l12102"></a>12102 <span class="comment">                            // ... do something here ...</span>
<a name="l12103"></a>12103 <span class="comment">                        }</span>
<a name="l12104"></a>12104 <span class="comment">                    }</span>
<a name="l12105"></a>12105 <span class="comment">                }</span>
<a name="l12106"></a>12106 <span class="comment">            }</span>
<a name="l12107"></a>12107 <span class="comment">        }</span>
<a name="l12108"></a>12108 <span class="comment"></span>
<a name="l12109"></a>12109 <span class="comment">     */</span>
<a name="l12110"></a>12110     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::queryAssetTypes&quot;</span>;
<a name="l12111"></a>12111     <span class="comment">// -----------------------------------------------------</span>
<a name="l12112"></a>12112     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l12113"></a>12113     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12114"></a>12114     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12115"></a>12115     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12116"></a>12116     <span class="comment">// -----------------------------------------------------</span>
<a name="l12117"></a>12117     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12118"></a>12118     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12119"></a>12119     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12120"></a>12120     <span class="comment">// -----------------------------------------------------</span>
<a name="l12121"></a>12121     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12122"></a>12122     int64_t lRequestNumber = 0;
<a name="l12123"></a>12123 
<a name="l12124"></a>12124     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID);
<a name="l12125"></a>12125 
<a name="l12126"></a>12126     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12127"></a>12127     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12128"></a>12128     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12129"></a>12129     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12130"></a>12130 
<a name="l12131"></a>12131     <span class="comment">// (1) set up member variables</span>
<a name="l12132"></a>12132     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;queryAssetTypes&quot;</span>;
<a name="l12133"></a>12133     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12134"></a>12134     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12135"></a>12135     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12136"></a>12136 
<a name="l12137"></a>12137     theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>         = ENCODED_MAP;
<a name="l12138"></a>12138 
<a name="l12139"></a>12139     <span class="comment">// (2) Sign the Message</span>
<a name="l12140"></a>12140     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12141"></a>12141 
<a name="l12142"></a>12142     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12143"></a>12143     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12144"></a>12144 
<a name="l12145"></a>12145     <span class="comment">// (Send it)</span>
<a name="l12146"></a>12146     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12147"></a>12147     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12148"></a>12148 
<a name="l12149"></a>12149     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12150"></a>12150 }
<a name="l12151"></a>12151 
<a name="l12152"></a>12152 
<a name="l12153"></a>12153 
<a name="l12154"></a><a class="code" href="class_o_t___a_p_i.html#a911f4791ccc4619dc5149e571d676867">12154</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a911f4791ccc4619dc5149e571d676867">OT_API::createAssetAccount</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12155"></a>12155                                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12156"></a>12156                                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ASSET_ID)
<a name="l12157"></a>12157 {
<a name="l12158"></a>12158     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::createAssetAccount&quot;</span>;
<a name="l12159"></a>12159     <span class="comment">// -----------------------------------------------------</span>
<a name="l12160"></a>12160     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l12161"></a>12161     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12162"></a>12162     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12163"></a>12163     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12164"></a>12164     <span class="comment">// -----------------------------------------------------</span>
<a name="l12165"></a>12165     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12166"></a>12166     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12167"></a>12167     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12168"></a>12168     <span class="comment">// -----------------------------------------------------</span>
<a name="l12169"></a>12169     <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> *   pAssetContract = this-&gt;<a class="code" href="class_o_t___a_p_i.html#a291b0f7c5298ceecc8d4aa929146d4db">GetAssetType</a>(ASSET_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12170"></a>12170     <span class="keywordflow">if</span> (NULL == pAssetContract) <span class="keywordflow">return</span> (-1);
<a name="l12171"></a>12171     <span class="comment">// By this point, pAssetContract is a good pointer.  (No need to cleanup.)</span>
<a name="l12172"></a>12172     <span class="comment">// -----------------------------------------------------</span>
<a name="l12173"></a>12173     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12174"></a>12174     int64_t lRequestNumber = 0;
<a name="l12175"></a>12175 
<a name="l12176"></a>12176     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAssetTypeID(ASSET_ID);
<a name="l12177"></a>12177 
<a name="l12178"></a>12178     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12179"></a>12179     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12180"></a>12180     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12181"></a>12181     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12182"></a>12182 
<a name="l12183"></a>12183     <span class="comment">// (1) set up member variables</span>
<a name="l12184"></a>12184     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;createAccount&quot;</span>;
<a name="l12185"></a>12185     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12186"></a>12186     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12187"></a>12187     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12188"></a>12188 
<a name="l12189"></a>12189     theMessage.<a class="code" href="class_o_t_message.html#a7cbf8c19d4be37bc2f67a8b8df7e701f">m_strAssetID</a>         = strAssetTypeID;
<a name="l12190"></a>12190 
<a name="l12191"></a>12191     <span class="comment">// (2) Sign the Message</span>
<a name="l12192"></a>12192     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12193"></a>12193 
<a name="l12194"></a>12194     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12195"></a>12195     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12196"></a>12196 
<a name="l12197"></a>12197     <span class="comment">// (Send it)</span>
<a name="l12198"></a>12198     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12199"></a>12199     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12200"></a>12200 
<a name="l12201"></a>12201     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12202"></a>12202 }
<a name="l12203"></a>12203 
<a name="l12204"></a>12204 
<a name="l12205"></a>12205 
<a name="l12206"></a><a class="code" href="class_o_t___a_p_i.html#a75dfa596de3c054af8a9ffb9c51748b0">12206</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a75dfa596de3c054af8a9ffb9c51748b0">OT_API::deleteAssetAccount</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12207"></a>12207                                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12208"></a>12208                                 <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID)
<a name="l12209"></a>12209 {
<a name="l12210"></a>12210     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::deleteAssetAccount&quot;</span>;
<a name="l12211"></a>12211     <span class="comment">// -----------------------------------------------------</span>
<a name="l12212"></a>12212     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l12213"></a>12213     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12214"></a>12214     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12215"></a>12215     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12216"></a>12216     <span class="comment">// -----------------------------------------------------</span>
<a name="l12217"></a>12217     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12218"></a>12218     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12219"></a>12219     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12220"></a>12220     <span class="comment">// -----------------------------------------------------</span>
<a name="l12221"></a>12221     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCOUNT_ID, SERVER_ID, szFuncName);
<a name="l12222"></a>12222     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l12223"></a>12223     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l12224"></a>12224     <span class="comment">// -----------------------------------------------------</span>
<a name="l12225"></a>12225     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12226"></a>12226     int64_t lRequestNumber = 0;
<a name="l12227"></a>12227 
<a name="l12228"></a>12228     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l12229"></a>12229 
<a name="l12230"></a>12230     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12231"></a>12231     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12232"></a>12232     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12233"></a>12233     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12234"></a>12234 
<a name="l12235"></a>12235     <span class="comment">// (1) set up member variables</span>
<a name="l12236"></a>12236     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;deleteAssetAccount&quot;</span>;
<a name="l12237"></a>12237     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12238"></a>12238     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12239"></a>12239     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12240"></a>12240 
<a name="l12241"></a>12241     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l12242"></a>12242 
<a name="l12243"></a>12243     <span class="comment">// (2) Sign the Message</span>
<a name="l12244"></a>12244     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12245"></a>12245 
<a name="l12246"></a>12246     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12247"></a>12247     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12248"></a>12248 
<a name="l12249"></a>12249     <span class="comment">// (Send it)</span>
<a name="l12250"></a>12250     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12251"></a>12251     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12252"></a>12252 
<a name="l12253"></a>12253     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12254"></a>12254 }
<a name="l12255"></a>12255 
<a name="l12256"></a>12256 
<a name="l12257"></a>12257 
<a name="l12258"></a>12258 
<a name="l12259"></a>12259 
<a name="l12260"></a>12260 
<a name="l12261"></a><a class="code" href="class_o_t___a_p_i.html#acbc0834e9b4c4f995114e62436e54fea">12261</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t___a_p_i.html#acbc0834e9b4c4f995114e62436e54fea">OT_API::DoesBoxReceiptExist</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12262"></a>12262                                  <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,  <span class="comment">// Unused here for now, but still convention.</span>
<a name="l12263"></a>12263                                  <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID,   <span class="comment">// If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l12264"></a>12264                                  <span class="keyword">const</span> int32_t          nBoxType,   <span class="comment">// 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l12265"></a>12265                                  <span class="keyword">const</span> int64_t        &amp; lTransactionNum)
<a name="l12266"></a>12266 {
<a name="l12267"></a>12267             <span class="comment">//static</span>
<a name="l12268"></a>12268     <span class="keywordflow">return</span>  <a class="code" href="class_o_t_transaction.html#acf756f8e3b1d1b9f1e9d2bcb48cbe927">OTTransaction::VerifyBoxReceiptExists</a>(SERVER_ID,
<a name="l12269"></a>12269                                                   USER_ID,      <span class="comment">// Unused here for now, but still convention.</span>
<a name="l12270"></a>12270                                                   ACCOUNT_ID,   <span class="comment">// If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l12271"></a>12271                                                   nBoxType,     <span class="comment">// 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l12272"></a>12272                                                   lTransactionNum);
<a name="l12273"></a>12273 }
<a name="l12274"></a>12274 
<a name="l12275"></a>12275 
<a name="l12276"></a>12276 
<a name="l12277"></a>12277 
<a name="l12278"></a><a class="code" href="class_o_t___a_p_i.html#a0cec1627c8efa1c18cdace3894a916e1">12278</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a0cec1627c8efa1c18cdace3894a916e1">OT_API::getBoxReceipt</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12279"></a>12279                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12280"></a>12280                            <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; ACCOUNT_ID,     <span class="comment">// If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l12281"></a>12281                            <span class="keyword">const</span> int32_t            nBoxType,       <span class="comment">// 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l12282"></a>12282                            <span class="keyword">const</span> int64_t          &amp; lTransactionNum)
<a name="l12283"></a>12283 {
<a name="l12284"></a>12284     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getBoxReceipt&quot;</span>;
<a name="l12285"></a>12285     <span class="comment">// -----------------------------------------------------</span>
<a name="l12286"></a>12286     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName);
<a name="l12287"></a>12287     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12288"></a>12288     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12289"></a>12289     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12290"></a>12290     <span class="comment">// -----------------------------------------------------</span>
<a name="l12291"></a>12291     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12292"></a>12292     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12293"></a>12293     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12294"></a>12294     <span class="comment">// -----------------------------------------------------</span>
<a name="l12295"></a>12295     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = NULL;
<a name="l12296"></a>12296     <span class="keywordflow">if</span> (USER_ID != ACCOUNT_ID) <span class="comment">// inbox/outbox (if it were nymbox, the USER_ID and ACCOUNT_ID would match)</span>
<a name="l12297"></a>12297     {
<a name="l12298"></a>12298         pAccount =  this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCOUNT_ID, SERVER_ID, szFuncName);
<a name="l12299"></a>12299         <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l12300"></a>12300     }
<a name="l12301"></a>12301     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l12302"></a>12302     <span class="comment">// Note: pAccount could be NULL also, but this function doesn&#39;t actually use it anyway.</span>
<a name="l12303"></a>12303     <span class="comment">// I just force it to load in order to keep things clean, since this is an API call. (I&#39;m</span>
<a name="l12304"></a>12304     <span class="comment">// real strict on the API user, making him keep his nose clean.)</span>
<a name="l12305"></a>12305     <span class="comment">// -----------------------------------------------------</span>
<a name="l12306"></a>12306     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12307"></a>12307     int64_t lRequestNumber = 0;
<a name="l12308"></a>12308 
<a name="l12309"></a>12309     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCOUNT_ID);
<a name="l12310"></a>12310 
<a name="l12311"></a>12311     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12312"></a>12312     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12313"></a>12313     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12314"></a>12314     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12315"></a>12315 
<a name="l12316"></a>12316     <span class="comment">// (1) set up member variables</span>
<a name="l12317"></a>12317     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getBoxReceipt&quot;</span>;
<a name="l12318"></a>12318     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12319"></a>12319     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12320"></a>12320     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12321"></a>12321 
<a name="l12322"></a>12322     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l12323"></a>12323     theMessage.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>             = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(nBoxType);
<a name="l12324"></a>12324     theMessage.<a class="code" href="class_o_t_message.html#a2374c052c03bf1d4c7e7dd7555197ba4">m_lTransactionNum</a>    = lTransactionNum;
<a name="l12325"></a>12325 
<a name="l12326"></a>12326     <span class="comment">// (2) Sign the Message</span>
<a name="l12327"></a>12327     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12328"></a>12328 
<a name="l12329"></a>12329     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12330"></a>12330     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12331"></a>12331 
<a name="l12332"></a>12332     <span class="comment">// (Send it)</span>
<a name="l12333"></a>12333     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12334"></a>12334     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12335"></a>12335 
<a name="l12336"></a>12336     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12337"></a>12337 }
<a name="l12338"></a>12338 
<a name="l12339"></a>12339 
<a name="l12340"></a>12340 
<a name="l12341"></a>12341 
<a name="l12342"></a>12342 <span class="comment">// NOTE: Deprecated. Replaced by getAccountFiles.</span>
<a name="l12343"></a><a class="code" href="class_o_t___a_p_i.html#a8d2a98f3ec41510173e91d2acb34b520">12343</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a8d2a98f3ec41510173e91d2acb34b520">OT_API::getAccount</a>( <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l12344"></a>12344                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; USER_ID,
<a name="l12345"></a>12345                         <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ACCT_ID)
<a name="l12346"></a>12346 {
<a name="l12347"></a>12347     <span class="comment">// -----------------------------------------------------</span>
<a name="l12348"></a>12348     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12349"></a>12349     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12350"></a>12350     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12351"></a>12351     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12352"></a>12352     <span class="comment">// -----------------------------------------------------</span>
<a name="l12353"></a>12353     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12354"></a>12354     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12355"></a>12355     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12356"></a>12356     <span class="comment">// -----------------------------------------------------</span>
<a name="l12357"></a>12357     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l12358"></a>12358     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l12359"></a>12359     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l12360"></a>12360     <span class="comment">// -----------------------------------------------------</span>
<a name="l12361"></a>12361     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12362"></a>12362     int64_t lRequestNumber = 0;
<a name="l12363"></a>12363 
<a name="l12364"></a>12364     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCT_ID);
<a name="l12365"></a>12365 
<a name="l12366"></a>12366     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12367"></a>12367     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12368"></a>12368     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12369"></a>12369     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12370"></a>12370 
<a name="l12371"></a>12371     <span class="comment">// (1) set up member variables</span>
<a name="l12372"></a>12372     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getAccount&quot;</span>;
<a name="l12373"></a>12373     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12374"></a>12374     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12375"></a>12375     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12376"></a>12376 
<a name="l12377"></a>12377     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l12378"></a>12378 
<a name="l12379"></a>12379     <span class="comment">// (2) Sign the Message</span>
<a name="l12380"></a>12380     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12381"></a>12381 
<a name="l12382"></a>12382     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12383"></a>12383     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12384"></a>12384 
<a name="l12385"></a>12385     <span class="comment">// (Send it)</span>
<a name="l12386"></a>12386     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12387"></a>12387     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12388"></a>12388 
<a name="l12389"></a>12389     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12390"></a>12390 }
<a name="l12391"></a>12391 
<a name="l12392"></a>12392 
<a name="l12393"></a>12393 
<a name="l12394"></a><a class="code" href="class_o_t___a_p_i.html#a2df75f7a37f281e3bacfce2c0fa49a3e">12394</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a2df75f7a37f281e3bacfce2c0fa49a3e">OT_API::getAccountFiles</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l12395"></a>12395                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; USER_ID,
<a name="l12396"></a>12396                             <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; ACCT_ID)
<a name="l12397"></a>12397 {
<a name="l12398"></a>12398     <span class="comment">// -----------------------------------------------------</span>
<a name="l12399"></a>12399     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12400"></a>12400     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12401"></a>12401     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12402"></a>12402     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12403"></a>12403     <span class="comment">// -----------------------------------------------------</span>
<a name="l12404"></a>12404     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12405"></a>12405     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12406"></a>12406     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12407"></a>12407     <span class="comment">// -----------------------------------------------------</span>
<a name="l12408"></a>12408     <a class="code" href="class_o_t_account.html">OTAccount</a> * pAccount = this-&gt;<a class="code" href="class_o_t___a_p_i.html#ad125eb5eb9193091ac98cc9aee179e77">GetOrLoadAccount</a>(*pNym, ACCT_ID, SERVER_ID, __FUNCTION__);
<a name="l12409"></a>12409     <span class="keywordflow">if</span> (NULL == pAccount) <span class="keywordflow">return</span> (-1);
<a name="l12410"></a>12410     <span class="comment">// By this point, pAccount is a good pointer, and is on the wallet. (No need to cleanup.)</span>
<a name="l12411"></a>12411     <span class="comment">// -----------------------------------------------------</span>
<a name="l12412"></a>12412     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12413"></a>12413     int64_t lRequestNumber = 0;
<a name="l12414"></a>12414 
<a name="l12415"></a>12415     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strAcctID(ACCT_ID);
<a name="l12416"></a>12416 
<a name="l12417"></a>12417     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12418"></a>12418     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12419"></a>12419     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12420"></a>12420     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12421"></a>12421 
<a name="l12422"></a>12422     <span class="comment">// (1) set up member variables</span>
<a name="l12423"></a>12423     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;getAccountFiles&quot;</span>;
<a name="l12424"></a>12424     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12425"></a>12425     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12426"></a>12426     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12427"></a>12427 
<a name="l12428"></a>12428     theMessage.<a class="code" href="class_o_t_message.html#aeba5afa7ce73d9398cc898a2749acd45">m_strAcctID</a>          = strAcctID;
<a name="l12429"></a>12429 
<a name="l12430"></a>12430     <span class="comment">// (2) Sign the Message</span>
<a name="l12431"></a>12431     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12432"></a>12432 
<a name="l12433"></a>12433     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12434"></a>12434     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12435"></a>12435 
<a name="l12436"></a>12436     <span class="comment">// (Send it)</span>
<a name="l12437"></a>12437     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12438"></a>12438     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12439"></a>12439 
<a name="l12440"></a>12440     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12441"></a>12441 }
<a name="l12442"></a>12442 
<a name="l12443"></a>12443 
<a name="l12444"></a>12444 
<a name="l12445"></a>12445 
<a name="l12446"></a><a class="code" href="class_o_t___a_p_i.html#a1dfa9ba3149336b36e68662e86265b6e">12446</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a1dfa9ba3149336b36e68662e86265b6e">OT_API::getRequest</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12447"></a>12447                        <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l12448"></a>12448 {
<a name="l12449"></a>12449     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::getRequest&quot;</span>;
<a name="l12450"></a>12450     <span class="comment">// -----------------------------------------------------</span>
<a name="l12451"></a>12451     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12452"></a>12452     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12453"></a>12453     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12454"></a>12454     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12455"></a>12455     <span class="comment">// -----------------------------------------------------</span>
<a name="l12456"></a>12456     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12457"></a>12457     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12458"></a>12458     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12459"></a>12459     <span class="comment">// -----------------------------------------------------</span>
<a name="l12460"></a>12460     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12461"></a>12461 
<a name="l12462"></a>12462     int32_t nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7ad2b66c0cf1b0a4bc0d12ae557679c004">OTClient::getRequest</a>, theMessage,
<a name="l12463"></a>12463                                                      *pNym, *pServer,
<a name="l12464"></a>12464                                                      NULL); <span class="comment">// NULL pAccount on this command.</span>
<a name="l12465"></a>12465     <span class="keywordflow">if</span> (0 &lt; nReturnValue) 
<a name="l12466"></a>12466     {               
<a name="l12467"></a>12467         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12468"></a>12468         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12469"></a>12469 
<a name="l12470"></a>12470         <span class="keywordflow">return</span> nReturnValue;
<a name="l12471"></a>12471     }
<a name="l12472"></a>12472     <span class="keywordflow">else</span>
<a name="l12473"></a>12473         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error processing getRequest command in OT_API::getRequest\n&quot;</span>);
<a name="l12474"></a>12474 
<a name="l12475"></a>12475     <span class="keywordflow">return</span> (-1);
<a name="l12476"></a>12476 }
<a name="l12477"></a>12477 
<a name="l12478"></a>12478 
<a name="l12479"></a>12479 
<a name="l12480"></a>12480 
<a name="l12481"></a>12481 
<a name="l12482"></a>12482 
<a name="l12483"></a><a class="code" href="class_o_t___a_p_i.html#aae87777314e8bcd258a117082559b024">12483</a> int32_t <a class="code" href="class_o_t___a_p_i.html#aae87777314e8bcd258a117082559b024">OT_API::usageCredits</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;   SERVER_ID,
<a name="l12484"></a>12484                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;  USER_ID,
<a name="l12485"></a>12485                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp;  USER_ID_CHECK,
<a name="l12486"></a>12486                           <span class="keyword">const</span> int64_t         lAdjustment<span class="comment">/*=0*/</span>)
<a name="l12487"></a>12487 {
<a name="l12488"></a>12488     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::usageCredits&quot;</span>;
<a name="l12489"></a>12489     <span class="comment">// -----------------------------------------------------</span>
<a name="l12490"></a>12490     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12491"></a>12491     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12492"></a>12492     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12493"></a>12493     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12494"></a>12494     <span class="comment">// -----------------------------------------------------</span>
<a name="l12495"></a>12495     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12496"></a>12496     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12497"></a>12497     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12498"></a>12498     <span class="comment">// -----------------------------------------------------</span>
<a name="l12499"></a>12499     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12500"></a>12500     int64_t lRequestNumber = 0;
<a name="l12501"></a>12501 
<a name="l12502"></a>12502     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strNymID2(USER_ID_CHECK);
<a name="l12503"></a>12503 
<a name="l12504"></a>12504     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12505"></a>12505     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12506"></a>12506     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12507"></a>12507     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12508"></a>12508 
<a name="l12509"></a>12509     <span class="comment">// (1) set up member variables</span>
<a name="l12510"></a>12510     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;usageCredits&quot;</span>;
<a name="l12511"></a>12511     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12512"></a>12512     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l12513"></a>12513     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12514"></a>12514     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12515"></a>12515 
<a name="l12516"></a>12516     theMessage.<a class="code" href="class_o_t_message.html#a04ef2907cff33f832b438c93f17880b7">m_lDepth</a>             = lAdjustment; <span class="comment">// Default is &quot;no adjustment&quot; (@usageCredits returns current balance regardless.)</span>
<a name="l12517"></a>12517 
<a name="l12518"></a>12518     <span class="comment">// (2) Sign the Message</span>
<a name="l12519"></a>12519     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12520"></a>12520 
<a name="l12521"></a>12521     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12522"></a>12522     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12523"></a>12523 
<a name="l12524"></a>12524     <span class="comment">// (Send it)</span>
<a name="l12525"></a>12525     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12526"></a>12526     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12527"></a>12527 
<a name="l12528"></a>12528     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12529"></a>12529 }
<a name="l12530"></a>12530 
<a name="l12531"></a>12531 
<a name="l12532"></a>12532 
<a name="l12533"></a><a class="code" href="class_o_t___a_p_i.html#a3c15352c5e6e6297252cc4d41dc66188">12533</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a3c15352c5e6e6297252cc4d41dc66188">OT_API::checkUser</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12534"></a>12534                       <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12535"></a>12535                       <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID_CHECK)
<a name="l12536"></a>12536 {
<a name="l12537"></a>12537     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12538"></a>12538     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12539"></a>12539     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12540"></a>12540     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12541"></a>12541     <span class="comment">// -----------------------------------------------------</span>
<a name="l12542"></a>12542     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12543"></a>12543     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12544"></a>12544     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12545"></a>12545     <span class="comment">// -----------------------------------------------------</span>
<a name="l12546"></a>12546     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12547"></a>12547     int64_t lRequestNumber = 0;
<a name="l12548"></a>12548 
<a name="l12549"></a>12549     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strNymID2(USER_ID_CHECK);
<a name="l12550"></a>12550 
<a name="l12551"></a>12551     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12552"></a>12552     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12553"></a>12553     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12554"></a>12554     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12555"></a>12555 
<a name="l12556"></a>12556     <span class="comment">// (1) set up member variables</span>
<a name="l12557"></a>12557     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;checkUser&quot;</span>;
<a name="l12558"></a>12558     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12559"></a>12559     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l12560"></a>12560     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12561"></a>12561     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12562"></a>12562 
<a name="l12563"></a>12563     <span class="comment">// (2) Sign the Message</span>
<a name="l12564"></a>12564     theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12565"></a>12565 
<a name="l12566"></a>12566     <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12567"></a>12567     theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12568"></a>12568 
<a name="l12569"></a>12569     <span class="comment">// (Send it)</span>
<a name="l12570"></a>12570     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12571"></a>12571     <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12572"></a>12572 
<a name="l12573"></a>12573     <span class="keywordflow">return</span> <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12574"></a>12574 }
<a name="l12575"></a>12575 
<a name="l12576"></a>12576 
<a name="l12577"></a>12577 
<a name="l12578"></a><a class="code" href="class_o_t___a_p_i.html#ab168fb55e1ce59b07f251517d6768076">12578</a> int32_t <a class="code" href="class_o_t___a_p_i.html#ab168fb55e1ce59b07f251517d6768076">OT_API::sendUserMessage</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>    &amp; SERVER_ID,
<a name="l12579"></a>12579                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID,
<a name="l12580"></a>12580                              <a class="code" href="class_o_t_identifier.html">OTIdentifier</a>   &amp; USER_ID_RECIPIENT,
<a name="l12581"></a>12581                              <a class="code" href="class_o_t_string.html">OTString</a>       &amp; RECIPIENT_PUBKEY, <span class="comment">// unescaped and bookended.</span>
<a name="l12582"></a>12582                              <a class="code" href="class_o_t_string.html">OTString</a>       &amp; THE_MESSAGE)
<a name="l12583"></a>12583 {
<a name="l12584"></a>12584     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::sendUserMessage&quot;</span>;
<a name="l12585"></a>12585     <span class="comment">// -----------------------------------------------------</span>
<a name="l12586"></a>12586     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12587"></a>12587     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12588"></a>12588     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12589"></a>12589     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12590"></a>12590     <span class="comment">// -----------------------------------------------------</span>
<a name="l12591"></a>12591     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12592"></a>12592     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12593"></a>12593     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12594"></a>12594     <span class="comment">// -----------------------------------------------------</span>
<a name="l12595"></a>12595     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12596"></a>12596     int64_t lRequestNumber = 0;
<a name="l12597"></a>12597 
<a name="l12598"></a>12598     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strNymID2(USER_ID_RECIPIENT);
<a name="l12599"></a>12599 
<a name="l12600"></a>12600     <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12601"></a>12601     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12602"></a>12602     theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12603"></a>12603     pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12604"></a>12604 
<a name="l12605"></a>12605     <span class="comment">// (1) set up member variables</span>
<a name="l12606"></a>12606     theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;sendUserMessage&quot;</span>;
<a name="l12607"></a>12607     theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12608"></a>12608     theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l12609"></a>12609     theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12610"></a>12610     theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12611"></a>12611 
<a name="l12612"></a>12612     <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
<a name="l12613"></a>12613     <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pPubkey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
<a name="l12614"></a>12614     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPubkey);
<a name="l12615"></a>12615     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theKeyAngel(pPubkey);
<a name="l12616"></a>12616 
<a name="l12617"></a>12617     int32_t nReturnValue = -1;
<a name="l12618"></a>12618 
<a name="l12619"></a>12619     <span class="keywordflow">if</span> (!pPubkey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(RECIPIENT_PUBKEY))
<a name="l12620"></a>12620     {
<a name="l12621"></a>12621         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::sendUserMessage: Failed setting public key.\n&quot;</span>);
<a name="l12622"></a>12622     }
<a name="l12623"></a>12623     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (THE_MESSAGE.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
<a name="l12624"></a>12624              theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pPubkey, THE_MESSAGE) &amp;&amp;
<a name="l12625"></a>12625              theEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>))
<a name="l12626"></a>12626     {
<a name="l12627"></a>12627         <span class="comment">// (2) Sign the Message</span>
<a name="l12628"></a>12628         theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12629"></a>12629 
<a name="l12630"></a>12630         <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12631"></a>12631         theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12632"></a>12632 
<a name="l12633"></a>12633         <span class="comment">// (Send it)</span>
<a name="l12634"></a>12634         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12635"></a>12635         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12636"></a>12636 
<a name="l12637"></a>12637         <span class="comment">// ----------------------------------------------</span>
<a name="l12638"></a>12638         <span class="comment">// store a copy in the outmail.</span>
<a name="l12639"></a>12639         <span class="comment">// (not encrypted, since the Nymfile will be encrypted anyway.</span>
<a name="l12640"></a>12640         <span class="comment">//</span>
<a name="l12641"></a>12641         <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l12642"></a>12642 
<a name="l12643"></a>12643         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l12644"></a>12644 
<a name="l12645"></a>12645         pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outmailMessage&quot;</span>;
<a name="l12646"></a>12646         pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l12647"></a>12647         pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
<a name="l12648"></a>12648         pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l12649"></a>12649         pMessage-&gt;<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber);
<a name="l12650"></a>12650 
<a name="l12651"></a>12651         pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(THE_MESSAGE);
<a name="l12652"></a>12652 
<a name="l12653"></a>12653         pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12654"></a>12654         pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12655"></a>12655 
<a name="l12656"></a>12656         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a908900d7fa217571e2dd3a6c06789a9b">AddOutmail</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outmail&quot;.</span>
<a name="l12657"></a>12657         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l12658"></a>12658         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym); <span class="comment">// commented out temp for testing.</span>
<a name="l12659"></a>12659 
<a name="l12660"></a>12660         nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12661"></a>12661     }
<a name="l12662"></a>12662     <span class="keywordflow">else</span>
<a name="l12663"></a>12663         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OT_API::sendUserMessage: Failed sealing envelope.\n&quot;</span>);
<a name="l12664"></a>12664 
<a name="l12665"></a>12665     <span class="keywordflow">return</span> nReturnValue;
<a name="l12666"></a>12666 }
<a name="l12667"></a>12667 
<a name="l12668"></a>12668 
<a name="l12669"></a>12669 
<a name="l12670"></a>12670 
<a name="l12671"></a>12671 <span class="comment">// UPDATE: Sometimes you want to send something to yourself, meaning just put a copy in your</span>
<a name="l12672"></a>12672 <span class="comment">// outpayments box, without sending anything to anyone. (Specifically, after a withdrawVoucher</span>
<a name="l12673"></a>12673 <span class="comment">// is performed, you want to save a copy in your outbox since the transaction number on it is</span>
<a name="l12674"></a>12674 <span class="comment">// signed out to you.) So I&#39;m updating this function so that if USER_ID and USER_ID_RECIPIENT</span>
<a name="l12675"></a>12675 <span class="comment">// are the same, it puts a copy in your outpayment box, without sending anything at all.</span>
<a name="l12676"></a>12676 <span class="comment">//</span>
<a name="l12677"></a><a class="code" href="class_o_t___a_p_i.html#a579f8299c5c8df16a7d30e2226663d84">12677</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a579f8299c5c8df16a7d30e2226663d84">OT_API::sendUserInstrument</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; SERVER_ID,
<a name="l12678"></a>12678                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID,
<a name="l12679"></a>12679                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID_RECIPIENT,
<a name="l12680"></a>12680                                <a class="code" href="class_o_t_string.html">OTString</a>     &amp; RECIPIENT_PUBKEY,
<a name="l12681"></a>12681                                <a class="code" href="class_o_t_payment.html">OTPayment</a>    &amp; THE_INSTRUMENT,
<a name="l12682"></a>12682                                <a class="code" href="class_o_t_payment.html">OTPayment</a>    * pINSTRUMENT_FOR_SENDER<span class="comment">/*=NULL*/</span>) <span class="comment">// This is only used for cash purses. It&#39;s a copy of the purse in THE_INSTRUMENT, except all the tokens are already encrypted to the sender&#39;s public key, instead of the recipient&#39;s public key (as THE_INSTRUMENT is.) This is what we put in the sender&#39;s outpayments, so he can retrieve those tokens if he needs to.</span>
<a name="l12683"></a>12683 {
<a name="l12684"></a>12684     <span class="comment">// -----------------------------------------------------</span>
<a name="l12685"></a>12685     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12686"></a>12686     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12687"></a>12687     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12688"></a>12688     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12689"></a>12689     <span class="comment">// -----------------------------------------------------</span>
<a name="l12690"></a>12690     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, __FUNCTION__); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12691"></a>12691     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12692"></a>12692     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12693"></a>12693     <span class="comment">// -----------------------------------------------------</span>
<a name="l12694"></a>12694     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12695"></a>12695     int32_t  nReturnValue   = -1;
<a name="l12696"></a>12696     int64_t lRequestNumber = 0;
<a name="l12697"></a>12697 
<a name="l12698"></a>12698     <a class="code" href="class_o_t_string.html">OTString</a> strServerID(SERVER_ID), strNymID(USER_ID), strNymID2(USER_ID_RECIPIENT);
<a name="l12699"></a>12699     <span class="comment">// -----------------------------------</span>
<a name="l12700"></a>12700     <a class="code" href="class_o_t_string.html">OTString</a> strInstrument,
<a name="l12701"></a>12701              strInstrumentForSender;
<a name="l12702"></a>12702     <span class="comment">// -----------------------------------</span>
<a name="l12703"></a>12703     <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotPaymentContents = THE_INSTRUMENT.<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strInstrument);
<a name="l12704"></a>12704     <span class="keyword">const</span> <span class="keywordtype">bool</span> bGotSenderPmntCnts  = (NULL == pINSTRUMENT_FOR_SENDER) ? <span class="keyword">false</span> :
<a name="l12705"></a>12705                                      pINSTRUMENT_FOR_SENDER-&gt;<a class="code" href="class_o_t_payment.html#a1d067b54e63054b1021ef5f187911fab">GetPaymentContents</a>(strInstrumentForSender);
<a name="l12706"></a>12706     <span class="comment">// -----------------------------------------------------</span>
<a name="l12707"></a>12707     <span class="comment">// PREPARE TO SAVE A COPY IN THE OUTPAYMENT BOX</span>
<a name="l12708"></a>12708     <span class="comment">//</span>
<a name="l12709"></a>12709     <span class="keywordflow">if</span> (!THE_INSTRUMENT.<a class="code" href="class_o_t_payment.html#aec4f77470b159c3afd1cc4e3dffe464d">IsPurse</a>())
<a name="l12710"></a>12710     {
<a name="l12711"></a>12711         <span class="comment">// ----------------------------------------------</span>
<a name="l12712"></a>12712         <span class="comment">// store a copy in the outpayments.</span>
<a name="l12713"></a>12713         <span class="comment">// (not encrypted, since the Nymfile will be encrypted anyway.)</span>
<a name="l12714"></a>12714         <span class="comment">//</span>
<a name="l12715"></a>12715         <span class="comment">// UPDATE: We are now storing a copy in outpayments when the</span>
<a name="l12716"></a>12716         <span class="comment">// cheque is WRITTEN. But for other instruments (like cash, or</span>
<a name="l12717"></a>12717         <span class="comment">// vouchers) we cannot store them in outpayments until they are</span>
<a name="l12718"></a>12718         <span class="comment">// SENT. ...Meaning we must record at this point regardless.</span>
<a name="l12719"></a>12719         <span class="comment">// Should we have an exception here for cheques?</span>
<a name="l12720"></a>12720         <span class="comment">//</span>
<a name="l12721"></a>12721         <span class="comment">// Solution: Let&#39;s just make sure there&#39;s not already one there...</span>
<a name="l12722"></a>12722         <span class="comment">//</span>
<a name="l12723"></a>12723         int64_t lTempTransNum = 0;
<a name="l12724"></a>12724         <span class="keywordtype">bool</span> bGotTransNum      = THE_INSTRUMENT.<a class="code" href="class_o_t_payment.html#a4a6c103790c2fc759136079db0e65434">GetOpeningNum</a>(lTempTransNum, USER_ID);
<a name="l12725"></a>12725         int32_t  lOutpaymentsIndex = bGotTransNum ? pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0fb41be70cd60e4febffce961bf39823">GetOutpaymentsIndexByTransNum</a>(lTempTransNum) : (-1);
<a name="l12726"></a>12726 
<a name="l12727"></a>12727         <span class="keywordflow">if</span> (lOutpaymentsIndex &gt; (-1)) <span class="comment">// found something that matches...</span>
<a name="l12728"></a>12728         {
<a name="l12729"></a>12729             <span class="comment">// Remove it from Outpayments box. We&#39;re adding an updated version</span>
<a name="l12730"></a>12730             <span class="comment">// of this same instrument here anyway. We can erase the old one.</span>
<a name="l12731"></a>12731             <span class="comment">//</span>
<a name="l12732"></a>12732             <span class="keywordflow">if</span> (!pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a2d66a8a46d8e147ca0dbc0fb45bc364d">RemoveOutpaymentsByIndex</a>(lOutpaymentsIndex)) <span class="comment">// &lt;==== REMOVED! (So the one added below isn&#39;t a duplicate.)</span>
<a name="l12733"></a>12733             {
<a name="l12734"></a>12734                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error calling RemoveOutpaymentsByIndex for Nym: %s\n&quot;</span>,
<a name="l12735"></a>12735                               __FUNCTION__, strNymID.Get());
<a name="l12736"></a>12736 
<a name="l12737"></a>12737             }
<a name="l12738"></a>12738             <span class="comment">// Save Nym to local storage, since an outpayment was erased.</span>
<a name="l12739"></a>12739             <span class="comment">// Note: we&#39;re saving below anyway. Might as well not save twice.</span>
<a name="l12740"></a>12740             <span class="comment">//</span>
<a name="l12741"></a>12741 <span class="comment">//          else if (!pNym-&gt;SaveSignedNymfile(*pNym))</span>
<a name="l12742"></a>12742 <span class="comment">//              OTLog::vError(&quot;%s: Error saving Nym: %s\n&quot;, __FUNCTION__, strNymID.Get());</span>
<a name="l12743"></a>12743         }
<a name="l12744"></a>12744         <span class="keywordflow">else</span>
<a name="l12745"></a>12745             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: FYI, didn&#39;t remove an older copy of the instrument from the payments outbox, &quot;</span>
<a name="l12746"></a>12746                            <span class="stringliteral">&quot;since I couldn&#39;t find it in there.\n&quot;</span>, __FUNCTION__);
<a name="l12747"></a>12747     }
<a name="l12748"></a>12748     <span class="comment">// --------------------------------------------------------</span>
<a name="l12749"></a>12749     <span class="comment">// OUTPAYMENT COPY:</span>
<a name="l12750"></a>12750     <a class="code" href="class_o_t_message.html">OTMessage</a> * pMessage = <span class="keyword">new</span> <a class="code" href="class_o_t_message.html">OTMessage</a>;
<a name="l12751"></a>12751     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTMessage&gt;</a> theOutMsgAngel(pMessage);
<a name="l12752"></a>12752     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pMessage);
<a name="l12753"></a>12753 
<a name="l12754"></a>12754     pMessage-&gt;<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>      = <span class="stringliteral">&quot;outpaymentsMessage&quot;</span>;
<a name="l12755"></a>12755     pMessage-&gt;<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>        = strNymID;
<a name="l12756"></a>12756     pMessage-&gt;<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>       = strNymID2;
<a name="l12757"></a>12757     pMessage-&gt;<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>     = strServerID;
<a name="l12758"></a>12758     pMessage-&gt;<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#ad898bd63a4c37a97f64acfa7514409cc">SetString</a>(bGotSenderPmntCnts ? strInstrumentForSender : strInstrument);
<a name="l12759"></a>12759     <span class="comment">// -----------------------------------------------------</span>
<a name="l12760"></a>12760     <span class="comment">// If they&#39;re the same, we only save a copy in the outbox.</span>
<a name="l12761"></a>12761     <span class="comment">// (We only SEND if they are different.)</span>
<a name="l12762"></a>12762     <span class="comment">//</span>
<a name="l12763"></a>12763     <span class="keywordflow">if</span> (USER_ID != USER_ID_RECIPIENT)
<a name="l12764"></a>12764     {
<a name="l12765"></a>12765         <span class="comment">// (0) Set up the REQUEST NUMBER and then INCREMENT IT</span>
<a name="l12766"></a>12766         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a3866622c214e0c9b9ede3b00df3cdcba">GetCurrentRequestNum</a>(strServerID, lRequestNumber);
<a name="l12767"></a>12767         theMessage.<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Always have to send this.</span>
<a name="l12768"></a>12768         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e2031a4404c589c3a492bd48eb63932">IncrementRequestNum</a>(*pNym, strServerID); <span class="comment">// since I used it for a server request, I have to increment it</span>
<a name="l12769"></a>12769 
<a name="l12770"></a>12770         <span class="comment">// (1) set up member variables</span>
<a name="l12771"></a>12771         theMessage.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>         = <span class="stringliteral">&quot;sendUserInstrument&quot;</span>;
<a name="l12772"></a>12772         theMessage.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>           = strNymID;
<a name="l12773"></a>12773         theMessage.<a class="code" href="class_o_t_message.html#a724247e90624bbc678fb067beeba58b9">m_strNymID2</a>          = strNymID2;
<a name="l12774"></a>12774         theMessage.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>        = strServerID;
<a name="l12775"></a>12775         theMessage.<a class="code" href="class_o_t_message.html#a1d5e432e2353991e4a52752921e6d915">SetAcknowledgments</a>(*pNym); <span class="comment">// Must be called AFTER theMessage.m_strServerID is already set. (It uses it.)</span>
<a name="l12776"></a>12776 
<a name="l12777"></a>12777         <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;
<a name="l12778"></a>12778         <a class="code" href="class_o_t_asymmetric_key.html">OTAsymmetricKey</a> * pPubkey = <a class="code" href="class_o_t_asymmetric_key.html#a4437342fa5841152e2dfa6ee48a69094">OTAsymmetricKey::KeyFactory</a>();
<a name="l12779"></a>12779         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPubkey);
<a name="l12780"></a>12780         <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTAsymmetricKey&gt;</a> theKeyAngel(pPubkey);
<a name="l12781"></a>12781         <span class="comment">// -----------------------------------</span>
<a name="l12782"></a>12782         <span class="keywordflow">if</span> (!pPubkey-&gt;<a class="code" href="class_o_t_asymmetric_key.html#abe1f83bcc64a9f56406c4e145cd65651">SetPublicKey</a>(RECIPIENT_PUBKEY))
<a name="l12783"></a>12783         {
<a name="l12784"></a>12784             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed setting public key from string ===&gt;%s&lt;===\n&quot;</span>,
<a name="l12785"></a>12785                            __FUNCTION__, RECIPIENT_PUBKEY.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l12786"></a>12786         }
<a name="l12787"></a>12787         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bGotPaymentContents &amp;&amp;
<a name="l12788"></a>12788                  theEnvelope.<a class="code" href="class_o_t_envelope.html#aa03a9ff3ec1ad113a894ba4d9fac1876">Seal</a>(*pPubkey, strInstrument) &amp;&amp;
<a name="l12789"></a>12789                  theEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(theMessage.<a class="code" href="class_o_t_message.html#aa6729578b97f61804e91035a7709800a">m_ascPayload</a>))
<a name="l12790"></a>12790         {
<a name="l12791"></a>12791             <span class="comment">// (2) Sign the Message</span>
<a name="l12792"></a>12792             theMessage.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12793"></a>12793 
<a name="l12794"></a>12794             <span class="comment">// (3) Save the Message (with signatures and all, back to its internal member m_strRawFile.)</span>
<a name="l12795"></a>12795             theMessage.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12796"></a>12796             <span class="comment">// -------------------------------------------------------</span>
<a name="l12797"></a>12797             <span class="comment">// Back to the outpayments message...</span>
<a name="l12798"></a>12798             <span class="comment">// (We may want it saved in the outpayment box, before the reply from the</span>
<a name="l12799"></a>12799             <span class="comment">// above message comes in. Actually that might be wrong, since we care more</span>
<a name="l12800"></a>12800             <span class="comment">// about the receipt from the recipient depositing the instrument, then we do</span>
<a name="l12801"></a>12801             <span class="comment">// about the reply for the sendInstrument itself. Anyway, better safe than sorry...)</span>
<a name="l12802"></a>12802             <span class="comment">//</span>
<a name="l12803"></a>12803             pMessage-&gt;<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber);
<a name="l12804"></a>12804 
<a name="l12805"></a>12805             pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12806"></a>12806             pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12807"></a>12807 
<a name="l12808"></a>12808             theOutMsgAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL);
<a name="l12809"></a>12809             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l12810"></a>12810             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l12811"></a>12811             pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);  <span class="comment">// &lt;==== SAVED.</span>
<a name="l12812"></a>12812             <span class="comment">// --------------------------------------------------------</span>
<a name="l12813"></a>12813             <span class="comment">// (Send it)</span>
<a name="l12814"></a>12814             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12815"></a>12815             <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12816"></a>12816             <span class="comment">// -----------------------------------------------------------------</span>
<a name="l12817"></a>12817             nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#aa8dd2177f0b88bc2ac38b6abac24d4e3">CalcReturnVal</a>(lRequestNumber);
<a name="l12818"></a>12818         }
<a name="l12819"></a>12819         <span class="keywordflow">else</span>
<a name="l12820"></a>12820             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed sealing envelope.\n&quot;</span>, __FUNCTION__);
<a name="l12821"></a>12821     }
<a name="l12822"></a>12822     <span class="comment">// --------------------------------------------------------</span>
<a name="l12823"></a>12823     <span class="keywordflow">else</span> <span class="comment">// (USER_ID == USER_ID_RECIPIENT)</span>
<a name="l12824"></a>12824     {
<a name="l12825"></a>12825         <span class="comment">// You may be wondering why this code seems to repeat?</span>
<a name="l12826"></a>12826         <span class="comment">// The answer is because above, it needs to happen BEFORE</span>
<a name="l12827"></a>12827         <span class="comment">// the message is sent, since the processing of the server</span>
<a name="l12828"></a>12828         <span class="comment">// reply may expect the outpayments copy to already exist.</span>
<a name="l12829"></a>12829         <span class="comment">//</span>
<a name="l12830"></a>12830         <span class="comment">// (NOTE: That may actually not be true. That is more true for</span>
<a name="l12831"></a>12831         <span class="comment">// when the receipt comes in, from the recipient depositing</span>
<a name="l12832"></a>12832         <span class="comment">// the cheque, versus the server reply to the sendInstrument</span>
<a name="l12833"></a>12833         <span class="comment">// itself. Anyway...)</span>
<a name="l12834"></a>12834         <span class="comment">//</span>
<a name="l12835"></a>12835         <span class="comment">// Whereas here, it needs to happen in the case where the</span>
<a name="l12836"></a>12836         <span class="comment">// message is NOT sent. (USER as RECIPIENT means &quot;just put</span>
<a name="l12837"></a>12837         <span class="comment">// a copy in my outpayments box.&quot;)</span>
<a name="l12838"></a>12838         <span class="comment">//</span>
<a name="l12839"></a>12839         <span class="comment">// But if it DOES happen BEFORE, then we want to properly</span>
<a name="l12840"></a>12840         <span class="comment">// add the request number to it, even though we apparently</span>
<a name="l12841"></a>12841         <span class="comment">// don&#39;t use the request number on outpayments messages.</span>
<a name="l12842"></a>12842         <span class="comment">// Whereas here, we don&#39;t have a request number, so it just</span>
<a name="l12843"></a>12843         <span class="comment">// gets set to 0.</span>
<a name="l12844"></a>12844         <span class="comment">//</span>
<a name="l12845"></a>12845         pMessage-&gt;<a class="code" href="class_o_t_message.html#a1f97ec73f2a05d3d3d6fcb4854501dbe">m_strRequestNum</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%ld&quot;</span>, lRequestNumber); <span class="comment">// Will be 0 in this case.</span>
<a name="l12846"></a>12846 
<a name="l12847"></a>12847         pMessage-&gt;<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(*pNym);
<a name="l12848"></a>12848         pMessage-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l12849"></a>12849 
<a name="l12850"></a>12850         theOutMsgAngel.<a class="code" href="class_o_t_cleanup.html#aac0b26193b0a59dbbf491a4e417af833">SetCleanupTargetPointer</a>(NULL);
<a name="l12851"></a>12851         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a0e6b0025655ea295902be7ea71ec444c">AddOutpayments</a>(*pMessage); <span class="comment">// Now the Nym is responsible to delete it. It&#39;s in his &quot;outpayments&quot;.</span>
<a name="l12852"></a>12852         <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pSignerNym = pNym;
<a name="l12853"></a>12853         pNym-&gt;<a class="code" href="class_o_t_pseudonym.html#a5d08ef86097db038c2c4fd30034f5dc8">SaveSignedNymfile</a>(*pSignerNym);  <span class="comment">// &lt;==== SAVED.</span>
<a name="l12854"></a>12854         <span class="comment">// -----------------------------------------------------------------</span>
<a name="l12855"></a>12855         nReturnValue = 0; <span class="comment">// 0 means, nothing was sent, but no error occurred.</span>
<a name="l12856"></a>12856     }
<a name="l12857"></a>12857     <span class="comment">// --------------------------------------------------------</span>
<a name="l12858"></a>12858     <span class="keywordflow">return</span> nReturnValue;
<a name="l12859"></a>12859 }
<a name="l12860"></a>12860 
<a name="l12861"></a>12861 
<a name="l12862"></a>12862 
<a name="l12863"></a>12863 <span class="comment">// PROBLEM: How can I put anything in an &quot;out&quot; box (ledger) when I can&#39;t generate a</span>
<a name="l12864"></a>12864 <span class="comment">// transaction number on the client side?  Normally I download the outbox and</span>
<a name="l12865"></a>12865 <span class="comment">// it contains transactions that the SERVER put there--not me!</span>
<a name="l12866"></a>12866 
<a name="l12867"></a>12867 <span class="comment">// THEREFORE!!! The paymentOutbox NEEDS to be like OUTMAIL! It&#39;s just a message on a Nym. (No transaction numbers.)</span>
<a name="l12868"></a>12868 <span class="comment">// The instrument I sent will be a payload on a message, and that message will be copied into the paymentOutbox...</span>
<a name="l12869"></a>12869 
<a name="l12870"></a>12870 <span class="comment">// The messages definitely go OUT as messages, as do instruments, and those same messages end up</span>
<a name="l12871"></a>12871 <span class="comment">// &quot;in reference to&quot; on transactions stuffed in my nymbox and then those transactions have their</span>
<a name="l12872"></a>12872 <span class="comment">// message copied OUT, and added as a message to my OUTMAIL.</span>
<a name="l12873"></a>12873 <span class="comment">// Therefore Payment Outbox needs to be similar. It will contain the message originally sent -- no more.</span>
<a name="l12874"></a>12874 
<a name="l12875"></a>12875 <span class="comment">// whereas payment inbox comes from Nymbox (just copy it over.)</span>
<a name="l12876"></a>12876 <span class="comment">// Similarly, recordbox comes from either payment inbox or asset account inbox.</span>
<a name="l12877"></a>12877 
<a name="l12878"></a>12878 <span class="comment">// So tomorrow:  REMOVE the payment Outbox since it is BULLSHIT and replace with &quot;outmail&quot; like functionality for that box.</span>
<a name="l12879"></a>12879 <span class="comment">//</span>
<a name="l12880"></a>12880 <span class="comment">// Update: DONE.</span>
<a name="l12881"></a>12881 
<a name="l12882"></a>12882 
<a name="l12883"></a>12883 
<a name="l12884"></a><a class="code" href="class_o_t___a_p_i.html#a60e541e43d25106bee94688886d66dcb">12884</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a60e541e43d25106bee94688886d66dcb">OT_API::createUserAccount</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; SERVER_ID,
<a name="l12885"></a>12885                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l12886"></a>12886 {
<a name="l12887"></a>12887     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::createUserAccount&quot;</span>;
<a name="l12888"></a>12888     <span class="comment">// -----------------------------------------------------</span>
<a name="l12889"></a>12889     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12890"></a>12890     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12891"></a>12891     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12892"></a>12892     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12893"></a>12893     <span class="comment">// -----------------------------------------------------</span>
<a name="l12894"></a>12894     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12895"></a>12895     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12896"></a>12896     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12897"></a>12897     <span class="comment">// -----------------------------------------------------</span>
<a name="l12898"></a>12898     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12899"></a>12899 
<a name="l12900"></a>12900     int32_t nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7afb333a78adbe626a0dc596eed05f63f2">OTClient::createUserAccount</a>, theMessage,
<a name="l12901"></a>12901                                                      *pNym, *pServer,
<a name="l12902"></a>12902                                                      NULL); <span class="comment">// NULL pAccount on this command.</span>
<a name="l12903"></a>12903     <span class="keywordflow">if</span> (0 &lt; nReturnValue)
<a name="l12904"></a>12904     {               
<a name="l12905"></a>12905         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12906"></a>12906         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12907"></a>12907 
<a name="l12908"></a>12908         <span class="keywordflow">return</span> nReturnValue;
<a name="l12909"></a>12909     }
<a name="l12910"></a>12910     <span class="keywordflow">else</span>
<a name="l12911"></a>12911         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OT_API::createUserAccount: Error in m_pClient-&gt;ProcessUserCommand() \n&quot;</span>);
<a name="l12912"></a>12912 
<a name="l12913"></a>12913     <span class="keywordflow">return</span> -1;
<a name="l12914"></a>12914 }
<a name="l12915"></a>12915 
<a name="l12916"></a>12916 
<a name="l12917"></a>12917 
<a name="l12918"></a><a class="code" href="class_o_t___a_p_i.html#a6d44f675aa0c8fb36f9d55dadba5efcc">12918</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a6d44f675aa0c8fb36f9d55dadba5efcc">OT_API::deleteUserAccount</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; SERVER_ID,
<a name="l12919"></a>12919                                <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l12920"></a>12920 {
<a name="l12921"></a>12921     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::deleteUserAccount&quot;</span>;
<a name="l12922"></a>12922     <span class="comment">// -----------------------------------------------------</span>
<a name="l12923"></a>12923     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12924"></a>12924     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12925"></a>12925     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12926"></a>12926     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12927"></a>12927     <span class="comment">// -----------------------------------------------------</span>
<a name="l12928"></a>12928     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12929"></a>12929     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12930"></a>12930     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12931"></a>12931     <span class="comment">// -----------------------------------------------------</span>
<a name="l12932"></a>12932     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12933"></a>12933 
<a name="l12934"></a>12934     int32_t nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a23b8e2415f87b591e674a206aabdd821">OTClient::deleteUserAccount</a>, theMessage,
<a name="l12935"></a>12935                                                      *pNym, *pServer,
<a name="l12936"></a>12936                                                      NULL); <span class="comment">// NULL pAccount on this command.</span>
<a name="l12937"></a>12937     <span class="keywordflow">if</span> (0 &lt; nReturnValue) 
<a name="l12938"></a>12938     {               
<a name="l12939"></a>12939         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12940"></a>12940         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12941"></a>12941 
<a name="l12942"></a>12942         <span class="keywordflow">return</span> nReturnValue;
<a name="l12943"></a>12943     }
<a name="l12944"></a>12944     <span class="keywordflow">else</span>
<a name="l12945"></a>12945         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error processing deleteUserAccount command in OT_API::deleteUserAccount\n&quot;</span>);
<a name="l12946"></a>12946 
<a name="l12947"></a>12947     <span class="keywordflow">return</span> -1;
<a name="l12948"></a>12948 
<a name="l12949"></a>12949 }
<a name="l12950"></a>12950 
<a name="l12951"></a>12951 
<a name="l12952"></a><a class="code" href="class_o_t___a_p_i.html#a1d07c06d85b685d11ac4076104d73f49">12952</a> int32_t <a class="code" href="class_o_t___a_p_i.html#a1d07c06d85b685d11ac4076104d73f49">OT_API::checkServerID</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a>  &amp; SERVER_ID,
<a name="l12953"></a>12953                            <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; USER_ID)
<a name="l12954"></a>12954 {
<a name="l12955"></a>12955     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFuncName = <span class="stringliteral">&quot;OT_API::checkServerID&quot;</span>;
<a name="l12956"></a>12956     <span class="comment">// -----------------------------------------------------</span>
<a name="l12957"></a>12957     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = this-&gt;<a class="code" href="class_o_t___a_p_i.html#aa53f110b77dee2bc71b70906ca64fbbc">GetOrLoadPrivateNym</a>(USER_ID, <span class="keyword">false</span>, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12958"></a>12958     <span class="keywordflow">if</span> (NULL == pNym) <span class="keywordflow">return</span> (-1);
<a name="l12959"></a>12959     <span class="comment">// By this point, pNym is a good pointer, and is on the wallet.</span>
<a name="l12960"></a>12960     <span class="comment">//  (No need to cleanup.)</span>
<a name="l12961"></a>12961     <span class="comment">// -----------------------------------------------------</span>
<a name="l12962"></a>12962     <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> *  pServer = this-&gt;<a class="code" href="class_o_t___a_p_i.html#afa4e2d39d29061b609d81f094c2ca25c">GetServer</a>(SERVER_ID, szFuncName); <span class="comment">// This ASSERTs and logs already.</span>
<a name="l12963"></a>12963     <span class="keywordflow">if</span> (NULL == pServer) <span class="keywordflow">return</span> (-1);
<a name="l12964"></a>12964     <span class="comment">// By this point, pServer is a good pointer.  (No need to cleanup.)</span>
<a name="l12965"></a>12965     <span class="comment">// -----------------------------------------------------</span>
<a name="l12966"></a>12966     <a class="code" href="class_o_t_message.html">OTMessage</a> theMessage;
<a name="l12967"></a>12967 
<a name="l12968"></a>12968     int32_t nReturnValue = <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a65b35501e13456c8086c66d4dfda2545">ProcessUserCommand</a>(<a class="code" href="class_o_t_client.html#af16093cbd49040c8968e26f8456da0f7a89596b609fbd84aa6151ca9d1b107c13">OTClient::checkServerID</a>, theMessage,
<a name="l12969"></a>12969                                                      *pNym, *pServer,
<a name="l12970"></a>12970                                                      NULL); <span class="comment">// NULL pAccount on this command.</span>
<a name="l12971"></a>12971     <span class="keywordflow">if</span> (0 &lt; nReturnValue) 
<a name="l12972"></a>12972     {               
<a name="l12973"></a>12973         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#a36a2c3be7c495a38f4ee0089527df638">SetFocusToServerAndNym</a>(*pServer, *pNym, this-&gt;m_pTransportCallback);
<a name="l12974"></a>12974         <a class="code" href="class_o_t___a_p_i.html#adb93341da4f1091977c5ac42acef25fd">m_pClient</a>-&gt;<a class="code" href="class_o_t_client.html#acba8ab65dfe62afdc219277c9d44b546">ProcessMessageOut</a>(theMessage);
<a name="l12975"></a>12975 
<a name="l12976"></a>12976         <span class="keywordflow">return</span> nReturnValue;
<a name="l12977"></a>12977     }
<a name="l12978"></a>12978     <span class="keywordflow">else</span>
<a name="l12979"></a>12979         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;Error processing checkServerID command in OT_API::checkServerID\n&quot;</span>);
<a name="l12980"></a>12980 
<a name="l12981"></a>12981     <span class="keywordflow">return</span> -1;
<a name="l12982"></a>12982 }
<a name="l12983"></a>12983 
<a name="l12984"></a>12984 
<a name="l12985"></a><a class="code" href="class_o_t___a_p_i.html#a13311668f7e0d6a58ef5d97e83fa9f46">12985</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t___a_p_i.html#a13311668f7e0d6a58ef5d97e83fa9f46">OT_API::AddServerContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_server_contract.html">OTServerContract</a> &amp; pContract)
<a name="l12986"></a>12986 {
<a name="l12987"></a>12987     this-&gt;<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#ad925633d8ba2319948b466ca0f0dc438">AddServerContract</a>(pContract);
<a name="l12988"></a>12988 }
<a name="l12989"></a>12989 
<a name="l12990"></a><a class="code" href="class_o_t___a_p_i.html#a1235a29159f7ed06cd975ad94186eb42">12990</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t___a_p_i.html#a1235a29159f7ed06cd975ad94186eb42">OT_API::AddAssetContract</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_asset_contract.html">OTAssetContract</a> &amp; theContract)
<a name="l12991"></a>12991 {
<a name="l12992"></a>12992     this-&gt;<a class="code" href="class_o_t___a_p_i.html#af96fb56042201afb4574298dcdca93fc">m_pWallet</a>-&gt;<a class="code" href="class_o_t_wallet.html#aec0dc4e66d6bc87cbec6fc4c0e3851f7">AddAssetContract</a>(theContract);
<a name="l12993"></a>12993 }
<a name="l12994"></a>12994 
<a name="l12995"></a>12995 
<a name="l12996"></a>12996 
<a name="l12997"></a>12997 
<a name="l12998"></a>12998 
<a name="l12999"></a>12999 
<a name="l13000"></a>13000 
<a name="l13001"></a>13001 
<a name="l13002"></a>13002 
<a name="l13003"></a>13003 
<a name="l13004"></a>13004 
<a name="l13005"></a>13005 
<a name="l13006"></a>13006 
<a name="l13007"></a>13007 
<a name="l13008"></a>13008 
<a name="l13009"></a>13009 
<a name="l13010"></a>13010 
<a name="l13011"></a>13011 
<a name="l13012"></a>13012 
<a name="l13013"></a>13013 
<a name="l13014"></a>13014 
<a name="l13015"></a>13015 
<a name="l13016"></a>13016 
<a name="l13017"></a>13017 
<a name="l13018"></a>13018 
<a name="l13019"></a>13019 
<a name="l13020"></a>13020 
<a name="l13021"></a>13021 
<a name="l13022"></a>13022 
<a name="l13023"></a>13023 
<a name="l13024"></a>13024 
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_open_transactions_8cpp.html">OpenTransactions.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:01 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
