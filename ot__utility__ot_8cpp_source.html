<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otapi/ot_utility_ot.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ot__utility__ot_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otapi/ot_utility_ot.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="ot__utility__ot_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// ------------------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment">//  ot_ot</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This is part of a library written in OTScript, which makes the OT-API</span>
<a name="l00005"></a>00005 <span class="comment">// much easier to use from inside your own OTScripts, by providing</span>
<a name="l00006"></a>00006 <span class="comment">// a higher-level layer.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// Think of it as the &quot;standard header&quot; for using OT from a script.</span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">// There is similar code to this in Java also, in the OTAPI_Func and</span>
<a name="l00011"></a>00011 <span class="comment">// Utility classes, in the Moneychanger project. They also make the</span>
<a name="l00012"></a>00012 <span class="comment">// OTAPI much easier to use, by providing a higher-level layer.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">//  http://www.chaiscript.com/doxygen/namespace_chai_script___language.html</span>
<a name="l00015"></a>00015 <span class="comment">//</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="ot__utility__ot_8hpp.html">ot_utility_ot.hpp</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="ot__otapi__ot_8hpp.html">ot_otapi_ot.hpp</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_a_p_i_8hpp.html">OTAPI.hpp</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="_o_t___m_e_8hpp.html">OT_ME.hpp</a>&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="ot__utility__ot_8cpp.html#ae8b3547306a6f1f21b9d35f9ed9b4375">00027</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8hpp.html#ae6c4712cdd271cd71ea9ade46732b23f">VerifyExists</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; theObjectNameAsStr)
<a name="l00028"></a>00028 {
<a name="l00029"></a>00029     <span class="keywordflow">return</span> <a class="code" href="ot__utility__ot_8hpp.html#ae6c4712cdd271cd71ea9ade46732b23f">VerifyExists</a>(theObjectNameAsStr, <span class="keyword">true</span>);
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="ot__utility__ot_8cpp.html#a9a3f8245344a63a1fa21a35e33b34bcc">00032</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8hpp.html#ae6c4712cdd271cd71ea9ade46732b23f">VerifyExists</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; theObjectNameAsStr, <span class="keyword">const</span> <span class="keywordtype">bool</span> bDisplayError)
<a name="l00033"></a>00033 {
<a name="l00034"></a>00034    <span class="comment">//var objs = get_objects();</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036     <span class="comment">//if (0 &gt;= objs.size()) { return false; }</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038     <span class="keywordflow">if</span> (<a class="code" href="class_o_t___m_e.html#a43521aa8e18a666882696219fd549cf1">OT_ME::FindVariable2</a>(theObjectNameAsStr) == NULL)
<a name="l00039"></a>00039     {
<a name="l00040"></a>00040         <span class="keywordtype">string</span> strDefault = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042         <span class="keywordflow">if</span> (<span class="stringliteral">&quot;Server&quot;</span> == theObjectNameAsStr) {
<a name="l00043"></a>00043             strDefault = <span class="stringliteral">&quot;--server &lt;SERVER_ID&gt;&quot;</span>;
<a name="l00044"></a>00044         }
<a name="l00045"></a>00045         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;MyNym&quot;</span> == theObjectNameAsStr) {
<a name="l00046"></a>00046             strDefault = <span class="stringliteral">&quot;--mynym &lt;NYM_ID&gt;&quot;</span>;
<a name="l00047"></a>00047         }
<a name="l00048"></a>00048         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;MyAcct&quot;</span> == theObjectNameAsStr) {
<a name="l00049"></a>00049             strDefault = <span class="stringliteral">&quot;--myacct &lt;ACCT_ID&gt;&quot;</span>;
<a name="l00050"></a>00050         }
<a name="l00051"></a>00051         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;MyPurse&quot;</span> == theObjectNameAsStr) {
<a name="l00052"></a>00052             strDefault = <span class="stringliteral">&quot;--mypurse &lt;ASSET_TYPE_ID&gt;&quot;</span>;
<a name="l00053"></a>00053         }
<a name="l00054"></a>00054         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;HisNym&quot;</span> == theObjectNameAsStr) {
<a name="l00055"></a>00055             strDefault = <span class="stringliteral">&quot;--hisnym &lt;NYM_ID&gt;&quot;</span>;
<a name="l00056"></a>00056         }
<a name="l00057"></a>00057         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;HisAcct&quot;</span> == theObjectNameAsStr) {
<a name="l00058"></a>00058             strDefault = <span class="stringliteral">&quot;--hisacct &lt;ACCT_ID&gt;&quot;</span>;
<a name="l00059"></a>00059         }
<a name="l00060"></a>00060         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;HisPurse&quot;</span> == theObjectNameAsStr) {
<a name="l00061"></a>00061             strDefault = <span class="stringliteral">&quot;--hispurse &lt;ASSET_TYPE_ID&gt;&quot;</span>;
<a name="l00062"></a>00062         }
<a name="l00063"></a>00063         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;Args&quot;</span> == theObjectNameAsStr) {
<a name="l00064"></a>00064             strDefault = <span class="stringliteral">&quot;--args \&quot;key1 value1 key2 value2 key3 \\\&quot;Here is value 3\\\&quot;\&quot;&quot;</span>;
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordflow">if</span> (bDisplayError)
<a name="l00068"></a>00068         {
<a name="l00069"></a>00069             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Missing variable: &quot;</span> + theObjectNameAsStr + <span class="stringliteral">&quot;. Try adding it as a parameter, like this: &quot;</span> + strDefault + <span class="stringliteral">&quot;\n(Or if you prefer, set the default in ~/.ot/command-line-ot.opt)\nNOTE: If you DID provide this variable, then the Nym wasn&#39;t found.\n\n&quot;</span>);
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00072"></a>00072     }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">// ********************************************************************************</span>
<a name="l00078"></a>00078 
<a name="l00080"></a>00080 <span class="comment">//OT_UTILITY_OT bool VerifyOTIntegerRef(nValue) // used for OTInteger</span>
<a name="l00081"></a>00081 <span class="comment">//{</span>
<a name="l00082"></a>00082 <span class="comment">//    if (nValue.is_var_null() || nValue.is_var_undef() || !nValue.is_type(&quot;OTInteger&quot;))</span>
<a name="l00083"></a>00083 <span class="comment">//    {</span>
<a name="l00084"></a>00084 <span class="comment">//        return false;</span>
<a name="l00085"></a>00085 <span class="comment">//    }</span>
<a name="l00086"></a>00086 <span class="comment">//    else { return true; }</span>
<a name="l00087"></a>00087 <span class="comment">//}</span>
<a name="l00088"></a>00088 <span class="comment">//</span>
<a name="l00090"></a>00090 <span class="comment"></span><span class="comment">//OT_UTILITY_OT bool VerifyOTBoolRef(bValue) // used for OTBool class</span>
<a name="l00091"></a>00091 <span class="comment">//{</span>
<a name="l00092"></a>00092 <span class="comment">//    if (bValue.is_var_null() || bValue.is_var_undef() || !bValue.is_type(&quot;OTBool&quot;))</span>
<a name="l00093"></a>00093 <span class="comment">//    {</span>
<a name="l00094"></a>00094 <span class="comment">//        return false;</span>
<a name="l00095"></a>00095 <span class="comment">//    }</span>
<a name="l00096"></a>00096 <span class="comment">//    else { return true; }</span>
<a name="l00097"></a>00097 <span class="comment">//}</span>
<a name="l00099"></a>00099 <span class="comment"></span>
<a name="l00100"></a><a class="code" href="ot__utility__ot_8cpp.html#a9334ce4c43498b7c0ae7883aafeb47d5">00100</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8cpp.html#a9334ce4c43498b7c0ae7883aafeb47d5">VerifyMessage</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strMessage)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (10 &gt; strMessage.length())
<a name="l00103"></a>00103     {
<a name="l00104"></a>00104         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMessage: Error strMessage is: Too Short:&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00105"></a>00105         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00106"></a>00106     }
<a name="l00107"></a>00107     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a><a class="code" href="ot__utility__ot_8cpp.html#aa9575c43efc3b0dc6f34f2b931693875">00111</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="ot__utility__ot_8hpp.html#afdbf3b63181963189d5f77bfd70bbb13">VerifyMessageSuccess</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strMessage)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8cpp.html#a9334ce4c43498b7c0ae7883aafeb47d5">VerifyMessage</a>(strMessage))
<a name="l00114"></a>00114     {
<a name="l00115"></a>00115         <span class="keywordflow">return</span> -1;
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     int32_t nStatus = <a class="code" href="class_o_t_a_p_i___wrap.html#a3f9ed20aefd19c741f64ffffb8c36bc1">OTAPI_Wrap::Message_GetSuccess</a>(strMessage);
<a name="l00119"></a>00119     <span class="keywordflow">switch</span> (nStatus)
<a name="l00120"></a>00120     {
<a name="l00121"></a>00121     <span class="keywordflow">case</span> -1:
<a name="l00122"></a>00122         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMessageSuccess: Error calling OT_API_Message_GetSuccess, for message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00123"></a>00123         <span class="keywordflow">break</span>;
<a name="l00124"></a>00124     <span class="keywordflow">case</span> 0:
<a name="l00125"></a>00125         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMessageSuccess: Reply received: success == FALSE. Reply message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00126"></a>00126         <span class="keywordflow">break</span>;
<a name="l00127"></a>00127     <span class="keywordflow">case</span> 1:
<a name="l00128"></a>00128         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMessageSuccess: Reply received: success == TRUE.\n&quot;</span>);
<a name="l00129"></a>00129         <span class="keywordflow">break</span>;
<a name="l00130"></a>00130     <span class="keywordflow">default</span>:
<a name="l00131"></a>00131         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMessageSuccess: Error. (This should never happen!) nStatus: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nStatus) + <span class="stringliteral">&quot;, Input: &quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00132"></a>00132         nStatus = -1;
<a name="l00133"></a>00133         <span class="keywordflow">break</span>;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">return</span> nStatus;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="ot__utility__ot_8cpp.html#a16b5f2901bc773c5b6e812b0dd735cf4">00140</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8hpp.html#a365a22eabcc7f4eca4f5e62f25cfd201">VerifyNotNull</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * theObjectRef)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="comment">//bool bNull = theObjectRef.is_var_null();</span>
<a name="l00143"></a>00143     <span class="comment">//bool bUndef = theObjectRef.is_var_undef();</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (theObjectRef == NULL)
<a name="l00146"></a>00146     {
<a name="l00147"></a>00147         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyNotNull: false\n&quot;</span>);
<a name="l00148"></a>00148         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyNotNull: true\n&quot;</span>);
<a name="l00152"></a>00152     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="ot__utility__ot_8cpp.html#afc5ecb02284c2700b0290f01a5aeeae7">00156</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8hpp.html#a210a7c90f7abda3fbe2cfb5dcf48ac61">VerifyType</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * theObjectRef, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strType)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a365a22eabcc7f4eca4f5e62f25cfd201">VerifyNotNull</a>(theObjectRef))
<a name="l00159"></a>00159     {
<a name="l00160"></a>00160         <span class="comment">//if (!strType.is_type(&quot;string&quot;))</span>
<a name="l00161"></a>00161         <span class="comment">//{</span>
<a name="l00162"></a>00162         <span class="comment">//    OTAPI_Wrap::Output(0, &quot;VerifyType: Expected strType to contain a string. (Failed.)\n&quot;);</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="comment">//    return false;</span>
<a name="l00165"></a>00165         <span class="comment">//}</span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="comment">//bool bType = theObjectRef.is_type(strType);</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="comment">//if (!bType)</span>
<a name="l00170"></a>00170         <span class="comment">//{</span>
<a name="l00171"></a>00171         <span class="comment">//    OTAPI_Wrap::Output(0, &quot;VerifyType: Expected object of type: &quot; + strType + &quot; (failed type match.)\n&quot;);</span>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="comment">//    return false;</span>
<a name="l00174"></a>00174         <span class="comment">//}</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="ot__utility__ot_8cpp.html#ac063046e62c8914bb55e1e25cebd2f87">00182</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="ot__utility__ot_8hpp.html#a56da374b90a36709e823a1b047604770">VerifyStorable</a>(<a class="code" href="class_o_t_d_b_1_1_storable.html">OTDB::Storable</a> * theStorableObjectRef, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strType)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <span class="comment">// Put this in a separate function VerifyType so I can use it for non-storable</span>
<a name="l00185"></a>00185     <span class="comment">// types such as std::map.</span>
<a name="l00186"></a>00186     <span class="comment">// This function can still customize on top of that, if/when we need to.</span>
<a name="l00187"></a>00187     <span class="comment">//</span>
<a name="l00188"></a>00188     <span class="keywordflow">return</span> <a class="code" href="ot__utility__ot_8hpp.html#a210a7c90f7abda3fbe2cfb5dcf48ac61">VerifyType</a>(theStorableObjectRef, strType);
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 
<a name="l00195"></a>00195 <span class="comment">//attr ObjRef::the_ref  // this is our &quot;pointer&quot; to an object we do NOT want to clone. (ObjRef can be passed in and cloned, with all clones retaining same pointer, theoretically.)</span>
<a name="l00196"></a>00196 <span class="comment">//</span>
<a name="l00197"></a>00197 <span class="comment">//</span>
<a name="l00198"></a>00198 <span class="comment">//OT_UTILITY_OT int32_t ObjRef::ObjRef() // todo remove this?</span>
<a name="l00199"></a>00199 <span class="comment">//{</span>
<a name="l00200"></a>00200 <span class="comment">//    OTAPI_Wrap::Output(1, &quot;(Version of ObjRef::ObjRef with 0 arguments. Must call setRef next...)\n&quot;);</span>
<a name="l00201"></a>00201 <span class="comment">//}</span>
<a name="l00203"></a>00203 <span class="comment"></span><span class="comment">//</span>
<a name="l00205"></a>00205 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t ObjRef::ObjRef(rhs)</span>
<a name="l00206"></a>00206 <span class="comment">//{</span>
<a name="l00207"></a>00207 <span class="comment">//    OTAPI_Wrap::Output(1, &quot;Supposedly: Copy constructor. rhs type actually is: &quot; + rhs.get_type_info().name() + &quot;\n&quot;);</span>
<a name="l00208"></a>00208 <span class="comment">//</span>
<a name="l00209"></a>00209 <span class="comment">//    // ---------------------------</span>
<a name="l00210"></a>00210 <span class="comment">//the_ref: = rhs.the_ref // by REFERENCE :-)</span>
<a name="l00211"></a>00211 <span class="comment">//}</span>
<a name="l00212"></a>00212 <span class="comment">//</span>
<a name="l00214"></a>00214 <span class="comment"></span><span class="comment">//</span>
<a name="l00215"></a>00215 <span class="comment">//OT_UTILITY_OT int32_t ObjRef::setRef(rhs) : rhs.is_type(&quot;ObjRef&quot;)</span>
<a name="l00216"></a>00216 <span class="comment">//{</span>
<a name="l00217"></a>00217 <span class="comment">//    OTAPI_Wrap::Output(1, &quot;(Version of ObjRef::setRef with ObjRef arg.\n&quot;);</span>
<a name="l00218"></a>00218 <span class="comment">//the_ref: = rhs.the_ref // by REFERENCE :-)</span>
<a name="l00219"></a>00219 <span class="comment">//}</span>
<a name="l00220"></a>00220 <span class="comment">//</span>
<a name="l00221"></a>00221 <span class="comment">//OT_UTILITY_OT int32_t ObjRef::setRef(rhs) : !rhs.is_type(&quot;ObjRef&quot;)</span>
<a name="l00222"></a>00222 <span class="comment">//{</span>
<a name="l00223"></a>00223 <span class="comment">//    // By this point we know that rhs is NOT an ObjRef.</span>
<a name="l00224"></a>00224 <span class="comment">//</span>
<a name="l00225"></a>00225 <span class="comment">//    OTAPI_Wrap::Output(1, &quot;(Version of ObjRef::setRef with non-ObjRef arg. Good: creating a new wrapper around some unknown type. Specifically, &quot; + rhs.get_type_info().name() + &quot;.)\n&quot;);</span>
<a name="l00226"></a>00226 <span class="comment">//    // ---------------------------</span>
<a name="l00227"></a>00227 <span class="comment">//    // if the_ref exists but doesn&#39;t match rhs&#39;s type...</span>
<a name="l00228"></a>00228 <span class="comment">//    //</span>
<a name="l00229"></a>00229 <span class="comment">//    if (VerifyNotNull(the_ref) &amp;&amp; !(the_ref.get_type_info().bare_equal(rhs.get_type_info())))</span>
<a name="l00230"></a>00230 <span class="comment">//    {</span>
<a name="l00231"></a>00231 <span class="comment">//        print(&quot;rhs TYPE NAME: &quot; + rhs.get_type_info().name())</span>
<a name="l00232"></a>00232 <span class="comment">//            print(&quot;the_ref TYPE NAME: &quot; + the_ref.get_type_info().name())</span>
<a name="l00233"></a>00233 <span class="comment">//</span>
<a name="l00234"></a>00234 <span class="comment">//            OTAPI_Wrap::Output(0, &quot;ERROR: object being copied is not an ObjRef like I am, neither is it the same type as the_ref is! (Which does exist.) You are passing an object of the wrong type--or someone is. ASSERT!\n&quot;);</span>
<a name="l00235"></a>00235 <span class="comment">//    }</span>
<a name="l00236"></a>00236 <span class="comment">//    // ---------------------------</span>
<a name="l00237"></a>00237 <span class="comment">//    // We know that the_ref is either NULL... or if it&#39;s not NULL,</span>
<a name="l00238"></a>00238 <span class="comment">//    // then at least rhs is of the same data type that the_ref is.</span>
<a name="l00239"></a>00239 <span class="comment">//    // Either way, now we can copy it&#39;s reference over.</span>
<a name="l00240"></a>00240 <span class="comment">//    //</span>
<a name="l00241"></a>00241 <span class="comment">//    else</span>
<a name="l00242"></a>00242 <span class="comment">//    {</span>
<a name="l00243"></a>00243 <span class="comment">//    the_ref: = rhs // by reference</span>
<a name="l00244"></a>00244 <span class="comment">//        OTAPI_Wrap::Output(1, &quot;Assigned the_ref to a reference to rhs. Type is: &quot; + rhs.get_type_info().name());</span>
<a name="l00245"></a>00245 <span class="comment">//</span>
<a name="l00246"></a>00246 <span class="comment">//    }</span>
<a name="l00247"></a>00247 <span class="comment">//    // ---------------------------</span>
<a name="l00248"></a>00248 <span class="comment">//}</span>
<a name="l00250"></a>00250 <span class="comment"></span><span class="comment">//</span>
<a name="l00251"></a>00251 <span class="comment">//OT_UTILITY_OT int32_t clone(rhs) : rhs.is_type(&quot;ObjRef&quot;)</span>
<a name="l00252"></a>00252 <span class="comment">//{</span>
<a name="l00253"></a>00253 <span class="comment">//    print(&quot;clone ObjRef&quot;)</span>
<a name="l00254"></a>00254 <span class="comment">//        var new_o : = ObjRef(rhs);</span>
<a name="l00255"></a>00255 <span class="comment">//</span>
<a name="l00256"></a>00256 <span class="comment">//    //    for_each(get_attrs(),</span>
<a name="l00257"></a>00257 <span class="comment">//    //             bind(fun(new_o, x) { new_o.get_attr(x.first) = x.second; },</span>
<a name="l00258"></a>00258 <span class="comment">//    //                  new_o, _)</span>
<a name="l00259"></a>00259 <span class="comment">//    //             );</span>
<a name="l00260"></a>00260 <span class="comment">//    return new_o;</span>
<a name="l00261"></a>00261 <span class="comment">//}</span>
<a name="l00262"></a>00262 <span class="comment">//</span>
<a name="l00266"></a>00266 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t clone(rhs) : (0 == rhs.get_type_info().name().find(&quot;OTDB_&quot;))</span>
<a name="l00267"></a>00267 <span class="comment">//{</span>
<a name="l00268"></a>00268 <span class="comment">//    return rhs;</span>
<a name="l00269"></a>00269 <span class="comment">//}</span>
<a name="l00270"></a>00270 <span class="comment">//</span>
<a name="l00272"></a>00272 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t ObjRef::assign(rhs)</span>
<a name="l00273"></a>00273 <span class="comment">//{</span>
<a name="l00274"></a>00274 <span class="comment">//    print(&quot;assign&quot;)</span>
<a name="l00275"></a>00275 <span class="comment">//        setRef(rhs)</span>
<a name="l00276"></a>00276 <span class="comment">//        return this;</span>
<a name="l00277"></a>00277 <span class="comment">//}</span>
<a name="l00279"></a>00279 <span class="comment"></span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">//pScript-&gt;chai.add(fun(&amp;OTAPI_Wrap::Message_GetSuccess), &quot;OT_API_Message_GetSuccess&quot;);                 *DONE (just above)</span>
<a name="l00282"></a>00282 <span class="comment">//pScript-&gt;chai.add(fun(&amp;OTAPI_Wrap::Msg_GetBlnceAgrmntSuccess), &quot;OT_API_Msg_GetBlnceAgrmntSuccess&quot;);   *DONE (first below)</span>
<a name="l00283"></a>00283 <span class="comment">//pScript-&gt;chai.add(fun(&amp;OTAPI_Wrap::Msg_GetTransactionSuccess), &quot;OT_API_Msg_GetTransactionSuccess&quot;);</span>
<a name="l00284"></a>00284 <span class="comment">//</span>
<a name="l00285"></a>00285 <span class="comment">//pScript-&gt;chai.add(fun(&amp;OTAPI_Wrap::Transaction_GetSuccess), &quot;OT_API_Transaction_GetSuccess&quot;);</span>
<a name="l00286"></a>00286 <span class="comment">//pScript-&gt;chai.add(fun(&amp;OTAPI_Wrap::Transaction_GetBlnceAgrmntSuccess), &quot;OT_API_Transaction_GetBlnceAgrmntSuccess&quot;);</span>
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="ot__utility__ot_8cpp.html#afef1db3f7a3c30cc6fecb58108dd0a23">00289</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="ot__utility__ot_8hpp.html#af9277b00455b6e760011dd7b597761aa">VerifyMsgBalanceAgrmntSuccess</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; SERVER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; USER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; ACCOUNT_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strMessage)  <span class="comment">// For when an OTMessage is the input.</span>
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8cpp.html#a9334ce4c43498b7c0ae7883aafeb47d5">VerifyMessage</a>(strMessage))
<a name="l00292"></a>00292     {
<a name="l00293"></a>00293         <span class="keywordflow">return</span> -1;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     int32_t nSuccess = <a class="code" href="class_o_t_a_p_i___wrap.html#ab96dba3945c8e16f0a290fd90cba467b">OTAPI_Wrap::Message_GetBalanceAgreementSuccess</a>(SERVER_ID, USER_ID, ACCOUNT_ID, strMessage);
<a name="l00297"></a>00297     <span class="keywordflow">switch</span> (nSuccess)
<a name="l00298"></a>00298     {
<a name="l00299"></a>00299     <span class="keywordflow">case</span> -1:
<a name="l00300"></a>00300         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMsgBalanceAgrmntSuccess: Error calling OT_API_Msg_GetBlnceAgrmntSuccess, for message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00301"></a>00301         <span class="keywordflow">break</span>;
<a name="l00302"></a>00302     <span class="keywordflow">case</span> 0:
<a name="l00303"></a>00303         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMsgBalanceAgrmntSuccess: Reply received: success == FALSE. Reply message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00304"></a>00304         <span class="keywordflow">break</span>;
<a name="l00305"></a>00305     <span class="keywordflow">case</span> 1:
<a name="l00306"></a>00306         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMsgBalanceAgrmntSuccess: Reply received: success == TRUE.\n&quot;</span>);
<a name="l00307"></a>00307         <span class="keywordflow">break</span>;
<a name="l00308"></a>00308     <span class="keywordflow">default</span>:
<a name="l00309"></a>00309         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMsgBalanceAgrmntSuccess: Error. (This should never happen!) Input: &quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00310"></a>00310         nSuccess = -1;
<a name="l00311"></a>00311         <span class="keywordflow">break</span>;
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="keywordflow">return</span> nSuccess;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a><a class="code" href="ot__utility__ot_8cpp.html#afbd9ccb88a0bd03495593fb8fc87d48c">00318</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="ot__utility__ot_8hpp.html#a711f019ab74c4afbe71dc745957bd98f">VerifyMsgTrnxSuccess</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; SERVER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; USER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; ACCOUNT_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strMessage)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8cpp.html#a9334ce4c43498b7c0ae7883aafeb47d5">VerifyMessage</a>(strMessage))
<a name="l00321"></a>00321     {
<a name="l00322"></a>00322         <span class="keywordflow">return</span> -1;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     int32_t nSuccess = <a class="code" href="class_o_t_a_p_i___wrap.html#aa7fda270a877dde2d8765a91b11ff98c">OTAPI_Wrap::Message_GetTransactionSuccess</a>(SERVER_ID, USER_ID, ACCOUNT_ID, strMessage);
<a name="l00326"></a>00326     <span class="keywordflow">switch</span> (nSuccess)
<a name="l00327"></a>00327     {
<a name="l00328"></a>00328     <span class="keywordflow">case</span> -1:
<a name="l00329"></a>00329         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMsgTrnxSuccess: Error calling OT_API_Message_GetSuccess, for message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00330"></a>00330         <span class="keywordflow">break</span>;
<a name="l00331"></a>00331     <span class="keywordflow">case</span> 0:
<a name="l00332"></a>00332         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMsgTrnxSuccess: Reply received: success == FALSE. Reply message:\n\n&quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00333"></a>00333         <span class="keywordflow">break</span>;
<a name="l00334"></a>00334     <span class="keywordflow">case</span> 1:
<a name="l00335"></a>00335         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, <span class="stringliteral">&quot;VerifyMsgTrnxSuccess: Reply received: success == TRUE.\n&quot;</span>);
<a name="l00336"></a>00336         <span class="keywordflow">break</span>;
<a name="l00337"></a>00337     <span class="keywordflow">default</span>:
<a name="l00338"></a>00338         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;VerifyMsgTrnxSuccess: Error. (This should never happen!) Input: &quot;</span> + strMessage + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00339"></a>00339         nSuccess = -1;
<a name="l00340"></a>00340         <span class="keywordflow">break</span>;
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">return</span> nSuccess;
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="comment">//</span>
<a name="l00347"></a>00347 <span class="comment">// This code was repeating a lot, so I just added a function for it.</span>
<a name="l00348"></a>00348 <span class="comment">//</span>
<a name="l00349"></a><a class="code" href="ot__utility__ot_8cpp.html#a45e8791d885dbc2edb764dc4f735ada3">00349</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="ot__utility__ot_8hpp.html#ac6ca2dbb5cd14f9620b00eae3cabfa56">InterpretTransactionMsgReply</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; SERVER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; USER_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; ACCOUNT_ID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strAttempt, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strResponse)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351     int32_t nMessageSuccess = <a class="code" href="ot__utility__ot_8hpp.html#afdbf3b63181963189d5f77bfd70bbb13">VerifyMessageSuccess</a>(strResponse);
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (-1 == nMessageSuccess)
<a name="l00353"></a>00353     {
<a name="l00354"></a>00354         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Message error: &quot;</span> + strAttempt + <span class="stringliteral">&quot;.\n&quot;</span>);
<a name="l00355"></a>00355         <span class="keywordflow">return</span> -1;
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (0 == nMessageSuccess)
<a name="l00358"></a>00358     {
<a name="l00359"></a>00359         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Server reply (&quot;</span> + strAttempt + <span class="stringliteral">&quot;): Message failure.\n&quot;</span>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="keywordflow">return</span> 0;
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     int32_t nBalanceSuccess = <a class="code" href="ot__utility__ot_8hpp.html#af9277b00455b6e760011dd7b597761aa">VerifyMsgBalanceAgrmntSuccess</a>(SERVER_ID, USER_ID, ACCOUNT_ID, strResponse);
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (-1 == nBalanceSuccess)
<a name="l00366"></a>00366     {
<a name="l00367"></a>00367         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Balance agreement error: &quot;</span> + strAttempt + <span class="stringliteral">&quot;.\n&quot;</span>);
<a name="l00368"></a>00368         <span class="keywordflow">return</span> -1;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (0 == nBalanceSuccess)
<a name="l00371"></a>00371     {
<a name="l00372"></a>00372         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Server reply (&quot;</span> + strAttempt + <span class="stringliteral">&quot;): Balance agreement failure.\n&quot;</span>);
<a name="l00373"></a>00373         <span class="keywordflow">return</span> 0;
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     int32_t nTransSuccess = <a class="code" href="ot__utility__ot_8hpp.html#a711f019ab74c4afbe71dc745957bd98f">VerifyMsgTrnxSuccess</a>(SERVER_ID, USER_ID, ACCOUNT_ID, strResponse);
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (-1 == nTransSuccess)
<a name="l00378"></a>00378     {
<a name="l00379"></a>00379         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Transaction error: &quot;</span> + strAttempt + <span class="stringliteral">&quot;.\n&quot;</span>);
<a name="l00380"></a>00380         <span class="keywordflow">return</span> -1;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (0 == nTransSuccess)
<a name="l00383"></a>00383     {
<a name="l00384"></a>00384         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;Server reply (&quot;</span> + strAttempt + <span class="stringliteral">&quot;): Transaction failure.\n&quot;</span>);
<a name="l00385"></a>00385         <span class="keywordflow">return</span> 0;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="keywordflow">return</span> 1;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 
<a name="l00394"></a>00394 <span class="comment">//</span>
<a name="l00395"></a>00395 <span class="comment">//OT_UTILITY_OT int32_t ifB(the_expression, X, Y)</span>
<a name="l00396"></a>00396 <span class="comment">//{</span>
<a name="l00397"></a>00397 <span class="comment">//    if (!(VerifyBoolVal(the_expression)))</span>
<a name="l00398"></a>00398 <span class="comment">//    {</span>
<a name="l00399"></a>00399 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ifB: ERROR: SHOULD NEVER HAPPEN: the_expression isn&#39;t a boolean.\n&quot;);</span>
<a name="l00400"></a>00400 <span class="comment">//        exit(-1)</span>
<a name="l00401"></a>00401 <span class="comment">//    }</span>
<a name="l00402"></a>00402 <span class="comment">//    // --------------------</span>
<a name="l00403"></a>00403 <span class="comment">//    var theReturnValue</span>
<a name="l00404"></a>00404 <span class="comment">//</span>
<a name="l00405"></a>00405 <span class="comment">//    if (the_expression)</span>
<a name="l00406"></a>00406 <span class="comment">//    {</span>
<a name="l00407"></a>00407 <span class="comment">//        theReturnValue = X;</span>
<a name="l00408"></a>00408 <span class="comment">//    }</span>
<a name="l00409"></a>00409 <span class="comment">//    else</span>
<a name="l00410"></a>00410 <span class="comment">//    {</span>
<a name="l00411"></a>00411 <span class="comment">//        theReturnValue = Y;</span>
<a name="l00412"></a>00412 <span class="comment">//    }</span>
<a name="l00413"></a>00413 <span class="comment">//</span>
<a name="l00414"></a>00414 <span class="comment">//    // Returning...</span>
<a name="l00415"></a>00415 <span class="comment">//    //</span>
<a name="l00416"></a>00416 <span class="comment">//</span>
<a name="l00417"></a>00417 <span class="comment">//    return theReturnValue;</span>
<a name="l00418"></a>00418 <span class="comment">//</span>
<a name="l00419"></a>00419 <span class="comment">//}</span>
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="comment">// ********************************************************************************</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="comment">//attr OTfourbool::one</span>
<a name="l00424"></a>00424 <span class="comment">//attr OTfourbool::two</span>
<a name="l00425"></a>00425 <span class="comment">//attr OTfourbool::three</span>
<a name="l00426"></a>00426 <span class="comment">//attr OTfourbool::four</span>
<a name="l00427"></a>00427 <span class="comment">//</span>
<a name="l00429"></a>00429 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTfourbool::OTfourbool()</span>
<a name="l00430"></a>00430 <span class="comment">//{</span>
<a name="l00431"></a>00431 <span class="comment">//    one = false;</span>
<a name="l00432"></a>00432 <span class="comment">//    two = false;</span>
<a name="l00433"></a>00433 <span class="comment">//    three = false;</span>
<a name="l00434"></a>00434 <span class="comment">//    four = false;</span>
<a name="l00435"></a>00435 <span class="comment">//}</span>
<a name="l00437"></a>00437 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTfourbool::OTfourbool(param_one, param_two, param_three, param_four)</span>
<a name="l00438"></a>00438 <span class="comment">//{</span>
<a name="l00439"></a>00439 <span class="comment">//    if (!VerifyBoolVal(param_one) || !VerifyBoolVal(param_two) || !VerifyBoolVal(param_three) || !VerifyBoolVal(param_four))</span>
<a name="l00440"></a>00440 <span class="comment">//    {</span>
<a name="l00441"></a>00441 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-boolean passed to OTfourbool constructor!\n&quot;);</span>
<a name="l00442"></a>00442 <span class="comment">//    }</span>
<a name="l00443"></a>00443 <span class="comment">//    one = param_one;</span>
<a name="l00444"></a>00444 <span class="comment">//    two = param_two;</span>
<a name="l00445"></a>00445 <span class="comment">//    three = param_three;</span>
<a name="l00446"></a>00446 <span class="comment">//    four = param_four;</span>
<a name="l00447"></a>00447 <span class="comment">//}</span>
<a name="l00448"></a>00448 
<a name="l00450"></a>00450 <span class="comment">//</span>
<a name="l00451"></a>00451 <span class="comment">//attr OTBool::value</span>
<a name="l00452"></a>00452 <span class="comment">//attr OTBool::value2</span>
<a name="l00453"></a>00453 <span class="comment">//</span>
<a name="l00455"></a>00455 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::OTBool()</span>
<a name="l00456"></a>00456 <span class="comment">//{</span>
<a name="l00457"></a>00457 <span class="comment">//    value = false;</span>
<a name="l00458"></a>00458 <span class="comment">//    value2 = false;</span>
<a name="l00459"></a>00459 <span class="comment">//}</span>
<a name="l00461"></a>00461 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::OTBool(param_value)</span>
<a name="l00462"></a>00462 <span class="comment">//{</span>
<a name="l00463"></a>00463 <span class="comment">//    if (!VerifyBoolVal(param_value))</span>
<a name="l00464"></a>00464 <span class="comment">//    {</span>
<a name="l00465"></a>00465 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-boolean passed to OTBool constructor!\n&quot;);</span>
<a name="l00466"></a>00466 <span class="comment">//    }</span>
<a name="l00467"></a>00467 <span class="comment">//    value = param_value;</span>
<a name="l00468"></a>00468 <span class="comment">//    value2 = false;</span>
<a name="l00469"></a>00469 <span class="comment">//}</span>
<a name="l00471"></a>00471 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::getBooleanValue()</span>
<a name="l00472"></a>00472 <span class="comment">//{</span>
<a name="l00473"></a>00473 <span class="comment">//</span>
<a name="l00474"></a>00474 <span class="comment">//    return value;</span>
<a name="l00475"></a>00475 <span class="comment">//</span>
<a name="l00476"></a>00476 <span class="comment">//}</span>
<a name="l00478"></a>00478 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::setBooleanValue(param_value)</span>
<a name="l00479"></a>00479 <span class="comment">//{</span>
<a name="l00480"></a>00480 <span class="comment">//    if (!VerifyBoolVal(param_value))</span>
<a name="l00481"></a>00481 <span class="comment">//    {</span>
<a name="l00482"></a>00482 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-boolean passed to OTBool::setBooleanValue!\n&quot;);</span>
<a name="l00483"></a>00483 <span class="comment">//    }</span>
<a name="l00484"></a>00484 <span class="comment">//    value = param_value;</span>
<a name="l00485"></a>00485 <span class="comment">//}</span>
<a name="l00487"></a>00487 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::getSecondValue()</span>
<a name="l00488"></a>00488 <span class="comment">//{</span>
<a name="l00489"></a>00489 <span class="comment">//</span>
<a name="l00490"></a>00490 <span class="comment">//    return value2;</span>
<a name="l00491"></a>00491 <span class="comment">//</span>
<a name="l00492"></a>00492 <span class="comment">//}</span>
<a name="l00494"></a>00494 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTBool::setSecondValue(param_value)</span>
<a name="l00495"></a>00495 <span class="comment">//{</span>
<a name="l00496"></a>00496 <span class="comment">//    if (!VerifyBoolVal(param_value))</span>
<a name="l00497"></a>00497 <span class="comment">//    {</span>
<a name="l00498"></a>00498 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-boolean passed to OTBool::setSecondValue!\n&quot;);</span>
<a name="l00499"></a>00499 <span class="comment">//    }</span>
<a name="l00500"></a>00500 <span class="comment">//    value2 = param_value;</span>
<a name="l00501"></a>00501 <span class="comment">//}</span>
<a name="l00502"></a>00502 <span class="comment">//</span>
<a name="l00504"></a>00504 <span class="comment"></span><span class="comment">//</span>
<a name="l00505"></a>00505 <span class="comment">//attr OTInteger::value</span>
<a name="l00506"></a>00506 <span class="comment">//</span>
<a name="l00508"></a>00508 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTInteger::OTInteger()</span>
<a name="l00509"></a>00509 <span class="comment">//{</span>
<a name="l00510"></a>00510 <span class="comment">//    value = 0;</span>
<a name="l00511"></a>00511 <span class="comment">//}</span>
<a name="l00513"></a>00513 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTInteger::OTInteger(param_value)</span>
<a name="l00514"></a>00514 <span class="comment">//{</span>
<a name="l00515"></a>00515 <span class="comment">//    if (!VerifyIntVal(param_value))</span>
<a name="l00516"></a>00516 <span class="comment">//    {</span>
<a name="l00517"></a>00517 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-integer passed to OTInteger constructor!\n&quot;);</span>
<a name="l00518"></a>00518 <span class="comment">//    }</span>
<a name="l00519"></a>00519 <span class="comment">//    value = param_value;</span>
<a name="l00520"></a>00520 <span class="comment">//}</span>
<a name="l00522"></a>00522 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTInteger::getIntegerValue()</span>
<a name="l00523"></a>00523 <span class="comment">//{</span>
<a name="l00524"></a>00524 <span class="comment">//    // Returning...</span>
<a name="l00525"></a>00525 <span class="comment">//    //</span>
<a name="l00526"></a>00526 <span class="comment">//</span>
<a name="l00527"></a>00527 <span class="comment">//    return value;</span>
<a name="l00528"></a>00528 <span class="comment">//</span>
<a name="l00529"></a>00529 <span class="comment">//}</span>
<a name="l00531"></a>00531 <span class="comment"></span><span class="comment">//OT_UTILITY_OT int32_t OTInteger::setIntegerValue(param_value)</span>
<a name="l00532"></a>00532 <span class="comment">//{</span>
<a name="l00533"></a>00533 <span class="comment">//    if (!VerifyIntVal(param_value))</span>
<a name="l00534"></a>00534 <span class="comment">//    {</span>
<a name="l00535"></a>00535 <span class="comment">//        OTAPI_Wrap::Output(0, &quot;ERROR: Non-integer passed to OTInteger::setIntegerValue!\n&quot;);</span>
<a name="l00536"></a>00536 <span class="comment">//    }</span>
<a name="l00537"></a>00537 <span class="comment">//    value = param_value;</span>
<a name="l00538"></a>00538 <span class="comment">//}</span>
<a name="l00540"></a>00540 <span class="comment"></span>
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="class_utility.html#ac7af3e1642ac8d53ef180180a08fbd00">00542</a> <a class="code" href="class_utility.html#ac7af3e1642ac8d53ef180180a08fbd00">Utility::Utility</a>()
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544     <a class="code" href="class_utility.html#a00936996be8e795003e5e57149446114">strLastReplyReceived</a> = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00545"></a>00545     <a class="code" href="class_utility.html#a55f9ff8ceb056a8fe95ec1ed5e4e3399">delay_ms</a> = 50;
<a name="l00546"></a>00546     <a class="code" href="class_utility.html#abf88910f56716fb9ddf3c991af073216">max_trans_dl</a> = 10; <span class="comment">// Number of transactions I download when I&#39;m low. (Also, when I&#39;m low is when I&#39;m below this number.)</span>
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 
<a name="l00549"></a><a class="code" href="class_utility.html#aecfe4b31e39b00555158a2d8288b874a">00549</a> <a class="code" href="class_utility.html#aecfe4b31e39b00555158a2d8288b874a">Utility::~Utility</a>()
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a><a class="code" href="class_utility.html#aca01f3986c5d18f3490c6950a3ebc894">00553</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">void</span> <a class="code" href="class_utility.html#aca01f3986c5d18f3490c6950a3ebc894">Utility::delay</a>()
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <a class="code" href="class_o_t_a_p_i___wrap.html#ae71d4d649f0cd1929a48f9092d505e10">OTAPI_Wrap::Sleep</a>(<a class="code" href="class_utility.html#a55f9ff8ceb056a8fe95ec1ed5e4e3399">delay_ms</a>);
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a><a class="code" href="class_utility.html#a680b0d0873c6d28cfd5b91de4e30c6b1">00558</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">void</span> <a class="code" href="class_utility.html#a680b0d0873c6d28cfd5b91de4e30c6b1">Utility::longDelay</a>()
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560     <a class="code" href="class_o_t_a_p_i___wrap.html#ae71d4d649f0cd1929a48f9092d505e10">OTAPI_Wrap::Sleep</a>(<a class="code" href="class_utility.html#a55f9ff8ceb056a8fe95ec1ed5e4e3399">delay_ms</a> + 200);
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a><a class="code" href="class_utility.html#a7443cfaae100f819537e97fbad964b93">00563</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a7443cfaae100f819537e97fbad964b93">Utility::getNbrTransactionCount</a>()
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#abf88910f56716fb9ddf3c991af073216">max_trans_dl</a>;
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="class_utility.html#a86d6326e062a59eca23cf597a8a11900">00568</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">void</span> <a class="code" href="class_utility.html#a86d6326e062a59eca23cf597a8a11900">Utility::setNbrTransactionCount</a>(int32_t new_trans_dl)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570     <a class="code" href="class_utility.html#abf88910f56716fb9ddf3c991af073216">max_trans_dl</a> = new_trans_dl;
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00573"></a><a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">00573</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">string</span> <a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">Utility::getLastReplyReceived</a>()
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#a00936996be8e795003e5e57149446114">strLastReplyReceived</a>;
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a><a class="code" href="class_utility.html#ab5bdca5dc8f916c2daa50c791ffcdfb1">00578</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">void</span> <a class="code" href="class_utility.html#ab5bdca5dc8f916c2daa50c791ffcdfb1">Utility::setLastReplyReceived</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; strReply)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580     <a class="code" href="class_utility.html#a00936996be8e795003e5e57149446114">strLastReplyReceived</a> = strReply;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
<a name="l00584"></a><a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">00584</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">Utility::getNymboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586     <span class="keywordtype">bool</span> bWasSent = <span class="keyword">false</span>;
<a name="l00587"></a>00587     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">getNymboxLowLevel</a>(serverID, nymID, bWasSent);
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="comment">// This returns -1 if error, or a positive request number if it was sent.</span>
<a name="l00592"></a>00592 <span class="comment">// (It cannot return 0;</span>
<a name="l00593"></a>00593 <span class="comment">// Called by getAndProcessNymbox.</span>
<a name="l00594"></a>00594 <span class="comment">//</span>
<a name="l00595"></a><a class="code" href="class_utility.html#af74d4659949c99e1fd86bbc69f8a1697">00595</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">Utility::getNymboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasSent)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getNymboxLowLevel&quot;</span>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l00600"></a>00600     bWasSent = <span class="keyword">false</span>;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     int32_t nRequestNum = <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">OTAPI_Wrap::getNymbox</a>(serverID, nymID); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (-2 == nRequestNum)
<a name="l00604"></a>00604     {
<a name="l00605"></a>00605         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l00606"></a>00606         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.);</span>
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l00609"></a>00609     {
<a name="l00610"></a>00610         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getNymbox message due to error.\n&quot;</span>);
<a name="l00611"></a>00611         <span class="keywordflow">return</span> -1;
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l00614"></a>00614     {
<a name="l00615"></a>00615         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpectedly returned 0. Didn&#39;t send getNymbox message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l00616"></a>00616         <span class="keywordflow">return</span> -1; <span class="comment">// Even though &#39;0&#39; MEANS &quot;didn&#39;t send, but no error&quot; by convention in many places, it is actually an impossible return value;</span>
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l00619"></a>00619     {
<a name="l00620"></a>00620         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00621"></a>00621         <span class="keywordflow">return</span> -1;
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     bWasSent = <span class="keyword">true</span>;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <span class="comment">// ***************************************************</span>
<a name="l00627"></a>00627     <span class="comment">//</span>
<a name="l00628"></a>00628     int32_t nResult = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, strLocation);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="comment">//      OTAPI_Wrap::Output(0, strLocation + &quot;: receiveReplySuccessLowLevel: &quot; + nResult + &quot;\n&quot;);</span>
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="comment">// BY this point, we definitely have the request number in nResult, which means</span>
<a name="l00633"></a>00633     <span class="comment">// the message was actually SENT. (At least.) This also means we can use nResult</span>
<a name="l00634"></a>00634     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l00635"></a>00635     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l00636"></a>00636     <span class="comment">//</span>
<a name="l00637"></a>00637     <span class="comment">// THE REMOVE SENT MESSAGE BELOW FAILS, LIKE IT&#39;S ALREADY GONE.</span>
<a name="l00638"></a>00638     <span class="comment">//</span>
<a name="l00639"></a>00639     <span class="comment">// THIS MUST BE DUE TO THE PROCESS SERVER REPLY THAT OCCURS **IMMEDIATELY** after the message was originally sent!</span>
<a name="l00640"></a>00640     <span class="comment">// (The reply came in and was sent to OT&#39;s &quot;ProcessServerReply&quot;, INSIDE the call to getNymbox.)</span>
<a name="l00641"></a>00641     <span class="comment">// Our subsequent &quot;receive&quot; (above) is nothing of the sort, but actually pops the incoming message buffer where</span>
<a name="l00642"></a>00642     <span class="comment">// the server&#39;s reply was ALREADY SITTING, since it was put there in OT&#39;s &quot;ProcessServerReply&quot;, WHICH REMOVED THE</span>
<a name="l00643"></a>00643     <span class="comment">// SENT MESSAGE ALREADY (that&#39;s why the below call to RemoveSentMessage fails.)</span>
<a name="l00644"></a>00644     <span class="comment">//</span>
<a name="l00645"></a>00645     <span class="comment">// RETHINK any logic that doesn&#39;t take this into account,.</span>
<a name="l00646"></a>00646     <span class="comment">// Either we REMOVE this call wherever this happens, OR... we call Get first and make sure whether it&#39;s</span>
<a name="l00647"></a>00647     <span class="comment">// there, THEN remove it. But we can&#39;t be lumping &quot;Failure because it&#39;s gone&quot; versus &quot;Error state&quot; by mixing</span>
<a name="l00648"></a>00648     <span class="comment">// 0 and -1 here. We need to differentiate.</span>
<a name="l00649"></a>00649     <span class="comment">//</span>
<a name="l00650"></a>00650     <span class="comment">// Bottom line: if the reply WAS received, then the original sent message has ALREADY been removed</span>
<a name="l00651"></a>00651     <span class="comment">// from the sent buffer. Whereas if the reply was NOT received, then the sent message is still there,</span>
<a name="l00652"></a>00652     <span class="comment">// but in that case, we do NOT want to remove it -- we want it to STAY in the sent buffer, so that</span>
<a name="l00653"></a>00653     <span class="comment">// when we get the Nymbox later and we DO have the reply from that, THEN we can remove the sent msg from</span>
<a name="l00654"></a>00654     <span class="comment">// the sent buffer. Until then, we don&#39;t want OT to think it&#39;s already been processed (which it will, if</span>
<a name="l00655"></a>00655     <span class="comment">// it&#39;s already been removed from the sent buffer. So we leave it there for now.)</span>
<a name="l00656"></a>00656     <span class="comment">//</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="comment">//      int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(to_string(nRequestNum), serverID, nymID);</span>
<a name="l00659"></a>00659     <span class="comment">//</span>
<a name="l00660"></a>00660     <span class="comment">//      if (nRemovedSentMsg &lt; 1)</span>
<a name="l00661"></a>00661     <span class="comment">//      {</span>
<a name="l00662"></a>00662     <span class="comment">//          OTAPI_Wrap::Output(0, strLocation + &quot;: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedSentMsg + &quot;\n&quot;);</span>
<a name="l00663"></a>00663     <span class="comment">//      }</span>
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">if</span> (1 == nResult)
<a name="l00666"></a>00666     {
<a name="l00667"></a>00667         <span class="keywordflow">return</span> nRequestNum;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="keywordflow">return</span> nResult;
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 
<a name="l00674"></a><a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">00674</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">Utility::getNymbox</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l00677"></a>00677     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">getNymbox</a>(serverID, nymID, bForceDownload);
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 
<a name="l00681"></a><a class="code" href="class_utility.html#a75bf919d2c853c9002605a15f9a032c0">00681</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">Utility::getNymbox</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getNymbox&quot;</span>;
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="keywordtype">string</span> strRecentHash = <a class="code" href="class_o_t_a_p_i___wrap.html#ae8d17b61c08e6fb661f1f44ddad49fc7">OTAPI_Wrap::GetNym_RecentHash</a>(serverID, nymID);
<a name="l00686"></a>00686     <span class="keywordtype">bool</span> bRecentHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strRecentHash);
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (!bRecentHash)
<a name="l00688"></a>00688     {
<a name="l00689"></a>00689         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve recent cached copy of server-side NymboxHash from client-side nym (perhaps he&#39;s never downloaded it before?)\n\n&quot;</span>);
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <span class="keywordtype">string</span> strLocalHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a17de0af836994eb5d28f9e843ffde769">OTAPI_Wrap::GetNym_NymboxHash</a>(serverID, nymID);
<a name="l00693"></a>00693     <span class="keywordtype">bool</span> bLocalHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLocalHash);
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (!bLocalHash)
<a name="l00695"></a>00695     {
<a name="l00696"></a>00696         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve client-side NymboxHash for:\n serverID: &quot;</span> + serverID + <span class="stringliteral">&quot;\n nymID: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="keywordflow">if</span> (!bForceDownload)
<a name="l00700"></a>00700     {
<a name="l00701"></a>00701         <span class="keywordflow">if</span> (bLocalHash  &amp;&amp; bRecentHash &amp;&amp; (strRecentHash == strLocalHash)) <span class="comment">// the hashes match -- no need to download anything.</span>
<a name="l00702"></a>00702         {
<a name="l00703"></a>00703             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: The hashes already match (skipping Nymbox download.)\n&quot;</span>);
<a name="l00704"></a>00704             <span class="keywordflow">return</span> 1;
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">// -- SECTION 1: &quot;GET NYMBOX&quot;</span>
<a name="l00709"></a>00709     <span class="comment">//</span>
<a name="l00710"></a>00710     <span class="keywordtype">bool</span> bWasMsgSent = <span class="keyword">false</span>;
<a name="l00711"></a>00711     int32_t nGetNymbox = <a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">getNymboxLowLevel</a>(serverID, nymID, bWasMsgSent); <span class="comment">// bWasMsgSent is output from this call.;</span>
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (bWasMsgSent)
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: FYI: we just sent a getNymboxLowLevel msg. RequestNum: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (!(bWasMsgSent) || ((nGetNymbox &lt;= 0) &amp;&amp; (-1 != nGetNymbox)))
<a name="l00718"></a>00718     {
<a name="l00719"></a>00719         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: this.getNymboxLowLevel returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00720"></a>00720         <span class="keywordflow">return</span> -1;
<a name="l00721"></a>00721     }   <span class="comment">// NOTE: for getNymbox, there is no &#39;0&#39; return value;</span>
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (-1 == nGetNymbox) <span class="comment">// we&#39;ll try re-syncing the request number, then try again.</span>
<a name="l00724"></a>00724     {
<a name="l00725"></a>00725         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: this.getNymboxLowLevel returned -1. (Re-trying...)\n&quot;</span>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         int32_t nGetRequest = <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID);
<a name="l00728"></a>00728         <span class="keywordflow">if</span> (1 != nGetRequest)
<a name="l00729"></a>00729         {
<a name="l00730"></a>00730             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: this.getNymboxLowLevel failed, then I tried to resync with this.getRequestNumber and then that failed too. (I give up.)\n&quot;</span>);
<a name="l00731"></a>00731             <span class="keywordflow">return</span> -1;
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         <span class="keywordtype">string</span> <a class="code" href="class_utility.html#a00936996be8e795003e5e57149446114">strLastReplyReceived</a> = <a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">getLastReplyReceived</a>();
<a name="l00735"></a>00735         <span class="comment">// I had to do this bit because getRequestNumber doesn&#39;t return the</span>
<a name="l00736"></a>00736         <span class="comment">// reply itself. But in this case, I needed it.</span>
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLastReplyReceived)) <span class="comment">// THIS SHOULD NEVER HAPPEN.</span>
<a name="l00738"></a>00738         {
<a name="l00739"></a>00739             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR in getLastReplyReceived(): why was this string not set, when this.getRequestNumber was otherwise an apparent success?\n&quot;</span>);
<a name="l00740"></a>00740             <span class="keywordflow">return</span> -1; <span class="comment">// (SHOULD NEVER HAPPEN. This string is set in the getRequestNumber function.)</span>
<a name="l00741"></a>00741         }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743         <span class="comment">// BY THIS POINT, we have received a server reply:  @getRequest</span>
<a name="l00744"></a>00744         <span class="comment">// (Unless it is malformed.) It&#39;s definitely not null, nor empty.</span>
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         <span class="comment">// Grab the NymboxHash on the @getRequest reply, and also the one I</span>
<a name="l00747"></a>00747         <span class="comment">// already had on my client-side Nym... (So we can compare them.)</span>
<a name="l00748"></a>00748         <span class="comment">//</span>
<a name="l00749"></a>00749         <span class="comment">//      If the hashes do NOT match, then I DO need to download nymbox and box receipts.</span>
<a name="l00750"></a>00750         <span class="comment">/*</span>
<a name="l00751"></a>00751 <span class="comment">        *      ===&gt; If the NymboxHash is changed from what I expected, then I need to re-download the</span>
<a name="l00752"></a>00752 <span class="comment">        *      nymbox (and any box receipts I don&#39;t already have.)</span>
<a name="l00753"></a>00753 <span class="comment">        *</span>
<a name="l00754"></a>00754 <span class="comment">        *      Then I need to process the Nymbox. But first, see if my missing server reply is in there.</span>
<a name="l00755"></a>00755 <span class="comment">        *      If it is, then I have the server reply! (As if we had succeeded in the first place!!)</span>
<a name="l00756"></a>00756 <span class="comment">        *      Next, process the Nymbox (which processes that reply) and then return strReply;</span>
<a name="l00757"></a>00757 <span class="comment">        *</span>
<a name="l00758"></a>00758 <span class="comment">        *      (Clearly this is just going to be a normal part of the getRequest syncronization.)</span>
<a name="l00759"></a>00759 <span class="comment">        *</span>
<a name="l00760"></a>00760 <span class="comment">        *      By the time that much is done, I will KNOW the request number, the nymbox, the box receipts,</span>
<a name="l00761"></a>00761 <span class="comment">        *      etc are ALL syncronized properly, and that I THEN processed the Nymbox successfully.</span>
<a name="l00762"></a>00762 <span class="comment">        *</span>
<a name="l00763"></a>00763 <span class="comment">        *</span>
<a name="l00764"></a>00764 <span class="comment">        *      NOTICE: In this example I do NOT want to pull out my sent message from the outbuffer (using</span>
<a name="l00765"></a>00765 <span class="comment">        *      the request number) and try to harvest all the transaction numbers. Why not? Because possibly the</span>
<a name="l00766"></a>00766 <span class="comment">        *      server DID reply! And if I processed that reply properly, it would sync my transaction numbers</span>
<a name="l00767"></a>00767 <span class="comment">        *      properly just from that! ===&gt;</span>
<a name="l00768"></a>00768 <span class="comment">        *</span>
<a name="l00769"></a>00769 <span class="comment">        *      ===&gt; Therefore, I need to see FIRST if the old message has a reply WAITING in the Nymbox. THEN</span>
<a name="l00770"></a>00770 <span class="comment">        *      I need to process the Nymbox. ONLY if the reply wasn&#39;t there, can I THEN pull out the message</span>
<a name="l00771"></a>00771 <span class="comment">        *      from my outbuffer and harvest it. (Which I am reticent to do, until I am SURE the server</span>
<a name="l00772"></a>00772 <span class="comment">        *      really never saw that message in the first place.)</span>
<a name="l00773"></a>00773 <span class="comment">        *</span>
<a name="l00774"></a>00774 <span class="comment">        *      However, as long as my NymboxHash hasn&#39;t changed, then I&#39;m safe! But if it HAS changed,</span>
<a name="l00775"></a>00775 <span class="comment">        *      then I HAVE to A. download it B. SEE if the reply is there for the request number, then</span>
<a name="l00776"></a>00776 <span class="comment">        *      C. process it. ... If the reply wasn&#39;t there, THEN Harvest the transaction #s (for transaction</span>
<a name="l00777"></a>00777 <span class="comment">        *      messages) and then re-try.</span>
<a name="l00778"></a>00778 <span class="comment">        */</span>
<a name="l00779"></a>00779 
<a name="l00780"></a>00780         <span class="comment">// Grabbing again in case it&#39;s changed.</span>
<a name="l00781"></a>00781         <span class="keywordtype">string</span> strServerHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a42803f459dcf9ecc1c3ee4bccf917746">OTAPI_Wrap::Message_GetNymboxHash</a>(strLastReplyReceived);
<a name="l00782"></a>00782         <span class="keywordtype">bool</span> bServerHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strServerHash);
<a name="l00783"></a>00783         <span class="keywordflow">if</span> (!bServerHash)
<a name="l00784"></a>00784         {
<a name="l00785"></a>00785             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve server-side NymboxHash from server @getRequest reply:\n\n&quot;</span> + strLastReplyReceived + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         strLocalHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a17de0af836994eb5d28f9e843ffde769">OTAPI_Wrap::GetNym_NymboxHash</a>(serverID, nymID);
<a name="l00789"></a>00789         bLocalHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLocalHash);
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (!bLocalHash)
<a name="l00791"></a>00791         {
<a name="l00792"></a>00792             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning(2): Unable to retrieve client-side NymboxHash for:\n serverID: &quot;</span> + serverID + <span class="stringliteral">&quot;\n nymID: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         <span class="comment">// The hashes don&#39;t match -- so let&#39;s definitely re-try to download the latest nymbox.</span>
<a name="l00796"></a>00796         <span class="keywordflow">if</span> (bForceDownload || !bLocalHash || !bServerHash || (bServerHash &amp;&amp; bLocalHash &amp;&amp; !(strServerHash == strLocalHash)))
<a name="l00797"></a>00797         {
<a name="l00798"></a>00798             <span class="comment">// the getRequest worked, and the server hashes don&#39;t match,</span>
<a name="l00799"></a>00799             <span class="comment">// so let&#39;s try the call again...</span>
<a name="l00800"></a>00800 
<a name="l00801"></a>00801             nGetNymbox = <a class="code" href="class_utility.html#acba161d25f6c8fd3cb0e459797eca6fb">getNymboxLowLevel</a>(serverID, nymID, bWasMsgSent);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803             <span class="keywordflow">if</span> (!(bWasMsgSent) || ((nGetNymbox &lt;= 0) &amp;&amp; (-1 != nGetNymbox)))
<a name="l00804"></a>00804             {
<a name="l00805"></a>00805                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure(2): this.getNymboxLowLevel returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00806"></a>00806                 <span class="keywordflow">return</span> -1;
<a name="l00807"></a>00807             }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             <span class="keywordflow">if</span> (-1 == nGetNymbox) <span class="comment">// we&#39;ll try re-syncing the request number, then try again.</span>
<a name="l00810"></a>00810             {
<a name="l00811"></a>00811                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: this.getNymboxLowLevel returned -1, even after syncing the request number successfully. (Giving up.)\n&quot;</span>);
<a name="l00812"></a>00812                 <span class="keywordflow">return</span> -1;
<a name="l00813"></a>00813             }
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815     }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="comment">// By this point, we DEFINITELY know that the Nymbox was retrieved successfully.</span>
<a name="l00818"></a>00818     <span class="comment">// (With request number nGetNymbox.) This is because the getNymboxLowLevel() call</span>
<a name="l00819"></a>00819     <span class="comment">// also tries to receive the reply, so we already know by now whether the reply</span>
<a name="l00820"></a>00820     <span class="comment">// was successfully received.</span>
<a name="l00821"></a>00821     <span class="comment">//</span>
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="keywordflow">return</span> nGetNymbox;
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 
<a name="l00827"></a>00827 <span class="comment">// NEW ONES:</span>
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 <span class="comment">//public static int32_t getAndProcessNymbox(String serverID, String nymID, OTBool bWasMsgSent, boolean bForceDownload,</span>
<a name="l00831"></a>00831 <span class="comment">//                                      var nRequestNumber, // nRequestNumber refers to a PREVIOUS msg (like a cash withdrawal) that had an error and then called this while trying to resync. (The caller will want to know whether it was found in the Nymbox.)</span>
<a name="l00832"></a>00832 <span class="comment">//                                      OTBool bFoundNymboxItem,  // bFoundNymboxItem is OUTPUT bool, telling caller whether it was found.</span>
<a name="l00833"></a>00833 <span class="comment">//                                      boolean bHarvestingForRetry, // bHarvestingForRetry is INPUT, in the case nRequestNumber needs to be harvested before a flush occurs.</span>
<a name="l00834"></a>00834 <span class="comment">//                                      boolean bMsgReplySuccess,    // bMsgReplySuccess is INPUT, and is in case nRequestNumber needs to be HARVESTED before a FLUSH happens.</span>
<a name="l00835"></a>00835 <span class="comment">//                                      boolean bMsgReplyFailure,    // bMsgReplyFailure is INPUT, and is in case nRequestNumber needs to be HARVESTED before a FLUSH happens.</span>
<a name="l00836"></a>00836 <span class="comment">//                                      boolean bMsgTransSuccess,    // bMsgTransSuccess is INPUT, and is in case nRequestNumber needs to be HARVESTED before a FLUSH happens.</span>
<a name="l00837"></a>00837 <span class="comment">//                                      boolean bMsgTransFailure)    // bMsgTransFailure is INPUT, and is in case nRequestNumber needs to be HARVESTED before a FLUSH happens.</span>
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="comment">//def Utility::getAndProcessNymbox_8(serverID, nymID, bWasMsgSent, // bWasMsgSent is OUTPUT.</span>
<a name="l00840"></a>00840 <span class="comment">//                                   bForceDownload,       // INPUT</span>
<a name="l00841"></a>00841 <span class="comment">//                                   nRequestNumber,       // nRequestNumber refers to a PREVIOUS msg (like a cash withdrawal) that had an error and then called this while trying to resync. (The caller will want to know whether it was found in the Nymbox.)</span>
<a name="l00842"></a>00842 <span class="comment">//                                   bFoundNymboxItem,     // bFoundNymboxItem is OUTPUT bool, telling caller whether it was found.</span>
<a name="l00843"></a>00843 <span class="comment">//                                   bHarvestingForRetry,  // bHarvestingForRetry is INPUT, in the case nRequestNumber needs to be harvested before a flush occurs.</span>
<a name="l00844"></a>00844 <span class="comment">//                                   bMsgFoursome) // OTfourbool class, used to reduce the number of parameters here, which I am suspicious that ChaiScript cannot handle.</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 <span class="comment">// Returns:</span>
<a name="l00847"></a>00847 <span class="comment">//   -1 ERROR.</span>
<a name="l00848"></a>00848 <span class="comment">//    0 Nymbox was empty -- nothing done. (bWasMsgSent = false)</span>
<a name="l00849"></a>00849 <span class="comment">//    0 Transactionstatus = = server reply received (bWasMsgSent = true), but;</span>
<a name="l00850"></a>00850 <span class="comment">//      the server reply hasstatus = = FAILED. (All harvesting was subsequently successful for processNymbox).;</span>
<a name="l00851"></a>00851 <span class="comment">//    1 If the ProcessNymbox Transaction status (from the server reply) is SUCCESS,</span>
<a name="l00852"></a>00852 <span class="comment">//      then this function returns 1.</span>
<a name="l00853"></a>00853 <span class="comment">//   &gt;1 If the ProcessNymbox Transaction status (from the server reply) is &gt;1, then this function returns the</span>
<a name="l00854"></a>00854 <span class="comment">//      REQUEST NUMBER from when it was originally sent. (Harvesting was NOT performed, which is why the request</span>
<a name="l00855"></a>00855 <span class="comment">//      number is being returned, so the caller can choose what to do next.)</span>
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 <span class="comment">//def Utility::getAndProcessNymbox_8(serverID, nymID, bWasMsgSent, bForceDownload, nRequestNumber, bFoundNymboxItem, bHarvestingForRetry, bMsgFoursome)</span>
<a name="l00858"></a>00858 <span class="comment">//{</span>
<a name="l00859"></a>00859 <span class="comment">//    print(&quot;Here&#39;s the dead version!\n&quot;)</span>
<a name="l00860"></a>00860 <span class="comment">//}</span>
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="comment">//var nGetAndProcessNymbox = getAndProcessNymbox_8(serverID, nymID, bWasMsgSent, bForceDownload, nRequestNumber, bFoundNymboxItem, bHarvestingForRetry, the_foursome);</span>
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="class_utility.html#a4b80172eebe42e9d5d4b88ebfe9fbacf">00865</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a4b80172eebe42e9d5d4b88ebfe9fbacf">Utility::getAndProcessNymbox_8</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasMsgSent, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload, <span class="keyword">const</span> int32_t nRequestNumber, <span class="keywordtype">bool</span> &amp; bFoundNymboxItem, <span class="keyword">const</span> <span class="keywordtype">bool</span> bHarvestingForRetry, <span class="keyword">const</span> <a class="code" href="class_o_tfourbool.html">OTfourbool</a> &amp; bMsgFoursome)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getAndProcessNymbox&quot;</span>;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="keywordtype">bool</span> bMsgReplySuccess = <span class="keyword">false</span>;
<a name="l00870"></a>00870     <span class="keywordtype">bool</span> bMsgReplyFailure = <span class="keyword">false</span>;
<a name="l00871"></a>00871     <span class="keywordtype">bool</span> bMsgTransSuccess = <span class="keyword">false</span>;
<a name="l00872"></a>00872     <span class="keywordtype">bool</span> bMsgTransFailure = <span class="keyword">false</span>;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874     bMsgReplySuccess = bMsgFoursome.<a class="code" href="class_o_tfourbool.html#ac271a3591b0180883a25daf6e249c7b1">one</a>;
<a name="l00875"></a>00875     bMsgReplyFailure = bMsgFoursome.<a class="code" href="class_o_tfourbool.html#a911c709dda8ec4e030fbb1d3523a25d3">two</a>;
<a name="l00876"></a>00876     bMsgTransSuccess = bMsgFoursome.<a class="code" href="class_o_tfourbool.html#a71cfae65c31c57649bd860d6c0d082b7">three</a>;
<a name="l00877"></a>00877     bMsgTransFailure = bMsgFoursome.<a class="code" href="class_o_tfourbool.html#ac656fed0abc02be552d02d422e03cbba">four</a>;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a3b5867c23a08707f6b1df41d04e7d5d3">VerifyIntVal</a>(nRequestNumber))
<a name="l00880"></a>00880     {
<a name="l00881"></a>00881         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;\n\n\n\n Failed verifying nRequestNumber as an integer. \n\n\n\n\n&quot;</span>);
<a name="l00882"></a>00882         <span class="keywordflow">return</span> -1;
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (1 == nRequestNumber)
<a name="l00886"></a>00886     {
<a name="l00887"></a>00887         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: WARNING: Request Num of &#39;1&#39; was just passed in here.\n&quot;</span>);
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889 
<a name="l00892"></a>00892     <span class="comment">//if (!VerifyOTBoolRef(bWasMsgSent) || !VerifyOTBoolRef(bFoundNymboxItem))</span>
<a name="l00893"></a>00893     <span class="comment">//{</span>
<a name="l00894"></a>00894     <span class="comment">//    OTAPI_Wrap::Output(0, strLocation + &quot;: SHOULD NEVER HAPPEN!!! ASSERT!! ERROR!! FAILURE!!! PROBLEM!!!!!\n&quot;);</span>
<a name="l00895"></a>00895     <span class="comment">//    return -1;</span>
<a name="l00896"></a>00896     <span class="comment">//}</span>
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     bWasMsgSent = <span class="keyword">false</span>;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="comment">// what is nRequestNumber?</span>
<a name="l00901"></a>00901     <span class="comment">//</span>
<a name="l00902"></a>00902     <span class="comment">// Let&#39;s say a message, say for a cash withdrawal with request number 5, has FAILED.</span>
<a name="l00903"></a>00903     <span class="comment">// Since the message failed, perhaps the request number was out of sync, or Nymbox hash</span>
<a name="l00904"></a>00904     <span class="comment">// was old? So, let&#39;s say that it then sent a getRequest message, in order to resync,</span>
<a name="l00905"></a>00905     <span class="comment">// and discovered that the Nymbox hash has changed. Therefore the Nymbox is now being</span>
<a name="l00906"></a>00906     <span class="comment">// re-downloaded and processed, so that the cash withdrawal can be attempted again.</span>
<a name="l00907"></a>00907     <span class="comment">//</span>
<a name="l00908"></a>00908     <span class="comment">// HOWEVER, before we PROCESS the Nymbox, we need to see if the withdrawal reply is already</span>
<a name="l00909"></a>00909     <span class="comment">// sitting in it. Why, you ask, if the withdrawal failed, would I expect a reply to be in</span>
<a name="l00910"></a>00910     <span class="comment">// the Nymbox? In case 1, the message was dropped, so I don&#39;t know if the reply is there</span>
<a name="l00911"></a>00911     <span class="comment">// until I check the Nymbox. In case 2, the message may have failed OR SUCCEEDED, with the</span>
<a name="l00912"></a>00912     <span class="comment">// successful message containing a FAILED TRANSACTION.</span>
<a name="l00913"></a>00913     <span class="comment">// Thus, we just want to check the Nymbox for nRequestNumber, and make sure whether it&#39;s</span>
<a name="l00914"></a>00914     <span class="comment">// there or not, before we PROCESS the nymbox, because once we do THAT, it will be empty.</span>
<a name="l00915"></a>00915     <span class="comment">//</span>
<a name="l00916"></a>00916     <span class="comment">// We will return a;</span>
<a name="l00917"></a>00917     <span class="comment">// was already in the Nymbox. We can also harvest the transaction numbers from the reply</span>
<a name="l00918"></a>00918     <span class="comment">// message, if it&#39;s a transaction, so that everything is set for the re-try. (Possibly pass</span>
<a name="l00919"></a>00919     <span class="comment">// a bool parameter dictating whether the harvesting is being done for a re-try or not.)</span>
<a name="l00920"></a>00920     <span class="comment">//</span>
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="comment">// -- SECTION 1: &quot;GET NYMBOX&quot;</span>
<a name="l00924"></a>00924     <span class="comment">//</span>
<a name="l00925"></a>00925     <span class="comment">// This call is sufficiently high-level enough that it already has re-tries</span>
<a name="l00926"></a>00926     <span class="comment">// built into it. That&#39;s why you don&#39;t see me re-trying the getNymbox if it</span>
<a name="l00927"></a>00927     <span class="comment">// fails.</span>
<a name="l00928"></a>00928     <span class="comment">//</span>
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     int32_t nGetNymbox = <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">getNymbox</a>(serverID, nymID, bForceDownload);
<a name="l00931"></a>00931     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a3b5867c23a08707f6b1df41d04e7d5d3">VerifyIntVal</a>(nGetNymbox) || (nGetNymbox &lt; 1))
<a name="l00932"></a>00932     {
<a name="l00933"></a>00933         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: this.getNymbox returned: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00934"></a>00934         <span class="keywordflow">return</span> -1;
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="comment">// By this point, we DEFINITELY know that the Nymbox was retrieved successfully.</span>
<a name="l00938"></a>00938     <span class="comment">// (With request number nGetNymbox.) This is because the getNymboxLowLevel() call</span>
<a name="l00939"></a>00939     <span class="comment">// also tries to receive the reply, so we already know by now whether the reply</span>
<a name="l00940"></a>00940     <span class="comment">// was successfully received.</span>
<a name="l00941"></a>00941     <span class="comment">//</span>
<a name="l00942"></a>00942     <span class="comment">/*</span>
<a name="l00943"></a>00943 <span class="comment">    *  FYI: nRequestNumber is the request number, if &gt;0, for whatever command</span>
<a name="l00944"></a>00944 <span class="comment">    * is causing this getAndProcessNymbox to occur (like a cash withdrawal, or</span>
<a name="l00945"></a>00945 <span class="comment">    * a cheque deposit, etc.) We pass it in here so we can verify whether it&#39;s on</span>
<a name="l00946"></a>00946 <span class="comment">    * the Nymbox, before we process it out (so the caller knows whether to clawback.)</span>
<a name="l00947"></a>00947 <span class="comment">    *</span>
<a name="l00948"></a>00948 <span class="comment">    * FYI: nGetNymbox is the request number from getNymboxLowLevel() (above.) We</span>
<a name="l00949"></a>00949 <span class="comment">    * know for a FACT, by this point, this number is &gt;0.</span>
<a name="l00950"></a>00950 <span class="comment">    *</span>
<a name="l00951"></a>00951 <span class="comment">    * FYI: nProcess (just below) is the request number for the PROCESS NYMBOX message.</span>
<a name="l00952"></a>00952 <span class="comment">    * Below the switch block just down there, we know for a fact this number is &gt;0.</span>
<a name="l00953"></a>00953 <span class="comment">    */</span>
<a name="l00954"></a>00954     <span class="comment">// ******************************************************************************</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="comment">// -- SECTION 2: &quot;SEND PROCESS NYMBOX&quot;</span>
<a name="l00957"></a>00957     <span class="comment">//</span>
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="comment">// Next, we have to make sure we have all the BOX RECEIPTS downloaded</span>
<a name="l00960"></a>00960     <span class="comment">// for this Nymbox.</span>
<a name="l00961"></a>00961 
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">// If the caller wanted to know whether a certain reply (by request number) was in the Nymbox, then bFoundNymboxItem</span>
<a name="l00964"></a>00964     <span class="comment">// will be set true in this call, if it was there. That way he can Harvest his own msg if he needs to. (Just like I</span>
<a name="l00965"></a>00965     <span class="comment">// harvest my own processNymbox call below, if necessary.)</span>
<a name="l00966"></a>00966     <span class="comment">//</span>
<a name="l00967"></a>00967     <span class="comment">// nBoxType = 0 aka nymbox;</span>
<a name="l00968"></a>00968     <span class="comment">//</span>
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     int32_t nBoxType = 0;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="keywordtype">bool</span> bInsured = <a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, nymID, nBoxType, nRequestNumber, bFoundNymboxItem);   <span class="comment">// ***************************;</span>
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a7333cee91a6a34abe00d628f13596e3b">VerifyBoolVal</a>(bInsured) &amp;&amp; bInsured)
<a name="l00974"></a>00974     {
<a name="l00975"></a>00975         <span class="comment">// If the caller was on about a specific request number...</span>
<a name="l00976"></a>00976         <span class="comment">//</span>
<a name="l00977"></a>00977         <span class="keywordflow">if</span> (nRequestNumber &gt; 0)
<a name="l00978"></a>00978         {
<a name="l00979"></a>00979             <span class="comment">// ...And if we DID NOT find that request number in the Nymbox</span>
<a name="l00980"></a>00980             <span class="comment">// (along with the server&#39;s reply), then harvest it!!</span>
<a name="l00981"></a>00981             <span class="comment">// (If we HAD found it, then we&#39;d know it didn&#39;t NEED harvesting,</span>
<a name="l00982"></a>00982             <span class="comment">// since the server clearly REPLIED to it already.)</span>
<a name="l00983"></a>00983 
<a name="l00984"></a>00984             <span class="comment">// FOUND it in the nymbox! Therefore we can remove without harvesting.</span>
<a name="l00985"></a>00985             <span class="comment">// (Server definitely processed it, so nothing to harvest.)</span>
<a name="l00986"></a>00986             <span class="comment">//</span>
<a name="l00987"></a>00987             <span class="keywordflow">if</span> (bFoundNymboxItem)
<a name="l00988"></a>00988             {
<a name="l00989"></a>00989                 <span class="comment">// Notice, if the above call to insureHaveAllBoxReceipts had any network hiccups, then</span>
<a name="l00990"></a>00990                 <span class="comment">// it may have had to get and processNymbox, meaning the below Remove would fail, since</span>
<a name="l00991"></a>00991                 <span class="comment">// the sent message was already removed. Therefore, might want to update this to call getSent</span>
<a name="l00992"></a>00992                 <span class="comment">// FIRST, before trying to remove.</span>
<a name="l00993"></a>00993                 <span class="comment">// (Might want different messages in either case.)</span>
<a name="l00994"></a>00994                 <span class="comment">//</span>
<a name="l00995"></a>00995                 <span class="keywordtype">bool</span> nRemovedMsg = <a class="code" href="class_o_t_a_p_i___wrap.html#ac15afd544c60bd63e7fe6fbc73d22a4b">OTAPI_Wrap::RemoveSentMessage</a>(int64_t(nRequestNumber), serverID, nymID);
<a name="l00996"></a>00996                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(2, strLocation + <span class="stringliteral">&quot;: OT_API_RemoveSentMessage: (Found server reply in Nymbox. Removing local sent msg.) Request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRemovedMsg) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00997"></a>00997             }
<a name="l00998"></a>00998             <span class="keywordflow">else</span> <span class="comment">// We DIDN&#39;T find it in the nymbox, so we can harvest it:</span>
<a name="l00999"></a>00999             {
<a name="l01000"></a>01000                 <span class="comment">// NOTE: This may always fail,</span>
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(3, strLocation + <span class="stringliteral">&quot;: FYI: Calling OT_API_GetSentMessage...\n&quot;</span>);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004                 <span class="keywordtype">string</span> strSentMsg = <a class="code" href="class_o_t_a_p_i___wrap.html#a29688af14e9b6cd58d50ef736a917f60">OTAPI_Wrap::GetSentMessage</a>(int64_t(nRequestNumber), serverID, nymID);
<a name="l01005"></a>01005 
<a name="l01006"></a>01006                 <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strSentMsg))
<a name="l01007"></a>01007                 {
<a name="l01008"></a>01008                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(2, strLocation + <span class="stringliteral">&quot;: (1) OT_API_GetSentMessage returned NULL for clawback. (Must have already been cleared. OT uses deliberate redundancy, though optimizes this wherever possible.) Request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNumber) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01009"></a>01009                 }
<a name="l01010"></a>01010                 <span class="keywordflow">else</span> <span class="comment">// OTAPI_Wrap::GetSentMessage success.</span>
<a name="l01011"></a>01011                 {
<a name="l01012"></a>01012                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: Harvesting transaction numbers from failed Msg attempt...\n&quot;</span>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014                     <span class="keywordtype">bool</span> nHarvested = <a class="code" href="class_o_t_a_p_i___wrap.html#a55b1919e2e09e188f3366f16cc9ca0ed">OTAPI_Wrap::Msg_HarvestTransactionNumbers</a>(strSentMsg, nymID,
<a name="l01015"></a>01015                         bHarvestingForRetry, <span class="comment">// bHarvestingForRetry.</span>
<a name="l01016"></a>01016                         bMsgReplySuccess,    <span class="comment">// bReplyWasSuccess,       // RECEIVED server reply: explicit success.</span>
<a name="l01017"></a>01017                         bMsgReplyFailure,    <span class="comment">// bReplyWasFailure,       // RECEIVED server reply: explicit failure.</span>
<a name="l01018"></a>01018                         bMsgTransSuccess,    <span class="comment">// bTransactionWasSuccess, // MESSAGE success, Transaction success. (Explicit.)</span>
<a name="l01019"></a>01019                         bMsgTransFailure);    <span class="comment">// bTransactionWasFailure  // MESSAGE success, Transaction failure. (Explicit.)</span>
<a name="l01020"></a>01020                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: OT_API_Msg_HarvestTransactionNumbers: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nHarvested) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022 
<a name="l01023"></a>01023                     <span class="keywordtype">bool</span> nRemovedMsg = <a class="code" href="class_o_t_a_p_i___wrap.html#ac15afd544c60bd63e7fe6fbc73d22a4b">OTAPI_Wrap::RemoveSentMessage</a>(int64_t(nRequestNumber), serverID, nymID);
<a name="l01024"></a>01024                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(2, strLocation + <span class="stringliteral">&quot;: OT_API_RemoveSentMessage: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRemovedMsg) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01025"></a>01025                 } <span class="comment">// strSentMsg NOT null!</span>
<a name="l01026"></a>01026             }
<a name="l01027"></a>01027         }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029 
<a name="l01030"></a>01030         <span class="comment">// (flush): LOOP THROUGH ALL &quot;SENT&quot; messages, and see if ANY of them has a reply</span>
<a name="l01031"></a>01031         <span class="comment">// sitting in my Nymbox. If so, REMOVE IT from &quot;Sent&quot; queue, (since clearly the server</span>
<a name="l01032"></a>01032         <span class="comment">// DID respond already.) And if it&#39;s NOT in my nymbox, that means I DEFINITELY need to</span>
<a name="l01033"></a>01033         <span class="comment">// harvest it back since the server definitely rejected it or never received it.</span>
<a name="l01034"></a>01034         <span class="comment">//</span>
<a name="l01035"></a>01035         <span class="comment">// The Nym actually SAVES the sent messages PER SERVER, so that this</span>
<a name="l01036"></a>01036         <span class="comment">// will continue to work in every possible case!!</span>
<a name="l01037"></a>01037         <span class="comment">// NOTE: Also now storing, on the client nym, a copy of the server&#39;s latest nymbox hash</span>
<a name="l01038"></a>01038         <span class="comment">// for that nym, in addition to the nym&#39;s copy (which only updates when he gets his Nymbox.)</span>
<a name="l01039"></a>01039         <span class="comment">// That way the Nym, even before syncing the nymboxes, and even before sending a new message</span>
<a name="l01040"></a>01040         <span class="comment">// to find out if they are out of sync, ALREADY KNOWS if they&#39;re in sync or not. (That&#39;s why</span>
<a name="l01041"></a>01041         <span class="comment">// all those other server messages send a copy of that hash back, not just the getNymbox msg.)</span>
<a name="l01042"></a>01042         <span class="comment">//</span>
<a name="l01043"></a>01043         <span class="comment">//</span>
<a name="l01044"></a>01044         <span class="comment">//            void OTAPI_Wrap::FlushSentMessages(const int32_t bHarvestingForRetry, // bHarvestingForRetry is actually OT_BOOL</span>
<a name="l01045"></a>01045         <span class="comment">//                              const char * SERVER_ID,</span>
<a name="l01046"></a>01046         <span class="comment">//                              const char * USER_ID,</span>
<a name="l01047"></a>01047         <span class="comment">//                              const char * THE_NYMBOX);</span>
<a name="l01048"></a>01048         <span class="comment">// NoVerify means don&#39;t load up all the box receipts.</span>
<a name="l01049"></a>01049         <span class="comment">// Especially in this case--we only care about whether a box receipt is THERE, not</span>
<a name="l01050"></a>01050         <span class="comment">// what it contains. FlushSentMessages will work just fine WITHOUT loading those</span>
<a name="l01051"></a>01051         <span class="comment">// box receipts (because the Nymbox contains enough of an abbreviated record already</span>
<a name="l01052"></a>01052         <span class="comment">// for each one, that we will have the info we need already.)</span>
<a name="l01053"></a>01053         <span class="comment">//</span>
<a name="l01054"></a>01054         <span class="keywordtype">string</span> strNymbox = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID); <span class="comment">// FLUSH SENT MESSAGES!!!!  (AND HARVEST.);</span>
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="comment">// *******************************************************</span>
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strNymbox))
<a name="l01058"></a>01058         {
<a name="l01059"></a>01059 
<a name="l01060"></a>01060             <a class="code" href="class_o_t_a_p_i___wrap.html#ae404dd731fc2272e138880e97d4ce0a9">OTAPI_Wrap::FlushSentMessages</a>(<span class="keyword">false</span>, <span class="comment">//harvesting for retry = = OT_FALSE. None of the things are being re-tried by the time they are being flushed.  They were already old news.;</span>
<a name="l01061"></a>01061                 serverID,
<a name="l01062"></a>01062                 nymID,
<a name="l01063"></a>01063                 strNymbox);
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065         <span class="comment">// Flushing removes all the messages from the &quot;sent messages&quot; queue,</span>
<a name="l01066"></a>01066         <span class="comment">// and harvests any transaction numbers to be had. How do I know for sure</span>
<a name="l01067"></a>01067         <span class="comment">// that I can get away with this? How do I know whether the server has</span>
<a name="l01068"></a>01068         <span class="comment">// processed those messages or not? How can I harvest them as though they</span>
<a name="l01069"></a>01069         <span class="comment">// were dropped on the network somewhere? The answer is because I JUST</span>
<a name="l01070"></a>01070         <span class="comment">// called GetNymbox and downloaded the latest one. I can SEE which replies</span>
<a name="l01071"></a>01071         <span class="comment">// are in there -- and which ones aren&#39;t. I pass that Nymbox into the flush</span>
<a name="l01072"></a>01072         <span class="comment">// call, so that flush can be careful to remove all sent messages that have</span>
<a name="l01073"></a>01073         <span class="comment">// nymbox replies, and only harvest the others.</span>
<a name="l01074"></a>01074         <span class="comment">// *******************************************************</span>
<a name="l01075"></a>01075         <span class="keywordflow">else</span>
<a name="l01076"></a>01076         {
<a name="l01077"></a>01077             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error while trying to flush sent messages: Failed loading Nymbox for nym: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01078"></a>01078         }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080         int32_t nMsgSentRequestNumOut = -1;
<a name="l01081"></a>01081         int32_t nReplySuccessOut = -1;
<a name="l01082"></a>01082         int32_t nBalanceSuccessOut = -1;
<a name="l01083"></a>01083         int32_t nTransSuccessOut = -1;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         <span class="comment">// PROCESS NYMBOX</span>
<a name="l01087"></a>01087         <span class="comment">//</span>
<a name="l01088"></a>01088         <span class="comment">// Returns:</span>
<a name="l01089"></a>01089         <span class="comment">// -1 Error.</span>
<a name="l01090"></a>01090         <span class="comment">//  0 Nymbox was empty -- nothing done. (bWasMsgSent = false)</span>
<a name="l01091"></a>01091         <span class="comment">//  0 Transactionstatus = = server reply received (bWasMsgSent = true),;</span>
<a name="l01092"></a>01092         <span class="comment">//    but the server reply saysstatus = =failed.;</span>
<a name="l01093"></a>01093         <span class="comment">// &gt;0 If the Transaction status (from the server reply) is SUCCESS, then this function</span>
<a name="l01094"></a>01094         <span class="comment">//    returns the REQUEST NUMBER from when it was originally sent.</span>
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         int32_t nProcess = <a class="code" href="class_utility.html#ac88672f5fd7f460fa467476a71f30371">processNymbox</a>(serverID, nymID,
<a name="l01097"></a>01097             bWasMsgSent,
<a name="l01098"></a>01098 
<a name="l01099"></a>01099             nMsgSentRequestNumOut,
<a name="l01100"></a>01100             nReplySuccessOut,
<a name="l01101"></a>01101             nBalanceSuccessOut,
<a name="l01102"></a>01102             nTransSuccessOut);
<a name="l01103"></a>01103 
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (-1 == nProcess)
<a name="l01105"></a>01105         {
<a name="l01106"></a>01106             <span class="comment">// Todo: might want to remove the sent message here, IF bMsgWasSent is true.</span>
<a name="l01107"></a>01107             <span class="comment">// (Just like case 0.)</span>
<a name="l01108"></a>01108             <span class="comment">//</span>
<a name="l01109"></a>01109             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: processNymbox: error (-1). (It couldn&#39;t send. I give up.)\n&quot;</span>);
<a name="l01110"></a>01110 
<a name="l01111"></a>01111             <span class="keywordflow">return</span> -1; <span class="comment">// (It didn&#39;t even send.)</span>
<a name="l01112"></a>01112         }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == nProcess)
<a name="l01115"></a>01115         {
<a name="l01116"></a>01116             <span class="comment">// Nymbox was empty. (So we didn&#39;t send any process message because there was nothing to process.)</span>
<a name="l01117"></a>01117             <span class="keywordflow">if</span> (!bWasMsgSent)
<a name="l01118"></a>01118             {
<a name="l01119"></a>01119                 <span class="keywordflow">return</span> 0; <span class="comment">// success. done. (box was empty already.)</span>
<a name="l01120"></a>01120             }
<a name="l01121"></a>01121             <span class="comment">// else: the message WAS sent, (the Nymbox was NOT empty)</span>
<a name="l01122"></a>01122             <span class="comment">//       and then the server replied &quot;success==FALSE&quot;</span>
<a name="l01123"></a>01123             <span class="comment">//       in its REPLY to that message! Thus we continue and DROP THROUGH...</span>
<a name="l01124"></a>01124         }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nProcess &lt; 0)
<a name="l01127"></a>01127         {
<a name="l01128"></a>01128             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: processNymbox: unexpected: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nProcess) + <span class="stringliteral">&quot;. (I give up.)\n&quot;</span>);
<a name="l01129"></a>01129 
<a name="l01130"></a>01130             <span class="keywordflow">return</span> -1;
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132         <span class="comment">// bWasMsgSent = true;  // unnecessary -- set already by processNymbox call above.</span>
<a name="l01133"></a>01133 
<a name="l01134"></a>01134         <span class="comment">// By this point, we definitely have a &gt;0 request number from the sendProcessNymbox()</span>
<a name="l01135"></a>01135         <span class="comment">// call, stored in nProcess (meaning the message WAS sent.) (Except in case of 0, see next line which fixes this:)</span>
<a name="l01136"></a>01136         <span class="comment">//</span>
<a name="l01137"></a>01137 
<a name="l01138"></a>01138         nProcess = nMsgSentRequestNumOut; <span class="comment">// Sometimes this could be 0 still, so we fix it here.;</span>
<a name="l01139"></a>01139         int32_t nReplySuccess = nReplySuccessOut;
<a name="l01140"></a>01140         int32_t nTransSuccess = nTransSuccessOut;
<a name="l01141"></a>01141         int32_t nBalanceSuccess = nBalanceSuccessOut;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="comment">/*</span>
<a name="l01145"></a>01145 <span class="comment"></span>
<a name="l01146"></a>01146 <span class="comment">        return const;</span>
<a name="l01147"></a>01147 <span class="comment"></span>
<a name="l01148"></a>01148 <span class="comment">        char *    OTAPI_Wrap::GetSentMessage(const char * REQUEST_NUMBER)</span>
<a name="l01149"></a>01149 <span class="comment">        OT_BOOL   OTAPI_Wrap::RemoveSentMessage(const char * REQUEST_NUMBER)</span>
<a name="l01150"></a>01150 <span class="comment"></span>
<a name="l01151"></a>01151 <span class="comment">        */</span>
<a name="l01152"></a>01152         <span class="comment">// All of these booleans (except &quot;error&quot;) represent RECEIVED ANSWERS from the server.</span>
<a name="l01153"></a>01153         <span class="comment">// In other words, &quot;false&quot; does not mean &quot;failed to find message.&quot;</span>
<a name="l01154"></a>01154         <span class="comment">// Rather, it means &quot;DEFINITELY got a reply, and that reply sayssuccess = =false.&quot;;</span>
<a name="l01155"></a>01155 
<a name="l01156"></a>01156 
<a name="l01157"></a>01157         <span class="comment">// SHOULD NEVER HAPPEN (processNymbox call just above was successful,</span>
<a name="l01158"></a>01158         <span class="comment">// therefore the sent message SHOULD be here in my cache.)</span>
<a name="l01159"></a>01159         <span class="comment">//</span>
<a name="l01160"></a>01160         <span class="keywordtype">string</span> strReplyProcess = <a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">getLastReplyReceived</a>();
<a name="l01161"></a>01161         <span class="comment">// I had to do this bit because getRequestNumber doesn&#39;t return the;</span>
<a name="l01162"></a>01162         <span class="comment">// reply itself. But in this case, I needed it.</span>
<a name="l01163"></a>01163         <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strReplyProcess)) <span class="comment">// THIS SHOULD NEVER HAPPEN.</span>
<a name="l01164"></a>01164         {
<a name="l01165"></a>01165             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR in getLastReplyReceived(): why was this string not set, when getRequestNumber was otherwise an apparent success?\n&quot;</span>);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167             <span class="keywordflow">return</span> -1; <span class="comment">// (SHOULD NEVER HAPPEN. This string is set in the getRequestNumber function.)</span>
<a name="l01168"></a>01168         }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 
<a name="l01171"></a>01171         <span class="keywordtype">bool</span> bProcessNymboxReplyError = (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strReplyProcess) || (nReplySuccess   &lt; 0));
<a name="l01172"></a>01172         <span class="keywordtype">bool</span> bProcessNymboxBalanceError = (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strReplyProcess) || (nBalanceSuccess &lt; 0));
<a name="l01173"></a>01173         <span class="keywordtype">bool</span> bProcessNymboxTransError = (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strReplyProcess) || (nTransSuccess   &lt; 0));
<a name="l01174"></a>01174 
<a name="l01175"></a>01175         <span class="keywordtype">bool</span> bProcessNymboxReplySuccess = (!bProcessNymboxReplyError &amp;&amp; (nReplySuccess  &gt; 0));
<a name="l01176"></a>01176         <span class="keywordtype">bool</span> bProcessNymboxReplyFailure = (!bProcessNymboxReplyError &amp;&amp; (nReplySuccess == 0));
<a name="l01177"></a>01177 
<a name="l01178"></a>01178         <span class="keywordtype">bool</span> bProcessNymboxBalanceSuccess = (!bProcessNymboxReplyError &amp;&amp; !bProcessNymboxBalanceError &amp;&amp; (nBalanceSuccess  &gt; 0));
<a name="l01179"></a>01179         <span class="keywordtype">bool</span> bProcessNymboxBalanceFailure = (!bProcessNymboxReplyError &amp;&amp; !bProcessNymboxBalanceError &amp;&amp; (nBalanceSuccess == 0));
<a name="l01180"></a>01180 
<a name="l01181"></a>01181         <span class="keywordtype">bool</span> bProcessNymboxTransSuccess = (!bProcessNymboxReplyError &amp;&amp; !bProcessNymboxBalanceError &amp;&amp; !bProcessNymboxTransError &amp;&amp; (nTransSuccess  &gt; 0));
<a name="l01182"></a>01182         <span class="keywordtype">bool</span> bProcessNymboxTransFailure = (!bProcessNymboxReplyError &amp;&amp; !bProcessNymboxBalanceError &amp;&amp; !bProcessNymboxTransError &amp;&amp; (nTransSuccess == 0));
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         <span class="keywordtype">bool</span> bProcessAnyError = (bProcessNymboxReplyError || bProcessNymboxBalanceError || bProcessNymboxTransError);
<a name="l01185"></a>01185         <span class="keywordtype">bool</span> bProcessAnyFailure = (bProcessNymboxReplyFailure || bProcessNymboxBalanceFailure || bProcessNymboxTransFailure);
<a name="l01186"></a>01186         <span class="keywordtype">bool</span> bProcessAllSuccess = (bProcessNymboxReplySuccess &amp;&amp; bProcessNymboxBalanceSuccess &amp;&amp; bProcessNymboxTransSuccess);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <span class="comment">// Note: we LEAVE the sent message in the &quot;sent queue&quot; until we are certain that it processed.</span>
<a name="l01190"></a>01190         <span class="comment">// If we are NOT certain that it processed, then we try to download the Nymbox and see if there&#39;s</span>
<a name="l01191"></a>01191         <span class="comment">// a reply there (for the sent message.) If we are able to confirm THAT, AFTER SUCCESSFULLY downloading</span>
<a name="l01192"></a>01192         <span class="comment">// the Nymbox, then then we don&#39;t have to do anything because we know for sure it was processed.</span>
<a name="l01193"></a>01193         <span class="comment">// Similarly, if we DEFINITELY download the Nymbox and do NOT find the reply, then we know the server</span>
<a name="l01194"></a>01194         <span class="comment">// DEFINITELY did not receive (or at least process) that message, which is what allows us to HARVEST</span>
<a name="l01195"></a>01195         <span class="comment">// the transaction numbers back from the sent message, and remove the sent message from the sent queue.</span>
<a name="l01196"></a>01196         <span class="comment">//</span>
<a name="l01197"></a>01197         <span class="comment">// However, if we are NOT able to Verify any of these things, NOR are we able to download the Nymbox to</span>
<a name="l01198"></a>01198         <span class="comment">// see, then we DO leave the message in the sent queue. This is deliberate, since it gives us the opportunity</span>
<a name="l01199"></a>01199         <span class="comment">// in the future to clear those sent messages NEXT time we successfully DO download the Nymbox, and in the</span>
<a name="l01200"></a>01200         <span class="comment">// meantime, it allows us to store a record of EXACTLY which messages were MISSED.</span>
<a name="l01201"></a>01201         <span class="comment">//</span>
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         int32_t nHarvested = -1;
<a name="l01204"></a>01204 
<a name="l01205"></a>01205         <span class="keywordflow">if</span> (bProcessAllSuccess)
<a name="l01206"></a>01206         {
<a name="l01207"></a>01207             <span class="comment">// the processNymbox was a complete success, including the message</span>
<a name="l01208"></a>01208             <span class="comment">// AND the transaction AND the transaction statement.</span>
<a name="l01209"></a>01209             <span class="comment">// Therefore, there&#39;s DEFINITELY nothing to clawback.</span>
<a name="l01210"></a>01210             <span class="comment">//</span>
<a name="l01211"></a>01211             <span class="comment">// (Thus I RemoveSentMessage for the processNymbox message, since</span>
<a name="l01212"></a>01212             <span class="comment">// I&#39;m totally done with it now.)</span>
<a name="l01213"></a>01213             <span class="comment">//</span>
<a name="l01214"></a>01214             <span class="comment">//         int32_t nRemoved = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nProcess), serverID, nymID);</span>
<a name="l01215"></a>01215 
<a name="l01216"></a>01216             <span class="comment">// NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l01217"></a>01217             <span class="comment">// we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l01218"></a>01218             <span class="comment">// already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l01219"></a>01219             <span class="comment">//</span>
<a name="l01220"></a>01220         }
<a name="l01221"></a>01221         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bProcessAnyError || bProcessAnyFailure) <span class="comment">// let&#39;s resync, and clawback whatever transaction numbers we might have used on the processNymbox request...</span>
<a name="l01222"></a>01222         {
<a name="l01223"></a>01223             nGetNymbox = <a class="code" href="class_utility.html#aed9167fe744ab29d8e4ce30c2517fc92">getNymbox</a>(serverID, nymID, <span class="keyword">true</span>); <span class="comment">// bForceDownload=true - NOTE: could maybe change this to false and have it still work.;</span>
<a name="l01224"></a>01224 
<a name="l01225"></a>01225             <span class="keywordflow">if</span> (nGetNymbox &lt; 1)
<a name="l01226"></a>01226             {
<a name="l01227"></a>01227                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: this.getNymbox returned: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 <span class="keywordflow">return</span> -1;
<a name="l01230"></a>01230             }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232             <span class="keywordtype">bool</span> bWasFound = <span class="keyword">false</span>;
<a name="l01233"></a>01233             nBoxType = 0; <span class="comment">// I think it was already zero, but since i&#39;m using it here;</span>
<a name="l01234"></a>01234             <span class="comment">// PURELY to be a &#39;0&#39;, I feel safer setting it again. (Nymbox is 0.)</span>
<a name="l01235"></a>01235             <span class="comment">//   bool bInsured = insureHaveAllBoxReceipts(serverID, nymID, nymID, nBoxType, nRequestNumber, bFoundNymboxItem);   // ***************************;</span>
<a name="l01236"></a>01236             <span class="keywordflow">if</span> (<a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, nymID, nBoxType, nProcess, bWasFound)) <span class="comment">// This will tell us whether the processNymbox reply was found in the Nymbox</span>
<a name="l01237"></a>01237             {
<a name="l01238"></a>01238                 <span class="comment">// we FOUND the processNymbox reply in the Nymbox!</span>
<a name="l01239"></a>01239                 <span class="comment">//</span>
<a name="l01240"></a>01240                 <span class="keywordflow">if</span> (bWasFound)
<a name="l01241"></a>01241                 {
<a name="l01242"></a>01242                     <span class="comment">// Thus, no need to clawback any transaction numbers,</span>
<a name="l01243"></a>01243                     <span class="comment">// since the server clearly already processed this processNymbox</span>
<a name="l01244"></a>01244                     <span class="comment">// transaction, since I have a reply to it already sitting in my Nymbox.</span>
<a name="l01245"></a>01245                     <span class="comment">//</span>
<a name="l01246"></a>01246                     <span class="comment">//                       int32_t nRemoved = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nProcess), serverID, nymID);</span>
<a name="l01247"></a>01247                     <span class="comment">//</span>
<a name="l01248"></a>01248                     <span class="comment">// NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l01249"></a>01249                     <span class="comment">// we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l01250"></a>01250                     <span class="comment">// already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l01251"></a>01251 
<a name="l01252"></a>01252                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: I *did* find the @processNymbox reply in my Nymbox, so NO NEED to clawback any transaction numbers.\n&quot;</span>);
<a name="l01253"></a>01253                 }
<a name="l01254"></a>01254                 <span class="keywordflow">else</span> <span class="comment">// was NOT found... we need to clawback.</span>
<a name="l01255"></a>01255                 {
<a name="l01256"></a>01256                     <span class="comment">// This means the server&#39;s reply was definitely NOT found in the</span>
<a name="l01257"></a>01257                     <span class="comment">// Nymbox, even after successfully DOWNLOADING that Nymbox. Which</span>
<a name="l01258"></a>01258                     <span class="comment">// means the server never got it in the first place, or rejected it</span>
<a name="l01259"></a>01259                     <span class="comment">// at the message level before the transaction portion had a chance</span>
<a name="l01260"></a>01260                     <span class="comment">// to run. Either way, we need to claw back any relevant transaction</span>
<a name="l01261"></a>01261                     <span class="comment">// numbers...</span>
<a name="l01262"></a>01262 
<a name="l01263"></a>01263                     <span class="comment">// HARVEST the processNymbox message from outgoing messages.</span>
<a name="l01264"></a>01264 
<a name="l01265"></a>01265                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(3, strLocation + <span class="stringliteral">&quot;: FYI: Calling OT_API_GetSentMessage...\n&quot;</span>);
<a name="l01266"></a>01266 
<a name="l01267"></a>01267                     <span class="keywordtype">string</span> strSentProcessNymboxMsg = <a class="code" href="class_o_t_a_p_i___wrap.html#a29688af14e9b6cd58d50ef736a917f60">OTAPI_Wrap::GetSentMessage</a>(int64_t(nProcess), serverID, nymID);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269                     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strSentProcessNymboxMsg))
<a name="l01270"></a>01270                     {
<a name="l01271"></a>01271                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(2, strLocation + <span class="stringliteral">&quot;: (2) OT_API_GetSentMessage returned NULL for clawback. (Must have already been cleared. OT uses deliberate redundancy, though optimizes this wherever possible.) Request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nProcess) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01272"></a>01272                     }
<a name="l01273"></a>01273                     <span class="keywordflow">else</span> <span class="comment">// strSentProcessNymboxMsg NOT null!</span>
<a name="l01274"></a>01274                     {
<a name="l01275"></a>01275                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: Harvesting transaction numbers from failed processNymbox attempt...\n&quot;</span>);
<a name="l01276"></a>01276 
<a name="l01277"></a>01277                         nHarvested = <a class="code" href="class_o_t_a_p_i___wrap.html#a55b1919e2e09e188f3366f16cc9ca0ed">OTAPI_Wrap::Msg_HarvestTransactionNumbers</a>(strSentProcessNymboxMsg, nymID,
<a name="l01278"></a>01278                             <span class="keyword">false</span>,   <span class="comment">//bHarvestingForRetry = = false;</span>
<a name="l01279"></a>01279                             bProcessNymboxReplySuccess, <span class="comment">// bReplyWasSuccess,       // RECEIVED server reply: explicit success.</span>
<a name="l01280"></a>01280                             bProcessNymboxReplyFailure, <span class="comment">// bReplyWasFailure,       // RECEIVED server reply: explicit failure.</span>
<a name="l01281"></a>01281                             bProcessNymboxTransSuccess, <span class="comment">// bTransactionWasSuccess, // MESSAGE success, Transaction success. (Explicit.)</span>
<a name="l01282"></a>01282                             bProcessNymboxTransFailure);  <span class="comment">// bTransactionWasFailure  // MESSAGE success, Transaction failure. (Explicit.)</span>
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: OT_API_Msg_HarvestTransactionNumbers: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nHarvested) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286                         <span class="keywordtype">bool</span> nRemovedProcessNymboxMsg = <a class="code" href="class_o_t_a_p_i___wrap.html#ac15afd544c60bd63e7fe6fbc73d22a4b">OTAPI_Wrap::RemoveSentMessage</a>(int64_t(nProcess), serverID, nymID);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(2, strLocation + <span class="stringliteral">&quot;: OT_API_RemoveSentMessage: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRemovedProcessNymboxMsg) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01289"></a>01289                     } <span class="comment">// strSentProcessNymboxMsg NOT null!</span>
<a name="l01290"></a>01290                 } <span class="comment">// a specific receipt was not found in the nymbox (need to clawback the transaction numbers on that receipt.)</span>
<a name="l01291"></a>01291 
<a name="l01292"></a>01292                 strNymbox = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID); <span class="comment">// FLUSH SENT MESSAGES!!!!  (AND HARVEST.);</span>
<a name="l01293"></a>01293                 <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strNymbox))
<a name="l01294"></a>01294                 {
<a name="l01295"></a>01295                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae404dd731fc2272e138880e97d4ce0a9">OTAPI_Wrap::FlushSentMessages</a>(<span class="keyword">false</span>, <span class="comment">//harvesting for retry = = OT_FALSE</span>
<a name="l01296"></a>01296                         serverID,
<a name="l01297"></a>01297                         nymID,
<a name="l01298"></a>01298                         strNymbox);
<a name="l01299"></a>01299                 }
<a name="l01300"></a>01300                 <span class="comment">// Flushing removes all the messages from the &quot;sent messages&quot; queue,</span>
<a name="l01301"></a>01301                 <span class="comment">// and harvests any transaction numbers to be had. How do I know for sure</span>
<a name="l01302"></a>01302                 <span class="comment">// that I can get away with this? How do I know whether the server has</span>
<a name="l01303"></a>01303                 <span class="comment">// processed those messages or not? How can I harvest them as though they</span>
<a name="l01304"></a>01304                 <span class="comment">// were dropped on the network somewhere? The answer is because I JUST</span>
<a name="l01305"></a>01305                 <span class="comment">// called getNymbox and downloaded the latest one. I can SEE which replies</span>
<a name="l01306"></a>01306                 <span class="comment">// are in there -- and which ones aren&#39;t. I pass that Nymbox into the flush</span>
<a name="l01307"></a>01307                 <span class="comment">// call, so that flush can be careful to remove all sent messages that have</span>
<a name="l01308"></a>01308                 <span class="comment">// nymbox replies, and only harvest the others.</span>
<a name="l01309"></a>01309                 <span class="comment">// *******************************************************</span>
<a name="l01310"></a>01310                 <span class="keywordflow">else</span>
<a name="l01311"></a>01311                 {
<a name="l01312"></a>01312                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error while trying to flush sent messages: Failed loading Nymbox for nym: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01313"></a>01313                 }
<a name="l01314"></a>01314             } <span class="comment">// if insureHaveAllBoxReceipts()</span>
<a name="l01315"></a>01315             <span class="keywordflow">else</span> <span class="comment">// we do NOT have all the box receipts.</span>
<a name="l01316"></a>01316             {
<a name="l01317"></a>01317                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error: insureHaveAllBoxReceipts failed. (I give up.)\n&quot;</span>);
<a name="l01318"></a>01318                 <span class="keywordflow">return</span> -1;
<a name="l01319"></a>01319             }
<a name="l01320"></a>01320         } <span class="comment">// else if (bProcessAnyError || bProcessAnyFailure)</span>
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         <span class="comment">// Return the request number, if potentially needed by caller.</span>
<a name="l01323"></a>01323         <span class="comment">// If explicit success, the request number is returned as a positive</span>
<a name="l01324"></a>01324         <span class="comment">// number (though already removed from sent queue.) Whereas if explicit</span>
<a name="l01325"></a>01325         <span class="comment">// failure (replystatus = failed) then we harvest the numbers;</span>
<a name="l01326"></a>01326         <span class="comment">//</span>
<a name="l01327"></a>01327         <span class="keywordflow">if</span> (bProcessAllSuccess)
<a name="l01328"></a>01328             <span class="comment">//          return getNymbox(serverID, nymID, true); //bForceDownload = true. Since we DID process it successfully, then we grab it again.</span>
<a name="l01329"></a>01329         {
<a name="l01330"></a>01330             <span class="keywordflow">return</span> 1;
<a name="l01331"></a>01331         }  <span class="comment">// We don&#39;t need the sent message after this, and we&#39;ve already removed it from sent queue.</span>
<a name="l01332"></a>01332 
<a name="l01333"></a>01333         <span class="keywordflow">if</span> (bProcessAnyFailure || bProcessAnyError)
<a name="l01334"></a>01334         {
<a name="l01335"></a>01335             <span class="keywordflow">if</span> (nHarvested &lt; 1)  <span class="comment">// If the message failed, and the harvesting failed, then we return the</span>
<a name="l01336"></a>01336             {
<a name="l01337"></a>01337                 <span class="keywordflow">return</span> nProcess;
<a name="l01338"></a>01338             }  <span class="comment">// number for the process nymbox, so the caller has a choice of what to do next.</span>
<a name="l01339"></a>01339 
<a name="l01340"></a>01340             <span class="keywordflow">if</span> (bProcessAnyFailure)
<a name="l01341"></a>01341             {
<a name="l01342"></a>01342                 <span class="keywordflow">return</span> 0;
<a name="l01343"></a>01343             }  <span class="comment">// by this point, we&#39;ve definitely harvested, AND removed sent message from sent queue. So we just return 0;</span>
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346         <span class="keywordflow">return</span> -1; <span class="comment">// must&#39;ve been an error.</span>
<a name="l01347"></a>01347     } <span class="comment">// if insureAllBoxReceipts()</span>
<a name="l01348"></a>01348     <span class="keywordflow">else</span>
<a name="l01349"></a>01349     {
<a name="l01350"></a>01350         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: insureHaveAllBoxReceipts failed. (I give up.)\n&quot;</span>);
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353     <span class="keywordflow">return</span> -1;
<a name="l01354"></a>01354 }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356 
<a name="l01357"></a>01357 <span class="comment">//  def Utility::getAndProcessNymbox(String serverID, String nymID, OTBool bWasMsgSent, boolean bForceDownload)</span>
<a name="l01358"></a>01358 <span class="comment">//</span>
<a name="l01359"></a><a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">01359</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">Utility::getAndProcessNymbox_4</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasMsgSent, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload)
<a name="l01360"></a>01360 {
<a name="l01361"></a>01361     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getAndProcessNymbox_4&quot;</span>;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="keywordflow">if</span> (<span class="comment">/* !VerifyOTBoolRef(bWasMsgSent) || */</span> !<a class="code" href="ot__utility__ot_8hpp.html#a7333cee91a6a34abe00d628f13596e3b">VerifyBoolVal</a>(bForceDownload))
<a name="l01364"></a>01364     {
<a name="l01365"></a>01365         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: SHOULD NEVER HAPPEN!!! ASSERT!! ERROR!! FAILURE!!! PROBLEM!!!!!\n&quot;</span>);
<a name="l01366"></a>01366         <span class="keywordflow">return</span> -1;
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(serverID) || !<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(nymID))
<a name="l01369"></a>01369     {
<a name="l01370"></a>01370         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: SHOULD NEVER HAPPEN!!! ASSERT!! ERROR!! FAILURE!!! PROBLEM!!!!!\n&quot;</span>);
<a name="l01371"></a>01371         <span class="keywordflow">return</span> -1;
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373     <span class="comment">//   bool bMsgReplySuccess5 = false;</span>
<a name="l01374"></a>01374     <span class="comment">//   bool bMsgReplyFailure5 = false;</span>
<a name="l01375"></a>01375     <span class="comment">//   bool bMsgTransSuccess5 = false;</span>
<a name="l01376"></a>01376     <span class="comment">//   bool bMsgTransFailure5 = false;</span>
<a name="l01377"></a>01377 
<a name="l01378"></a>01378     int32_t nRequestNumber = 0;
<a name="l01379"></a>01379     <span class="keywordtype">bool</span> bHarvestingForRetry = <span class="keyword">false</span>;
<a name="l01380"></a>01380     <a class="code" href="class_o_tfourbool.html">OTfourbool</a> the_foursome(<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l01381"></a>01381     <span class="keywordtype">bool</span> bFoundNymboxItem = <span class="keyword">false</span>; <span class="comment">// bFoundNymboxItem is output bool, telling caller whether it was found.;</span>
<a name="l01382"></a>01382 
<a name="l01383"></a>01383     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#a4b80172eebe42e9d5d4b88ebfe9fbacf">getAndProcessNymbox_8</a>(serverID, nymID, bWasMsgSent, bForceDownload, nRequestNumber, bFoundNymboxItem, bHarvestingForRetry, the_foursome);
<a name="l01384"></a>01384 }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 <span class="comment">//  public static int32_t getNymboxLowLevel(String serverID, String nymID)</span>
<a name="l01388"></a>01388 <span class="comment">//  public static int32_t receiveNymboxLowLevel(String serverID, String nymID, var nRequestNum)</span>
<a name="l01389"></a>01389 <span class="comment">//  public static int32_t processNymboxLowLevel(String serverID, String nymID) {</span>
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 
<a name="l01392"></a>01392 <span class="comment">//  def Utility::getAndProcessNymbox(String serverID, String nymID, OTBool bWasMsgSent)</span>
<a name="l01393"></a><a class="code" href="class_utility.html#a1d8f582b0679932743f3a40d2dee45d0">01393</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a1d8f582b0679932743f3a40d2dee45d0">Utility::getAndProcessNymbox_3</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasMsgSent)
<a name="l01394"></a>01394 {
<a name="l01395"></a>01395     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l01396"></a>01396     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasMsgSent, bForceDownload);
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 <span class="comment">// NEW VERSION:</span>
<a name="l01400"></a>01400 
<a name="l01401"></a>01401 <span class="comment">// PROCESS NYMBOX</span>
<a name="l01402"></a>01402 <span class="comment">//</span>
<a name="l01403"></a>01403 <span class="comment">// Returns:</span>
<a name="l01404"></a>01404 <span class="comment">// -1 Error.</span>
<a name="l01405"></a>01405 <span class="comment">//  0 Nymbox was empty -- nothing done. (bWasMsgSent = false)</span>
<a name="l01406"></a>01406 <span class="comment">//  0 server reply received, but it sayssuccess = =false on that msg. (bWasMsgSent = true);</span>
<a name="l01407"></a>01407 <span class="comment">// &gt;0 If the Transaction status (from the server reply) is SUCCESS, then this function</span>
<a name="l01408"></a>01408 <span class="comment">//    returns the REQUEST NUMBER from when it was originally sent.</span>
<a name="l01409"></a>01409 <span class="comment">//</span>
<a name="l01410"></a>01410 <span class="comment">//public static int32_t processNymbox(String    serverID, String nymID,</span>
<a name="l01411"></a>01411 <span class="comment">//                                OTBool    bWasMsgSent,</span>
<a name="l01412"></a>01412 <span class="comment">//                                // --------------------------------</span>
<a name="l01413"></a>01413 <span class="comment">//                                OTInteger nMsgSentRequestNumOut,</span>
<a name="l01414"></a>01414 <span class="comment">//                                OTInteger nReplySuccessOut,</span>
<a name="l01415"></a>01415 <span class="comment">//                                OTInteger nBalanceSuccessOut,</span>
<a name="l01416"></a>01416 <span class="comment">//                                OTInteger nTransSuccessOut)</span>
<a name="l01417"></a>01417 
<a name="l01418"></a><a class="code" href="class_utility.html#ac88672f5fd7f460fa467476a71f30371">01418</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ac88672f5fd7f460fa467476a71f30371">Utility::processNymbox</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasMsgSent, int32_t &amp; nMsgSentRequestNumOut, int32_t &amp; nReplySuccessOut, int32_t &amp; nBalanceSuccessOut, int32_t &amp; nTransSuccessOut)
<a name="l01419"></a>01419 {
<a name="l01420"></a>01420     bWasMsgSent = <span class="keyword">false</span>;
<a name="l01421"></a>01421     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::processNymbox&quot;</span>;
<a name="l01422"></a>01422 
<a name="l01423"></a>01423     <span class="comment">//if (!VerifyOTBoolRef(bWasMsgSent) || !VerifyOTIntegerRef(nReplySuccessOut) || !VerifyOTIntegerRef(nBalanceSuccessOut) || !VerifyOTIntegerRef(nTransSuccessOut))</span>
<a name="l01424"></a>01424     <span class="comment">//{</span>
<a name="l01425"></a>01425     <span class="comment">//    OTAPI_Wrap::Output(0, strLocation + &quot;: SHOULD NEVER HAPPEN: has null values passed in...\n&quot;);</span>
<a name="l01426"></a>01426     <span class="comment">//    exit(-1)</span>
<a name="l01427"></a>01427     <span class="comment">//}</span>
<a name="l01428"></a>01428 
<a name="l01429"></a>01429     nMsgSentRequestNumOut = -1;
<a name="l01430"></a>01430     nReplySuccessOut = -1;
<a name="l01431"></a>01431     nBalanceSuccessOut = -1;
<a name="l01432"></a>01432     nTransSuccessOut = -1;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     <span class="comment">// -- SECTION 2: &quot;SEND PROCESS NYMBOX&quot;</span>
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     <span class="comment">// Next, we have to make sure we have all the BOX RECEIPTS downloaded</span>
<a name="l01437"></a>01437     <span class="comment">// for this Nymbox.</span>
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     int32_t nProcess = <a class="code" href="class_utility.html#ad6c441c50adc8c4327de016dbdfa9a28">sendProcessNymboxLowLevel</a>(serverID, nymID); <span class="comment">// &lt;===================== SEND PROCESS NYMBOX!!;</span>
<a name="l01440"></a>01440     <span class="keywordflow">if</span> (-1 == nProcess)
<a name="l01441"></a>01441     {
<a name="l01442"></a>01442         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;(2): error (-1), when calling sendProcessNymboxLowLevel. (It couldn&#39;t send. I give up.)\n&quot;</span>);
<a name="l01443"></a>01443         <span class="keywordflow">return</span> -1; <span class="comment">// (It didn&#39;t even send.)</span>
<a name="l01444"></a>01444     }
<a name="l01445"></a>01445     <span class="comment">// Nymbox was empty. (So we didn&#39;t send any process message because there was nothing to process.)</span>
<a name="l01446"></a>01446     <span class="keywordflow">if</span> (0 == nProcess)
<a name="l01447"></a>01447     {
<a name="l01448"></a>01448         <span class="keywordflow">return</span> 0; <span class="comment">// success. done.</span>
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450     <span class="keywordflow">if</span> (nProcess &lt; 0)
<a name="l01451"></a>01451     {
<a name="l01452"></a>01452         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: unexpected: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nProcess) + <span class="stringliteral">&quot;, when calling sendProcessNymboxLowLevel. (I give up.)\n&quot;</span>);
<a name="l01453"></a>01453         <span class="keywordflow">return</span> -1;
<a name="l01454"></a>01454     }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     bWasMsgSent = <span class="keyword">true</span>;
<a name="l01457"></a>01457     nMsgSentRequestNumOut = nProcess;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="comment">// By this point, we definitely have a &gt;0 request number from the sendProcessNymbox()</span>
<a name="l01460"></a>01460     <span class="comment">// call, stored in  ** nProcess ** (meaning the message WAS sent.)</span>
<a name="l01461"></a>01461     <span class="comment">//</span>
<a name="l01462"></a>01462     <span class="comment">// But was it received?</span>
<a name="l01463"></a>01463     <span class="comment">//</span>
<a name="l01464"></a>01464     <span class="keywordtype">string</span> strReplyProcess = <a class="code" href="class_utility.html#a8bd3cff789307602e0ef5a29b911b8ce">ReceiveReplyLowLevel</a>(serverID, nymID, nProcess,
<a name="l01465"></a>01465         <span class="stringliteral">&quot;processNymbox / sendProcessNymboxLowLevel / ReceiveReplyLowLevel&quot;</span>); <span class="comment">// &lt;=============== Here we RECEIVE the REPLY...</span>
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 
<a name="l01468"></a>01468     <span class="comment">// getLastReplyReceived() will also contain the same as strReplyProcess.</span>
<a name="l01469"></a>01469     <span class="comment">// So if the CALLER of this function (that we&#39;re in, receiveNymboxLowLevel)</span>
<a name="l01470"></a>01470     <span class="comment">// wants to see the contents, he can.</span>
<a name="l01471"></a>01471 
<a name="l01472"></a>01472     <span class="comment">// ReceiveReplyLowLevel returns null unless there was a string returned.</span>
<a name="l01473"></a>01473     <span class="comment">// So we can directly check it for success...</span>
<a name="l01474"></a>01474 
<a name="l01475"></a>01475     int32_t nReplySuccess = <a class="code" href="ot__utility__ot_8hpp.html#afdbf3b63181963189d5f77bfd70bbb13">VerifyMessageSuccess</a>(strReplyProcess); <span class="comment">// sendProcessNymboxLowLevel;</span>
<a name="l01476"></a>01476     int32_t nTransSuccess = -1;
<a name="l01477"></a>01477     int32_t nBalanceSuccess = -1;;
<a name="l01478"></a>01478     <span class="keywordflow">if</span> (nReplySuccess &gt; 0) <span class="comment">// If message was success, then let&#39;s see if the transaction was, too.</span>
<a name="l01479"></a>01479     {
<a name="l01480"></a>01480         nBalanceSuccess = <a class="code" href="class_o_t_a_p_i___wrap.html#ab96dba3945c8e16f0a290fd90cba467b">OTAPI_Wrap::Message_GetBalanceAgreementSuccess</a>(serverID, nymID, nymID, strReplyProcess); <span class="comment">// the processNymbox transaction.;</span>
<a name="l01481"></a>01481         <span class="keywordflow">if</span> (nBalanceSuccess &gt; 0)
<a name="l01482"></a>01482         {
<a name="l01483"></a>01483             nTransSuccess = <a class="code" href="class_o_t_a_p_i___wrap.html#aa7fda270a877dde2d8765a91b11ff98c">OTAPI_Wrap::Message_GetTransactionSuccess</a>(serverID, nymID, nymID, strReplyProcess); <span class="comment">// the processNymbox transaction.;</span>
<a name="l01484"></a>01484         }
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     nReplySuccessOut = nReplySuccess;
<a name="l01488"></a>01488     nBalanceSuccessOut = nBalanceSuccess;
<a name="l01489"></a>01489     nTransSuccessOut = nTransSuccess;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="comment">// NOTE: The caller MUST have a call to OTAPI_Wrap::RemoveSentMessage</span>
<a name="l01492"></a>01492     <span class="comment">// to correspond to THIS function&#39;s call of sendProcessNymboxLowLevel().</span>
<a name="l01493"></a>01493     <span class="comment">//</span>
<a name="l01494"></a>01494     <span class="keywordflow">if</span> (nTransSuccess &gt; 0)
<a name="l01495"></a>01495     {
<a name="l01496"></a>01496         <span class="keywordflow">return</span> nProcess; <span class="comment">// &lt;=========================</span>
<a name="l01497"></a>01497     }
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="keywordflow">return</span> nTransSuccess;
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 
<a name="l01503"></a>01503 <span class="comment">// No need to deal with getRequest here when failure, since the calling</span>
<a name="l01504"></a>01504 <span class="comment">// function already goes through that crap before we get here.</span>
<a name="l01505"></a>01505 <span class="comment">// Returns: the request number for the process Nymbox request.</span>
<a name="l01506"></a>01506 <span class="comment">// OR returns 0 if the Nymbox was empty (and no message was sent.)</span>
<a name="l01507"></a>01507 <span class="comment">// OR returns -1 if there was an error.</span>
<a name="l01508"></a>01508 <span class="comment">//</span>
<a name="l01509"></a>01509 <span class="comment">// DONE</span>
<a name="l01510"></a><a class="code" href="class_utility.html#ad6c441c50adc8c4327de016dbdfa9a28">01510</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ad6c441c50adc8c4327de016dbdfa9a28">Utility::sendProcessNymboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID) <span class="comment">// bWasSent is an output param allowing to return whether;</span>
<a name="l01511"></a>01511 {
<a name="l01512"></a>01512     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::sendProcessNymboxLowLevel&quot;</span>;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     <span class="comment">// Send message..</span>
<a name="l01515"></a>01515     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     int32_t nRequestNum = <a class="code" href="class_utility.html#ac88672f5fd7f460fa467476a71f30371">OTAPI_Wrap::processNymbox</a>(serverID, nymID);
<a name="l01518"></a>01518     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l01519"></a>01519     {
<a name="l01520"></a>01520         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure sending. OT_API_processNymbox() returned -1. \n&quot;</span>);
<a name="l01521"></a>01521         <span class="keywordflow">return</span> -1; <span class="comment">// no need to check for any reply.</span>
<a name="l01522"></a>01522     } <span class="comment">// ------------------------------------------</span>
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l01524"></a>01524     {
<a name="l01525"></a>01525         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: OT_API_processNymbox() returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01526"></a>01526         <span class="keywordflow">return</span> -1; <span class="comment">// no need to check for any reply.</span>
<a name="l01527"></a>01527     } <span class="comment">// ------------------------------------------</span>
<a name="l01528"></a>01528     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l01529"></a>01529     {
<a name="l01530"></a>01530         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Nymbox was empty; no need to process it. \n&quot;</span>);
<a name="l01531"></a>01531         <span class="keywordflow">return</span> 0; <span class="comment">// Nymbox is empty, thus no need to process it.</span>
<a name="l01532"></a>01532     }
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <span class="comment">// Note: I do NOT call RemoveSentMessage for processNymbox, at least, not here.</span>
<a name="l01535"></a>01535     <span class="comment">// Instead, the place that CALLS this function, will actually use that because</span>
<a name="l01536"></a>01536     <span class="comment">// it has to be able to harvest the transaction numbers in certain failure cases.</span>
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     <span class="keywordflow">return</span> nRequestNum;
<a name="l01539"></a>01539 }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 
<a name="l01542"></a>01542 <span class="comment">// returns:</span>
<a name="l01543"></a>01543 <span class="comment">// -1 for error,</span>
<a name="l01544"></a>01544 <span class="comment">//  0 for server reply of failure,</span>
<a name="l01545"></a>01545 <span class="comment">//  1 for server reply of success</span>
<a name="l01546"></a>01546 <span class="comment">//</span>
<a name="l01547"></a><a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">01547</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">Utility::receiveReplySuccessLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID18, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> int32_t nRequestNumber7, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; IN_FUNCTION)
<a name="l01548"></a>01548 {
<a name="l01549"></a>01549     <span class="keywordtype">string</span> strReply = <a class="code" href="class_utility.html#a8bd3cff789307602e0ef5a29b911b8ce">ReceiveReplyLowLevel</a>(serverID18, nymID, nRequestNumber7, <span class="stringliteral">&quot;receiveReplySuccessLowLevel: &quot;</span> + IN_FUNCTION); <span class="comment">// &lt;=============== Here we RECEIVE the REPLY...</span>
<a name="l01550"></a>01550 
<a name="l01551"></a>01551     <span class="comment">// getLastReplyReceived() will also contain the same as strReply.</span>
<a name="l01552"></a>01552     <span class="comment">// So if the CALLER of this function (that we&#39;re in, receiveNymboxLowLevel)</span>
<a name="l01553"></a>01553     <span class="comment">// wants to see the contents, he can.</span>
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     <span class="comment">// ReceiveReplyLowLevel returns null unless there was a string returned.</span>
<a name="l01556"></a>01556     <span class="comment">// So we can directly check it for success...</span>
<a name="l01557"></a>01557 
<a name="l01558"></a>01558     <span class="keywordflow">return</span> <a class="code" href="ot__utility__ot_8hpp.html#afdbf3b63181963189d5f77bfd70bbb13">VerifyMessageSuccess</a>(strReply);
<a name="l01559"></a>01559 }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 <span class="comment">// Tries to receive a server reply</span>
<a name="l01563"></a>01563 <span class="comment">// (for a message that you presumably just sent.)</span>
<a name="l01564"></a>01564 <span class="comment">// If successful, returns the server reply. Otherwise returns null.</span>
<a name="l01565"></a>01565 <span class="comment">// (Successful meaning, a valid-formed message was received. Whether that is a</span>
<a name="l01566"></a>01566 <span class="comment">// &quot;success=true&quot; or &quot;success=false&quot; message, the caller will have to figure</span>
<a name="l01567"></a>01567 <span class="comment">// that out for himself.)</span>
<a name="l01568"></a>01568 <span class="comment">//</span>
<a name="l01569"></a><a class="code" href="class_utility.html#a8bd3cff789307602e0ef5a29b911b8ce">01569</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">string</span> <a class="code" href="class_utility.html#a8bd3cff789307602e0ef5a29b911b8ce">Utility::ReceiveReplyLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID17, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> int32_t nRequestNumber8, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; IN_FUNCTION)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571     <a class="code" href="class_utility.html#aca01f3986c5d18f3490c6950a3ebc894">delay</a>();
<a name="l01572"></a>01572     <a class="code" href="class_utility.html#ab5bdca5dc8f916c2daa50c791ffcdfb1">setLastReplyReceived</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a3b5867c23a08707f6b1df41d04e7d5d3">VerifyIntVal</a>(nRequestNumber8))
<a name="l01575"></a>01575     {
<a name="l01576"></a>01576         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;ReceiveReplyLowLevel (&quot;</span> + IN_FUNCTION + <span class="stringliteral">&quot;): nRequestNumber isn&#39;t a valid number.\n&quot;</span>);
<a name="l01577"></a>01577         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01578"></a>01578     }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     <span class="keywordtype">string</span> strResponseMessage = <a class="code" href="class_o_t_a_p_i___wrap.html#abb1006b47d0b435a01a327341471bdfc">OTAPI_Wrap::PopMessageBuffer</a>(int64_t(nRequestNumber8), serverID17, nymID);
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strResponseMessage))
<a name="l01582"></a>01582     {
<a name="l01583"></a>01583         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <span class="stringliteral">&quot;ReceiveReplyLowLevel (&quot;</span> + IN_FUNCTION + <span class="stringliteral">&quot;): null server reply!\n&quot;</span>);
<a name="l01584"></a>01584         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01585"></a>01585     }
<a name="l01586"></a>01586     <a class="code" href="class_utility.html#ab5bdca5dc8f916c2daa50c791ffcdfb1">setLastReplyReceived</a>(strResponseMessage);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     <span class="keywordflow">return</span> strResponseMessage;
<a name="l01589"></a>01589 }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591 
<a name="l01592"></a><a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">01592</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">Utility::getRequestNumber</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID)
<a name="l01593"></a>01593 {
<a name="l01594"></a>01594     <span class="keywordtype">bool</span> bWasSent = <span class="keyword">false</span>;
<a name="l01595"></a>01595     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID, bWasSent);
<a name="l01596"></a>01596 }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598 <span class="comment">// -1 == error (couldn&#39;t send, or couldn&#39;t receive)</span>
<a name="l01599"></a>01599 <span class="comment">// 0 = = success false (received reply from server);</span>
<a name="l01600"></a>01600 <span class="comment">// 1 = = success true  (received reply from server);</span>
<a name="l01601"></a>01601 <span class="comment">//</span>
<a name="l01602"></a>01602 <span class="comment">// To distinguish between error where message wasn&#39;t sent,</span>
<a name="l01603"></a>01603 <span class="comment">// and error where message WAS sent, but reply never received,</span>
<a name="l01604"></a>01604 <span class="comment">// bWasSent will be set to TRUE once this function is sure that</span>
<a name="l01605"></a>01605 <span class="comment">// it was sent out. (which you only care about if -1 was the</span>
<a name="l01606"></a>01606 <span class="comment">// return value;</span>
<a name="l01607"></a>01607 <span class="comment">// server reply, AND its status.</span>
<a name="l01608"></a>01608 <span class="comment">// DONE</span>
<a name="l01609"></a><a class="code" href="class_utility.html#a252176a94ca8f6db2b76a79266f21d3c">01609</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">Utility::getRequestNumber</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasSent) <span class="comment">// bWasSent is an output param allowing to return whether;</span>
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getRequestNumber&quot;</span>;
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     int32_t nResult = <a class="code" href="class_o_t_a_p_i___wrap.html#af42bdc7602ac9c589bea8c289e7fd660">OTAPI_Wrap::getRequest</a>(serverID, nymID);
<a name="l01616"></a>01616     <span class="keywordflow">if</span> (-1 == nResult)  <span class="comment">// if error -1, that means it DIDN&#39;T SEND (error)</span>
<a name="l01617"></a>01617     {
<a name="l01618"></a>01618         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getRequest message due to error.\n&quot;</span>);
<a name="l01619"></a>01619         <span class="keywordflow">return</span> -1;
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621     <span class="keywordflow">if</span> (0 == nResult)  <span class="comment">// if 0 is returned, that also means it DIDN&#39;T SEND (but there was NO error...)</span>
<a name="l01622"></a>01622     {                       <span class="comment">// I don&#39;t know if this case can actually even HAPPEN... but if it does, I&#39;ll log it.</span>
<a name="l01623"></a>01623         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send this getRequest message, but NO error occurred, either. (Should never happen.)\n&quot;</span>);
<a name="l01624"></a>01624         <span class="keywordflow">return</span> -1; <span class="comment">// Since the 0 case should never happen, I&#39;m returning it as an ERROR (-1).</span>
<a name="l01625"></a>01625         <span class="comment">// Note: I could never return 0;</span>
<a name="l01626"></a>01626         <span class="comment">// and that the server&#39;s reply said &quot;success == 0&quot;. But that&#39;s not what happened here. Here,</span>
<a name="l01627"></a>01627         <span class="comment">// we couldn&#39;t even SEND our request, which is an error</span>
<a name="l01628"></a>01628     }
<a name="l01629"></a>01629     <span class="comment">//</span>
<a name="l01630"></a>01630     <span class="comment">// else it&#39;s &gt;0  ==  successfully sent! (I BELIEVE this is 1, in this case, every time, since you don&#39;t NEED a request number to CALL getRequestNum since you are only calling it in the first place because it must have gotten out of sync.)</span>
<a name="l01631"></a>01631     <span class="comment">//</span>
<a name="l01632"></a>01632     bWasSent = <span class="keyword">true</span>;
<a name="l01633"></a>01633     <span class="comment">// ***************************************************</span>
<a name="l01634"></a>01634     <span class="comment">//</span>
<a name="l01635"></a>01635     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nResult, strLocation);
<a name="l01636"></a>01636     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getRequestNumber &quot; + getLastReplyReceived());</span>
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     <span class="comment">// BY this point, we definitely have the request number in nResult, which means</span>
<a name="l01639"></a>01639     <span class="comment">// the message was actually SENT. (At least.) This also means we can use nResult</span>
<a name="l01640"></a>01640     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l01641"></a>01641     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l01642"></a>01642     <span class="comment">//</span>
<a name="l01643"></a>01643     <span class="comment">//var nRemovedGetRequest = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nResult), serverID, nymID);</span>
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="comment">// NOTE: The above call is unnecessary, since a successful reply means</span>
<a name="l01646"></a>01646     <span class="comment">// we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l01647"></a>01647     <span class="comment">// already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     <span class="comment">//      if (nRemovedGetRequest &lt; 1)</span>
<a name="l01650"></a>01650     <span class="comment">//      {</span>
<a name="l01651"></a>01651     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getRequestNumber: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedGetRequest);</span>
<a name="l01652"></a>01652     <span class="comment">//      }</span>
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     <span class="keywordflow">return</span> nReturn;
<a name="l01655"></a>01655 }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657 
<a name="l01658"></a>01658 <span class="comment">// called by getBoxReceiptWithErrorCorrection   DONE</span>
<a name="l01659"></a><a class="code" href="class_utility.html#ac525e30eb94faab66f240d7a17a0e845">01659</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ac525e30eb94faab66f240d7a17a0e845">Utility::getBoxReceiptLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> int32_t nBoxType, <span class="keyword">const</span> int64_t strTransactionNum, <span class="keywordtype">bool</span> &amp; bWasSent) <span class="comment">// bWasSent is OTBool</span>
<a name="l01660"></a>01660 {
<a name="l01661"></a>01661     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getBoxReceiptLowLevel&quot;</span>;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     bWasSent = <span class="keyword">false</span>;
<a name="l01664"></a>01664 
<a name="l01665"></a>01665     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l01666"></a>01666 
<a name="l01667"></a>01667     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#a293ffd5e91bc298d8ead5dc389b7344b">OTAPI_Wrap::getBoxReceipt</a>(serverID, nymID, accountID, nBoxType, strTransactionNum); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l01668"></a>01668     <span class="keywordflow">if</span> (-2 == nRequestNum)
<a name="l01669"></a>01669     {
<a name="l01670"></a>01670         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l01671"></a>01671         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.);</span>
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l01674"></a>01674     {
<a name="l01675"></a>01675         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getNymbox message due to error.\n&quot;</span>);
<a name="l01676"></a>01676         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01677"></a>01677     }
<a name="l01678"></a>01678     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l01679"></a>01679     {
<a name="l01680"></a>01680         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send getNymbox message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l01681"></a>01681         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Even though &#39;0&#39; MEANS &quot;didn&#39;t send, but no error&quot; by convention in many places, it is actually an impossible return value;</span>
<a name="l01682"></a>01682     }
<a name="l01683"></a>01683     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l01684"></a>01684     {
<a name="l01685"></a>01685         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01686"></a>01686         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01687"></a>01687     }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689     bWasSent = <span class="keyword">true</span>;
<a name="l01690"></a>01690 
<a name="l01691"></a>01691     <span class="comment">// BY this point, we definitely have the request number, which means the</span>
<a name="l01692"></a>01692     <span class="comment">// message was actually SENT. (At least.) This also means we can use nRequestNum</span>
<a name="l01693"></a>01693     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l01694"></a>01694     <span class="comment">//</span>
<a name="l01695"></a>01695     <span class="comment">// ***************************************************</span>
<a name="l01696"></a>01696     <span class="comment">//</span>
<a name="l01697"></a>01697     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, strLocation);
<a name="l01698"></a>01698     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: nRequestNum: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot; /  nReturn: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700     <span class="comment">//     int32_t nRemovedGetBoxReceipt = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l01701"></a>01701     <span class="comment">//</span>
<a name="l01702"></a>01702     <span class="comment">//      // NOTE: The above call is unnecessary, since a successful reply means</span>
<a name="l01703"></a>01703     <span class="comment">//      // we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l01704"></a>01704     <span class="comment">//      // already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l01705"></a>01705     <span class="comment">//</span>
<a name="l01706"></a>01706     <span class="comment">//      if (nRemovedGetBoxReceipt &lt; 1)</span>
<a name="l01707"></a>01707     <span class="comment">//      {</span>
<a name="l01708"></a>01708     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getBoxReceiptLowLevel: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedGetBoxReceipt);</span>
<a name="l01709"></a>01709     <span class="comment">//      }</span>
<a name="l01710"></a>01710 
<a name="l01711"></a>01711     <span class="keywordflow">if</span> (nReturn &gt; 0)
<a name="l01712"></a>01712     {
<a name="l01713"></a>01713         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01714"></a>01714     }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: Response from server:\n&quot;</span> + <a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">getLastReplyReceived</a>() + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01717"></a>01717 
<a name="l01718"></a>01718     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01719"></a>01719 }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721 <span class="comment">// called by insureHaveAllBoxReceipts     DONE</span>
<a name="l01722"></a><a class="code" href="class_utility.html#a9987f4da96634939d1a2dce81b147d95">01722</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#a9987f4da96634939d1a2dce81b147d95">Utility::getBoxReceiptWithErrorCorrection</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> int32_t nBoxType, <span class="keyword">const</span> int64_t strTransactionNum) <span class="comment">// nBoxType is int32_t</span>
<a name="l01723"></a>01723 {
<a name="l01724"></a>01724     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getBoxReceiptWithErrorCorrection&quot;</span>;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726     <span class="keywordtype">bool</span> bWasSent = <span class="keyword">false</span>;
<a name="l01727"></a>01727     <span class="keywordtype">bool</span> bWasRequestSent = <span class="keyword">false</span>;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729     <span class="keywordflow">if</span> (<a class="code" href="class_utility.html#ac525e30eb94faab66f240d7a17a0e845">getBoxReceiptLowLevel</a>(serverID, nymID, accountID, nBoxType, strTransactionNum, bWasSent))
<a name="l01730"></a>01730     {
<a name="l01731"></a>01731         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01732"></a>01732     }
<a name="l01733"></a>01733     <span class="keywordflow">if</span> (bWasSent &amp;&amp; (1 == <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID, bWasRequestSent))) <span class="comment">// this might be out of sync, if it failed... we&#39;ll re-sync, and re-try.</span>
<a name="l01734"></a>01734     {
<a name="l01735"></a>01735         <span class="keywordflow">if</span> (bWasRequestSent &amp;&amp; <a class="code" href="class_utility.html#ac525e30eb94faab66f240d7a17a0e845">getBoxReceiptLowLevel</a>(serverID, nymID, accountID, nBoxType, strTransactionNum, bWasSent))
<a name="l01736"></a>01736         {
<a name="l01737"></a>01737             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01738"></a>01738         }
<a name="l01739"></a>01739         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getBoxReceiptLowLevel failed, then getRequestNumber succeeded, then getBoxReceiptLowLevel failed again. (I give up.)\n&quot;</span>);
<a name="l01740"></a>01740     }
<a name="l01741"></a>01741     <span class="keywordflow">else</span>
<a name="l01742"></a>01742     {
<a name="l01743"></a>01743         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, <a class="code" href="ot__otapi__ot_8hpp.html#af28213bb736d19ba8637019a486e3f76">concat</a>(strLocation + <span class="stringliteral">&quot;: getBoxReceiptLowLevel failed, then getRequestNumber failed. (I give up.) Was getRequest message sent: &quot;</span>,
<a name="l01744"></a>01744             <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(bWasRequestSent) + <span class="stringliteral">&quot;\n&quot;</span>));
<a name="l01745"></a>01745     }
<a name="l01746"></a>01746     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 <span class="comment">// This function assumes you just downloaded the latest version of the box (inbox, outbox, or nymbox)</span>
<a name="l01750"></a>01750 <span class="comment">// and its job is to make sure all the related box receipts are downloaded as well and available, though</span>
<a name="l01751"></a>01751 <span class="comment">// not necessarily loaded into memory. (Yet.)</span>
<a name="l01752"></a>01752 <span class="comment">// NOTE: If nBoxType is 0 (nymbox) then pass nymID as the accountID as well!</span>
<a name="l01753"></a>01753 <span class="comment">//</span>
<a name="l01754"></a><a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">01754</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">Utility::insureHaveAllBoxReceipts</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> int32_t nBoxType) <span class="comment">// nBoxType is int32_t</span>
<a name="l01755"></a>01755 {
<a name="l01756"></a>01756     <span class="keywordtype">bool</span> bFoundIt = <span class="keyword">false</span>;
<a name="l01757"></a>01757     int32_t nRequestSeeking = 0;
<a name="l01758"></a>01758     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, accountID, nBoxType, nRequestSeeking, bFoundIt);
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761 
<a name="l01762"></a><a class="code" href="class_utility.html#a3dfa4e51052f58f3a0df4e455692803e">01762</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">Utility::insureHaveAllBoxReceipts</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> int32_t nBoxType, <span class="keyword">const</span> int32_t nRequestSeeking, <span class="keywordtype">bool</span> &amp; bFoundIt)
<a name="l01763"></a>01763 {
<a name="l01764"></a>01764     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::insureHaveAllBoxReceipts&quot;</span>;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     <span class="keywordtype">string</span> ledger = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="keywordflow">if</span> (0 == nBoxType)
<a name="l01769"></a>01769     {
<a name="l01770"></a>01770         ledger = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID);
<a name="l01771"></a>01771     }
<a name="l01772"></a>01772     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1 == nBoxType)
<a name="l01773"></a>01773     {
<a name="l01774"></a>01774         ledger = <a class="code" href="class_o_t_a_p_i___wrap.html#a5a08b3ad80f4f3a5e08b78344f348e92" title="These versions don&#39;t verify the ledger, they just load it up.">OTAPI_Wrap::LoadInboxNoVerify</a>(serverID, nymID, accountID);
<a name="l01775"></a>01775     }
<a name="l01776"></a>01776     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (2 == nBoxType)
<a name="l01777"></a>01777     {
<a name="l01778"></a>01778         ledger = <a class="code" href="class_o_t_a_p_i___wrap.html#a856a83f6ea9395e127e9eaa0ddb59546">OTAPI_Wrap::LoadOutboxNoVerify</a>(serverID, nymID, accountID);
<a name="l01779"></a>01779     }
<a name="l01780"></a>01780     <span class="keywordflow">else</span>
<a name="l01781"></a>01781     {
<a name="l01782"></a>01782         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error. Expected nBoxType of 0,1,2 (nymbox, inbox, or outbox.)\n&quot;</span>);
<a name="l01783"></a>01783         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01784"></a>01784     }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     <span class="comment">// Unable to load or verify inbox/outbox/nymbox</span>
<a name="l01787"></a>01787     <span class="comment">// Notice I don&#39;t call VerifyAccount() here (not that the API even exposes</span>
<a name="l01788"></a>01788     <span class="comment">// that method) but why not? Because that method tries to load up all the</span>
<a name="l01789"></a>01789     <span class="comment">// box receipts, in addition to verifying the signature. Therefore I call</span>
<a name="l01790"></a>01790     <span class="comment">// &quot;Load XXXX NoVerify()&quot;, avoiding all that, then I verify the Signature</span>
<a name="l01791"></a>01791     <span class="comment">// itself. That&#39;s because this function&#39;s whole point is to find out what</span>
<a name="l01792"></a>01792     <span class="comment">// the box receipts are, and download them from the server. No point trying</span>
<a name="l01793"></a>01793     <span class="comment">// to load them before that time, when I know it will fail.</span>
<a name="l01794"></a>01794     <span class="comment">//</span>
<a name="l01795"></a>01795     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(ledger) || (!<a class="code" href="class_o_t_a_p_i___wrap.html#a519859fade0f73fd4c041794be42b37f">OTAPI_Wrap::VerifySignature</a>(nymID, ledger)))
<a name="l01796"></a>01796     {
<a name="l01797"></a>01797         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unable to load or verify signature on ledger. (Failure.) Contents:\n&quot;</span> + ledger + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01798"></a>01798         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01799"></a>01799     }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <span class="comment">// At this point, the box is definitely loaded.</span>
<a name="l01802"></a>01802     <span class="comment">// Next we&#39;ll iterate the receipts</span>
<a name="l01803"></a>01803     <span class="comment">// within, and for each, verify that the Box Receipt already exists. If not,</span>
<a name="l01804"></a>01804     <span class="comment">// then we&#39;ll download it using getBoxReceiptLowLevel(). If any download fails,</span>
<a name="l01805"></a>01805     <span class="comment">// then we break out of the loop (without continuing on to try the rest.)</span>
<a name="l01806"></a>01806     <span class="comment">//</span>
<a name="l01807"></a>01807     <span class="keywordtype">bool</span> bReturnValue = <span class="keyword">true</span>; <span class="comment">// Assuming an empty box, we return success;</span>
<a name="l01808"></a>01808 
<a name="l01809"></a>01809     int32_t nReceiptCount = <a class="code" href="class_o_t_a_p_i___wrap.html#adc7892cde5212b7eeb3fe1c75b3f2291" title="Find out how many pending transactions (and receipts) are in this inbox.">OTAPI_Wrap::Ledger_GetCount</a>(serverID, nymID, accountID, ledger);
<a name="l01810"></a>01810     <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a3b5867c23a08707f6b1df41d04e7d5d3">VerifyIntVal</a>(nReceiptCount) &amp;&amp; (nReceiptCount &gt; 0))
<a name="l01811"></a>01811     {
<a name="l01812"></a>01812         <span class="keywordflow">for</span> (int32_t i_loop = 0; i_loop &lt; nReceiptCount; ++i_loop) <span class="comment">// ******** FOR LOOP ****************</span>
<a name="l01813"></a>01813         {
<a name="l01814"></a>01814             int64_t lTransactionNum = <a class="code" href="class_o_t_a_p_i___wrap.html#a658a2d79b83a29fc5cf2d18dc0889856">OTAPI_Wrap::Ledger_GetTransactionIDByIndex</a>(serverID, nymID, accountID, ledger, i_loop);
<a name="l01815"></a>01815             <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a3b5867c23a08707f6b1df41d04e7d5d3">VerifyIntVal</a>(lTransactionNum) &amp;&amp; (lTransactionNum != -1))
<a name="l01816"></a>01816             {
<a name="l01817"></a>01817                 <span class="keywordflow">if</span> (lTransactionNum &gt; 0)
<a name="l01818"></a>01818                 {
<a name="l01819"></a>01819                     <span class="keywordtype">string</span> strTransaction = <a class="code" href="class_o_t_a_p_i___wrap.html#a0f2079d912ec13e9bace32d212efc4c8">OTAPI_Wrap::Ledger_GetTransactionByID</a>(serverID, nymID, accountID, ledger, lTransactionNum);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821                     <span class="comment">// Note: OTAPI_Wrap::Ledger_GetTransactionByID tries to get the full transaction from the ledger and</span>
<a name="l01822"></a>01822                     <span class="comment">// return it;</span>
<a name="l01823"></a>01823                     <span class="comment">// and pass the full version back to us. Failing that (perhaps the box receipt hasn&#39;t been downloaded</span>
<a name="l01824"></a>01824                     <span class="comment">// yet) then it will try to re-sign / re-save the abbreviated version and pass it back. So if, by this</span>
<a name="l01825"></a>01825                     <span class="comment">// point, it STILL has failed, that means it couldn&#39;t even give us the abbreviated version either!</span>
<a name="l01826"></a>01826                     <span class="comment">//</span>
<a name="l01827"></a>01827                     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strTransaction))
<a name="l01828"></a>01828                     {
<a name="l01829"></a>01829                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error: Null transaction somehow returned, (not even an abbreviated one!) even though I had a good ID &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(lTransactionNum)
<a name="l01830"></a>01830                             + <span class="stringliteral">&quot; which came originally as lTransactionNum: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(lTransactionNum) + <span class="stringliteral">&quot; for index: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(i_loop) + <span class="stringliteral">&quot; with the contents:\n\n&quot;</span> + strTransaction + <span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l01831"></a>01831                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01832"></a>01832                     }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834                     <span class="comment">// This block might have a full version, OR an abbreviated version of the box receipt in</span>
<a name="l01835"></a>01835                     <span class="comment">// question, in the strTransaction variable. It will attempt to download the full box</span>
<a name="l01836"></a>01836                     <span class="comment">// receipt, if we don&#39;t already have it here on the client side.</span>
<a name="l01837"></a>01837                     {
<a name="l01838"></a>01838                         <span class="keywordtype">string</span> strTransType = <a class="code" href="class_o_t_a_p_i___wrap.html#a6023b3d67960b596ca4146a132e6ff83" title="Get Transaction Type (internally uses GetTransactionTypeString().)">OTAPI_Wrap::Transaction_GetType</a>(serverID, nymID, accountID, strTransaction);
<a name="l01839"></a>01839                         <span class="keywordtype">bool</span> bIsReplyNotice = (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strTransType) &amp;&amp; (strTransType == <span class="stringliteral">&quot;replyNotice&quot;</span>));
<a name="l01840"></a>01840                         int64_t lRequestNum = 0;
<a name="l01841"></a>01841                         <span class="keywordflow">if</span> (bIsReplyNotice)
<a name="l01842"></a>01842                         {
<a name="l01843"></a>01843                             lRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#a8d6b69fb05930ea9411197137d10b6d5">OTAPI_Wrap::ReplyNotice_GetRequestNum</a>(serverID, nymID, strTransaction);
<a name="l01844"></a>01844                         }
<a name="l01845"></a>01845 
<a name="l01846"></a>01846                         <span class="keywordtype">bool</span> bShouldDownload = (!bIsReplyNotice ||
<a name="l01847"></a>01847                             (bIsReplyNotice &amp;&amp; (0 &lt; lRequestNum) &amp;&amp; !<a class="code" href="class_o_t_a_p_i___wrap.html#aee839704601f9d56f9eb21ca9c87469c">OTAPI_Wrap::HaveAlreadySeenReply</a>(serverID, nymID, lRequestNum)));
<a name="l01848"></a>01848 
<a name="l01849"></a>01849                         <span class="keywordflow">if</span> (bShouldDownload) <span class="comment">// This block executes if we should download it (assuming we haven&#39;t already, which it also checks for.)</span>
<a name="l01850"></a>01850                         {
<a name="l01851"></a>01851                             <span class="keywordtype">bool</span> bHaveBoxReceipt = <a class="code" href="class_o_t_a_p_i___wrap.html#ada7621c2729462f2d6822e64ec2f2b84">OTAPI_Wrap::DoesBoxReceiptExist</a>(serverID, nymID, accountID, nBoxType, lTransactionNum);
<a name="l01852"></a>01852                             <span class="keywordflow">if</span> (!bHaveBoxReceipt)
<a name="l01853"></a>01853                             {
<a name="l01854"></a>01854                                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: Downloading box receipt to add to my collection...\n&quot;</span>);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856                                 <span class="keywordtype">bool</span> bDownloaded = <a class="code" href="class_utility.html#a9987f4da96634939d1a2dce81b147d95">getBoxReceiptWithErrorCorrection</a>(serverID, nymID, accountID, nBoxType, lTransactionNum);
<a name="l01857"></a>01857                                 <span class="keywordflow">if</span> (!bDownloaded)
<a name="l01858"></a>01858                                 {
<a name="l01859"></a>01859                                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed downloading box receipt. (Skipping any others.) Transaction number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(lTransactionNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01860"></a>01860 
<a name="l01861"></a>01861                                     bReturnValue = <span class="keyword">false</span>;
<a name="l01862"></a>01862                                     <span class="keywordflow">break</span>;
<a name="l01863"></a>01863                                     <span class="comment">// No point continuing to loop and fail 500 times, when getBoxReceiptWithErrorCorrection() already failed</span>
<a name="l01864"></a>01864                                     <span class="comment">// even doing the getRequest() trick and everything, and whatever retries are inside OT, before it finally</span>
<a name="l01865"></a>01865                                     <span class="comment">// gave up.</span>
<a name="l01866"></a>01866                                 }
<a name="l01867"></a>01867                                 <span class="comment">// else (Download success.)</span>
<a name="l01868"></a>01868                             } <span class="comment">// if (!bHaveBoxReceipt)</span>
<a name="l01869"></a>01869                         }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871                         <span class="comment">// else we already have the box receipt, no need to download again.</span>
<a name="l01872"></a>01872                     }
<a name="l01873"></a>01873                 } <span class="comment">// if (lTransactionNum &gt; 0)</span>
<a name="l01874"></a>01874                 <span class="keywordflow">else</span>
<a name="l01875"></a>01875                 {
<a name="l01876"></a>01876                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error: TransactionNum less-than-or-equal-to 0.\n&quot;</span>);
<a name="l01877"></a>01877                 }
<a name="l01878"></a>01878             }
<a name="l01879"></a>01879             <span class="keywordflow">else</span>
<a name="l01880"></a>01880             {
<a name="l01881"></a>01881                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error: TransactionNum was null, when trying to read it based on the index (within bounds, too!)\n&quot;</span>);
<a name="l01882"></a>01882             }
<a name="l01883"></a>01883         } <span class="comment">// ************* FOR LOOP ******************</span>
<a name="l01884"></a>01884     } <span class="comment">// if (nReceiptCount &gt; 0)</span>
<a name="l01885"></a>01885 
<a name="l01886"></a>01886     <span class="comment">//</span>
<a name="l01887"></a>01887     <span class="comment">// if nRequestSeeking is &gt;0, that means the caller wants to know if there is a receipt present for that request number.</span>
<a name="l01888"></a>01888     <span class="comment">// (which is only a valid option ifnBoxType = = 0 for Nymbox.);</span>
<a name="l01889"></a>01889     <span class="comment">// IF the receipt is found, then bFoundIt is set to true.</span>
<a name="l01890"></a>01890     <span class="comment">//</span>
<a name="l01891"></a>01891     <span class="keywordflow">if</span> ((nRequestSeeking &gt; 0) &amp;&amp; (0 == nBoxType))
<a name="l01892"></a>01892     {
<a name="l01893"></a>01893         <span class="comment">// NOTE: the below call to OTAPI_Wrap::Nymbox_GetReplyNotice will succeed even if</span>
<a name="l01894"></a>01894         <span class="comment">// only the abbreviated receipt is available, because the caller mainly just</span>
<a name="l01895"></a>01895         <span class="comment">// wants to know if it is there.</span>
<a name="l01896"></a>01896         <span class="comment">// Technically the full receipt SHOULD always be there, with the above loop,</span>
<a name="l01897"></a>01897         <span class="comment">// but since the above loop can break in case of error, it&#39;s still possible that</span>
<a name="l01898"></a>01898         <span class="comment">// box receipts haven&#39;t been downloaded by the time you reach this code.</span>
<a name="l01899"></a>01899         <span class="comment">// Nevertheless, we will see if the reply is there for the appropriate request</span>
<a name="l01900"></a>01900         <span class="comment">// number, whether abbreviated or not.</span>
<a name="l01901"></a>01901         <span class="comment">//</span>
<a name="l01902"></a>01902         <span class="comment">// UPDATE: I am now adding specific cases where the replyNotice is NOT downloaded.</span>
<a name="l01903"></a>01903         <span class="comment">// You still use it, through its abbreviated version -- and the actual version</span>
<a name="l01904"></a>01904         <span class="comment">// IS still available for download through the server&#39;s API. But with a replyNotice,</span>
<a name="l01905"></a>01905         <span class="comment">// just knowing that it exists is usually enough for the client, who probably still</span>
<a name="l01906"></a>01906         <span class="comment">// has a cached copy of the original sent message anyway. Only in cases where he</span>
<a name="l01907"></a>01907         <span class="comment">// doesn&#39;t, would he need to download it. (Why? So he can process the server&#39;s reply.)</span>
<a name="l01908"></a>01908         <span class="comment">// Therefore the cached sent message is useless, since it doesn&#39;t contain the server&#39;s</span>
<a name="l01909"></a>01909         <span class="comment">// reply! Hmm. So I need that reply BUT ONLY IN CASES where I didn&#39;t already receive it</span>
<a name="l01910"></a>01910         <span class="comment">// as a normal part of processing (and that is MOST of the time, meaning most cases can</span>
<a name="l01911"></a>01911         <span class="comment">// thus entirely eliminate the download.)</span>
<a name="l01912"></a>01912         <span class="comment">//</span>
<a name="l01913"></a>01913         <span class="comment">// PROTOCOL FOR NOT DOWNLOADING MOST OF THE BOX RECEIPTS</span>
<a name="l01914"></a>01914         <span class="comment">//</span>
<a name="l01915"></a>01915         <span class="comment">// Solution: User messages should contain a list of the last X number of request numbers</span>
<a name="l01916"></a>01916         <span class="comment">// that they have DEFINITELY seen the response to. The server, meanwhile, since the user</span>
<a name="l01917"></a>01917         <span class="comment">// has DEFINITELY seen the response, can now safely remove the replyNotice from the Nymbox.</span>
<a name="l01918"></a>01918         <span class="comment">// The only reason it was there in the first place was to make sure the user got the reply.</span>
<a name="l01919"></a>01919         <span class="comment">// Since the user is straight-up acknowledging that he received it, the server no longer</span>
<a name="l01920"></a>01920         <span class="comment">// needs to &quot;make sure&quot; and thus it can remove that reply from the Nymbox, and mark the</span>
<a name="l01921"></a>01921         <span class="comment">// box receipt for deletion. This will be MOST REPLIES! We&#39;ll eliminate the step of having</span>
<a name="l01922"></a>01922         <span class="comment">// to download the box receipt.</span>
<a name="l01923"></a>01923         <span class="comment">// The above call to getBoxReceiptWithErrorCorrection should also be smart enough not to</span>
<a name="l01924"></a>01924         <span class="comment">// bother downloading any replyNotice Box Receipts if their request number appears on that</span>
<a name="l01925"></a>01925         <span class="comment">// list. Again: the list means I DEFINITELY already responded to it--if the request # is on</span>
<a name="l01926"></a>01926         <span class="comment">// that list, then NO NEED downloading the Box Receipt -- I DEFINITELY already got that reply!</span>
<a name="l01927"></a>01927         <span class="comment">//</span>
<a name="l01928"></a>01928         <span class="comment">// Therefore, Something like OTAPI_Wrap::HaveAlreadySeenReply(serverID, nymID, requestNum);</span>
<a name="l01929"></a>01929         <span class="comment">//</span>
<a name="l01930"></a>01930         <span class="comment">// Perhaps also, on the server side, send a list of request numbers for that Nym that the</span>
<a name="l01931"></a>01931         <span class="comment">// server KNOWS the Nym saw the reply to. This way, the Nym can remove the number from his</span>
<a name="l01932"></a>01932         <span class="comment">// list, and thus won&#39;t be continually causing the server to load up the Nymbox and try</span>
<a name="l01933"></a>01933         <span class="comment">// to remove the replyNotice (since it&#39;s already been removed.)</span>
<a name="l01934"></a>01934         <span class="comment">//</span>
<a name="l01935"></a>01935         <span class="comment">// The Nym doesn&#39;t have to keep a list of ALL request numbers he&#39;s seen the reply to.</span>
<a name="l01936"></a>01936         <span class="comment">// Rather, just the past X number of them, and with the number explicitly removed once</span>
<a name="l01937"></a>01937         <span class="comment">// he sees the server acknowledgment. (ServerAckOfAlreadyGotReply.)</span>
<a name="l01938"></a>01938         <span class="comment">//</span>
<a name="l01939"></a>01939         <span class="comment">// The server, meanwhile, is free to remove the ACK for any request # once he sees that</span>
<a name="l01940"></a>01940         <span class="comment">// the client has as well. Server also only needs to store a list of the past X request #s.</span>
<a name="l01941"></a>01941         <span class="comment">// Also: since both sides REMOVE the number, there need not necessarily be a limit on the</span>
<a name="l01942"></a>01942         <span class="comment">// size of the list, since it grows and shrinks as needed.</span>
<a name="l01943"></a>01943         <span class="comment">//</span>
<a name="l01944"></a>01944         <span class="comment">// Whenever Wallet processes a server reply, just see if it&#39;s on that &quot;replied to already&quot;</span>
<a name="l01945"></a>01945         <span class="comment">// list already on client side. If so, discard the reply. OTClient::ProcessServerReply probably</span>
<a name="l01946"></a>01946         <span class="comment">// best place to do  (We replied to it already, so discard it.)</span>
<a name="l01947"></a>01947         <span class="comment">// Also, for any server reply, look at the list of numbers on it. The server is acknowledging</span>
<a name="l01948"></a>01948         <span class="comment">// to us that it KNOWS we got those replies, and that it ALREADY has removed them from the</span>
<a name="l01949"></a>01949         <span class="comment">// Nymbox as a result. Therefore we can remove ALL of those numbers from our own list</span>
<a name="l01950"></a>01950         <span class="comment">// as well. No need for an API call to do this, since it will happen internally to OT.</span>
<a name="l01951"></a>01951         <span class="comment">//</span>
<a name="l01952"></a>01952         <span class="comment">// On the server side, any numbers on its own list were only there to acknowledge numbers</span>
<a name="l01953"></a>01953         <span class="comment">// that had been on the client side list. Therefore, when those numbers disappear from the</span>
<a name="l01954"></a>01954         <span class="comment">// client side list, the server simply removes them. Again: ANY NUMBERS on the server list,</span>
<a name="l01955"></a>01955         <span class="comment">// which do NOT appear on the client list, are REMOVED From the server list. After all, the</span>
<a name="l01956"></a>01956         <span class="comment">// client has clearly now removed them, so the server doesn&#39;t have to keep them around either.</span>
<a name="l01957"></a>01957         <span class="comment">//</span>
<a name="l01958"></a>01958         <span class="comment">// These are useful for synchronization but also there&#39;s a int64_t term benefit, if we include</span>
<a name="l01959"></a>01959         <span class="comment">// them in the signed receipt (which they will be already, if the receipt contains the entire</span>
<a name="l01960"></a>01960         <span class="comment">// message and not just the transaction.) That benefit is that we can prove receipt of notice.</span>
<a name="l01961"></a>01961         <span class="comment">// At least, notice of server replies. But for other notice types, such as notice of upcoming</span>
<a name="l01962"></a>01962         <span class="comment">// meeting. Or notice of upcoming election. Or notice of election outcome. Or notice of petition</span>
<a name="l01963"></a>01963         <span class="comment">// to put X issue on the next ballot, or to nominate Y Nym for some corporate role. Sometimes</span>
<a name="l01964"></a>01964         <span class="comment">// you want to be able to PROVE that notice was received. Does this prove that?</span>
<a name="l01965"></a>01965         <span class="comment">// Hmm, not necessarily. Currently I&#39;m using this as an optimization scheme, which is useful</span>
<a name="l01966"></a>01966         <span class="comment">// even if not provable. How to make it provable?</span>
<a name="l01967"></a>01967         <span class="comment">//</span>
<a name="l01968"></a>01968         <span class="comment">// Back from tangent: Wait a sec! If I notice the server that I saw the reply, the server will</span>
<a name="l01969"></a>01969         <span class="comment">// remove that reply from my Nymbox -- but it&#39;s still in my Nymbox on the client side! Until</span>
<a name="l01970"></a>01970         <span class="comment">// I download the latest Nymbox. Thus if I try to PROCESS MY NYMBOX, I will be attempting to</span>
<a name="l01971"></a>01971         <span class="comment">// accept a receipt that&#39;s already gone! (And the processNymbox will therefore FAIL!)</span>
<a name="l01972"></a>01972         <span class="comment">// Solution: be smart enough, when processing Nymbox, to IGNORE any replyNotices when the request</span>
<a name="l01973"></a>01973         <span class="comment">// Number appears on the client&#39;s list! As the wallet processes the Nymbox it should already</span>
<a name="l01974"></a>01974         <span class="comment">// know to skip the ones that were already replied-to.</span>
<a name="l01975"></a>01975         <span class="comment">// Meanwhile the server side will deliberately NOT update the Nymbox hash just because the receipt</span>
<a name="l01976"></a>01976         <span class="comment">// was removed. Otherwise it could trigger an unnecessary download of the Nymbox, when the whole</span>
<a name="l01977"></a>01977         <span class="comment">// point of this exercise was to prevent unnecessary downloads. It only updates the Nymbox hash</span>
<a name="l01978"></a>01978         <span class="comment">// when it WANTS me to download the Nymbox, and that certainly does NOT apply to cases where the</span>
<a name="l01979"></a>01979         <span class="comment">// only change involved the removal of some old receipt I already acknowledged. (No need to force</span>
<a name="l01980"></a>01980         <span class="comment">// any downloads based on THAT case, after all.)</span>
<a name="l01981"></a>01981         <span class="comment">//</span>
<a name="l01982"></a>01982         <span class="keywordtype">string</span> strReplyNotice = <a class="code" href="class_o_t_a_p_i___wrap.html#a0986f8a3cbac901bd17725a120cc8290">OTAPI_Wrap::Nymbox_GetReplyNotice</a>(serverID, nymID, int64_t(nRequestSeeking));
<a name="l01983"></a>01983 
<a name="l01984"></a>01984         <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strReplyNotice))
<a name="l01985"></a>01985         {
<a name="l01986"></a>01986             bFoundIt = <span class="keyword">true</span>;
<a name="l01987"></a>01987         }
<a name="l01988"></a>01988     }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <span class="keywordflow">return</span> bReturnValue;
<a name="l01991"></a>01991 }
<a name="l01992"></a>01992 
<a name="l01993"></a>01993 <span class="comment">/*</span>
<a name="l01994"></a>01994 <span class="comment">static void getBoxReceipt(  const std::string SERVER_ID,</span>
<a name="l01995"></a>01995 <span class="comment">const std::string USER_ID,</span>
<a name="l01996"></a>01996 <span class="comment">const std::string ACCT_ID, // If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l01997"></a>01997 <span class="comment">const int32_t  nBoxType, // 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l01998"></a>01998 <span class="comment">const std::string TRANSACTION_NUMBER);</span>
<a name="l01999"></a>01999 <span class="comment"></span>
<a name="l02000"></a>02000 <span class="comment">static bool DoesBoxReceiptExist(const std::string SERVER_ID,</span>
<a name="l02001"></a>02001 <span class="comment">const std::string USER_ID,</span>
<a name="l02002"></a>02002 <span class="comment">const std::string ACCT_ID, // If for Nymbox (vs inbox/outbox) then pass USER_ID in this field also.</span>
<a name="l02003"></a>02003 <span class="comment">const int32_t  nBoxType, // 0/nymbox, 1/inbox, 2/outbox</span>
<a name="l02004"></a>02004 <span class="comment">const std::string TRANSACTION_NUMBER);</span>
<a name="l02005"></a>02005 <span class="comment">*/</span>
<a name="l02006"></a>02006 <span class="comment">// If the transaction number requests fail, this function will try to resync</span>
<a name="l02007"></a>02007 <span class="comment">// the request number. But you still have to call getRequest() yourself if</span>
<a name="l02008"></a>02008 <span class="comment">// you have a failure in your own function, since you might already have</span>
<a name="l02009"></a>02009 <span class="comment">// enough transaction numbers, and thus this function will never get called,</span>
<a name="l02010"></a>02010 <span class="comment">// even if your request number IS out of sync. Sorry :-)</span>
<a name="l02011"></a>02011 <span class="comment">//</span>
<a name="l02012"></a>02012 
<a name="l02013"></a><a class="code" href="class_utility.html#a542c5b9409119aef3e1dce41d7904c03">02013</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a542c5b9409119aef3e1dce41d7904c03">Utility::getTransactionNumLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keywordtype">bool</span> &amp; bWasSent) <span class="comment">// bWasSent is OTBool</span>
<a name="l02014"></a>02014 {
<a name="l02015"></a>02015     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getTransactionNumLowLevel&quot;</span>;
<a name="l02016"></a>02016 
<a name="l02017"></a>02017     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l02018"></a>02018     bWasSent = <span class="keyword">false</span>;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#adf2fcc335490df1e05bffd6ac5040a05">OTAPI_Wrap::getTransactionNumber</a>(serverID, nymID); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l02021"></a>02021     <span class="keywordflow">if</span> (-2 == nRequestNum)
<a name="l02022"></a>02022     {
<a name="l02023"></a>02023         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l02024"></a>02024         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.)</span>
<a name="l02025"></a>02025     }
<a name="l02026"></a>02026     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l02027"></a>02027     {
<a name="l02028"></a>02028         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getNymbox message due to error.\n&quot;</span>);
<a name="l02029"></a>02029         <span class="keywordflow">return</span> -1;
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l02032"></a>02032     {
<a name="l02033"></a>02033         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpectedly returned 0. Didn&#39;t send getTransactionNum message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l02034"></a>02034         <span class="keywordflow">return</span> -1;  <span class="comment">// Even though &#39;0&#39; MEANS &quot;didn&#39;t send, but no error&quot; by convention in many places, it is actually an impossible return value;</span>
<a name="l02035"></a>02035     }
<a name="l02036"></a>02036     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l02037"></a>02037     {
<a name="l02038"></a>02038         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02039"></a>02039         <span class="keywordflow">return</span> -1;
<a name="l02040"></a>02040     }
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     bWasSent = <span class="keyword">true</span>;
<a name="l02043"></a>02043 
<a name="l02044"></a>02044     <span class="comment">// ***************************************************</span>
<a name="l02045"></a>02045     <span class="comment">//</span>
<a name="l02046"></a>02046     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, <span class="stringliteral">&quot;getTransactionNum&quot;</span>);
<a name="l02047"></a>02047     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getTransactionNum &quot; + getLastReplyReceived());</span>
<a name="l02048"></a>02048 
<a name="l02049"></a>02049     <span class="comment">// BY this point, we definitely have the request number in nResult, which means</span>
<a name="l02050"></a>02050     <span class="comment">// the message was actually SENT. (At least.) This also means we can use nResult</span>
<a name="l02051"></a>02051     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l02052"></a>02052     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l02053"></a>02053     <span class="comment">//</span>
<a name="l02054"></a>02054 
<a name="l02055"></a>02055     <span class="comment">// THE REMOVE SENT MESSAGE BELOW FAILS, LIKE IT&#39;S ALREADY GONE.</span>
<a name="l02056"></a>02056     <span class="comment">//</span>
<a name="l02057"></a>02057     <span class="comment">// THIS MUST BE DUE TO THE PROCESS SERVER REPLY THAT OCCURS **IMMEDIATELY** after the message was originally sent!</span>
<a name="l02058"></a>02058     <span class="comment">// (The reply came in and was sent to OT&#39;s &quot;ProcessServerReply&quot;, INSIDE the call to OTAPI_Wrap::getTransactionNumber.)</span>
<a name="l02059"></a>02059     <span class="comment">// Our subsequent &quot;receive&quot; (above) is nothing of the sort, but actually pops the incoming message buffer where</span>
<a name="l02060"></a>02060     <span class="comment">// the server&#39;s reply was ALREADY SITTING, since it was put there in OT&#39;s &quot;ProcessServerReply&quot;, WHICH REMOVED THE</span>
<a name="l02061"></a>02061     <span class="comment">// SENT MESSAGE ALREADY (that&#39;s why the below call to RemoveSentMessage fails.)</span>
<a name="l02062"></a>02062     <span class="comment">//</span>
<a name="l02063"></a>02063     <span class="comment">// RETHINK any logic that doesn&#39;t take this into account,.</span>
<a name="l02064"></a>02064     <span class="comment">// Either we REMOVE this call wherever this happens, OR... we call Get first and make sure whether it&#39;s</span>
<a name="l02065"></a>02065     <span class="comment">// there, THEN remove it. But we can&#39;t be lumping &quot;Failure because it&#39;s gone&quot; versus &quot;Error state&quot; by mixing</span>
<a name="l02066"></a>02066     <span class="comment">// 0 and -1 here. We need to differentiate.</span>
<a name="l02067"></a>02067     <span class="comment">//</span>
<a name="l02068"></a>02068     <span class="comment">// Bottom line: if the reply WAS received, then the original sent message has ALREADY been removed</span>
<a name="l02069"></a>02069     <span class="comment">// from the sent buffer. Whereas if the reply was NOT received, then the sent message is still there,</span>
<a name="l02070"></a>02070     <span class="comment">// but in that case, we do NOT want to remove it -- we want it to STAY in the sent buffer, so that</span>
<a name="l02071"></a>02071     <span class="comment">// when we get the Nymbox later and we DO have the reply from that, THEN we can remove the sent msg from</span>
<a name="l02072"></a>02072     <span class="comment">// the sent buffer. Until then, we don&#39;t want OT to think it&#39;s already been processed (which it will, if</span>
<a name="l02073"></a>02073     <span class="comment">// it&#39;s already been removed from the sent buffer. So we leave it there for now.)</span>
<a name="l02074"></a>02074     <span class="comment">//</span>
<a name="l02075"></a>02075     <span class="comment">//</span>
<a name="l02076"></a>02076     <span class="comment">//</span>
<a name="l02077"></a>02077     <span class="comment">//     int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l02078"></a>02078     <span class="comment">//</span>
<a name="l02079"></a>02079     <span class="comment">//      if (nRemovedSentMsg &lt; 1)</span>
<a name="l02080"></a>02080     <span class="comment">//      {</span>
<a name="l02081"></a>02081     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getTransactionNum: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedSentMsg);</span>
<a name="l02082"></a>02082     <span class="comment">//      }</span>
<a name="l02083"></a>02083 
<a name="l02084"></a>02084     <span class="keywordflow">if</span> (1 == nReturn)
<a name="l02085"></a>02085     {
<a name="l02086"></a>02086         <span class="keywordflow">return</span> nRequestNum;
<a name="l02087"></a>02087     }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <span class="keywordflow">return</span> nReturn;
<a name="l02090"></a>02090 }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092 
<a name="l02093"></a>02093 <span class="comment">// DONE</span>
<a name="l02094"></a><a class="code" href="class_utility.html#af469bfc39379af23989e185469bb9dbd">02094</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#af469bfc39379af23989e185469bb9dbd">Utility::getTransactionNumbers</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID)
<a name="l02095"></a>02095 {
<a name="l02096"></a>02096     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#af469bfc39379af23989e185469bb9dbd">getTransactionNumbers</a>(serverID, nymID, <span class="keyword">true</span>); <span class="comment">//bForceFirstCall = = true (by default) but in special cases you can override it and set it to false.</span>
<a name="l02097"></a>02097 }
<a name="l02098"></a>02098 
<a name="l02099"></a><a class="code" href="class_utility.html#a022490aee892af222c03cbe2f74c6739">02099</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#af469bfc39379af23989e185469bb9dbd">Utility::getTransactionNumbers</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceFirstCall) <span class="comment">// boolean bForceFirstCall defaults to true.</span>
<a name="l02100"></a>02100 {
<a name="l02101"></a>02101     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getTransactionNumbers&quot;</span>;
<a name="l02102"></a>02102 
<a name="l02103"></a>02103     <span class="keywordtype">bool</span> bWasSent = <span class="keyword">false</span>;
<a name="l02104"></a>02104     int32_t nGetNumbers = -1;
<a name="l02105"></a>02105     <span class="keywordflow">if</span> (bForceFirstCall)
<a name="l02106"></a>02106     {
<a name="l02107"></a>02107         nGetNumbers = <a class="code" href="class_utility.html#a542c5b9409119aef3e1dce41d7904c03">getTransactionNumLowLevel</a>(serverID, nymID, bWasSent); <span class="comment">// &lt;============ FIRST TRY;</span>
<a name="l02108"></a>02108     }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110     <span class="comment">// if the first call didn&#39;t happen, due to bForceFirstCall being false, that means the caller wants the rest of this to happen as though it did.</span>
<a name="l02111"></a>02111     <span class="comment">//</span>
<a name="l02112"></a>02112     <span class="keywordflow">if</span> (!bForceFirstCall || (bWasSent &amp;&amp; (nGetNumbers &gt;= 1)) || (!bWasSent &amp;&amp; (nGetNumbers == 0)))
<a name="l02113"></a>02113     {
<a name="l02114"></a>02114         <span class="comment">// Because it was successful, we have to now SIGN FOR those numbers we requested.</span>
<a name="l02115"></a>02115         <span class="comment">//</span>
<a name="l02116"></a>02116         <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02117"></a>02117         int32_t nProcess = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasSent, bForceDownload); <span class="comment">// bForceDownload=true;</span>
<a name="l02118"></a>02118 
<a name="l02119"></a>02119         <span class="keywordflow">if</span> ((bWasSent &amp;&amp; (1 == nProcess)) || (!bWasSent &amp;&amp; (0 == nProcess)))
<a name="l02120"></a>02120         {
<a name="l02121"></a>02121             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02122"></a>02122         }
<a name="l02123"></a>02123     }
<a name="l02124"></a>02124     <span class="comment">// If value is LESS THAN -1 (which is an unexpected value)</span>
<a name="l02125"></a>02125     <span class="comment">// or if the getTransactionNum message WASN&#39;T EVEN SENT, then return.</span>
<a name="l02126"></a>02126     <span class="comment">//</span>
<a name="l02127"></a>02127     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((nGetNumbers &lt; -1) || !bWasSent)
<a name="l02128"></a>02128     {
<a name="l02129"></a>02129         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNumbers) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02130"></a>02130         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132 
<a name="l02133"></a>02133     <span class="comment">// Below this point, the message WAS sent.  -1 is error, 0 is failure, &gt;0 is success.</span>
<a name="l02134"></a>02134     <span class="comment">// Now it&#39;s just about whether a reply was successful, or was even received.</span>
<a name="l02135"></a>02135     <span class="comment">//</span>
<a name="l02136"></a>02136     <span class="comment">//      else if ((-1 == nGetNumbers) ||   // Message sent, but then error receiving or loading the reply.</span>
<a name="l02137"></a>02137     <span class="comment">//               (( 0) == nGetNumbers))     // Received a reply, butstatus = = failure on that reply.;</span>
<a name="l02138"></a>02138 
<a name="l02139"></a>02139     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((-1 == nGetNumbers) || (0 == nGetNumbers))
<a name="l02140"></a>02140     {
<a name="l02141"></a>02141         <span class="keywordflow">if</span> (-1 == nGetNumbers)
<a name="l02142"></a>02142         {
<a name="l02143"></a>02143             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: getTransactionNumLowLevel did send, but returned error (-1). (Re-trying...)\n&quot;</span>);
<a name="l02144"></a>02144         }
<a name="l02145"></a>02145         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == nGetNumbers)
<a name="l02146"></a>02146         {
<a name="l02147"></a>02147             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: FYI: getTransactionNumLowLevel did send, but returned failure (0). (Re-trying...)\n&quot;</span>);
<a name="l02148"></a>02148         }
<a name="l02149"></a>02149 
<a name="l02150"></a>02150         int32_t nGetRequest = <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID);
<a name="l02151"></a>02151         <span class="keywordflow">if</span> (1 != nGetRequest)
<a name="l02152"></a>02152         {
<a name="l02153"></a>02153             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel failed, then I tried to resync with getRequestNumber and then that failed too. (I give up.)\n&quot;</span>);
<a name="l02154"></a>02154             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02155"></a>02155         }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157         <span class="comment">//</span>
<a name="l02158"></a>02158         <span class="keywordtype">bool</span> bWasProcessSent = <span class="keyword">false</span>;
<a name="l02159"></a>02159         <span class="keywordtype">bool</span> bFoundNymboxItem = <span class="keyword">false</span>;
<a name="l02160"></a>02160 
<a name="l02161"></a>02161         <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02162"></a>02162         int32_t nProcessNymbox = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasProcessSent, bForceDownload); <span class="comment">//boolean bForceDownload=true;</span>
<a name="l02163"></a>02163 
<a name="l02164"></a>02164         <span class="comment">//          if ( (!bWasProcessSent &amp;&amp; ((nProcessNymbox  &lt; 0) || (nProcessNymbox  &gt; 1))) ||</span>
<a name="l02165"></a>02165         <span class="comment">//               ( bWasProcessSent &amp;&amp; (nProcessNymbox  != 1)) ) // -1 error, 0 failed (harvesting success), 1 success, &gt;1 failed (harvesting NOT done) RequestNum is returned.</span>
<a name="l02166"></a>02166 
<a name="l02167"></a>02167         <span class="keywordflow">if</span> ((!bWasProcessSent &amp;&amp; ((nProcessNymbox  &lt; 0) || (nProcessNymbox  &gt; 1))) || (bWasProcessSent &amp;&amp; (nProcessNymbox != 1)))
<a name="l02168"></a>02168         {
<a name="l02169"></a>02169             <span class="comment">// todo: if request num is returned probably don&#39;t have to do anything with it.</span>
<a name="l02170"></a>02170             <span class="comment">// Why not?  Because future processNymbox will iterate Nymbox and search for all found</span>
<a name="l02171"></a>02171             <span class="comment">// items in the sent message buffer, and REMOVE them from it (as clearly they will be</span>
<a name="l02172"></a>02172             <span class="comment">// processed already.)</span>
<a name="l02173"></a>02173             <span class="comment">// The ones left over in the sent buffer, after this? Must be harvested!</span>
<a name="l02174"></a>02174             <span class="comment">// Hmm, solution: Use the &quot;Flush Sent Messages&quot; function, which is already</span>
<a name="l02175"></a>02175             <span class="comment">// there. Have it be smart enough to harvest all sent messages before flushing,</span>
<a name="l02176"></a>02176             <span class="comment">//</span>
<a name="l02177"></a>02177             <span class="comment">//</span>
<a name="l02178"></a>02178             <span class="keywordflow">if</span> (bWasProcessSent &amp;&amp; (nProcessNymbox &gt; 1))
<a name="l02179"></a>02179             {
<a name="l02180"></a>02180                 <span class="keywordtype">string</span> strNymbox = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID); <span class="comment">// FLUSH SENT MESSAGES!!!!  (AND HARVEST.);</span>
<a name="l02181"></a>02181 
<a name="l02182"></a>02182                 <span class="comment">// *******************************************************</span>
<a name="l02183"></a>02183                 <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strNymbox))
<a name="l02184"></a>02184                 {
<a name="l02185"></a>02185                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae404dd731fc2272e138880e97d4ce0a9">OTAPI_Wrap::FlushSentMessages</a>(<span class="keyword">false</span>, <span class="comment">//harvesting for retry = = OT_FALSE</span>
<a name="l02186"></a>02186                         serverID,
<a name="l02187"></a>02187                         nymID,
<a name="l02188"></a>02188                         strNymbox);
<a name="l02189"></a>02189                 }
<a name="l02190"></a>02190             }
<a name="l02191"></a>02191 
<a name="l02192"></a>02192             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getAndProcessNymbox. Returned value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nProcessNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02193"></a>02193 
<a name="l02194"></a>02194             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02195"></a>02195         }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197         nGetNumbers = <a class="code" href="class_utility.html#a542c5b9409119aef3e1dce41d7904c03">getTransactionNumLowLevel</a>(serverID, nymID, bWasSent); <span class="comment">// &lt;================= SECOND TRY;</span>
<a name="l02198"></a>02198 
<a name="l02199"></a>02199         <span class="comment">//          if ( ( bWasSent &amp;&amp; (nGetNumbers &gt;=  1)) || // if message was sent, and was a success.</span>
<a name="l02200"></a>02200         <span class="comment">//               (!bWasSent &amp;&amp; (nGetNumbers ==  0)) )  // Or if message wasn&#39;t sent due to &quot;you already signed out too many numbers--you need to process your Nymbox...&quot;</span>
<a name="l02201"></a>02201 
<a name="l02202"></a>02202         <span class="keywordflow">if</span> ((bWasSent &amp;&amp; (nGetNumbers &gt;= 1)) || (!bWasSent &amp;&amp; (nGetNumbers == 0)))
<a name="l02203"></a>02203         {
<a name="l02204"></a>02204             <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02205"></a>02205             int32_t nProcess = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasSent, bForceDownload); <span class="comment">// bForceDownload=true;</span>
<a name="l02206"></a>02206 
<a name="l02207"></a>02207             <span class="comment">//              if ( ( bWasSent &amp;&amp; (1 == nProcess)) ||</span>
<a name="l02208"></a>02208             <span class="comment">//                   (!bWasSent &amp;&amp; (0 == nProcess)) )</span>
<a name="l02209"></a>02209 
<a name="l02210"></a>02210             <span class="keywordflow">if</span> ((bWasSent &amp;&amp; (1 == nProcess)) || (!bWasSent &amp;&amp; (0 == nProcess)))
<a name="l02211"></a>02211             {
<a name="l02212"></a>02212                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02213"></a>02213             }
<a name="l02214"></a>02214         }
<a name="l02215"></a>02215         <span class="comment">//          else if (( nGetNumbers &lt; -1) ||</span>
<a name="l02216"></a>02216         <span class="comment">//                   (!bWasSent &amp;&amp; nGetNumbers != 0))</span>
<a name="l02217"></a>02217         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((nGetNumbers &lt; -1) || (!bWasSent &amp;&amp; nGetNumbers != 0))
<a name="l02218"></a>02218         {
<a name="l02219"></a>02219             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNumbers) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02220"></a>02220             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02221"></a>02221         }
<a name="l02222"></a>02222         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((-1 == nGetNumbers) || (0 == nGetNumbers))
<a name="l02223"></a>02223         {
<a name="l02224"></a>02224             <span class="keywordflow">if</span> (-1 == nGetNumbers)
<a name="l02225"></a>02225             {
<a name="l02226"></a>02226                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel did send, but returned error (-1), even after syncing the request number successfully. (Giving up.)\n&quot;</span>);
<a name="l02227"></a>02227             }
<a name="l02228"></a>02228             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == nGetNumbers)
<a name="l02229"></a>02229             {
<a name="l02230"></a>02230                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel did send, but returned failure (0), even after syncing the request number successfully. (Giving up.)\n&quot;</span>);
<a name="l02231"></a>02231             }
<a name="l02232"></a>02232 
<a name="l02233"></a>02233             <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235             int32_t nLast = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasProcessSent, bForceDownload); <span class="comment">//boolean bForceDownload=true;</span>
<a name="l02236"></a>02236             <span class="comment">//              if (</span>
<a name="l02237"></a>02237             <span class="comment">//                  ((!bWasProcessSent) &amp;&amp; ((nLast  &lt; 0) || (nLast  &gt; 1))) ||</span>
<a name="l02238"></a>02238             <span class="comment">//                  ((true  == bWasProcessSent) &amp;&amp;  (nLast != 1))</span>
<a name="l02239"></a>02239             <span class="comment">//                  ) // -1 error, 0 failed (harvesting success), 1 success, &gt;1 failed (harvesting NOT done) RequestNum is returned.</span>
<a name="l02240"></a>02240 
<a name="l02241"></a>02241             <span class="keywordflow">if</span> (((!bWasProcessSent) &amp;&amp; ((nLast  &lt; 0) || (nLast  &gt; 1))) || ((<span class="keyword">true</span> == bWasProcessSent) &amp;&amp; (nLast != 1))) <span class="comment">// -1 error, 0 failed (harvesting success), 1 success, &gt;1 failed (harvesting NOT done) RequestNum is returned.</span>
<a name="l02242"></a>02242             {
<a name="l02243"></a>02243                 <span class="keywordflow">if</span> (bWasProcessSent &amp;&amp; (nLast &gt; 1))
<a name="l02244"></a>02244                 {
<a name="l02245"></a>02245                     <span class="keywordtype">string</span> strNymbox = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID); <span class="comment">// FLUSH SENT MESSAGES!!!!  (AND HARVEST.);</span>
<a name="l02246"></a>02246 
<a name="l02247"></a>02247                     <span class="comment">// *******************************************************</span>
<a name="l02248"></a>02248                     <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strNymbox))
<a name="l02249"></a>02249                     {
<a name="l02250"></a>02250                         <a class="code" href="class_o_t_a_p_i___wrap.html#ae404dd731fc2272e138880e97d4ce0a9">OTAPI_Wrap::FlushSentMessages</a>(<span class="keyword">false</span>, <span class="comment">//harvesting for retry = = OT_FALSE</span>
<a name="l02251"></a>02251                             serverID,
<a name="l02252"></a>02252                             nymID,
<a name="l02253"></a>02253                             strNymbox);
<a name="l02254"></a>02254                     }
<a name="l02255"></a>02255                 }
<a name="l02256"></a>02256 
<a name="l02257"></a>02257                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getAndProcessNymbox. Returned value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nLast) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02258"></a>02258                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02259"></a>02259             }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261             nGetNumbers = <a class="code" href="class_utility.html#a542c5b9409119aef3e1dce41d7904c03">getTransactionNumLowLevel</a>(serverID, nymID, bWasSent); <span class="comment">// &lt;============ FIRST TRY;</span>
<a name="l02262"></a>02262 
<a name="l02263"></a>02263             <span class="comment">//              if ( (bWasSent &amp;&amp; (nGetNumbers &gt;= 1) )</span>
<a name="l02264"></a>02264             <span class="comment">//                   ||</span>
<a name="l02265"></a>02265             <span class="comment">//                   ((!bWasSent &amp;&amp; (nGetNumbers == 0) ) )</span>
<a name="l02266"></a>02266             <span class="comment">//                 )</span>
<a name="l02267"></a>02267 
<a name="l02268"></a>02268             <span class="keywordflow">if</span> ((bWasSent &amp;&amp; (nGetNumbers &gt;= 1)) || ((!bWasSent &amp;&amp; (nGetNumbers == 0))))
<a name="l02269"></a>02269             {
<a name="l02270"></a>02270                 <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02271"></a>02271                 int32_t nProcess = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasSent, bForceDownload); <span class="comment">// bForceDownload=true;</span>
<a name="l02272"></a>02272 
<a name="l02273"></a>02273                 <span class="comment">//                  if ( ( bWasSent &amp;&amp; (1 == nProcess)) ||</span>
<a name="l02274"></a>02274                 <span class="comment">//                       (!bWasSent &amp;&amp; (0 == nProcess)) )</span>
<a name="l02275"></a>02275 
<a name="l02276"></a>02276                 <span class="keywordflow">if</span> ((bWasSent &amp;&amp; (1 == nProcess)) || (!bWasSent &amp;&amp; (0 == nProcess)))
<a name="l02277"></a>02277                 {
<a name="l02278"></a>02278                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02279"></a>02279                 }
<a name="l02280"></a>02280             }
<a name="l02281"></a>02281 
<a name="l02282"></a>02282             <span class="comment">//              if ((nGetNumbers &lt; -1) ||         // If value is LESS THAN -1 (which is an unexpected value)</span>
<a name="l02283"></a>02283             <span class="comment">//                  !bWasSent)    // or if the getTransactionNum message WASN&#39;T EVEN SENT, then return.</span>
<a name="l02284"></a>02284 
<a name="l02285"></a>02285             <span class="keywordflow">if</span> ((nGetNumbers &lt; -1) || !bWasSent)
<a name="l02286"></a>02286             {
<a name="l02287"></a>02287                 <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getTransactionNumLowLevel returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNumbers) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02288"></a>02288                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02289"></a>02289             }
<a name="l02290"></a>02290         }
<a name="l02291"></a>02291     }
<a name="l02292"></a>02292 
<a name="l02293"></a>02293     <span class="comment">// BY THIS POINT, we have SUCCESSFULLY sent the getTransactionNumLowLevel message,</span>
<a name="l02294"></a>02294     <span class="comment">// and nGetNumbers contains its request number.</span>
<a name="l02295"></a>02295 
<a name="l02296"></a>02296 
<a name="l02297"></a>02297     <span class="comment">// No need to read the result, as getTransactionNumLowLevel() already read it,</span>
<a name="l02298"></a>02298     <span class="comment">// and and it&#39;s available anytime via getLastReplyReceived()</span>
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     <span class="keywordtype">string</span> <a class="code" href="class_utility.html#a00936996be8e795003e5e57149446114">strLastReplyReceived</a> = <a class="code" href="class_utility.html#a41a51fc2cb1a609654b625769ef08519">getLastReplyReceived</a>();
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLastReplyReceived))
<a name="l02303"></a>02303     {
<a name="l02304"></a>02304         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR in getLastReplyReceived(): why was this string not set, when getRequestNumber was otherwise an apparent success?\n&quot;</span>);
<a name="l02305"></a>02305         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// (SHOULD NEVER HAPPEN. This string is set in the getRequestNumber function.);</span>
<a name="l02306"></a>02306     }
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="comment">// BY THIS POINT, we have received a server reply:  @getTransactionNum</span>
<a name="l02309"></a>02309     <span class="comment">// (Unless it is malformed.) It&#39;s definitely not null, nor empty.</span>
<a name="l02310"></a>02310 
<a name="l02311"></a>02311     <span class="comment">// Grab the NymboxHash on the @getTransactionNum reply, and also the one I</span>
<a name="l02312"></a>02312     <span class="comment">// already had on my client-side Nym... (So we can compare them.)</span>
<a name="l02313"></a>02313     <span class="comment">//</span>
<a name="l02314"></a>02314     <span class="keywordtype">string</span> strServerHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a42803f459dcf9ecc1c3ee4bccf917746">OTAPI_Wrap::Message_GetNymboxHash</a>(strLastReplyReceived);
<a name="l02315"></a>02315     <span class="keywordtype">bool</span> bServerhash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strServerHash);
<a name="l02316"></a>02316     <span class="keywordflow">if</span> (!bServerhash)
<a name="l02317"></a>02317     {
<a name="l02318"></a>02318         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve server-side NymboxHash from OT, from server @getTransactionNum reply:\n\n&quot;</span> + strLastReplyReceived + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02319"></a>02319         <span class="comment">//          return false;</span>
<a name="l02320"></a>02320     }
<a name="l02321"></a>02321 
<a name="l02322"></a>02322     <span class="keywordtype">string</span> strLocalHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a17de0af836994eb5d28f9e843ffde769">OTAPI_Wrap::GetNym_NymboxHash</a>(serverID, nymID);
<a name="l02323"></a>02323     <span class="keywordtype">bool</span> bLocalhash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLocalHash);
<a name="l02324"></a>02324     <span class="keywordflow">if</span> (!bLocalhash)
<a name="l02325"></a>02325     {
<a name="l02326"></a>02326         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve client-side NymboxHash from OT, for:\n serverID: &quot;</span> + serverID + <span class="stringliteral">&quot;\n nymID: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02327"></a>02327         <span class="comment">//          return false;</span>
<a name="l02328"></a>02328     }
<a name="l02329"></a>02329 
<a name="l02330"></a>02330     <span class="comment">// the hashes don&#39;t match -- so let&#39;s definitely re-try to download the latest nymbox.</span>
<a name="l02331"></a>02331     <span class="comment">//</span>
<a name="l02332"></a>02332     <span class="keywordflow">if</span> (!bServerhash || !bLocalhash || (bServerhash &amp;&amp; bLocalhash &amp;&amp; !(strServerHash == strLocalHash)))
<a name="l02333"></a>02333     {
<a name="l02334"></a>02334         <span class="comment">// the getRequest worked, and the server hashes don&#39;t match,</span>
<a name="l02335"></a>02335         <span class="comment">// so let&#39;s get and process the Nymbox...</span>
<a name="l02336"></a>02336         <span class="comment">//</span>
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         <span class="keywordtype">bool</span> bWasProcessSent = <span class="keyword">false</span>;
<a name="l02339"></a>02339         <span class="keywordtype">bool</span> bFoundNymboxItem = <span class="keyword">false</span>;
<a name="l02340"></a>02340 
<a name="l02341"></a>02341         <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">true</span>;
<a name="l02342"></a>02342         int32_t nGetNymbox = <a class="code" href="class_utility.html#ad6d2691529e14cbcdc6023797428aa26">getAndProcessNymbox_4</a>(serverID, nymID, bWasProcessSent, bForceDownload); <span class="comment">//boolean bForceDownload=true;</span>
<a name="l02343"></a>02343 
<a name="l02344"></a>02344         <span class="comment">//          if ( ((!bWasProcessSent) &amp;&amp; ((nGetNymbox  &lt; 0) || (nGetNymbox  &gt; 1))) ||</span>
<a name="l02345"></a>02345         <span class="comment">//               ((true  == bWasProcessSent) &amp;&amp; (nGetNymbox != 1)) ) // -1 error, 0 failed (harvesting success), 1 success, &gt;1 failed (harvesting NOT done) RequestNum is returned.</span>
<a name="l02346"></a>02346 
<a name="l02347"></a>02347         <span class="keywordflow">if</span> (((!bWasProcessSent) &amp;&amp; ((nGetNymbox  &lt; 0) || (nGetNymbox  &gt; 1))) || ((<span class="keyword">true</span> == bWasProcessSent) &amp;&amp; (nGetNymbox != 1)))
<a name="l02348"></a>02348         {
<a name="l02349"></a>02349             <span class="keywordflow">if</span> (nGetNymbox &gt; 1)
<a name="l02350"></a>02350             {
<a name="l02351"></a>02351                 <span class="keywordtype">string</span> strNymbox = <a class="code" href="class_o_t_a_p_i___wrap.html#a40953d1314416f6735616d66e3028712">OTAPI_Wrap::LoadNymboxNoVerify</a>(serverID, nymID); <span class="comment">// FLUSH SENT MESSAGES!!!!  (AND HARVEST.);</span>
<a name="l02352"></a>02352 
<a name="l02353"></a>02353                 <span class="comment">// *******************************************************</span>
<a name="l02354"></a>02354                 <span class="keywordflow">if</span> (<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strNymbox))
<a name="l02355"></a>02355                 {
<a name="l02356"></a>02356                     <a class="code" href="class_o_t_a_p_i___wrap.html#ae404dd731fc2272e138880e97d4ce0a9">OTAPI_Wrap::FlushSentMessages</a>(<span class="keyword">false</span>, <span class="comment">//harvesting for retry = = OT_FALSE</span>
<a name="l02357"></a>02357                         serverID,
<a name="l02358"></a>02358                         nymID,
<a name="l02359"></a>02359                         strNymbox);
<a name="l02360"></a>02360                 }
<a name="l02361"></a>02361             }
<a name="l02362"></a>02362 
<a name="l02363"></a>02363             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getAndProcessNymbox returned unexpected value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nGetNymbox) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02364"></a>02364             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02365"></a>02365         }
<a name="l02366"></a>02366         <span class="keywordflow">if</span> (-1 == nGetNymbox) <span class="comment">// we&#39;ll try re-syncing the request number, then try again.</span>
<a name="l02367"></a>02367         {
<a name="l02368"></a>02368             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getAndProcessNymbox returned -1, even after syncing the request number successfully. (Giving up.)\n&quot;</span>);
<a name="l02369"></a>02369             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02370"></a>02370         }
<a name="l02371"></a>02371     }
<a name="l02372"></a>02372 
<a name="l02373"></a>02373     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02374"></a>02374 }
<a name="l02375"></a>02375 
<a name="l02376"></a>02376 
<a name="l02377"></a><a class="code" href="class_utility.html#afcf37cb45c40719b2d6d81f0202f96ab">02377</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#afcf37cb45c40719b2d6d81f0202f96ab">Utility::getIntermediaryFiles</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID)
<a name="l02378"></a>02378 {
<a name="l02379"></a>02379     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l02380"></a>02380     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#afcf37cb45c40719b2d6d81f0202f96ab">getIntermediaryFiles</a>(serverID, nymID, accountID, bForceDownload);
<a name="l02381"></a>02381 }
<a name="l02382"></a>02382 
<a name="l02383"></a>02383 <span class="comment">// DEPRECATED</span>
<a name="l02384"></a><a class="code" href="class_utility.html#ae7f64d3fed00450d31b4659607918e0d">02384</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ae7f64d3fed00450d31b4659607918e0d">Utility::getIntermediaryFiles_old</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload) <span class="comment">// booleanbForceDownload = false;</span>
<a name="l02385"></a>02385 {
<a name="l02386"></a>02386     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getIntermediaryFiles_old&quot;</span>;
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(serverID) || serverID.size() &lt; 10)
<a name="l02389"></a>02389     {
<a name="l02390"></a>02390         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid serverID.\n&quot;</span>);
<a name="l02391"></a>02391         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02392"></a>02392     }
<a name="l02393"></a>02393     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(nymID) || nymID.size() &lt; 10)
<a name="l02394"></a>02394     {
<a name="l02395"></a>02395         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid nymID.\n&quot;</span>);
<a name="l02396"></a>02396         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02397"></a>02397     }
<a name="l02398"></a>02398     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(accountID) || accountID.size() &lt; 10)
<a name="l02399"></a>02399     {
<a name="l02400"></a>02400         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid accountID.\n&quot;</span>);
<a name="l02401"></a>02401         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02402"></a>02402     }
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="keywordtype">bool</span> bWasSentInbox = <span class="keyword">false</span>;
<a name="l02405"></a>02405     <span class="keywordtype">bool</span> bWasSentAccount = <span class="keyword">false</span>;
<a name="l02406"></a>02406 
<a name="l02407"></a>02407     int32_t nGetInboxAcct = <a class="code" href="class_utility.html#a146d2bf737526cc31e0f8473aed7e36e">getInboxAccount_old</a>(serverID, nymID, accountID, bWasSentInbox, bWasSentAccount, bForceDownload);
<a name="l02408"></a>02408 
<a name="l02409"></a>02409     <span class="comment">// if we received an error state, and the &quot;getAccount&quot; message wasn&#39;t even sent,</span>
<a name="l02410"></a>02410     <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02411"></a>02411     <span class="comment">//</span>
<a name="l02412"></a>02412     <span class="keywordflow">if</span> ((-1 == nGetInboxAcct) &amp;&amp; !bWasSentAccount)
<a name="l02413"></a>02413     {
<a name="l02414"></a>02414         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount_old failed, without even sending getAccount. (Returning false.)\n&quot;</span>);
<a name="l02415"></a>02415         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02416"></a>02416     }
<a name="l02417"></a>02417 
<a name="l02418"></a>02418     <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02419"></a>02419     <span class="comment">// no error: we already have the latest inbox. (Nothing done.)</span>
<a name="l02420"></a>02420     <span class="comment">//</span>
<a name="l02421"></a>02421     <span class="keywordflow">if</span> (!bWasSentInbox &amp;&amp; (0 == nGetInboxAcct))
<a name="l02422"></a>02422     {
<a name="l02423"></a>02423         <span class="comment">// we don&#39;t return true;</span>
<a name="l02424"></a>02424     }
<a name="l02425"></a>02425     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1 != nGetInboxAcct)
<a name="l02426"></a>02426     {
<a name="l02427"></a>02427         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount_old failed. (Trying one more time...)\n&quot;</span>);
<a name="l02428"></a>02428 
<a name="l02429"></a>02429         int32_t nGetRequest = <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID);
<a name="l02430"></a>02430         <span class="keywordflow">if</span> (1 != nGetRequest)
<a name="l02431"></a>02431         {
<a name="l02432"></a>02432             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getInboxAccount_old failed, then I tried to resync with getRequestNumber and then that failed too. (I give up.)\n&quot;</span>);
<a name="l02433"></a>02433             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02434"></a>02434         }
<a name="l02435"></a>02435 
<a name="l02436"></a>02436         int32_t nSecondtry = <a class="code" href="class_utility.html#a146d2bf737526cc31e0f8473aed7e36e">getInboxAccount_old</a>(serverID, nymID, accountID, bWasSentInbox, bWasSentAccount, bForceDownload);
<a name="l02437"></a>02437         <span class="keywordflow">if</span> ((-1 == nSecondtry) &amp;&amp; !bWasSentAccount)
<a name="l02438"></a>02438         {
<a name="l02439"></a>02439             <span class="comment">// if we received an error state, and the &quot;getAccount&quot; message wasn&#39;t even sent,</span>
<a name="l02440"></a>02440             <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02441"></a>02441             <span class="comment">//</span>
<a name="l02442"></a>02442             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount_old failed a second time, without even sending getAccount. (Returning false.)\n&quot;</span>);
<a name="l02443"></a>02443             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02444"></a>02444         }
<a name="l02445"></a>02445         <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02446"></a>02446         <span class="comment">// no error: we already have the latest inbox. (Nothing done.)</span>
<a name="l02447"></a>02447         <span class="comment">//</span>
<a name="l02448"></a>02448         <span class="keywordflow">if</span> (!bWasSentInbox &amp;&amp; (0 == nSecondtry))
<a name="l02449"></a>02449         {
<a name="l02450"></a>02450             <span class="comment">// we don&#39;t return true;</span>
<a name="l02451"></a>02451         }
<a name="l02452"></a>02452         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1 != nSecondtry)
<a name="l02453"></a>02453         {
<a name="l02454"></a>02454             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount_old re-try failed. (That&#39;s twice now--Returning false.) Value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nSecondtry) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02455"></a>02455             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02456"></a>02456         }
<a name="l02457"></a>02457         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount_old second call succeeded. (Continuing...)\n&quot;</span>);
<a name="l02458"></a>02458     }
<a name="l02459"></a>02459     <span class="comment">// *****************************************************************************</span>
<a name="l02460"></a>02460 
<a name="l02461"></a>02461     <span class="keywordtype">bool</span> bWasSentOutbox = <span class="keyword">false</span>;
<a name="l02462"></a>02462 
<a name="l02463"></a>02463     int32_t nGetOutbox = <a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">getOutboxLowLevel</a>(serverID, nymID, accountID, bWasSentOutbox, bForceDownload);
<a name="l02464"></a>02464 
<a name="l02465"></a>02465     <span class="keywordflow">if</span> (-1 == nGetOutbox &amp;&amp; !bWasSentOutbox)
<a name="l02466"></a>02466     {
<a name="l02467"></a>02467         <span class="comment">// if we received an error state, and the &quot;getOutbox&quot; message wasn&#39;t even sent,</span>
<a name="l02468"></a>02468         <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02469"></a>02469         <span class="comment">//</span>
<a name="l02470"></a>02470         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutboxLowLevel failed, without even sending getOutbox. (Returning false.)\n&quot;</span>);
<a name="l02471"></a>02471         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02472"></a>02472     }
<a name="l02473"></a>02473     <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means the</span>
<a name="l02474"></a>02474     <span class="comment">// outbox we have is already the latest version.</span>
<a name="l02475"></a>02475     <span class="comment">//</span>
<a name="l02476"></a>02476     <span class="keywordflow">if</span> (!bWasSentOutbox &amp;&amp; 0 == nGetOutbox)
<a name="l02477"></a>02477     {
<a name="l02478"></a>02478         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02479"></a>02479     }
<a name="l02480"></a>02480 
<a name="l02481"></a>02481     <span class="keywordflow">if</span> (1 != nGetOutbox)
<a name="l02482"></a>02482     {
<a name="l02483"></a>02483         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutboxLowLevel failed. (Trying one more time...)\n&quot;</span>);
<a name="l02484"></a>02484 
<a name="l02485"></a>02485         int32_t nGetRequest = <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID);
<a name="l02486"></a>02486         <span class="keywordflow">if</span> (1 != nGetRequest)
<a name="l02487"></a>02487         {
<a name="l02488"></a>02488             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getOutboxLowLevel failed, then I tried to resync with getRequestNumber and then that failed too. (I give up.)\n&quot;</span>);
<a name="l02489"></a>02489             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02490"></a>02490         }
<a name="l02491"></a>02491 
<a name="l02492"></a>02492         int32_t nSecondtry = <a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">getOutboxLowLevel</a>(serverID, nymID, accountID, bWasSentOutbox, bForceDownload);
<a name="l02493"></a>02493         <span class="keywordflow">if</span> ((-1 == nSecondtry) &amp;&amp; !bWasSentOutbox)
<a name="l02494"></a>02494         {
<a name="l02495"></a>02495             <span class="comment">// if we received an error state, and the &quot;getOutbox&quot; message wasn&#39;t even sent,</span>
<a name="l02496"></a>02496             <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02497"></a>02497             <span class="comment">//</span>
<a name="l02498"></a>02498             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutboxLowLevel failed a second time, without even sending getOutbox. (Returning false.)\n&quot;</span>);
<a name="l02499"></a>02499             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02500"></a>02500         }
<a name="l02501"></a>02501         <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02502"></a>02502         <span class="comment">// no error: we already have the latest outbox. (Nothing done.)</span>
<a name="l02503"></a>02503         <span class="comment">//</span>
<a name="l02504"></a>02504         <span class="keywordflow">if</span> (!bWasSentOutbox &amp;&amp; (0 == nSecondtry))
<a name="l02505"></a>02505         {
<a name="l02506"></a>02506             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02507"></a>02507         }
<a name="l02508"></a>02508 
<a name="l02509"></a>02509         <span class="keywordflow">if</span> (1 != nSecondtry)
<a name="l02510"></a>02510         {
<a name="l02511"></a>02511             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutboxLowLevel re-try failed. (That&#39;s twice now--Returning false.) Value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nSecondtry) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02512"></a>02512             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02513"></a>02513         }
<a name="l02514"></a>02514         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutboxLowLevel second call succeeded. (Continuing...)\n&quot;</span>);
<a name="l02515"></a>02515     }
<a name="l02516"></a>02516 
<a name="l02517"></a>02517     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02518"></a>02518 }
<a name="l02519"></a>02519 
<a name="l02520"></a>02520 
<a name="l02521"></a>02521 <span class="comment">// NOTE: This is a new version, that uses getInboxAccount new version, which</span>
<a name="l02522"></a>02522 <span class="comment">// uses getAccountFiles instead of getAccount, getInbox, and getOutbox.</span>
<a name="l02523"></a><a class="code" href="class_utility.html#aa20c934ec6b8e7c8fb4c1ed6f7bf617e">02523</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#afcf37cb45c40719b2d6d81f0202f96ab">Utility::getIntermediaryFiles</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload) <span class="comment">// booleanbForceDownload = false;</span>
<a name="l02524"></a>02524 {
<a name="l02525"></a>02525     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getIntermediaryFiles&quot;</span>;
<a name="l02526"></a>02526 
<a name="l02527"></a>02527     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(serverID) || serverID.size() &lt; 10)
<a name="l02528"></a>02528     {
<a name="l02529"></a>02529         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid serverID.\n&quot;</span>);
<a name="l02530"></a>02530         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02531"></a>02531     }
<a name="l02532"></a>02532     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(nymID) || nymID.size() &lt; 10)
<a name="l02533"></a>02533     {
<a name="l02534"></a>02534         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid nymID.\n&quot;</span>);
<a name="l02535"></a>02535         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02536"></a>02536     }
<a name="l02537"></a>02537     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(accountID) || accountID.size() &lt; 10)
<a name="l02538"></a>02538     {
<a name="l02539"></a>02539         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: NULL or invalid accountID.\n&quot;</span>);
<a name="l02540"></a>02540         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02541"></a>02541     }
<a name="l02542"></a>02542 
<a name="l02543"></a>02543     <span class="keywordtype">bool</span> bWasSentInbox = <span class="keyword">false</span>;
<a name="l02544"></a>02544     <span class="keywordtype">bool</span> bWasSentAccount = <span class="keyword">false</span>;
<a name="l02545"></a>02545 
<a name="l02546"></a>02546     <span class="comment">// This is a new version of getInboxAccount that downloads ALL</span>
<a name="l02547"></a>02547     <span class="comment">// THREE files (account/inbox/outbox) in a single server message.</span>
<a name="l02548"></a>02548     <span class="comment">//</span>
<a name="l02549"></a>02549     int32_t nGetInboxAcct = <a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">getInboxAccount</a>(serverID, nymID, accountID, bWasSentInbox, bWasSentAccount, bForceDownload);
<a name="l02550"></a>02550 
<a name="l02551"></a>02551     <span class="comment">// if we received an error state, and the &quot;getAccountFiles&quot; message wasn&#39;t even sent,</span>
<a name="l02552"></a>02552     <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02553"></a>02553     <span class="comment">//</span>
<a name="l02554"></a>02554     <span class="keywordflow">if</span> (-1 == nGetInboxAcct)
<a name="l02555"></a>02555     {
<a name="l02556"></a>02556         <span class="keywordflow">if</span> (!bWasSentAccount)
<a name="l02557"></a>02557         {
<a name="l02558"></a>02558             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: this.getInboxAccount failed, without even sending getAccountFiles. (Returning false.)\n&quot;</span>);
<a name="l02559"></a>02559             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02560"></a>02560         }
<a name="l02561"></a>02561     }
<a name="l02562"></a>02562 
<a name="l02563"></a>02563 
<a name="l02564"></a>02564     <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02565"></a>02565     <span class="comment">// no error: we already have the latest inbox. (Nothing done.)</span>
<a name="l02566"></a>02566     <span class="comment">//</span>
<a name="l02567"></a>02567     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bWasSentInbox &amp;&amp; (0 == nGetInboxAcct))
<a name="l02568"></a>02568     {
<a name="l02569"></a>02569         <span class="comment">// we don&#39;t return true;</span>
<a name="l02570"></a>02570     }
<a name="l02571"></a>02571     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1 != nGetInboxAcct)
<a name="l02572"></a>02572     {
<a name="l02573"></a>02573         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount failed. (Trying one more time...)\n&quot;</span>);
<a name="l02574"></a>02574 
<a name="l02575"></a>02575         int32_t nGetRequest = <a class="code" href="class_utility.html#afd115fbf7b749ce17059191a07865edf">getRequestNumber</a>(serverID, nymID);
<a name="l02576"></a>02576         <span class="keywordflow">if</span> (1 != nGetRequest)
<a name="l02577"></a>02577         {
<a name="l02578"></a>02578             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failure: getInboxAccount failed, then I tried to resync with getRequestNumber and then that failed too. (I give up.)\n&quot;</span>);
<a name="l02579"></a>02579             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02580"></a>02580         }
<a name="l02581"></a>02581         <span class="keywordflow">else</span> <span class="comment">// TODO: REMOVE THIS BLOCK ONCE THE SERVERS ALL SUPPORT NEW &quot;getAccountFiles&quot; message.</span>
<a name="l02582"></a>02582         {
<a name="l02583"></a>02583             <span class="comment">// Maybe the server doesn&#39;t support the new getAccountFiles</span>
<a name="l02584"></a>02584             <span class="comment">// message yet -- so let&#39;s just call the old version of the function we&#39;re currently in.</span>
<a name="l02585"></a>02585 
<a name="l02586"></a>02586             <span class="comment">// TODO: LONGER TERM, remove this call to _old entirely.</span>
<a name="l02587"></a>02587             <span class="comment">// AND: remove this &#39;else&#39; -- just let it fall through to the getRequest / retry.</span>
<a name="l02588"></a>02588             <span class="comment">//</span>
<a name="l02589"></a>02589             <span class="comment">// UNTIL WE REMOVE THIS, any sync issue with the request number will cause this</span>
<a name="l02590"></a>02590             <span class="comment">// function to download the account/inbox/outbox individually, due to this call</span>
<a name="l02591"></a>02591             <span class="comment">// here to the old version.</span>
<a name="l02592"></a>02592 
<a name="l02593"></a>02593             <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ae7f64d3fed00450d31b4659607918e0d">getIntermediaryFiles_old</a>(serverID, nymID, accountID, bForceDownload);
<a name="l02594"></a>02594         }
<a name="l02595"></a>02595 
<a name="l02597"></a>02597 
<a name="l02598"></a>02598         <span class="comment">// We sync&#39;d the request number, so now we try the function again...</span>
<a name="l02599"></a>02599         <span class="comment">//</span>
<a name="l02600"></a>02600         int32_t nSecondtry = <a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">getInboxAccount</a>(serverID, nymID, accountID, bWasSentInbox, bWasSentAccount, bForceDownload);
<a name="l02601"></a>02601 
<a name="l02602"></a>02602         <span class="keywordflow">if</span> ((-1 == nSecondtry) &amp;&amp; !bWasSentAccount)
<a name="l02603"></a>02603         {
<a name="l02604"></a>02604             <span class="comment">// if we received an error state, and the &quot;getAccountFiles&quot; message wasn&#39;t even sent,</span>
<a name="l02605"></a>02605             <span class="comment">// then no point doing a bunch of retries -- it failed.</span>
<a name="l02606"></a>02606             <span class="comment">//</span>
<a name="l02607"></a>02607             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount failed a second time, without even sending getAccountFiles. (Returning false.)\n&quot;</span>);
<a name="l02608"></a>02608             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02609"></a>02609         }
<a name="l02610"></a>02610         <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02611"></a>02611         <span class="comment">// no error: we already have the latest inbox. (Nothing done.)</span>
<a name="l02612"></a>02612         <span class="comment">//</span>
<a name="l02613"></a>02613         <span class="keywordflow">if</span> (!bWasSentInbox &amp;&amp; (0 == nSecondtry))
<a name="l02614"></a>02614         {
<a name="l02615"></a>02615             <span class="comment">// we don&#39;t return true;</span>
<a name="l02616"></a>02616         }
<a name="l02617"></a>02617         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1 != nSecondtry)
<a name="l02618"></a>02618         {
<a name="l02619"></a>02619             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount re-try failed. (That&#39;s twice now--Returning false.) Value: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nSecondtry) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02620"></a>02620             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02621"></a>02621         }
<a name="l02622"></a>02622         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxAccount second call succeeded. (Continuing...)\n&quot;</span>);
<a name="l02623"></a>02623     }
<a name="l02624"></a>02624 
<a name="l02625"></a>02625     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02626"></a>02626 }
<a name="l02627"></a>02627 
<a name="l02628"></a>02628 
<a name="l02629"></a>02629 <span class="comment">// NOTE: This is a new version that uses the new server message, getAccountFiles</span>
<a name="l02630"></a>02630 <span class="comment">// (Which combines getAccount, getInbox, and getOutbox into a single message.)</span>
<a name="l02631"></a><a class="code" href="class_utility.html#ad4599a3d5ab440ca221980b5c903a454">02631</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">Utility::getInboxAccount</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSentInbox, <span class="keywordtype">bool</span> &amp; bWasSentAccount, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload) <span class="comment">//bForceDownload=false</span>
<a name="l02632"></a>02632 {
<a name="l02633"></a>02633     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getInboxAccount&quot;</span>;
<a name="l02634"></a>02634 
<a name="l02635"></a>02635     bWasSentAccount = <span class="keyword">false</span>;
<a name="l02636"></a>02636     bWasSentInbox = <span class="keyword">false</span>;
<a name="l02637"></a>02637 
<a name="l02638"></a>02638     <span class="comment">// ***************************************************</span>
<a name="l02639"></a>02639     <span class="comment">//</span>
<a name="l02640"></a>02640     <span class="comment">// (Success means both were downloaded, if necessary.)</span>
<a name="l02641"></a>02641     <span class="comment">//</span>
<a name="l02642"></a>02642     <span class="comment">// FIRST WE DO THE ACCOUNT...</span>
<a name="l02643"></a>02643     <span class="comment">//</span>
<a name="l02644"></a>02644     <span class="comment">// ***************************************************</span>
<a name="l02645"></a>02645     <span class="comment">// GET ACCOUNT</span>
<a name="l02646"></a>02646     <span class="comment">//</span>
<a name="l02647"></a>02647     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l02648"></a>02648 
<a name="l02649"></a>02649     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#ad928fc7e8648507f2e2f8b50e38ccc20">OTAPI_Wrap::getAccountFiles</a>(serverID, nymID, accountID); <span class="comment">// &lt;===== ATTEMPT TO SEND MESSAGE;</span>
<a name="l02650"></a>02650     <span class="keywordflow">if</span> (-2 == nRequestNum)
<a name="l02651"></a>02651     {
<a name="l02652"></a>02652         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l02653"></a>02653         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.)</span>
<a name="l02654"></a>02654     }
<a name="l02655"></a>02655     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l02656"></a>02656     {
<a name="l02657"></a>02657         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getAccountFiles message due to error.\n&quot;</span>);
<a name="l02658"></a>02658         <span class="keywordflow">return</span> -1;
<a name="l02659"></a>02659     }
<a name="l02660"></a>02660     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l02661"></a>02661     {
<a name="l02662"></a>02662         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send getAccountFiles message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l02663"></a>02663         <span class="keywordflow">return</span> -1;
<a name="l02664"></a>02664     }
<a name="l02665"></a>02665     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l02666"></a>02666     {
<a name="l02667"></a>02667         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected failure sending getAccountFiles. Request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02668"></a>02668         <span class="keywordflow">return</span> -1;
<a name="l02669"></a>02669     }
<a name="l02670"></a>02670 
<a name="l02671"></a>02671     bWasSentAccount = <span class="keyword">true</span>;
<a name="l02672"></a>02672     bWasSentInbox = <span class="keyword">true</span>;
<a name="l02673"></a>02673 
<a name="l02674"></a>02674     <span class="comment">// ***************************************************</span>
<a name="l02675"></a>02675     <span class="comment">// -1 for error</span>
<a name="l02676"></a>02676     <span class="comment">//  0 for reply: failure</span>
<a name="l02677"></a>02677     <span class="comment">//  1 for reply: success</span>
<a name="l02678"></a>02678     <span class="comment">//</span>
<a name="l02679"></a>02679     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, <span class="stringliteral">&quot;getInboxAccount&quot;</span>); <span class="comment">// &lt;============ RETURN VALUE;</span>
<a name="l02680"></a>02680     <span class="keywordflow">if</span> (nReturn &lt; 0) <span class="comment">// error</span>
<a name="l02681"></a>02681     {
<a name="l02682"></a>02682         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error in getAccountFiles: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn) + <span class="stringliteral">&quot;.  (I give up.)\n&quot;</span>);
<a name="l02683"></a>02683         <span class="keywordflow">return</span> -1;
<a name="l02684"></a>02684     }
<a name="l02685"></a>02685 
<a name="l02686"></a>02686     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getInboxAccount &quot; + getLastReplyReceived());</span>
<a name="l02687"></a>02687 
<a name="l02688"></a>02688     <span class="comment">// BY this point, we definitely have the request number, which means the</span>
<a name="l02689"></a>02689     <span class="comment">// message was actually SENT. (At least.) This also means we can use nRequestNum</span>
<a name="l02690"></a>02690     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l02691"></a>02691     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l02692"></a>02692     <span class="comment">//</span>
<a name="l02693"></a>02693 
<a name="l02694"></a>02694     <span class="comment">//     int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l02695"></a>02695     <span class="comment">//</span>
<a name="l02696"></a>02696     <span class="comment">//      // NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l02697"></a>02697     <span class="comment">//      // we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l02698"></a>02698     <span class="comment">//      // already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l02699"></a>02699     <span class="comment">//</span>
<a name="l02700"></a>02700     <span class="comment">//      if (nRemovedSentMsg &lt; 1) // (not success.)</span>
<a name="l02701"></a>02701     <span class="comment">//      {</span>
<a name="l02702"></a>02702     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getInboxAccount: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedSentMsg);</span>
<a name="l02703"></a>02703     <span class="comment">//      }</span>
<a name="l02704"></a>02704 
<a name="l02705"></a>02705     <span class="comment">// ***************************************************</span>
<a name="l02706"></a>02706 
<a name="l02707"></a>02707     <span class="keywordflow">if</span> (1 != nReturn)
<a name="l02708"></a>02708     {
<a name="l02709"></a>02709         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getAccountFiles failed, returning: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02710"></a>02710         <span class="keywordflow">return</span> nReturn;
<a name="l02711"></a>02711     }
<a name="l02712"></a>02712 
<a name="l02713"></a>02713     <span class="comment">// DOWNLOAD THE BOX RECEIPTS.</span>
<a name="l02714"></a>02714     <span class="keywordflow">if</span> (!<a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, accountID, 1)) <span class="comment">// &lt;===== nBoxType = 1 aka INBOX;</span>
<a name="l02715"></a>02715     {
<a name="l02716"></a>02716         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getAccountFiles succeeded, but then insureHaveAllBoxReceipts failed on the inbox. (I give up.)\n&quot;</span>);
<a name="l02717"></a>02717         <span class="keywordflow">return</span> -1;
<a name="l02718"></a>02718     }
<a name="l02719"></a>02719 
<a name="l02720"></a>02720     <span class="keywordflow">if</span> (!<a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, accountID, 2)) <span class="comment">// &lt;===== nBoxType = 2 aka OUTBOX;</span>
<a name="l02721"></a>02721     {
<a name="l02722"></a>02722         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getAccountFiles succeeded, but then insureHaveAllBoxReceipts failed on the outbox. (I give up.)\n&quot;</span>);
<a name="l02723"></a>02723         <span class="keywordflow">return</span> -1;
<a name="l02724"></a>02724     }
<a name="l02725"></a>02725 
<a name="l02726"></a>02726     <span class="keywordflow">return</span> 1;
<a name="l02727"></a>02727 }
<a name="l02728"></a>02728 
<a name="l02729"></a>02729 
<a name="l02730"></a>02730 <span class="comment">// Same as the above function, except you only have to pass the accountID.</span>
<a name="l02731"></a>02731 <span class="comment">// (instead of 3 IDs...)</span>
<a name="l02732"></a>02732 <span class="comment">//</span>
<a name="l02733"></a><a class="code" href="class_utility.html#ace00803d49059bc75277ecb7712b1bd5">02733</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ace00803d49059bc75277ecb7712b1bd5">Utility::getInboxOutboxAccount</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID)
<a name="l02734"></a>02734 {
<a name="l02735"></a>02735     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l02736"></a>02736     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ace00803d49059bc75277ecb7712b1bd5">getInboxOutboxAccount</a>(accountID, bForceDownload);
<a name="l02737"></a>02737 }
<a name="l02738"></a>02738 
<a name="l02739"></a><a class="code" href="class_utility.html#a28dcdd17394214ea61ea708899c5d746">02739</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> <span class="keywordtype">bool</span> <a class="code" href="class_utility.html#ace00803d49059bc75277ecb7712b1bd5">Utility::getInboxOutboxAccount</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload) <span class="comment">// booleanbForceDownload = false;</span>
<a name="l02740"></a>02740 {
<a name="l02741"></a>02741     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getInboxOutboxAccount&quot;</span>;
<a name="l02742"></a>02742 
<a name="l02743"></a>02743     <span class="keywordflow">if</span> (!<a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(accountID) || accountID.size() &lt; 10)
<a name="l02744"></a>02744     {
<a name="l02745"></a>02745         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: invalid accountID: &quot;</span> + accountID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02746"></a>02746         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02747"></a>02747     }
<a name="l02748"></a>02748 
<a name="l02749"></a>02749     <span class="keywordtype">string</span> serverID = <a class="code" href="class_o_t_a_p_i___wrap.html#a938435d114f98fbb2ff8d8b932521296">OTAPI_Wrap::GetAccountWallet_ServerID</a>(accountID);
<a name="l02750"></a>02750     <span class="keywordtype">string</span> nymID = <a class="code" href="class_o_t_a_p_i___wrap.html#a8c70b106ba3957ebcc5abce3e3404dfe">OTAPI_Wrap::GetAccountWallet_NymID</a>(accountID);
<a name="l02751"></a>02751     <span class="keywordflow">if</span> (!<a class="code" href="class_utility.html#afcf37cb45c40719b2d6d81f0202f96ab">getIntermediaryFiles</a>(serverID, nymID, accountID, bForceDownload))
<a name="l02752"></a>02752     {
<a name="l02753"></a>02753         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getIntermediaryFiles failed. (Returning.)\n&quot;</span>);
<a name="l02754"></a>02754         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02755"></a>02755     }
<a name="l02756"></a>02756 
<a name="l02757"></a>02757     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02758"></a>02758 }
<a name="l02759"></a>02759 
<a name="l02760"></a>02760 <span class="comment">// getInboxAccount()</span>
<a name="l02761"></a>02761 <span class="comment">// Grabs the &quot;Account&quot;, which is the intermediary file containing the current balance, verified against</span>
<a name="l02762"></a>02762 <span class="comment">// last signed receipt. Server must have your signature on the last balance agreement plus, if applicable,</span>
<a name="l02763"></a>02763 <span class="comment">// any inbox receipts (box receipts), also with your signature, in order to justify the current balance.</span>
<a name="l02764"></a>02764 <span class="comment">// Any inbox receipts, further, are only valid if they each contain a transaction number that was previously</span>
<a name="l02765"></a>02765 <span class="comment">// already signed out to you.</span>
<a name="l02766"></a>02766 <span class="comment">// (As you can see, the &quot;account&quot; is not a list of transactions, as per the classical understanding in</span>
<a name="l02767"></a>02767 <span class="comment">// double-entry accounting, but instead it&#39;s just a signed balance agreement, plus any as-yet-unclosed</span>
<a name="l02768"></a>02768 <span class="comment">// transactions that have cleared since that balance was last signed, and are still waiting in the inbox</span>
<a name="l02769"></a>02769 <span class="comment">// for the next balance agreement to be signed when they can be removed.)</span>
<a name="l02770"></a>02770 
<a name="l02771"></a>02771 <span class="comment">// In addition to the &quot;Account&quot; there is also the Inbox itself, as well as all of its box receipts.</span>
<a name="l02772"></a>02772 <span class="comment">// The box receipts are stored in abbreviated form in the Inbox itself, with the actual full</span>
<a name="l02773"></a>02773 <span class="comment">// versions in separate files. These are retrieved individually from the server after the inbox itself</span>
<a name="l02774"></a>02774 <span class="comment">// is, and then each is verified against a hash kept inside its abbreviated version.)</span>
<a name="l02775"></a>02775 <span class="comment">// DONE</span>
<a name="l02776"></a><a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">02776</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">Utility::getInboxAccount</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSentInbox, <span class="keywordtype">bool</span> &amp; bWasSentAccount)
<a name="l02777"></a>02777 {
<a name="l02778"></a>02778     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l02779"></a>02779     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#a1f4589a6ee859d8b0b0ea25cdf3766d0">getInboxAccount</a>(serverID, nymID, accountID, bWasSentInbox, bWasSentAccount, bForceDownload);
<a name="l02780"></a>02780 }
<a name="l02781"></a>02781 
<a name="l02782"></a>02782 <span class="comment">// DEPRECATED</span>
<a name="l02783"></a><a class="code" href="class_utility.html#a146d2bf737526cc31e0f8473aed7e36e">02783</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#a146d2bf737526cc31e0f8473aed7e36e">Utility::getInboxAccount_old</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSentInbox, <span class="keywordtype">bool</span> &amp; bWasSentAccount, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForceDownload) <span class="comment">//bForceDownload=false</span>
<a name="l02784"></a>02784 {
<a name="l02785"></a>02785     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getInboxAccount_old&quot;</span>;
<a name="l02786"></a>02786 
<a name="l02787"></a>02787     bWasSentAccount = <span class="keyword">false</span>;
<a name="l02788"></a>02788     bWasSentInbox = <span class="keyword">false</span>;
<a name="l02789"></a>02789 
<a name="l02790"></a>02790     <span class="comment">// ***************************************************</span>
<a name="l02791"></a>02791     <span class="comment">//</span>
<a name="l02792"></a>02792     <span class="comment">// (Success means both were downloaded, if necessary.)</span>
<a name="l02793"></a>02793     <span class="comment">//</span>
<a name="l02794"></a>02794     <span class="comment">// FIRST WE DO THE ACCOUNT...</span>
<a name="l02795"></a>02795     <span class="comment">//</span>
<a name="l02796"></a>02796     <span class="comment">// ***************************************************</span>
<a name="l02797"></a>02797     <span class="comment">// GET ACCOUNT</span>
<a name="l02798"></a>02798     <span class="comment">//</span>
<a name="l02799"></a>02799     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l02800"></a>02800 
<a name="l02801"></a>02801     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#a06cb5d61a5940aaecb72279ceb39238e">OTAPI_Wrap::getAccount</a>(serverID, nymID, accountID); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l02802"></a>02802 
<a name="l02803"></a>02803     <span class="keywordflow">if</span> ((-2) == nRequestNum)
<a name="l02804"></a>02804     {
<a name="l02805"></a>02805         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l02806"></a>02806         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.)</span>
<a name="l02807"></a>02807     }
<a name="l02808"></a>02808     <span class="keywordflow">if</span> (-1 == nRequestNum)
<a name="l02809"></a>02809     {
<a name="l02810"></a>02810         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getAccount message due to error.\n&quot;</span>);
<a name="l02811"></a>02811         <span class="keywordflow">return</span> -1;
<a name="l02812"></a>02812     }
<a name="l02813"></a>02813     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l02814"></a>02814     {
<a name="l02815"></a>02815         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send getAccount message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l02816"></a>02816         <span class="keywordflow">return</span> -1;
<a name="l02817"></a>02817     }
<a name="l02818"></a>02818     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l02819"></a>02819     {
<a name="l02820"></a>02820         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected failure sending getAccount(). Request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02821"></a>02821         <span class="keywordflow">return</span> -1;
<a name="l02822"></a>02822     }
<a name="l02823"></a>02823 
<a name="l02824"></a>02824     bWasSentAccount = <span class="keyword">true</span>;
<a name="l02825"></a>02825 
<a name="l02826"></a>02826     <span class="comment">// ***************************************************</span>
<a name="l02827"></a>02827     <span class="comment">// -1 for error</span>
<a name="l02828"></a>02828     <span class="comment">//  0 for reply: failure</span>
<a name="l02829"></a>02829     <span class="comment">//  1 for reply: success</span>
<a name="l02830"></a>02830     <span class="comment">//</span>
<a name="l02831"></a>02831     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, <span class="stringliteral">&quot;getInboxAccount&quot;</span>); <span class="comment">// &lt;============ RETURN VALUE;</span>
<a name="l02832"></a>02832 
<a name="l02833"></a>02833     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getInboxAccount &quot; + getLastReplyReceived());</span>
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     <span class="keywordtype">bool</span> bAccount = 1 == nReturn;
<a name="l02836"></a>02836 
<a name="l02837"></a>02837     <span class="comment">// BY this point, we definitely have the request number, which means the</span>
<a name="l02838"></a>02838     <span class="comment">// message was actually SENT. (At least.) This also means we can use nRequestNum</span>
<a name="l02839"></a>02839     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l02840"></a>02840     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l02841"></a>02841     <span class="comment">//</span>
<a name="l02842"></a>02842 
<a name="l02843"></a>02843     <span class="comment">//     int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l02844"></a>02844     <span class="comment">//</span>
<a name="l02845"></a>02845     <span class="comment">//      // NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l02846"></a>02846     <span class="comment">//      // we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l02847"></a>02847     <span class="comment">//      // already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l02848"></a>02848     <span class="comment">//</span>
<a name="l02849"></a>02849     <span class="comment">//      if (nRemovedSentMsg &lt; 1) // (not success.)</span>
<a name="l02850"></a>02850     <span class="comment">//      {</span>
<a name="l02851"></a>02851     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getInboxAccount: ERROR: OT_API_RemoveSentMessage returned: &quot; + nRemovedSentMsg);</span>
<a name="l02852"></a>02852     <span class="comment">//      }</span>
<a name="l02853"></a>02853 
<a name="l02854"></a>02854     <span class="keywordflow">if</span> (nReturn &lt; 0) <span class="comment">// error</span>
<a name="l02855"></a>02855     {
<a name="l02856"></a>02856         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Error in getAccount: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn) + <span class="stringliteral">&quot;.  (I give up.)\n&quot;</span>);
<a name="l02857"></a>02857         <span class="keywordflow">return</span> -1;
<a name="l02858"></a>02858     }
<a name="l02859"></a>02859     <span class="comment">// ***************************************************</span>
<a name="l02860"></a>02860 
<a name="l02861"></a>02861     <span class="keywordflow">if</span> (!bAccount)
<a name="l02862"></a>02862     {
<a name="l02863"></a>02863         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getAccount failed, returning: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02864"></a>02864         <span class="keywordflow">return</span> nReturn;
<a name="l02865"></a>02865     }
<a name="l02866"></a>02866 
<a name="l02867"></a>02867     int32_t nReturn2 = <a class="code" href="class_utility.html#ac257e532b323bbb3cd841749b0565da7">getInboxLowLevel</a>(serverID, nymID, accountID, bWasSentInbox, bForceDownload);
<a name="l02868"></a>02868 
<a name="l02869"></a>02869     <span class="comment">// If it wasn&#39;t sent, and 0 was returned, that means</span>
<a name="l02870"></a>02870     <span class="comment">// no error: we already have the latest inbox. (Nothing done.)</span>
<a name="l02871"></a>02871     <span class="comment">//</span>
<a name="l02872"></a>02872     <span class="keywordflow">if</span> (!bWasSentInbox &amp;&amp; (0 == nReturn2))
<a name="l02873"></a>02873     {
<a name="l02874"></a>02874         <span class="keywordflow">return</span> 0;
<a name="l02875"></a>02875     }
<a name="l02876"></a>02876 
<a name="l02877"></a>02877     <span class="keywordflow">if</span> (1 != nReturn2)
<a name="l02878"></a>02878     {
<a name="l02879"></a>02879         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInboxLowLevel failed. Returning: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nReturn2) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02880"></a>02880     }
<a name="l02881"></a>02881 
<a name="l02882"></a>02882     <span class="keywordflow">return</span> nReturn2;
<a name="l02883"></a>02883 }
<a name="l02884"></a>02884 
<a name="l02885"></a>02885 
<a name="l02886"></a>02886 <span class="comment">// -1 error</span>
<a name="l02887"></a>02887 <span class="comment">//  0 Request NOT sent: But NO error, since hash hasn&#39;t changed.  (bWasSent=false)</span>
<a name="l02888"></a>02888 <span class="comment">//  0 Request WAS sent, reply WAS received:success = = false.  (bWasSent=true);</span>
<a name="l02889"></a>02889 <span class="comment">//  1 reply received:success = = true.;</span>
<a name="l02890"></a>02890 <span class="comment">//  bWasSent gets set to TRUE once the message is confirmed as sent.</span>
<a name="l02891"></a>02891 <span class="comment">//</span>
<a name="l02892"></a>02892 <span class="comment">// DEPRECATED</span>
<a name="l02893"></a><a class="code" href="class_utility.html#ac257e532b323bbb3cd841749b0565da7">02893</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ac257e532b323bbb3cd841749b0565da7">Utility::getInboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSent)
<a name="l02894"></a>02894 {
<a name="l02895"></a>02895     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l02896"></a>02896     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ac257e532b323bbb3cd841749b0565da7">getInboxLowLevel</a>(serverID, nymID, accountID, bWasSent, bForceDownload);
<a name="l02897"></a>02897 }
<a name="l02898"></a>02898 
<a name="l02899"></a>02899 <span class="comment">// DEPRECATED</span>
<a name="l02900"></a><a class="code" href="class_utility.html#a59b0628ccc6241729a32b1c362bb7155">02900</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ac257e532b323bbb3cd841749b0565da7">Utility::getInboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSent, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForce) <span class="comment">// bForce defaults to FALSE</span>
<a name="l02901"></a>02901 {
<a name="l02902"></a>02902     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getInboxLowLevel&quot;</span>;
<a name="l02903"></a>02903 
<a name="l02904"></a>02904     bWasSent = <span class="keyword">false</span>;
<a name="l02905"></a>02905 
<a name="l02906"></a>02906     <span class="comment">//</span>
<a name="l02907"></a>02907     <span class="comment">// Use OTAPI_Wrap::GetAccountWallet_InboxHash(ACCT_ID) to see the server&#39;s most recent inbox hash (on the OTAccount for that box)</span>
<a name="l02908"></a>02908 
<a name="l02909"></a>02909     <span class="keywordtype">string</span> strRecentHash = <a class="code" href="class_o_t_a_p_i___wrap.html#ad9d93ec0532d16d58c73ea2a560b14e6">OTAPI_Wrap::GetAccountWallet_InboxHash</a>(accountID);
<a name="l02910"></a>02910     <span class="keywordtype">bool</span> bRecentHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strRecentHash);
<a name="l02911"></a>02911     <span class="keywordflow">if</span> (!bRecentHash)
<a name="l02912"></a>02912     {
<a name="l02913"></a>02913         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve recent cached copy of server-side InboxHash from client-side nym (perhaps he&#39;s never downloaded it before?)\n\n&quot;</span>);
<a name="l02914"></a>02914     }
<a name="l02915"></a>02915 
<a name="l02916"></a>02916     <span class="comment">//</span>
<a name="l02917"></a>02917     <span class="comment">// Use OTAPI_Wrap::GetNym_InboxHash(ACCT_ID, NYM_ID) to see the client&#39;s copy of the inbox hash,</span>
<a name="l02918"></a>02918     <span class="comment">// from whenever the client last actually downloaded the inbox.</span>
<a name="l02919"></a>02919 
<a name="l02920"></a>02920     <span class="keywordtype">string</span> strLocalHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a10ff5fb2facdf12280a5334eb5f538a4">OTAPI_Wrap::GetNym_InboxHash</a>(accountID, nymID);
<a name="l02921"></a>02921     <span class="keywordtype">bool</span> bLocalHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLocalHash);
<a name="l02922"></a>02922     <span class="keywordflow">if</span> (!bLocalHash)
<a name="l02923"></a>02923     {
<a name="l02924"></a>02924         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve client-side InboxHash for:\n accountID: &quot;</span> + accountID + <span class="stringliteral">&quot;\n nymID: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02925"></a>02925     }
<a name="l02926"></a>02926 
<a name="l02927"></a>02927     <span class="keywordflow">if</span> (!bForce)
<a name="l02928"></a>02928     {
<a name="l02929"></a>02929         <span class="comment">// the hashes match -- no need to download anything.</span>
<a name="l02930"></a>02930         <span class="comment">//</span>
<a name="l02931"></a>02931         <span class="keywordflow">if</span> (bLocalHash &amp;&amp; bRecentHash &amp;&amp; (strRecentHash == strLocalHash))
<a name="l02932"></a>02932         {
<a name="l02933"></a>02933             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: The hashes already match (skipping Inbox download.)\n&quot;</span>);
<a name="l02934"></a>02934             <span class="keywordflow">return</span> 0;
<a name="l02935"></a>02935         }
<a name="l02936"></a>02936     }
<a name="l02937"></a>02937     <span class="comment">// ************************************************************************************</span>
<a name="l02938"></a>02938     <span class="comment">//</span>
<a name="l02939"></a>02939     <span class="comment">// Now that we dealt with the Inbox Hash, let&#39;s do the download!!</span>
<a name="l02940"></a>02940     <span class="comment">//</span>
<a name="l02941"></a>02941     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#ae8c7f22dedb5d0219e7be55ab70535c0">OTAPI_Wrap::getInbox</a>(serverID, nymID, accountID); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l02944"></a>02944 
<a name="l02945"></a>02945     <span class="keywordflow">if</span> ((-2) == nRequestNum)
<a name="l02946"></a>02946     {
<a name="l02947"></a>02947         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l02948"></a>02948         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.)</span>
<a name="l02949"></a>02949     }
<a name="l02950"></a>02950     <span class="keywordflow">if</span> (-1 == nRequestNum) <span class="comment">// if the requestNumber returned by the send-attempt is -1, that means it DIDN&#39;T SEND (error)</span>
<a name="l02951"></a>02951     {
<a name="l02952"></a>02952         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getInbox message due to error.\n&quot;</span>);
<a name="l02953"></a>02953         <span class="keywordflow">return</span> -1;
<a name="l02954"></a>02954     }
<a name="l02955"></a>02955     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l02956"></a>02956     {
<a name="l02957"></a>02957         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send getInbox message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l02958"></a>02958         <span class="keywordflow">return</span> -1; <span class="comment">// Even though &#39;0&#39; MEANS &quot;didn&#39;t send, but no error&quot; by convention in many places, it is actually an impossible return value;</span>
<a name="l02959"></a>02959     }
<a name="l02960"></a>02960     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l02961"></a>02961     {
<a name="l02962"></a>02962         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02963"></a>02963         <span class="keywordflow">return</span> -1;
<a name="l02964"></a>02964     }
<a name="l02965"></a>02965 
<a name="l02966"></a>02966     bWasSent = <span class="keyword">true</span>;
<a name="l02967"></a>02967 
<a name="l02968"></a>02968     <span class="comment">// ***************************************************</span>
<a name="l02969"></a>02969     <span class="comment">//</span>
<a name="l02970"></a>02970     <span class="comment">//</span>
<a name="l02971"></a>02971     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, strLocation);
<a name="l02972"></a>02972     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getInboxLowLevel &quot; + getLastReplyReceived() + &quot;\n&quot;);</span>
<a name="l02973"></a>02973 
<a name="l02974"></a>02974     <span class="keywordtype">bool</span> bInbox = 1 == nReturn;
<a name="l02975"></a>02975 
<a name="l02976"></a>02976     <span class="comment">// BY this point, we definitely have the request number, which means the</span>
<a name="l02977"></a>02977     <span class="comment">// message was actually SENT. (At least.) This also means we can use nRequestNum</span>
<a name="l02978"></a>02978     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l02979"></a>02979     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l02980"></a>02980     <span class="comment">//</span>
<a name="l02981"></a>02981 
<a name="l02982"></a>02982     <span class="comment">//     int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l02983"></a>02983     <span class="comment">//</span>
<a name="l02984"></a>02984     <span class="comment">//      // NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l02985"></a>02985     <span class="comment">//      // we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l02986"></a>02986     <span class="comment">//      // already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l02987"></a>02987     <span class="comment">//</span>
<a name="l02988"></a>02988     <span class="comment">//      if (nRemovedSentMsg &lt; 1)</span>
<a name="l02989"></a>02989     <span class="comment">//      {</span>
<a name="l02990"></a>02990     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getInboxLowLevel: ERROR: OT_API_RemoveSentMessage returned: &quot; + to_string(nRemovedSentMsg) + &quot;\n&quot;);</span>
<a name="l02991"></a>02991     <span class="comment">//      }</span>
<a name="l02992"></a>02992 
<a name="l02993"></a>02993     <span class="comment">// ***************************************************</span>
<a name="l02994"></a>02994     <span class="comment">// Now let&#39;s make sure we have all the box receipts for this outbox.</span>
<a name="l02995"></a>02995     <span class="comment">// (They will be needed when it is used for something.)</span>
<a name="l02996"></a>02996     <span class="comment">//</span>
<a name="l02997"></a>02997     int32_t nBoxType = 1;
<a name="l02998"></a>02998     <span class="keywordflow">if</span> (bInbox &amp;&amp; !<a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, accountID, nBoxType)) <span class="comment">// &lt;===== nBoxType = 1 aka INBOX;</span>
<a name="l02999"></a>02999     {
<a name="l03000"></a>03000         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getInbox succeeded, but then insureHaveAllBoxReceipts failed. (I give up.)\n&quot;</span>);
<a name="l03001"></a>03001         <span class="keywordflow">return</span> -1;
<a name="l03002"></a>03002     }
<a name="l03003"></a>03003 
<a name="l03004"></a>03004     <span class="keywordflow">return</span> nReturn;
<a name="l03005"></a>03005 }
<a name="l03006"></a>03006 
<a name="l03007"></a>03007 
<a name="l03008"></a>03008 <span class="comment">// ************************************************************************</span>
<a name="l03009"></a>03009 
<a name="l03010"></a>03010 <span class="comment">// -1 error</span>
<a name="l03011"></a>03011 <span class="comment">//  0 Request NOT sent: But NO error, since hash hasn&#39;t changed.  (bWasSent=false)</span>
<a name="l03012"></a>03012 <span class="comment">//  0 Request WAS sent, reply WAS received:success = = false.  (bWasSent=true);</span>
<a name="l03013"></a>03013 <span class="comment">//  1 reply received:success = = true.;</span>
<a name="l03014"></a>03014 <span class="comment">//  bWasSent gets set to TRUE once the message is confirmed as sent.</span>
<a name="l03015"></a>03015 <span class="comment">//</span>
<a name="l03016"></a>03016 <span class="comment">// DEPRECATED</span>
<a name="l03017"></a><a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">03017</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">Utility::getOutboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSent)
<a name="l03018"></a>03018 {
<a name="l03019"></a>03019     <span class="keywordtype">bool</span> bForceDownload = <span class="keyword">false</span>;
<a name="l03020"></a>03020     <span class="keywordflow">return</span> <a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">getOutboxLowLevel</a>(serverID, nymID, accountID, bWasSent, bForceDownload);
<a name="l03021"></a>03021 }
<a name="l03022"></a>03022 
<a name="l03023"></a>03023 <span class="comment">// DEPRECATED</span>
<a name="l03024"></a>03024 <span class="comment">//public static int32_t getOutboxLowLevel(String serverID, String nymID, String accountID, OTBool bWasSent, boolean bForce) // bForce defaults to FALSE</span>
<a name="l03025"></a><a class="code" href="class_utility.html#a4ad01379dfd7aa0762fd976b8c297ea3">03025</a> <a class="code" href="ot__utility__ot_8hpp.html#a7401343b9dc8882cfa686264480c8f06">OT_UTILITY_OT</a> int32_t <a class="code" href="class_utility.html#ad1ab51b434b4a65e2eef0c3ec8516873">Utility::getOutboxLowLevel</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; serverID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; nymID, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; accountID, <span class="keywordtype">bool</span> &amp; bWasSent, <span class="keyword">const</span> <span class="keywordtype">bool</span> bForce) <span class="comment">// bForce defaults to FALSE</span>
<a name="l03026"></a>03026 {
<a name="l03027"></a>03027     bWasSent = <span class="keyword">false</span>;
<a name="l03028"></a>03028 
<a name="l03029"></a>03029     <span class="keywordtype">string</span> strLocation = <span class="stringliteral">&quot;Utility::getOutboxLowLevel&quot;</span>;
<a name="l03030"></a>03030 
<a name="l03031"></a>03031     <span class="comment">//</span>
<a name="l03032"></a>03032     <span class="comment">// Use OTAPI_Wrap::GetAccountWallet_OutboxHash(ACCT_ID) to see the server&#39;s most recent outbox hash (on the OTAccount for that box)</span>
<a name="l03033"></a>03033 
<a name="l03034"></a>03034     <span class="keywordtype">string</span> strRecentHash = <a class="code" href="class_o_t_a_p_i___wrap.html#adb0da89b71880a06ce8a7522bef67aa8">OTAPI_Wrap::GetAccountWallet_OutboxHash</a>(accountID);
<a name="l03035"></a>03035     <span class="keywordtype">bool</span> bRecentHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strRecentHash);
<a name="l03036"></a>03036     <span class="keywordflow">if</span> (!bRecentHash)
<a name="l03037"></a>03037     {
<a name="l03038"></a>03038         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve recent cached copy of server-side OutboxHash from client-side nym (perhaps he&#39;s never downloaded it before?)\n\n&quot;</span>);
<a name="l03039"></a>03039     }
<a name="l03040"></a>03040 
<a name="l03041"></a>03041     <span class="comment">//</span>
<a name="l03042"></a>03042     <span class="comment">// Use OTAPI_Wrap::GetNym_OutboxHash(ACCT_ID, NYM_ID) to see the client&#39;s copy of the outbox hash,</span>
<a name="l03043"></a>03043     <span class="comment">// from whenever the client last actually downloaded the outbox.</span>
<a name="l03044"></a>03044 
<a name="l03045"></a>03045     <span class="keywordtype">string</span> strLocalHash = <a class="code" href="class_o_t_a_p_i___wrap.html#a902332b6b95b05f597d418eb8a491776">OTAPI_Wrap::GetNym_OutboxHash</a>(accountID, nymID);
<a name="l03046"></a>03046     <span class="keywordtype">bool</span> bLocalHash = <a class="code" href="ot__utility__ot_8hpp.html#a69ccecde9b7fed4322eebb917a3890d9">VerifyStringVal</a>(strLocalHash);
<a name="l03047"></a>03047     <span class="keywordflow">if</span> (!bLocalHash)
<a name="l03048"></a>03048     {
<a name="l03049"></a>03049         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Warning: Unable to retrieve client-side OutboxHash for:\n accountID: &quot;</span> + accountID + <span class="stringliteral">&quot;\n nymID: &quot;</span> + nymID + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03050"></a>03050     }
<a name="l03051"></a>03051 
<a name="l03052"></a>03052     <span class="keywordflow">if</span> (!bForce)
<a name="l03053"></a>03053     {
<a name="l03054"></a>03054         <span class="keywordflow">if</span> (bLocalHash  &amp;&amp; bRecentHash &amp;&amp; (strRecentHash == strLocalHash)) <span class="comment">// the hashes match -- no need to download anything.</span>
<a name="l03055"></a>03055         {
<a name="l03056"></a>03056             <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(1, strLocation + <span class="stringliteral">&quot;: The hashes already match (skipping Outbox download.)\n&quot;</span>);
<a name="l03057"></a>03057             <span class="keywordflow">return</span> 0;
<a name="l03058"></a>03058         }
<a name="l03059"></a>03059     }
<a name="l03060"></a>03060     <span class="comment">// ************************************************************************************</span>
<a name="l03061"></a>03061 
<a name="l03062"></a>03062     <span class="comment">// Now that we dealt with the Outbox Hash, let&#39;s do the download!!</span>
<a name="l03063"></a>03063     <span class="comment">//</span>
<a name="l03064"></a>03064     <a class="code" href="class_o_t_a_p_i___wrap.html#a06b125c1d2e4141e1e875349ae570981">OTAPI_Wrap::FlushMessageBuffer</a>();
<a name="l03065"></a>03065 
<a name="l03066"></a>03066     int32_t nRequestNum = <a class="code" href="class_o_t_a_p_i___wrap.html#aa566a688bab96938f411018d2cec53f7">OTAPI_Wrap::getOutbox</a>(serverID, nymID, accountID); <span class="comment">// &lt;===== ATTEMPT TO SEND THE MESSAGE HERE...;</span>
<a name="l03067"></a>03067     <span class="keywordflow">if</span> (-2 == nRequestNum)
<a name="l03068"></a>03068     {
<a name="l03069"></a>03069         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: ERROR, not supported. (-2 was returned.)\n&quot;</span>);
<a name="l03070"></a>03070         <span class="keywordflow">return</span> -1; <span class="comment">// -2 is also possible at some future date. (If the request number won&#39;t fit in an int32_t, this is returned and then you can retrieve the actual number via a separate call.)</span>
<a name="l03071"></a>03071     }
<a name="l03072"></a>03072     <span class="keywordflow">if</span> (-1 == nRequestNum) <span class="comment">// if the requestNumber returned by the send-attempt is -1, that means it DIDN&#39;T SEND (error)</span>
<a name="l03073"></a>03073     {
<a name="l03074"></a>03074         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Failed to send getOutbox message due to error.\n&quot;</span>);
<a name="l03075"></a>03075         <span class="keywordflow">return</span> -1;
<a name="l03076"></a>03076     }
<a name="l03077"></a>03077     <span class="keywordflow">if</span> (0 == nRequestNum)
<a name="l03078"></a>03078     {
<a name="l03079"></a>03079         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Didn&#39;t send getOutbox message, but NO error occurred, either. (In this case, SHOULD NEVER HAPPEN. Treating as Error.)\n&quot;</span>);
<a name="l03080"></a>03080         <span class="keywordflow">return</span> -1; <span class="comment">// Even though &#39;0&#39; MEANS &quot;didn&#39;t send, but no error&quot; by convention in many places, it is actually an impossible return value;</span>
<a name="l03081"></a>03081     }
<a name="l03082"></a>03082     <span class="keywordflow">if</span> (nRequestNum &lt; 0)
<a name="l03083"></a>03083     {
<a name="l03084"></a>03084         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: Unexpected request number: &quot;</span> + <a class="code" href="ot__otapi__ot_8hpp.html#a8011fa809e73c86ef9f399b9529b8ef4">to_string</a>(nRequestNum) + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03085"></a>03085         <span class="keywordflow">return</span> -1;
<a name="l03086"></a>03086     }
<a name="l03087"></a>03087 
<a name="l03088"></a>03088     bWasSent = <span class="keyword">true</span>;
<a name="l03089"></a>03089 
<a name="l03090"></a>03090     <span class="comment">// ***************************************************</span>
<a name="l03091"></a>03091     <span class="comment">//</span>
<a name="l03092"></a>03092     <span class="comment">//</span>
<a name="l03093"></a>03093     int32_t nReturn = <a class="code" href="class_utility.html#a3d67d3c7f3c386cb6a4a165c3ca6e5a1">receiveReplySuccessLowLevel</a>(serverID, nymID, nRequestNum, strLocation);
<a name="l03094"></a>03094     <span class="comment">//      OTAPI_Wrap::Output(0, &quot;IN getOutboxLowLevel &quot; + getLastReplyReceived());</span>
<a name="l03095"></a>03095 
<a name="l03096"></a>03096     <span class="keywordtype">bool</span> bOutbox = 1 == nReturn;
<a name="l03097"></a>03097 
<a name="l03098"></a>03098     <span class="comment">// BY this point, we definitely have the request number, which means the</span>
<a name="l03099"></a>03099     <span class="comment">// message was actually SENT. (At least.) This also means we can use nRequestNum</span>
<a name="l03100"></a>03100     <span class="comment">// later to query for a copy of that sent message.</span>
<a name="l03101"></a>03101     <span class="comment">// Let&#39;s go ahead, in this case, and remove that now:</span>
<a name="l03102"></a>03102     <span class="comment">//</span>
<a name="l03103"></a>03103 
<a name="l03104"></a>03104     <span class="comment">//     int32_t nRemovedSentMsg = OTAPI_Wrap::RemoveSentMessage(Integer.toString(nRequestNum), serverID, nymID);</span>
<a name="l03105"></a>03105     <span class="comment">//</span>
<a name="l03106"></a>03106     <span class="comment">//      // NOTE: The above call is unnecessary, since a successful process means</span>
<a name="l03107"></a>03107     <span class="comment">//      // we already received the successful server reply, and OT&#39;s &quot;ProcessServerReply&quot;</span>
<a name="l03108"></a>03108     <span class="comment">//      // already removed the sent message from the sent buffer (so no need to do that here.)</span>
<a name="l03109"></a>03109     <span class="comment">//</span>
<a name="l03110"></a>03110     <span class="comment">//      if (nRemovedSentMsg &lt; 1)</span>
<a name="l03111"></a>03111     <span class="comment">//      {</span>
<a name="l03112"></a>03112     <span class="comment">//          OTAPI_Wrap::Output(0, &quot;getOutboxLowLevel: ERROR: OT_API_RemoveSentMessage returned: &quot; + to_string(nRemovedSentMsg) + &quot;\n&quot;);</span>
<a name="l03113"></a>03113 
<a name="l03114"></a>03114     <span class="comment">//      }</span>
<a name="l03115"></a>03115 
<a name="l03116"></a>03116 
<a name="l03117"></a>03117     <span class="comment">// ***************************************************</span>
<a name="l03118"></a>03118     <span class="comment">// Now let&#39;s make sure we have all the box receipts for this outbox.</span>
<a name="l03119"></a>03119     <span class="comment">// (They will be needed when it is used for something.)</span>
<a name="l03120"></a>03120     <span class="comment">//</span>
<a name="l03121"></a>03121     int32_t nBoxType = 2;
<a name="l03122"></a>03122     <span class="keywordflow">if</span> (bOutbox &amp;&amp; !<a class="code" href="class_utility.html#ad944a8dda0ef36b4e437bb9d3452ea97">insureHaveAllBoxReceipts</a>(serverID, nymID, accountID, nBoxType)) <span class="comment">// &lt;===== nBoxType = 2 aka OUTBOX;</span>
<a name="l03123"></a>03123     {
<a name="l03124"></a>03124         <a class="code" href="class_o_t_a_p_i___wrap.html#ae077a64733ed6e663938f51519e30235">OTAPI_Wrap::Output</a>(0, strLocation + <span class="stringliteral">&quot;: getOutbox succeeded, but then insureHaveAllBoxReceipts failed. (I give up.)\n&quot;</span>);
<a name="l03125"></a>03125         <span class="keywordflow">return</span> -1;
<a name="l03126"></a>03126     }
<a name="l03127"></a>03127 
<a name="l03128"></a>03128     <span class="keywordflow">return</span> nReturn;
<a name="l03129"></a>03129 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ot__utility__ot_8cpp.html">ot_utility_ot.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:01 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
