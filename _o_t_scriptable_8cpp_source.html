<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/otlib/OTScriptable.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_o_t_scriptable_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/otlib/OTScriptable.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_o_t_scriptable_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *  OTScriptable.cpp</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/************************************************************</span>
<a name="l00008"></a>00008 <span class="comment"> -----BEGIN PGP SIGNED MESSAGE-----</span>
<a name="l00009"></a>00009 <span class="comment"> Hash: SHA1</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment"> *                 OPEN TRANSACTIONS</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> *       Financial Cryptography and Digital Cash</span>
<a name="l00014"></a>00014 <span class="comment"> *       Library, Protocol, API, Server, CLI, GUI</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *       -- Anonymous Numbered Accounts.</span>
<a name="l00017"></a>00017 <span class="comment"> *       -- Untraceable Digital Cash.</span>
<a name="l00018"></a>00018 <span class="comment"> *       -- Triple-Signed Receipts.</span>
<a name="l00019"></a>00019 <span class="comment"> *       -- Cheques, Vouchers, Transfers, Inboxes.</span>
<a name="l00020"></a>00020 <span class="comment"> *       -- Basket Currencies, Markets, Payment Plans.</span>
<a name="l00021"></a>00021 <span class="comment"> *       -- Signed, XML, Ricardian-style Contracts.</span>
<a name="l00022"></a>00022 <span class="comment"> *       -- Scripted smart contracts.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *  Copyright (C) 2010-2013 by &quot;Fellow Traveler&quot; (A pseudonym)</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> *  EMAIL:</span>
<a name="l00027"></a>00027 <span class="comment"> *  FellowTraveler@rayservers.net</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> *  BITCOIN:  1NtTPVVjDsUfDWybS4BwvHpG2pdS9RnYyQ</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> *  KEY FINGERPRINT (PGP Key in license file):</span>
<a name="l00032"></a>00032 <span class="comment"> *  9DD5 90EB 9292 4B48 0484  7910 0308 00ED F951 BB8E</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  OFFICIAL PROJECT WIKI(s):</span>
<a name="l00035"></a>00035 <span class="comment"> *  https://github.com/FellowTraveler/Moneychanger</span>
<a name="l00036"></a>00036 <span class="comment"> *  https://github.com/FellowTraveler/Open-Transactions/wiki</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> *  WEBSITE:</span>
<a name="l00039"></a>00039 <span class="comment"> *  http://www.OpenTransactions.org/</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> *  Components and licensing:</span>
<a name="l00042"></a>00042 <span class="comment"> *   -- Moneychanger..A Java client GUI.....LICENSE:.....GPLv3</span>
<a name="l00043"></a>00043 <span class="comment"> *   -- otlib.........A class library.......LICENSE:...LAGPLv3</span>
<a name="l00044"></a>00044 <span class="comment"> *   -- otapi.........A client API..........LICENSE:...LAGPLv3</span>
<a name="l00045"></a>00045 <span class="comment"> *   -- opentxs/ot....Command-line client...LICENSE:...LAGPLv3</span>
<a name="l00046"></a>00046 <span class="comment"> *   -- otserver......Server Application....LICENSE:....AGPLv3</span>
<a name="l00047"></a>00047 <span class="comment"> *  Github.com/FellowTraveler/Open-Transactions/wiki/Components</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> *  All of the above OT components were designed and written by</span>
<a name="l00050"></a>00050 <span class="comment"> *  Fellow Traveler, with the exception of Moneychanger, which</span>
<a name="l00051"></a>00051 <span class="comment"> *  was contracted out to Vicky C (bitcointrader4@gmail.com).</span>
<a name="l00052"></a>00052 <span class="comment"> *  The open-source community has since actively contributed.</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *  -----------------------------------------------------</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> *   LICENSE:</span>
<a name="l00057"></a>00057 <span class="comment"> *   This program is free software: you can redistribute it</span>
<a name="l00058"></a>00058 <span class="comment"> *   and/or modify it under the terms of the GNU Affero</span>
<a name="l00059"></a>00059 <span class="comment"> *   General Public License as published by the Free Software</span>
<a name="l00060"></a>00060 <span class="comment"> *   Foundation, either version 3 of the License, or (at your</span>
<a name="l00061"></a>00061 <span class="comment"> *   option) any later version.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> *   ADDITIONAL PERMISSION under the GNU Affero GPL version 3</span>
<a name="l00064"></a>00064 <span class="comment"> *   section 7: (This paragraph applies only to the LAGPLv3</span>
<a name="l00065"></a>00065 <span class="comment"> *   components listed above.) If you modify this Program, or</span>
<a name="l00066"></a>00066 <span class="comment"> *   any covered work, by linking or combining it with other</span>
<a name="l00067"></a>00067 <span class="comment"> *   code, such other code is not for that reason alone subject</span>
<a name="l00068"></a>00068 <span class="comment"> *   to any of the requirements of the GNU Affero GPL version 3.</span>
<a name="l00069"></a>00069 <span class="comment"> *   (==&gt; This means if you are only using the OT API, then you</span>
<a name="l00070"></a>00070 <span class="comment"> *   don&#39;t have to open-source your code--only your changes to</span>
<a name="l00071"></a>00071 <span class="comment"> *   Open-Transactions itself must be open source. Similar to</span>
<a name="l00072"></a>00072 <span class="comment"> *   LGPLv3, except it applies to software-as-a-service, not</span>
<a name="l00073"></a>00073 <span class="comment"> *   just to distributing binaries.)</span>
<a name="l00074"></a>00074 <span class="comment"> *</span>
<a name="l00075"></a>00075 <span class="comment"> *   Extra WAIVER for OpenSSL, Lucre, and all other libraries</span>
<a name="l00076"></a>00076 <span class="comment"> *   used by Open Transactions: This program is released under</span>
<a name="l00077"></a>00077 <span class="comment"> *   the AGPL with the additional exemption that compiling,</span>
<a name="l00078"></a>00078 <span class="comment"> *   linking, and/or using OpenSSL is allowed. The same is true</span>
<a name="l00079"></a>00079 <span class="comment"> *   for any other open source libraries included in this</span>
<a name="l00080"></a>00080 <span class="comment"> *   project: complete waiver from the AGPL is hereby granted to</span>
<a name="l00081"></a>00081 <span class="comment"> *   compile, link, and/or use them with Open-Transactions,</span>
<a name="l00082"></a>00082 <span class="comment"> *   according to their own terms, as long as the rest of the</span>
<a name="l00083"></a>00083 <span class="comment"> *   Open-Transactions terms remain respected, with regard to</span>
<a name="l00084"></a>00084 <span class="comment"> *   the Open-Transactions code itself.</span>
<a name="l00085"></a>00085 <span class="comment"> *</span>
<a name="l00086"></a>00086 <span class="comment"> *   Lucre License:</span>
<a name="l00087"></a>00087 <span class="comment"> *   This code is also &quot;dual-license&quot;, meaning that Ben Lau-</span>
<a name="l00088"></a>00088 <span class="comment"> *   rie&#39;s license must also be included and respected, since</span>
<a name="l00089"></a>00089 <span class="comment"> *   the code for Lucre is also included with Open Transactions.</span>
<a name="l00090"></a>00090 <span class="comment"> *   See Open-Transactions/src/otlib/lucre/LUCRE_LICENSE.txt</span>
<a name="l00091"></a>00091 <span class="comment"> *   The Laurie requirements are light, but if there is any</span>
<a name="l00092"></a>00092 <span class="comment"> *   problem with his license, simply remove the Lucre code.</span>
<a name="l00093"></a>00093 <span class="comment"> *   Although there are no other blind token algorithms in Open</span>
<a name="l00094"></a>00094 <span class="comment"> *   Transactions (yet. credlib is coming), the other functions</span>
<a name="l00095"></a>00095 <span class="comment"> *   will continue to operate.</span>
<a name="l00096"></a>00096 <span class="comment"> *   See Lucre on Github:  https://github.com/benlaurie/lucre</span>
<a name="l00097"></a>00097 <span class="comment"> *   -----------------------------------------------------</span>
<a name="l00098"></a>00098 <span class="comment"> *   You should have received a copy of the GNU Affero General</span>
<a name="l00099"></a>00099 <span class="comment"> *   Public License along with this program.  If not, see:</span>
<a name="l00100"></a>00100 <span class="comment"> *   http://www.gnu.org/licenses/</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> *   If you would like to use this software outside of the free</span>
<a name="l00103"></a>00103 <span class="comment"> *   software license, please contact FellowTraveler.</span>
<a name="l00104"></a>00104 <span class="comment"> *   (Unfortunately many will run anonymously and untraceably,</span>
<a name="l00105"></a>00105 <span class="comment"> *   so who could really stop them?)</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> *   DISCLAIMER:</span>
<a name="l00108"></a>00108 <span class="comment"> *   This program is distributed in the hope that it will be</span>
<a name="l00109"></a>00109 <span class="comment"> *   useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00110"></a>00110 <span class="comment"> *   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00111"></a>00111 <span class="comment"> *   PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00112"></a>00112 <span class="comment"> *   more details.</span>
<a name="l00113"></a>00113 <span class="comment"></span>
<a name="l00114"></a>00114 <span class="comment"> -----BEGIN PGP SIGNATURE-----</span>
<a name="l00115"></a>00115 <span class="comment"> Version: GnuPG v1.4.9 (Darwin)</span>
<a name="l00116"></a>00116 <span class="comment"></span>
<a name="l00117"></a>00117 <span class="comment"> iQIcBAEBAgAGBQJRSsfJAAoJEAMIAO35UbuOQT8P/RJbka8etf7wbxdHQNAY+2cC</span>
<a name="l00118"></a>00118 <span class="comment"> vDf8J3X8VI+pwMqv6wgTVy17venMZJa4I4ikXD/MRyWV1XbTG0mBXk/7AZk7Rexk</span>
<a name="l00119"></a>00119 <span class="comment"> KTvL/U1kWiez6+8XXLye+k2JNM6v7eej8xMrqEcO0ZArh/DsLoIn1y8p8qjBI7+m</span>
<a name="l00120"></a>00120 <span class="comment"> aE7lhstDiD0z8mwRRLKFLN2IH5rAFaZZUvj5ERJaoYUKdn4c+RcQVei2YOl4T0FU</span>
<a name="l00121"></a>00121 <span class="comment"> LWND3YLoH8naqJXkaOKEN4UfJINCwxhe5Ke9wyfLWLUO7NamRkWD2T7CJ0xocnD1</span>
<a name="l00122"></a>00122 <span class="comment"> sjAzlVGNgaFDRflfIF4QhBx1Ddl6wwhJfw+d08bjqblSq8aXDkmFA7HeunSFKkdn</span>
<a name="l00123"></a>00123 <span class="comment"> oIEOEgyj+veuOMRJC5pnBJ9vV+7qRdDKQWaCKotynt4sWJDGQ9kWGWm74SsNaduN</span>
<a name="l00124"></a>00124 <span class="comment"> TPMyr9kNmGsfR69Q2Zq/FLcLX/j8ESxU+HYUB4vaARw2xEOu2xwDDv6jt0j3Vqsg</span>
<a name="l00125"></a>00125 <span class="comment"> x7rWv4S/Eh18FDNDkVRChiNoOIilLYLL6c38uMf1pnItBuxP3uhgY6COm59kVaRh</span>
<a name="l00126"></a>00126 <span class="comment"> nyGTYCDYD2TK+fI9o89F1297uDCwEJ62U0Q7iTDp5QuXCoxkPfv8/kX6lS6T3y9G</span>
<a name="l00127"></a>00127 <span class="comment"> M9mqIoLbIQ1EDntFv7/t6fUTS2+46uCrdZWbQ5RjYXdrzjij02nDmJAm2BngnZvd</span>
<a name="l00128"></a>00128 <span class="comment"> kamH0Y/n11lCvo1oQxM+</span>
<a name="l00129"></a>00129 <span class="comment"> =uSzz</span>
<a name="l00130"></a>00130 <span class="comment"> -----END PGP SIGNATURE-----</span>
<a name="l00131"></a>00131 <span class="comment"> **************************************************************/</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">#include &lt;<a class="code" href="stdafx_8hpp.html">stdafx.hpp</a>&gt;</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_scriptable_8hpp.html">OTScriptable.hpp</a>&gt;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00138"></a>00138 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_assert_8hpp.html">OTAssert.hpp</a>&gt;</span>
<a name="l00139"></a>00139 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_smart_contract_8hpp.html">OTSmartContract.hpp</a>&gt;</span>
<a name="l00140"></a>00140 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_script_8hpp.html">OTScript.hpp</a>&gt;</span>
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_pseudonym_8hpp.html">OTPseudonym.hpp</a>&gt;</span>
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="preprocessor">#include &quot;irrxml/irrXML.hpp&quot;</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">// ---------------------------------------------------</span>
<a name="l00146"></a>00146 <span class="preprocessor">#ifdef OT_USE_SCRIPT_CHAI</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span><span class="preprocessor">#include &lt;chaiscript/chaiscript.hpp&gt;</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#ifdef OT_USE_CHAI_STDLIB</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span><span class="preprocessor">#include &lt;chaiscript/chaiscript_stdlib.hpp&gt;</span>
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="preprocessor">#endif</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>
<a name="l00154"></a>00154 <span class="preprocessor">#endif</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_log_8hpp.html">OTLog.hpp</a>&gt;</span>
<a name="l00157"></a>00157 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_assert_8hpp.html">OTAssert.hpp</a>&gt;</span>
<a name="l00158"></a>00158 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_smart_contract_8hpp.html">OTSmartContract.hpp</a>&gt;</span>
<a name="l00159"></a>00159 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_script_8hpp.html">OTScript.hpp</a>&gt;</span>
<a name="l00160"></a>00160 <span class="preprocessor">#include &lt;<a class="code" href="_o_t_pseudonym_8hpp.html">OTPseudonym.hpp</a>&gt;</span>
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">// CALLBACKS</span>
<a name="l00164"></a>00164 <span class="comment">//</span>
<a name="l00165"></a>00165 <span class="comment">// The server will call these callbacks, from time to time, and give you the</span>
<a name="l00166"></a>00166 <span class="comment">// opportunity to resolve its questions.</span>
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">// This script is called by the server, whenever it wants to know whether a</span>
<a name="l00169"></a>00169 <span class="comment">// given party is allowed to execute a specific clause.</span>
<a name="l00170"></a>00170 <span class="comment">//</span>
<a name="l00171"></a>00171 <span class="preprocessor">#ifndef SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</span>
<a name="l00172"></a><a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">00172</a> <span class="preprocessor"></span><span class="preprocessor">#define SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE       &quot;callback_party_may_execute_clause&quot;</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">00176</a> <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strInput)
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178     <span class="keyword">static</span> <span class="keywordtype">char</span> buf[45] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00179"></a>00179     <span class="comment">// ---------------------------------</span>
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strInput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00181"></a>00181     {
<a name="l00182"></a>00182         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failure: Input string is empty.\n&quot;</span>, __FUNCTION__);
<a name="l00183"></a>00183         <span class="keywordflow">return</span> NULL;
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     <span class="comment">// --------------------------------------------------------------------</span>
<a name="l00186"></a>00186     <a class="code" href="class_o_t_string.html">OTString</a> strContract(strInput);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (<span class="keyword">false</span> == strContract.<a class="code" href="class_o_t_string.html#a0221820d7a19178ca0c539795b494f8d">DecodeIfArmored</a>(<span class="keyword">false</span>)) <span class="comment">// bEscapedIsAllowed=true by default.</span>
<a name="l00189"></a>00189     {
<a name="l00190"></a>00190         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Input string apparently was encoded and then failed decoding. Contents: \n%s\n&quot;</span>,
<a name="l00191"></a>00191                       __FUNCTION__, strInput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00192"></a>00192         <span class="keywordflow">return</span> NULL;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194     <span class="comment">// ------------------------------------------</span>
<a name="l00195"></a>00195     <span class="comment">// At this point, strContract contains the actual contents, whether they</span>
<a name="l00196"></a>00196     <span class="comment">// were originally ascii-armored OR NOT. (And they are also now trimmed, either way.)</span>
<a name="l00197"></a>00197     <span class="comment">//</span>
<a name="l00198"></a>00198     strContract.<a class="code" href="class_o_t_string.html#a9dc2c1f7f583e495406dee7a14b919b4">reset</a>(); <span class="comment">// for sgets</span>
<a name="l00199"></a>00199     buf[0] = 0; <span class="comment">// probably unnecessary.</span>
<a name="l00200"></a>00200     <span class="keywordtype">bool</span> bGotLine = strContract.<a class="code" href="class_o_t_string.html#a53f546c500623fff646e3c2970b9f8af">sgets</a>(buf, 40);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (!bGotLine)
<a name="l00203"></a>00203         <span class="keywordflow">return</span> NULL;
<a name="l00204"></a>00204     <span class="comment">// --------------------------------</span>
<a name="l00205"></a>00205     <a class="code" href="class_o_t_cron_item.html">OTCronItem</a> * pItem = NULL;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <a class="code" href="class_o_t_string.html">OTString</a> strFirstLine(buf);
<a name="l00208"></a>00208     strContract.<a class="code" href="class_o_t_string.html#a9dc2c1f7f583e495406dee7a14b919b4">reset</a>(); <span class="comment">// set the &quot;file&quot; pointer within this string back to index 0.</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">// Now I feel pretty safe -- the string I&#39;m examining is within</span>
<a name="l00211"></a>00211     <span class="comment">// the first 45 characters of the beginning of the contract, and</span>
<a name="l00212"></a>00212     <span class="comment">// it will NOT contain the escape &quot;- &quot; sequence. From there, if</span>
<a name="l00213"></a>00213     <span class="comment">// it contains the proper sequence, I will instantiate that type.</span>
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (!strFirstLine.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || strFirstLine.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;- -&quot;</span>))
<a name="l00215"></a>00215         <span class="keywordflow">return</span> NULL;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">// There are actually two factories that load smart contracts. See OTCronItem.</span>
<a name="l00218"></a>00218     <span class="comment">//</span>
<a name="l00219"></a>00219     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strFirstLine.<a class="code" href="class_o_t_string.html#acb212b06102322aebb96090601794825">Contains</a>(<span class="stringliteral">&quot;-----BEGIN SIGNED SMARTCONTRACT-----&quot;</span>))  <span class="comment">// this string is 36 chars long.</span>
<a name="l00220"></a>00220     {   pItem = <span class="keyword">new</span> <a class="code" href="class_o_t_smart_contract.html">OTSmartContract</a>();  <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pItem); }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">// Coming soon.</span>
<a name="l00223"></a>00223 <span class="comment">//  else if (strFirstLine.Contains(&quot;-----BEGIN SIGNED ENTITY-----&quot;))  // this string is 29 chars long.</span>
<a name="l00224"></a>00224 <span class="comment">//  {   pItem = new OTEntity();         OT_ASSERT(NULL != pItem); }</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">// The string didn&#39;t match any of the options in the factory.</span>
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (NULL == pItem)
<a name="l00228"></a>00228         <span class="keywordflow">return</span> NULL;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="comment">// Does the contract successfully load from the string passed in?</span>
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strContract))
<a name="l00232"></a>00232         <span class="keywordflow">return</span> pItem;
<a name="l00233"></a>00233     <span class="keywordflow">else</span>
<a name="l00234"></a>00234         <span class="keyword">delete</span> pItem;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="keywordflow">return</span> NULL;
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">//virtual</span>
<a name="l00242"></a><a class="code" href="class_o_t_scriptable.html#a7590c450a8a079eb388fd4fc378b3b40">00242</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a7590c450a8a079eb388fd4fc378b3b40">OTScriptable::SetDisplayLabel</a>(<span class="keyword">const</span> std::string * pstrLabel<span class="comment">/*=NULL*/</span>)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <a class="code" href="class_o_t_scriptable.html#a9e1d9c7e46bab582ea1922026a21b357">m_strLabel</a> = (NULL != pstrLabel) ? pstrLabel-&gt;c_str() : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">// VALIDATING IDENTIFIERS IN OTSCRIPTABLE.</span>
<a name="l00249"></a>00249 <span class="comment">//</span>
<a name="l00250"></a>00250 <span class="comment">// Only alphanumerics are valid, or &#39;_&#39; (underscore)</span>
<a name="l00251"></a>00251 <span class="comment">//</span>
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="_o_t_scriptable_8cpp.html#a0de615976d74e8e2c5acde992b062471">00253</a> <span class="keywordtype">bool</span> <a class="code" href="_o_t_scriptable_8cpp.html#a0de615976d74e8e2c5acde992b062471">is_ot_namechar_invalid</a>(<span class="keywordtype">char</span> c)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255     <span class="keywordflow">return</span> !(isalnum(c) || (c == <span class="charliteral">&#39;_&#39;</span>));
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="comment">// static</span>
<a name="l00260"></a><a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">00260</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(<span class="keyword">const</span> std::string str_name)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <span class="keywordflow">if</span> (str_name.size() &lt;= 0)
<a name="l00263"></a>00263     {
<a name="l00264"></a>00264         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::ValidateName: Name has zero size.\n&quot;</span>);
<a name="l00265"></a>00265         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (find_if(str_name.begin(), str_name.end(), <a class="code" href="_o_t_scriptable_8cpp.html#a0de615976d74e8e2c5acde992b062471">is_ot_namechar_invalid</a>) != str_name.end())
<a name="l00268"></a>00268     {
<a name="l00269"></a>00269         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::ValidateName: Name fails validation testing: %s\n&quot;</span>,
<a name="l00270"></a>00270                      str_name.c_str());
<a name="l00271"></a>00271         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">// OTSmartContract::RegisterOTNativeCallsWithScript OVERRIDES this, but</span>
<a name="l00279"></a>00279 <span class="comment">// also calls it.</span>
<a name="l00280"></a>00280 <span class="comment">//</span>
<a name="l00281"></a><a class="code" href="class_o_t_scriptable.html#ad469b542209e1c73905d2094bb561793">00281</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#ad469b542209e1c73905d2094bb561793">OTScriptable::RegisterOTNativeCallsWithScript</a>(<a class="code" href="class_o_t_script.html">OTScript</a> &amp; theScript)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283 <span class="preprocessor">#ifdef OT_USE_SCRIPT_CHAI</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>    <span class="keyword">using namespace </span>chaiscript;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// In the future, this will be polymorphic.</span>
<a name="l00287"></a>00287     <span class="comment">// But for now, I&#39;m forcing things...</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     OTScriptChai * pScript = <span class="keyword">dynamic_cast&lt;</span>OTScriptChai *<span class="keyword">&gt;</span> (&amp;theScript);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (NULL != pScript)
<a name="l00292"></a>00292     {
<a name="l00293"></a>00293         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pScript-&gt;chai)
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         pScript-&gt;chai-&gt;add(fun(&amp;<a class="code" href="class_o_t_scriptable.html#aebf4ace228231ac6aa8395fe56a5271c">OTScriptable::GetTime</a>), <span class="stringliteral">&quot;get_time&quot;</span>);
<a name="l00296"></a>00296         <span class="comment">// ---------------------------------------------------------------------------------</span>
<a name="l00297"></a>00297         pScript-&gt;chai-&gt;add(fun(&amp;<a class="code" href="class_o_t_scriptable.html#ae2046f1b62828d26dda822eaa6a194b6">OTScriptable::CanExecuteClause</a>, <span class="keyword">this</span>), <span class="stringliteral">&quot;party_may_execute_clause&quot;</span>);
<a name="l00298"></a>00298 <span class="comment">//      pScript-&gt;chai.add(fun(&amp;OTScriptable::CanExecuteClause, (*this)), &quot;party_may_execute_clause&quot;);</span>
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 <span class="comment">//  else if (NULL != (pScript = dynamic_cast&lt;OTScriptSomeOtherScriptingLanguageSubClass_GOES_HERE *&gt; (&amp;theScript)) )</span>
<a name="l00301"></a>00301 <span class="comment">//  { }</span>
<a name="l00302"></a>00302     <span class="keywordflow">else</span>
<a name="l00303"></a>00303 <span class="preprocessor">#endif // OT_USE_SCRIPT_CHAI</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>    {
<a name="l00305"></a>00305         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::RegisterOTNativeCallsWithScript: Failed dynamic casting OTScript to OTScriptChai \n&quot;</span>);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="comment">//static</span>
<a name="l00311"></a><a class="code" href="class_o_t_scriptable.html#aebf4ace228231ac6aa8395fe56a5271c">00311</a> std::string <a class="code" href="class_o_t_scriptable.html#aebf4ace228231ac6aa8395fe56a5271c">OTScriptable::GetTime</a>() <span class="comment">// Returns a string, containing seconds as int32_t. (Time in seconds.)</span>
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313     <span class="keyword">const</span> <a class="code" href="_o_t_common_8hpp.html#ad28ff0a3eda18840f6bda5872819167f">time64_t</a>  CURRENT_TIME = <a class="code" href="_o_t_common_8hpp.html#a1163606b2546b160d50c5f0a5afe479a">OTTimeGetCurrentTime</a>();
<a name="l00314"></a>00314     <span class="keyword">const</span> int64_t   lTime = <a class="code" href="_o_t_common_8hpp.html#a4c31551b478d298d694f7df4915b4302">OTTimeGetSecondsFromTime</a>(CURRENT_TIME);
<a name="l00315"></a>00315     <span class="comment">// ----------------------------------</span>
<a name="l00316"></a>00316     <a class="code" href="class_o_t_string.html">OTString</a> strTime;
<a name="l00317"></a>00317     strTime.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%lld&quot;</span>, lTime);
<a name="l00318"></a>00318     <span class="keywordflow">return</span>  strTime.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="comment">// The server calls this when it wants to know if a certain party is allowed to execute a specific clause.</span>
<a name="l00323"></a>00323 <span class="comment">// This function tries to answer that question by checking for a callback script called callback_party_may_execute_clause</span>
<a name="l00324"></a>00324 <span class="comment">// If the callback exists, then it calls that for the answer. Otherwise the default return value is: true</span>
<a name="l00325"></a>00325 <span class="comment">// Script coders may also call &quot;party_may_execute_clause()&quot; from within a script, which will call this function,</span>
<a name="l00326"></a>00326 <span class="comment">// which will trigger the script callback_party_may_execute_clause(), etc.</span>
<a name="l00327"></a>00327 <span class="comment">//</span>
<a name="l00328"></a><a class="code" href="class_o_t_scriptable.html#ae2046f1b62828d26dda822eaa6a194b6">00328</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#ae2046f1b62828d26dda822eaa6a194b6">OTScriptable::CanExecuteClause</a>(<span class="keyword">const</span> std::string str_party_name, <span class="keyword">const</span> std::string str_clause_name)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330 <span class="comment">//  OTCron * pCron  = GetCron();</span>
<a name="l00331"></a>00331 <span class="comment">//  OT_ASSERT(NULL != pCron);</span>
<a name="l00332"></a>00332 <span class="comment">//  // ----------------------------------</span>
<a name="l00333"></a>00333 <span class="comment">//  OTPseudonym * pServerNym = pCron-&gt;GetServerNym();</span>
<a name="l00334"></a>00334 <span class="comment">//  OT_ASSERT(NULL != pServerNym);</span>
<a name="l00335"></a>00335     <span class="comment">// -------------------------------------------------</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <a class="code" href="class_o_t_party.html">OTParty</a>     * pParty    = this-&gt;<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l00338"></a>00338     <a class="code" href="class_o_t_clause.html">OTClause</a>    * pClause   = this-&gt;<a class="code" href="class_o_t_scriptable.html#abe36809472a1b7adf66b303ea176888e">GetClause</a>(str_clause_name);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l00341"></a>00341     {
<a name="l00342"></a>00342         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Unable to find this party: %s\n&quot;</span>,
<a name="l00343"></a>00343                        str_party_name.size() &gt; 0 ? str_party_name.c_str() : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00344"></a>00344         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (NULL == pClause)
<a name="l00348"></a>00348     {
<a name="l00349"></a>00349         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Unable to find this clause: %s\n&quot;</span>,
<a name="l00350"></a>00350                        str_clause_name.size() &gt; 0 ? str_clause_name.c_str() : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00351"></a>00351         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353     <span class="comment">// Below this point, pParty and pClause are both good.</span>
<a name="l00354"></a>00354     <span class="comment">// -------------------------------------------------</span>
<a name="l00355"></a>00355     <span class="comment">//</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="comment">// ...This WILL check to see if pParty has its Opening number verified as issued.</span>
<a name="l00358"></a>00358     <span class="comment">// (If the opening number is &gt; 0 then VerifyPartyAuthorization() is smart enough to verify it.)</span>
<a name="l00359"></a>00359     <span class="comment">//</span>
<a name="l00360"></a>00360     <span class="comment">// To KNOW that a party has the right to even ASK the script to cancel a contract, MEANS that</span>
<a name="l00361"></a>00361     <span class="comment">// (1) The party is listed as a party on the contract. (2) The party&#39;s copy of that contract</span>
<a name="l00362"></a>00362     <span class="comment">// is signed by the authorizing agent for that party. and (3) The opening transaction number for</span>
<a name="l00363"></a>00363     <span class="comment">// that party is verified as issued for authorizing agent. (2 and 3 are both performed at the same</span>
<a name="l00364"></a>00364     <span class="comment">// time, in VerifyPartyAuthorization(), since the agent may need to be loaded in order to verify</span>
<a name="l00365"></a>00365     <span class="comment">// them.) 1 is already done by this point, as it&#39;s performed above.</span>
<a name="l00366"></a>00366     <span class="comment">//</span>
<a name="l00367"></a>00367     <span class="comment">// Todo: notice this code appears in CanCancelContract() (this function) as well as</span>
<a name="l00368"></a>00368     <span class="comment">// OTScriptable::CanExecuteClause.</span>
<a name="l00369"></a>00369     <span class="comment">// Therefore I can see that THIS VERIFICATION CODE WILL GET CALLED EVERY SINGLE TIME THE SCRIPT</span>
<a name="l00370"></a>00370     <span class="comment">// CALLS ANY CLAUSE OR OT NATIVE FUNCTION.  Since technically this only needs to be verified before the</span>
<a name="l00371"></a>00371     <span class="comment">// first call, and not for EVERY call during any of a script&#39;s runs, I should probably move this verification</span>
<a name="l00372"></a>00372     <span class="comment">// higher, such as each time the OTCronItem triggers, plus each time a party triggers a clause directly</span>
<a name="l00373"></a>00373     <span class="comment">// through the API (server message). As long as those are covered, I will be able to remove it from here</span>
<a name="l00374"></a>00374     <span class="comment">// which should be a significant improvement for performance.</span>
<a name="l00375"></a>00375     <span class="comment">// It will be at the bottom of those same functions that &quot;ClearTemporaryPointers()&quot; should finally be called.</span>
<a name="l00376"></a>00376     <span class="comment">//</span>
<a name="l00377"></a>00377     <span class="comment">// Also todo:  Need to implement MOVE CONSTRUCTORS and MOVE COPY CONSTRUCTORS all over the place,</span>
<a name="l00378"></a>00378     <span class="comment">// once I&#39;m sure C++0x build environments are available for all of the various OT platforms. That should</span>
<a name="l00379"></a>00379     <span class="comment">// be another great performance boost!</span>
<a name="l00380"></a>00380     <span class="comment">//</span>
<a name="l00381"></a>00381 <span class="comment">//  const OTString strServerID(GetServerID());</span>
<a name="l00382"></a>00382 <span class="comment">//</span>
<a name="l00383"></a>00383 <span class="comment">//  mapOfNyms   map_Nyms_Already_Loaded;</span>
<a name="l00384"></a>00384 <span class="comment">//  this-&gt;RetrieveNymPointers(map_Nyms_Already_Loaded);</span>
<a name="l00385"></a>00385 <span class="comment">//</span>
<a name="l00386"></a>00386 <span class="comment">//  bool bVerifiedAuthorization =</span>
<a name="l00387"></a>00387 <span class="comment">//      this-&gt;VerifyPartyAuthorization(*pParty, *pServerNym, strServerID, &amp;map_Nyms_Already_Loaded);</span>
<a name="l00388"></a>00388 <span class="comment">//</span>
<a name="l00389"></a>00389 <span class="comment">//  if (!bVerifiedAuthorization)</span>
<a name="l00390"></a>00390 <span class="comment">//  {</span>
<a name="l00391"></a>00391 <span class="comment">//      OTLog::vOutput(0, &quot;OTScriptable::CanExecuteClause: Unable to verify authorization for party: %s\n&quot;,</span>
<a name="l00392"></a>00392 <span class="comment">//                     str_party_name.c_str());</span>
<a name="l00393"></a>00393 <span class="comment">//      return false;</span>
<a name="l00394"></a>00394 <span class="comment">//  }</span>
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="comment">// NOTE (Above):  When it came time to compile, I realized that OTScriptable has no pointer to Cron,</span>
<a name="l00397"></a>00397     <span class="comment">// nor access to any ServerNym (unless you pass it in).  But I want this function to work by merely</span>
<a name="l00398"></a>00398     <span class="comment">// passing in 2 strings.</span>
<a name="l00399"></a>00399     <span class="comment">//</span>
<a name="l00400"></a>00400     <span class="comment">// SINCE THE PARTY IS VERIFIED ALREADY (WHEN THE SMART CONTRACT IS FIRST ACTIVATED) THEN THIS IS</span>
<a name="l00401"></a>00401     <span class="comment">// REDUNDANT ANYWAY.</span>
<a name="l00402"></a>00402     <span class="comment">//</span>
<a name="l00403"></a>00403     <span class="comment">// IF you ever need to use CanExecuteClause() in some circumstance where the party has NOT been verified</span>
<a name="l00404"></a>00404     <span class="comment">// anyway (it won&#39;t be from within some script...) then just call VerifyPartyAuthorization() yourself in</span>
<a name="l00405"></a>00405     <span class="comment">// that code, wherever you need to.</span>
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="comment">// *****************************************************************************</span>
<a name="l00408"></a>00408     <span class="comment">//</span>
<a name="l00409"></a>00409     <span class="comment">// DISALLOW parties to directly execute any clauses named similarly to callbacks, hooks, or cron hooks!</span>
<a name="l00410"></a>00410     <span class="comment">// Only allow this for normal clauses.</span>
<a name="l00411"></a>00411     <span class="comment">//</span>
<a name="l00412"></a>00412     <span class="keywordflow">if</span> (str_clause_name.compare(0,5,<span class="stringliteral">&quot;cron_&quot;</span>) == 0) <span class="comment">// todo stop hardcoding</span>
<a name="l00413"></a>00413     {
<a name="l00414"></a>00414         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Parties may not directly trigger clauses beginning in cron_\n&quot;</span>);
<a name="l00415"></a>00415         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (str_clause_name.compare(0,5,<span class="stringliteral">&quot;hook_&quot;</span>) == 0) <span class="comment">// todo stop hardcoding</span>
<a name="l00419"></a>00419     {
<a name="l00420"></a>00420         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Parties may not directly trigger clauses beginning in hook_\n&quot;</span>);
<a name="l00421"></a>00421         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (str_clause_name.compare(0,9,<span class="stringliteral">&quot;callback_&quot;</span>) == 0) <span class="comment">// todo stop hardcoding</span>
<a name="l00425"></a>00425     {
<a name="l00426"></a>00426         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Parties may not directly trigger clauses beginning in callback_\n&quot;</span>);
<a name="l00427"></a>00427         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <span class="comment">// *****************************************************************************</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="comment">// IF NO CALLBACK IS PROVIDED, The default answer to this function is:</span>
<a name="l00432"></a>00432     <span class="comment">//     YES, this party MAY run this clause!</span>
<a name="l00433"></a>00433     <span class="comment">//</span>
<a name="l00434"></a>00434     <span class="comment">// But... first we check to see if this OTScriptable has a clause named:</span>
<a name="l00435"></a>00435     <span class="comment">//          &quot;callback_party_may_execute_clause&quot;</span>
<a name="l00436"></a>00436     <span class="comment">// ...and if so, we ask the CALLBACK to make the decision instead. This way, people can define</span>
<a name="l00437"></a>00437     <span class="comment">// in their own scripts any rules they want about which parties may execute which clauses.</span>
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="comment">//</span>
<a name="l00440"></a>00440     <span class="keyword">const</span> std::string str_CallbackName(<a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <a class="code" href="class_o_t_clause.html">OTClause</a> * pCallbackClause = this-&gt;<a class="code" href="class_o_t_scriptable.html#a390511c5b2f419453b1cc169ec576972">GetCallback</a>(str_CallbackName); <span class="comment">// See if there is a script clause registered for this callback.</span>
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (NULL != pCallbackClause) <span class="comment">// Found it!</span>
<a name="l00445"></a>00445     {
<a name="l00446"></a>00446         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Found script for: %s. Asking...\n&quot;</span>,
<a name="l00447"></a>00447                        <a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</a>);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <span class="comment">// The function we&#39;re IN defaults to TRUE, if there&#39;s no script available.</span>
<a name="l00450"></a>00450         <span class="comment">// However, if the script is available, then our default return value starts as FALSE.</span>
<a name="l00451"></a>00451         <span class="comment">// The script itself will then have to set it to true, if that&#39;s what it wants.</span>
<a name="l00452"></a>00452         <span class="comment">//</span>
<a name="l00453"></a>00453         <a class="code" href="class_o_t_variable.html">OTVariable</a> param1       (<span class="stringliteral">&quot;param_party_name&quot;</span>,  str_party_name,   <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a3663696326da4cd07edb796beec5c324">OTVariable::Var_Constant</a>);
<a name="l00454"></a>00454         <a class="code" href="class_o_t_variable.html">OTVariable</a> param2       (<span class="stringliteral">&quot;param_clause_name&quot;</span>, str_clause_name,  <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a3663696326da4cd07edb796beec5c324">OTVariable::Var_Constant</a>);
<a name="l00455"></a>00455         <span class="comment">// -------------------------------------------------------------</span>
<a name="l00456"></a>00456         <a class="code" href="class_o_t_variable.html">OTVariable</a> theReturnVal (<span class="stringliteral">&quot;return_val&quot;</span>,        <span class="keyword">false</span>);
<a name="l00457"></a>00457         <span class="comment">// -------------------------------------------------------------</span>
<a name="l00458"></a>00458         <a class="code" href="_o_t_variable_8hpp.html#aa7620bdfc9f969dd2802c11c3260eb37">mapOfVariables</a> theParameters;
<a name="l00459"></a>00459         theParameters.insert(std::pair&lt;std::string, OTVariable *&gt;(<span class="stringliteral">&quot;param_party_name&quot;</span>,  &amp;param1));
<a name="l00460"></a>00460         theParameters.insert(std::pair&lt;std::string, OTVariable *&gt;(<span class="stringliteral">&quot;param_clause_name&quot;</span>, &amp;param2));
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         <span class="comment">// ****************************************</span>
<a name="l00463"></a>00463 
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (<span class="keyword">false</span> == this-&gt;<a class="code" href="class_o_t_scriptable.html#a4a95506db44acbdd3b125f54cac3595a">ExecuteCallback</a>(*pCallbackClause, theParameters, theReturnVal)) <span class="comment">// &lt;============================================</span>
<a name="l00465"></a>00465         {
<a name="l00466"></a>00466             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Error while running callback script %s, clause %s \n&quot;</span>,
<a name="l00467"></a>00467                           <a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</a>, str_clause_name.c_str());
<a name="l00468"></a>00468             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470         <span class="keywordflow">else</span>
<a name="l00471"></a>00471         {
<a name="l00472"></a>00472             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Success executing callback script %s, clause: %s.\n\n&quot;</span>,
<a name="l00473"></a>00473                            <a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</a>, str_clause_name.c_str());
<a name="l00474"></a>00474 
<a name="l00475"></a>00475             <span class="keywordflow">return</span> theReturnVal.<a class="code" href="class_o_t_variable.html#a0959b001470125f22842d05a278ce0b7">CopyValueBool</a>();
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         <span class="comment">// ****************************************</span>
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <span class="keywordflow">else</span>
<a name="l00480"></a>00480     {
<a name="l00481"></a>00481         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::CanExecuteClause: Unable to find script for: %s. Therefore, default return value is: TRUE.\n&quot;</span>,
<a name="l00482"></a>00482                        <a class="code" href="_o_t_scriptable_8cpp.html#a51efbadf8c28ca583639fbd6991a0fab">SCRIPTABLE_CALLBACK_PARTY_MAY_EXECUTE</a>);
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     <span class="comment">// *****************************************************************************</span>
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 <span class="comment">// Client-side.</span>
<a name="l00491"></a>00491 <span class="comment">// (The server could actually load all the other nyms and accounts,</span>
<a name="l00492"></a>00492 <span class="comment">// and verify their transaction numbers, yadda yadda yadda. But the</span>
<a name="l00493"></a>00493 <span class="comment">// client can only check to see that at least a signed copy is supposedly</span>
<a name="l00494"></a>00494 <span class="comment">// available for every single party.)</span>
<a name="l00495"></a>00495 <span class="comment">//</span>
<a name="l00496"></a><a class="code" href="class_o_t_scriptable.html#a559702a7d59f37881a892129b911d330">00496</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a559702a7d59f37881a892129b911d330">OTScriptable::AllPartiesHaveSupposedlyConfirmed</a>()
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498     <span class="keywordtype">bool</span> bReturnVal = (<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.size() &gt; 0) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00501"></a>00501     {
<a name="l00502"></a>00502         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00503"></a>00503         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00504"></a>00504         <span class="comment">// -----------------------</span>
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (!(pParty-&gt;<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()))
<a name="l00506"></a>00506             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="keywordflow">return</span> bReturnVal;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 
<a name="l00513"></a><a class="code" href="class_o_t_scriptable.html#ab9a6cff853b9c71456eaf427caa3ab8b">00513</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#ab9a6cff853b9c71456eaf427caa3ab8b">OTScriptable::ClearTemporaryPointers</a>()
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00516"></a>00516     {
<a name="l00517"></a>00517         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00518"></a>00518         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00519"></a>00519         <span class="comment">// -----------------------</span>
<a name="l00520"></a>00520         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>();
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 
<a name="l00525"></a><a class="code" href="class_o_t_scriptable.html#a4a95506db44acbdd3b125f54cac3595a">00525</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a4a95506db44acbdd3b125f54cac3595a">OTScriptable::ExecuteCallback</a> (<a class="code" href="class_o_t_clause.html">OTClause</a> &amp; theCallbackClause, <a class="code" href="_o_t_variable_8hpp.html#aa7620bdfc9f969dd2802c11c3260eb37">mapOfVariables</a> &amp; theParameters, <a class="code" href="class_o_t_variable.html">OTVariable</a> &amp; varReturnVal)
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527     <span class="keyword">const</span> std::string str_clause_name   = theCallbackClause.<a class="code" href="class_o_t_clause.html#a325b3cfeedbfc1c699de3d0f787e5120">GetName</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ?
<a name="l00528"></a>00528                                             theCallbackClause.<a class="code" href="class_o_t_clause.html#a325b3cfeedbfc1c699de3d0f787e5120">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00529"></a>00529     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(<a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_clause_name));
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = theCallbackClause.<a class="code" href="class_o_t_clause.html#adcfc1603deba61e670b5d1374147bd6a">GetBylaw</a>();
<a name="l00532"></a>00532     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l00533"></a>00533     <span class="comment">// -------------------------------------------------</span>
<a name="l00534"></a>00534     <span class="comment">// By this point, we have the clause we are executing as theCallbackClause,</span>
<a name="l00535"></a>00535     <span class="comment">// and we have the Bylaw it belongs to, as pBylaw.</span>
<a name="l00536"></a>00536     <span class="comment">// ----------------------------------------</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="keyword">const</span> std::string str_code      =   theCallbackClause.<a class="code" href="class_o_t_clause.html#a29dced05f7ab1026ef191dbc013dddd6">GetCode</a>();    <span class="comment">// source code for the script.</span>
<a name="l00539"></a>00539     <span class="keyword">const</span> std::string str_language  =   pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a9227cd44b9e3bab6efdf0dcb719e126c">GetLanguage</a>();          <span class="comment">// language it&#39;s in. (Default is &quot;chai&quot;)</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     _SharedPtr&lt;OTScript&gt; pScript = <a class="code" href="_o_t_script_8hpp.html#af97c0dd6a02e33a9ff1c837a6d006b88">OTScriptFactory</a>(str_language, str_code);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">// ---------------------------------------------------------------</span>
<a name="l00544"></a>00544     <span class="comment">//</span>
<a name="l00545"></a>00545     <span class="comment">// SET UP THE NATIVE CALLS, REGISTER THE PARTIES, REGISTER THE VARIABLES, AND EXECUTE THE SCRIPT.</span>
<a name="l00546"></a>00546     <span class="comment">//</span>
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (pScript)
<a name="l00548"></a>00548     {
<a name="l00549"></a>00549         <span class="comment">// Register the special server-side native OT calls we make available to all scripts.</span>
<a name="l00550"></a>00550         <span class="comment">//</span>
<a name="l00551"></a>00551         this-&gt;<a class="code" href="class_o_t_scriptable.html#ad469b542209e1c73905d2094bb561793">RegisterOTNativeCallsWithScript</a>(*pScript);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <span class="comment">// ---------------------------------------</span>
<a name="l00554"></a>00554         <span class="comment">// Register all the parties with the script.</span>
<a name="l00555"></a>00555         <span class="comment">//</span>
<a name="l00556"></a>00556         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00557"></a>00557         {
<a name="l00558"></a>00558             <span class="keyword">const</span> std::string str_party_name    = (*it).first;
<a name="l00559"></a>00559             <a class="code" href="class_o_t_party.html">OTParty</a> * pParty                    = (*it).second;
<a name="l00560"></a>00560             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pParty) &amp;&amp; (str_party_name.size() &gt; 0));
<a name="l00561"></a>00561             <span class="comment">// -----------------------</span>
<a name="l00562"></a>00562 
<a name="l00563"></a>00563             pScript-&gt;AddParty(str_party_name, *pParty);
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565         <span class="comment">// ---------------------------------------</span>
<a name="l00566"></a>00566         <span class="comment">// Add the parameters...</span>
<a name="l00567"></a>00567         <span class="comment">//</span>
<a name="l00568"></a>00568         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_variable_8hpp.html#aa7620bdfc9f969dd2802c11c3260eb37">mapOfVariables</a>, theParameters)
<a name="l00569"></a>00569         {
<a name="l00570"></a>00570             <span class="keyword">const</span> std::string str_var_name  = (*it).first;
<a name="l00571"></a>00571             <a class="code" href="class_o_t_variable.html">OTVariable</a> * pVar               = (*it).second;
<a name="l00572"></a>00572             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>((NULL != pVar)&amp;&amp;(str_var_name.size() &gt; 0));
<a name="l00573"></a>00573             <span class="comment">// ---------------------------------------------------</span>
<a name="l00574"></a>00574             pVar-&gt;<a class="code" href="class_o_t_variable.html#a89944d26c87080bbc6aab0ff3fe26de5">RegisterForExecution</a>(*pScript);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="comment">// ---------------------------------------</span>
<a name="l00578"></a>00578         <span class="comment">// Also need to loop through the Variables on pBylaw and register those as well.</span>
<a name="l00579"></a>00579         <span class="comment">//</span>
<a name="l00580"></a>00580         pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#aa9a5296f71c28edb48988fe0a8b4bf65">RegisterVariablesForExecution</a>(*pScript); <span class="comment">// This sets all the variables as CLEAN so we can check for dirtiness after execution.</span>
<a name="l00581"></a>00581         <span class="comment">//</span>
<a name="l00582"></a>00582         <span class="comment">// ****************************************</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         this-&gt;<a class="code" href="class_o_t_scriptable.html#a7590c450a8a079eb388fd4fc378b3b40">SetDisplayLabel</a>(&amp;str_clause_name);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         pScript-&gt;SetDisplayFilename(<a class="code" href="class_o_t_scriptable.html#a9e1d9c7e46bab582ea1922026a21b357">m_strLabel</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pScript-&gt;ExecuteScript(&amp;varReturnVal))
<a name="l00589"></a>00589         {
<a name="l00590"></a>00590             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::ExecuteCallback: Error while running callback on scriptable: %s\n&quot;</span>,
<a name="l00591"></a>00591                          <a class="code" href="class_o_t_scriptable.html#a9e1d9c7e46bab582ea1922026a21b357">m_strLabel</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593         <span class="keywordflow">else</span>
<a name="l00594"></a>00594         {
<a name="l00595"></a>00595             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::ExecuteCallback: Successfully executed callback on scriptable: %s\n\n&quot;</span>,
<a name="l00596"></a>00596                            <a class="code" href="class_o_t_scriptable.html#a9e1d9c7e46bab582ea1922026a21b357">m_strLabel</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l00597"></a>00597             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00598"></a>00598         }
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600     <span class="comment">// ---------------------------------------------------------------</span>
<a name="l00601"></a>00601     <span class="keywordflow">else</span>
<a name="l00602"></a>00602     {
<a name="l00603"></a>00603         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::ExecuteCallback: Error instantiating script!\n&quot;</span>);
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="comment">// ***************************************************************</span>
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="comment">// NOTE: Normally after calling a script, you want to check to see if any of the persistent variables</span>
<a name="l00609"></a>00609     <span class="comment">// are dirty, and if important, send a notice to the parties, save an updated copy of the contract, etc.</span>
<a name="l00610"></a>00610     <span class="comment">// WE DON&#39;T DO THAT FOR CALLBACKS!  Why not?</span>
<a name="l00611"></a>00611     <span class="comment">//</span>
<a name="l00612"></a>00612     <span class="comment">// 1) It only matters if the variables change, if you are actually saving an updated version of the contract.</span>
<a name="l00613"></a>00613     <span class="comment">//    (Which is more OTCronItem / OTSmartContract, which saves an updated copy of itself.) Whereas if you are</span>
<a name="l00614"></a>00614     <span class="comment">//    NOT saving the contract with those variables in it, then why the hell would you care to notify people?</span>
<a name="l00615"></a>00615     <span class="comment">// 2) Since only OTCronItem / OTSmartContract actually save updated copies of themselves, they are the only ones</span>
<a name="l00616"></a>00616     <span class="comment">//    who will ever need to notify anyone. Not EVERY OTScriptable-derived class will send notifications, but if they</span>
<a name="l00617"></a>00617     <span class="comment">//    need to, SendNoticeToAllParties() is already available on OTScriptable.</span>
<a name="l00618"></a>00618     <span class="comment">//</span>
<a name="l00619"></a>00619     <span class="comment">// 3) MOST IMPORTANTLY: the only time a callback is currently triggered is when the script has already been activated</span>
<a name="l00620"></a>00620     <span class="comment">//    somehow, and the only places that do that ALREADY SEND NOTICES WHEN DIRTY. In fact, if a callback actually makes</span>
<a name="l00621"></a>00621     <span class="comment">//    the scriptable dirty, IT WILL SEND NOTICES ANYWAY, since the &quot;ExecuteClauses()&quot; function that CALLED the callback</span>
<a name="l00622"></a>00622     <span class="comment">//    is also smart enough to send the notices already.</span>
<a name="l00623"></a>00623     <span class="comment">//</span>
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 
<a name="l00629"></a>00629 <span class="comment">// TODO: Add a &quot;Notice Number&quot; to OTScriptable and OTVotingGroup. This increments each</span>
<a name="l00630"></a>00630 <span class="comment">// time a notice is sent to the parties, and will be passed in here as a parameter. The nyms</span>
<a name="l00631"></a>00631 <span class="comment">// will all store a map by ServerID, similar to request #, and for each, a list of notice #s</span>
<a name="l00632"></a>00632 <span class="comment">// mapped by the transaction # for each Cron Item the Nym has open. This way the Nym can</span>
<a name="l00633"></a>00633 <span class="comment">// expect to see notice #1, notice #2, etc, to make sure he didn&#39;t miss one. They can even</span>
<a name="l00634"></a>00634 <span class="comment">// have a protocol where each notice contains a hash of the previous one, and the users</span>
<a name="l00635"></a>00635 <span class="comment">// (presumably using some future p2p client) can compare hashes with little network cost.</span>
<a name="l00636"></a>00636 <span class="comment">// (This prevents the server from sending a false notice to one party, without having to</span>
<a name="l00637"></a>00637 <span class="comment">// also falsify all subsequent hashes / notices, since all future hashes will now fail to</span>
<a name="l00638"></a>00638 <span class="comment">// match.) The hashes can also be made public if people prefer, as a way of &quot;publicly</span>
<a name="l00639"></a>00639 <span class="comment">// posting&quot; the hash of the notice ...without in any way revealing the notice contents.</span>
<a name="l00640"></a>00640 
<a name="l00641"></a><a class="code" href="class_o_t_scriptable.html#a03d724ec348f2dc140c9ed45d6133429">00641</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a03d724ec348f2dc140c9ed45d6133429">OTScriptable::SendNoticeToAllParties</a>(<span class="keywordtype">bool</span> bSuccessMsg,
<a name="l00642"></a>00642                                           <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theServerNym,
<a name="l00643"></a>00643                                           <span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theServerID,
<a name="l00644"></a>00644                                           <span class="keyword">const</span> int64_t &amp; lNewTransactionNumber,
<a name="l00645"></a>00645 <span class="comment">//                                        const int64_t &amp; lInReferenceTo,   // Each party has its own opening trans #.</span>
<a name="l00646"></a>00646                                           <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> &amp; strReference,
<a name="l00647"></a>00647                                           <a class="code" href="class_o_t_string.html">OTString</a> * pstrNote<span class="comment">/*=NULL*/</span>,
<a name="l00648"></a>00648                                           <a class="code" href="class_o_t_string.html">OTString</a> * pstrAttachment<span class="comment">/*=NULL*/</span>,
<a name="l00649"></a>00649                                           <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pActualNym<span class="comment">/*=NULL*/</span>)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651     <span class="keywordtype">bool</span> bSuccess = <span class="keyword">true</span>;  <span class="comment">// Success is defined as ALL parties receiving a notice</span>
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00654"></a>00654     {
<a name="l00655"></a>00655         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00656"></a>00656         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00657"></a>00657         <span class="comment">// ------------------</span>
<a name="l00658"></a>00658         <span class="comment">// If a smart contract is being canceled, it may not have been confirmed by</span>
<a name="l00659"></a>00659         <span class="comment">// all parties. There may be some unconfirmed parties. (Meaning there is no</span>
<a name="l00660"></a>00660         <span class="comment">// NymID available for those parties.) So here, we make sure we are only sending</span>
<a name="l00661"></a>00661         <span class="comment">// the notice to parties which have been confirmed. Those parties will have an</span>
<a name="l00662"></a>00662         <span class="comment">// opening transaction number that is non-zero. So for parties with a 0 opening</span>
<a name="l00663"></a>00663         <span class="comment">// number, we skip the notice (since there won&#39;t be any NymID anyway -- nowhere</span>
<a name="l00664"></a>00664         <span class="comment">// to send the notice even if we tried.)</span>
<a name="l00665"></a>00665         <span class="comment">//</span>
<a name="l00666"></a>00666         <span class="keywordflow">if</span> (0 != pParty-&gt;<a class="code" href="class_o_t_party.html#aa11f990dfe9743dd1d8e34af8bfd693a">GetOpeningTransNo</a>())
<a name="l00667"></a>00667         {
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#a7419b9a17e72819156005dd976b2dd1e">SendNoticeToParty</a>(bSuccessMsg, <span class="comment">// &quot;success&quot; notice? or &quot;failure&quot; notice?</span>
<a name="l00669"></a>00669                                                    theServerNym, theServerID, lNewTransactionNumber,
<a name="l00670"></a>00670 <span class="comment">//                                                 lInReferenceTo, // each party has its own opening trans #.</span>
<a name="l00671"></a>00671                                                    strReference, pstrNote, pstrAttachment, pActualNym))
<a name="l00672"></a>00672                 bSuccess = <span class="keyword">false</span>; <span class="comment">// Notice I don&#39;t break here -- I still allow it to try to notice ALL parties, even if one fails.</span>
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">return</span> bSuccess;
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="comment">// So you can tell if any persistent or important variables have CHANGED since it was last set clean.</span>
<a name="l00681"></a>00681 <span class="comment">//</span>
<a name="l00682"></a><a class="code" href="class_o_t_scriptable.html#a3855f5a3f2ae738c6a39674f4d621ed5">00682</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a3855f5a3f2ae738c6a39674f4d621ed5">OTScriptable::IsDirty</a>()<span class="keyword"> const</span>
<a name="l00683"></a>00683 <span class="keyword"></span>{
<a name="l00684"></a>00684     <span class="keywordtype">bool</span> bIsDirty = <span class="keyword">false</span>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l00687"></a>00687     {
<a name="l00688"></a>00688         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l00689"></a>00689         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l00690"></a>00690         <span class="comment">// ---------------------------------------------------</span>
<a name="l00691"></a>00691         <span class="comment">//</span>
<a name="l00692"></a>00692         <span class="keywordflow">if</span> (pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#af44456e72cb29dce8374aa5ea37b6540">IsDirty</a>())
<a name="l00693"></a>00693         {
<a name="l00694"></a>00694             bIsDirty = <span class="keyword">true</span>;
<a name="l00695"></a>00695             <span class="keywordflow">break</span>;
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="keywordflow">return</span> bIsDirty;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="comment">// So you can tell if ONLY the IMPORTANT variables have CHANGED since it was last set clean.</span>
<a name="l00704"></a>00704 <span class="comment">//</span>
<a name="l00705"></a><a class="code" href="class_o_t_scriptable.html#a9f08ba14dc0e384301b8b69947243581">00705</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a9f08ba14dc0e384301b8b69947243581">OTScriptable::IsDirtyImportant</a>()<span class="keyword"> const</span>
<a name="l00706"></a>00706 <span class="keyword"></span>{
<a name="l00707"></a>00707     <span class="keywordtype">bool</span> bIsDirty = <span class="keyword">false</span>;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l00710"></a>00710     {
<a name="l00711"></a>00711         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l00712"></a>00712         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l00713"></a>00713         <span class="comment">// ---------------------------------------------------</span>
<a name="l00714"></a>00714         <span class="comment">//</span>
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a8e755847cfb04617fb6395cbdc16e2c2">IsDirtyImportant</a>())
<a name="l00716"></a>00716         {
<a name="l00717"></a>00717             bIsDirty = <span class="keyword">true</span>;
<a name="l00718"></a>00718             <span class="keywordflow">break</span>;
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="keywordflow">return</span> bIsDirty;
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 <span class="comment">// Sets the variables as clean, so you can check later and see if any have been changed (if it&#39;s DIRTY again.)</span>
<a name="l00727"></a>00727 <span class="comment">//</span>
<a name="l00728"></a><a class="code" href="class_o_t_scriptable.html#a69532b928482fc65b1c5abd2cebe3f4c">00728</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a69532b928482fc65b1c5abd2cebe3f4c">OTScriptable::SetAsClean</a>()
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l00731"></a>00731     {
<a name="l00732"></a>00732         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l00733"></a>00733         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l00734"></a>00734         <span class="comment">// ---------------------------------------------------</span>
<a name="l00735"></a>00735         <span class="comment">//</span>
<a name="l00736"></a>00736         pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a8ed91d5c78fc24f89229531223132142">SetAsClean</a>(); <span class="comment">// so we can check for dirtiness later, if it&#39;s changed.</span>
<a name="l00737"></a>00737     }
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="comment">// Note: this maybe would have been more appropriate on OTSmartContract, since that is</span>
<a name="l00742"></a>00742 <span class="comment">// where the opening/closing numbers are actually USED. But still, they ARE stored HERE,</span>
<a name="l00743"></a>00743 <span class="comment">// so I might as well put the function here also. That way later on, if some new subclass</span>
<a name="l00744"></a>00744 <span class="comment">// uses those numbers, it will have access to count them as well.</span>
<a name="l00745"></a>00745 <span class="comment">//</span>
<a name="l00746"></a>00746 <span class="comment">// Returns 0 if this agent is not the authorizing agent for a party, and is also not the</span>
<a name="l00747"></a>00747 <span class="comment">// authorized agent for any party&#39;s accounts.</span>
<a name="l00748"></a>00748 <span class="comment">//</span>
<a name="l00749"></a><a class="code" href="class_o_t_scriptable.html#a2c2d74c762a93dd62bedfe1235de3bce">00749</a> int32_t <a class="code" href="class_o_t_scriptable.html#a2c2d74c762a93dd62bedfe1235de3bce">OTScriptable::GetCountTransNumsNeededForAgent</a>(<span class="keyword">const</span> std::string str_agent_name)
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751     int32_t nReturnVal = 0;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent = this-&gt;<a class="code" href="class_o_t_scriptable.html#a8f8c32df22c81d1a5aec3e483089b923">GetAgent</a>(str_agent_name);
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (NULL == pAgent)
<a name="l00755"></a>00755         <span class="keywordflow">return</span> nReturnVal;  <span class="comment">// (Looks like there is no agent with that name.)</span>
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment">// Below this point, pAgent is good, meaning str_agent_name really IS</span>
<a name="l00758"></a>00758     <span class="comment">// a legit agent for this party. But that doesn&#39;t necessarily mean the</span>
<a name="l00759"></a>00759     <span class="comment">// agent has to supply any opening or closing transaction #s for this</span>
<a name="l00760"></a>00760     <span class="comment">// smart contract. That&#39;s only true if he&#39;s the AUTHORIZING agent for</span>
<a name="l00761"></a>00761     <span class="comment">// the party (for the opening num) or the authorized agent for any of</span>
<a name="l00762"></a>00762     <span class="comment">// party&#39;s accounts (for the closing number).  So let&#39;s add it up...</span>
<a name="l00763"></a>00763     <span class="comment">//</span>
<a name="l00764"></a>00764     <span class="keywordflow">if</span> (pAgent-&gt;<a class="code" href="class_o_t_agent.html#a4fd83cc610c9c64e1e3dd043b050a81a">IsAuthorizingAgentForParty</a>())   <span class="comment">// true/false whether THIS agent is the authorizing agent for his party.</span>
<a name="l00765"></a>00765         nReturnVal++;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     <span class="comment">// Add the number of accounts, owned by this agent&#39;s party, that this agent is the authorized agent FOR.</span>
<a name="l00768"></a>00768     <span class="comment">//</span>
<a name="l00769"></a>00769     nReturnVal += pAgent-&gt;<a class="code" href="class_o_t_agent.html#a3bb37db7c624b498462ca875783d9f50">GetCountAuthorizedAccts</a>();
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="keywordflow">return</span> nReturnVal;
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 
<a name="l00775"></a><a class="code" href="class_o_t_scriptable.html#a94c9e55f78357e04e4b9781ab662370f">00775</a> <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * <a class="code" href="class_o_t_scriptable.html#a94c9e55f78357e04e4b9781ab662370f">OTScriptable::GetPartyAccount</a>(<span class="keyword">const</span> std::string str_acct_name)
<a name="l00776"></a>00776 {
<a name="l00777"></a>00777     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_acct_name)) <span class="comment">// this logs, FYI.</span>
<a name="l00778"></a>00778     {
<a name="l00779"></a>00779         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::GetPartyAccount:  Error: invalid name.\n&quot;</span>);
<a name="l00780"></a>00780         <span class="keywordflow">return</span> NULL;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     <span class="comment">// ----------------------------------------</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="comment">//  OTLog::vError(&quot;DEBUGGING OTScriptable::GetPartyAccount: above loop. str_acct_name: %s \n&quot;, str_acct_name.c_str());</span>
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00787"></a>00787     {
<a name="l00788"></a>00788         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00789"></a>00789         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00790"></a>00790         <span class="comment">// -------------------------</span>
<a name="l00791"></a>00791 
<a name="l00792"></a>00792 <span class="comment">//      OTLog::vError(&quot;DEBUGGING OTScriptable::GetPartyAccount: loop iteration. party name: %s \n&quot;, pParty-&gt;GetPartyName().c_str());</span>
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pAcct = pParty-&gt;<a class="code" href="class_o_t_party.html#aee3973dc05c042dab571781a9d454af2">GetAccount</a>(str_acct_name);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         <span class="keywordflow">if</span> (NULL != pAcct) <span class="comment">// found it.</span>
<a name="l00797"></a>00797             <span class="keywordflow">return</span> pAcct;
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800 <span class="comment">//  OTLog::Error(&quot;DEBUGGING OTScriptable::GetPartyAccount: below loop \n&quot;);</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="keywordflow">return</span> NULL;
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="class_o_t_scriptable.html#ae4abf1800fd193dc93835b777f40019c">00806</a> <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * <a class="code" href="class_o_t_scriptable.html#ae4abf1800fd193dc93835b777f40019c">OTScriptable::GetPartyAccountByID</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAcctID)<span class="keyword"> const</span>
<a name="l00807"></a>00807 <span class="keyword"></span>{
<a name="l00808"></a>00808     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00809"></a>00809     {
<a name="l00810"></a>00810         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00811"></a>00811         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00812"></a>00812         <span class="comment">// -------------------------</span>
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pAcct = pParty-&gt;<a class="code" href="class_o_t_party.html#a31c08f0f4902dd79db4786d10f2fe81e">GetAccountByID</a>(theAcctID);
<a name="l00815"></a>00815 
<a name="l00816"></a>00816         <span class="keywordflow">if</span> (NULL != pAcct) <span class="comment">// found it.</span>
<a name="l00817"></a>00817             <span class="keywordflow">return</span> pAcct;
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="keywordflow">return</span> NULL;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="comment">/*</span>
<a name="l00825"></a>00825 <span class="comment"> bool HasAgent(OTPseudonym &amp; theNym, OTAgent ** ppAgent=NULL) const; // If Nym is agent for Party, set agent&#39;s pointer to Nym and return true.</span>
<a name="l00826"></a>00826 <span class="comment"> bool HasAgentByNymID(OTIdentifier &amp; theNymID, OTAgent ** ppAgent=NULL) const;</span>
<a name="l00827"></a>00827 <span class="comment"> // ------------------------------------</span>
<a name="l00828"></a>00828 <span class="comment"> bool HasAuthorizingAgent(OTPseudonym &amp; theNym, OTAgent ** ppAgent=NULL) const;</span>
<a name="l00829"></a>00829 <span class="comment"> bool HasAuthorizingAgentByNymID(OTIdentifier &amp; theNymID, OTAgent ** ppAgent=NULL) const; // ppAgent lets you get the agent ptr if it was there.</span>
<a name="l00830"></a>00830 <span class="comment"> // ------------------------------------</span>
<a name="l00831"></a>00831 <span class="comment"> */</span>
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="comment">/*</span>
<a name="l00834"></a>00834 <span class="comment">OTParty * FindPartyBasedOnNymIDAsAgent(const OTIdentifier &amp; theNymID, OTAgent ** ppAgent=NULL);</span>
<a name="l00835"></a>00835 <span class="comment">OTParty * FindPartyBasedOnNymIDAsAuthAgent(const OTIdentifier &amp; theNymID, OTAgent ** ppAgent=NULL);</span>
<a name="l00836"></a>00836 <span class="comment">OTParty * FindPartyBasedOnAccountID(const OTIdentifier &amp; theAcctID, OTPartyAccount ** ppPartyAccount=NULL);</span>
<a name="l00837"></a>00837 <span class="comment">*/</span>
<a name="l00838"></a>00838 
<a name="l00839"></a><a class="code" href="class_o_t_scriptable.html#af0eddbe4b88394bcc113d9333d8e0a97">00839</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#af0eddbe4b88394bcc113d9333d8e0a97">OTScriptable::FindPartyBasedOnNymIDAsAgent</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theNymID, <a class="code" href="class_o_t_agent.html">OTAgent</a> ** ppAgent<span class="comment">/*=NULL*/</span>)<span class="keyword"> const</span>
<a name="l00840"></a>00840 <span class="keyword"></span>{
<a name="l00841"></a>00841     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00842"></a>00842     {
<a name="l00843"></a>00843         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00844"></a>00844         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00845"></a>00845         <span class="comment">// -----------------------</span>
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#a6d8f917d33c9c49c6425add0b041e4ee">HasAgentByNymID</a>(theNymID, ppAgent))
<a name="l00848"></a>00848             <span class="keywordflow">return</span> pParty;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850     <span class="keywordflow">return</span> NULL;
<a name="l00851"></a>00851 }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="class_o_t_scriptable.html#a5853814d252a72a7d5c7d63f04c3cae2">00854</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#a5853814d252a72a7d5c7d63f04c3cae2">OTScriptable::FindPartyBasedOnNymIDAsAuthAgent</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theNymID, <a class="code" href="class_o_t_agent.html">OTAgent</a> ** ppAgent<span class="comment">/*=NULL*/</span>)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00857"></a>00857     {
<a name="l00858"></a>00858         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00859"></a>00859         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00860"></a>00860         <span class="comment">// -----------------------</span>
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#a649744ad680735efc8f3670c0b4294fc">HasAuthorizingAgentByNymID</a>(theNymID, ppAgent))
<a name="l00863"></a>00863             <span class="keywordflow">return</span> pParty;
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865     <span class="keywordflow">return</span> NULL;
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 
<a name="l00869"></a><a class="code" href="class_o_t_scriptable.html#a7a425a20fba9d2a800e1d6a029186094">00869</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#a7a425a20fba9d2a800e1d6a029186094">OTScriptable::FindPartyBasedOnAccountID</a>(<span class="keyword">const</span> <a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; theAcctID, <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> ** ppPartyAccount<span class="comment">/*=NULL*/</span>)
<a name="l00870"></a>00870 {
<a name="l00871"></a>00871     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00872"></a>00872     {
<a name="l00873"></a>00873         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00874"></a>00874         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00875"></a>00875         <span class="comment">// -----------------------</span>
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#a1bf782a97edb882ba9ace729ed74e22d">HasAccountByID</a>(theAcctID, ppPartyAccount))
<a name="l00878"></a>00878         {
<a name="l00879"></a>00879             <span class="keywordflow">return</span> pParty;
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882     <span class="keywordflow">return</span> NULL;
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 
<a name="l00886"></a><a class="code" href="class_o_t_scriptable.html#aa89029542587094cd2844cb8bf7a9a16">00886</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#aa89029542587094cd2844cb8bf7a9a16">OTScriptable::FindPartyBasedOnNymAsAgent</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym, <a class="code" href="class_o_t_agent.html">OTAgent</a> ** ppAgent<span class="comment">/*=NULL*/</span>)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00889"></a>00889     {
<a name="l00890"></a>00890         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00891"></a>00891         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00892"></a>00892         <span class="comment">// -----------------------</span>
<a name="l00893"></a>00893 
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#afda73de60d222bc8c01b893289a4564e">HasAgent</a>(theNym, ppAgent))
<a name="l00895"></a>00895             <span class="keywordflow">return</span> pParty;
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     <span class="keywordflow">return</span> NULL;
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 
<a name="l00901"></a><a class="code" href="class_o_t_scriptable.html#a08ff87b0f54ed3139bfcfb362a757778">00901</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#a08ff87b0f54ed3139bfcfb362a757778">OTScriptable::FindPartyBasedOnNymAsAuthAgent</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym, <a class="code" href="class_o_t_agent.html">OTAgent</a> ** ppAgent<span class="comment">/*=NULL*/</span>)
<a name="l00902"></a>00902 {
<a name="l00903"></a>00903     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00904"></a>00904     {
<a name="l00905"></a>00905         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00906"></a>00906         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00907"></a>00907         <span class="comment">// -----------------------</span>
<a name="l00908"></a>00908 
<a name="l00909"></a>00909         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#aa34fe1901531ed5056633b99fade0f93">HasAuthorizingAgent</a>(theNym, ppAgent))
<a name="l00910"></a>00910             <span class="keywordflow">return</span> pParty;
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912     <span class="keywordflow">return</span> NULL;
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 
<a name="l00916"></a><a class="code" href="class_o_t_scriptable.html#adf3ca54a95c8813c23cf7bdc23e4330a">00916</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#adf3ca54a95c8813c23cf7bdc23e4330a">OTScriptable::FindPartyBasedOnAccount</a>(<a class="code" href="class_o_t_account.html">OTAccount</a> &amp; theAccount, <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> ** ppPartyAccount<span class="comment">/*=NULL*/</span>)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00919"></a>00919     {
<a name="l00920"></a>00920         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00921"></a>00921         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00922"></a>00922         <span class="comment">// -----------------------</span>
<a name="l00923"></a>00923 
<a name="l00924"></a>00924         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#ad586d25e956e0925e58e39879688a8e9">HasAccount</a>(theAccount, ppPartyAccount))
<a name="l00925"></a>00925         {
<a name="l00926"></a>00926             <span class="keywordflow">return</span> pParty;
<a name="l00927"></a>00927         }
<a name="l00928"></a>00928     }
<a name="l00929"></a>00929     <span class="keywordflow">return</span> NULL;
<a name="l00930"></a>00930 }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932 
<a name="l00933"></a><a class="code" href="class_o_t_scriptable.html#a9e41bb939fd5dbfe1f2442e5919a5079">00933</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a9e41bb939fd5dbfe1f2442e5919a5079">OTScriptable::RetrieveNymPointers</a>(<a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a> &amp; map_Nyms_Already_Loaded)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l00936"></a>00936     {
<a name="l00937"></a>00937         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l00938"></a>00938         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l00939"></a>00939         <span class="comment">// -----------------------</span>
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         pParty-&gt;<a class="code" href="class_o_t_party.html#aa47dda003a2d39a491ac96582c9679b8">RetrieveNymPointers</a>(map_Nyms_Already_Loaded);
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945 
<a name="l00946"></a>00946 <span class="comment">/*</span>
<a name="l00947"></a>00947 <span class="comment"> -- Load up the authorizing agent&#39;s Nym, if not already loaded. (Why? To verifySignature. Also, just to have</span>
<a name="l00948"></a>00948 <span class="comment"> it loaded so I don&#39;t have to load it twice in case it&#39;s needed for verifying one/some of the accts.) So really:</span>
<a name="l00949"></a>00949 <span class="comment"> -- Verify each party, that the authorizing agent and signature are all good. (I think I have this already...)</span>
<a name="l00950"></a>00950 <span class="comment"> -- Definitely during this, need to make sure that the contents of the signed version match the contents of the main version, for each signer.</span>
<a name="l00951"></a>00951 <span class="comment"> -- Verify that the authorizing agent actually has the opening transaction # for the party issued to him. (Do I have this?....)</span>
<a name="l00952"></a>00952 <span class="comment"> */</span>
<a name="l00953"></a>00953 
<a name="l00954"></a>00954 <span class="comment">// OTScriptable::VerifyPartyAuthorization</span>
<a name="l00955"></a>00955 <span class="comment">// Similar to VerifyNymAsAgent, except it doesn&#39;t ClearTemporaryPointers.</span>
<a name="l00956"></a>00956 <span class="comment">// (If it has to Load the authorizing agent, then it will clear that one.)</span>
<a name="l00957"></a>00957 <span class="comment">// It also doesn&#39;t START with a Nym, per se, but rather starts from the Party.</span>
<a name="l00958"></a>00958 <span class="comment">// Though it still allows the possibility that the Nym is already loaded.</span>
<a name="l00959"></a>00959 <span class="comment">// I basically wrote RetrieveNymPointers() (above) so I could call it in here.</span>
<a name="l00960"></a>00960 <span class="comment">// This function is for cases where the Nym very well may NOT be loaded yet,</span>
<a name="l00961"></a>00961 <span class="comment">// BUT THAT WHETHER IT IS, OR NOT, IT *DEFINITELY* DOESN&#39;T CLEAR OUT THE ONES</span>
<a name="l00962"></a>00962 <span class="comment">// THAT *ARE* THERE OTHER THAN WHICHEVER ONES IT IS FORCED TO LOAD ITSELF.</span>
<a name="l00963"></a>00963 <span class="comment">// (This is in contrast to VerifyNymAsAgent(), which calls ClearTemporaryPointers()</span>
<a name="l00964"></a>00964 <span class="comment">// religiously.)</span>
<a name="l00965"></a>00965 <span class="comment">//</span>
<a name="l00966"></a>00966 <span class="comment">// This function also verifies the opening transactions # for the party, whereas</span>
<a name="l00967"></a>00967 <span class="comment">// VerifyNymAsAgent doesn&#39;t. ACTUALLY WAIT -- There IS no opening transaction #</span>
<a name="l00968"></a>00968 <span class="comment">// except for OTCronItem-derived objects (OTSmartContract for example...)</span>
<a name="l00969"></a>00969 <span class="comment">// So perhaps that will have to go OUTSIDE of this function after all!</span>
<a name="l00970"></a>00970 <span class="comment">// Therefore I&#39;ll make a separate function for that that I can call along with</span>
<a name="l00971"></a>00971 <span class="comment">// this one. (Like how I do in OTSmartContract::CanCancelContract)</span>
<a name="l00972"></a>00972 <span class="comment">//</span>
<a name="l00973"></a>00973 <span class="comment">// No again -- Because it&#39;s in HERE that I actually have the authorizing agent</span>
<a name="l00974"></a>00974 <span class="comment">// loaded. I certainly don&#39;t want to just have to load him up again. Therefore I</span>
<a name="l00975"></a>00975 <span class="comment">// have to use a new rule:  IN THIS FUNCTION, if the party HAS an Opening Number,</span>
<a name="l00976"></a>00976 <span class="comment">// THEN IT MUST VERIFY. Since the default value is 0, then that should work, since</span>
<a name="l00977"></a>00977 <span class="comment">// I&#39;m always verifying the number as long as one is there.</span>
<a name="l00978"></a>00978 <span class="comment">//</span>
<a name="l00979"></a><a class="code" href="class_o_t_scriptable.html#a5b20bcf70883ffe7e02f10343b88affc">00979</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a5b20bcf70883ffe7e02f10343b88affc">OTScriptable::VerifyPartyAuthorization</a>(<a class="code" href="class_o_t_party.html">OTParty</a>         &amp; theParty,     <span class="comment">// The party that supposedly is authorized for this supposedly executed agreement.</span>
<a name="l00980"></a>00980                                             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     &amp; theSignerNym, <span class="comment">// For verifying signature on the authorizing Nym, when loading it</span>
<a name="l00981"></a>00981                                             <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  &amp; strServerID, <span class="comment">// For verifying issued num, need the serverID the # goes with.</span>
<a name="l00982"></a>00982                                             <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a>       * pmap_ALREADY_LOADED<span class="comment">/*=NULL*/</span>, <span class="comment">// If some nyms are already loaded, pass them here so we don&#39;t load them twice on accident.</span>
<a name="l00983"></a>00983                                             <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a>       * pmap_NEWLY_LOADED<span class="comment">/*=NULL*/</span>,   <span class="comment">// If some nyms had to be loaded, then they will be deleted, too. UNLESS you pass a map here, in which case they will instead be added to this map. (But if you do that, then you must delete them yourself after calling this function.)</span>
<a name="l00984"></a>00984                                             <span class="keyword">const</span> <span class="keywordtype">bool</span>        bBurnTransNo<span class="comment">/*=false*/</span>) <span class="comment">// In OTServer::VerifySmartContract(), it not only wants to verify the # is properly issued, but it additionally wants to see that it hasn&#39;t been USED yet -- AND it wants to burn it, so it can&#39;t be used again!  This bool allows you to tell the function whether or not to do that.</span>
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     <span class="comment">// This function DOES assume that theParty was initially FOUND on OTScriptable.</span>
<a name="l00987"></a>00987     <span class="comment">// Meaning I don&#39;t have to verify that much if I got this far.</span>
<a name="l00988"></a>00988     <span class="comment">// --------------------------------------------------</span>
<a name="l00989"></a>00989     <span class="keyword">const</span> <span class="keywordtype">bool</span> bNeedToCleanup = (NULL == pmap_NEWLY_LOADED) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00990"></a>00990     <span class="comment">// --------------------------------------------------</span>
<a name="l00991"></a>00991     <span class="comment">// This party hasn&#39;t signed the contract??</span>
<a name="l00992"></a>00992     <span class="comment">//</span>
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (<span class="keyword">false</span> == theParty.<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l00994"></a>00994     {
<a name="l00995"></a>00995         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find party&#39;s signed copy of this contract. Has it been executed?\n&quot;</span>,
<a name="l00996"></a>00996                        __FUNCTION__);
<a name="l00997"></a>00997         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">// By this point, we know that theParty has a signed copy of the agreement (or of SOMETHING anyway) and we know that</span>
<a name="l01001"></a>01001     <span class="comment">// we were able to find the party based on theNym as one of its agents. But the signature still needs to be verified...</span>
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="comment">// (2)</span>
<a name="l01004"></a>01004     <span class="comment">// This step verifies that the party has been signed by its authorizing agent. (Who may not be the Nym, yet might be.)</span>
<a name="l01005"></a>01005     <span class="comment">//</span>
<a name="l01006"></a>01006     <a class="code" href="class_o_t_agent.html">OTAgent</a>     * pAuthorizingAgent = NULL;
<a name="l01007"></a>01007     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pAuthAgentsNym    = NULL;
<a name="l01008"></a>01008     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPseudonym&gt;</a> theAgentNymAngel; <span class="comment">// In case I have to load it myself, I want it cleaned up properly.</span>
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="comment">// Some nyms are *already* loaded. If any were passed in, let&#39;s see if any of them are</span>
<a name="l01011"></a>01011     <span class="comment">// the authorizing agent for the contract (for this party)...</span>
<a name="l01012"></a>01012     <span class="comment">//</span>
<a name="l01013"></a>01013     <span class="keywordflow">if</span> (NULL != pmap_ALREADY_LOADED)
<a name="l01014"></a>01014     {
<a name="l01015"></a>01015         <span class="comment">// (So we don&#39;t load it twice, if it&#39;s there.)</span>
<a name="l01016"></a>01016         <span class="comment">//</span>
<a name="l01017"></a>01017         <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a> &amp; map_Nyms_Already_Loaded = (*pmap_ALREADY_LOADED);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a>, map_Nyms_Already_Loaded)
<a name="l01020"></a>01020         {
<a name="l01021"></a>01021             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = (*it).second;
<a name="l01022"></a>01022             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01023"></a>01023             <span class="comment">// -----------------------------</span>
<a name="l01024"></a>01024             <span class="keywordflow">if</span> (theParty.<a class="code" href="class_o_t_party.html#aa34fe1901531ed5056633b99fade0f93">HasAuthorizingAgent</a>(*pNym, &amp;pAuthorizingAgent))
<a name="l01025"></a>01025             {
<a name="l01026"></a>01026                 pAuthAgentsNym = pNym; <span class="comment">// Just in case</span>
<a name="l01027"></a>01027                 <span class="keywordflow">break</span>;
<a name="l01028"></a>01028             }
<a name="l01029"></a>01029         }
<a name="l01030"></a>01030         <span class="comment">// if pAuthorizingAgent != NULL, that means the authorizing agent was found among the map of nyms that were already loaded.</span>
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032     <span class="comment">// -------------------------------------------------------------------------------------</span>
<a name="l01033"></a>01033     <span class="comment">// Only if I had to load the authorizing agent myself, do I clear its temporary pointer.</span>
<a name="l01034"></a>01034     <span class="comment">// (Because it&#39;s going out of scope at the bottom of this function.)</span>
<a name="l01035"></a>01035     <span class="comment">// Any other temporary pointers, I do NOT clear, but I leave them because a script is</span>
<a name="l01036"></a>01036     <span class="comment">// probably executing and may still need them.</span>
<a name="l01037"></a>01037     <span class="comment">// (This function that we&#39;re in was expressly called by someone who didn&#39;t want the</span>
<a name="l01038"></a>01038     <span class="comment">// temporary nym pointers cleared just yet, for whatever reason.)</span>
<a name="l01039"></a>01039     <span class="comment">//</span>
<a name="l01040"></a>01040     <span class="keywordtype">bool</span> bHadToLoadItMyself = (NULL == pAuthorizingAgent) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="comment">// Still not found? Okay, let&#39;s LOAD IT UP then...</span>
<a name="l01043"></a>01043     <span class="comment">//</span>
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (bHadToLoadItMyself)
<a name="l01045"></a>01045     {
<a name="l01046"></a>01046         <span class="comment">// Of all of a party&#39;s Agents, the &quot;authorizing agent&quot; is the one who originally activated</span>
<a name="l01047"></a>01047         <span class="comment">// the agreement for this party (and fronted the opening trans#.) Since we need to verify his</span>
<a name="l01048"></a>01048         <span class="comment">// signature, we have to load him up.</span>
<a name="l01049"></a>01049         <span class="comment">//</span>
<a name="l01050"></a>01050         pAuthAgentsNym = theParty.<a class="code" href="class_o_t_party.html#a01988fe0bfd917703214f7f7bf3ba66f">LoadAuthorizingAgentNym</a>(theSignerNym, &amp;pAuthorizingAgent);
<a name="l01051"></a>01051 
<a name="l01052"></a>01052         <span class="keywordflow">if</span> (NULL != pAuthAgentsNym) <span class="comment">// success</span>
<a name="l01053"></a>01053         {
<a name="l01054"></a>01054             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAuthorizingAgent); <span class="comment">// This HAS to be set now. I assume it henceforth.</span>
<a name="l01055"></a>01055             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;%s: I just had to load &quot;</span>
<a name="l01056"></a>01056                            <span class="stringliteral">&quot;the authorizing agent&#39;s Nym for a party (%s), &quot;</span>
<a name="l01057"></a>01057                            <span class="stringliteral">&quot;so I guess it wasn&#39;t already available on the list of &quot;</span>
<a name="l01058"></a>01058                            <span class="stringliteral">&quot;Nyms that were already loaded.\n&quot;</span>,
<a name="l01059"></a>01059                            __FUNCTION__, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01060"></a>01060             <span class="comment">// ----------------------------------------------------</span>
<a name="l01061"></a>01061             <span class="comment">// Either I&#39;m DEFINITELY cleaning it up myself, OR I&#39;m adding it to a list</span>
<a name="l01062"></a>01062             <span class="comment">// where the CALLER can clean it up.</span>
<a name="l01063"></a>01063             <span class="comment">//</span>
<a name="l01064"></a>01064             <span class="keywordflow">if</span> (bNeedToCleanup)
<a name="l01065"></a>01065                 theAgentNymAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pAuthAgentsNym);  <span class="comment">// CLEANUP!!</span>
<a name="l01066"></a>01066             <span class="keywordflow">else</span>
<a name="l01067"></a>01067             {
<a name="l01068"></a>01068                 <span class="keyword">const</span>
<a name="l01069"></a>01069                 std::string str_agent_name = pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a123d27f05e46977ecdbe0b83de3c119d">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l01070"></a>01070 
<a name="l01071"></a>01071                 <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a> &amp; map_Nyms_Newly_Loaded = (*pmap_NEWLY_LOADED);
<a name="l01072"></a>01072                 map_Nyms_Newly_Loaded.insert(map_Nyms_Newly_Loaded.begin(),
<a name="l01073"></a>01073                                              std::pair&lt;std::string, OTPseudonym *&gt;(str_agent_name, pAuthAgentsNym)); <span class="comment">// (Caller must clean these up.)</span>
<a name="l01074"></a>01074             }
<a name="l01075"></a>01075         }
<a name="l01076"></a>01076         <span class="keywordflow">else</span>
<a name="l01077"></a>01077         {
<a name="l01078"></a>01078             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: Strange, unable to load authorizing agent&#39;s Nym (to verify his signature.)\n&quot;</span>,
<a name="l01079"></a>01079                           __FUNCTION__);
<a name="l01080"></a>01080             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     <span class="comment">// Below this point, we KNOW that pAuthorizingAgent is a good pointer and will be cleaned up properly/automatically.</span>
<a name="l01085"></a>01085     <span class="comment">// I&#39;m not using pAuthAgentsNym directly, but pAuthorizingAgent WILL use it before this function is done.</span>
<a name="l01086"></a>01086     <span class="comment">// -----------------------------------------</span>
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="comment">// (3) Verify the issued number, if he has one. If this instance is OTScriptable-derived, but NOT OTCronItem-derived,</span>
<a name="l01089"></a>01089     <span class="comment">//     then that means there IS NO opening number (or closing number) since we&#39;re not even on Cron. The parties just</span>
<a name="l01090"></a>01090     <span class="comment">//     happen to store their opening number for the cases where we ARE on Cron, which will probably be most cases.</span>
<a name="l01091"></a>01091     <span class="comment">//     Therefore we CHECK TO SEE if the opening number is NONZERO -- and if so, we VERIFY ISSUED on that #. That way,</span>
<a name="l01092"></a>01092     <span class="comment">//     for cases where this IS a cron item, it will still verify the number (as it should) and in other cases, it will</span>
<a name="l01093"></a>01093     <span class="comment">//     just skip this step.</span>
<a name="l01094"></a>01094     <span class="comment">//</span>
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keyword">const</span> int64_t lOpeningNo = theParty.<a class="code" href="class_o_t_party.html#aa11f990dfe9743dd1d8e34af8bfd693a">GetOpeningTransNo</a>();
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="keywordflow">if</span> (lOpeningNo &gt; 0) <span class="comment">// If one exists, then verify it.</span>
<a name="l01099"></a>01099     {
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#aa5175fb8a0a26e3b5cb7ea54ba3c2f7e">VerifyIssuedNumber</a>(lOpeningNo, strServerID))
<a name="l01101"></a>01101         {
<a name="l01102"></a>01102             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Opening trans number %lld doesn&#39;t &quot;</span>
<a name="l01103"></a>01103                           <span class="stringliteral">&quot;verify for the nym listed as the authorizing agent for party %s.\n&quot;</span>,
<a name="l01104"></a>01104                           __FUNCTION__, lOpeningNo, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (bHadToLoadItMyself &amp;&amp; bNeedToCleanup)
<a name="l01106"></a>01106                 pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a90211a756315e750b9e658bc6a224f0e">ClearTemporaryPointers</a>(); <span class="comment">// We loaded the Nym ourselves, which goes out of scope after this function.</span>
<a name="l01107"></a>01107             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01108"></a>01108         }
<a name="l01109"></a>01109         <span class="comment">// --------------------------------------</span>
<a name="l01110"></a>01110         <span class="comment">// The caller wants the additional verification that the number hasn&#39;t been USED</span>
<a name="l01111"></a>01111         <span class="comment">// yet -- AND the caller wants you to BURN IT HERE.</span>
<a name="l01112"></a>01112         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bBurnTransNo)
<a name="l01113"></a>01113         {
<a name="l01114"></a>01114             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#adb89b362ce9a7100d4bd736d8e54d92a">VerifyTransactionNumber</a>(lOpeningNo, strServerID))
<a name="l01115"></a>01115             {
<a name="l01116"></a>01116                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Opening trans number %lld doesn&#39;t &quot;</span>
<a name="l01117"></a>01117                               <span class="stringliteral">&quot;verify as available for use, for the nym listed as the authorizing agent for party: %s.\n&quot;</span>,
<a name="l01118"></a>01118                               __FUNCTION__, lOpeningNo, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01119"></a>01119                 <span class="keywordflow">if</span> (bHadToLoadItMyself &amp;&amp; bNeedToCleanup)
<a name="l01120"></a>01120                     pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a90211a756315e750b9e658bc6a224f0e">ClearTemporaryPointers</a>(); <span class="comment">// We loaded the Nym ourselves, which goes out of scope after this function.</span>
<a name="l01121"></a>01121                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01122"></a>01122             }
<a name="l01123"></a>01123             <span class="keywordflow">else</span> <span class="comment">// SUCCESS -- It verified as available, so let&#39;s burn it here. (So he can&#39;t use it twice. It remains issued and open until the cron item is eventually closed out for good.)</span>
<a name="l01124"></a>01124             {
<a name="l01125"></a>01125                 <span class="comment">// This function also adds lOpeningNo to the agent&#39;s nym&#39;s list of open cron items.</span>
<a name="l01126"></a>01126                 <span class="comment">// (OTPseudonym::GetSetOpenCronItems)</span>
<a name="l01127"></a>01127                 <span class="comment">//</span>
<a name="l01128"></a>01128                 pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a6e4e4cc1971996a8da677b1c789a324e">RemoveTransactionNumber</a>(lOpeningNo, strServerID, theSignerNym, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l01129"></a>01129             }
<a name="l01130"></a>01130         }
<a name="l01131"></a>01131         <span class="comment">// ---------------------</span>
<a name="l01132"></a>01132     } <span class="comment">// if lOpeningNo&gt;0</span>
<a name="l01133"></a>01133     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bBurnTransNo)  <span class="comment">// In this case, bBurnTransNo=true, then the caller EXPECTED to burn a transaction</span>
<a name="l01134"></a>01134     {                       <span class="comment">// num. But the number was 0! Therefore, FAILURE!</span>
<a name="l01135"></a>01135         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: FAILURE. On Party %s, expected to burn a legitimate opening transaction &quot;</span>
<a name="l01136"></a>01136                        <span class="stringliteral">&quot;number, but got this instead: %lld\n&quot;</span>, __FUNCTION__, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str(), lOpeningNo);
<a name="l01137"></a>01137         <span class="keywordflow">if</span> (bHadToLoadItMyself &amp;&amp; bNeedToCleanup)
<a name="l01138"></a>01138             pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a90211a756315e750b9e658bc6a224f0e">ClearTemporaryPointers</a>(); <span class="comment">// We loaded the Nym ourselves, which goes out of scope after this function.</span>
<a name="l01139"></a>01139         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     <span class="comment">// ----------------------------------------------</span>
<a name="l01142"></a>01142     <span class="comment">//</span>
<a name="l01143"></a>01143     <span class="comment">// (4)</span>
<a name="l01144"></a>01144     <span class="comment">// Here, we use the Authorizing Agent to verify the signature on his party&#39;s version of the contract.</span>
<a name="l01145"></a>01145     <span class="comment">// Notice: Even if the authorizing agent gets fired, we can still load his Nym to verify the original signature on the</span>
<a name="l01146"></a>01146     <span class="comment">// original contract! We should ALWAYS be able to verify our signatures!  Therefore, TODO: When a Nym is DELETED, it&#39;s necessary</span>
<a name="l01147"></a>01147     <span class="comment">// to KEEP the public key on file. We may not have a Nymfile with any request #s or trans# signed out, and there are may be no</span>
<a name="l01148"></a>01148     <span class="comment">// accounts for him, but we still need that public key, for later verification of the signature.</span>
<a name="l01149"></a>01149     <span class="comment">// UNLESS... the public key ITSELF is stashed into the contract... Notice that normal asset contracts already keep the keys inside,</span>
<a name="l01150"></a>01150     <span class="comment">// so why shouldn&#39;t these? In fact I can pop the &quot;key&quot; value onto the contract as part of the &quot;Party-Signing&quot; API call. Just grab the</span>
<a name="l01151"></a>01151     <span class="comment">// public key from each one. Meanwhile the server can verify that it&#39;s actually there, and refuse to process without it!!  Nice.</span>
<a name="l01152"></a>01152     <span class="comment">// This also shows why we need to store the NymID, even if it can be overridden by a Role: because you want to be able to verify</span>
<a name="l01153"></a>01153     <span class="comment">// the original signature, no matter WHO is authorized now. Otherwise your entire contract falls apart.</span>
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pPartySignedCopy = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(theParty.<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>());
<a name="l01156"></a>01156     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theCopyAngel;
<a name="l01157"></a>01157 
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (NULL == pPartySignedCopy)
<a name="l01159"></a>01159     {
<a name="l01160"></a>01160         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading party&#39;s signed copy of agreement. Has it been executed?\n&quot;</span>, __FUNCTION__);
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (bHadToLoadItMyself &amp;&amp; bNeedToCleanup)
<a name="l01162"></a>01162             pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a90211a756315e750b9e658bc6a224f0e">ClearTemporaryPointers</a>();
<a name="l01163"></a>01163         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01164"></a>01164     }
<a name="l01165"></a>01165     <span class="keywordflow">else</span>
<a name="l01166"></a>01166     {
<a name="l01167"></a>01167         theCopyAngel.SetCleanupTarget(*pPartySignedCopy);
<a name="l01168"></a>01168     }
<a name="l01169"></a>01169     <span class="comment">// ----------------------------------------------</span>
<a name="l01170"></a>01170     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSigVerified = pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a63316db5c765344066a18d87e39cef60">VerifySignature</a>(*pPartySignedCopy);
<a name="l01171"></a>01171 <span class="comment">//  const bool bSigVerified = pPartySignedCopy-&gt;VerifySignature(*pAuthAgentsNym);</span>
<a name="l01172"></a>01172     <span class="keywordtype">bool</span> bContentsVerified = <span class="keyword">false</span>;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <span class="keywordflow">if</span> (bSigVerified)
<a name="l01175"></a>01175     {
<a name="l01176"></a>01176         <span class="comment">// Todo OPTIMIZE: Might move this call to a higher layer, so it gets called MUCH less often but retains the same security.</span>
<a name="l01177"></a>01177         <span class="comment">// There are several places currently in smart contracts like this.</span>
<a name="l01178"></a>01178         <span class="comment">// Need to analyze security aspects before doing it.</span>
<a name="l01179"></a>01179         <span class="comment">//</span>
<a name="l01180"></a>01180         bContentsVerified = this-&gt;<a class="code" href="class_o_t_scriptable.html#aa4735bf6c25261ea1a021fd8afb57916">Compare</a>(*pPartySignedCopy); <span class="comment">// This also compares the opening / closing numbers, if they are non-zero.</span>
<a name="l01181"></a>01181 
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (!bContentsVerified)
<a name="l01183"></a>01183             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Though the signature verifies, the contract &quot;</span>
<a name="l01184"></a>01184                            <span class="stringliteral">&quot;signed by the party (%s) doesn&#39;t match this contract. (Failed comparison.)\n&quot;</span>,
<a name="l01185"></a>01185                            __FUNCTION__, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     <span class="keywordflow">else</span>
<a name="l01188"></a>01188         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Signature failed to verify for party: %s \n&quot;</span>,
<a name="l01189"></a>01189                        __FUNCTION__, theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01190"></a>01190     <span class="comment">// ----------------------------------------------</span>
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (bHadToLoadItMyself &amp;&amp; bNeedToCleanup)
<a name="l01192"></a>01192         pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a90211a756315e750b9e658bc6a224f0e">ClearTemporaryPointers</a>(); <span class="comment">// We loaded the Nym ourselves, which goes out of scope after this function.</span>
<a name="l01193"></a>01193     <span class="comment">//The party is done with it now, and we don&#39;t want it to keep pointing to something that is now going out of scope.</span>
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     <span class="keywordflow">return</span> bContentsVerified;
<a name="l01196"></a>01196 }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="comment">// Kind of replaces VerifySignature() in certain places. It still verifies signatures inside, but</span>
<a name="l01200"></a>01200 <span class="comment">// OTTrade and OTAgreement have a much simpler way of doing that than OTScriptable/OTSmartContract.</span>
<a name="l01201"></a>01201 <span class="comment">//</span>
<a name="l01202"></a>01202 <span class="comment">// This function also loads its own versions of certain nyms, when necessary, and cleans the pointers</span>
<a name="l01203"></a>01203 <span class="comment">// when it&#39;s done.</span>
<a name="l01204"></a>01204 <span class="comment">//</span>
<a name="l01205"></a><a class="code" href="class_o_t_scriptable.html#a242f30ff4c6deccf285930efa15638eb">01205</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a242f30ff4c6deccf285930efa15638eb">OTScriptable::VerifyNymAsAgent</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l01206"></a>01206                                     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theSignerNym,
<a name="l01207"></a>01207                                     <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a>   * pmap_ALREADY_LOADED<span class="comment">/*=NULL*/</span>)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209     <span class="comment">// (COmmented out) existing trades / payment plans on OT basically just have this one line:</span>
<a name="l01210"></a>01210     <span class="comment">//</span>
<a name="l01211"></a>01211     <span class="comment">// this-&gt;VerifySignature(theNym)</span>
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="comment">// ----------------------------------------------------</span>
<a name="l01214"></a>01214     <span class="comment">// NEW VERSION:</span>
<a name="l01215"></a>01215     <span class="comment">/*</span>
<a name="l01216"></a>01216 <span class="comment">     Proves the original party DOES approve of Nym:</span>
<a name="l01217"></a>01217 <span class="comment"></span>
<a name="l01218"></a>01218 <span class="comment">     1) Lookup the party for this Nym, (loop to see if Nym is listed as an agent by any party.)</span>
<a name="l01219"></a>01219 <span class="comment">     2) If party found, lookup authorizing agent for party, loading him if necessary.</span>
<a name="l01220"></a>01220 <span class="comment">     3) Use authorizing agent to verify signature on original copy of this contract. Each party stores their</span>
<a name="l01221"></a>01221 <span class="comment">        own copy of the agreement, therefore use that copy to verify signature, instead of the current version.</span>
<a name="l01222"></a>01222 <span class="comment"></span>
<a name="l01223"></a>01223 <span class="comment">     This proves that the original authorizing agent for the party that lists Nym as an agent HAS signed the smart contract.</span>
<a name="l01224"></a>01224 <span class="comment">     (As long as that same party OWNS the account, that should be fine.)</span>
<a name="l01225"></a>01225 <span class="comment">     Obviously the best proof is to verify the ORIGINAL version of the contract against the PARTY&#39;S ORIGINAL SIGNED COPY,</span>
<a name="l01226"></a>01226 <span class="comment">     and also to verify them AGAINST EACH OTHER.  The calling function should do this. Otherwise what if the &quot;authorized signer&quot;</span>
<a name="l01227"></a>01227 <span class="comment">     has been changed, and some new guy and signature are substituted? Well, I guess as long as he really is authorized... but</span>
<a name="l01228"></a>01228 <span class="comment">     you simply don&#39;t know what the original agreement really says unless you look at it.  So load it and use it to call THIS METHOD.</span>
<a name="l01229"></a>01229 <span class="comment">     */</span>
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="comment">// (1)</span>
<a name="l01232"></a>01232     <span class="comment">// This step verifies that theNym is at least REGISTERED as a valid agent for the party. (According to the party.)</span>
<a name="l01233"></a>01233     <span class="comment">//</span>
<a name="l01234"></a>01234     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = this-&gt;<a class="code" href="class_o_t_scriptable.html#aa89029542587094cd2844cb8bf7a9a16">FindPartyBasedOnNymAsAgent</a>(theNym);
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l01237"></a>01237     {
<a name="l01238"></a>01238         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Unable to find party based on Nym as agent.\n&quot;</span>);
<a name="l01239"></a>01239         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     <span class="comment">// Below this point, pParty is good.</span>
<a name="l01242"></a>01242     <span class="comment">// --------------------------------------------------</span>
<a name="l01243"></a>01243 
<a name="l01244"></a>01244     <span class="comment">// This party hasn&#39;t signed the contract??</span>
<a name="l01245"></a>01245     <span class="comment">//</span>
<a name="l01246"></a>01246     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01247"></a>01247     {
<a name="l01248"></a>01248         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Unable to find party&#39;s (%s) signed copy of &quot;</span>
<a name="l01249"></a>01249                        <span class="stringliteral">&quot;this contract. Has it been executed?\n&quot;</span>, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01250"></a>01250         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01251"></a>01251     }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253     <span class="comment">// By this point, we know that pParty has a signed copy of the agreement (or of SOMETHING anyway) and we know that</span>
<a name="l01254"></a>01254     <span class="comment">// we were able to find the party based on theNym as one of its agents. But the signature still needs to be verified...</span>
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     <span class="comment">// (2)</span>
<a name="l01257"></a>01257     <span class="comment">// This step verifies that the party has been signed by its authorizing agent. (Who may not be the Nym, yet might be.)</span>
<a name="l01258"></a>01258     <span class="comment">//</span>
<a name="l01259"></a>01259     <a class="code" href="class_o_t_agent.html">OTAgent</a>     * pAuthorizingAgent = NULL;
<a name="l01260"></a>01260     <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pAuthAgentsNym    = NULL;
<a name="l01261"></a>01261     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTPseudonym&gt;</a> theAgentNymAngel;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     <span class="comment">// See if theNym is the authorizing agent.</span>
<a name="l01264"></a>01264     <span class="comment">//</span>
<a name="l01265"></a>01265     <span class="keywordflow">if</span> ((<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#aa34fe1901531ed5056633b99fade0f93">HasAuthorizingAgent</a>(theNym, &amp;pAuthorizingAgent)) &amp;&amp;
<a name="l01266"></a>01266         (NULL  != pmap_ALREADY_LOADED))
<a name="l01267"></a>01267     {
<a name="l01268"></a>01268         <span class="comment">// No? Okay then, let&#39;s see if the authorizing agent is one of these already loaded.</span>
<a name="l01269"></a>01269         <span class="comment">// (So we don&#39;t load it twice.)</span>
<a name="l01270"></a>01270         <span class="comment">//</span>
<a name="l01271"></a>01271         <a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a> &amp; map_Nyms_Already_Loaded = (*pmap_ALREADY_LOADED);
<a name="l01272"></a>01272         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_agent_8hpp.html#ac89892658f6bc83e354078647b704e8f">mapOfNyms</a>, map_Nyms_Already_Loaded)
<a name="l01273"></a>01273         {
<a name="l01274"></a>01274             <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> * pNym = (*it).second;
<a name="l01275"></a>01275             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pNym);
<a name="l01276"></a>01276             <span class="comment">// -----------------------------</span>
<a name="l01277"></a>01277 
<a name="l01278"></a>01278             <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#aa34fe1901531ed5056633b99fade0f93">HasAuthorizingAgent</a>(*pNym, &amp;pAuthorizingAgent))
<a name="l01279"></a>01279             {
<a name="l01280"></a>01280                 pAuthAgentsNym = pNym; <span class="comment">// Just in case.</span>
<a name="l01281"></a>01281                 <span class="keywordflow">break</span>;
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283         }
<a name="l01284"></a>01284         <span class="comment">// if pAuthorizingAgent != NULL, that means the authorizing agent was found among the map of nyms that were already loaded.</span>
<a name="l01285"></a>01285     }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287     <span class="comment">// Still not found?</span>
<a name="l01288"></a>01288     <span class="keywordflow">if</span> (NULL == pAuthorizingAgent)
<a name="l01289"></a>01289     {
<a name="l01290"></a>01290         <span class="comment">// Of all of a party&#39;s Agents, the &quot;authorizing agent&quot; is the one who originally activated</span>
<a name="l01291"></a>01291         <span class="comment">// the agreement for this party (and fronted the opening trans#.) Since we need to verify his</span>
<a name="l01292"></a>01292         <span class="comment">// signature, we have to load him up.</span>
<a name="l01293"></a>01293         <span class="comment">//</span>
<a name="l01294"></a>01294         pAuthAgentsNym = pParty-&gt;<a class="code" href="class_o_t_party.html#a01988fe0bfd917703214f7f7bf3ba66f">LoadAuthorizingAgentNym</a>(theSignerNym, &amp;pAuthorizingAgent);
<a name="l01295"></a>01295 
<a name="l01296"></a>01296         <span class="keywordflow">if</span> (NULL != pAuthAgentsNym) <span class="comment">// success</span>
<a name="l01297"></a>01297         {
<a name="l01298"></a>01298             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAuthorizingAgent); <span class="comment">// This HAS to be set now. I assume it henceforth.</span>
<a name="l01299"></a>01299             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(3, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: I just had to load the authorizing agent&#39;s Nym for a party (%s), &quot;</span>
<a name="l01300"></a>01300                           <span class="stringliteral">&quot;so I guess it wasn&#39;t already available on the list of Nyms that were already loaded.\n&quot;</span>,
<a name="l01301"></a>01301                            pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01302"></a>01302             theAgentNymAngel.<a class="code" href="class_o_t_cleanup.html#a00a399db45f730439d2263d4429d00c1">SetCleanupTarget</a>(*pAuthAgentsNym);  <span class="comment">// CLEANUP!!</span>
<a name="l01303"></a>01303         }
<a name="l01304"></a>01304         <span class="keywordflow">else</span>
<a name="l01305"></a>01305         {
<a name="l01306"></a>01306             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Error: Strange, unable to load authorizing &quot;</span>
<a name="l01307"></a>01307                          <span class="stringliteral">&quot;agent&#39;s Nym for party %s (to verify his signature.)\n&quot;</span>, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01308"></a>01308             pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>();
<a name="l01309"></a>01309             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     <span class="comment">// Below this point, we KNOW that pAuthorizingAgent is a good pointer and will be cleaned up properly/automatically.</span>
<a name="l01314"></a>01314     <span class="comment">// I&#39;m not using pAuthAgentsNym directly, but pAuthorizingAgent WILL use it before this function is done.</span>
<a name="l01315"></a>01315     <span class="comment">// -----------------------------------------</span>
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="comment">// TODO: Verify the opening transaction # here, like I do in VerifyPartyAuthorization() ??  Research first.</span>
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="comment">// (3)</span>
<a name="l01320"></a>01320     <span class="comment">// Here, we use the Authorizing Agent to verify the signature on his party&#39;s version of the contract.</span>
<a name="l01321"></a>01321     <span class="comment">// Notice: Even if the authorizing agent gets fired, we can still load his Nym to verify the original signature on the</span>
<a name="l01322"></a>01322     <span class="comment">// original contract! We should ALWAYS be able to verify our signatures!  Therefore, TODO: When a Nym is DELETED, it&#39;s necessary</span>
<a name="l01323"></a>01323     <span class="comment">// to KEEP the public key on file. We may not have a Nymfile with any request #s or trans# signed out, and there are may be no</span>
<a name="l01324"></a>01324     <span class="comment">// accounts for him, but we still need that public key, for later verification of the signature.</span>
<a name="l01325"></a>01325     <span class="comment">// UNLESS... the public key ITSELF is stashed into the contract... Notice that normal asset contracts already keep the keys inside,</span>
<a name="l01326"></a>01326     <span class="comment">// so why shouldn&#39;t these? In fact I can pop the &quot;key&quot; value onto the contract as part of the &quot;Party-Signing&quot; API call. Just grab the</span>
<a name="l01327"></a>01327     <span class="comment">// public key from each one. Meanwhile the server can verify that it&#39;s actually there, and refuse to process without it!!  Nice.</span>
<a name="l01328"></a>01328     <span class="comment">// This also shows why we need to store the NymID, even if it can be overridden by a Role: because you want to be able to verify</span>
<a name="l01329"></a>01329     <span class="comment">// the original signature, no matter WHO is authorized now. Otherwise your entire contract falls apart.</span>
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pPartySignedCopy = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(pParty-&gt;<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>());
<a name="l01332"></a>01332     <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theCopyAngel;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     <span class="keywordflow">if</span> (NULL == pPartySignedCopy)
<a name="l01335"></a>01335     {
<a name="l01336"></a>01336         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Error loading party&#39;s (%s) signed copy of agreement. Has it been executed?\n&quot;</span>,
<a name="l01337"></a>01337                       pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01338"></a>01338         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>();
<a name="l01339"></a>01339         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01340"></a>01340     }
<a name="l01341"></a>01341     <span class="keywordflow">else</span>
<a name="l01342"></a>01342         theCopyAngel.SetCleanupTarget(*pPartySignedCopy);
<a name="l01343"></a>01343     <span class="comment">// ----------------------------------------------</span>
<a name="l01344"></a>01344 
<a name="l01345"></a>01345     <span class="keyword">const</span> <span class="keywordtype">bool</span> bSigVerified = pAuthorizingAgent-&gt;<a class="code" href="class_o_t_agent.html#a63316db5c765344066a18d87e39cef60">VerifySignature</a>(*pPartySignedCopy);
<a name="l01346"></a>01346     <span class="keywordtype">bool</span> bContentsVerified = <span class="keyword">false</span>;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (bSigVerified)
<a name="l01349"></a>01349     {
<a name="l01350"></a>01350         <span class="comment">// Todo OPTIMIZE: Might move this call to a higher layer, so it gets called MUCH less often but retains the same security.</span>
<a name="l01351"></a>01351         <span class="comment">// There are several places currently in smart contracts like this.</span>
<a name="l01352"></a>01352         <span class="comment">// Need to analyze security aspects before doing it.</span>
<a name="l01353"></a>01353         <span class="comment">//</span>
<a name="l01354"></a>01354         bContentsVerified = this-&gt;<a class="code" href="class_o_t_scriptable.html#aa4735bf6c25261ea1a021fd8afb57916">Compare</a>(*pPartySignedCopy);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356         <span class="keywordflow">if</span> (!bContentsVerified)
<a name="l01357"></a>01357             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Though the signature verifies, the contract &quot;</span>
<a name="l01358"></a>01358                            <span class="stringliteral">&quot;signed by the party (%s) doesn&#39;t match this contract. (Failed comparison.)\n&quot;</span>,
<a name="l01359"></a>01359                            pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     <span class="keywordflow">else</span>
<a name="l01362"></a>01362         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgent: Signature failed to verify for party: %s \n&quot;</span>,
<a name="l01363"></a>01363                        pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     <span class="comment">// Todo: possibly call this-&gt;Compare(*pPartySignedCopy); to make sure there&#39;s no funny business.</span>
<a name="l01367"></a>01367     <span class="comment">// Well actually that HAS to happen anyway, it&#39;s just a question of whether it goes here too, or only somewhere else.</span>
<a name="l01368"></a>01368     <span class="comment">// ----------------------------------------------</span>
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// We loaded a Nym ourselves, which goes out of scope after this function. The party is done</span>
<a name="l01371"></a>01371                                     <span class="comment">// with it now, and we don&#39;t want it to keep pointing to something that is now going out of scope.</span>
<a name="l01372"></a>01372 
<a name="l01373"></a>01373     <span class="keywordflow">return</span> bContentsVerified;
<a name="l01374"></a>01374 }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376 
<a name="l01377"></a>01377 <span class="comment">// Call VerifyPartyAuthorization() first.</span>
<a name="l01378"></a>01378 <span class="comment">// Also, this function, unlike VerifyPartyAuthorization(), is able to ASSUME that ALL</span>
<a name="l01379"></a>01379 <span class="comment">// of the Nyms AND accounts have ALREADY been loaded into memory, AND that *this has</span>
<a name="l01380"></a>01380 <span class="comment">// pointers to them. That is all prepared before this function is called. That is why</span>
<a name="l01381"></a>01381 <span class="comment">// you don&#39;t see me passing in maps to Nyms that are already loaded -- because *this</span>
<a name="l01382"></a>01382 <span class="comment">// already has them all loaded.</span>
<a name="l01383"></a>01383 <span class="comment">//</span>
<a name="l01384"></a>01384 <span class="comment">// This function verifies ownership AND agency of the account, and it</span>
<a name="l01385"></a>01385 <span class="comment">// also handles closing transaction numbers when appropriate.</span>
<a name="l01386"></a>01386 <span class="comment">//</span>
<a name="l01387"></a><a class="code" href="class_o_t_scriptable.html#a1cd358deb75bfc2d39cbba6a4a4799f6">01387</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a1cd358deb75bfc2d39cbba6a4a4799f6">OTScriptable::VerifyPartyAcctAuthorization</a>(<a class="code" href="class_o_t_party_account.html">OTPartyAccount</a>  &amp; thePartyAcct, <span class="comment">// The party is assumed to have been verified already via VerifyPartyAuthorization()</span>
<a name="l01388"></a>01388                                                 <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a>     &amp; theSignerNym, <span class="comment">// For verifying signature on the authorizing Nym.</span>
<a name="l01389"></a>01389                                                 <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  &amp; strServerID, <span class="comment">// For verifying issued num, need the serverID the # goes with.</span>
<a name="l01390"></a>01390                                                 <span class="keyword">const</span> <span class="keywordtype">bool</span>        bBurnTransNo<span class="comment">/*=false*/</span>) <span class="comment">// In OTServer::VerifySmartContract(), it not only wants to verify the closing # is properly issued, but it additionally wants to see that it hasn&#39;t been USED yet -- AND it wants to burn it, so it can&#39;t be used again!  This bool allows you to tell the function whether or not to do that.</span>
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = thePartyAcct.<a class="code" href="class_o_t_party_account.html#a018ef4f5d66227cd23fc6a323db4b669">GetParty</a>();
<a name="l01393"></a>01393 
<a name="l01394"></a>01394     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l01395"></a>01395     {
<a name="l01396"></a>01396         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::%s: Unable to find party for acct: %s \n&quot;</span>,
<a name="l01397"></a>01397                       __FUNCTION__, thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01398"></a>01398         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01399"></a>01399     }
<a name="l01400"></a>01400     <span class="comment">// -----------------------</span>
<a name="l01401"></a>01401     <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAuthorizedAgent = thePartyAcct.<a class="code" href="class_o_t_party_account.html#ad8c523b08a478e4071bb2b3ca85749b1">GetAuthorizedAgent</a>();
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <span class="keywordflow">if</span> (NULL == pAuthorizedAgent)
<a name="l01404"></a>01404     {
<a name="l01405"></a>01405         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: Unable to find authorized agent (%s) for acct: %s \n&quot;</span>,
<a name="l01406"></a>01406                        __FUNCTION__, thePartyAcct.<a class="code" href="class_o_t_party_account.html#a86975046b18ac6d6c5841f5ba0befe69">GetAgentName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01407"></a>01407         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01408"></a>01408     }
<a name="l01409"></a>01409     <span class="comment">// -----------------------</span>
<a name="l01410"></a>01410     <span class="comment">// BELOW THIS POINT, pParty and pAuthorizedAgent are both good pointers.</span>
<a name="l01411"></a>01411     <span class="comment">//</span>
<a name="l01412"></a>01412     <span class="comment">// Next, we need to verify that pParty is the proper OWNER of thePartyAcct..</span>
<a name="l01413"></a>01413     <span class="comment">//</span>
<a name="l01414"></a>01414     <span class="comment">// AND that pAuthorizedAgent really IS authorized to manipulate the actual</span>
<a name="l01415"></a>01415     <span class="comment">// account itself. (Either he is listed as its actual owner, or he is an</span>
<a name="l01416"></a>01416     <span class="comment">// agent for an entity, authorized based on a specific role, and the account</span>
<a name="l01417"></a>01417     <span class="comment">// is owned by that entity / controlled by that role.)</span>
<a name="l01418"></a>01418     <span class="comment">//</span>
<a name="l01419"></a>01419     <span class="comment">// -----------------------</span>
<a name="l01420"></a>01420     <span class="comment">// VERIFY ACCOUNT&#39;s OWNERSHIP BY PARTY</span>
<a name="l01421"></a>01421     <span class="comment">//</span>
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (!thePartyAcct.<a class="code" href="class_o_t_party_account.html#a126d14e990b067acb6a4149ee4639b43">VerifyOwnership</a>())  <span class="comment">// This will use pParty internally.</span>
<a name="l01423"></a>01423     {
<a name="l01424"></a>01424         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: Unable to verify party&#39;s (%s) ownership of acct: %s \n&quot;</span>,
<a name="l01425"></a>01425                       __FUNCTION__, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str(), thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01426"></a>01426         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01427"></a>01427     }
<a name="l01428"></a>01428     <span class="comment">// -----------------------</span>
<a name="l01429"></a>01429     <span class="comment">// VERIFY ACCOUNT&#39;s AUTHORIZED AGENT (that he has rights to manipulate the account itself)</span>
<a name="l01430"></a>01430     <span class="comment">//</span>
<a name="l01431"></a>01431     <span class="keywordflow">if</span> (!thePartyAcct.<a class="code" href="class_o_t_party_account.html#ae1ede2f4ff5e29ab6a46c6fedff21bd3">VerifyAgency</a>()) <span class="comment">// This will use pAuthorizedAgent internally.</span>
<a name="l01432"></a>01432     {
<a name="l01433"></a>01433         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: Unable to verify agent&#39;s (%s) rights re: acct: %s \n&quot;</span>,
<a name="l01434"></a>01434                        __FUNCTION__, pAuthorizedAgent-&gt;<a class="code" href="class_o_t_agent.html#a123d27f05e46977ecdbe0b83de3c119d">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01435"></a>01435         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01436"></a>01436     }
<a name="l01437"></a>01437     <span class="comment">// **************************************************</span>
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="comment">//     Verify the closing number, if he has one. (If this instance is OTScriptable-derived, but NOT OTCronItem-derived,</span>
<a name="l01440"></a>01440     <span class="comment">//     then that means there IS NO closing number, since we&#39;re not even on Cron.) The PartyAccts just happen</span>
<a name="l01441"></a>01441     <span class="comment">//     to store their closing number for the cases where we ARE on Cron, which will probably be most cases.</span>
<a name="l01442"></a>01442     <span class="comment">//     Therefore we CHECK TO SEE if the closing number is NONZERO -- and if so, we VERIFY ISSUED on that #. That way,</span>
<a name="l01443"></a>01443     <span class="comment">//     for cases where this IS a cron item, it will still verify the number (as it should) and in other cases, it will</span>
<a name="l01444"></a>01444     <span class="comment">//     just skip this step.</span>
<a name="l01445"></a>01445     <span class="comment">//</span>
<a name="l01446"></a>01446     <span class="comment">//     Also: If bBurnTransNo is set to true, then it will force this issue, since the code then DEMANDS a number</span>
<a name="l01447"></a>01447     <span class="comment">//     be available for use.</span>
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     <span class="keyword">const</span> int64_t lClosingNo = thePartyAcct.<a class="code" href="class_o_t_party_account.html#add572c3b200be9265d9dcc4a1b1f4185">GetClosingTransNo</a>();
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="keywordflow">if</span> (lClosingNo &gt; 0) <span class="comment">// If one exists, then verify it.</span>
<a name="l01452"></a>01452     {
<a name="l01453"></a>01453         <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAuthorizedAgent-&gt;<a class="code" href="class_o_t_agent.html#aa5175fb8a0a26e3b5cb7ea54ba3c2f7e">VerifyIssuedNumber</a>(lClosingNo, strServerID))
<a name="l01454"></a>01454         {
<a name="l01455"></a>01455             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: Closing trans number %lld doesn&#39;t &quot;</span>
<a name="l01456"></a>01456                            <span class="stringliteral">&quot;verify for the nym listed as the authorized agent for account %s.\n&quot;</span>, __FUNCTION__,
<a name="l01457"></a>01457                            lClosingNo, thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01458"></a>01458             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01459"></a>01459         }
<a name="l01460"></a>01460         <span class="comment">// --------------------------------------</span>
<a name="l01461"></a>01461         <span class="comment">// The caller wants the additional verification that the number hasn&#39;t been USED</span>
<a name="l01462"></a>01462         <span class="comment">// yet -- AND the caller wants you to BURN IT HERE.</span>
<a name="l01463"></a>01463         <span class="comment">//</span>
<a name="l01464"></a>01464         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bBurnTransNo)
<a name="l01465"></a>01465         {
<a name="l01466"></a>01466             <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAuthorizedAgent-&gt;<a class="code" href="class_o_t_agent.html#adb89b362ce9a7100d4bd736d8e54d92a">VerifyTransactionNumber</a>(lClosingNo, strServerID))
<a name="l01467"></a>01467             {
<a name="l01468"></a>01468                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: Closing trans number %lld doesn&#39;t &quot;</span>
<a name="l01469"></a>01469                                <span class="stringliteral">&quot;verify as available for use, for the nym listed as the authorized agent for acct: %s.\n&quot;</span>,
<a name="l01470"></a>01470                                __FUNCTION__, lClosingNo, thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l01471"></a>01471                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01472"></a>01472             }
<a name="l01473"></a>01473             <span class="keywordflow">else</span><span class="comment">// SUCCESS -- It verified as available, so let&#39;s burn it here. (So he can&#39;t use it twice. It remains</span>
<a name="l01474"></a>01474             {   <span class="comment">// issued and open until the cron item is eventually closed out for good.)</span>
<a name="l01475"></a>01475                 <span class="comment">//</span>
<a name="l01476"></a>01476                 <span class="comment">// NOTE: This also adds lClosingNo to the agent&#39;s nym&#39;s GetSetOpenCronItems.</span>
<a name="l01477"></a>01477                 <span class="comment">//</span>
<a name="l01478"></a>01478                 pAuthorizedAgent-&gt;<a class="code" href="class_o_t_agent.html#a6e4e4cc1971996a8da677b1c789a324e">RemoveTransactionNumber</a>(lClosingNo, strServerID, theSignerNym, <span class="keyword">true</span>); <span class="comment">// bSave=true</span>
<a name="l01479"></a>01479             }
<a name="l01480"></a>01480         }
<a name="l01481"></a>01481         <span class="comment">// ---------------------</span>
<a name="l01482"></a>01482     } <span class="comment">// if lClosingNo&gt;0</span>
<a name="l01483"></a>01483     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bBurnTransNo)  <span class="comment">// In this case, bBurnTransNo=true, then the caller EXPECTED to burn a transaction</span>
<a name="l01484"></a>01484     {                       <span class="comment">// num. But the number was 0! Therefore, FAILURE!</span>
<a name="l01485"></a>01485         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::%s: FAILURE. On Acct %s, expected to burn a legitimate closing transaction &quot;</span>
<a name="l01486"></a>01486                        <span class="stringliteral">&quot;number, but got this instead: %lld\n&quot;</span>, __FUNCTION__, thePartyAcct.<a class="code" href="class_o_t_party_account.html#a56b14b8bc2279fab08cc9c2c754043d4">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), lClosingNo);
<a name="l01487"></a>01487         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01488"></a>01488     }
<a name="l01489"></a>01489     <span class="comment">// ----------------------------------------------</span>
<a name="l01490"></a>01490     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01491"></a>01491 }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 <span class="comment">// Wherever you call the below function, you need to call the above function too, and make sure the same</span>
<a name="l01495"></a>01495 <span class="comment">// Party is the one found in both cases.</span>
<a name="l01496"></a>01496 <span class="comment">//</span>
<a name="l01497"></a>01497 <span class="comment">// AGAIN: CALL VerifyNymAsAgent() BEFORE you call this function! Otherwise you aren&#39;t proving nearly as much. ALWAYS call it first.</span>
<a name="l01498"></a>01498 <span class="comment">//</span>
<a name="l01499"></a><a class="code" href="class_o_t_scriptable.html#a844de5b0eb2560a28bf795c2c4da3f3b">01499</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a844de5b0eb2560a28bf795c2c4da3f3b">OTScriptable::VerifyNymAsAgentForAccount</a>(<a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> &amp; theNym,
<a name="l01500"></a>01500                                               <a class="code" href="class_o_t_account.html">OTAccount</a> &amp; theAccount)
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502     <span class="comment">// -------------------------------------------------------------</span>
<a name="l01503"></a>01503     <span class="comment">// Lookup the party via the NYM.</span>
<a name="l01504"></a>01504     <span class="comment">// NOTE: I think without this, the agent never gets its pointer set to Nym.  FYI.</span>
<a name="l01505"></a>01505     <span class="comment">// OTAgent * pAgent = NULL;</span>
<a name="l01506"></a>01506 <span class="comment">//  const   OTParty * pNymParty = this-&gt;FindPartyBasedOnNymAsAgent(theNym, &amp;pAgent);</span>
<a name="l01507"></a>01507 <span class="comment">//</span>
<a name="l01508"></a>01508 <span class="comment">//  if (NULL == pNymParty)</span>
<a name="l01509"></a>01509 <span class="comment">//  {</span>
<a name="l01510"></a>01510 <span class="comment">//      OT_ASSERT(NULL != pAgent);</span>
<a name="l01511"></a>01511 <span class="comment">//      OTLog::Output(0, &quot;OTScriptable::VerifyNymAsAgentForAccount: Unable to find party based on Nym as agent.\n&quot;);</span>
<a name="l01512"></a>01512 <span class="comment">//      return false;</span>
<a name="l01513"></a>01513 <span class="comment">//  }</span>
<a name="l01514"></a>01514     <span class="comment">// Below this point, pAgent is a good pointer.</span>
<a name="l01515"></a>01515     <span class="comment">//</span>
<a name="l01516"></a>01516     <span class="comment">// -------------------------------------------------------------</span>
<a name="l01517"></a>01517     <span class="comment">// Lookup the party via the ACCOUNT.</span>
<a name="l01518"></a>01518     <span class="comment">//</span>
<a name="l01519"></a>01519     <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a>  * pPartyAcct    = NULL;
<a name="l01520"></a>01520     <a class="code" href="class_o_t_party.html">OTParty</a>         * pParty        = this-&gt;<a class="code" href="class_o_t_scriptable.html#adf3ca54a95c8813c23cf7bdc23e4330a">FindPartyBasedOnAccount</a>(theAccount, &amp;pPartyAcct);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     <span class="keywordflow">if</span> (NULL == pParty)
<a name="l01523"></a>01523     {
<a name="l01524"></a>01524         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pPartyAcct);
<a name="l01525"></a>01525         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgentForAccount: Unable to find party based on account.\n&quot;</span>);
<a name="l01526"></a>01526         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01527"></a>01527     }
<a name="l01528"></a>01528     <span class="comment">// pPartyAcct is a good pointer below this point.</span>
<a name="l01529"></a>01529 
<a name="l01530"></a>01530     <span class="comment">// -------------------------------------------------------------</span>
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <span class="comment">// Verify ownership.</span>
<a name="l01533"></a>01533     <span class="comment">//</span>
<a name="l01534"></a>01534     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#a34d26cfe50e7065718c0360b42ca20ef">VerifyOwnershipOfAccount</a>(theAccount))
<a name="l01535"></a>01535     {
<a name="l01536"></a>01536         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgentForAccount: pParty is not the owner of theAccount.\n&quot;</span>);
<a name="l01537"></a>01537         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// Just in case.</span>
<a name="l01538"></a>01538         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01539"></a>01539     }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="comment">// -------------------------------------------------------------</span>
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <span class="keyword">const</span>   std::string str_acct_agent_name = pPartyAcct-&gt;  GetAgentName().Get();
<a name="l01544"></a>01544             <a class="code" href="class_o_t_agent.html">OTAgent</a> *   pAgent              = pParty-&gt;      <a class="code" href="class_o_t_scriptable.html#a8f8c32df22c81d1a5aec3e483089b923">GetAgent</a>(str_acct_agent_name);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546     <span class="comment">// Make sure they are from the SAME PARTY.</span>
<a name="l01547"></a>01547     <span class="comment">//</span>
<a name="l01548"></a>01548     <span class="keywordflow">if</span> (NULL == pAgent)
<a name="l01549"></a>01549     {
<a name="l01550"></a>01550         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgentForAccount: Unable to find the right agent for this account.\n&quot;</span>);
<a name="l01551"></a>01551         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// Just in case.</span>
<a name="l01552"></a>01552         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01553"></a>01553     }
<a name="l01554"></a>01554     <span class="comment">// Below this point, pPartyAcct is a good pointer, and so is pParty, as well as pAgent</span>
<a name="l01555"></a>01555     <span class="comment">// We also know that the agent&#39;s name is the same one that was listed on the account as authorized.</span>
<a name="l01556"></a>01556     <span class="comment">// (Because we used the account&#39;s agent_name to look up pAgent in the first place.)</span>
<a name="l01557"></a>01557     <span class="comment">// -------------------------------------------------------------</span>
<a name="l01558"></a>01558 
<a name="l01559"></a>01559     <span class="comment">// Make sure theNym is a valid signer for pAgent, whether representing himself as in individual, or in a role for an entity.</span>
<a name="l01560"></a>01560     <span class="comment">// This means that pAgent (looked up based on partyAcct&#39;s agent name) will return true to IsValidSigner when passed theNym,</span>
<a name="l01561"></a>01561     <span class="comment">// assuming theNym really is the agent that partyAcct was talking about.</span>
<a name="l01562"></a>01562     <span class="comment">//</span>
<a name="l01563"></a>01563     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAgent-&gt;<a class="code" href="class_o_t_agent.html#a2039e8ad981abeecabf0a3aa412a3a9f">IsValidSigner</a>(theNym))
<a name="l01564"></a>01564     {
<a name="l01565"></a>01565         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgentForAccount: theNym is not a valid signer for pAgent.\n&quot;</span>);
<a name="l01566"></a>01566         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// Just in case.</span>
<a name="l01567"></a>01567         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569     <span class="keywordflow">if</span> (<span class="keyword">false</span> == pAgent-&gt;<a class="code" href="class_o_t_agent.html#a0ebeaa707c5793be4ac3c1a906f89f7c">VerifyAgencyOfAccount</a>(theAccount))
<a name="l01570"></a>01570     {
<a name="l01571"></a>01571         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::VerifyNymAsAgentForAccount: theNym is not a valid agent for theAccount.\n&quot;</span>);
<a name="l01572"></a>01572         pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// Just in case.</span>
<a name="l01573"></a>01573         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01574"></a>01574     }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576 
<a name="l01577"></a>01577 <span class="comment">//  Now we know:</span>
<a name="l01578"></a>01578     <span class="comment">// (1) theNym is agent for pParty,     (according to the party)</span>
<a name="l01579"></a>01579     <span class="comment">// (2) theAccount is owned by pParty   (according to the party)</span>
<a name="l01580"></a>01580     <span class="comment">// (3) theNym is agent for theAccount  (according to the party)</span>
<a name="l01581"></a>01581     <span class="comment">// (4) theNym is valid signer for pAgent</span>
<a name="l01582"></a>01582     <span class="comment">// (5) pParty is the actual OWNER of the account. (According to theAccount.)</span>
<a name="l01583"></a>01583 
<a name="l01584"></a>01584 
<a name="l01585"></a>01585     pParty-&gt;<a class="code" href="class_o_t_party.html#a41a428ded2f0477cf8752648cbe51e4e">ClearTemporaryPointers</a>(); <span class="comment">// Just in case.</span>
<a name="l01586"></a>01586 
<a name="l01587"></a>01587     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01588"></a>01588 }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     <span class="comment">// Normally I&#39;d call this to prove OWNERSHIP and I&#39;d ASSUME AGENCY based on that:</span>
<a name="l01592"></a>01592     <span class="comment">// pSourceAcct-&gt;VerifyOwner(*pSenderNym)</span>
<a name="l01593"></a>01593 
<a name="l01594"></a>01594     <span class="comment">// However, if I&#39;m instead supposed to accept that pSenderNym, while NOT listed as the &quot;Owner&quot; on the</span>
<a name="l01595"></a>01595     <span class="comment">// account itself, is still somehow AUTHORIZED to change it, &quot;because the actual owner says that it&#39;s okay&quot;...</span>
<a name="l01596"></a>01596     <span class="comment">// Well in that case, it&#39;s not good enough unless I prove BOTH ownership AND Agency. I should prove:</span>
<a name="l01597"></a>01597     <span class="comment">// -- the actual owner for the account,</span>
<a name="l01598"></a>01598     <span class="comment">// -- AND is shown to have signed the agreement with his authorizing agent,</span>
<a name="l01599"></a>01599     <span class="comment">// -- AND is shown to have set theNym as his agent, and listed theNym as authorized agent for that account.</span>
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="comment">/*</span>
<a name="l01602"></a>01602 <span class="comment">     Proves the original party DOES approve of Nym managing that account (assuming that VerifyNymAsAgentForAnyParty was called, which</span>
<a name="l01603"></a>01603 <span class="comment">     saves us from having to look up the authorizing agent for the party and verify his signature on the entire contract. We assume the</span>
<a name="l01604"></a>01604 <span class="comment">     contract itself is sound, and we go on to verify its term.)</span>
<a name="l01605"></a>01605 <span class="comment">     Also needs to prove that the ACCOUNT believes itself to be owned by the original party and was signed by the server.</span>
<a name="l01606"></a>01606 <span class="comment">     (If we have proved that ACCOUNT believes itself to be owned by the party, AND that the PARTY believes it has authorized Nym to</span>
<a name="l01607"></a>01607 <span class="comment">     manage that account,</span>
<a name="l01608"></a>01608 <span class="comment">     plus the previous function already proves that Nym is an agent of the PARTY and that the original agreement</span>
<a name="l01609"></a>01609 <span class="comment">     is sound, as signed by the party&#39;s authorizing agent.)</span>
<a name="l01610"></a>01610 <span class="comment"></span>
<a name="l01611"></a>01611 <span class="comment">     AGENCY</span>
<a name="l01612"></a>01612 <span class="comment">     1) Lookup the account from among all the parties. This way we find the party. bool FindPartyBasedOnAccount(theAccount);</span>
<a name="l01613"></a>01613 <span class="comment">     2) Lookup the party based on the Nym as agent, and compare it to make sure they are the SAME PARTY.</span>
<a name="l01614"></a>01614 <span class="comment">     3) Lookup the authorized agent for that account (from that party.) This is different than the authorizing agent in</span>
<a name="l01615"></a>01615 <span class="comment">        the function above, which is who signed to open the contract and fronted the opening trans#. But in THIS case, the authorized</span>
<a name="l01616"></a>01616 <span class="comment">        agent must be available for EACH asset account, and he is the one who supplied the CLOSING number. Each acct has an agent</span>
<a name="l01617"></a>01617 <span class="comment">        name, so lookup that agent from pParty.</span>
<a name="l01618"></a>01618 <span class="comment">     4) Make sure theNym IS that authorized agent. Only THEN do we know that theNym is authorized (as far as the party is concerned.)</span>
<a name="l01619"></a>01619 <span class="comment">        Notice also that we didn&#39;t verify theNym&#39;s signature on anything since he hasn&#39;t actually signed anything on the contract itself.</span>
<a name="l01620"></a>01620 <span class="comment">        Notice that the ONLY REASON THAT WE KNOW FOR SURE is because VerifyNymAsAgent() was called before this function! Because that is</span>
<a name="l01621"></a>01621 <span class="comment">        what loads the original signer and verifies his signature. Unless that was done, we honestly don&#39;t even know this much! So make</span>
<a name="l01622"></a>01622 <span class="comment">        sure you call that function before this one.</span>
<a name="l01623"></a>01623 <span class="comment"></span>
<a name="l01624"></a>01624 <span class="comment">     Assuming we get this far, this means the Party / Smart Contract actually approves of theNym as an Agent, and of theAccount as an</span>
<a name="l01625"></a>01625 <span class="comment">     account, and it also approves that Nym is authorized to manipulate that account.</span>
<a name="l01626"></a>01626 <span class="comment">     But it doesn&#39;t prove who OWNS that account! Nor does it prove, even if the Nym DOES own it, whether theNym actually authorizes</span>
<a name="l01627"></a>01627 <span class="comment">     this action. Therefore we must also prove that the owner of the account (according to the ACCOUNT) is the same party who authorized</span>
<a name="l01628"></a>01628 <span class="comment">     the Nym to manage that account in the smart contract.  (If the Nym IS the party, then he will show as the owner AND agent.)</span>
<a name="l01629"></a>01629 <span class="comment"></span>
<a name="l01630"></a>01630 <span class="comment">     OWNERSHIP</span>
<a name="l01631"></a>01631 <span class="comment">     1) pParty-&gt;VerifyOwnership(theAccount)</span>
<a name="l01632"></a>01632 <span class="comment">     2) If Party owner is a Nym, then call verifyOwner on the account directly with that Nym (just like the old way.)</span>
<a name="l01633"></a>01633 <span class="comment">     3) BUT, if Party owner is an Entity, verify that the entity owns the account.</span>
<a name="l01634"></a>01634 <span class="comment">     4) ALSO: Outside of the smart contract, the same Nym should be able to manipulate that account in this same way, just</span>
<a name="l01635"></a>01635 <span class="comment">        by showing that the account is owned by an entity where that Nym has the RoleID in that entity that appears on the</span>
<a name="l01636"></a>01636 <span class="comment">        account. (Account should have entity AND role).</span>
<a name="l01637"></a>01637 <span class="comment"></span>
<a name="l01638"></a>01638 <span class="comment">     AHH this is the difference between &quot;this Nym may manipulate this account in general, due to his role&quot; vs. &quot;this Nym may</span>
<a name="l01639"></a>01639 <span class="comment">     manipulate this account DUE TO THE AGENCY OF THE ROLE ID stored in the Account.&quot;</span>
<a name="l01640"></a>01640 <span class="comment">     What&#39;s happening is, I&#39;m proving BOTH.  The smart contract, even if you HAVE the role, still restricts you from doing anything</span>
<a name="l01641"></a>01641 <span class="comment">     FROM INSIDE THE SMART CONTRACT (scripts) where that Nym isn&#39;t explicitly set up as the authorized agent for that account. The Nym</span>
<a name="l01642"></a>01642 <span class="comment">     may STILL *normally* be able to mess with that account, if the role is set up that way -- he just can&#39;t do it from inside the script,</span>
<a name="l01643"></a>01643 <span class="comment">     without the additional setup inside the script itself that THIS Nym is the one setup on THIS account.</span>
<a name="l01644"></a>01644 <span class="comment"></span>
<a name="l01645"></a>01645 <span class="comment">     Really though, inside the script itself, the only time a Nym would be set up as the account manager is really if the script</span>
<a name="l01646"></a>01646 <span class="comment">     owner wanted to set the ROLE as the account manager.  I don&#39;t REALLY want to set Frank in charge in the sales budget money.</span>
<a name="l01647"></a>01647 <span class="comment">     Rather, I want to set the SALES DIRECTOR ROLE as being in charge of the sales budget money, and Frank just happens to be in that</span>
<a name="l01648"></a>01648 <span class="comment">     role.  IF I FIRE HIM TOMORROW, AND PUT ANOTHER NYM IN THAT ROLE, THE CONTRACT SHOULD STILL FUNCTION, right? Following that...</span>
<a name="l01649"></a>01649 <span class="comment"></span>
<a name="l01650"></a>01650 <span class="comment">     The account itself will store the EntityID and RoleID.</span>
<a name="l01651"></a>01651 <span class="comment"></span>
<a name="l01652"></a>01652 <span class="comment">     The partyaccount (on the party) only has the &quot;agent name&quot; who deals with that account. (No nym ID so far.)</span>
<a name="l01653"></a>01653 <span class="comment"></span>
<a name="l01654"></a>01654 <span class="comment">     When I lookup the partyaccount, I lookup the authorized agent. At this point, the agent could still be a Role, not a Nym.</span>
<a name="l01655"></a>01655 <span class="comment"></span>
<a name="l01656"></a>01656 <span class="comment">     Therefore when I verify the Nym against the agent, I do it the same way as I might verify a nym against an account. If the</span>
<a name="l01657"></a>01657 <span class="comment">     agent is a nym repping himself, I compare the NymIDs. Else if the agent is an individual in a role, then I  take the Entity that</span>
<a name="l01658"></a>01658 <span class="comment">     owns that agent (the entity is hidden inside the party) and I compare the Nym&#39;s ID to the NymID recorded in the Entity as being</span>
<a name="l01659"></a>01659 <span class="comment">     responsible for that role based on the RoleID stored in the agent. CLearer:  The agent has a RoleID and an Entity ID. The entity</span>
<a name="l01660"></a>01660 <span class="comment">     that owns it has a list of NymIDs, each mapped to a RoleID.  For the account controlled by the agent, if the Nym trying to change</span>
<a name="l01661"></a>01661 <span class="comment">     that account is actually listed in entity EntityID as being assigned role RoleID, where EntityID and RoleID match those in the agent,</span>
<a name="l01662"></a>01662 <span class="comment">     then Nym IS authorized to play with the account. This is verifiable for entities, nyms, and accounts even OUTSIDE of a smart contract,</span>
<a name="l01663"></a>01663 <span class="comment">     and doesn&#39;t rely on the smart contract having the partyaccount/authorized_agent set up. Those are just ADDITIONAL restrictions.</span>
<a name="l01664"></a>01664 <span class="comment">     Thus, Inside a smart contract, OT should enforce those additional restrictions as a layer above the verification of role/owner, etc.</span>
<a name="l01665"></a>01665 <span class="comment"></span>
<a name="l01666"></a>01666 <span class="comment">     OR: Should I make it instead: That you must EITHER have Role-permission, OR smartcontract authorization, and EITHER WAY it allows</span>
<a name="l01667"></a>01667 <span class="comment">     you to manipulate the account?</span>
<a name="l01668"></a>01668 <span class="comment"></span>
<a name="l01669"></a>01669 <span class="comment">     */</span>
<a name="l01670"></a>01670 
<a name="l01671"></a>01671 <span class="comment">// Find the first (and hopefully the only) clause on this scriptable object,</span>
<a name="l01672"></a>01672 <span class="comment">// with a given name. (Searches ALL Bylaws on *this.)</span>
<a name="l01673"></a>01673 <span class="comment">//</span>
<a name="l01674"></a><a class="code" href="class_o_t_scriptable.html#abe36809472a1b7adf66b303ea176888e">01674</a> <a class="code" href="class_o_t_clause.html">OTClause</a> * <a class="code" href="class_o_t_scriptable.html#abe36809472a1b7adf66b303ea176888e">OTScriptable::GetClause</a>(<span class="keyword">const</span> std::string str_clause_name)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_clause_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01677"></a>01677     {
<a name="l01678"></a>01678         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: invalid name.\n&quot;</span>, __FUNCTION__);
<a name="l01679"></a>01679         <span class="keywordflow">return</span> NULL;
<a name="l01680"></a>01680     }
<a name="l01681"></a>01681     <span class="comment">// --------------------------------</span>
<a name="l01682"></a>01682     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l01683"></a>01683     {
<a name="l01684"></a>01684         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l01685"></a>01685         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l01686"></a>01686         <span class="comment">// -------------------------</span>
<a name="l01687"></a>01687         <a class="code" href="class_o_t_clause.html">OTClause</a> * pClause = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a95b30b2c0f6e2944bb3061e0044f48f5">GetClause</a>(str_clause_name);
<a name="l01688"></a>01688 
<a name="l01689"></a>01689         <span class="keywordflow">if</span> (NULL != pClause) <span class="comment">// found it.</span>
<a name="l01690"></a>01690             <span class="keywordflow">return</span> pClause;
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="keywordflow">return</span> NULL;
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 
<a name="l01697"></a><a class="code" href="class_o_t_scriptable.html#a8f8c32df22c81d1a5aec3e483089b923">01697</a> <a class="code" href="class_o_t_agent.html">OTAgent</a> * <a class="code" href="class_o_t_scriptable.html#a8f8c32df22c81d1a5aec3e483089b923">OTScriptable::GetAgent</a>(<span class="keyword">const</span> std::string str_agent_name)
<a name="l01698"></a>01698 {
<a name="l01699"></a>01699     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_agent_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01700"></a>01700     {
<a name="l01701"></a>01701         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: invalid name.\n&quot;</span>, __FUNCTION__);
<a name="l01702"></a>01702         <span class="keywordflow">return</span> NULL;
<a name="l01703"></a>01703     }
<a name="l01704"></a>01704     <span class="comment">// -----------------------------------</span>
<a name="l01705"></a>01705     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l01706"></a>01706     {
<a name="l01707"></a>01707         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l01708"></a>01708         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l01709"></a>01709         <span class="comment">// -------------------------</span>
<a name="l01710"></a>01710         <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent = pParty-&gt;<a class="code" href="class_o_t_party.html#af959cf9f0815a145c5a3072eadfaeb14">GetAgent</a>(str_agent_name);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         <span class="keywordflow">if</span> (NULL != pAgent) <span class="comment">// found it.</span>
<a name="l01713"></a>01713             <span class="keywordflow">return</span> pAgent;
<a name="l01714"></a>01714     }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">return</span> NULL;
<a name="l01717"></a>01717 }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719 
<a name="l01720"></a><a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">01720</a> <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * <a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">OTScriptable::GetBylaw</a>(<span class="keyword">const</span> std::string str_bylaw_name)
<a name="l01721"></a>01721 {
<a name="l01722"></a>01722     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_bylaw_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01723"></a>01723     {
<a name="l01724"></a>01724         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: invalid name.\n&quot;</span>, __FUNCTION__);
<a name="l01725"></a>01725         <span class="keywordflow">return</span> NULL;
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727     <span class="comment">// -----------------------------------------------------------</span>
<a name="l01728"></a>01728     mapOfBylaws::iterator iii = <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.find(str_bylaw_name);
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.end() == iii) <span class="comment">// Did NOT find it.</span>
<a name="l01731"></a>01731     {
<a name="l01732"></a>01732         <span class="comment">// People call this function sometimes just to SEE if one is there.</span>
<a name="l01733"></a>01733         <span class="comment">// So it&#39;s not an error if it&#39;s not there...</span>
<a name="l01734"></a>01734         <span class="comment">//</span>
<a name="l01735"></a>01735 <span class="comment">//      OTLog::vOutput(0, &quot;OTScriptable::GetBylaw: Strange: bylaw not found: %s. Bylaw count is: %d \n&quot;,</span>
<a name="l01736"></a>01736 <span class="comment">//                     str_bylaw_name.c_str(), m_mapBylaws.size());</span>
<a name="l01737"></a>01737         <span class="keywordflow">return</span> NULL;
<a name="l01738"></a>01738     }
<a name="l01739"></a>01739     <span class="comment">// ----------------------------------------</span>
<a name="l01740"></a>01740     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*iii).second;
<a name="l01741"></a>01741     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     <span class="keywordflow">return</span> pBylaw;
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746 
<a name="l01747"></a><a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">01747</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">OTScriptable::GetParty</a>(<span class="keyword">const</span> std::string str_party_name)
<a name="l01748"></a>01748 {
<a name="l01749"></a>01749     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_party_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01750"></a>01750     {
<a name="l01751"></a>01751         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: invalid name.\n&quot;</span>, __FUNCTION__);
<a name="l01752"></a>01752         <span class="keywordflow">return</span> NULL;
<a name="l01753"></a>01753     }
<a name="l01754"></a>01754     <span class="comment">// -----------------------------------------------------------</span>
<a name="l01755"></a>01755     mapOfParties::iterator it = <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.find(str_party_name);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.end() == it) <span class="comment">// Did NOT find it.</span>
<a name="l01758"></a>01758     {
<a name="l01759"></a>01759         <span class="comment">// GetParty() is often called to SEE if a party is there.</span>
<a name="l01760"></a>01760         <span class="comment">// (So if the party ain&#39;t there, it&#39;s not necessarily an error.)</span>
<a name="l01761"></a>01761         <span class="comment">//</span>
<a name="l01762"></a>01762 <span class="comment">//      OTLog::vOutput(0, &quot;OTScriptable::GetParty: Strange: party not found: %s\n&quot;,</span>
<a name="l01763"></a>01763 <span class="comment">//                     str_party_name.c_str());</span>
<a name="l01764"></a>01764         <span class="keywordflow">return</span> NULL;
<a name="l01765"></a>01765     }
<a name="l01766"></a>01766     <span class="comment">// ----------------------------------------</span>
<a name="l01767"></a>01767     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l01768"></a>01768     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="keywordflow">return</span> pParty;
<a name="l01771"></a>01771 }
<a name="l01772"></a>01772 
<a name="l01773"></a>01773 
<a name="l01774"></a><a class="code" href="class_o_t_scriptable.html#a4be857ffbe603f75f1dc5550ed4c20e9">01774</a> <a class="code" href="class_o_t_party.html">OTParty</a> * <a class="code" href="class_o_t_scriptable.html#a4be857ffbe603f75f1dc5550ed4c20e9">OTScriptable::GetPartyByIndex</a>(int32_t nIndex)
<a name="l01775"></a>01775 {
<a name="l01776"></a>01776     <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.size())))
<a name="l01777"></a>01777     {
<a name="l01778"></a>01778         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Index out of bounds: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01779"></a>01779     }
<a name="l01780"></a>01780     <span class="keywordflow">else</span>
<a name="l01781"></a>01781     {
<a name="l01782"></a>01782         <span class="comment">// --------------------------</span>
<a name="l01783"></a>01783         int32_t nLoopIndex = -1; <span class="comment">// will be 0 on first iteration.</span>
<a name="l01784"></a>01784 
<a name="l01785"></a>01785         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l01786"></a>01786         {
<a name="l01787"></a>01787             <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l01788"></a>01788             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l01789"></a>01789             <span class="comment">// ----------------------------</span>
<a name="l01790"></a>01790             ++nLoopIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01791"></a>01791 
<a name="l01792"></a>01792             <span class="keywordflow">if</span> (nLoopIndex == nIndex)
<a name="l01793"></a>01793                 <span class="keywordflow">return</span> pParty;
<a name="l01794"></a>01794         } <span class="comment">// FOR_EACH</span>
<a name="l01795"></a>01795         <span class="comment">// --------------------------</span>
<a name="l01796"></a>01796     }
<a name="l01797"></a>01797     <span class="keywordflow">return</span> NULL;
<a name="l01798"></a>01798 }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800 
<a name="l01801"></a><a class="code" href="class_o_t_scriptable.html#addfadf16de3cfbb972ec73e097a8dc81">01801</a> <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * <a class="code" href="class_o_t_scriptable.html#addfadf16de3cfbb972ec73e097a8dc81">OTScriptable::GetBylawByIndex</a>(int32_t nIndex)
<a name="l01802"></a>01802 {
<a name="l01803"></a>01803     <span class="keywordflow">if</span> ((nIndex &lt; 0) || (nIndex &gt;= static_cast&lt;int64_t&gt;(<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.size())))
<a name="l01804"></a>01804     {
<a name="l01805"></a>01805         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Index out of bounds: %d\n&quot;</span>, __FUNCTION__, nIndex);
<a name="l01806"></a>01806     }
<a name="l01807"></a>01807     <span class="keywordflow">else</span>
<a name="l01808"></a>01808     {
<a name="l01809"></a>01809         <span class="comment">// --------------------------</span>
<a name="l01810"></a>01810         int32_t nLoopIndex = -1; <span class="comment">// will be 0 on first iteration.</span>
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l01813"></a>01813         {
<a name="l01814"></a>01814             <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l01815"></a>01815             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l01816"></a>01816             <span class="comment">// ----------------------------</span>
<a name="l01817"></a>01817             ++nLoopIndex; <span class="comment">// 0 on first iteration.</span>
<a name="l01818"></a>01818 
<a name="l01819"></a>01819             <span class="keywordflow">if</span> (nLoopIndex == nIndex)
<a name="l01820"></a>01820                 <span class="keywordflow">return</span> pBylaw;
<a name="l01821"></a>01821         } <span class="comment">// FOR_EACH</span>
<a name="l01822"></a>01822         <span class="comment">// --------------------------</span>
<a name="l01823"></a>01823     }
<a name="l01824"></a>01824     <span class="keywordflow">return</span> NULL;
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827 
<a name="l01828"></a>01828 <span class="comment">// Verify the contents of THIS contract against signed copies of it that are stored in each Party.</span>
<a name="l01829"></a>01829 <span class="comment">//</span>
<a name="l01830"></a><a class="code" href="class_o_t_scriptable.html#ae83de8305c791c41e58e888cb873def0">01830</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#ae83de8305c791c41e58e888cb873def0">OTScriptable::VerifyThisAgainstAllPartiesSignedCopies</a>()
<a name="l01831"></a>01831 {
<a name="l01832"></a>01832     <span class="keywordtype">bool</span> bReturnVal = (<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.size() &gt; 0) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     <span class="comment">// MAKE SURE ALL SIGNED COPIES ARE OF THE SAME CONTRACT.</span>
<a name="l01835"></a>01835     <span class="comment">// Loop through ALL the parties. For whichever ones are already signed,</span>
<a name="l01836"></a>01836     <span class="comment">// load up the signed copy and make sure it compares to the main one.</span>
<a name="l01837"></a>01837     <span class="comment">// This is in order to make sure that I am signing the same thing that</span>
<a name="l01838"></a>01838     <span class="comment">// everyone else signed, before I actually sign it.</span>
<a name="l01839"></a>01839     <span class="comment">//</span>
<a name="l01840"></a>01840     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l01841"></a>01841     {
<a name="l01842"></a>01842         <span class="keyword">const</span> std::string current_party_name = (*it).first;
<a name="l01843"></a>01843         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty                     = (*it).second;
<a name="l01844"></a>01844         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l01845"></a>01845         <span class="comment">// ---------------</span>
<a name="l01846"></a>01846         <span class="keywordflow">if</span> (pParty-&gt;<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>().<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l01847"></a>01847         {
<a name="l01848"></a>01848             <a class="code" href="class_o_t_scriptable.html">OTScriptable</a> * pPartySignedCopy = <a class="code" href="class_o_t_scriptable.html#a4a89cbc1abd2bac0e5dec64da3452b7a">OTScriptable::InstantiateScriptable</a>(pParty-&gt;<a class="code" href="class_o_t_party.html#a6559c663654d4f9d54628f6116737b47">GetMySignedCopy</a>());
<a name="l01849"></a>01849             <a class="code" href="class_o_t_cleanup.html">OTCleanup&lt;OTScriptable&gt;</a> theCopyAngel;
<a name="l01850"></a>01850 
<a name="l01851"></a>01851             <span class="keywordflow">if</span> (NULL == pPartySignedCopy)
<a name="l01852"></a>01852             {
<a name="l01853"></a>01853                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading party&#39;s (%s) signed copy of agreement. Has it been executed?\n&quot;</span>,
<a name="l01854"></a>01854                               __FUNCTION__, current_party_name.c_str());
<a name="l01855"></a>01855                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01856"></a>01856             }
<a name="l01857"></a>01857             <span class="keywordflow">else</span>
<a name="l01858"></a>01858                 theCopyAngel.SetCleanupTarget(*pPartySignedCopy);
<a name="l01859"></a>01859             <span class="comment">// ----------------------</span>
<a name="l01860"></a>01860             <span class="keywordflow">if</span> ( ! this-&gt;<a class="code" href="class_o_t_scriptable.html#aa4735bf6c25261ea1a021fd8afb57916">Compare</a>(*pPartySignedCopy) )   <span class="comment">// &lt;==== For all signed copies, we compare them to *this.</span>
<a name="l01861"></a>01861             {
<a name="l01862"></a>01862                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Party&#39;s (%s) signed copy of agreement doesn&#39;t match *this.\n&quot;</span>,
<a name="l01863"></a>01863                               __FUNCTION__, current_party_name.c_str());
<a name="l01864"></a>01864                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01865"></a>01865             }
<a name="l01866"></a>01866         }
<a name="l01867"></a>01867         <span class="comment">// else nothing. (We only verify against the ones that are signed.)</span>
<a name="l01868"></a>01868     } <span class="comment">// FOR_EACH</span>
<a name="l01869"></a>01869     <span class="comment">// ---------------</span>
<a name="l01870"></a>01870     <span class="keywordflow">return</span> bReturnVal;
<a name="l01871"></a>01871 }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873 
<a name="l01874"></a>01874 <span class="comment">// Done</span>
<a name="l01875"></a>01875 <span class="comment">// Takes ownership. Client side.</span>
<a name="l01876"></a>01876 <span class="comment">// ONLY works if the party is ALREADY there. Assumes the transaction #s, etc are set up already.</span>
<a name="l01877"></a>01877 <span class="comment">//</span>
<a name="l01878"></a>01878 <span class="comment">// Used once all the actual parties have examined a specific smartcontract and have</span>
<a name="l01879"></a>01879 <span class="comment">// chosen to sign-on to it. This function looks up the theoretical party (such as &quot;trustee&quot;)</span>
<a name="l01880"></a>01880 <span class="comment">// that they are trying to sign on to, compares the two, then replaces the theoretical one</span>
<a name="l01881"></a>01881 <span class="comment">// with the actual one. Then it signs the contract and saves a copy inside the party.</span>
<a name="l01882"></a>01882 <span class="comment">//</span>
<a name="l01883"></a><a class="code" href="class_o_t_scriptable.html#a197539281206ac2e950ff0fc4842886b">01883</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a197539281206ac2e950ff0fc4842886b">OTScriptable::ConfirmParty</a>(<a class="code" href="class_o_t_party.html">OTParty</a> &amp; theParty)
<a name="l01884"></a>01884 {
<a name="l01885"></a>01885     <span class="keyword">const</span> std::string str_party_name = theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>();
<a name="l01886"></a>01886 
<a name="l01887"></a>01887     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_party_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01888"></a>01888     {
<a name="l01889"></a>01889         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::ConfirmParty:  Error: invalid name.\n&quot;</span>);
<a name="l01890"></a>01890         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01891"></a>01891     }
<a name="l01892"></a>01892     <span class="comment">// -----------------------------------------------------------</span>
<a name="l01893"></a>01893     <span class="comment">// MAKE SURE ALL SIGNED COPIES ARE OF THE SAME CONTRACT.</span>
<a name="l01894"></a>01894     <span class="comment">// Loop through ALL the parties. For whichever ones are already signed,</span>
<a name="l01895"></a>01895     <span class="comment">// load up the signed copy and make sure it compares to the main one.</span>
<a name="l01896"></a>01896     <span class="comment">// This is in order to make sure that I am signing the same thing that</span>
<a name="l01897"></a>01897     <span class="comment">// everyone else signed, before I actually sign it.</span>
<a name="l01898"></a>01898     <span class="comment">//</span>
<a name="l01899"></a>01899     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#ae83de8305c791c41e58e888cb873def0">VerifyThisAgainstAllPartiesSignedCopies</a>())
<a name="l01900"></a>01900         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// This already logs on failure.</span>
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     <span class="comment">// BY THIS POINT, we know that, of all the parties who have already signed,</span>
<a name="l01903"></a>01903     <span class="comment">// their signed copies DO match this smart contract.</span>
<a name="l01904"></a>01904     <span class="comment">//</span>
<a name="l01905"></a>01905     <span class="comment">// -----------------------------------------------------------</span>
<a name="l01906"></a>01906     <span class="comment">//</span>
<a name="l01907"></a>01907     <span class="comment">// Next, find the theoretical Party on this scriptable that matches the actual Party that</span>
<a name="l01908"></a>01908     <span class="comment">// was passed in. (It should already be there.) If found, replace it with the one passed in.</span>
<a name="l01909"></a>01909     <span class="comment">// Then sign the contract, save the signed version in the new party, and then sign again.</span>
<a name="l01910"></a>01910     <span class="comment">//</span>
<a name="l01911"></a>01911     <span class="comment">// If NOT found, then we failed. (For trying to confirm a non-existent party.)</span>
<a name="l01912"></a>01912     <span class="comment">//</span>
<a name="l01913"></a>01913     mapOfParties::iterator it_delete = <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.find(str_party_name);
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     <span class="keywordflow">if</span> (it_delete != <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.end()) <span class="comment">// It was already there. (Good.)</span>
<a name="l01916"></a>01916     {
<a name="l01917"></a>01917         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it_delete).second;
<a name="l01918"></a>01918         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l01919"></a>01919         <span class="comment">// -------------------------------</span>
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <span class="keywordflow">if</span> (!pParty-&gt;<a class="code" href="class_o_t_party.html#aea38f73c2145bddc59c900fd887bfd4e">Compare</a>(theParty)) <span class="comment">// Make sure my party compares to the one it&#39;s replacing...</span>
<a name="l01922"></a>01922         {
<a name="l01923"></a>01923             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::ConfirmParty: Party (%s) doesn&#39;t match the one it&#39;s confirming.\n&quot;</span>,
<a name="l01924"></a>01924                            str_party_name.c_str());
<a name="l01925"></a>01925             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01926"></a>01926         }
<a name="l01927"></a>01927         <span class="comment">// else...</span>
<a name="l01928"></a>01928         <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.erase(it_delete);  <span class="comment">// Remove the theoretical party from the map, so we can replace it with the real one.</span>
<a name="l01929"></a>01929         <span class="keyword">delete</span> pParty; pParty=NULL;     <span class="comment">// Delete it, since I own it.</span>
<a name="l01930"></a>01930         <span class="comment">// ------------------------</span>
<a name="l01931"></a>01931         <span class="comment">// Careful:  This ** DOES ** TAKE OWNERSHIP!  theParty will get deleted when</span>
<a name="l01932"></a>01932         <span class="comment">// this OTScriptable instance is.</span>
<a name="l01933"></a>01933         <span class="comment">//</span>
<a name="l01934"></a>01934         <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.insert( std::pair&lt;std::string, OTParty *&gt;(str_party_name, &amp;theParty)) ;
<a name="l01935"></a>01935         theParty.<a class="code" href="class_o_t_party.html#a41f870f87f27213da8f4c2996a3d0bf1">SetOwnerAgreement</a>(*<span class="keyword">this</span>); <span class="comment">// Now the actual party is in place, instead of a placekeeper version of it. There are actual Acct/Nym IDs now, etc.</span>
<a name="l01936"></a>01936         <span class="comment">// ------------------------</span>
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         <span class="comment">// Sign it and save it,</span>
<a name="l01939"></a>01939         <a class="code" href="class_o_t_string.html">OTString</a> strNewSignedCopy;
<a name="l01940"></a>01940         this-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01941"></a>01941         <span class="keywordtype">bool</span> bSuccess = theParty.<a class="code" href="class_o_t_party.html#a4b078e0267983b8da083264f504489e1">SignContract</a>(*<span class="keyword">this</span>);
<a name="l01942"></a>01942         <span class="keywordflow">if</span> (bSuccess)
<a name="l01943"></a>01943         {
<a name="l01944"></a>01944             this-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01945"></a>01945             this-&gt;<a class="code" href="class_o_t_contract.html#a5fd00cded794a6f96ba80d8d4081d591">SaveContractRaw</a>(strNewSignedCopy);
<a name="l01946"></a>01946             <span class="comment">// -----------------------</span>
<a name="l01947"></a>01947             <span class="comment">// then save a copy of it inside theParty,</span>
<a name="l01948"></a>01948             <span class="comment">//</span>
<a name="l01949"></a>01949             theParty.<a class="code" href="class_o_t_party.html#a4a5ec299bde05422462ddcb0a66495d4">SetMySignedCopy</a>(strNewSignedCopy);
<a name="l01950"></a>01950 
<a name="l01951"></a>01951             <span class="comment">// -----------------------</span>
<a name="l01952"></a>01952             <span class="comment">// then sign the overall thing again, so that signed copy (now inside theParty) will be properly saved.</span>
<a name="l01953"></a>01953             <span class="comment">// That way when other people verify my signature, it will be there for them to verify.</span>
<a name="l01954"></a>01954             <span class="comment">//</span>
<a name="l01955"></a>01955             this-&gt;<a class="code" href="class_o_t_contract.html#aae54340526fbd8eb8a18de27a4b97c83">ReleaseSignatures</a>();
<a name="l01956"></a>01956             theParty.<a class="code" href="class_o_t_party.html#a4b078e0267983b8da083264f504489e1">SignContract</a>(*<span class="keyword">this</span>);
<a name="l01957"></a>01957             this-&gt;<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();
<a name="l01958"></a>01958 
<a name="l01959"></a>01959             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01963"></a>01963     }
<a name="l01964"></a>01964     <span class="keywordflow">else</span>
<a name="l01965"></a>01965         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;OTScriptable::ConfirmParty: Failed attempt to confirm non-existent party: %s \n &quot;</span>,
<a name="l01966"></a>01966                       str_party_name.c_str());
<a name="l01967"></a>01967     <span class="comment">// ----------------------------------------</span>
<a name="l01968"></a>01968 
<a name="l01969"></a>01969     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01970"></a>01970 }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 <span class="comment">// ONLY adds it if it&#39;s not already there.</span>
<a name="l01974"></a>01974 <span class="comment">// Used during the design of the smartcontract. (Adding theoretical parties.)</span>
<a name="l01975"></a>01975 <span class="comment">//</span>
<a name="l01976"></a><a class="code" href="class_o_t_scriptable.html#accfde75655f5c49c041ef3a5fbff54e6">01976</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#accfde75655f5c49c041ef3a5fbff54e6">OTScriptable::AddParty</a>(<a class="code" href="class_o_t_party.html">OTParty</a> &amp; theParty)
<a name="l01977"></a>01977 {
<a name="l01978"></a>01978     <span class="keyword">const</span> std::string str_party_name = theParty.<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>();
<a name="l01979"></a>01979 
<a name="l01980"></a>01980     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_party_name)) <span class="comment">// this logs, FYI.</span>
<a name="l01981"></a>01981     {
<a name="l01982"></a>01982         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::AddParty:  Error: invalid name.\n&quot;</span>);
<a name="l01983"></a>01983         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985     <span class="comment">// -----------------------------------------------------------</span>
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.find(str_party_name) == <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.end())
<a name="l01988"></a>01988     {
<a name="l01989"></a>01989         <span class="comment">// Careful:  This ** DOES ** TAKE OWNERSHIP!  theParty will get deleted when this OTScriptable is.</span>
<a name="l01990"></a>01990         <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.insert( std::pair&lt;std::string, OTParty *&gt;(str_party_name, &amp;theParty)) ;
<a name="l01991"></a>01991 
<a name="l01992"></a>01992         theParty.<a class="code" href="class_o_t_party.html#a41f870f87f27213da8f4c2996a3d0bf1">SetOwnerAgreement</a>(*<span class="keyword">this</span>);
<a name="l01993"></a>01993 
<a name="l01994"></a>01994         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01995"></a>01995     }
<a name="l01996"></a>01996     <span class="keywordflow">else</span>
<a name="l01997"></a>01997         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::AddParty: Failed attempt: party already exists on contract.\n &quot;</span>);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999     <span class="comment">// ----------------------------------------</span>
<a name="l02000"></a>02000 
<a name="l02001"></a>02001     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02002"></a>02002 }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004 
<a name="l02005"></a><a class="code" href="class_o_t_scriptable.html#a32d8bccb563ab97e335f457148770c73">02005</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a32d8bccb563ab97e335f457148770c73">OTScriptable::AddBylaw</a>(<a class="code" href="class_o_t_bylaw.html">OTBylaw</a> &amp; theBylaw)
<a name="l02006"></a>02006 {
<a name="l02007"></a>02007     <span class="keyword">const</span> std::string str_name = theBylaw.<a class="code" href="class_o_t_bylaw.html#ad7c410277a99a3abed22249a8dfd8fb7">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02008"></a>02008 
<a name="l02009"></a>02009     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_name)) <span class="comment">// this logs, FYI.</span>
<a name="l02010"></a>02010     {
<a name="l02011"></a>02011         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::AddBylaw:  Error: invalid name.\n&quot;</span>);
<a name="l02012"></a>02012         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02013"></a>02013     }
<a name="l02014"></a>02014     <span class="comment">// -----------------------------------------------------------</span>
<a name="l02015"></a>02015 
<a name="l02016"></a>02016     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.find(str_name) == <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.end())
<a name="l02017"></a>02017     {
<a name="l02018"></a>02018         <span class="comment">// Careful:  This ** DOES ** TAKE OWNERSHIP!  theBylaw will get deleted when this OTScriptable is.</span>
<a name="l02019"></a>02019         <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.insert( std::pair&lt;std::string, OTBylaw *&gt;(str_name, &amp;theBylaw)) ;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021         theBylaw.<a class="code" href="class_o_t_bylaw.html#ad841af7594d0a885a5b35e6e2973d28c">SetOwnerAgreement</a>(*<span class="keyword">this</span>);
<a name="l02022"></a>02022 
<a name="l02023"></a>02023         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02024"></a>02024     }
<a name="l02025"></a>02025     <span class="keywordflow">else</span>
<a name="l02026"></a>02026         <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;OTScriptable::AddBylaw: Failed attempt: bylaw already exists on contract.\n &quot;</span>);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028     <span class="comment">// ----------------------------------------</span>
<a name="l02029"></a>02029 
<a name="l02030"></a>02030     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02031"></a>02031 }
<a name="l02032"></a>02032 
<a name="l02033"></a>02033 
<a name="l02034"></a>02034 <span class="comment">/*</span>
<a name="l02035"></a>02035 <span class="comment"> &lt;party name=“shareholders”</span>
<a name="l02036"></a>02036 <span class="comment"> Owner_Type=“entity”  // ONLY can be “nym” or “entity”.</span>
<a name="l02037"></a>02037 <span class="comment"> Owner_ID=“this” &gt;   // Nym ID or Entity ID. Not known at creation.</span>
<a name="l02038"></a>02038 <span class="comment"></span>
<a name="l02039"></a>02039 <span class="comment"> &lt;agent type=“group”// could be “nym”, or “role”, or “group”.</span>
<a name="l02040"></a>02040 <span class="comment">    Nym_id=“” // In case of “nym”, this is the Nym’s ID. If “role”, this is NymID of employee in role.</span>
<a name="l02041"></a>02041 <span class="comment">    Role_id=“” // In case of “role”, this is the Role’s ID.</span>
<a name="l02042"></a>02042 <span class="comment">    Entity_id=“this” // same as OwnerID if ever used. Should remove.</span>
<a name="l02043"></a>02043 <span class="comment">    Group_ID=“class_A” // “class A shareholders” are the voting group that controls this agent.</span>
<a name="l02044"></a>02044 <span class="comment">    /&gt;</span>
<a name="l02045"></a>02045 <span class="comment"></span>
<a name="l02046"></a>02046 <span class="comment"> &lt;/party&gt;</span>
<a name="l02047"></a>02047 <span class="comment"> */</span>
<a name="l02048"></a>02048 
<a name="l02049"></a><a class="code" href="class_o_t_scriptable.html#aa4735bf6c25261ea1a021fd8afb57916">02049</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#aa4735bf6c25261ea1a021fd8afb57916">OTScriptable::Compare</a>(<a class="code" href="class_o_t_scriptable.html">OTScriptable</a> &amp; rhs)
<a name="l02050"></a>02050 {
<a name="l02051"></a>02051     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTScriptable::Compare&quot;</span>;
<a name="l02052"></a>02052     <span class="comment">//</span>
<a name="l02053"></a>02053     <span class="comment">// UPDATE: ALL of the parties should be there, in terms of their</span>
<a name="l02054"></a>02054     <span class="comment">// names and account names --- but the actual IDs can remain blank,</span>
<a name="l02055"></a>02055     <span class="comment">// and the signed copies can be blank. (Those things are all verified</span>
<a name="l02056"></a>02056     <span class="comment">// elsewhere. That&#39;s about verifying the signature and authorization,</span>
<a name="l02057"></a>02057     <span class="comment">// versus verifying the content.)</span>
<a name="l02058"></a>02058     <span class="comment">//</span>
<a name="l02059"></a>02059     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_o_t_scriptable.html#a862b70e3515a874a4fed101ad4af1a50">GetPartyCount</a>() != rhs.<a class="code" href="class_o_t_scriptable.html#a862b70e3515a874a4fed101ad4af1a50">GetPartyCount</a>())
<a name="l02060"></a>02060     {
<a name="l02061"></a>02061         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The number of parties does not match.\n&quot;</span>, szFunc);
<a name="l02062"></a>02062         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02063"></a>02063     }
<a name="l02064"></a>02064     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_o_t_scriptable.html#a8ceb875e6117eaa14fd02d84e15cb9b3">GetBylawCount</a>() != rhs.<a class="code" href="class_o_t_scriptable.html#a8ceb875e6117eaa14fd02d84e15cb9b3">GetBylawCount</a>())
<a name="l02065"></a>02065     {
<a name="l02066"></a>02066         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: The number of bylaws does not match.\n&quot;</span>, szFunc);
<a name="l02067"></a>02067         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02068"></a>02068     }
<a name="l02069"></a>02069     <span class="comment">// ----------------------------------------</span>
<a name="l02070"></a>02070     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l02071"></a>02071     {
<a name="l02072"></a>02072         <span class="keyword">const</span> std::string str_bylaw_name    = (*it).first;
<a name="l02073"></a>02073         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw                    = (*it).second;
<a name="l02074"></a>02074         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l02075"></a>02075         <span class="comment">// --------------------</span>
<a name="l02076"></a>02076 
<a name="l02077"></a>02077         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * p2 = rhs.<a class="code" href="class_o_t_scriptable.html#a970014fa028541c7a3c908800bfa4ee9">GetBylaw</a>(str_bylaw_name);
<a name="l02078"></a>02078 
<a name="l02079"></a>02079         <span class="keywordflow">if</span> (NULL == p2)
<a name="l02080"></a>02080         {
<a name="l02081"></a>02081             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find bylaw %s on rhs.\n&quot;</span>, szFunc,
<a name="l02082"></a>02082                            str_bylaw_name.c_str());
<a name="l02083"></a>02083             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02084"></a>02084         }
<a name="l02085"></a>02085         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a2337bd8701517a3bf168ac345f9d201c">Compare</a>(*p2) )
<a name="l02086"></a>02086         {
<a name="l02087"></a>02087             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Bylaws don&#39;t match: %s.\n&quot;</span>, szFunc,
<a name="l02088"></a>02088                            str_bylaw_name.c_str());
<a name="l02089"></a>02089             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02090"></a>02090         }
<a name="l02091"></a>02091     }
<a name="l02092"></a>02092     <span class="comment">// ----------------------------------------</span>
<a name="l02093"></a>02093     <a class="code" href="_o_t_storage_8hpp.html#a804eb881e96b7e1846d130a55a94f716">FOR_EACH_CONST</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l02094"></a>02094     {
<a name="l02095"></a>02095         <span class="keyword">const</span> std::string str_party_name    = (*it).first;
<a name="l02096"></a>02096         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty                    = (*it).second;
<a name="l02097"></a>02097         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l02098"></a>02098         <span class="comment">// --------------------</span>
<a name="l02099"></a>02099 
<a name="l02100"></a>02100         <a class="code" href="class_o_t_party.html">OTParty</a> * p2 = rhs.<a class="code" href="class_o_t_scriptable.html#acd0f8e884ed00f1d082fa498323d8894">GetParty</a>(str_party_name);
<a name="l02101"></a>02101 
<a name="l02102"></a>02102         <span class="keywordflow">if</span> (NULL == p2)
<a name="l02103"></a>02103         {
<a name="l02104"></a>02104             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to find party %s on rhs.\n&quot;</span>, szFunc,
<a name="l02105"></a>02105                            str_party_name.c_str());
<a name="l02106"></a>02106             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02107"></a>02107         }
<a name="l02108"></a>02108         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! pParty-&gt;<a class="code" href="class_o_t_party.html#aea38f73c2145bddc59c900fd887bfd4e">Compare</a>(*p2) )
<a name="l02109"></a>02109         {
<a name="l02110"></a>02110             <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Parties don&#39;t match: %s.\n&quot;</span>, szFunc,
<a name="l02111"></a>02111                            str_party_name.c_str());
<a name="l02112"></a>02112             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02113"></a>02113         }
<a name="l02114"></a>02114     }
<a name="l02115"></a>02115     <span class="comment">// ----------------------------</span>
<a name="l02116"></a>02116 
<a name="l02117"></a>02117     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02118"></a>02118 }
<a name="l02119"></a>02119 
<a name="l02120"></a>02120 
<a name="l02121"></a>02121 <span class="comment">// Most contracts calculate their ID by hashing the Raw File (signatures and all).</span>
<a name="l02122"></a>02122 <span class="comment">// The scriptable only hashes the unsigned contents, and only with specific data removed.</span>
<a name="l02123"></a>02123 <span class="comment">// This way, the smart contract will produce a consistent ID even when asset account IDs</span>
<a name="l02124"></a>02124 <span class="comment">// or Nym IDs have been added to it (which would alter the hash of any normal contract</span>
<a name="l02125"></a>02125 <span class="comment">// such as an OTAssetContract.)</span>
<a name="l02126"></a>02126 <span class="comment">//</span>
<a name="l02127"></a><a class="code" href="class_o_t_scriptable.html#ac1c6d838f350141b461420004bb8834b">02127</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#ac1c6d838f350141b461420004bb8834b">OTScriptable::CalculateContractID</a>(<a class="code" href="class_o_t_identifier.html">OTIdentifier</a> &amp; newID)
<a name="l02128"></a>02128 {
<a name="l02129"></a>02129     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strContents(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131     <span class="comment">// Produce a template version of the scriptable.</span>
<a name="l02132"></a>02132     <span class="comment">//</span>
<a name="l02133"></a>02133     <a class="code" href="class_o_t_scriptable.html#a217fc906e2d6475e22913bd8653ffaa2">m_bCalculatingID</a>    = <span class="keyword">true</span>;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <a class="code" href="class_o_t_scriptable.html#accb9d578e3b10cee62e6aba7c178cf62">UpdateContents</a>();  <span class="comment">// &lt;=========</span>
<a name="l02136"></a>02136 
<a name="l02137"></a>02137     newID.<a class="code" href="class_o_t_identifier.html#ac50b356cf5d5d04c08eaf568d07bcc46">CalculateDigest</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);
<a name="l02138"></a>02138 
<a name="l02139"></a>02139     <span class="comment">// Put it back the way it was.</span>
<a name="l02140"></a>02140     <a class="code" href="class_o_t_scriptable.html#a217fc906e2d6475e22913bd8653ffaa2">m_bCalculatingID</a>    = <span class="keyword">false</span>;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142 <span class="comment">//  UpdateContents(); // No need to do this, we already had this string before (above).</span>
<a name="l02143"></a>02143     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a> = strContents; <span class="comment">// Here we just set it back again.</span>
<a name="l02144"></a>02144 }
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 
<a name="l02147"></a>02147 <span class="comment">//bool  m_bCalculatingID; // NOT serialized. Used during ID calculation.</span>
<a name="l02148"></a>02148 <span class="comment">//</span>
<a name="l02149"></a>02149 <span class="comment">//bool  m_bSpecifyAssetID;  // Serialized.</span>
<a name="l02150"></a>02150 <span class="comment">//bool  m_bSpecifyParties;  // Serialized.</span>
<a name="l02151"></a>02151 
<a name="l02152"></a><a class="code" href="class_o_t_scriptable.html#a65ed14652345ef231ad4a3d347d89c3a">02152</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a65ed14652345ef231ad4a3d347d89c3a">OTScriptable::UpdateContentsToString</a>(<a class="code" href="class_o_t_string.html">OTString</a> &amp; strAppend)
<a name="l02153"></a>02153 {
<a name="l02154"></a>02154     <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.size()&gt;0) || (<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.size()&gt;0))
<a name="l02155"></a>02155     {
<a name="l02156"></a>02156         strAppend.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;scriptableContract\n specifyAssetID=\&quot;%s\&quot;\n specifyParties=\&quot;%s\&quot;\n&quot;</span>
<a name="l02157"></a>02157                               <span class="stringliteral">&quot; numParties=\&quot;%d\&quot;\n numBylaws=\&quot;%d\&quot; &gt;\n\n&quot;</span>,
<a name="l02158"></a>02158                               <a class="code" href="class_o_t_scriptable.html#acea6ed68ee05f67a19caa03fcab92b49">m_bSpecifyAssetID</a> ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>, <a class="code" href="class_o_t_scriptable.html#a8e92c7502904b0e3ac00abc672e7f942">m_bSpecifyParties</a> ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>,
<a name="l02159"></a>02159                               <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.size(), <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.size()
<a name="l02160"></a>02160                               );
<a name="l02161"></a>02161 
<a name="l02162"></a>02162         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_party_8hpp.html#a029bc6921acd4516530e26201cf595f2">mapOfParties</a>, <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>)
<a name="l02163"></a>02163         {
<a name="l02164"></a>02164             <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = (*it).second;
<a name="l02165"></a>02165             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l02166"></a>02166 
<a name="l02167"></a>02167             <span class="comment">// Serialization is slightly different depending on whether we are saving</span>
<a name="l02168"></a>02168             <span class="comment">// for real, or just generating a template version of the contract in order</span>
<a name="l02169"></a>02169             <span class="comment">// to generate its ID.</span>
<a name="l02170"></a>02170             <span class="comment">//</span>
<a name="l02171"></a>02171             pParty-&gt;<a class="code" href="class_o_t_party.html#a417d0ab00166c2cd8fe2c07c3c218955">Serialize</a>(strAppend, <a class="code" href="class_o_t_scriptable.html#a217fc906e2d6475e22913bd8653ffaa2">m_bCalculatingID</a>, <a class="code" href="class_o_t_scriptable.html#acea6ed68ee05f67a19caa03fcab92b49">m_bSpecifyAssetID</a>, <a class="code" href="class_o_t_scriptable.html#a8e92c7502904b0e3ac00abc672e7f942">m_bSpecifyParties</a>);
<a name="l02172"></a>02172         }
<a name="l02173"></a>02173 
<a name="l02174"></a>02174         <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l02175"></a>02175         {
<a name="l02176"></a>02176             <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l02177"></a>02177             <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l02178"></a>02178 
<a name="l02179"></a>02179             pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a0221074fd0bcf790ec4c1b92e6aeba80">Serialize</a>(strAppend, <a class="code" href="class_o_t_scriptable.html#a217fc906e2d6475e22913bd8653ffaa2">m_bCalculatingID</a>);
<a name="l02180"></a>02180         }
<a name="l02181"></a>02181 
<a name="l02182"></a>02182         strAppend.<a class="code" href="class_o_t_string.html#a86e54de385040ff6769d7f2149ce176b">Concatenate</a>(<span class="stringliteral">&quot;&lt;/scriptableContract&gt;\n\n&quot;</span>);
<a name="l02183"></a>02183     }
<a name="l02184"></a>02184 }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186 
<a name="l02187"></a><a class="code" href="class_o_t_scriptable.html#accb9d578e3b10cee62e6aba7c178cf62">02187</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#accb9d578e3b10cee62e6aba7c178cf62">OTScriptable::UpdateContents</a>() <span class="comment">// Before transmission or serialization, this is where the contract updates its contents</span>
<a name="l02188"></a>02188 {
<a name="l02189"></a>02189     <span class="comment">// I release this because I&#39;m about to repopulate it.</span>
<a name="l02190"></a>02190     <a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>();
<a name="l02191"></a>02191 
<a name="l02192"></a>02192     <a class="code" href="class_o_t_scriptable.html#a65ed14652345ef231ad4a3d347d89c3a">UpdateContentsToString</a>(<a class="code" href="class_o_t_contract.html#a087fc09cfa4b2fd9076088360a5e5039">m_xmlUnsigned</a>);
<a name="l02193"></a>02193 }
<a name="l02194"></a>02194 
<a name="l02195"></a>02195 
<a name="l02196"></a>02196 <span class="comment">// return -1 if error, 0 if nothing, and 1 if the node was processed.</span>
<a name="l02197"></a><a class="code" href="class_o_t_scriptable.html#a2fe2dd55c1bb910e895c05a6924d08f4">02197</a> int32_t <a class="code" href="class_o_t_scriptable.html#a2fe2dd55c1bb910e895c05a6924d08f4">OTScriptable::ProcessXMLNode</a>(<a class="code" href="namespaceirr_1_1io.html#a1628edbb9d5d53f18c82d2a92b0ad27e">irr::io::IrrXMLReader</a>*&amp; xml)
<a name="l02198"></a>02198 {
<a name="l02199"></a>02199     <span class="keyword">const</span> <span class="keywordtype">char</span> * szFunc = <span class="stringliteral">&quot;OTScriptable::ProcessXMLNode&quot;</span>;
<a name="l02200"></a>02200 
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     int32_t nReturnVal = 0; <span class="comment">// Unless/until I want to add OTContract::Compare(), then people would be able to surreptitiously insert keys and</span>
<a name="l02203"></a>02203 <span class="comment">//  int32_t nReturnVal = ot_super::ProcessXMLNode(xml); // conditions, and entities, that passed OTScriptable::Compare() with flying colors</span>
<a name="l02204"></a>02204 <span class="comment">//  even though they didn&#39;t really match. Therefore, here I explicitly disallow loading those things.</span>
<a name="l02205"></a>02205 
<a name="l02206"></a>02206     <span class="comment">// Here we call the parent class first.</span>
<a name="l02207"></a>02207     <span class="comment">// If the node is found there, or there is some error,</span>
<a name="l02208"></a>02208     <span class="comment">// then we just return either way.  But if it comes back</span>
<a name="l02209"></a>02209     <span class="comment">// as &#39;0&#39;, then nothing happened, and we&#39;ll continue executing.</span>
<a name="l02210"></a>02210     <span class="comment">//</span>
<a name="l02211"></a>02211     <span class="comment">// -- Note: you can choose not to call the parent, if</span>
<a name="l02212"></a>02212     <span class="comment">// you don&#39;t want to use any of those xml tags.</span>
<a name="l02213"></a>02213 
<a name="l02214"></a>02214 <span class="comment">//  if (nReturnVal == 1 || nReturnVal == (-1))</span>
<a name="l02215"></a>02215 <span class="comment">//      return nReturnVal;</span>
<a name="l02216"></a>02216 
<a name="l02217"></a>02217     <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strNodeName(xml-&gt;getNodeName());
<a name="l02218"></a>02218 
<a name="l02219"></a>02219 
<a name="l02220"></a>02220 <span class="comment">//    OTLog::vError(&quot;OTScriptable::ProcessXMLNode:  strNodeName: %s \n&quot;, strNodeName.Get());</span>
<a name="l02221"></a>02221 
<a name="l02222"></a>02222 
<a name="l02223"></a>02223     <span class="keywordflow">if</span> (strNodeName.Compare(<span class="stringliteral">&quot;scriptableContract&quot;</span>))
<a name="l02224"></a>02224     {
<a name="l02225"></a>02225         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSpecify1  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;specifyAssetID&quot;</span>);
<a name="l02226"></a>02226         <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> strSpecify2  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;specifyParties&quot;</span>);
<a name="l02227"></a>02227 
<a name="l02228"></a>02228         <a class="code" href="class_o_t_string.html">OTString</a> strNumParties      = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numParties&quot;</span>);
<a name="l02229"></a>02229         <a class="code" href="class_o_t_string.html">OTString</a> strNumBylaws       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numBylaws&quot;</span>);
<a name="l02230"></a>02230 
<a name="l02231"></a>02231         <span class="comment">// ---------------------------------------</span>
<a name="l02232"></a>02232         <span class="comment">// These determine whether asset IDs and/or party owner IDs</span>
<a name="l02233"></a>02233         <span class="comment">// are used on the template for any given smart contract.</span>
<a name="l02234"></a>02234         <span class="comment">// (Some templates are specific to certain asset types, while</span>
<a name="l02235"></a>02235         <span class="comment">// other smart contract types allow you to leave asset ID blank</span>
<a name="l02236"></a>02236         <span class="comment">// until the confirmation phase.)</span>
<a name="l02237"></a>02237         <span class="comment">//</span>
<a name="l02238"></a>02238         <span class="keywordflow">if</span> (strSpecify1.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>))
<a name="l02239"></a>02239             <a class="code" href="class_o_t_scriptable.html#acea6ed68ee05f67a19caa03fcab92b49">m_bSpecifyAssetID</a> = <span class="keyword">true</span>;
<a name="l02240"></a>02240         <span class="keywordflow">if</span> (strSpecify2.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>))
<a name="l02241"></a>02241             <a class="code" href="class_o_t_scriptable.html#a8e92c7502904b0e3ac00abc672e7f942">m_bSpecifyParties</a> = <span class="keyword">true</span>;
<a name="l02242"></a>02242 
<a name="l02243"></a>02243         <span class="comment">// -----------------------------------------------</span>
<a name="l02244"></a>02244         <span class="comment">//</span>
<a name="l02245"></a>02245         <span class="comment">// Load up the Parties.</span>
<a name="l02246"></a>02246         <span class="comment">//</span>
<a name="l02247"></a>02247         int32_t nPartyCount = strNumParties.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumParties.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02248"></a>02248         <span class="keywordflow">if</span> (nPartyCount &gt; 0)
<a name="l02249"></a>02249         {
<a name="l02250"></a>02250             <span class="keywordflow">while</span> (nPartyCount-- &gt; 0)
<a name="l02251"></a>02251             {
<a name="l02252"></a>02252 <span class="comment">//              xml-&gt;read(); // &lt;==================</span>
<a name="l02253"></a>02253                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">SkipToElement</a>(xml))
<a name="l02254"></a>02254                 {
<a name="l02255"></a>02255                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Unable to find expected element for party. \n&quot;</span>, szFunc);
<a name="l02256"></a>02256                     <span class="keywordflow">return</span> (-1);
<a name="l02257"></a>02257                 }
<a name="l02258"></a>02258                 <span class="comment">// -----------------------------------------------</span>
<a name="l02259"></a>02259 
<a name="l02260"></a>02260 <span class="comment">//                OTLog::vOutput(0, &quot;%s: Looping to load parties: currently on: %s \n&quot;, szFunc, xml-&gt;getNodeName());</span>
<a name="l02261"></a>02261 
<a name="l02262"></a>02262                 <span class="keywordflow">if</span> ((!strcmp(<span class="stringliteral">&quot;party&quot;</span>, xml-&gt;getNodeName())))
<a name="l02263"></a>02263                 {
<a name="l02264"></a>02264                     <a class="code" href="class_o_t_string.html">OTString</a> strName            = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Party name (in script code)</span>
<a name="l02265"></a>02265                     <a class="code" href="class_o_t_string.html">OTString</a> strOwnerType       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;ownerType&quot;</span>); <span class="comment">// &quot;nym&quot; or &quot;entity&quot;</span>
<a name="l02266"></a>02266                     <a class="code" href="class_o_t_string.html">OTString</a> strOwnerID         = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;ownerID&quot;</span>); <span class="comment">// Nym or Entity ID. todo security probably make these separate variables.</span>
<a name="l02267"></a>02267 
<a name="l02268"></a>02268                     <a class="code" href="class_o_t_string.html">OTString</a> strOpeningTransNo  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;openingTransNo&quot;</span>); <span class="comment">// the closing #s are on the asset accounts.</span>
<a name="l02269"></a>02269 
<a name="l02270"></a>02270                     <a class="code" href="class_o_t_string.html">OTString</a> strAuthAgent       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;authorizingAgent&quot;</span>); <span class="comment">// When an agent activates this contract, it&#39;s HIS opening trans# that&#39;s used.</span>
<a name="l02271"></a>02271 
<a name="l02272"></a>02272                     <a class="code" href="class_o_t_string.html">OTString</a> strNumAgents       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numAgents&quot;</span>); <span class="comment">// number of agents on this party.</span>
<a name="l02273"></a>02273                     <a class="code" href="class_o_t_string.html">OTString</a> strNumAccounts     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numAccounts&quot;</span>); <span class="comment">// number of accounts for this party.</span>
<a name="l02274"></a>02274 
<a name="l02275"></a>02275                     <a class="code" href="class_o_t_string.html">OTString</a> strIsCopyProvided  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;signedCopyProvided&quot;</span>);
<a name="l02276"></a>02276 
<a name="l02277"></a>02277                     <span class="comment">// ----------------------------------</span>
<a name="l02278"></a>02278                     <span class="keywordtype">bool</span> bIsCopyProvided = <span class="keyword">false</span>; <span class="comment">// default</span>
<a name="l02279"></a>02279 
<a name="l02280"></a>02280                     <span class="keywordflow">if</span> (strIsCopyProvided.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>))
<a name="l02281"></a>02281                         bIsCopyProvided = <span class="keyword">true</span>;
<a name="l02282"></a>02282 
<a name="l02283"></a>02283                     <span class="comment">// ---------------------------------------</span>
<a name="l02284"></a>02284                     int64_t lOpeningTransNo = 0;
<a name="l02285"></a>02285                     <span class="comment">// -------</span>
<a name="l02286"></a>02286                     <span class="keywordflow">if</span> (strOpeningTransNo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02287"></a>02287                         lOpeningTransNo = atol(strOpeningTransNo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02288"></a>02288                     <span class="keywordflow">else</span>
<a name="l02289"></a>02289                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected openingTransNo in party.\n&quot;</span>, szFunc);
<a name="l02290"></a>02290                     <span class="comment">// ---------------------------------------</span>
<a name="l02291"></a>02291 
<a name="l02292"></a>02292                     <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = <span class="keyword">new</span>  <a class="code" href="class_o_t_party.html">OTParty</a>(strName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>() : <span class="stringliteral">&quot;PARTY_ERROR_NAME&quot;</span>,
<a name="l02293"></a>02293                                                     strOwnerType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;nym&quot;</span>) ? <span class="keyword">true</span> : <span class="keyword">false</span>,
<a name="l02294"></a>02294                                                     strOwnerID.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(),
<a name="l02295"></a>02295                                                     strAuthAgent.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02296"></a>02296                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298                     pParty-&gt;<a class="code" href="class_o_t_party.html#a7f587b2f9dc4305e035057fa252b8fa7">SetOpeningTransNo</a>(lOpeningTransNo); <span class="comment">// WARNING:  NEED TO MAKE SURE pParty IS CLEANED UP BELOW THIS POINT, IF FAILURE!!</span>
<a name="l02299"></a>02299 
<a name="l02300"></a>02300                     <span class="comment">// -----------------------------------------------</span>
<a name="l02301"></a>02301                     <span class="comment">//</span>
<a name="l02302"></a>02302                     <span class="comment">// Load up the agents.</span>
<a name="l02303"></a>02303                     <span class="comment">//</span>
<a name="l02304"></a>02304                     int32_t nAgentCount = strNumAgents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumAgents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02305"></a>02305                     <span class="keywordflow">if</span> (nAgentCount &gt; 0)
<a name="l02306"></a>02306                     {
<a name="l02307"></a>02307                         <span class="keywordflow">while</span> (nAgentCount-- &gt; 0)
<a name="l02308"></a>02308                         {
<a name="l02309"></a>02309 <span class="comment">//                          xml-&gt;read(); // &lt;==================</span>
<a name="l02310"></a>02310                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">SkipToElement</a>(xml))
<a name="l02311"></a>02311                             {
<a name="l02312"></a>02312                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Unable to find expected element for agent. \n&quot;</span>, szFunc);
<a name="l02313"></a>02313                                 <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02314"></a>02314                                 <span class="keywordflow">return</span> (-1);
<a name="l02315"></a>02315                             }
<a name="l02316"></a>02316                             <span class="comment">// -----------------------------------------------</span>
<a name="l02317"></a>02317                             <span class="keywordflow">if</span> ((xml-&gt;getNodeType() == irr::io::EXN_ELEMENT) &amp;&amp; (!strcmp(<span class="stringliteral">&quot;agent&quot;</span>, xml-&gt;getNodeName())))
<a name="l02318"></a>02318                             {
<a name="l02319"></a>02319                                 <a class="code" href="class_o_t_string.html">OTString</a> strAgentName       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Agent name (if needed in script code)</span>
<a name="l02320"></a>02320                                 <a class="code" href="class_o_t_string.html">OTString</a> strAgentRepSelf    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;doesAgentRepresentHimself&quot;</span>); <span class="comment">// Agent might also BE the party, and not just party&#39;s employee.</span>
<a name="l02321"></a>02321                                 <a class="code" href="class_o_t_string.html">OTString</a> strAgentIndividual = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;isAgentAnIndividual&quot;</span>); <span class="comment">// Is the agent a voting group, or an individual nym? (whether employee or not)</span>
<a name="l02322"></a>02322                                 <a class="code" href="class_o_t_string.html">OTString</a> strNymID           = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;nymID&quot;</span>); <span class="comment">// Nym ID if Nym in role for entity, or if representing himself.</span>
<a name="l02323"></a>02323                                 <a class="code" href="class_o_t_string.html">OTString</a> strRoleID          = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;roleID&quot;</span>); <span class="comment">// Role ID if Nym in Role.</span>
<a name="l02324"></a>02324                                 <a class="code" href="class_o_t_string.html">OTString</a> strGroupName       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;groupName&quot;</span>); <span class="comment">// Group name if voting group. (Relative to entity.)</span>
<a name="l02325"></a>02325 
<a name="l02326"></a>02326                                 <span class="comment">// ----------------------------------</span>
<a name="l02327"></a>02327 
<a name="l02328"></a>02328                                 <span class="keywordflow">if</span> (!strAgentName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strAgentRepSelf.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strAgentIndividual.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02329"></a>02329                                 {
<a name="l02330"></a>02330                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading agent: Either the name, or one of the bool variables was EMPTY.\n&quot;</span>, szFunc);
<a name="l02331"></a>02331                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02332"></a>02332                                     <span class="keywordflow">return</span> (-1);
<a name="l02333"></a>02333                                 }
<a name="l02334"></a>02334                                 <span class="comment">// ----------------------------------</span>
<a name="l02335"></a>02335                                 <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(strAgentName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02336"></a>02336                                 {
<a name="l02337"></a>02337                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading agent due to Invalid name: %s\n&quot;</span>, szFunc,
<a name="l02338"></a>02338                                                   strAgentName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02339"></a>02339                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02340"></a>02340                                     <span class="keywordflow">return</span> (-1);
<a name="l02341"></a>02341                                 }
<a name="l02342"></a>02342                                 <span class="comment">// ----------------------------------</span>
<a name="l02343"></a>02343                                 <span class="keywordtype">bool</span> bRepsHimself = <span class="keyword">true</span>; <span class="comment">// default</span>
<a name="l02344"></a>02344 
<a name="l02345"></a>02345                                 <span class="keywordflow">if</span> (strAgentRepSelf.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;false&quot;</span>))
<a name="l02346"></a>02346                                     bRepsHimself = <span class="keyword">false</span>;
<a name="l02347"></a>02347 
<a name="l02348"></a>02348                                 <span class="comment">// ----------------------------------</span>
<a name="l02349"></a>02349                                 <span class="keywordtype">bool</span> bIsIndividual = <span class="keyword">true</span>; <span class="comment">// default</span>
<a name="l02350"></a>02350 
<a name="l02351"></a>02351                                 <span class="keywordflow">if</span> (strAgentIndividual.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;false&quot;</span>))
<a name="l02352"></a>02352                                     bIsIndividual = <span class="keyword">false</span>;
<a name="l02353"></a>02353 
<a name="l02354"></a>02354                                 <span class="comment">// ---------------------------------------</span>
<a name="l02355"></a>02355                                 <span class="comment">// See if the same-named agent already exists on ANY of the OTHER PARTIES</span>
<a name="l02356"></a>02356                                 <span class="comment">// (There can only be one agent on an OTScriptable with a given name.)</span>
<a name="l02357"></a>02357                                 <span class="comment">//</span>
<a name="l02358"></a>02358                                 <a class="code" href="class_o_t_agent.html">OTAgent</a> * pExistingAgent = this-&gt;<a class="code" href="class_o_t_scriptable.html#a8f8c32df22c81d1a5aec3e483089b923">GetAgent</a>(strAgentName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02359"></a>02359 
<a name="l02360"></a>02360                                 <span class="keywordflow">if</span> (NULL != pExistingAgent) <span class="comment">// Uh-oh, it&#39;s already there!</span>
<a name="l02361"></a>02361                                 {
<a name="l02362"></a>02362                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading agent named %s, since one was &quot;</span>
<a name="l02363"></a>02363                                                    <span class="stringliteral">&quot;already there on party %s.\n&quot;</span>, szFunc, strAgentName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02364"></a>02364                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02365"></a>02365                                     <span class="keywordflow">return</span> (-1);
<a name="l02366"></a>02366                                 }
<a name="l02367"></a>02367                                 <span class="comment">// The AddAgent call below checks to see if it&#39;s already there, but only for the</span>
<a name="l02368"></a>02368                                 <span class="comment">// currently-loading party.</span>
<a name="l02369"></a>02369                                 <span class="comment">// Whereas the above GetAgent() call checks this OTScriptable for ALL the agents on the already-loaded parties.</span>
<a name="l02370"></a>02370                                 <span class="comment">// ----------------------------------</span>
<a name="l02371"></a>02371 
<a name="l02372"></a>02372                                 <a class="code" href="class_o_t_agent.html">OTAgent</a> * pAgent =
<a name="l02373"></a>02373                                 <span class="keyword">new</span> <a class="code" href="class_o_t_agent.html">OTAgent</a>(bRepsHimself, bIsIndividual, strAgentName, strNymID, strRoleID, strGroupName);
<a name="l02374"></a>02374                                 <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pAgent);
<a name="l02375"></a>02375 
<a name="l02376"></a>02376                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#a16221b0011a08f0f239ba82741851c0b">AddAgent</a>(*pAgent))
<a name="l02377"></a>02377                                 {
<a name="l02378"></a>02378                                     <span class="keyword">delete</span> pAgent; pAgent = NULL;
<a name="l02379"></a>02379                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02380"></a>02380                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed adding agent to party.\n&quot;</span>, szFunc);
<a name="l02381"></a>02381                                     <span class="keywordflow">return</span> (-1);
<a name="l02382"></a>02382                                 }
<a name="l02383"></a>02383 
<a name="l02384"></a>02384                                 <span class="comment">//                  xml-&gt;read(); // &lt;==================</span>
<a name="l02385"></a>02385 
<a name="l02386"></a>02386                                 <span class="comment">// MIGHT need to add &quot;skip after element&quot; here.</span>
<a name="l02387"></a>02387 
<a name="l02388"></a>02388                                 <span class="comment">// Update: Nope.</span>
<a name="l02389"></a>02389                             }
<a name="l02390"></a>02390                             <span class="keywordflow">else</span>
<a name="l02391"></a>02391                             {
<a name="l02392"></a>02392                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected agent element in party.\n&quot;</span>, szFunc);
<a name="l02393"></a>02393                                 <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02394"></a>02394                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02395"></a>02395                             }
<a name="l02396"></a>02396                         } <span class="comment">// while</span>
<a name="l02397"></a>02397                     }
<a name="l02398"></a>02398                     <span class="comment">// --------------------------------</span>
<a name="l02399"></a>02399                     <span class="comment">//</span>
<a name="l02400"></a>02400                     <span class="comment">// LOAD PARTY ACCOUNTS.</span>
<a name="l02401"></a>02401                     <span class="comment">//</span>
<a name="l02402"></a>02402                     int32_t nAcctCount  = strNumAccounts.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumAccounts.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02403"></a>02403                     <span class="keywordflow">if</span> (nAcctCount &gt; 0)
<a name="l02404"></a>02404                     {
<a name="l02405"></a>02405                         <span class="keywordflow">while</span> (nAcctCount-- &gt; 0)
<a name="l02406"></a>02406                         {
<a name="l02407"></a>02407 <span class="comment">//                          xml-&gt;read(); // &lt;==================</span>
<a name="l02408"></a>02408                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">OTContract::SkipToElement</a>(xml))
<a name="l02409"></a>02409                             {
<a name="l02410"></a>02410                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error finding expected next element for party account.\n&quot;</span>, szFunc);
<a name="l02411"></a>02411                                 <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02412"></a>02412                                 <span class="keywordflow">return</span> (-1);
<a name="l02413"></a>02413                             }
<a name="l02414"></a>02414                             <span class="comment">// -----------------------------------------------</span>
<a name="l02415"></a>02415                             <span class="keywordflow">if</span> ((xml-&gt;getNodeType() == irr::io::EXN_ELEMENT) &amp;&amp; (!strcmp(<span class="stringliteral">&quot;assetAccount&quot;</span>, xml-&gt;getNodeName())))
<a name="l02416"></a>02416                             {
<a name="l02417"></a>02417                                 <a class="code" href="class_o_t_string.html">OTString</a> strAcctName        = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Acct name (if needed in script code)</span>
<a name="l02418"></a>02418                                 <a class="code" href="class_o_t_string.html">OTString</a> strAcctID          = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;acctID&quot;</span>); <span class="comment">// Asset Acct ID</span>
<a name="l02419"></a>02419                                 <a class="code" href="class_o_t_string.html">OTString</a> strAssetTypeID     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;assetTypeID&quot;</span>); <span class="comment">// Asset Type ID</span>
<a name="l02420"></a>02420                                 <a class="code" href="class_o_t_string.html">OTString</a> strAgentName       = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;agentName&quot;</span>); <span class="comment">// Name of agent who controls this account.</span>
<a name="l02421"></a>02421                                 <a class="code" href="class_o_t_string.html">OTString</a> strClosingTransNo  = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;closingTransNo&quot;</span>); <span class="comment">// the closing #s are on the asset accounts.</span>
<a name="l02422"></a>02422 
<a name="l02423"></a>02423                                 int64_t lClosingTransNo = 0;
<a name="l02424"></a>02424                                 <span class="comment">// -------</span>
<a name="l02425"></a>02425                                 <span class="keywordflow">if</span> (strClosingTransNo.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02426"></a>02426                                     lClosingTransNo = atol(strClosingTransNo.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02427"></a>02427                                 <span class="keywordflow">else</span>
<a name="l02428"></a>02428                                 {
<a name="l02429"></a>02429                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected closingTransNo in partyaccount.\n&quot;</span>, szFunc);
<a name="l02430"></a>02430                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02431"></a>02431                                     <span class="keywordflow">return</span> (-1);
<a name="l02432"></a>02432                                 }
<a name="l02433"></a>02433                                 <span class="comment">// ----------------------------------</span>
<a name="l02434"></a>02434 
<a name="l02435"></a>02435                                 <span class="comment">// Missing Account ID is allowed, as well as agent name, since those things may not be decided yet.</span>
<a name="l02436"></a>02436                                 <span class="comment">//</span>
<a name="l02437"></a>02437                                 <span class="keywordflow">if</span> (!strAcctName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || (<a class="code" href="class_o_t_scriptable.html#acea6ed68ee05f67a19caa03fcab92b49">m_bSpecifyAssetID</a> &amp;&amp; !strAssetTypeID.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>()))
<a name="l02438"></a>02438 <span class="comment">//                              if (!strAcctName.Exists() || !strAcctID.Exists() || !strAgentName.Exists() || !strAssetTypeID.Exists())</span>
<a name="l02439"></a>02439                                 {
<a name="l02440"></a>02440                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected missing AcctID or AssetTypeID or Name or AgentName in partyaccount.\n&quot;</span>,
<a name="l02441"></a>02441                                                   szFunc);
<a name="l02442"></a>02442                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02443"></a>02443                                     <span class="keywordflow">return</span> (-1);
<a name="l02444"></a>02444                                 }
<a name="l02445"></a>02445                                 <span class="comment">// ---------------------------------------</span>
<a name="l02446"></a>02446                                 <span class="comment">// See if the same-named partyacct already exists on ANY of the OTHER PARTIES</span>
<a name="l02447"></a>02447                                 <span class="comment">// (There can only be one partyacct on an OTScriptable with a given name.)</span>
<a name="l02448"></a>02448                                 <span class="comment">//</span>
<a name="l02449"></a>02449                                 <a class="code" href="class_o_t_party_account.html">OTPartyAccount</a> * pAcct = this-&gt;<a class="code" href="class_o_t_scriptable.html#a94c9e55f78357e04e4b9781ab662370f">GetPartyAccount</a>(strAcctName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02450"></a>02450 
<a name="l02451"></a>02451                                 <span class="keywordflow">if</span> (NULL != pAcct) <span class="comment">// Uh-oh, it&#39;s already there!</span>
<a name="l02452"></a>02452                                 {
<a name="l02453"></a>02453                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading partyacct named %s, since one was &quot;</span>
<a name="l02454"></a>02454                                                    <span class="stringliteral">&quot;already there on party %s.\n&quot;</span>, szFunc, strAcctName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02455"></a>02455                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02456"></a>02456                                     <span class="keywordflow">return</span> (-1);
<a name="l02457"></a>02457                                 }
<a name="l02458"></a>02458                                 <span class="comment">// The AddAccount call below checks to see if it&#39;s already there, but only for the</span>
<a name="l02459"></a>02459                                 <span class="comment">// currently-loading party.</span>
<a name="l02460"></a>02460                                 <span class="comment">// Whereas the above call checks this OTScriptable for all the accounts on the already-loaded parties.</span>
<a name="l02461"></a>02461                                 <span class="comment">// ----------------------------------</span>
<a name="l02462"></a>02462 
<a name="l02463"></a>02463                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pParty-&gt;<a class="code" href="class_o_t_party.html#a143915bb1a69a404cc35b02f50f0e2d3">AddAccount</a>(strAgentName, strAcctName, strAcctID, strAssetTypeID, lClosingTransNo))
<a name="l02464"></a>02464                                 {
<a name="l02465"></a>02465                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed adding account to party.\n&quot;</span>, szFunc);
<a name="l02466"></a>02466                                     <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02467"></a>02467                                     <span class="keywordflow">return</span> (-1);
<a name="l02468"></a>02468                                 }
<a name="l02469"></a>02469 
<a name="l02470"></a>02470 <span class="comment">//                              xml-&gt;read(); // &lt;==================</span>
<a name="l02471"></a>02471 
<a name="l02472"></a>02472 
<a name="l02473"></a>02473                                 <span class="comment">// MIGHT need to add &quot;skip after field&quot; call here.</span>
<a name="l02474"></a>02474 
<a name="l02475"></a>02475                                 <span class="comment">// UPdate: Nope. Not here.</span>
<a name="l02476"></a>02476 
<a name="l02477"></a>02477                             }
<a name="l02478"></a>02478                             <span class="keywordflow">else</span>
<a name="l02479"></a>02479                             {
<a name="l02480"></a>02480                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected assetAccount element in party.\n&quot;</span>, szFunc);
<a name="l02481"></a>02481                                 <span class="keyword">delete</span> pParty; pParty=NULL;
<a name="l02482"></a>02482                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02483"></a>02483                             }
<a name="l02484"></a>02484                         } <span class="comment">// while</span>
<a name="l02485"></a>02485                     }
<a name="l02486"></a>02486 
<a name="l02487"></a>02487                     <span class="comment">// **************************************</span>
<a name="l02488"></a>02488 
<a name="l02489"></a>02489                     <span class="keywordflow">if</span> (bIsCopyProvided)
<a name="l02490"></a>02490                     {
<a name="l02491"></a>02491                         <span class="keyword">const</span> <span class="keywordtype">char</span>  *   pElementExpected    = <span class="stringliteral">&quot;mySignedCopy&quot;</span>;
<a name="l02492"></a>02492                         <a class="code" href="class_o_t_string.html">OTString</a>        strTextExpected; <span class="comment">// signed copy will go here.</span>
<a name="l02493"></a>02493 
<a name="l02494"></a>02494                         <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#ac374831c4a1fad9d016d39d640a285ac">OTContract::LoadEncodedTextFieldByName</a>(xml, strTextExpected, pElementExpected))
<a name="l02495"></a>02495                         {
<a name="l02496"></a>02496                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: &quot;</span>
<a name="l02497"></a>02497                                           <span class="stringliteral">&quot;Expected %s element with text field.\n&quot;</span>, szFunc,
<a name="l02498"></a>02498                                           pElementExpected);
<a name="l02499"></a>02499                             <span class="keyword">delete</span> pParty; pParty = NULL;
<a name="l02500"></a>02500                             <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02501"></a>02501                         }
<a name="l02502"></a>02502                         <span class="comment">// else ...</span>
<a name="l02503"></a>02503 
<a name="l02504"></a>02504                         pParty-&gt;<a class="code" href="class_o_t_party.html#a4a5ec299bde05422462ddcb0a66495d4">SetMySignedCopy</a>(strTextExpected);
<a name="l02505"></a>02505                     }
<a name="l02506"></a>02506 
<a name="l02507"></a>02507                     <span class="comment">// --------------------------------</span>
<a name="l02508"></a>02508 <span class="comment">//                    if (false == SkipAfterLoadingField(xml))  // &lt;/party&gt;</span>
<a name="l02509"></a>02509 <span class="comment">//                    {</span>
<a name="l02510"></a>02510 <span class="comment">//                        OTLog::vOutput(0, &quot;*** %s: Bad data? Expected EXN_ELEMENT_END here, but &quot;</span>
<a name="l02511"></a>02511 <span class="comment">//                                       &quot;didn&#39;t get it. Failure.\n&quot;, szFunc);</span>
<a name="l02512"></a>02512 <span class="comment">//                        delete pParty; pParty=NULL;</span>
<a name="l02513"></a>02513 <span class="comment">//                        return (-1);</span>
<a name="l02514"></a>02514 <span class="comment">//                    }</span>
<a name="l02515"></a>02515                     <span class="comment">// --------------------------------</span>
<a name="l02516"></a>02516 
<a name="l02517"></a>02517                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#accfde75655f5c49c041ef3a5fbff54e6">AddParty</a>(*pParty))
<a name="l02518"></a>02518                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Loaded Party: %s\n&quot;</span>, szFunc, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l02519"></a>02519                     <span class="keywordflow">else</span>
<a name="l02520"></a>02520                     {
<a name="l02521"></a>02521                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading Party: %s\n&quot;</span>, szFunc, pParty-&gt;<a class="code" href="class_o_t_party.html#ad823a9d89b3d8d0d87bc85114eefcead">GetPartyName</a>().c_str());
<a name="l02522"></a>02522                         <span class="keyword">delete</span> pParty; pParty = NULL;
<a name="l02523"></a>02523                         <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02524"></a>02524                     }
<a name="l02525"></a>02525                 }
<a name="l02526"></a>02526                 <span class="keywordflow">else</span>
<a name="l02527"></a>02527                 {
<a name="l02528"></a>02528                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected party element.\n&quot;</span>, szFunc);
<a name="l02529"></a>02529                     <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02530"></a>02530                 }
<a name="l02531"></a>02531             } <span class="comment">// while</span>
<a name="l02532"></a>02532         }
<a name="l02533"></a>02533 
<a name="l02534"></a>02534         <span class="comment">// -----------------------------------------------</span>
<a name="l02535"></a>02535         <span class="comment">//</span>
<a name="l02536"></a>02536         <span class="comment">// Load up the Bylaws.</span>
<a name="l02537"></a>02537         <span class="comment">//</span>
<a name="l02538"></a>02538         int32_t nBylawCount = strNumBylaws.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumBylaws.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02539"></a>02539         <span class="keywordflow">if</span> (nBylawCount &gt; 0)
<a name="l02540"></a>02540         {
<a name="l02541"></a>02541             <span class="keywordflow">while</span> (nBylawCount-- &gt; 0)
<a name="l02542"></a>02542             {
<a name="l02543"></a>02543 <span class="comment">//              xml-&gt;read(); // &lt;==================</span>
<a name="l02544"></a>02544                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">SkipToElement</a>(xml))
<a name="l02545"></a>02545                 {
<a name="l02546"></a>02546                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Unable to find expected element for bylaw. \n&quot;</span>, szFunc);
<a name="l02547"></a>02547                     <span class="keywordflow">return</span> (-1);
<a name="l02548"></a>02548                 }
<a name="l02549"></a>02549                 <span class="comment">// -----------------------------------------------</span>
<a name="l02550"></a>02550 
<a name="l02551"></a>02551 <span class="comment">//                OTLog::vOutput(0, &quot;%s: Looping to load bylaws: currently on: %s \n&quot;, szFunc, xml-&gt;getNodeName());</span>
<a name="l02552"></a>02552 
<a name="l02553"></a>02553 
<a name="l02554"></a>02554                 <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;bylaw&quot;</span>, xml-&gt;getNodeName()))
<a name="l02555"></a>02555                 {
<a name="l02556"></a>02556                     <a class="code" href="class_o_t_string.html">OTString</a> strName        = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// bylaw name</span>
<a name="l02557"></a>02557                     <a class="code" href="class_o_t_string.html">OTString</a> strLanguage    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;language&quot;</span>); <span class="comment">// The script language used in this bylaw.</span>
<a name="l02558"></a>02558 
<a name="l02559"></a>02559                     <a class="code" href="class_o_t_string.html">OTString</a> strNumVariable     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numVariables&quot;</span>); <span class="comment">// number of variables on this bylaw.</span>
<a name="l02560"></a>02560                     <a class="code" href="class_o_t_string.html">OTString</a> strNumClauses      = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numClauses&quot;</span>); <span class="comment">// number of clauses on this bylaw.</span>
<a name="l02561"></a>02561                     <a class="code" href="class_o_t_string.html">OTString</a> strNumHooks        = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numHooks&quot;</span>); <span class="comment">// hooks to server events.</span>
<a name="l02562"></a>02562                     <a class="code" href="class_o_t_string.html">OTString</a> strNumCallbacks    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;numCallbacks&quot;</span>); <span class="comment">// Callbacks the server may initiate, when it needs answers.</span>
<a name="l02563"></a>02563 
<a name="l02564"></a>02564                     <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = <span class="keyword">new</span> <a class="code" href="class_o_t_bylaw.html">OTBylaw</a>(strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strLanguage.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02565"></a>02565 
<a name="l02566"></a>02566                     <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l02567"></a>02567 
<a name="l02568"></a>02568                     <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l02569"></a>02569                     <span class="comment">//</span>
<a name="l02570"></a>02570                     <span class="comment">// LOAD VARIABLES AND CONSTANTS.</span>
<a name="l02571"></a>02571                     <span class="comment">//</span>
<a name="l02572"></a>02572                     int32_t nCount  = strNumVariable.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumVariable.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02573"></a>02573                     <span class="keywordflow">if</span> (nCount &gt; 0)
<a name="l02574"></a>02574                     {
<a name="l02575"></a>02575                         <span class="keywordflow">while</span> (nCount-- &gt; 0)
<a name="l02576"></a>02576                         {
<a name="l02577"></a>02577 <span class="comment">//                          xml-&gt;read(); // &lt;==================</span>
<a name="l02578"></a>02578                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">OTContract::SkipToElement</a>(xml))
<a name="l02579"></a>02579                             {
<a name="l02580"></a>02580                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error finding expected next element for variable.\n&quot;</span>, szFunc);
<a name="l02581"></a>02581                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02582"></a>02582                                 <span class="keywordflow">return</span> (-1);
<a name="l02583"></a>02583                             }
<a name="l02584"></a>02584                             <span class="comment">// -----------------------------------------------</span>
<a name="l02585"></a>02585                             <span class="keywordflow">if</span> ((xml-&gt;getNodeType() == irr::io::EXN_ELEMENT) &amp;&amp; (!strcmp(<span class="stringliteral">&quot;variable&quot;</span>, xml-&gt;getNodeName())))
<a name="l02586"></a>02586                             {
<a name="l02587"></a>02587                                 <a class="code" href="class_o_t_string.html">OTString</a> strVarName     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Variable name (if needed in script code)</span>
<a name="l02588"></a>02588                                 <a class="code" href="class_o_t_string.html">OTString</a> strVarValue    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;value&quot;</span>); <span class="comment">// Value stored in variable (If this is &quot;true&quot; then a real value is expected in a text field below. Otherwise, it&#39;s assumed to be a BLANK STRING.)</span>
<a name="l02589"></a>02589                                 <a class="code" href="class_o_t_string.html">OTString</a> strVarType     = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;type&quot;</span>); <span class="comment">// string or int64_t</span>
<a name="l02590"></a>02590                                 <a class="code" href="class_o_t_string.html">OTString</a> strVarAccess   = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;access&quot;</span>); <span class="comment">// constant, persistent, or important.</span>
<a name="l02591"></a>02591 
<a name="l02592"></a>02592                                 <span class="comment">// ----------------------------------</span>
<a name="l02593"></a>02593 
<a name="l02594"></a>02594                                 <span class="keywordflow">if</span> (!strVarName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strVarType.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strVarAccess.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02595"></a>02595                                 {
<a name="l02596"></a>02596                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected missing name, type, or access type in variable.\n&quot;</span>, szFunc);
<a name="l02597"></a>02597                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02598"></a>02598                                     <span class="keywordflow">return</span> (-1);
<a name="l02599"></a>02599                                 }
<a name="l02600"></a>02600                                 <span class="comment">// ---------------------------------------</span>
<a name="l02601"></a>02601                                 <span class="comment">// See if the same-named variable already exists on ANY of the OTHER BYLAWS</span>
<a name="l02602"></a>02602                                 <span class="comment">// (There can only be one variable on an OTScriptable with a given name.)</span>
<a name="l02603"></a>02603                                 <span class="comment">//</span>
<a name="l02604"></a>02604                                 <a class="code" href="class_o_t_variable.html">OTVariable</a> * pVar = this-&gt;<a class="code" href="class_o_t_scriptable.html#a3f72637feb6a94088d8a576e29cc6a29">GetVariable</a>(strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02605"></a>02605 
<a name="l02606"></a>02606                                 <span class="keywordflow">if</span> (NULL != pVar) <span class="comment">// Uh-oh, it&#39;s already there!</span>
<a name="l02607"></a>02607                                 {
<a name="l02608"></a>02608                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading variable named %s, since one was &quot;</span>
<a name="l02609"></a>02609                                                    <span class="stringliteral">&quot;already there on one of the bylaws.\n&quot;</span>, szFunc, strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02610"></a>02610                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02611"></a>02611                                     <span class="keywordflow">return</span> (-1);
<a name="l02612"></a>02612                                 }
<a name="l02613"></a>02613                                 <span class="comment">// The AddVariable call below checks to see if it&#39;s already there, but only for the</span>
<a name="l02614"></a>02614                                 <span class="comment">// currently-loading bylaw.</span>
<a name="l02615"></a>02615                                 <span class="comment">// Whereas the above call checks this OTScriptable for all the variables on the already-loaded bylaws.</span>
<a name="l02616"></a>02616                                 <span class="comment">// ----------------------------------</span>
<a name="l02617"></a>02617                                 <span class="comment">//</span>
<a name="l02618"></a>02618                                 <span class="comment">// VARIABLE TYPE AND ACCESS TYPE</span>
<a name="l02619"></a>02619                                 <span class="comment">//</span>
<a name="l02620"></a>02620                                 <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009">OTVariable::OTVariable_Type</a> theVarType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ae4992b1094ef990fbe683f43c7b2a2a8">OTVariable::Var_Error_Type</a>;
<a name="l02621"></a>02621 
<a name="l02622"></a>02622                                 <span class="keywordflow">if</span> (strVarType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;integer&quot;</span>))
<a name="l02623"></a>02623                                     theVarType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ad6ecaa07337c8641bed85deab47c1a1d">OTVariable::Var_Integer</a>;
<a name="l02624"></a>02624                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strVarType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;string&quot;</span>))
<a name="l02625"></a>02625                                     theVarType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a814483713bd6ebb3b01c06378fc60fa7">OTVariable::Var_String</a>;
<a name="l02626"></a>02626                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strVarType.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;bool&quot;</span>))
<a name="l02627"></a>02627                                     theVarType = <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a4f6c0ea25b7a5aed16bc7710389e77da">OTVariable::Var_Bool</a>;
<a name="l02628"></a>02628                                 <span class="keywordflow">else</span>
<a name="l02629"></a>02629                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Bad variable type: %s.\n&quot;</span>, szFunc, strVarType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02630"></a>02630 
<a name="l02631"></a>02631                                 <span class="comment">// ---------</span>
<a name="l02632"></a>02632 
<a name="l02633"></a>02633                                 <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672">OTVariable::OTVariable_Access</a> theVarAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a664538cd758878fab6c2e8718b1839fc">OTVariable::Var_Error_Access</a>;
<a name="l02634"></a>02634 
<a name="l02635"></a>02635                                 <span class="keywordflow">if</span> (strVarAccess.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;constant&quot;</span>))
<a name="l02636"></a>02636                                     theVarAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a3663696326da4cd07edb796beec5c324">OTVariable::Var_Constant</a>;
<a name="l02637"></a>02637                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strVarAccess.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;persistent&quot;</span>))
<a name="l02638"></a>02638                                     theVarAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672ad39bbaff07fae07e5d3dece3789fb03c">OTVariable::Var_Persistent</a>;
<a name="l02639"></a>02639                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strVarAccess.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;important&quot;</span>))
<a name="l02640"></a>02640                                     theVarAccess = <a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a087192fa3f7d345cf2eb413a52fdddc4">OTVariable::Var_Important</a>;
<a name="l02641"></a>02641                                 <span class="keywordflow">else</span>
<a name="l02642"></a>02642                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Bad variable access type: %s.\n&quot;</span>, szFunc, strVarAccess.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02643"></a>02643 
<a name="l02644"></a>02644                                 <span class="comment">// ---------</span>
<a name="l02645"></a>02645 
<a name="l02646"></a>02646                                 <span class="keywordflow">if</span> ((<a class="code" href="class_o_t_variable.html#a649f74cb58ba9ed9aeb8601750c98672a664538cd758878fab6c2e8718b1839fc">OTVariable::Var_Error_Access</a> == theVarAccess) ||
<a name="l02647"></a>02647                                     (<a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ae4992b1094ef990fbe683f43c7b2a2a8">OTVariable::Var_Error_Type</a> == theVarType))
<a name="l02648"></a>02648                                 {
<a name="l02649"></a>02649                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading variable to bylaw: &quot;</span>
<a name="l02650"></a>02650                                                   <span class="stringliteral">&quot;bad type (%s) or access type (%s).\n&quot;</span>,
<a name="l02651"></a>02651                                                   szFunc, strVarType.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strVarAccess.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02652"></a>02652                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02653"></a>02653                                     <span class="keywordflow">return</span> (-1);
<a name="l02654"></a>02654                                 }
<a name="l02655"></a>02655                                 <span class="comment">// ---------------------------------------</span>
<a name="l02656"></a>02656 
<a name="l02657"></a>02657                                 <span class="keywordtype">bool</span> bAddedVar = <span class="keyword">false</span>;
<a name="l02658"></a>02658                                 <span class="keyword">const</span> std::string str_var_name = strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02659"></a>02659 
<a name="l02660"></a>02660                                 <span class="keywordflow">switch</span> (theVarType)
<a name="l02661"></a>02661                                 {
<a name="l02662"></a>02662                                     <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009ad6ecaa07337c8641bed85deab47c1a1d">OTVariable::Var_Integer</a>:
<a name="l02663"></a>02663                                         <span class="keywordflow">if</span> (strVarValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02664"></a>02664                                         {
<a name="l02665"></a>02665                                             <span class="keyword">const</span> int32_t nVarValue = atoi(strVarValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02666"></a>02666                                             bAddedVar = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a87629353941a57f2636d2d10c0d99d57">AddVariable</a>(str_var_name, nVarValue, theVarAccess);
<a name="l02667"></a>02667                                         }
<a name="l02668"></a>02668                                         <span class="keywordflow">else</span>
<a name="l02669"></a>02669                                         {
<a name="l02670"></a>02670                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: No value found for integer variable: %s\n&quot;</span>, szFunc,
<a name="l02671"></a>02671                                                           strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02672"></a>02672                                             <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02673"></a>02673                                             <span class="keywordflow">return</span> (-1);
<a name="l02674"></a>02674                                         }
<a name="l02675"></a>02675                                         <span class="keywordflow">break</span>;
<a name="l02676"></a>02676                                         <span class="comment">// ---------------------------------</span>
<a name="l02677"></a>02677                                     <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a4f6c0ea25b7a5aed16bc7710389e77da">OTVariable::Var_Bool</a>:
<a name="l02678"></a>02678                                         <span class="keywordflow">if</span> (strVarValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02679"></a>02679                                         {
<a name="l02680"></a>02680                                             <span class="keyword">const</span> <span class="keywordtype">bool</span> bVarValue = strVarValue.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;true&quot;</span>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l02681"></a>02681                                             bAddedVar = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a87629353941a57f2636d2d10c0d99d57">AddVariable</a>(str_var_name, bVarValue, theVarAccess);
<a name="l02682"></a>02682                                         }
<a name="l02683"></a>02683                                         <span class="keywordflow">else</span>
<a name="l02684"></a>02684                                         {
<a name="l02685"></a>02685                                             <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: No value found for bool variable: %s\n&quot;</span>, szFunc,
<a name="l02686"></a>02686                                                           strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02687"></a>02687                                             <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02688"></a>02688                                             <span class="keywordflow">return</span> (-1);
<a name="l02689"></a>02689                                         }
<a name="l02690"></a>02690                                         <span class="keywordflow">break</span>;
<a name="l02691"></a>02691                                         <span class="comment">// ---------------------------------</span>
<a name="l02692"></a>02692                                     <span class="keywordflow">case</span> <a class="code" href="class_o_t_variable.html#a368e6a27177cbd9016c4dc40a6c67009a814483713bd6ebb3b01c06378fc60fa7">OTVariable::Var_String</a>:
<a name="l02693"></a>02693                                     {
<a name="l02694"></a>02694                                         <span class="comment">// I realized I should probably allow empty strings.  :-P</span>
<a name="l02695"></a>02695                                         <span class="keywordflow">if</span> (strVarValue.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; strVarValue.<a class="code" href="class_o_t_string.html#a03401b39fb66d63696342c4f61ea8bf5">Compare</a>(<span class="stringliteral">&quot;exists&quot;</span>))
<a name="l02696"></a>02696                                         {
<a name="l02697"></a>02697                                             strVarValue.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); <span class="comment">// probably unnecessary.</span>
<a name="l02698"></a>02698                                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a72ffe11fdcf2f6e3566afa9061241f30">OTContract::LoadEncodedTextField</a>(xml, strVarValue))
<a name="l02699"></a>02699                                             {
<a name="l02700"></a>02700                                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: No value found for string variable: %s\n&quot;</span>, szFunc,
<a name="l02701"></a>02701                                                               strVarName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02702"></a>02702                                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02703"></a>02703                                                 <span class="keywordflow">return</span> (-1);
<a name="l02704"></a>02704                                             }
<a name="l02705"></a>02705                                             <span class="comment">// (else success)</span>
<a name="l02706"></a>02706                                         }
<a name="l02707"></a>02707                                         <span class="keywordflow">else</span>
<a name="l02708"></a>02708                                             strVarValue.<a class="code" href="class_o_t_string.html#abef4b21b2170468705c58d64212d7257">Release</a>(); <span class="comment">// Necessary. If it&#39;s going to be a blank string, then let&#39;s make sure.</span>
<a name="l02709"></a>02709 
<a name="l02710"></a>02710                                         <span class="keyword">const</span> std::string str_var_value = strVarValue.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>();
<a name="l02711"></a>02711                                         bAddedVar = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a87629353941a57f2636d2d10c0d99d57">AddVariable</a>(str_var_name, str_var_value, theVarAccess);
<a name="l02712"></a>02712                                     }
<a name="l02713"></a>02713                                         <span class="keywordflow">break</span>;
<a name="l02714"></a>02714                                     <span class="keywordflow">default</span>:
<a name="l02715"></a>02715                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Wrong variable type... &quot;</span>
<a name="l02716"></a>02716                                                       <span class="stringliteral">&quot;somehow AFTER I should have already detected it...\n&quot;</span>, szFunc);
<a name="l02717"></a>02717                                         <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02718"></a>02718                                         <span class="keywordflow">return</span> (-1);
<a name="l02719"></a>02719                                 }
<a name="l02720"></a>02720                                 <span class="comment">// -------------------------------------------------</span>
<a name="l02721"></a>02721 
<a name="l02722"></a>02722                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == bAddedVar)
<a name="l02723"></a>02723                                 {
<a name="l02724"></a>02724                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed adding variable to bylaw.\n&quot;</span>, szFunc);
<a name="l02725"></a>02725                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02726"></a>02726                                     <span class="keywordflow">return</span> (-1);
<a name="l02727"></a>02727                                 }
<a name="l02728"></a>02728 
<a name="l02729"></a>02729                                 <span class="comment">//                  xml-&gt;read(); // &lt;==================</span>
<a name="l02730"></a>02730 
<a name="l02731"></a>02731                                 <span class="comment">// MIGHT NEED TO HAVE &quot;SKIP AFTER&quot; HERE...</span>
<a name="l02732"></a>02732                                 <span class="comment">// Update: Nope.</span>
<a name="l02733"></a>02733 
<a name="l02734"></a>02734 
<a name="l02735"></a>02735             <span class="comment">//                  if (false == SkipAfterLoadingField(xml))</span>
<a name="l02736"></a>02736             <span class="comment">//                  {</span>
<a name="l02737"></a>02737             <span class="comment">//                      OTLog::Output(0, &quot;*** OTScriptable::ProcessXMLNode: Bad data? Expected EXN_ELEMENT_END here, but &quot;</span>
<a name="l02738"></a>02738             <span class="comment">//                                  &quot;didn&#39;t get it. Failure.\n&quot;);</span>
<a name="l02739"></a>02739             <span class="comment">//                      delete pBylaw; pBylaw=NULL;</span>
<a name="l02740"></a>02740             <span class="comment">//                      return (-1);</span>
<a name="l02741"></a>02741             <span class="comment">//                  }</span>
<a name="l02742"></a>02742                             }
<a name="l02743"></a>02743                             <span class="keywordflow">else</span>
<a name="l02744"></a>02744                             {
<a name="l02745"></a>02745                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected variable element in bylaw.\n&quot;</span>, szFunc);
<a name="l02746"></a>02746                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02747"></a>02747                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02748"></a>02748                             }
<a name="l02749"></a>02749                         } <span class="comment">// while</span>
<a name="l02750"></a>02750                     }
<a name="l02751"></a>02751 
<a name="l02752"></a>02752                     <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l02753"></a>02753                     <span class="comment">// LOAD CLAUSES</span>
<a name="l02754"></a>02754                     <span class="comment">//</span>
<a name="l02755"></a>02755                     nCount  = strNumClauses.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumClauses.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02756"></a>02756                     <span class="keywordflow">if</span> (nCount &gt; 0)
<a name="l02757"></a>02757                     {
<a name="l02758"></a>02758                         <span class="keywordflow">while</span> (nCount-- &gt; 0)
<a name="l02759"></a>02759                         {
<a name="l02760"></a>02760                             <span class="comment">// OTContract::LoadEncodedTextFieldByName() (below) does this stuff already. Commented out.</span>
<a name="l02761"></a>02761                             <span class="comment">//</span>
<a name="l02762"></a>02762             <span class="comment">//              xml-&gt;read(); // &lt;==================</span>
<a name="l02763"></a>02763             <span class="comment">//              if (false == OTContract::SkipToElement(xml))</span>
<a name="l02764"></a>02764             <span class="comment">//              {</span>
<a name="l02765"></a>02765             <span class="comment">//                  OTLog::Error(&quot;OTScriptable::ProcessXMLNode: Error finding expected next element for variable.\n&quot;);</span>
<a name="l02766"></a>02766             <span class="comment">//                  delete pBylaw; pBylaw=NULL;</span>
<a name="l02767"></a>02767             <span class="comment">//                  return (-1);</span>
<a name="l02768"></a>02768             <span class="comment">//              }</span>
<a name="l02769"></a>02769                             <span class="comment">// -----------------------------------------------</span>
<a name="l02770"></a>02770 
<a name="l02771"></a>02771                             <span class="keyword">const</span> <span class="keywordtype">char</span>  *   pElementExpected    = <span class="stringliteral">&quot;clause&quot;</span>;
<a name="l02772"></a>02772                             <a class="code" href="class_o_t_string.html">OTString</a>        strTextExpected; <span class="comment">// clause&#39;s script code will go here.</span>
<a name="l02773"></a>02773 
<a name="l02774"></a>02774                             <a class="code" href="_o_t_string_8hpp.html#a7ec7839682b097a5c5b5c5125046c82b">mapOfStrings</a>    temp_MapAttributes;
<a name="l02775"></a>02775                             <span class="comment">//</span>
<a name="l02776"></a>02776                             <span class="comment">// This map contains values we will also want, when we read the clause...</span>
<a name="l02777"></a>02777                             <span class="comment">// (The OTContract::LoadEncodedTextField call below will read all the values</span>
<a name="l02778"></a>02778                             <span class="comment">// as specified in this map.)</span>
<a name="l02779"></a>02779                             <span class="comment">//</span>
<a name="l02780"></a>02780                             <span class="comment">//</span>
<a name="l02781"></a>02781                             temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(<span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l02782"></a>02782             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));   // Grab the others this way as well.</span>
<a name="l02783"></a>02783             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));</span>
<a name="l02784"></a>02784             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));</span>
<a name="l02785"></a>02785             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));</span>
<a name="l02786"></a>02786             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));</span>
<a name="l02787"></a>02787             <span class="comment">//              temp_MapAttributes.insert(std::pair&lt;std::string, std::string&gt;(&quot;name&quot;, &quot;&quot;));</span>
<a name="l02788"></a>02788 
<a name="l02789"></a>02789                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#ac374831c4a1fad9d016d39d640a285ac">OTContract::LoadEncodedTextFieldByName</a>(xml, strTextExpected, pElementExpected, &amp;temp_MapAttributes)) <span class="comment">// &lt;/clause&gt;</span>
<a name="l02790"></a>02790                             {
<a name="l02791"></a>02791                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error: &quot;</span>
<a name="l02792"></a>02792                                               <span class="stringliteral">&quot;Expected %s element with text field.\n&quot;</span>, szFunc,
<a name="l02793"></a>02793                                               pElementExpected);
<a name="l02794"></a>02794                                 <span class="keyword">delete</span> pBylaw; pBylaw = NULL;
<a name="l02795"></a>02795                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02796"></a>02796                             }
<a name="l02797"></a>02797 
<a name="l02798"></a>02798                             <span class="comment">// Okay we now have the script code in strTextExpected. Next, let&#39;s read the clause&#39;s NAME</span>
<a name="l02799"></a>02799                             <span class="comment">// from the map. If it&#39;s there, and presumably some kind of harsh validation for both, then</span>
<a name="l02800"></a>02800                             <span class="comment">// create a clause object and add to my list here.</span>
<a name="l02801"></a>02801                             <span class="comment">// ------------------------------------------</span>
<a name="l02802"></a>02802 
<a name="l02803"></a>02803                             mapOfStrings::iterator it = temp_MapAttributes.find(<span class="stringliteral">&quot;name&quot;</span>);
<a name="l02804"></a>02804 
<a name="l02805"></a>02805                             <span class="keywordflow">if</span> ((it != temp_MapAttributes.end())) <span class="comment">// We expected this much.</span>
<a name="l02806"></a>02806                             {
<a name="l02807"></a>02807                                 std::string &amp; str_name = (*it).second;
<a name="l02808"></a>02808 
<a name="l02809"></a>02809                                 <span class="keywordflow">if</span> (str_name.size() &gt; 0) <span class="comment">// SUCCESS</span>
<a name="l02810"></a>02810                                 {
<a name="l02811"></a>02811                                     <span class="comment">// ---------------------------------------</span>
<a name="l02812"></a>02812 
<a name="l02813"></a>02813             <span class="comment">//                      if (false == SkipAfterLoadingField(xml))  // NOt sure yet about this block....</span>
<a name="l02814"></a>02814             <span class="comment">//                      {</span>
<a name="l02815"></a>02815             <span class="comment">//                          OTLog::Output(0, &quot;*** OTScriptable::ProcessXMLNode: Bad data? Expected EXN_ELEMENT_END here, but &quot;</span>
<a name="l02816"></a>02816             <span class="comment">//                                        &quot;didn&#39;t get it. Failure.\n&quot;);</span>
<a name="l02817"></a>02817             <span class="comment">//                          delete pBylaw; pBylaw=NULL;</span>
<a name="l02818"></a>02818             <span class="comment">//                          return (-1);</span>
<a name="l02819"></a>02819             <span class="comment">//                      }</span>
<a name="l02820"></a>02820                                     <span class="comment">// *****************************************************</span>
<a name="l02821"></a>02821 
<a name="l02822"></a>02822                                     <span class="comment">// See if the same-named clause already exists on ANY of the OTHER BYLAWS</span>
<a name="l02823"></a>02823                                     <span class="comment">// (There can only be one clause on an OTScriptable with a given name.)</span>
<a name="l02824"></a>02824                                     <span class="comment">//</span>
<a name="l02825"></a>02825                                     <a class="code" href="class_o_t_clause.html">OTClause</a> * pClause = this-&gt;<a class="code" href="class_o_t_scriptable.html#abe36809472a1b7adf66b303ea176888e">GetClause</a>(str_name.c_str());
<a name="l02826"></a>02826 
<a name="l02827"></a>02827                                     <span class="keywordflow">if</span> (NULL != pClause) <span class="comment">// Uh-oh, it&#39;s already there!</span>
<a name="l02828"></a>02828                                     {
<a name="l02829"></a>02829                                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading clause named %s, since one was already &quot;</span>
<a name="l02830"></a>02830                                                        <span class="stringliteral">&quot;there on one of the bylaws.\n&quot;</span>, szFunc, str_name.c_str());
<a name="l02831"></a>02831                                         <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02832"></a>02832                                         <span class="keywordflow">return</span> (-1);
<a name="l02833"></a>02833                                     }
<a name="l02834"></a>02834                                     <span class="comment">// ---------------------------------------------------------</span>
<a name="l02835"></a>02835                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a389b9d1cb6053622e37213304155a998">AddClause</a>(str_name.c_str(),
<a name="l02836"></a>02836                                                                         strTextExpected.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02837"></a>02837                                     {
<a name="l02838"></a>02838                                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed adding clause to bylaw.\n&quot;</span>, szFunc);
<a name="l02839"></a>02839                                         <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02840"></a>02840                                         <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02841"></a>02841                                     }
<a name="l02842"></a>02842                                 }
<a name="l02843"></a>02843                                 <span class="comment">// else it&#39;s empty, which is expected if nothing was there, since that&#39;s the default value</span>
<a name="l02844"></a>02844                                 <span class="comment">// that we set above for &quot;name&quot; in temp_MapAttributes.</span>
<a name="l02845"></a>02845                                 <span class="keywordflow">else</span>
<a name="l02846"></a>02846                                 {
<a name="l02847"></a>02847                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected clause name.\n&quot;</span>, szFunc);
<a name="l02848"></a>02848                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02849"></a>02849                                     <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02850"></a>02850                                 }
<a name="l02851"></a>02851                             }
<a name="l02852"></a>02852                             <span class="keywordflow">else</span>
<a name="l02853"></a>02853                             {
<a name="l02854"></a>02854                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Strange error: couldn&#39;t find name AT ALL.\n&quot;</span>, szFunc);
<a name="l02855"></a>02855                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02856"></a>02856                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02857"></a>02857                             }
<a name="l02858"></a>02858                         } <span class="comment">// while</span>
<a name="l02859"></a>02859                     } <span class="comment">// if strNumClauses.Exists() &amp;&amp; nCount &gt; 0</span>
<a name="l02860"></a>02860 
<a name="l02861"></a>02861 
<a name="l02862"></a>02862                     <span class="comment">// ---------------------------------------------------------------------------</span>
<a name="l02863"></a>02863                     <span class="comment">//</span>
<a name="l02864"></a>02864                     <span class="comment">// LOAD HOOKS.</span>
<a name="l02865"></a>02865                     <span class="comment">//</span>
<a name="l02866"></a>02866                     nCount  = strNumHooks.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumHooks.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02867"></a>02867                     <span class="keywordflow">if</span> (nCount &gt; 0)
<a name="l02868"></a>02868                     {
<a name="l02869"></a>02869                         <span class="keywordflow">while</span> (nCount-- &gt; 0)
<a name="l02870"></a>02870                         {
<a name="l02871"></a>02871 <span class="comment">//                          xml-&gt;read();</span>
<a name="l02872"></a>02872                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">SkipToElement</a>(xml))
<a name="l02873"></a>02873                             {
<a name="l02874"></a>02874                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Unable to find expected element.\n&quot;</span>, szFunc);
<a name="l02875"></a>02875                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02876"></a>02876                                 <span class="keywordflow">return</span> (-1);
<a name="l02877"></a>02877                             }
<a name="l02878"></a>02878                             <span class="comment">// --------------------------------------</span>
<a name="l02879"></a>02879                             <span class="keywordflow">if</span> ((xml-&gt;getNodeType() == irr::io::EXN_ELEMENT) &amp;&amp; (!strcmp(<span class="stringliteral">&quot;hook&quot;</span>, xml-&gt;getNodeName())))
<a name="l02880"></a>02880                             {
<a name="l02881"></a>02881                                 <a class="code" href="class_o_t_string.html">OTString</a> strHookName    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Name of standard hook such as hook_activate or cron_process, etc</span>
<a name="l02882"></a>02882                                 <a class="code" href="class_o_t_string.html">OTString</a> strClause      = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;clause&quot;</span>); <span class="comment">// Name of clause on this Bylaw that should trigger when that callback occurs.</span>
<a name="l02883"></a>02883 
<a name="l02884"></a>02884                                 <span class="comment">// ----------------------------------</span>
<a name="l02885"></a>02885 
<a name="l02886"></a>02886                                 <span class="keywordflow">if</span> (!strHookName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strClause.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02887"></a>02887                                 {
<a name="l02888"></a>02888                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected missing name or clause while loading hook.\n&quot;</span>, szFunc);
<a name="l02889"></a>02889                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02890"></a>02890                                     <span class="keywordflow">return</span> (-1);
<a name="l02891"></a>02891                                 }
<a name="l02892"></a>02892                                 <span class="comment">// ---------------------------------------</span>
<a name="l02893"></a>02893 
<a name="l02894"></a>02894                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#abb196d8702499b28a959248d0e55c033">AddHook</a>(strHookName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strClause.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02895"></a>02895                                 {
<a name="l02896"></a>02896                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed adding hook to bylaw.\n&quot;</span>, szFunc);
<a name="l02897"></a>02897                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02898"></a>02898                                     <span class="keywordflow">return</span> (-1);
<a name="l02899"></a>02899                                 }
<a name="l02900"></a>02900                                 <span class="comment">// ---------------------------------------</span>
<a name="l02901"></a>02901 
<a name="l02902"></a>02902 <span class="comment">//                              xml-&gt;read(); // &lt;==================  NO NEED FOR THIS HERE.</span>
<a name="l02903"></a>02903                             }
<a name="l02904"></a>02904                             <span class="keywordflow">else</span>
<a name="l02905"></a>02905                             {
<a name="l02906"></a>02906                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected hook element in bylaw.\n&quot;</span>, szFunc);
<a name="l02907"></a>02907                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02908"></a>02908                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02909"></a>02909                             }
<a name="l02910"></a>02910                         } <span class="comment">// while</span>
<a name="l02911"></a>02911                     }
<a name="l02912"></a>02912 
<a name="l02913"></a>02913                     <span class="comment">// ---------------------------------------------------------------</span>
<a name="l02914"></a>02914                     <span class="comment">//</span>
<a name="l02915"></a>02915                     <span class="comment">// LOAD CALLBACKS.</span>
<a name="l02916"></a>02916                     <span class="comment">//</span>
<a name="l02917"></a>02917                     nCount  = 0;
<a name="l02918"></a>02918                     nCount  = strNumCallbacks.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() ? atoi(strNumCallbacks.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()) : 0;
<a name="l02919"></a>02919                     <span class="keywordflow">if</span> (nCount &gt; 0)
<a name="l02920"></a>02920                     {
<a name="l02921"></a>02921                         <span class="keywordflow">while</span> (nCount-- &gt; 0)
<a name="l02922"></a>02922                         {
<a name="l02923"></a>02923 <span class="comment">//                          xml-&gt;read();</span>
<a name="l02924"></a>02924                             <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_contract.html#a6d67d87a183391e60f4aca8a3856fdb2">SkipToElement</a>(xml))
<a name="l02925"></a>02925                             {
<a name="l02926"></a>02926                                 <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failure: Unable to find expected element.\n&quot;</span>, szFunc);
<a name="l02927"></a>02927                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02928"></a>02928                                 <span class="keywordflow">return</span> (-1);
<a name="l02929"></a>02929                             }
<a name="l02930"></a>02930                             <span class="comment">// --------------------------------------</span>
<a name="l02931"></a>02931                             <span class="keywordflow">if</span> ((xml-&gt;getNodeType() == irr::io::EXN_ELEMENT) &amp;&amp; (!strcmp(<span class="stringliteral">&quot;callback&quot;</span>, xml-&gt;getNodeName())))
<a name="l02932"></a>02932                             {
<a name="l02933"></a>02933                                 <a class="code" href="class_o_t_string.html">OTString</a> strCallbackName    = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;name&quot;</span>); <span class="comment">// Name of standard callback such as OnActivate, OnDeactivate, etc</span>
<a name="l02934"></a>02934                                 <a class="code" href="class_o_t_string.html">OTString</a> strClause          = xml-&gt;getAttributeValue(<span class="stringliteral">&quot;clause&quot;</span>); <span class="comment">// Name of clause on this Bylaw that should trigger when that hook occurs.</span>
<a name="l02935"></a>02935 
<a name="l02936"></a>02936                                 <span class="comment">// ----------------------------------</span>
<a name="l02937"></a>02937 
<a name="l02938"></a>02938                                 <span class="keywordflow">if</span> (!strCallbackName.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() || !strClause.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
<a name="l02939"></a>02939                                 {
<a name="l02940"></a>02940                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected, yet nevertheless missing, name or clause while loading &quot;</span>
<a name="l02941"></a>02941                                                   <span class="stringliteral">&quot;callback for bylaw %s.\n&quot;</span>, szFunc, strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02942"></a>02942                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02943"></a>02943                                     <span class="keywordflow">return</span> (-1);
<a name="l02944"></a>02944                                 }
<a name="l02945"></a>02945                                 <span class="comment">// ---------------------------------------</span>
<a name="l02946"></a>02946                                 <span class="comment">// See if the same-named callback already exists on ANY of the OTHER BYLAWS</span>
<a name="l02947"></a>02947                                 <span class="comment">// (There can only be one clause to handle any given callback.)</span>
<a name="l02948"></a>02948                                 <span class="comment">//</span>
<a name="l02949"></a>02949                                 <a class="code" href="class_o_t_clause.html">OTClause</a> * pClause = this-&gt;<a class="code" href="class_o_t_scriptable.html#a390511c5b2f419453b1cc169ec576972">GetCallback</a>(strCallbackName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02950"></a>02950 
<a name="l02951"></a>02951                                 <span class="keywordflow">if</span> (NULL != pClause) <span class="comment">// Uh-oh, it&#39;s already there!</span>
<a name="l02952"></a>02952                                 {
<a name="l02953"></a>02953                                     <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Error loading callback %s, since one was already there on one of the other bylaws.\n&quot;</span>,
<a name="l02954"></a>02954                                                    szFunc,
<a name="l02955"></a>02955                                                    strCallbackName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02956"></a>02956                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02957"></a>02957                                     <span class="keywordflow">return</span> (-1);
<a name="l02958"></a>02958                                 }
<a name="l02959"></a>02959                                 <span class="comment">// The below call checks to see if it&#39;s already there, but only for the currently-loading bylaw.</span>
<a name="l02960"></a>02960                                 <span class="comment">// Whereas the above call checks this OTScriptable for all the already-loaded bylaws.</span>
<a name="l02961"></a>02961                                 <span class="comment">// ---------------------------------------</span>
<a name="l02962"></a>02962 
<a name="l02963"></a>02963                                 <span class="keywordflow">if</span> (<span class="keyword">false</span> == pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#a08c600dbb06d5bcf42b41349d37d83da">AddCallback</a>(strCallbackName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strClause.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>()))
<a name="l02964"></a>02964                                 {
<a name="l02965"></a>02965                                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%se: Failed adding callback (%s) to bylaw (%s).\n&quot;</span>, szFunc,
<a name="l02966"></a>02966                                                   strCallbackName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strName.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02967"></a>02967                                     <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02968"></a>02968                                     <span class="keywordflow">return</span> (-1);
<a name="l02969"></a>02969                                 }
<a name="l02970"></a>02970                                 <span class="comment">// ---------------------------------------</span>
<a name="l02971"></a>02971 
<a name="l02972"></a>02972 <span class="comment">//                              xml-&gt;read(); // &lt;==================    NO NEED FOR THIS HERE.</span>
<a name="l02973"></a>02973                             }
<a name="l02974"></a>02974                             <span class="keywordflow">else</span>
<a name="l02975"></a>02975                             {
<a name="l02976"></a>02976                                 <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected callback element in bylaw.\n&quot;</span>, szFunc);
<a name="l02977"></a>02977                                 <span class="keyword">delete</span> pBylaw; pBylaw=NULL;
<a name="l02978"></a>02978                                 <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l02979"></a>02979                             }
<a name="l02980"></a>02980                         } <span class="comment">// while</span>
<a name="l02981"></a>02981                     }
<a name="l02982"></a>02982 
<a name="l02983"></a>02983                     <span class="comment">// --------------------------------</span>
<a name="l02984"></a>02984 <span class="comment">//                  if (false == SkipAfterLoadingField(xml))  // &lt;/bylaw&gt;</span>
<a name="l02985"></a>02985 <span class="comment">//                  {</span>
<a name="l02986"></a>02986 <span class="comment">//                      OTLog::vOutput(0, &quot;*** %s: Bad data? Expected EXN_ELEMENT_END here, but &quot;</span>
<a name="l02987"></a>02987 <span class="comment">//                                     &quot;didn&#39;t get it. Failure.\n&quot;, szFunc);</span>
<a name="l02988"></a>02988 <span class="comment">//                      delete pBylaw; pBylaw=NULL;</span>
<a name="l02989"></a>02989 <span class="comment">//                      return (-1);</span>
<a name="l02990"></a>02990 <span class="comment">//                  }</span>
<a name="l02991"></a>02991                     <span class="comment">// --------------------------------</span>
<a name="l02992"></a>02992 
<a name="l02993"></a>02993                     <span class="keywordflow">if</span> (<a class="code" href="class_o_t_scriptable.html#a32d8bccb563ab97e335f457148770c73">AddBylaw</a>(*pBylaw))
<a name="l02994"></a>02994                     {
<a name="l02995"></a>02995                         <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Loaded Bylaw: %s\n&quot;</span>, szFunc,
<a name="l02996"></a>02996                                        pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#ad7c410277a99a3abed22249a8dfd8fb7">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l02997"></a>02997                     }
<a name="l02998"></a>02998                     <span class="keywordflow">else</span>
<a name="l02999"></a>02999                     {
<a name="l03000"></a>03000                         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Failed loading Bylaw: %s\n&quot;</span>, szFunc,
<a name="l03001"></a>03001                                       pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#ad7c410277a99a3abed22249a8dfd8fb7">GetName</a>().<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
<a name="l03002"></a>03002                         <span class="keyword">delete</span> pBylaw; pBylaw = NULL;
<a name="l03003"></a>03003                         <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l03004"></a>03004                     }
<a name="l03005"></a>03005                 }
<a name="l03006"></a>03006                 <span class="keywordflow">else</span>
<a name="l03007"></a>03007                 {
<a name="l03008"></a>03008                     <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Expected bylaw element.\n&quot;</span>, szFunc);
<a name="l03009"></a>03009                     <span class="keywordflow">return</span> (-1); <span class="comment">// error condition</span>
<a name="l03010"></a>03010                 }
<a name="l03011"></a>03011 
<a name="l03012"></a>03012             } <span class="comment">// while</span>
<a name="l03013"></a>03013         }
<a name="l03014"></a>03014         <span class="comment">// -----------------------------------------------</span>
<a name="l03015"></a>03015 
<a name="l03016"></a>03016         nReturnVal = 1;
<a name="l03017"></a>03017     }
<a name="l03018"></a>03018 
<a name="l03019"></a>03019     <span class="comment">// ----------------------------------------------------------------------------------</span>
<a name="l03020"></a>03020 
<a name="l03021"></a>03021 
<a name="l03022"></a>03022     <span class="keywordflow">return</span> nReturnVal;
<a name="l03023"></a>03023 }
<a name="l03024"></a>03024 
<a name="l03025"></a>03025 
<a name="l03026"></a>03026 <span class="comment">// Look up the first (and hopefully only) variable registered for a given name.</span>
<a name="l03027"></a>03027 <span class="comment">// (Across all of my Bylaws)</span>
<a name="l03028"></a>03028 <span class="comment">//</span>
<a name="l03029"></a><a class="code" href="class_o_t_scriptable.html#a3f72637feb6a94088d8a576e29cc6a29">03029</a> <a class="code" href="class_o_t_variable.html">OTVariable</a> * <a class="code" href="class_o_t_scriptable.html#a3f72637feb6a94088d8a576e29cc6a29">OTScriptable::GetVariable</a>(<span class="keyword">const</span> std::string str_VarName)
<a name="l03030"></a>03030 {
<a name="l03031"></a>03031     <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_VarName)) <span class="comment">// this logs, FYI.</span>
<a name="l03032"></a>03032     {
<a name="l03033"></a>03033         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::GetVariable:  Error: invalid name.\n&quot;</span>);
<a name="l03034"></a>03034         <span class="keywordflow">return</span> NULL;
<a name="l03035"></a>03035     }
<a name="l03036"></a>03036     <span class="comment">// -------------------------------------</span>
<a name="l03037"></a>03037 
<a name="l03038"></a>03038     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l03039"></a>03039     {
<a name="l03040"></a>03040         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l03041"></a>03041         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l03042"></a>03042         <span class="comment">// -------------------------</span>
<a name="l03043"></a>03043 
<a name="l03044"></a>03044         <a class="code" href="class_o_t_variable.html">OTVariable</a> * pVar = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#aae26ff96d920fcc17ef69e9f0c762710">GetVariable</a>(str_VarName);
<a name="l03045"></a>03045 
<a name="l03046"></a>03046         <span class="keywordflow">if</span> (NULL != pVar) <span class="comment">// found it.</span>
<a name="l03047"></a>03047             <span class="keywordflow">return</span> pVar;
<a name="l03048"></a>03048     }
<a name="l03049"></a>03049 
<a name="l03050"></a>03050     <span class="keywordflow">return</span> NULL;
<a name="l03051"></a>03051 }
<a name="l03052"></a>03052 
<a name="l03053"></a>03053 
<a name="l03054"></a>03054 <span class="comment">// Look up the first (and hopefully only) clause registered for a given callback.</span>
<a name="l03055"></a>03055 <span class="comment">//</span>
<a name="l03056"></a><a class="code" href="class_o_t_scriptable.html#a390511c5b2f419453b1cc169ec576972">03056</a> <a class="code" href="class_o_t_clause.html">OTClause</a> * <a class="code" href="class_o_t_scriptable.html#a390511c5b2f419453b1cc169ec576972">OTScriptable::GetCallback</a>(<span class="keyword">const</span> std::string str_CallbackName)
<a name="l03057"></a>03057 {
<a name="l03058"></a>03058     <span class="keywordflow">if</span> ((<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_CallbackName)) ||
<a name="l03059"></a>03059         (str_CallbackName.compare(0,9,<span class="stringliteral">&quot;callback_&quot;</span>) != 0)) <span class="comment">// this logs, FYI.</span>
<a name="l03060"></a>03060     {
<a name="l03061"></a>03061         <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;OTScriptable::GetCallback:  Error: invalid name: %s\n&quot;</span>, str_CallbackName.c_str());
<a name="l03062"></a>03062         <span class="keywordflow">return</span> NULL;
<a name="l03063"></a>03063     }
<a name="l03064"></a>03064     <span class="comment">// -------------------------------------</span>
<a name="l03065"></a>03065     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l03066"></a>03066     {
<a name="l03067"></a>03067         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l03068"></a>03068         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l03069"></a>03069         <span class="comment">// -------------------------</span>
<a name="l03070"></a>03070 
<a name="l03071"></a>03071         <a class="code" href="class_o_t_clause.html">OTClause</a> * pClause = pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#ab1c6c33a33817e60be48e70ce862e898">GetCallback</a>(str_CallbackName);
<a name="l03072"></a>03072 
<a name="l03073"></a>03073         <span class="keywordflow">if</span> (NULL != pClause) <span class="comment">// found it.</span>
<a name="l03074"></a>03074             <span class="keywordflow">return</span> pClause;
<a name="l03075"></a>03075     }
<a name="l03076"></a>03076 
<a name="l03077"></a>03077     <span class="keywordflow">return</span> NULL;
<a name="l03078"></a>03078 }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080 
<a name="l03081"></a>03081 <span class="comment">// Look up all clauses matching a specific hook.</span>
<a name="l03082"></a>03082 <span class="comment">//</span>
<a name="l03083"></a><a class="code" href="class_o_t_scriptable.html#a298d8fdb0982df3c36e8ae194f228009">03083</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#a298d8fdb0982df3c36e8ae194f228009">OTScriptable::GetHooks</a>(<span class="keyword">const</span> std::string str_HookName, <a class="code" href="_o_t_clause_8hpp.html#a40c16432fa9c16826c026b74351425ad">mapOfClauses</a> &amp; theResults)
<a name="l03084"></a>03084 {
<a name="l03085"></a>03085     <span class="keywordflow">if</span> (
<a name="l03086"></a>03086         (<span class="keyword">false</span> == <a class="code" href="class_o_t_scriptable.html#a9492afb0aee3340f6fbdffdbdf8d5291">OTScriptable::ValidateName</a>(str_HookName))
<a name="l03087"></a>03087         ||
<a name="l03088"></a>03088         ((str_HookName.compare(0,5,<span class="stringliteral">&quot;cron_&quot;</span>) != 0) &amp;&amp; (str_HookName.compare(0,5,<span class="stringliteral">&quot;hook_&quot;</span>) != 0))
<a name="l03089"></a>03089        ) <span class="comment">// this logs, FYI.</span>
<a name="l03090"></a>03090     {
<a name="l03091"></a>03091         <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;OTScriptable::GetHooks:  Error: invalid name.\n&quot;</span>);
<a name="l03092"></a>03092         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03093"></a>03093     }
<a name="l03094"></a>03094     <span class="comment">// -------------------------------------</span>
<a name="l03095"></a>03095     <span class="keywordtype">bool</span> bReturnVal = <span class="keyword">false</span>;
<a name="l03096"></a>03096 
<a name="l03097"></a>03097     <a class="code" href="_o_t_storage_8hpp.html#aa135ed03585fa4b246d7907afbd5873d">FOR_EACH</a>(<a class="code" href="_o_t_bylaw_8hpp.html#ae1c6a97f4f9673e07292cd88ef39b450">mapOfBylaws</a>, <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>)
<a name="l03098"></a>03098     {
<a name="l03099"></a>03099         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = (*it).second;
<a name="l03100"></a>03100         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l03101"></a>03101         <span class="comment">// -------------------------</span>
<a name="l03102"></a>03102 
<a name="l03103"></a>03103         <span class="comment">// Look up all clauses matching a specific hook.</span>
<a name="l03104"></a>03104         <span class="comment">//</span>
<a name="l03105"></a>03105         <span class="keywordflow">if</span> (pBylaw-&gt;<a class="code" href="class_o_t_bylaw.html#ac43e007f0a64ca7c09853340c8a3aab1">GetHooks</a>(str_HookName, theResults))
<a name="l03106"></a>03106             bReturnVal = <span class="keyword">true</span>;
<a name="l03107"></a>03107     }
<a name="l03108"></a>03108 
<a name="l03109"></a>03109     <span class="keywordflow">return</span> bReturnVal;
<a name="l03110"></a>03110 }
<a name="l03111"></a>03111 
<a name="l03112"></a>03112 
<a name="l03113"></a><a class="code" href="class_o_t_scriptable.html#a2f9a8cf56455a256952bf4069b7039ba">03113</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a2f9a8cf56455a256952bf4069b7039ba">OTScriptable::Release_Scriptable</a>()
<a name="l03114"></a>03114 {
<a name="l03115"></a>03115     <span class="comment">// Go through the existing list of parties and bylaws at this point, and delete them all.</span>
<a name="l03116"></a>03116     <span class="comment">// (After all, I own them.)</span>
<a name="l03117"></a>03117     <span class="comment">//</span>
<a name="l03118"></a>03118     <span class="keywordflow">while</span> (!<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.empty())
<a name="l03119"></a>03119     {
<a name="l03120"></a>03120         <a class="code" href="class_o_t_party.html">OTParty</a> * pParty = <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.begin()-&gt;second;
<a name="l03121"></a>03121         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pParty);
<a name="l03122"></a>03122 
<a name="l03123"></a>03123         <a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.erase(<a class="code" href="class_o_t_scriptable.html#a6a7e4ef3e0ed95f90d950b1718f815ab">m_mapParties</a>.begin());
<a name="l03124"></a>03124 
<a name="l03125"></a>03125         <span class="keyword">delete</span> pParty;
<a name="l03126"></a>03126         pParty = NULL;
<a name="l03127"></a>03127     }
<a name="l03128"></a>03128     <span class="keywordflow">while</span> (!<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.empty())
<a name="l03129"></a>03129     {
<a name="l03130"></a>03130         <a class="code" href="class_o_t_bylaw.html">OTBylaw</a> * pBylaw = <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.begin()-&gt;second;
<a name="l03131"></a>03131         <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pBylaw);
<a name="l03132"></a>03132 
<a name="l03133"></a>03133         <a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.erase(<a class="code" href="class_o_t_scriptable.html#abd086b417d7222947b26a63aee80d501">m_mapBylaws</a>.begin());
<a name="l03134"></a>03134 
<a name="l03135"></a>03135         <span class="keyword">delete</span> pBylaw;
<a name="l03136"></a>03136         pBylaw = NULL;
<a name="l03137"></a>03137     }
<a name="l03138"></a>03138 }
<a name="l03139"></a>03139 
<a name="l03140"></a>03140 
<a name="l03141"></a><a class="code" href="class_o_t_scriptable.html#a92785192590f2e039f46d16bcd1934d3">03141</a> <span class="keywordtype">void</span> <a class="code" href="class_o_t_scriptable.html#a92785192590f2e039f46d16bcd1934d3">OTScriptable::Release</a>()
<a name="l03142"></a>03142 {
<a name="l03143"></a>03143     <a class="code" href="class_o_t_scriptable.html#a2f9a8cf56455a256952bf4069b7039ba">Release_Scriptable</a>();
<a name="l03144"></a>03144 
<a name="l03145"></a>03145     <span class="comment">// If there were any dynamically allocated objects, clean them up here.</span>
<a name="l03146"></a>03146 
<a name="l03147"></a>03147     <a class="code" href="class_o_t_contract.html#a15e423ca0d650858a23e54f8285feae1">ot_super::Release</a>(); <span class="comment">// since I&#39;ve overridden the base class, I call it now...</span>
<a name="l03148"></a>03148 }
<a name="l03149"></a>03149 
<a name="l03150"></a>03150 
<a name="l03151"></a><a class="code" href="class_o_t_scriptable.html#a1789860b8b6fae4c7c6543cfc72463cb">03151</a> <a class="code" href="class_o_t_scriptable.html#a1789860b8b6fae4c7c6543cfc72463cb">OTScriptable::OTScriptable</a>()
<a name="l03152"></a>03152 :  <a class="code" href="class_o_t_contract.html">ot_super</a>(),
<a name="l03153"></a>03153     <a class="code" href="class_o_t_scriptable.html#a217fc906e2d6475e22913bd8653ffaa2">m_bCalculatingID</a>(false), <span class="comment">// This is not serialized.</span>
<a name="l03154"></a>03154     <a class="code" href="class_o_t_scriptable.html#acea6ed68ee05f67a19caa03fcab92b49">m_bSpecifyAssetID</a>(false), <a class="code" href="class_o_t_scriptable.html#a8e92c7502904b0e3ac00abc672e7f942">m_bSpecifyParties</a>(false) <span class="comment">// These are.</span>
<a name="l03155"></a>03155 {
<a name="l03156"></a>03156 
<a name="l03157"></a>03157 }
<a name="l03158"></a>03158 
<a name="l03159"></a>03159 
<a name="l03160"></a><a class="code" href="class_o_t_scriptable.html#ad15650bac68579572022af0cd2adad9d">03160</a> <a class="code" href="class_o_t_scriptable.html#ad15650bac68579572022af0cd2adad9d">OTScriptable::~OTScriptable</a>()
<a name="l03161"></a>03161 {
<a name="l03162"></a>03162     <a class="code" href="class_o_t_scriptable.html#a2f9a8cf56455a256952bf4069b7039ba">Release_Scriptable</a>();
<a name="l03163"></a>03163 }
<a name="l03164"></a>03164 
<a name="l03165"></a>03165 
<a name="l03166"></a><a class="code" href="class_o_t_scriptable.html#af1433fd747d848bbab0029c06c07668a">03166</a> <span class="keywordtype">bool</span> <a class="code" href="class_o_t_scriptable.html#af1433fd747d848bbab0029c06c07668a">OTScriptable::SaveContractWallet</a>(std::ofstream &amp; ofs)
<a name="l03167"></a>03167 {
<a name="l03168"></a>03168     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03169"></a>03169 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_o_t_scriptable_8cpp.html">OTScriptable.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:04 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
