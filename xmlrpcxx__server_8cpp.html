<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Open-Transactions: src/ots/xmlrpcxx_server.cpp File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Open-Transactions
   &#160;<span id="projectnumber">master/1066fb4910a63ee3f7de8e0807fee3eb663b66c7</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('xmlrpcxx__server_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">src/ots/xmlrpcxx_server.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="stdafx_8hpp_source.html">stdafx.hpp</a>&gt;</code><br/>
<code>#include &lt;main.hpp&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_server_8hpp_source.html">OTServer.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_log_8hpp_source.html">OTLog.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_paths_8hpp_source.html">OTPaths.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_message_8hpp_source.html">OTMessage.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_envelope_8hpp_source.html">OTEnvelope.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_socket_8hpp_source.html">OTSocket.hpp</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="_o_t_cached_key_8hpp_source.html">OTCachedKey.hpp</a>&gt;</code><br/>
<code>#include &lt;cassert&gt;</code><br/>
</div>
<p><a href="xmlrpcxx__server_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#a738d8737b635a895b99d8dc59b50ce52">SERVER_PATH_DEFAULT</a>&#160;&#160;&#160;&quot;server_data&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#a3f9b9f7ef658597943b0d965345b1eaf">SERVER_CONFIG_KEY</a>&#160;&#160;&#160;&quot;server&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#a693f96e87be964cf7eb1c423be25b2df">SERVER_DEFAULT_LATENCY_SEND_MS</a>&#160;&#160;&#160;5000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#a4657600f0526ae484ff12e067156b5a4">SERVER_DEFAULT_LATENCY_SEND_NO_TRIES</a>&#160;&#160;&#160;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#a37e51c89249345659197111310eb6260">SERVER_DEFAULT_LATENCY_RECEIVE_MS</a>&#160;&#160;&#160;5000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#ad7992089581de9e4333d63a56279cc67">SERVER_DEFAULT_LATENCY_RECEIVE_NO_TRIES</a>&#160;&#160;&#160;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#adeed281ca838b6c1cebc1f237240a57a">SERVER_DEFAULT_LATENCY_DELAY_AFTER</a>&#160;&#160;&#160;50</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#ac6998dffffaa8239f4578c7ed0179a39">SERVER_DEFAULT_IS_BLOCKING</a>&#160;&#160;&#160;false</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#aea85c87f25efb3fb63df79e333e8da7f">ProcessMessage_ZMQ</a> (<a class="el" href="class_o_t_server.html">OTServer</a> &amp;theServer, const std::string &amp;str_Message, std::string &amp;str_Reply)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="xmlrpcxx__server_8cpp.html#abbc50c23c5192bfa8579c0c06a87fcd9">main</a> (int32_t argc, char *argv[])</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a3f9b9f7ef658597943b0d965345b1eaf"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_CONFIG_KEY" ref="a3f9b9f7ef658597943b0d965345b1eaf" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#a3f9b9f7ef658597943b0d965345b1eaf">SERVER_CONFIG_KEY</a>&#160;&#160;&#160;&quot;server&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00154">154</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="ac6998dffffaa8239f4578c7ed0179a39"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_IS_BLOCKING" ref="ac6998dffffaa8239f4578c7ed0179a39" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#ac6998dffffaa8239f4578c7ed0179a39">SERVER_DEFAULT_IS_BLOCKING</a>&#160;&#160;&#160;false</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00163">163</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="adeed281ca838b6c1cebc1f237240a57a"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_LATENCY_DELAY_AFTER" ref="adeed281ca838b6c1cebc1f237240a57a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#adeed281ca838b6c1cebc1f237240a57a">SERVER_DEFAULT_LATENCY_DELAY_AFTER</a>&#160;&#160;&#160;50</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00162">162</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="a37e51c89249345659197111310eb6260"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_LATENCY_RECEIVE_MS" ref="a37e51c89249345659197111310eb6260" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#a37e51c89249345659197111310eb6260">SERVER_DEFAULT_LATENCY_RECEIVE_MS</a>&#160;&#160;&#160;5000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00160">160</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="ad7992089581de9e4333d63a56279cc67"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_LATENCY_RECEIVE_NO_TRIES" ref="ad7992089581de9e4333d63a56279cc67" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#ad7992089581de9e4333d63a56279cc67">SERVER_DEFAULT_LATENCY_RECEIVE_NO_TRIES</a>&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00161">161</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="a693f96e87be964cf7eb1c423be25b2df"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_LATENCY_SEND_MS" ref="a693f96e87be964cf7eb1c423be25b2df" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#a693f96e87be964cf7eb1c423be25b2df">SERVER_DEFAULT_LATENCY_SEND_MS</a>&#160;&#160;&#160;5000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00158">158</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="a4657600f0526ae484ff12e067156b5a4"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_DEFAULT_LATENCY_SEND_NO_TRIES" ref="a4657600f0526ae484ff12e067156b5a4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#a4657600f0526ae484ff12e067156b5a4">SERVER_DEFAULT_LATENCY_SEND_NO_TRIES</a>&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00159">159</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="a738d8737b635a895b99d8dc59b50ce52"></a><!-- doxytag: member="xmlrpcxx_server.cpp::SERVER_PATH_DEFAULT" ref="a738d8737b635a895b99d8dc59b50ce52" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="xmlrpcxx__server_8cpp.html#a738d8737b635a895b99d8dc59b50ce52">SERVER_PATH_DEFAULT</a>&#160;&#160;&#160;&quot;server_data&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00153">153</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="abbc50c23c5192bfa8579c0c06a87fcd9"></a><!-- doxytag: member="xmlrpcxx_server.cpp::main" ref="abbc50c23c5192bfa8579c0c06a87fcd9" args="(int32_t argc, char *argv[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t <a class="el" href="otc_2main_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00178">178</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span>(!<a class="code" href="class_o_t_log.html#a35ff36b83c644febc07a8a736c4ea9b5">OTLog::Init</a>(<a class="code" href="xmlrpcxx__server_8cpp.html#a3f9b9f7ef658597943b0d965345b1eaf">SERVER_CONFIG_KEY</a>,0)) { assert(<span class="keyword">false</span>); };  <span class="comment">// setup the logger.</span>

    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\nWelcome to Open Transactions... Test Server -- version %s\n&quot;</span>
                   <span class="stringliteral">&quot;(transport build: OTMessage -&gt; OTEnvelope -&gt; ZMQ )\n\n&quot;</span>, <a class="code" href="class_o_t_log.html#a3d4addadb76f6dec42a806cbc634ee0f">OTLog::Version</a>());

    <span class="comment">// WINSOCK WINDOWS</span>
    <span class="comment">// -----------------------------------------------------------------------</span>
<span class="preprocessor">#ifdef OT_ZMQ_2_MODE</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>
    WSADATA wsaData;
    WORD wVersionRequested = MAKEWORD( 2, 2 );
    int32_t err = WSAStartup( wVersionRequested, &amp;wsaData );

    <span class="comment">/* Tell the user that we could not find a usable        */</span>
    <span class="comment">/* Winsock DLL.                                         */</span>

    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((err == 0), <span class="stringliteral">&quot;WSAStartup failed!\n&quot;</span>);


    <span class="comment">/*  Confirm that the WinSock DLL supports 2.2.          */</span>
    <span class="comment">/*  Note that if the DLL supports versions greater      */</span>
    <span class="comment">/*  than 2.2 in addition to 2.2, it will still return   */</span>
    <span class="comment">/*  2.2 in wVersion since that is the version we        */</span>
    <span class="comment">/*  requested.                                          */</span>

    <span class="keywordtype">bool</span> bWinsock = (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2);

    <span class="comment">/* Tell the user that we could not find a usable */</span>
    <span class="comment">/* WinSock DLL.                                  */</span>

    <span class="keywordflow">if</span> (!bWinsock) WSACleanup();  <span class="comment">// do cleanup.</span>
    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>((!bWinsock), <span class="stringliteral">&quot;Could not find a usable version of Winsock.dll\n&quot;</span>);

    <span class="comment">/* The Winsock DLL is acceptable. Proceed to use it. */</span>
    <span class="comment">/* Add network programming using Winsock here */</span>
    <span class="comment">/* then call WSACleanup when done using the Winsock dll */</span>
    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,<span class="stringliteral">&quot;The Winsock 2.2 dll was found okay\n&quot;</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>




    <span class="comment">// ***********************************************************************</span>
    <span class="comment">// INITIALIZATION and CLEANUP (for the OT library, and for this server application.)</span>
    <span class="comment">//</span>
    <span class="keyword">class </span>__ot_server_
    {
        <a class="code" href="class_o_t_server.html">OTServer</a> * m_pServer;
    <span class="keyword">public</span>:
        <a class="code" href="class_o_t_server.html">OTServer</a> * GetServer() { <span class="keywordflow">return</span> m_pServer; }
        <span class="comment">// -----------------------------------</span>
        __ot_server_() : m_pServer(NULL) <span class="comment">// INIT</span>
        {
            <span class="comment">// -----------------------------------------------------------------------</span>

            <span class="comment">// -----------------------------------------------------------------------</span>
            <span class="comment">// OTLog class exists on both client and server sides.</span>
            <span class="comment">// #define OT_NO_SIGNAL_HANDLING if you want to turn off OT&#39;s signal handling.</span>
            <span class="comment">//</span>
<span class="preprocessor">#if defined(OT_SIGNAL_HANDLING)</span>
<span class="preprocessor"></span>            <a class="code" href="class_o_t_log.html#a3fb27300b83fb9ed8c7c96283ff55fa0">OTLog::SetupSignalHandler</a>(); <span class="comment">// This is optional! (I, of course, am using it in this test app...)</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            <span class="comment">// -----------------------------------------------------------------------</span>
            <span class="comment">// I instantiate this here (instead of globally) so that I am assured that any globals and other</span>
            <span class="comment">// setup is already done before we instantiate the server object itself.</span>
            <span class="comment">//</span>
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL == m_pServer, <span class="stringliteral">&quot;server main(): ASSERT: NULL == m_pServer.&quot;</span>);
            m_pServer = <span class="keyword">new</span> <a class="code" href="class_o_t_server.html">OTServer</a>;
            <span class="comment">//</span>
            <span class="comment">// (This .cpp file you are currently reading is a wrapper for OTServer,</span>
            <span class="comment">// which adds the transport layer.)</span>
            <span class="comment">//</span>
            <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(NULL != m_pServer, <span class="stringliteral">&quot;server main(): ASSERT: Unable to instantiate OT server.\n&quot;</span>);


            <span class="comment">//</span>
            <span class="comment">// OT Server Path:</span>
            <span class="comment">//</span>
            {
                <span class="keywordtype">bool</span> bSetupPathsSuccess = <span class="keyword">false</span>;
                <span class="keywordflow">if</span>(!<a class="code" href="class_o_t_data_folder.html#ab8b6cd17737f8b362c64a39d86faf604">OTDataFolder::Init</a>(<a class="code" href="xmlrpcxx__server_8cpp.html#a3f9b9f7ef658597943b0d965345b1eaf">SERVER_CONFIG_KEY</a>)) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; }
                <span class="keywordflow">else</span>
                    bSetupPathsSuccess = <span class="keyword">true</span>;

                <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bSetupPathsSuccess, <span class="stringliteral">&quot;main(): Assert failed: Failed to set OT Path&quot;</span>);
            }

            <span class="comment">// -----------------------------------------------------------------------</span>

            <a class="code" href="class_o_t_crypto.html#af10d51149df4803f79b4b2fed829430b">OTCrypto::It</a>()-&gt;<a class="code" href="class_o_t_crypto.html#ae83b19ae07a5a0ba00780cf031014fcc">Init</a>();  <span class="comment">// &lt;========== (OpenSSL gets initialized here.)</span>

        }
        <span class="comment">// ****************************************</span>
        <span class="comment">//</span>
        ~__ot_server_()  <span class="comment">// CLEANUP</span>
        {
            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;\n\n OT version %s, shutting down and cleaning up.\n&quot;</span>,
                           <a class="code" href="class_o_t_log.html#a3d4addadb76f6dec42a806cbc634ee0f">OTLog::Version</a>());

            <span class="comment">// ------------------------------</span>
            <span class="keywordflow">if</span> (NULL != m_pServer)
                <span class="keyword">delete</span> m_pServer;
            m_pServer = NULL;
            <span class="comment">// ------------------------------</span>
            <a class="code" href="class_o_t_cached_key.html#a60f1041be525c88bde575ac183e64435">OTCachedKey::Cleanup</a>();
            <span class="comment">// ------------------------------</span>
            <span class="comment">// We clean these up in reverse order from the Init function, which just seems</span>
            <span class="comment">// like the best default, in absence of any brighter ideas.</span>
            <span class="comment">//</span>
            <a class="code" href="class_o_t_crypto.html#af10d51149df4803f79b4b2fed829430b">OTCrypto::It</a>()-&gt;<a class="code" href="class_o_t_crypto.html#a0b59b9598063be8d46a733bbd3449514">Cleanup</a>();  <span class="comment">// &lt;======= (OpenSSL gets cleaned up here.)</span>

            <span class="comment">// -------------------------</span>
            <span class="comment">// (This is at the bottom, since we do the cleanup in the</span>
            <span class="comment">// reverse order from initialization.)</span>
<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            WSACleanup();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
    };
    <span class="comment">// ***********************************************************************</span>
    <span class="comment">//</span>
    <span class="comment">// INSTANTIATE and INITIALIZE...</span>
    <span class="comment">//</span>
    <span class="comment">// (Cleanup happens automatically when this object goes out of scope.)</span>
    <span class="comment">//</span>
    __ot_server_  the_server_obj;
    <a class="code" href="class_o_t_server.html">OTServer</a> * pServer = the_server_obj.GetServer();
    <a class="code" href="_o_t_assert_8hpp.html#a74ecab0c6a7b0a9a546bb545160e23b3">OT_ASSERT</a>(NULL != pServer);
    <span class="comment">// -----------------------------------------------------------------------</span>
<span class="comment">//  OTString strCAFile, strDHFile, strKeyFile;  //, strSSLPassword;</span>
<span class="comment">//  strCAFile. Format(&quot;%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(), CA_FILE);</span>
<span class="comment">//  strDHFile. Format(&quot;%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(), DH_FILE);</span>
<span class="comment">//  strKeyFile.Format(&quot;%s%s%s&quot;, OTLog::Path(), OTLog::PathSeparator(), KEY_FILE);</span>
    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="comment">//</span>
    <span class="comment">// UPDATE: This was moved to OTLog::OT_Init(), which is called above, by the</span>
    <span class="comment">// nested cleanup class.</span>
    <span class="comment">//</span>
    <span class="comment">// Initialize SSL -- This MUST occur before any Private Keys are loaded!</span>
<span class="comment">//  SSL_library_init();</span>
<span class="comment">//  SSL_load_error_strings();</span>

    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="comment">// OTServer::Init loads up server&#39;s nym so it can decrypt messages sent in</span>
    <span class="comment">// envelopes. It also does various other initialization work.</span>
    <span class="comment">//</span>
    <span class="comment">// (Envelopes prove that ONLY someone who actually had the server contract,</span>
    <span class="comment">//  and had loaded it into his wallet, could ever connect to the server or</span>
    <span class="comment">//  communicate with it. And if that person is following the contract, there</span>
    <span class="comment">//  is only one server he can connect to, and one key he can use to talk to it.)</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0,
                   <span class="stringliteral">&quot;\nNow loading the server nym, which will also ask you for a password, to unlock\n&quot;</span>
                   <span class="stringliteral">&quot;its private key.\n&quot;</span>);

    pServer-&gt;<a class="code" href="class_o_t_server.html#af666d21f5f2814cf3dac34ecc041098d">Init</a>(); <span class="comment">// Keys, etc are loaded here. ===&gt; Assumes main path is set! &lt;===</span>

    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="comment">// We&#39;re going to listen on the same port that is listed in our server contract.</span>
    <span class="comment">//</span>
    <span class="comment">//</span>
    <a class="code" href="class_o_t_string.html">OTString</a>    strHostname;    <span class="comment">// The hostname of this server, according to its own contract.</span>
    int32_t         nPort=0;        <span class="comment">// The port of this server, according to its own contract.</span>

    <span class="keyword">const</span> <span class="keywordtype">bool</span> bConnectInfo = pServer-&gt;<a class="code" href="class_o_t_server.html#ac8d402506ad55458cd2fb0862dd7f26e">GetConnectInfo</a>(strHostname, nPort);

    <a class="code" href="_o_t_assert_8hpp.html#a033b133f48e61f2b227c52ad2be0c882">OT_ASSERT_MSG</a>(bConnectInfo, <span class="stringliteral">&quot;server main: Unable to find my own connect info (which SHOULD be in my server contract, BTW.) Perhaps you failed trying to open that contract? Have you tried the test password? (\&quot;test\&quot;)\n&quot;</span>);

    <span class="keyword">const</span> int32_t   nServerPort = nPort;

    <span class="comment">// -----------------------------------------------------------------------</span>
    <span class="comment">// OT CRON</span>
    <span class="comment">//</span>
    <span class="comment">// A heartbeat for recurring transactions, such as markets, payment plans,</span>
    <span class="comment">// and smart contracts.</span>

    pServer-&gt;<a class="code" href="class_o_t_server.html#a67db7bda44ff9b7e5a68661eba3dec87">ActivateCron</a>();

    <span class="comment">// NOTE: Currently we trigger OT Cron&#39;s processing internally, but there&#39;s no reason why, in the</span>
    <span class="comment">// future, we can&#39;t make an actual cron job that triggers a script, that fires a message</span>
    <span class="comment">// to OT, causing OT to process its Cron (even if we were single-threaded we could do this...)</span>
    <span class="comment">//</span>
    <span class="comment">// Have to put some thought into it...</span>
    <span class="comment">//</span>
    <span class="comment">// Wouldn&#39;t require much security, since OT can still be smart enough not to process cron any</span>
    <span class="comment">// more often than X minutes, no matter HOW many times the ProcessCron script fires.</span>
    <span class="comment">// Thing is, though, that with this setup, we can&#39;t really guarantee that cron will EVER be</span>
    <span class="comment">// triggered -- whereas the way OT is now, at least we know it WILL fire every X seconds.</span>
    <span class="comment">//</span>

    <span class="comment">// --------------------------------------</span>
    <span class="comment">//</span>
    <span class="comment">// NETWORK</span>
    <span class="comment">//</span>
    <span class="comment">// Prepare our context and listening socket...</span>

<span class="preprocessor">#ifdef OT_ZMQ_2_MODE</span>
<span class="preprocessor"></span>    <a class="code" href="class_o_t_socket.html">OTSocket</a> *  pSocket = <span class="keyword">new</span> OTSocket_ZMQ_2();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef OT_ZMQ_4_MODE</span>
<span class="preprocessor"></span>    <a class="code" href="class_o_t_socket.html">OTSocket</a> *  pSocket = <span class="keyword">new</span> <a class="code" href="class_o_t_socket___z_m_q__4.html">OTSocket_ZMQ_4</a>();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

    <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a624a126d059f0db031d894de786b4011">OTDataFolder::IsInitialized</a>()) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };

    {
        <a class="code" href="class_o_t_string.html">OTString</a> strConfigFolderPath = <span class="stringliteral">&quot;&quot;</span>;
        <span class="keywordflow">if</span> (!<a class="code" href="class_o_t_data_folder.html#a03f3da5b6d8d7f3df43757c66cbb8693">OTDataFolder::GetConfigFilePath</a>(strConfigFolderPath)) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
        <a class="code" href="class_o_t_settings.html">OTSettings</a> * pSettings(<span class="keyword">new</span> <a class="code" href="class_o_t_settings.html">OTSettings</a>(strConfigFolderPath));

        pSettings-&gt;Reset();
        <span class="keywordflow">if</span> (!pSettings-&gt;Load()) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
        {
            <span class="keyword">const</span> <a class="code" href="class_o_t_socket_1_1_defaults.html">OTSocket::Defaults</a> socketDefaults(
                <a class="code" href="xmlrpcxx__server_8cpp.html#a693f96e87be964cf7eb1c423be25b2df">SERVER_DEFAULT_LATENCY_SEND_MS</a>,
                <a class="code" href="xmlrpcxx__server_8cpp.html#a4657600f0526ae484ff12e067156b5a4">SERVER_DEFAULT_LATENCY_SEND_NO_TRIES</a>,
                <a class="code" href="xmlrpcxx__server_8cpp.html#a37e51c89249345659197111310eb6260">SERVER_DEFAULT_LATENCY_RECEIVE_MS</a>,
                <a class="code" href="xmlrpcxx__server_8cpp.html#ad7992089581de9e4333d63a56279cc67">SERVER_DEFAULT_LATENCY_RECEIVE_NO_TRIES</a>,
                <a class="code" href="xmlrpcxx__server_8cpp.html#adeed281ca838b6c1cebc1f237240a57a">SERVER_DEFAULT_LATENCY_DELAY_AFTER</a>,
                <a class="code" href="xmlrpcxx__server_8cpp.html#ac6998dffffaa8239f4578c7ed0179a39">SERVER_DEFAULT_IS_BLOCKING</a>
                );


            <span class="keywordflow">if</span> (!pSocket-&gt;<a class="code" href="class_o_t_socket.html#aac7b28cf63c959f95c3e47b8091b774f">Init</a>(socketDefaults, pSettings)) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
        }

        <span class="keywordflow">if</span> (!pSettings-&gt;Save()) { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
        pSettings-&gt;Reset();

        <span class="keywordflow">if</span> (NULL != pSettings) <span class="keyword">delete</span> pSettings; pSettings = NULL;
    }

    <span class="keywordflow">if</span> (!pSocket-&gt;<a class="code" href="class_o_t_socket.html#a7e398f4273932d4d43d3012120326bb0">NewContext</a>())     { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };

    {
        <span class="keywordflow">if</span>(0 == nServerPort)  { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
        <a class="code" href="class_o_t_string.html">OTString</a> strBindPath; strBindPath.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;%s%d&quot;</span>, <span class="stringliteral">&quot;tcp://*:&quot;</span>, nServerPort);

        <span class="keywordflow">if</span> (!pSocket-&gt;<a class="code" href="class_o_t_socket.html#a94d785d139c80aaf8c9632416769ef35">Listen</a>(strBindPath))  { <a class="code" href="_o_t_assert_8hpp.html#a1ae1def3bdc59b89b0d96240d3c5c321">OT_FAIL</a>; };
    }

    <span class="comment">// ******************************************************************************************</span>
    <span class="comment">//</span>
    <span class="comment">//      *** MAIN LOOP ***</span>
    <span class="comment">//</span>
    <span class="keywordflow">for</span> (;;)
    {
        <span class="comment">// =-=-=- HEARTBEAT -=-=-=</span>
        <span class="comment">//</span>
        <span class="comment">// The Server now processes certain things on a regular basis.</span>
        <span class="comment">// ProcessCron is what gives it the opportunity to do that.</span>
        <span class="comment">// All of the Cron Items (including market trades, payment plans, smart contracts...)</span>
        <span class="comment">// they all have their hooks here...</span>
        <span class="comment">//</span>
        pServer-&gt;<a class="code" href="class_o_t_server.html#a9f37adf57ae3e289f4a05494dd4642e3">ProcessCron</a>();  <span class="comment">// Internally this is smart enough to know how often to actually activate itself.</span>
                                   <span class="comment">// Most often it just returns doing nothing (waiting for its timer.)</span>
        <span class="comment">// -----------------------------------------------------------------------</span>
        <span class="comment">// Wait for client http requests (and process replies out to them.)</span>
        <span class="comment">// ----------------------------------------------------------------------</span>
        <span class="comment">// Number of requests to process per heartbeat: OTServer::GetHeartbeatNoRequests()</span>
        <span class="comment">//</span>
        <span class="comment">// Loop: process up to 10 client requests, then sleep for 1/10th second.</span>
        <span class="comment">// That&#39;s a total of 100 requests per second. Can the computers handle it?</span>
        <span class="comment">// Is it too much or too little? Todo: load testing.</span>
        <span class="comment">//</span>
        <span class="comment">// Then: check for shutdown flag.</span>
        <span class="comment">//</span>
        <span class="comment">// Then: go back to the top (&quot;do&quot;) and repeat the loop.... process cron,</span>
        <span class="comment">// process 10 client requests, sleep, check for shutdown, etc.</span>
        <span class="comment">//</span>
        <span class="comment">//</span>

        <a class="code" href="class_timer.html">Timer</a> t;    <span class="comment">// start timer</span>
        t.<a class="code" href="class_timer.html#a3a8b5272198d029779dc9302a54305a8">start</a>();
        <span class="keyword">const</span> <span class="keywordtype">double</span> tick1 = t.<a class="code" href="class_timer.html#a71a44ab36290730bc49f8719546194fc">getElapsedTimeInMilliSec</a>();
        <span class="comment">// -----------------------------------------------------</span>
        <span class="comment">//</span>
        <span class="comment">// PROCESS X NUMBER OF REQUESTS (THIS PULSE.)</span>
        <span class="comment">//</span>
        <span class="comment">// Theoretically the &quot;number of requests&quot; that we process EACH PULSE.</span>
        <span class="comment">// (The timing code here is still pretty new, need to do some load testing.)</span>
        <span class="comment">//</span>
        <span class="keywordflow">for</span> (int32_t i = 0; i &lt; <span class="comment">/*10*/</span><a class="code" href="class_o_t_server.html#ab08a2fd97673e879377a1a8a60c27dff">OTServer::GetHeartbeatNoRequests</a>(); i++)
        {
            <a class="code" href="class_o_t_string.html">OTString</a> str_Message;
            
            <span class="comment">// With 100ms heartbeat, receive will try 100 ms, then 200 ms, then 400 ms, total of 700.</span>
            <span class="comment">// That&#39;s about 15 Receive() calls every 10 seconds. Therefore if I want the ProcessCron()</span>
            <span class="comment">// to trigger every 10 seconds, I need to set the cron interval to roll over every 15 heartbeats.</span>
            <span class="comment">// Therefore I will be using a real Timer for Cron, instead of the damn intervals.</span>
            <span class="comment">//</span>
            <span class="keywordtype">bool</span> bReceived = pSocket-&gt;<a class="code" href="class_o_t_socket.html#a22c16b853dab1812a724d91c436135af">Receive</a>(str_Message);
            
            <span class="keywordflow">if</span>  (bReceived)
            {
                std::string str_Reply; <span class="comment">// Output.</span>
                
                <span class="keywordflow">if</span> (str_Message.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>() &lt;= 0)
                {
                    <a class="code" href="class_o_t_log.html#a5acd90ac91c2618f395b0ff37ad4f8ee">OTLog::Error</a>(<span class="stringliteral">&quot;server main: Received a message, but of 0 length or less. Weird. (Skipping it.)\n&quot;</span>);
                }
                <span class="keywordflow">else</span> <span class="comment">// ------------------------------------</span>
                {
                    <span class="comment">// true  == YES, DISCONNECT m_pSocket, something must have gone wrong.</span>
                    <span class="comment">// false ==  NO, do NOT disconnect m_pSocket, everything went wonderfully!</span>
                    <span class="comment">//</span>
                    <span class="keyword">const</span> std::string strMsg(str_Message.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bShouldDisconnect = <a class="code" href="xmlrpcxx__server_8cpp.html#aea85c87f25efb3fb63df79e333e8da7f">ProcessMessage_ZMQ</a>(*pServer, strMsg, str_Reply); <span class="comment">// &lt;================== PROCESS the message!</span>
                    <span class="comment">// --------------------------------------------------</span>

                    <span class="keywordflow">if</span> ((str_Reply.length() &lt;= 0) || bShouldDisconnect)
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;server main: ERROR: Unfortunately, not every client request is &quot;</span>
                                       <span class="stringliteral">&quot;legible or worthy of a server response. :-)  &quot;</span>
                                       <span class="stringliteral">&quot;Msg:\n\n%s\n\n&quot;</span>, strMsg.c_str());
                        
                        pSocket-&gt;<a class="code" href="class_o_t_socket.html#a94d785d139c80aaf8c9632416769ef35">Listen</a>();
                    }
                    <span class="keywordflow">else</span>
                    {
                        <span class="keywordtype">bool</span> bSuccessSending = pSocket-&gt;<a class="code" href="class_o_t_socket.html#ab87369f9469c9881c6bd821636657523">Send</a>(str_Reply.c_str()); <span class="comment">// &lt;===== SEND THE REPLY</span>
                        
                        <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSuccessSending)
                            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;server main: Socket ERROR: failed while trying to send reply &quot;</span>
                                          <span class="stringliteral">&quot;back to client! \n\n MESSAGE:\n%s\n\nREPLY:\n%s\n\n&quot;</span>, 
                                          strMsg.c_str(), str_Reply.c_str());
                        <span class="comment">// --------------------------------------------------</span>
                    }
                }
            }
        } <span class="comment">//  for</span>

        <span class="comment">// -----------------------------------------------------------------------</span>
        <span class="comment">//</span>
        <span class="comment">// IF the time we had available wasn&#39;t all used up -- if some of it is still</span>
        <span class="comment">// available, then SLEEP until we reach the NEXT PULSE. (In practice, we will</span>
        <span class="comment">// probably use TOO MUCH time, not too little--but then again OT isn&#39;t ALWAYS</span>
        <span class="comment">// processing a message. There could be plenty of dead time in between...)</span>
        <span class="comment">//</span>
        <span class="keyword">const</span>   <span class="keywordtype">double</span> tick2    = t.<a class="code" href="class_timer.html#a71a44ab36290730bc49f8719546194fc">getElapsedTimeInMilliSec</a>();
        <span class="keyword">const</span>   int64_t elapsed = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(tick2 - tick1);
        int64_t lSleepMS        = 0;

        <span class="keywordflow">if</span> (elapsed &lt; <span class="comment">/*100*/</span><a class="code" href="class_o_t_server.html#a972049b6ef960e94d43df291ac44dd4b">OTServer::GetHeartbeatMsBetweenBeats</a>())
        {
            lSleepMS = <a class="code" href="class_o_t_server.html#a972049b6ef960e94d43df291ac44dd4b">OTServer::GetHeartbeatMsBetweenBeats</a>() - elapsed;

            <span class="comment">// Now go to sleep.</span>
            <span class="comment">// (The main loop processes ten times per second, currently.)</span>
            <a class="code" href="class_o_t_log.html#a10fba9fb1a7c5cb04178e2beb7fd10c9">OTLog::SleepMilliseconds</a>(lSleepMS); <span class="comment">// 100 ms == (1 second / 10)</span>
        }

        <span class="comment">// -----------------------------------------------------------------------</span>
        <span class="comment">// ARTIFICIAL LIMIT:</span>
        <span class="comment">// 10 requests per heartbeat, 10 rounds per second == 100 requests per second.</span>
        <span class="comment">//</span>
        <span class="comment">// *** ONE HUNDRED CLIENT MESSAGES PER SECOND is the same as:</span>
        <span class="comment">//</span>
        <span class="comment">//     6000 PER MINUTE == 360,000 PER HOUR == 8,640,000 PER DAY***</span>
        <span class="comment">//</span>
        <span class="comment">// Speeding it up is just a matter of adjusting the above numbers, and LOAD TESTING,</span>
        <span class="comment">// to see if OT can handle it. (Not counting optimization of course.)</span>
        <span class="comment">//</span>
        <span class="comment">// -----------------------------------------------------------------------</span>

        <span class="keywordflow">if</span> (pServer-&gt;<a class="code" href="class_o_t_server.html#a3ecda4645f3d7fce295f5b6f78d53852">IsFlaggedForShutdown</a>())
        {
            <a class="code" href="class_o_t_log.html#a1f7549d776ee919dcb6517f611ded015">OTLog::Output</a>(0, <span class="stringliteral">&quot;main: OT Server is shutting down gracefully....\n&quot;</span>);
            <span class="keywordflow">break</span>;
        }

    }
    <span class="keywordflow">if</span> (NULL != pSocket) <span class="keyword">delete</span> pSocket;

    <span class="comment">// ------------------------------------</span>
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aea85c87f25efb3fb63df79e333e8da7f"></a><!-- doxytag: member="xmlrpcxx_server.cpp::ProcessMessage_ZMQ" ref="aea85c87f25efb3fb63df79e333e8da7f" args="(OTServer &amp;theServer, const std::string &amp;str_Message, std::string &amp;str_Reply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="xmlrpcxx__server_8cpp.html#aea85c87f25efb3fb63df79e333e8da7f">ProcessMessage_ZMQ</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_t_server.html">OTServer</a> &amp;&#160;</td>
          <td class="paramname"><em>theServer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>str_Message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string &amp;&#160;</td>
          <td class="paramname"><em>str_Reply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="xmlrpcxx__server_8cpp_source.html#l00567">567</a> of file <a class="el" href="xmlrpcxx__server_8cpp_source.html">xmlrpcxx_server.cpp</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (str_Message.size() &lt; 1)
        <span class="keywordflow">return</span> <span class="keyword">false</span>;

    <span class="comment">// --------------------</span>

    <span class="comment">// return value.</span>
    std::string resultString = <span class="stringliteral">&quot;&quot;</span>; <span class="comment">// Whatever we put in this string is what will get returned.</span>

    <span class="comment">// First we grab the client&#39;s message</span>
    <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascMessage;
    ascMessage.<a class="code" href="class_o_t_string.html#afe8b9f0781c0159cd7575b92af89bf9a">MemSet</a>(str_Message.data(), <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span> (str_Message.size()));


    <span class="keywordtype">bool</span> bReturnVal = <span class="keyword">false</span>; <span class="comment">// &quot;false&quot; == no, do NOT disconnect. No errors. (&quot;True&quot; means YES, DISCONNECT!)</span>

    <a class="code" href="class_o_t_message.html">OTMessage</a> theMsg, theReply; <span class="comment">// we&#39;ll need these in a sec...</span>

<span class="comment">//  OTEnvelope theEnvelope(ascMessage);</span>
    <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theEnvelope;

    <span class="keywordflow">if</span> (<span class="keyword">false</span> == theEnvelope.<a class="code" href="class_o_t_envelope.html#ad0d76f534bcda708b0298bcf906cb923">SetAsciiArmoredData</a>(ascMessage))
    {
        <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error retrieving envelope.\n&quot;</span>, __FUNCTION__);
        bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
    }
    <span class="keywordflow">else</span>
    {   <span class="comment">// Now the base64 is decoded and the envelope is in binary form again.</span>
        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(2, <span class="stringliteral">&quot;%s: Successfully retrieved envelope from ZMQ message...\n&quot;</span>, __FUNCTION__);

        <a class="code" href="class_o_t_string.html">OTString</a> strEnvelopeContents;

<span class="comment">//      OTString strPubkeyPath(&quot;TESTPUBKEY.txt&quot;);</span>
<span class="comment">//      theServer.GetServerNym().SavePublicKey(strPubkeyPath);</span>

        <span class="comment">// Decrypt the Envelope.</span>
        <span class="keywordflow">if</span> (<span class="keyword">false</span> == theEnvelope.<a class="code" href="class_o_t_envelope.html#ae2e8fafc4e508ce5d323c089b71c7e7b">Open</a>(theServer.<a class="code" href="class_o_t_server.html#aaaf31d2353a6821b09453e0e60feee30">GetServerNym</a>(), strEnvelopeContents)) <span class="comment">// now strEnvelopeContents contains the decoded message.</span>
        {
            <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Unable to open envelope.\n&quot;</span>, __FUNCTION__);
            bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// All decrypted--now let&#39;s load the results into an OTMessage.</span>
            <span class="comment">// No need to call theMsg.ParseRawFile() after, since</span>
            <span class="comment">// LoadContractFromString handles it.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span> (strEnvelopeContents.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp; theMsg.<a class="code" href="class_o_t_contract.html#a36300e34dcd94ed7006d98b392d46815">LoadContractFromString</a>(strEnvelopeContents))
            {
                theReply.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af1c861f21033a1d583b3cb12f952422e">Format</a>(<span class="stringliteral">&quot;@%s&quot;</span>, theMsg.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                theReply.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>     = theMsg.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>;    <span class="comment">// UserID</span>
                theReply.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>  = theMsg.<a class="code" href="class_o_t_message.html#ae5304f18eb276ecd0c5370aa41817926">m_strServerID</a>; <span class="comment">// ServerID, a hash of the server contract.</span>
                theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a>     = <span class="keyword">false</span>;                <span class="comment">// The default reply. In fact this is probably superfluous.</span>

                <span class="comment">// In case you want to see all the incoming messages...</span>
<span class="comment">//              OTLog::vOutput(0, &quot;%s\n\n&quot;, strEnvelopeContents.Get());</span>

                <span class="comment">// By constructing this without a socket, I put it in ZMQ mode, instead of tcp/ssl.</span>
                <a class="code" href="class_o_t_client_connection.html">OTClientConnection</a> theClient(theServer);

                <a class="code" href="class_o_t_pseudonym.html">OTPseudonym</a> theNym(theMsg.<a class="code" href="class_o_t_message.html#a61b38b159dbb516bb3f4f382b936238a">m_strNymID</a>);

                <span class="keyword">const</span> <span class="keywordtype">bool</span> bProcessedUserCmd = theServer.<a class="code" href="class_o_t_server.html#ae547a4bbf348c113568d625f8f5256aa">ProcessUserCommand</a>(theMsg, theReply, &amp;theClient, &amp;theNym);

                <span class="comment">// By optionally passing in &amp;theClient, the client Nym&#39;s public key will be</span>
                <span class="comment">// set on it whenever verification is complete. (So for the reply, I&#39;ll</span>
                <span class="comment">// have the key and thus I&#39;ll be able to encrypt reply to the recipient.)</span>
                <span class="keywordflow">if</span> (<span class="keyword">false</span> == bProcessedUserCmd)
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> s1(theMsg);

                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to process user command: %s\n ********** &quot;</span>
                        <span class="stringliteral">&quot;REQUEST:\n\n%s\n\n&quot;</span>, __FUNCTION__, theMsg.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), s1.Get());


                    <span class="comment">// NOTE: normally you would even HAVE a true or false if we&#39;re in this block. ProcessUserCommand()</span>
                    <span class="comment">// is what tries to process a command and then sets false if/when it fails. Until that point, you</span>
                    <span class="comment">// wouldn&#39;t get any server reply.  I&#39;m now changing this slightly, so you still get a reply (defaulted</span>
                    <span class="comment">// to success==false.) That way if a client needs to re-sync his request number, he will get the false</span>
                    <span class="comment">// and therefore know to resync the # as his next move, vs being stuck with no server reply (and thus</span>
                    <span class="comment">// stuck with a bad socket.)</span>
                    <span class="comment">// We sign the reply here, but not in the else block, since it&#39;s already signed in cases where</span>
                    <span class="comment">// ProcessUserCommand() is a success, by the time that call returns.</span>

                    theReply.<a class="code" href="class_o_t_message.html#ad6d611b1178ec24da0a380fb461300b8">m_bSuccess</a> = <span class="keyword">false</span>; <span class="comment">// Since the process call definitely failed, I&#39;m making sure this here is definitely set to false (even though it probably was already.)</span>
                    theReply.<a class="code" href="class_o_t_message.html#a0ed3dfe3a61124318b477ff5c4e5e041">SignContract</a>(theServer.<a class="code" href="class_o_t_server.html#aaaf31d2353a6821b09453e0e60feee30">GetServerNym</a>());
                    theReply.<a class="code" href="class_o_t_contract.html#a363ae430d4fd9256ab8364dbafb95444">SaveContract</a>();

                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a> s2(theReply);

                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot; ********** RESPONSE:\n\n%s\n\n&quot;</span>, s2.Get());

                }
                <span class="keywordflow">else</span>    <span class="comment">// At this point the reply is ready to go, and theClient has the public key of the recipient...</span>
                    <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(1, <span class="stringliteral">&quot;%s: Successfully processed user command: %s.\n&quot;</span>, __FUNCTION__, theMsg.<a class="code" href="class_o_t_message.html#a14c7dc1d2e11075a73e0a9aaf79fd762">m_strCommand</a>.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());

                <span class="comment">// -------------------------------------------------------------------------------------</span>

                <span class="comment">// IF ProcessUserCommand returned true, THEN we process the message for the recipient.</span>
                <span class="comment">// ELSE IF ProcessUserCommand returned false, YET the PubKey DOES exist, THEN in this case also, we process the message for the recipient.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span> (bProcessedUserCmd || theNym.Server_PubKeyExists()) <span class="comment">// if success + Nym&#39;s pub key exists here on server.</span>
                {
                    <span class="comment">// The transaction is now processed (or not), and the server&#39;s reply message is in theReply.</span>
                    <span class="comment">// Let&#39;s seal it up to the recipient&#39;s nym (in an envelope) and send back to the user...</span>
                    <span class="comment">//</span>
                    <a class="code" href="class_o_t_envelope.html">OTEnvelope</a> theRecipientEnvelope;

                    <span class="keyword">const</span> <span class="keywordtype">bool</span> bSealed = theClient.SealMessageForRecipient(theReply, theRecipientEnvelope);

                    <span class="keywordflow">if</span> (<span class="keyword">false</span> == bSealed)
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to seal envelope. (No reply will be sent.)\n&quot;</span>, __FUNCTION__);
                        bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
                    }
                    <span class="keywordflow">else</span>
                    {
<span class="comment">//                      OTPayload theReplyPayload;</span>
<span class="comment">//                      theReplyPayload.SetEnvelope(theRecipientEnvelope);</span>
<span class="comment">//                      resultString = ascReply.Get();</span>
<span class="comment">//                      resultString.assign(theReplyPayload.GetPayloadPointer(), theReplyPayload.GetPayloadSize());</span>

                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascReply;
                        <span class="keywordflow">if</span> (theRecipientEnvelope.<a class="code" href="class_o_t_envelope.html#a4ecb56611bd11931de4fae77b8b735ec">GetAsciiArmoredData</a>(ascReply))
                        {
                            <span class="comment">// -----------------------------------------</span>
                            <a class="code" href="class_o_t_string.html">OTString</a> strOutput;
                            <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = ascReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
                                                    ascReply.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput,
                                                                                <span class="stringliteral">&quot;ENVELOPE&quot;</span>); <span class="comment">// There&#39;s no default, to force you to enter the right string.</span>
                            <span class="comment">// -----------------------------------------</span>
                            <span class="keywordflow">if</span> (bSuccess &amp;&amp; strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                                resultString.assign(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strOutput.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()); <span class="comment">// &lt;============== REPLY ENVELOPE...</span>
                            <span class="keywordflow">else</span>
                            {
                                <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to WriteArmoredString from OTASCIIArmor object into &quot;</span>
                                    <span class="stringliteral">&quot;OTString object. (No reply envelope will be sent.)\n&quot;</span>, __FUNCTION__);
                                bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
                            }
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to GetAsciiArmoredData from sealed envelope into &quot;</span>
                                <span class="stringliteral">&quot;OTASCIIArmor object. (No reply envelope will be sent.)\n&quot;</span>, __FUNCTION__);
                            bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
                        }
                    }
                }
                <span class="comment">// -------------------------------------------------------------------------------------</span>
                <span class="comment">// ELSE we send the message in the CLEAR. (As an armored message, instead of as an armored envelope.)</span>
                <span class="keywordflow">else</span>
                {
                    <span class="keyword">const</span> <a class="code" href="class_o_t_string.html">OTString</a>  strReply(theReply);

                    <span class="keywordflow">if</span> (strReply.Exists())
                    {
                        <a class="code" href="class_o_t_a_s_c_i_i_armor.html">OTASCIIArmor</a> ascReply(strReply);
                        <span class="comment">// ------------------------------------</span>
                        <a class="code" href="class_o_t_string.html">OTString</a> strOutput;
                        <span class="keyword">const</span> <span class="keywordtype">bool</span> bSuccess = ascReply.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>() &amp;&amp;
                                                ascReply.<a class="code" href="class_o_t_a_s_c_i_i_armor.html#a754effb29fd0192ba0a7535846e52890">WriteArmoredString</a>(strOutput,
                                                                            <span class="stringliteral">&quot;MESSAGE&quot;</span>); <span class="comment">// There&#39;s no default, to force you to enter the right string.</span>
                        <span class="comment">// -----------------------------------------</span>
                        <span class="keywordflow">if</span> (bSuccess &amp;&amp; strOutput.<a class="code" href="class_o_t_string.html#adf7489cd917d4ae5bf30853a3ad78daf">Exists</a>())
                            resultString.assign(strOutput.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>(), strOutput.<a class="code" href="class_o_t_string.html#a640392dd17a786dab643dbfc7e5a8672">GetLength</a>()); <span class="comment">// &lt;============== REPLY MESSAGE...</span>
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Unable to WriteArmoredString from OTASCIIArmor object into &quot;</span>
                                <span class="stringliteral">&quot;OTString object. (No reply message will be sent.)\n&quot;</span>, __FUNCTION__);
                            bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
                        }
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="class_o_t_log.html#aa2a497c02879b811fe3134631d762f08">OTLog::vOutput</a>(0, <span class="stringliteral">&quot;%s: Failed trying to grab theReply in OTString form. &quot;</span>
                            <span class="stringliteral">&quot;(No reply message will be sent.)\n&quot;</span>, __FUNCTION__);
                        bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
                    }
                }
                <span class="comment">// -------------------------------------------------------------------------------------</span>
            }
            <span class="keywordflow">else</span>
            {
                <a class="code" href="class_o_t_log.html#acd1264f26723485de0783186149b0eca">OTLog::vError</a>(<span class="stringliteral">&quot;%s: Error loading message from envelope contents:\n\n%s\n\n&quot;</span>,
                    __FUNCTION__, strEnvelopeContents.<a class="code" href="class_o_t_string.html#af87b3b43148de9b1425ed8e9348241d3">Get</a>());
                bReturnVal = <span class="keyword">true</span>; <span class="comment">// disconnect the socket!</span>
            }
        }
    }
    <span class="comment">// ----------------------------------------------------------------------</span>

    str_Reply = resultString;

    <span class="keywordflow">return</span> bReturnVal;

} <span class="comment">// ProcessMessage_ZMQ</span>
</pre></div>
</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="xmlrpcxx__server_8cpp.html">xmlrpcxx_server.cpp</a>      </li>

    <li class="footer">Generated on Wed May 21 2014 11:26:05 for Open-Transactions by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
